[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Credit Limits Application",
  "enabled": 1,
  "modified": "2025-12-05 07:31:18.154417",
  "module": "UnderWriting1",
  "name": "credit limits script",
  "script": "frappe.ui.form.on('Credit Limits Application', {\r\n    onload: function(frm) {\r\n                console.log(\"Script Loaded: onload triggered\");\r\n\r\n        // Auto-generate credit limit number if not already populated\r\n        if (!frm.doc.credit_limit_no) {\r\n          generateNumber(frm);\r\n        }\r\n\r\n    },\r\n\r\n    refresh: function(frm) {\r\n                console.log(\"Script Loaded: refresh triggered\");\r\n               \r\n          var workflow_state = frm.doc.workflow_state;\r\n \r\n        // Check if the workflow state is \"Approved\"\r\n        if (workflow_state === \"Approved\") {\r\n            // Show policy_holder1 field and hide policy_holder field\r\n            frm.toggle_display('policy_no', true);\r\n            frm.toggle_display('policy_number', false);\r\n        } else {\r\n            // If workflow state is not \"Approved\", reverse the display\r\n            frm.toggle_display('policy_no', false);\r\n            frm.toggle_display('policy_number', true);\r\n        }\r\n\r\n        // Align numeric fields to the right\r\n        let right_align_fields = ['account_number', 'limit_required', 'terms_of_payments', 'no_of_employees', 'reg_noid_no'];\r\n        right_align_fields.forEach(field => {\r\n            if (frm.fields_dict[field]) {\r\n                frm.fields_dict[field].$wrapper.find('input').css(\"text-align\", \"right\");\r\n            }\r\n        });\r\n\r\n        // // Ensure the 'new' button exists before attaching event\r\n        if (frm.fields_dict.new) {\r\n            frm.fields_dict.new.$wrapper.find('button').off('click').on('click', function() {\r\n                frappe.new_doc('Buyer');\r\n            }).addClass('btn-primary');\r\n        }\r\n\r\nfrappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Policy Approvals',\r\n        filters: {\r\n            workflow_state: 'Accepted'\r\n        },\r\n        fields: ['policy_holder'],\r\n        limit_page_length: 0\r\n    },\r\n    callback: function(response) {\r\n        if (response.message && response.message.length > 0) {\r\n\r\n            // Extract unique & remove empty values\r\n            let uniqueHolders = [\r\n                \r\n                \r\n                ...new Set(\r\n                    response.message\r\n                        .map(d => (d.policy_holder || '').trim())\r\n                        .filter(name => name) // remove null/empty\r\n                )\r\n            ];\r\n                 uniqueHolders.sort();\r\n            // Set dropdown options\r\n            frm.set_df_property(\r\n                'policy_holder_name',\r\n                'options',\r\n                uniqueHolders.join('\\n')\r\n            );\r\n\r\n        } else {\r\n            frm.set_df_property('policy_holder_name', 'options', '');\r\n        }\r\n\r\n        frm.refresh_field('policy_holder_name');\r\n    }\r\n});\r\n\r\n\r\n\r\n\r\n        frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Buyer',\r\n            fields: ['buyer_name'],\r\n             limit_page_length: 0\r\n        },\r\n        callback: function(response) {\r\n            var buyers = response.message;\r\n            var options = buyers.map(buyer => buyer.buyer_name);\r\n            frm.set_df_property('buyer', 'options', options);\r\n\r\n       \r\n\r\n        }\r\n    });\r\n\r\n\r\n        \r\n\r\n},\r\n        \r\npolicy_holder_name: function(frm) {\r\n\r\n    if (!frm.doc.policy_holder_name) {\r\n        frm.set_df_property('policy_number', 'options', '');\r\n        return;\r\n    }\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Policy Approvals',\r\n            filters: {\r\n                policy_holder: frm.doc.policy_holder_name\r\n            },\r\n            fields: ['policy_number'],\r\n            limit_page_length: 0\r\n        },\r\n        callback: function(response) {\r\n\r\n            if (response.message && response.message.length > 0) {\r\n\r\n                // Get unique policy numbers\r\n                let uniquePolicyNumbers = [\r\n                    ...new Set(\r\n                        response.message\r\n                            .map(d => (d.policy_number || '').trim())\r\n                            .filter(num => num) // remove empty/null\r\n                    )\r\n                ];\r\n\r\n                // Set dropdown options\r\n                frm.set_df_property(\r\n                    'policy_number',\r\n                    'options',\r\n                    uniquePolicyNumbers.join('\\n')\r\n                );\r\n\r\n            } else {\r\n                // Clear dropdown if no records found\r\n                frm.set_df_property('policy_number', 'options', '');\r\n            }\r\n\r\n            frm.refresh_field('policy_number');\r\n        }\r\n    });\r\n},\r\n        \r\n  policy_number: function (frm) {\r\n\r\n    let policyNumber = frm.doc.policy_number;   // FIXED: define variable\r\n   frm.set_value('policy_no', policyNumber);\r\n    if (!policyNumber) return;  // stop if empty\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Policy Approvals',\r\n            filters: { policy_number: policyNumber },\r\n            fields: ['status', 'inception_date', 'policy_type'],\r\n            limit_page_length: 1\r\n        },\r\n        callback: function(response) {\r\n            if (response.message && response.message.length > 0) {\r\n\r\n                let data = response.message[0];\r\n\r\n                frm.set_value({\r\n                    status: data.status || '',\r\n                    inception_date: data.inception_date || '',\r\n                    policy_type: data.policy_type || ''\r\n                });\r\n\r\n            } else {\r\n\r\n                frm.set_value({\r\n                    status: '',\r\n                    inception_date: '',\r\n                    policy_type: ''\r\n                });\r\n            }\r\n        }\r\n    });\r\n},\r\n\r\n\r\n    policy_type: function(frm) {\r\n\r\n        // Clear existing buyer field\r\n        frm.set_df_property(\"buyer\", \"options\", \"\");\r\n        frm.set_value(\"buyer\", \"\");\r\n\r\n        let filterCondition = {};\r\n\r\n        // Apply filter based on policy type\r\n        if (frm.doc.policy_type === \"DCI\") {\r\n            filterCondition = { dci: 1 };      // DCI buyers only\r\n        }\r\n        else if (frm.doc.policy_type === \"ECI\") {\r\n            filterCondition = { eci: 1 };      // ECI buyers only\r\n        } \r\n        else {\r\n            return;  // If not DCI/ECI, no filtering\r\n        }\r\n\r\n        // Fetch buyers based on filter conditions\r\n        frappe.call({\r\n            method: \"frappe.client.get_list\",\r\n            args: {\r\n                doctype: \"Buyer\",\r\n                filters: filterCondition,\r\n                fields: [\"buyer_name\"],\r\n                limit_page_length: 0\r\n            },\r\n            callback: function(r) {\r\n                if (r.message) {\r\n\r\n                    // Get unique buyer names\r\n                    let buyers = [...new Set(r.message.map(b => b.buyer_name))];\r\n\r\n                    // Set Buyer dropdown options\r\n                    frm.set_df_property(\"buyer\", \"options\", buyers.join(\"\\n\"));\r\n                }\r\n            }\r\n        });\r\n    },\r\n\r\n    inception_date: function(frm) {\r\n        if (frm.doc.inception_date) {\r\n            // Convert string to date object\r\n            let inception_date = frappe.datetime.str_to_obj(frm.doc.inception_date);\r\n            \r\n            // Add one year\r\n            let expiry_date = new Date(inception_date);\r\n            expiry_date.setFullYear(expiry_date.getFullYear() + 1);\r\n\r\n            // Set expiry date back to field in user format\r\n            frm.set_value('policy_expire_date', frappe.datetime.obj_to_user(expiry_date));\r\n        } else {\r\n            frm.set_value('policy_expire_date', '');\r\n        }\r\n    },\r\n    \r\n    buyer: function(frm) {\r\n        if (frm.doc.buyer) {\r\n            frappe.call({\r\n                method: \"frappe.client.get_list\",\r\n                args: {\r\n                    doctype: \"Buyer\",\r\n                    fields: [\r\n                        \"trading_name\", \"phone\", \"fax\",\"estddate\",\r\n                        \"branch\",\"ac_no\",\"registration_no\",\"postal_address\",\r\n                        \"physical_address\",\"no_of_employees\",\"bank\",\r\n                        \"referance_1\",\"tel_no1\", \"referance_2\", \"tel_no2\", \"director_1\",\"director_2\", \"director_3\",\"director_4\"\r\n                    ],\r\n                    filters: {\r\n                        buyer_name: frm.doc.buyer    // replace with your actual field for Buyer Name\r\n                    },\r\n                    limit: 1\r\n                },\r\n                callback: function(r) {\r\n                    if (r.message && r.message.length > 0) {\r\n                        let doc = r.message[0];\r\n                        frm.set_value('trading_style', doc.trading_name);\r\n                        frm.set_value('tel_no', doc.phone);\r\n                        frm.set_value('fax_no', doc.fax);\r\n                        frm.set_value('estd_date', doc.estddate);\r\n                        frm.set_value('branch', doc.branch);\r\n                        frm.set_value('account_number', doc.ac_no);\r\n                        frm.set_value('reg_noid_no', doc.registration_no);\r\n                        frm.set_value('address_1', doc.postal_address);\r\n                        frm.set_value('address_2', doc.physical_address);\r\n                        frm.set_value('no_of_employees', doc.no_of_employees);\r\n                        frm.set_value('reference_1', doc.referance_1);\r\n                        frm.set_value('tel_no1', doc.tel_no1);\r\n                        frm.set_value('bank', doc.bank);\r\n                        frm.set_value('reference_2', doc.referance_2);\r\n                        frm.set_value('tel_no2', doc.tel_no2);\r\n                        frm.set_value('director_1', doc.director_1);\r\n                        frm.set_value('director_2', doc.director_2);\r\n                        frm.set_value('director_3', doc.director_3);\r\n                        frm.set_value('director_4', doc.director_4);\r\n                        \r\n                         \r\n                        //frm.set_value('terms_of_payments', doc.terms_of_payments);\r\n                    } else {\r\n                        frappe.msgprint(\"No Buyer record found for: \" + frm.doc.buyer);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    }\r\n    \r\n});\r\n\r\n// Function to generate credit limit number\r\nfunction generateNumber(frm) {\r\n    if (!frm.doc.credit_limit_no) {\r\n        let currentYear = new Date().getFullYear();\r\n        let prefix = `CRL/${currentYear}/`;\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Credit Limits Application',\r\n                fields: ['credit_limit_no'],\r\n                order_by: 'creation desc',\r\n                limit: 1\r\n            },\r\n            callback: function(r) {\r\n                let newNumber = '0001';\r\n                if (r.message && r.message.length > 0) {\r\n                    let last_credit_limit_no = r.message[0].credit_limit_no;\r\n                    let match = last_credit_limit_no.match(/CRL\\/\\d{4}\\/(\\d+)/);\r\n                    if (match) {\r\n                        newNumber = (parseInt(match[1]) + 1).toString().padStart(4, '0');\r\n                    }\r\n                }\r\n                frm.set_value('credit_limit_no', prefix + newNumber);\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Credit Limit Processing",
  "enabled": 1,
  "modified": "2025-12-05 07:32:30.899637",
  "module": "UnderWriting",
  "name": "Credit Limit Processing Script",
  "script": "frappe.ui.form.on('Credit Limit Processing', {\r\n    refresh: function(frm) {\r\n     \r\n       \r\n      var workflowState = frm.doc.workflow_state;\r\nif (workflowState === \"Approved\") {\r\n    frm.add_custom_button(__('Print Annexure'), function() {\r\n\r\n        frappe.call({\r\n            method: \"frappe.client.get_list\",\r\n            args: {\r\n                doctype: \"Credit Limit  Annexure\",\r\n                filters: {\r\n                    policy_no: frm.doc.policy_no,\r\n                    buyer_id: frm.doc.buyer_id\r\n                },\r\n                fields: [\"name\"],\r\n                limit_page_length: 1\r\n            },\r\n            callback(res) {\r\n\r\n                // CASE 1: Record already exists \u2192 OPEN IT\r\n                if (res.message && res.message.length > 0) {\r\n                    frappe.set_route(\"Form\", \"Credit Limit  Annexure\", res.message[0].name);\r\n                    return;\r\n                }\r\n\r\n                // CASE 2: No record \u2192 CREATE NEW with route_options\r\n                frappe.route_options = {\r\n                    capture_date: frm.doc.capture_date,\r\n                    policy_holder_name: frm.doc.policy_holder_name,\r\n                    policy_no: frm.doc.policy_no,\r\n                    credit_limit_no: frm.doc.credit_limit_no,\r\n                    buyer_name: frm.doc.buyer_name,\r\n                    trading__style: frm.doc.trading__style,\r\n                    location: frm.doc.location,\r\n                    credit_limit: frm.doc.approved_amount,\r\n                    terms_of_payments: frm.doc.terms_of_payments,\r\n                    days_from: frm.doc.days_from,\r\n                    conditions: frm.doc.conditions,\r\n                    buyer_id: frm.doc.buyer_id\r\n                };\r\n\r\n                frappe.new_doc(\"Credit Limit  Annexure\");\r\n            }\r\n        });\r\n\r\n    }).addClass(\"btn-primary\");\r\n}\r\n\r\n        frm.fields_dict.financial_analysis.$input.addClass('btn-primary');\r\n        frm.fields_dict.director_share_holder_exposure.$input.addClass('btn-primary');\r\n \r\n        // new code\r\n        if (frm.doc.yes) {\r\n    if (workflowState === \"Pending\" || workflowState === \"Approved\") {\r\n        frm.add_custom_button(__('View CB Report'), function() {\r\n            frappe.call({\r\n                method: \"frappe.client.get_list\",\r\n                args: {\r\n                    doctype: \"CB Report\",\r\n                    filters: {\r\n                        buyer: frm.doc.buyer_name,\r\n                        refnumber: frm.doc.credit_limit_no\r\n                    },\r\n                    fields: [\"cb_request_number\", \"reqdate\", \"buyer\", \"refnumber\", \"date\", \"catagory\", \"code\", \"details\", \"description\"],\r\n                    limit: 1\r\n                },\r\n                callback: function (r) {\r\n                    if (r.message && r.message.length > 0) {\r\n                        var cbReportData = r.message[0];\r\n                        frappe.prompt([\r\n                            {'fieldname': 'credit_bureau_request', 'fieldtype': 'Heading', 'label': 'Credit Bureau Request'},\r\n                            {'fieldname': 'section_break_2','fieldtype': 'Section Break','label': ''},\r\n                            {'fieldname': 'cb_request_number', 'fieldtype': 'Data', 'label': 'CB Req Number', 'default': cbReportData.cb_request_number},\r\n                            {'fieldname': 'reqdate', 'fieldtype': 'Date', 'label': 'Req.Date', 'default': cbReportData.reqdate},\r\n                            {'fieldname': 'buyer', 'fieldtype': 'Data', 'label': 'Buyer', 'default': cbReportData.buyer},\r\n                            {'fieldname': 'column_break_1','fieldtype': 'Column Break','label': ''},\r\n                            {'fieldname': 'refnumber', 'fieldtype': 'Data', 'label': 'Ref.Number','default': cbReportData.refnumber},\r\n                            {'fieldname': 'section_break_4','fieldtype': 'Section Break','label': ''},\r\n                            {'fieldname': 'credit_bureau_responce', 'fieldtype': 'Heading', 'label': 'Credit Bureau Response'},\r\n                            {'fieldname': 'section_break_5','fieldtype': 'Section Break','label': ''},\r\n                            {'fieldname': 'date', 'fieldtype': 'Date', 'label': 'Date', 'default': cbReportData.date},\r\n                            {'fieldname': 'catagory', 'fieldtype': 'Data', 'label': 'Category', 'default': cbReportData.catagory},\r\n                            {'fieldname': 'code', 'fieldtype': 'Data', 'label': 'Code',  'default': cbReportData.code},\r\n                            {'fieldname': 'column_break_2','fieldtype': 'Column Break','label': ''},\r\n                            {'fieldname': 'details', 'fieldtype': 'Data', 'label': 'Details',  'default': cbReportData.details},\r\n                            {'fieldname': 'description', 'fieldtype': 'Small Text', 'label': 'Description', 'default': cbReportData.description},\r\n                        ], function(values){}, 'CB Report');\r\n                    } else {\r\n                        frappe.msgprint(`CB Report not found for Buyer <b>${frm.doc.buyer_name}</b> and Credit Limit Number <b>${frm.doc.credit_limit_no}</b>.`);\r\n                    }\r\n                }\r\n            });\r\n        }).addClass(\"btn-primary\");\r\n    }\r\n}\r\n\r\n\r\n\r\n\r\n      \r\n        if(frm.doc.yes){\r\n        if (workflowState === \"Pending\" || workflowState === \"Approved\") {\r\n            frm.toggle_display('cbreport', true);\r\n            frm.toggle_display('report', false);\r\n            frm.toggle_display('cb_request', false);\r\n            // frm.toggle_display('table', false);\r\n \r\n        }\r\n        }\r\n        \r\nvar workflow_state = frm.doc.workflow_state || '';\r\n \r\n// Always keep original fields visible\r\nfrm.toggle_display('policy_no', true);\r\n\r\n// Make them read-only when approved\r\nif (workflow_state === \"Approved\") {\r\n    frm.set_df_property('policy_no', 'read_only', 1);\r\n} else {\r\n    frm.set_df_property('policy_no', 'read_only', 0);\r\n}\r\n \r\n        //   if (workflowState === \"Approved\") {// || workflowState === \"Pending\" || workflowState === \"Draft\") {\r\n        //      frm.toggle_display('policy_number', true);\r\n        //      frm.toggle_display('policy_no', false);\r\n            \r\n        // //     frm.toggle_display('credit_number', true);\r\n        // //     frm.toggle_display('credit_limit_no', false); \r\n\r\n        //  }\r\n        \r\n        \r\n        \r\n         frm.fields_dict.credit_limit.$input.css(\"text-align\", \"right\");\r\n      frm.fields_dict.overdue_amount.$input.css(\"text-align\", \"right\");\r\n      frm.fields_dict.outstanding_amount.$input.css(\"text-align\", \"right\");\r\n      frm.fields_dict.total_exposure.$input.css(\"text-align\", \"right\");\r\n      frm.fields_dict.recommended_exposure.$input.css(\"text-align\", \"right\");\r\n \r\n    \r\n    },\r\n\r\n    \r\nonload: function(frm){\r\n\r\n  \r\n   frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Credit Limits Application',\r\n                    filters: {\r\n                        workflow_state: 'Approved',\r\n                       \r\n                    },\r\n                    fields: ['policy_holder_name'],\r\n                    limit_page_length: 0\r\n                },\r\n                 callback: function(response) {\r\n                    if (response.message) {\r\n                         // Remove duplicates using Set\r\n                    let uniquePolicyHolders = [...new Set(response.message.map(i => i.policy_holder_name))];\r\n                    console.log(\"Unique Policy Holders:\", uniquePolicyHolders);\r\n                    \r\n                     uniquePolicyHolders.sort();\r\n\r\n                    // Set options in dropdown\r\n                    frm.set_df_property('policy_holder_name', 'options', uniquePolicyHolders.join('\\n'));\r\n                    frm.refresh_field('policy_holder_name');\r\n                    }\r\n                }\r\n            });\r\n\r\n\r\n \r\n \r\n\r\n    },\r\n    \r\n    policy_holder_name: function(frm){\r\n             frm.toggle_enable('policy_holder_name', true);\r\n         \t    var policyHolderName = frm.doc.policy_holder_name;\r\n         \t    frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Credit Limits Application',\r\n                    filters: {\r\n                        policy_holder_name: policyHolderName     \r\n                        },\r\n                    fields: ['credit_limit_no'],\r\n                    limit_page_length: 0\r\n                },\r\n                 callback: function(response) {\r\n                    if (response.message) {\r\n                        // Get all credit_limit_no values (including duplicates)\r\n                        let creditLimitList = response.message.map(item => item.credit_limit_no);\r\n                        frm.set_df_property('credit_limit_no', 'options', creditLimitList.join('\\n'));\r\n                       \r\n                    }\r\n                }\r\n            });\r\n    },\r\n\r\n \tcredit_limit_no: function(frm) {\r\n \t                 frm.toggle_enable('credit_limit_no', true);\r\n\r\n \t    var creditlimitNo = frm.doc.credit_limit_no;\r\n \r\n    // Set the value of policy_number field\r\n    frm.set_value('credit_limit_no', creditlimitNo);\r\n        if (frm.doc.credit_limit_no) {\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Credit Limits Application',\r\n                    filters: {\r\n                        credit_limit_no: creditlimitNo\r\n                    },\r\n                    fields: ['policy_number'],\r\n                    limit_page_length: 0\r\n                },\r\n                  callback: function (response) {\r\n\r\n            let claimData = response.message && response.message.length > 0 \r\n                            ? response.message[0] \r\n                            : null;\r\n\r\n            if (claimData) {\r\n\r\n                // Check if Potential Claim already exists\r\n                frappe.call({\r\n                    method: 'frappe.client.get_list',\r\n                    args: {\r\n                        doctype: 'Credit Limit Processing',\r\n                        filters: {\r\n                            credit_limit_no: creditlimitNo\r\n                            // workflow_state: 'Approved'\r\n                        },\r\n                        fields: ['credit_limit_no']\r\n                    },\r\n\r\n                    callback: function (approvedResponse) {\r\n\r\n                        let alreadyApproved = approvedResponse.message && approvedResponse.message.length > 0;\r\n\r\n                        if (alreadyApproved) {\r\n                            frappe.msgprint('This Credit Limit No is already approved.');\r\n                        } \r\n                           frm.set_df_property('policy_no', 'options',claimData.policy_number);\r\n                           \r\n                      \r\n                    }\r\n                });\r\n\r\n            } else {\r\n                // No data found in Claim Register\r\n                frm.set_value('status', '');\r\n            }\r\n        }\r\n                \r\n                \r\n                \r\n                \r\n            });\r\n        } \r\n        else {\r\n            // Clear credit_limit_no options if policy_no is cleared\r\n            frm.set_df_property('policy_no', 'options', '');\r\n        }\r\n    },\r\n    \r\n  policy_no: function(frm) {\r\n    var policyNo = frm.doc.policy_no;\r\n \r\n    // Set the value of policy_number field\r\n    //frm.set_value('policy_number', policyNo);\r\n if (frm.doc.policy_no) {\r\n    // Fetch data from DCI Proposals based on selected policy_no\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Credit Limits Application',\r\n            filters: {\r\n                policy_number: policyNo\r\n            },\r\n            fields: ['policy_holder_name', 'inception_date', 'buyer', 'estd_date', 'no_of_employees', 'policy_type', 'trading_style', 'limit_required']\r\n        },\r\n        callback: function(response) {\r\n            if (response.message && response.message.length > 0) {\r\n                var data_from_proposals = response.message[0];\r\n                // Populate fields if data is found\r\n              //  frm.set_value('policy_holder_name', data_from_proposals.policy_holder_name || '');\r\n                frm.set_value('capture_date', data_from_proposals.inception_date || '');\r\n              // frm.set_value('credit_limit_no', data_from_proposals.credit_limit_no || '');\r\n                frm.set_value('buyer_name', data_from_proposals.buyer || '');\r\n                frm.set_value('estd_date', data_from_proposals.estd_date || '');\r\n                frm.set_value('noof_employees', data_from_proposals.no_of_employees || '');\r\n                frm.set_value('policy_type', data_from_proposals.policy_type || '');\r\n                frm.set_value('trading__style', data_from_proposals.trading_style || '');\r\n                 frm.set_value('credit_limit', data_from_proposals.limit_required || '');\r\n \r\n            } else {\r\n                // Clear fields if no matching record found\r\n               // frm.set_value('policy_holder_name', '');\r\n                frm.set_value('capture_date', '');\r\n              // frm.set_value('credit_limit_no', '');\r\n                frm.set_value('buyer_name', '');\r\n                frm.set_value('estd_date', '');\r\n                frm.set_value('noof_employees', '');\r\n                frm.set_value('policy_type', '');\r\n                frm.set_value('trading__style', '');\r\n                frm.set_value('credit_limit', '');\r\n                //frappe.msgprint('No matching record found in DCI Proposals.');\r\n            }\r\n        },\r\n        error: function(err) {\r\n            console.error(err);\r\n            frappe.msgprint('An error occurred while fetching data from DCI Proposals. Please check the console for details.');\r\n        }\r\n    });\r\n }\r\n \r\n},\r\ncb_request: function(frm) {\r\n        frappe.new_doc('CB Request'); \r\n          frappe.route_options = {\r\n             buyer: frm.doc.buyer_name,\r\n             refnumber: frm.doc.credit_limit_no,\r\n             policy_type: frm.doc.policy_type,\r\n            }; \r\n    //   frappe.prompt([\r\n    //         {'fieldname': 'toaddress', 'fieldtype': 'Data','label': 'TO'},\r\n    //         {'fieldname': 'attention', 'fieldtype': 'Data', 'label': 'ATTENTION'},\r\n    //         {'fieldname': 'from', 'fieldtype': 'Data', 'label': 'FROM'},\r\n    //         {'fieldname': 'attention1', 'fieldtype': 'Data', 'label': 'ATTENTION'},\r\n    //         {'fieldname': 'subject', 'fieldtype': 'Data', 'label': 'Subject'},\r\n    //         {'fieldname': 'date', 'fieldtype': 'Date', 'label': 'Date', 'default': frappe.datetime.get_today()},\r\n    //         {'fieldname': 'amount_required', 'fieldtype': 'Data', 'label': 'Amount Required'},\r\n\r\n    //     ],\r\n    //     function(values){\r\n    //         var data = {\r\n    //             toaddress: values.toaddress,\r\n    //             attention: values.attention,\r\n    //             from: values.from,\r\n    //             attention1: values.attention1,\r\n    //             subject: values.subject,\r\n    //             date: values.date,\r\n    //             amount_required: values.amount_required,\r\n    //         };\r\n    //         // Save the object to LocalStorage\r\n    //         localStorage.setItem('CB Request ChildTable', JSON.stringify(data));\r\n \r\n    //         // Retrieve the data from LocalStorage\r\n    //         var CB_Request_ChildTable = JSON.parse(localStorage.getItem('CB Request ChildTable'));\r\n    //         // Log the retrieved data to the console\r\n    //         console.log(CB_Request_ChildTable, \"data\");\r\n    //         // Add the retrieved data to the child table\r\n    //         addDataToChildTable(frm, CB_Request_ChildTable);\r\n    //     },\r\n    //     'CB Request');\r\n    },\r\n    //  view_cb_report: function(frm) {\r\n//       // Fetch data from CB Report doctype based on buyer name and credit limit number\r\n//       frappe.call({\r\n//         method: \"frappe.client.get\",\r\n//         args: {\r\n//             doctype: \"CB Report\",\r\n//             filters: {\r\n//                 buyer: frm.doc.buyer_name,\r\n//                 refnumber: frm.doc.credit_limit_no,\r\n//             },\r\n//             fields: [\"cb_request_number\", \"reqdate\", \"buyer\", \"refnumber\", \"date\", \"catagory\", \"code\", \"details\", \"description\"]\r\n//         },\r\n//         callback: function (r) {\r\n//             if (!r.exc) {\r\n//                 var cbReportData = r.message;\r\n//                 if (cbReportData) {\r\n//                     // Open prompt dialog only if data is found\r\n//                     frappe.prompt([\r\n//                         {'fieldname': 'credit_bureau_request', 'fieldtype': 'Heading', 'label': 'Credit Bureau Request'},\r\n//                         {'fieldname': 'section_break_2','fieldtype': 'Section Break','label': ''},\r\n//                         {'fieldname': 'cb_request_number', 'fieldtype': 'Data', 'label': 'CB Req Number', 'default': cbReportData.cb_request_number},\r\n//                         {'fieldname': 'reqdate', 'fieldtype': 'Date', 'label': 'Req.Date', 'default': cbReportData.reqdate},\r\n//                         {'fieldname': 'buyer', 'fieldtype': 'Data', 'label': 'Buyer', 'default': cbReportData.buyer},\r\n//                          {'fieldname': 'column_break_1','fieldtype': 'Column Break','label': ''},\r\n//                         {'fieldname': 'refnumber', 'fieldtype': 'Data', 'label': 'Ref.Number','default': cbReportData.refnumber},\r\n//                         {'fieldname': 'section_break_3','fieldtype': 'Section Break','label': ''},\r\n//                         {'fieldname': 'section_break_4','fieldtype': 'Section Break','label': ''},\r\n//                         {'fieldname': 'credit_bureau_responce', 'fieldtype': 'Heading', 'label': 'Credit Bureau Response'},\r\n//                         {'fieldname': 'section_break_5','fieldtype': 'Section Break','label': ''},\r\n//                         {'fieldname': 'date', 'fieldtype': 'Date', 'label': 'Date', 'default': cbReportData.date},\r\n//                         {'fieldname': 'catagory', 'fieldtype': 'Data', 'label': 'Category', 'default': cbReportData.catagory},\r\n//                         {'fieldname': 'code', 'fieldtype': 'Data', 'label': 'Code',  'default': cbReportData.code},\r\n//                          {'fieldname': 'column_break_2','fieldtype': 'Column Break','label': ''},\r\n//                         {'fieldname': 'details', 'fieldtype': 'Data', 'label': 'Details',  'default': cbReportData.details},\r\n//                         {'fieldname': 'description', 'fieldtype': 'Small Text', 'label': 'Description', 'default': cbReportData.description},\r\n//                     ], function(values){\r\n//                         // Handle user input if needed\r\n//                     }, 'CB Report');\r\n//                 } else {\r\n//                     frappe.msgprint(\"No CB Report data found for the selected buyer and credit limit number.\");\r\n//                 }\r\n//             } else {\r\n//                 console.error(\"Error occurred while fetching CB Report data:\", r.exc);\r\n//                 frappe.msgprint(\"Error occurred while fetching CB Report data. Please try again.\");\r\n//             }\r\n//         }\r\n//     });\r\n// },\r\n// policy_no: function(frm) {\r\n    //     var policy_no = frm.doc.policy_no;\r\n    //     // Fetch data from DCI Proposals based on selected client name\r\n    //     frappe.call({\r\n    //         method: 'frappe.client.get_list',\r\n    //         args: {\r\n    //             doctype: 'Credit Limits Application',\r\n    //             filters: {\r\n    //                  policy_number:policy_no\r\n    //             },\r\n    //             fields: ['policy_holder_name', 'inception_date', 'credit_limit_no','buyer','estd_date','no_of_employees','policy_type','trading_style']\r\n    //         },\r\n    //         callback: function(response) {\r\n    //             if (response.message && response.message.length > 0) {\r\n    //                 var data_from_proposals = response.message[0];\r\n    //                 // Populate fields if data is found\r\n    //                 frm.set_value('policy_holder_name', data_from_proposals.policy_holder_name || '');\r\n    //                 frm.set_value('capture_date', data_from_proposals.inception_date || '');\r\n    //                 frm.set_value('credit_limit_no', data_from_proposals.credit_limit_no || '');\r\n    //                 frm.set_value('buyer_name', data_from_proposals.buyer || '');\r\n    //                 frm.set_value('estd_date', data_from_proposals.estd_date || '');\r\n    //                 frm.set_value('noof_employees', data_from_proposals.no_of_employees || '');\r\n    //                 frm.set_value('policy_type', data_from_proposals.policy_type || '');\r\n    //                 frm.set_value('trading__style', data_from_proposals.trading_style || '');\r\n \r\n    //             } else {\r\n    //                 // Clear fields if no matching record found\r\n    //                 frm.set_value('policy_holder_name', '');\r\n    //                 frm.set_value('capture_date', '');\r\n    //                 frm.set_value('credit_limit_no', '');\r\n    //                 frm.set_value('buyer_name', '');\r\n    //                 frm.set_value('estd_date', '');\r\n    //                 frm.set_value('noof_employees', '');\r\n    //                 frm.set_value('policy_type', '');\r\n    //                 frm.set_value('trading__style', '');\r\n    //                 frappe.msgprint('No matching record found in DCI Proposals.');\r\n    //             }\r\n    //         },\r\n    //         error: function(err) {\r\n    //             console.error(err);\r\n    //             frappe.msgprint('An error occurred while fetching data from DCI Proposals. Please check the console for details.');\r\n    //         }\r\n    //     });\r\n    // },\r\n \r\n    buyer_name: function(frm) {\r\n    var buyer_name = frm.doc.buyer_name; // Get the value of buyer_name from the form\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Buyer',\r\n            filters: {\r\n                buyer_name: buyer_name // Use the buyer_name variable here\r\n            },\r\n            fields: ['buyer_name', 'buyer_id']\r\n        },\r\n        callback: function(r) {\r\n            console.log(r, 'finance');\r\n            if (r.message && r.message.length > 0) {\r\n                // Assuming only one buyer is expected in the response\r\n                frm.set_value('buyer_id', r.message[0].buyer_id);\r\n            } else {\r\n                // Handle case when no buyer is found with the given name\r\n                frm.set_value('buyer_id', '');\r\n            }\r\n        }\r\n    });\r\n},\r\ndirector_share_holder_exposure: function(frm) {\r\n\r\n    // Open Director and Shareholder Exposure directly\r\n    frappe.new_doc('Director and Shareholder Exposure');\r\n    frappe.route_options = {\r\n        buyer_name: frm.doc.buyer_name\r\n    };\r\n \r\n    // Add a hook to hide fields after the document is created\r\n    frappe.ui.form.on('Director and Shareholder Exposure', {\r\n        onload: function(frm) {\r\n            // Hide the specific fields and search button\r\n            frm.toggle_display('director_shareholder', false);\r\n            frm.toggle_display('search',false);\r\n            // Replace 'director_shareholder_field' with the actual field name you want to hide\r\n            frm.page.btn_primary.hide(); // Hides the primary button, typically the save button\r\n \r\n            // To hide the search button specifically, you might need to use jQuery or direct DOM manipulation\r\n            // Assuming the search button has a class or ID you can select\r\n            $('.search-btn-class').hide();// Replace with the actual class or ID selector for the search button\r\n        }\r\n    });\r\n},\r\n\r\n\r\n\r\n    financial_analysis: function(frm) {\r\n       \r\n\r\n    \r\n\r\n        // Use frappe.db.get_value to fetch existing record name by buyer\r\n        frappe.db.get_value('Financial Analysis', { buyer_name: frm.doc.buyer }, 'buyer')\r\n            .then(r => {\r\n                if (r && r.message && r.message.buyer) {\r\n                    // \u2705 Existing record found \u2014 go to it\r\n                    frappe.set_route('Form', 'Financial Analysis', r.message.buyer);\r\n                } else {\r\n                    // \u274c Not found \u2014 create a new record\r\n                    frappe.new_doc('Financial Analysis', {\r\n                        buyer: frm.doc.buyer,\r\n                        buyer_name: frm.doc.buyer_name\r\n                    });\r\n                }\r\n            });\r\n    }\r\n});\r\n\r\n\r\n \r\n//  function addDataToChildTable(frm, data) {\r\n//     // Access the child table grid\r\n//     var childTable = frm.fields_dict['table'].grid;\r\n//     // Add a new row to the child table\r\n//     var newRow = childTable.add_new_row();\r\n//     // Set values for each field in the row\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'toaddress', data.toaddress);\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'attention', data.attention);\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'from', data.from);\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'attention1', data.attention1);\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'subject', data.subject);\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'date', data.date);\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'amount_required', data.amount_required);\r\n\r\n//     // Refresh the child table to reflect the changes\r\n//     childTable.refresh()\r\n// }\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Bond Facility",
  "enabled": 0,
  "modified": "2025-07-30 08:15:04.869021",
  "module": "Marketing",
  "name": "Bond facility Script",
  "script": " \r\n\r\n frappe.ui.form.on('Bond Facility', {\r\n    refresh: function(frm) {\r\n        \r\n           clear_attachment(frm);\r\n           \r\n                  // frm.set_df_property('personel_child', 'cannot_add_new', true);\r\n\r\n        frm.fields_dict.required_facility.$input.css(\"text-align\", \"right\");\r\n        // Ensure that the rejection_letter1 field exists before binding the event\r\n        // if (frm.fields_dict['rejection_letter1']) {\r\n        //     frm.fields_dict['rejection_letter1'].$input.on('click', function() {\r\n        //         frappe.new_doc('Rejection Letter Bond Facility');\r\n        //     });\r\n        // }\r\n\r\n        // Add the btn-primary class to the add_new button\r\n        \r\n        if (frm.fields_dict.add_new) {\r\n            frm.fields_dict.add_new.$input.addClass('btn-primary');\r\n            frm.fields_dict.add_new1.$input.addClass('btn-primary');\r\n            frm.fields_dict.add_new2.$input.addClass('btn-primary');\r\n            frm.fields_dict.add_new3.$input.addClass('btn-primary');\r\n            frm.fields_dict.add_new4.$input.addClass('btn-primary');\r\n\r\n\r\n\r\n        }\r\n\r\n        // Generate a facility number if it does not exist\r\n        if (!frm.doc.facility_no) {\r\n            generateNumber(frm);\r\n        }\r\n         var workflowState = frm.doc.workflow_state;\r\n         \r\n         if (workflowState === \"Rejected\") {\r\n            frm.add_custom_button(__('Rejection Letter'), function() {\r\n                // Set route_options before creating the new document\r\n                frappe.route_options = {\r\n                    facility_no: frm.doc.facility_no,\r\n                    to: frm.doc.client_name,\r\n                    registration_no: frm.doc.reg_no,\r\n                    \r\n                };\r\n\r\n                // Create a new 'Rejection_Letter_1' document\r\n                frappe.new_doc('Rejection Letter Bond Facility');\r\n                frappe.model.set_value(frm.doctype, frm.docname, 'created_date', frappe.datetime.now_datetime());\r\n                console.log(\"Rejection Letter clicked!\");\r\n            }).addClass(\"btn-primary\");\r\n         }\r\n\r\n        frm.set_df_property('shareholders_table', 'cannot_add_rows', true); \r\n        frm.set_df_property('company_child', 'cannot_add_rows', true); \r\n        frm.set_df_property('current_bond', 'cannot_add_rows', true); \r\n        frm.set_df_property('personel_child', 'cannot_add_rows', true); \r\n         frm.set_df_property('company_child', 'cannot_add_rows', true); \r\n         frm.set_df_property('directors', 'cannot_add_rows', true); \r\n         frm.set_df_property('group_company', 'cannot_add_rows', true); \r\n             \r\n        frm.fields_dict.ac_no.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.overdraft_facility.$input.css(\"text-align\", \"right\");\r\n                frm.fields_dict.overdraft_used.$input.css(\"text-align\", \"right\");\r\n                                frm.fields_dict.required_facility.$input.css(\"text-align\", \"right\");\r\n\r\n \r\n\r\n    },\r\n\r\n// status: function(frm) {\r\n//         // Call the function to disable file attachment based on status\r\n//         disable_attachment_based_on_status(frm);\r\n//     },\r\n    \r\n    onload: function(frm) {\r\n        // frappe.call({\r\n        //     method: 'frappe.client.get',\r\n        //     args: {\r\n        //         doctype: 'DCI Proposals',\r\n        //         filters: {\r\n        //             client_name: frm.doc.client_name\r\n        //         },\r\n        //         fields: [\r\n        //             'agriculture', 'timber_products', 'steel_merchants', 'steel_doors_window_farmes', '_diaries', 'soda_ash', \r\n        //             'security_services', 'salt', 'road_construction', 'plastic_and_spices', 'pharmaceuticals', 'perishable_goods', \r\n        //             'hair_products', 'gas', 'fuel', 'frozen_chicken', 'airconditioning', 'aluminium_boats', 'fmcg', 'engraving', \r\n        //             'couriers', 'cosmetics', 'corporate_clothing', 'concrete_products', 'computer_electronic', 'cigarettes', \r\n        //             'animal_vaccines', 'arts_crafts', 'batteries', 'building_materials', 'cellular', 'cereals', 'canning_cans', \r\n        //             'heavy_plant', 'invoice_factoring', 'leather_products', 'logistics', 'lubricants__fuel', 'meat_products', \r\n        //             'media_products', 'media__radio', 'merchandise', 'packaging_materials'\r\n        //         ]\r\n        //     },\r\n        //     callback: function(r) {\r\n        //         console.log(r, \"proposal_no1\");\r\n        //         if (!r.exc) {\r\n        //             if (r.message) {\r\n        //                 // Get the list of checked fields from Nature_Of_Business\r\n        //                 var checkedFields = [];\r\n        //                 $.each([\r\n        //                     'aluminium_boats', 'airconditioning', 'heavy_plant', 'invoice_factoring', 'leather_products', 'logistics', \r\n        //                     'lubricants__fuel', 'meat_products', 'media_products', 'media__radio', 'merchandise', 'packaging_materials', \r\n        //                     'agriculture', 'animal_vaccines', 'arts_crafts', 'batteries', 'building_materials', 'cellular', 'cereals', \r\n        //                     'canning_cans', 'fmcg', 'engraving', 'couriers', 'cosmetics', 'corporate_clothing', 'concrete_products', \r\n        //                     'computer_electronic', 'cigarettes', 'timber_products', 'steel_merchants', 'steel_doors_window_farmes', \r\n        //                     '_diaries', 'soda_ash', 'security_services', 'salt', 'road_construction', 'plastic_and_spices', \r\n        //                     'pharmaceuticals', 'perishable_goods', 'hair_products', 'gas', 'fuel', 'frozen_chicken'\r\n        //                 ], function(index, field) {\r\n        //                     if (r.message[field]) {\r\n        //                         checkedFields.push(field);\r\n        //                     }\r\n        //                 });\r\n\r\n        //                 // Hide all existing fields in Domestic Credit Insurance Schedule\r\n        //                 frm.fields.forEach(function(field) {\r\n        //                     if (field.df.fieldtype === 'Check') {\r\n        //                         frm.set_df_property(field.df.fieldname, 'hidden', true);\r\n        //                     }\r\n        //                 });\r\n\r\n        //                 // Iterate through checked fields and display them\r\n        //                 checkedFields.forEach(function(field) {\r\n        //                     frm.set_df_property(field, 'hidden', false);\r\n        //                 });\r\n        //             }\r\n\r\n        //             // Generate schedule_no directly\r\n        //             generateNumber(frm);\r\n        //         } else {\r\n        //             console.error(\"Error occurred:\", r.exc);\r\n        //         }\r\n        //     }\r\n        // });\r\n               \r\n         \r\n    },\r\n\r\n    // rejection_letter1: function(frm) {\r\n    //     frappe.route_options = {\r\n    //         facility_no: frm.doc.facility_no,\r\n    //         to: frm.doc.client_name,\r\n    //         registration_no: frm.doc.reg_no,\r\n    //     };\r\n    //     frappe.new_doc('Rejection Letter Bond Facility');\r\n    // },\r\n    //   add_new: function(frm) {\r\n    //     frappe.prompt([\r\n    //         {'fieldname': 'id_type', 'fieldtype': 'Select', 'options': '\\nDRIVING LICENSE\\nOMANG\\nPASSPORT', 'label': 'ID Type'},\r\n    //         {'fieldname': 'surname', 'fieldtype': 'Data', 'label': 'Surname'},\r\n    //         {'fieldname': 'first_name', 'fieldtype': 'Data', 'label': 'First Name'},\r\n    //         {'fieldname': 'e_mail_id', 'fieldtype': 'Data', 'label': 'E-mail Id'},\r\n    //         {'fieldname': 'fax_no', 'fieldtype': 'Data', 'label': 'Fax No'},\r\n    //         {'fieldname': '', 'fieldtype': 'Column Break'},\r\n    //         {'fieldname': 'id_number', 'fieldtype': 'Data', 'label': 'ID Number'},\r\n    //         {'fieldname': 'middle_name', 'fieldtype': 'Data', 'label': 'Middle Name'},\r\n    //         {'fieldname': 'contact_no', 'fieldtype': 'Phone', 'label': 'Contact No'},\r\n    //         {'fieldname': 'share_held', 'fieldtype': 'Data', 'label': '% Share Held'},\r\n    //         {'fieldname': 'married_anccop', 'fieldtype': 'Select', 'options': '\\nANC\\nCOP', 'label': 'Married ANC/COP'},\r\n    //         {'fieldname': 'designation', 'fieldtype': 'Select', 'options': '\\nDIRECTOR\\nMEMBER\\nMANAGER\\nOTHERS\\nPARTNER\\nPROPRIETOR', 'label': 'Designation'}\r\n    //     ],\r\n    //     function(values) {\r\n    //         // Combine first_name, middle_name (if present), and surname into full_name\r\n    //         var full_name = [values.first_name, values.middle_name, values.surname].filter(Boolean).join(' ');\r\n\r\n    //         var data = {\r\n    //             id_type: values.id_type,\r\n    //             id_number: values.id_number,\r\n    //             first_name: full_name,  // Store full_name in first_name field of child table\r\n    //             middle_name: values.middle_name,\r\n    //             surname: values.surname,\r\n    //             contact_no: values.contact_no,\r\n    //             married_anccop: values.married_anccop,\r\n    //             share_held: values.share_held,\r\n    //             designation: values.designation,\r\n    //             original_first_name: values.first_name, // Original first name\r\n    //             original_middle_name: values.middle_name // Original middle name\r\n    //         };\r\n    //         addDataToChildTable(frm, data);\r\n    //     }, 'Directors/ShareHolders');\r\n    // },\r\n\r\n    // add_new: function(frm) {\r\n    //     frappe.prompt([\r\n    //         {'fieldname': 'id_type', 'fieldtype': 'Select', 'options': '\\nDRIVING LICENSE\\nOMANG\\nPASSPORT', 'label': 'ID Type'},\r\n    //         {'fieldname': 'surname', 'fieldtype': 'Data', 'label': 'Surname'},\r\n    //         {'fieldname': 'first_name', 'fieldtype': 'Data', 'label': 'First Name'},\r\n    //          {'fieldname': 'middle_name', 'fieldtype': 'Data', 'label': 'Middle Name'},\r\n           \r\n    //         {'fieldname': 'fax_no', 'fieldtype': 'Data', 'label': 'Fax No'},\r\n    //         {'fieldname': '', 'fieldtype': 'Column Break'},\r\n    //         {'fieldname': 'id_number', 'fieldtype': 'Data', 'label': 'ID Number'},\r\n    //          {'fieldname': 'e_mail_id', 'fieldtype': 'Data', 'label': 'E-mail Id'},\r\n            \r\n    //         {'fieldname': 'contact_no', 'fieldtype': 'Phone', 'label': 'Contact No'},\r\n    //         {'fieldname': 'share_held', 'fieldtype': 'Data', 'label': '% Share Held'},\r\n    //         {'fieldname': 'married_anccop', 'fieldtype': 'Select','options': '\\nANC\\nCOP ', 'label': 'Married ANC/COP'},\r\n    //         {'fieldname': 'designation', 'fieldtype': 'Select', 'options': '\\nDIRECTOR\\nMEMBER\\nMANAGER\\nOTHERS\\nPARTNER\\nPROPRIETOR', 'label': 'Designation'}\r\n    //     ],\r\n    //     function(values) {\r\n    //         var data = {\r\n    //             id_type: values.id_type,\r\n    //             id_number: values.id_number,\r\n    //             first_name: values.first_name,\r\n    //             contact_no: values.contact_no,\r\n    //             married_anccop: values.married_anccop,\r\n    //             share_held: values.share_held,\r\n    //         };\r\n    //         addDataToChildTable(frm, data);\r\n    //     }, 'Directors/ShareHolders');\r\n    // },\r\n    \r\n\r\n    // add_new1: function(frm) {\r\n    //     frappe.prompt([\r\n    //         {'fieldname': 'name1', 'fieldtype': 'Data', 'label': 'Name'},\r\n    //         {'fieldname': 'registration_number', 'fieldtype': 'Data', 'label': 'Registration Number'},\r\n    //         {'fieldname': 'share_held', 'fieldtype': 'Data', 'label': '% Shares Held'},\r\n    //         {'fieldname': 'nature_of_business', 'fieldtype': 'Data', 'label': 'Nature Of Business'},\r\n    //         {'fieldname': '', 'fieldtype': 'Column Break'},\r\n    //         {'fieldname': 'bond_required', 'fieldtype': 'Data', 'label': 'Bond Required'},\r\n    //     ],\r\n    //     function(values) {\r\n    //         var data1 = {\r\n    //             name1: values.name1,\r\n    //             registration_number: values.registration_number,\r\n    //             share_held: values.share_held,\r\n    //             nature_of_business: values.nature_of_business,\r\n    //             bond_required: values.bond_required,\r\n    //         };\r\n    //         addDataToCompanyChildBondFacility(frm, data1);\r\n    //     }, 'Company');\r\n    // },\r\n     add_new: function(frm) {\r\n    const style = document.createElement('style');\r\n    style.innerHTML = `\r\n        .frappe-control[data-fieldname=\"contact_no\"] .form-control {\r\n            padding-top: 1px; /* Adjust the padding to shift the text */\r\n            box-sizing: border-box; /* Ensure padding does not affect the field's overall size */\r\n        }\r\n    `;\r\n    document.head.appendChild(style);\r\n\r\n    frappe.prompt([\r\n        {'fieldname': 'id_type', 'fieldtype': 'Select', 'options': '\\nDRIVING LICENSE\\nOMANG\\nPASSPORT', 'label': 'ID Type'},\r\n        {'fieldname': 'surname', 'fieldtype': 'Data', 'label': 'Surname'},\r\n        {'fieldname': 'first_name', 'fieldtype': 'Data', 'label': 'First Name'},\r\n        {'fieldname': 'middle_name', 'fieldtype': 'Data', 'label': 'Middle Name'},\r\n        {'fieldname': 'fax_no', 'fieldtype': 'Data', 'label': 'Fax No'},\r\n        {'fieldname': '', 'fieldtype': 'Column Break'},\r\n        {'fieldname': 'id_number', 'fieldtype': 'Data', 'label': 'ID Number'},\r\n        {'fieldname': 'e_mail_id', 'fieldtype': 'Data', 'label': 'Email ID'},\r\n        {'fieldname': 'contact_no', 'fieldtype': 'Phone', 'label': 'Contact No'},\r\n        {'fieldname': 'share_held', 'fieldtype': 'Data', 'label': '% Share Held'},\r\n        {'fieldname': 'married_anccop', 'fieldtype': 'Select', 'options': '\\nANC\\nCOP', 'label': 'Married ANC/COP'},\r\n        {'fieldname': 'designation', 'fieldtype': 'Select', 'options': '\\nDIRECTOR\\nMEMBER\\nMANAGER\\nOTHERS\\nPARTNER\\nPROPRIETOR', 'label': 'Designation'}\r\n    ], function(values) {\r\n        // Combine the names to create full_name\r\n        var name1 = [values.surname, values.first_name, values.middle_name].filter(Boolean).join(' ');\r\n\r\n        var data = {\r\n            id_type: values.id_type,\r\n            id_number: values.id_number,\r\n            first_name: values.first_name,\r\n            middle_name: values.middle_name,\r\n          //  surname: values.surname,\r\n            surname: values.last_name,\r\n            contact_no: values.contact_no,\r\n            married_anccop: values.married_anccop,\r\n            share_held: values.share_held,\r\n            name1: name1, // Add the full_name field\r\n            fax_no: values.fax_no, // Capture the fax_no as well\r\n            e_mail_id: values.e_mail_id, // Capture email id\r\n            designation: values.designation // Capture designation\r\n        };\r\n\r\n        // Call the function to add data to the child table  \r\n        addDataToChildTable(frm, data);\r\n\r\n        // Set the full_name back to the parent form if needed\r\n        frm.set_value('name1', name1); // This sets the full_name in the parent doctype if you have a field for it\r\n    }, 'Directors/ShareHolders', 'Add New Director');\r\n},\r\n\r\n    //  add_new1: function(frm) {\r\n    //     frappe.prompt([\r\n    //         {\r\n    //             'fieldname': 'name1',\r\n    //             'fieldtype': 'Link',\r\n    //             'label': 'Name',\r\n    //             'options': 'Company-Details',\r\n    //             'reqd': 1\r\n    //         },\r\n    //         {'fieldname': 'registration_number', 'fieldtype': 'Data', 'label': 'Registration Number'},\r\n    //         {'fieldname': 'share_held', 'fieldtype': 'Data', 'label': '% Shares Held'},\r\n    //          {'fieldname': '', 'fieldtype': 'Column Break'},\r\n    //         {'fieldname': 'nature_of_business', 'fieldtype': 'Data', 'label': 'Nature Of Business'},\r\n    //         // {'fieldname': '', 'fieldtype': 'Column Break'},\r\n    //         {\r\n    //             'fieldname': 'bond_required',\r\n    //             'fieldtype': 'Check',\r\n    //             'label': 'Bond Required'\r\n    //         },\r\n    //     ],\r\n    //     function(values) {\r\n    //         var data1 = {\r\n    //             name1: values.name1,\r\n    //             registration_number: values.registration_number,\r\n    //             share_held: values.share_held,\r\n    //             nature_of_business: values.nature_of_business,\r\n    //             bond_required: values.bond_required,\r\n    //         };\r\n    //         addDataToCompanyChildBondFacility(frm, data1);\r\n    //     }, 'Company');\r\n    // },\r\n add_new1: function(frm) {\r\n    frappe.prompt([\r\n        {\r\n            'fieldname': 'name1',\r\n            'fieldtype': 'Link',\r\n            'label': 'Name',\r\n            'options': 'Company-Details',\r\n            'reqd': 1\r\n        },\r\n        {'fieldname': 'registration_number', 'fieldtype': 'Data', 'label': 'Registration Number'},\r\n        {'fieldname': 'share_held', 'fieldtype': 'Data', 'label': '% Shares Held'},\r\n        {'fieldname': '', 'fieldtype': 'Column Break'},\r\n        {\r\n          //  'fieldname': 'nature_of_business',\r\n         // 'fieldtype': 'Select', \r\n          //'label': 'Nature Of Business',\r\n         // 'default': '' // Set default empty value initially\r\n         \r\n         \r\n    'fieldname': 'nature_of_business',\r\n    'fieldtype': 'Select',\r\n    'label': 'Nature Of Business',\r\n    'options': '\\nBUILDING CONSTRUCTION\\nBUILDING MAINTENANCE\\nCHEMICALS\\nCHEMICALS AND STATIONARY\\nCIVIL ENGINEERING\\nELECTRICAL ENGINEERING\\nENGINEERING CONSULTANCY\\nFREIGHT FORWARDING\\nFURNITURE AND HARDWARE\\nGENERAL DEALER\\nGOODS RETAILING\\nGOODS RETALING\\nHARDWARE\\nINSTRUMENTATION\\nIT PRODUCTS\\nLANDSCAPE CONTRACTORS\\nMANUFACTURER\\nMANUFACTURING\\nMECHANICAL CONTRACTORS\\nMECHANICAL ENGINEERING\\nMINING ENGINEERING\\nOTHERS\\nRESTAURANT\\nROAD CONSTRUCTION\\nROAD MAINTENANCE\\nSERVICES RETAILING\\nSTATIONARY\\nSTATIONARY AND COMPUTERS\\nSTATIONARY AND IT PRODUCTS\\nWHOLESALERS',\r\n    'default': ''  // Set default empty value initially\r\n\r\n\r\n        },\r\n        {\r\n            'fieldname': 'bond_required',\r\n            'fieldtype': 'Check',\r\n            'label': 'Bond Required'\r\n        },\r\n    ],\r\n    function(values) {\r\n        // This will automatically fetch the `nature_of_business` field\r\n        frm.fields_dict['nature_of_business'].get_query = function(doc, cdt, cdn) {\r\n            return {\r\n                filters: {\r\n                    'name': values.name1\r\n                }\r\n            };\r\n        };\r\n\r\n        // Fetch the business value from the selected Company-Details and auto-populate nature_of_business\r\n        frm.add_fetch('name1', 'business', 'nature_of_business');\r\n        \r\n        var data1 = {\r\n            name1: values.name1,\r\n            registration_number: values.registration_number,\r\n            share_held: values.share_held,\r\n            nature_of_business: values.nature_of_business,  // This will auto-populate based on the `add_fetch` line\r\n            bond_required: values.bond_required,\r\n        };\r\n\r\n        addDataToCompanyChildBondFacility(frm, data1);\r\n    }, 'Company');\r\n},\r\n\r\n\r\n\r\n\r\n\r\n    add_new2: function(frm) {\r\n        frappe.prompt([\r\n            {'fieldname': 'name_of_bankinsurance_company', 'fieldtype': 'Data', 'label': 'Name Of Bank/Insurance Company'},\r\n            {'fieldname': 'facility', 'fieldtype': 'Data', 'label': 'Facility'},\r\n            {'fieldname': 'bonds_out_standing', 'fieldtype': 'Data', 'label': 'Bond(s) OutStanding'},\r\n            {'fieldname': 'rate_charged', 'fieldtype': 'Data', 'label': 'Rate Charged'},\r\n        ],\r\n        function(values) {\r\n            var data1 = {\r\n                name_of_bankinsurance_company: values.name_of_bankinsurance_company,\r\n                facility: values.facility,\r\n                bonds_out_standing: values.bonds_out_standing,\r\n                rate_charged: values.rate_charged,\r\n            };\r\n            localStorage.setItem('current_bond', JSON.stringify(data1));\r\n            var current_bond = JSON.parse(localStorage.getItem('current_bond'));\r\n            addDataToCurrentBondChildBondFacility(frm, current_bond);\r\n        }, 'Current Bond');\r\n    },\r\n     add_new3: function(frm) {\r\n        frappe.prompt([\r\n            {'fieldname': 'name1', 'fieldtype': 'Data', 'label': 'Name'},\r\n            {'fieldname': 'position', 'fieldtype': 'Data', 'label': 'Position'},\r\n            {'fieldname': 'period_with_companyyears', 'fieldtype': 'Data', 'label': 'Period With Company(Years)'}\r\n        ],\r\n        function(values) {\r\n            var data1 = {\r\n                name1: values.name1,\r\n                position: values.position,\r\n                period_with_companyyears: values.period_with_companyyears\r\n            };\r\n            localStorage.setItem('personel_child', JSON.stringify(data1));\r\n            var personel_child = JSON.parse(localStorage.getItem('personel_child'));\r\n            addDataTopersonnelchildbondfacility(frm, personel_child);\r\n        }, 'Personnel');\r\n    },\r\n     add_new4: function(frm) {\r\n        frappe.prompt([\r\n            {'fieldname': 'company', 'fieldtype': 'Data', 'label': 'Company', 'reqd': 1},\r\n            {'fieldname': 'address', 'fieldtype': 'Data', 'label': 'Address', 'reqd': 1},\r\n            {'fieldname': 'type', 'fieldtype': 'Data', 'label': 'Type', 'reqd': 1}\r\n        ],\r\n        function(values) {\r\n            var data = {\r\n                company: values.company,\r\n                address: values.address,\r\n                type: values.type\r\n            };\r\n            localStorage.setItem('group_company', JSON.stringify(data));\r\n            var group_company = JSON.parse(localStorage.getItem('group_company'));\r\n            addDataToGroupCompanyChild(frm, group_company);\r\n        }, 'Group Company', 'Submit');\r\n    },\r\n     \r\n    \r\n    validate(frm) {\r\n         var acNo = frm.doc.ac_no;\r\n\r\n        console.log(acNo); // Check the value of ac_no\r\n\r\n        // Validate the ac_no to ensure it is exactly 10 digits\r\n        var acNoRegex = /^\\d{1,15}$/;\r\n        if (!acNoRegex.test(acNo)) {\r\n            frappe.msgprint(__(\"It allows only 11-digit for account number field.\"));\r\n            frappe.validated = false; // Prevent form submission\r\n        }\r\n\r\n    },\r\n    setup: function(frm) {\r\n        frm.fields_dict['client_name'].get_query = function(doc) {\r\n            return {\r\n                doctype: 'Company-Details',\r\n                filters: {\r\n                    'status': 'Active'\r\n                }\r\n            };\r\n        };\r\n    },\r\n     \r\n client_name: function(frm) {\r\n    if (frm.doc.client_name) {\r\n        frappe.call({\r\n            method: \"frappe.client.get_list\",\r\n            args: {\r\n                doctype: \"Bond Facility\",\r\n                filters: {\r\n                    client_name: frm.doc.client_name\r\n                },\r\n                fields: [\"name\"],\r\n                limit_page_length: 100000\r\n            },\r\n            callback: function(r) {\r\n                if (r.message && r.message.length > 0) {\r\n                    frappe.msgprint(__('Client already exists!'));\r\n                } else {\r\n                    // Check if the client name is 'approved'\r\n                    if (frm.doc.client_name.toLowerCase() === 'approved') {\r\n                        if (!frm.doc.msg_displayed) {\r\n                            frappe.msgprint(__('Client Name is approved!'));\r\n                            frm.set_value('msg_displayed', 1);\r\n                        } else {\r\n                            frappe.msgprint(__('The client name is already approved.'));\r\n                        }\r\n                    } else {\r\n                        // frm.set_value('msg_displayed', 0);\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\n\r\n});\r\nfunction addDataToChildTable(frm, data) {\r\n    // Add a new row to the child table\r\n    var newRow = frappe.model.add_child(frm.doc, 'Directors', 'directors');\r\n\r\n    // Directly set the values to the new row\r\n    newRow.id_type = data.id_type;\r\n    newRow.id_number = data.id_number;\r\n    newRow.first_name = data.first_name;\r\n    newRow.middle_name = data.middle_name;\r\n    newRow.surname = data.surname;\r\n    newRow.contact_no = data.contact_no;\r\n    newRow.married_anccop = data.married_anccop;\r\n    newRow.share_held = data.share_held;\r\n    newRow.fax_no = data.fax_no;\r\n    newRow.e_mail_id = data.e_mail_id;\r\n    newRow.designation = data.designation;\r\n\r\n    // Set the 'name' field in the child doctype to the full_name\r\n    newRow.name1 = data.name1;\r\n\r\n    // Refresh the child table to reflect the new row\r\n    frm.refresh_field('directors');\r\n}\r\n\r\n// Function to add data to the child table\r\n// function addDataToChildTable(frm, data) {\r\n//     var childTable = frm.fields_dict['directors'].grid;\r\n//     var newRow = frappe.model.add_child(frm.doc, childTable.doctype, 'directors');\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'id_type', data.id_type);\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'id_number', data.id_number);\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'first_name', data.first_name);\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'contact_no', data.contact_no);\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'married_anccop', data.married_anccop);\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'share_held', data.share_held);\r\n//     frm.refresh_field('directors');\r\n// }\r\n// function addDataToChildTable(frm, data) {\r\n//     // Add a new row to the child table 'directors'\r\n//     var newRow = frappe.model.add_child(frm.doc, 'Director Details', 'directors');\r\n\r\n//     // Set the values in the new child row\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'id_type', data.id_type);\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'id_number', data.id_number);\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'first_name', data.first_name); // Set full_name to first_name field\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'middle_name', data.middle_name); // Set middle_name\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'surname', data.surname); // Set surname\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'contact_no', data.contact_no);\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'married_anccop', data.married_anccop);\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'share_held', data.share_held);\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'designation', data.designation); // Set designation\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'original_first_name', data.original_first_name); // Set original first name\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'original_middle_name', data.original_middle_name); // Set original middle name\r\n\r\n//     // Refresh the field to show the updated child table\r\n//     frm.refresh_field('directors');\r\n// }\r\nfunction addDataToCompanyChildBondFacility(frm, data1) {\r\n    var childTable = frm.fields_dict['company_child'].grid;\r\n    var newRow = frappe.model.add_child(frm.doc, childTable.doctype, 'company_child');\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'name1', data1.name1);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'registration_number', data1.registration_number);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'share_held', data1.share_held);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'nature_of_business', data1. nature_of_business);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'bond_required', data1.bond_required);\r\n    frm.refresh_field('company_child');\r\n}\r\n\r\n\r\n// Function to add data to the company child bond facility table\r\n// function addDataToCompanyChildBondFacility(frm, data1) {\r\n//     var childTable = frm.fields_dict['company_child'].grid;\r\n//     var newRow = frappe.model.add_child(frm.doc, childTable.doctype, 'company_child');\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'name1', data1.name1);\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'registration_number', data1.registration_number);\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'share_held', data1.share_held);\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'nature_of_business', data1.nature_of_business);\r\n//     frappe.model.set_value(newRow.doctype, newRow.name, 'bond_required', data1.bond_required);\r\n//     frm.refresh_field('company_child');\r\n// }\r\n\r\nfunction addDataToCurrentBondChildBondFacility(frm, data) {\r\n    var childTable = frm.fields_dict['current_bond'].grid;\r\n    var newRow = frappe.model.add_child(frm.doc, childTable.doctype, 'current_bond');\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'name_of_bankinsurance_company', data.name_of_bankinsurance_company);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'facility', data.facility);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'bonds_out_standing', data.bonds_out_standing);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'rate_charged', data.rate_charged);\r\n    frm.refresh_field('current_bond');\r\n}\r\n\r\nfunction addDataTopersonnelchildbondfacility(frm, data) {\r\n    var childTable = frm.fields_dict['personel_child'].grid;\r\n    var newRow = frappe.model.add_child(frm.doc, childTable.doctype, 'personel_child');\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'name1', data.name1);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'position', data.position);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'period_with_companyyears', data.period_with_companyyears);\r\n    \r\n    frm.refresh_field('personel_child');\r\n}\r\nfunction addDataToGroupCompanyChild(frm, data) {\r\n    var childTable = frm.fields_dict['group_company'].grid;\r\n    var newRow = frappe.model.add_child(frm.doc, 'Group Company Child Doctype', 'group_company');\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'company', data.company);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'address', data.address);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'type', data.type);\r\n\r\n    frm.refresh_field('group_company');\r\n}\r\n \r\n// Auto generation of Proposal No\r\nfunction generateNumber(frm) {\r\n    if (!frm.doc.facility_no) {\r\n        let currentYear = new Date().getFullYear();\r\n        let prefix = `BFC/${currentYear}/`;\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Bond Facility',\r\n                fields: ['facility_no', 'creation'],\r\n                order_by: 'creation desc',\r\n                limit: 1\r\n            },\r\n            callback: function(r) {\r\n                if (r.message && r.message.length > 0) {\r\n                    let lastFacilityNo = r.message[0].facility_no;\r\n                    let lastNumber = parseInt(lastFacilityNo.split(\"/\").pop());\r\n                    if (!isNaN(lastNumber)) {\r\n                        let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n                        frm.set_value('facility_no', prefix + newNumber);\r\n                    }\r\n                } else {\r\n                    frm.set_value('facility_no', prefix + '0001');\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\n\r\n\r\n\r\n// Function to disable the file attachment if status is \"Submitted\"\r\n// function disable_attachment_based_on_status(frm) {\r\n//     // Check if the status is 'Submitted'\r\n//     // if (frm.doc.status === 'Submitted') {\r\n//     if (workflow_state === \"Submitted\") {\r\n//         // Disable the file attachment field\r\n//         frm.fields_dict['file_attach_fieldname'].grid.toggle_enable(false);\r\n//     } else {\r\n//         // Enable the file attachment field if status is not 'Submitted'\r\n//         frm.fields_dict['file_attach_fieldname'].grid.toggle_enable(true);\r\n//     }\r\n// }\r\n\r\n// Function to disable file attachment field if workflow state is \"Submitted\"\r\n// function clear_attachment(frm) {\r\n//     if (frm.doc.status === \"Submitted\" || frm.doc.workflow_state === \"Submitted\") {\r\n//         // Disable the file attachment field\r\n//         frm.set_df_property(\"file_attach_fieldname\", \"read_only\", 1);\r\n\r\n//         // Disable the \"Clear\" button after a short delay\r\n//         setTimeout(() => {\r\n//             $(\".btn[data-action='clear_attachment']\").prop(\"disabled\", true).addClass(\"disabled\");\r\n//         }, 500);\r\n\r\n//         // Observe the attachment section for changes\r\n//         const observer = new MutationObserver(() => {\r\n//             $(\".btn[data-action='clear_attachment']\").prop(\"disabled\", true).addClass(\"disabled\");\r\n//         });\r\n\r\n//         // Target the attachments area\r\n//         const targetNode = document.querySelector(\".frappe-control[data-fieldname='file_attach_fieldname']\");\r\n//         if (targetNode) {\r\n//             observer.observe(targetNode, { childList: true, subtree: true });\r\n//         }\r\n//     } else {\r\n//         // Enable the file attachment field\r\n//         frm.set_df_property(\"file_attach_fieldname\", \"read_only\", 0);\r\n\r\n//         // Enable the \"Clear\" button\r\n//         setTimeout(() => {\r\n//             $(\".btn[data-action='clear_attachment']\").prop(\"disabled\", false).removeClass(\"disabled\");\r\n//         }, 500);\r\n//     }\r\n// }\r\nfunction clear_attachment(frm) {\r\n    if (frm.doc.status === \"Submitted\" || frm.doc.workflow_state === \"Submitted\") {\r\n        // Disable the file attachment field\r\n        frm.set_df_property(\"file_attach_fieldname\", \"read_only\", 1);\r\n\r\n        // Disable the \"Clear\" button immediately\r\n        $(\".btn[data-action='clear_attachment']\").prop(\"disabled\", true).addClass(\"disabled\");\r\n    } else {\r\n        // Enable the file attachment field\r\n        frm.set_df_property(\"file_attach_fieldname\", \"read_only\", 0);\r\n\r\n        // Enable the \"Clear\" button immediately\r\n        $(\".btn[data-action='clear_attachment']\").prop(\"disabled\", false).removeClass(\"disabled\");\r\n    }\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Credit Limit Reviews",
  "enabled": 1,
  "modified": "2025-12-02 11:59:12.508105",
  "module": "UnderWriting",
  "name": "Credit Limit Reviews CS",
  "script": "frappe.ui.form.on('Credit Limit Reviews', {\r\n    refresh: function(frm) {\r\n        \r\n\r\n        \r\n        frm.set_df_property('review_history', 'cannot_add_rows', true);\r\n        if (!frm.doc.clreview_no) {\r\n            generateNumber(frm);\r\n        }\r\n         var workflowState = frm.doc.workflow_state || '';\r\n \r\n// Always keep original fields visible\r\nfrm.toggle_display('policy_number', true);\r\nfrm.toggle_display('buyer', true);\r\n \r\n// Make them read-only when approved\r\nif (workflowState === \"Approved\") {\r\n    frm.set_df_property('policy_number', 'read_only', 1);\r\n    frm.set_df_property('buyer', 'read_only', 1);\r\n} else {\r\n    frm.set_df_property('policy_number', 'read_only', 0);\r\n    frm.set_df_property('buyer', 'read_only', 0);\r\n}\r\n\r\n\r\n\r\n\r\n\r\n        if (workflowState === \"Approved\") {\r\n            frm.add_custom_button(__('Print Annexure'), function() {\r\n                frappe.new_doc('Credit Limit  Annexure');\r\n                    frappe.route_options = {\r\n                    inception_date: frm.doc.capture_date,\r\n                    policy_holder_name: frm.doc.ph_name,\r\n                    policy_no:frm.doc.policy_number,\r\n                    credit_limit_no: frm.doc.credit_limit_no,\r\n                    buyer_name:frm.doc.buyer,\r\n                    trading__style: frm.doc.trading_style,\r\n                  // reinsurer: frm.doc.reinsurer,\r\n                    location: frm.doc.location,\r\n                  credit_limit: frm.doc.current_limit,\r\n                    terms_of_payments: frm.doc.terms_of_payments,\r\n                    conditions: frm.doc.conditions,\r\n                    buyer_id: frm.doc.buyer_id,\r\n                    days_from:frm.doc.days_from\r\n                };\r\n                console.log(\"Print Annexur clicked!\");\r\n            }).addClass(\"btn-primary\");\r\n        }\r\n        \r\n        if (frm.doc.yes) {\r\n        \r\n        if (workflowState === \"Pending\" || workflowState === \"Approved\") {\r\n            frm.add_custom_button(__('View CB Report'), function() {\r\n                \r\n        frappe.call({\r\n        method: \"frappe.client.get\",\r\n        args: {\r\n            doctype: \"CB Report\",\r\n            filters: {\r\n                buyer: frm.doc.buyer,\r\n                refnumber: frm.doc.credit_limit_no,\r\n            },\r\n            fields: [\"cb_request_number\", \"reqdate\", \"buyer\", \"refnumber\", \"date\", \"catagory\", \"code\", \"details\", \"description\"]\r\n        },\r\n        callback: function (r) {\r\n            if (!r.exc) {\r\n                var cbReportData = r.message;\r\n                if (cbReportData) {\r\n                    // Open prompt dialog only if data is found\r\n                    frappe.prompt([\r\n                        {'fieldname': 'credit_bureau_request', 'fieldtype': 'Heading', 'label': 'Credit Bureau Request'},\r\n                        {'fieldname': 'section_break_2','fieldtype': 'Section Break','label': ''},\r\n                        \r\n                        {'fieldname': 'cb_request_number', 'fieldtype': 'Data', 'label': 'CB Req Number', 'default': cbReportData.cb_request_number},\r\n                        {'fieldname': 'reqdate', 'fieldtype': 'Date', 'label': 'Req.Date', 'default': cbReportData.reqdate},\r\n                        {'fieldname': 'column_break_1','fieldtype': 'Column Break','label': ''},\r\n                        {'fieldname': 'buyer', 'fieldtype': 'Data', 'label': 'Buyer', 'default': cbReportData.buyer},\r\n                        \r\n                       \r\n                        \r\n                        {'fieldname': 'refnumber', 'fieldtype': 'Data', 'label': 'Ref.Number','default': cbReportData.refnumber},\r\n                        \r\n                        {'fieldname': 'section_break_3','fieldtype': 'Section Break','label': ''},\r\n                        {'fieldname': 'section_break_4','fieldtype': 'Section Break','label': ''},\r\n                        {'fieldname': 'credit_bureau_responce', 'fieldtype': 'Heading', 'label': 'Credit Bureau Response'},\r\n                        {'fieldname': 'section_break_5','fieldtype': 'Section Break','label': ''},\r\n                        \r\n                        {'fieldname': 'date', 'fieldtype': 'Date', 'label': 'Date', 'default': cbReportData.date},\r\n                        {'fieldname': 'catagory', 'fieldtype': 'Data', 'label': 'Category', 'default': cbReportData.catagory},\r\n                        {'fieldname': 'code', 'fieldtype': 'Data', 'label': 'Code',  'default': cbReportData.code},\r\n                        \r\n                         {'fieldname': 'column_break_2','fieldtype': 'Column Break','label': ''},\r\n                        \r\n                        {'fieldname': 'details', 'fieldtype': 'Data', 'label': 'Details',  'default': cbReportData.details},\r\n                        {'fieldname': 'description', 'fieldtype': 'Small Text', 'label': 'Description', 'default': cbReportData.description},\r\n                    ], function(values){\r\n                        // Handle user input if needed\r\n                    }, 'CB Report');\r\n                } else {\r\n                    frappe.msgprint(\"No CB Report data found for the selected buyer.\");\r\n                }\r\n            } else {\r\n                console.error(\"Error occurred while fetching CB Report data:\", r.exc);\r\n                frappe.msgprint(\"Error occurred while fetching CB Report data. Please try again.\");\r\n            }\r\n        }\r\n    });\r\n                \r\n                \r\n                \r\n            }).addClass(\"btn-primary\");\r\n        }\r\n         }\r\n         \r\n        if(frm.doc.yes){\r\n          if (workflowState === \"Pending\" || workflowState === \"Approved\") {\r\n            frm.toggle_display('cbreport', true);\r\n            frm.toggle_display('report', false);\r\n            frm.toggle_display('cb_request', false);\r\n            // frm.toggle_display('table', false);\r\n\r\n        }\r\n        \r\n        \r\n        }\r\n        frm.fields_dict.director_share_holder_exposure.$input.addClass('btn-primary');\r\n\r\n        //  frm.fields_dict.cb_request.$input.addClass('btn-primary');\r\n        frm.fields_dict.go_to_financial_analysis.$input.addClass('btn-primary');\r\n        \r\n        \r\n        \r\n        alignFields(frm);\r\n        \r\n\r\n        \r\n\r\n        \r\n         \r\n    },\r\n   cb_request: function(frm) {\r\n    frappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'CB Request',\r\n        filters: {\r\n            buyer: frm.doc.buyer,\r\n            policy_type: frm.doc.policy_type\r\n        },\r\n        fields: ['toaddress', 'attention', 'from', 'attention1', 'subject']\r\n    },\r\n    callback: function (response) {\r\n        console.log(\"Bond Facility response:\", response);\r\n        \r\n        if (response.message && response.message.length > 0) {\r\n            // If records found, display a message\r\n            frappe.msgprint(\"CB Request already exists for this Buyer.\");\r\n        } else {\r\n            // If no records found, open a new CB Request document\r\n            frappe.new_doc('CB Request');\r\n            frappe.route_options = {\r\n                buyer: frm.doc.buyer,\r\n                refnumber: frm.doc.credit_limit_no,\r\n                policy_type: frm.doc.policy_type\r\n            };\r\n        }\r\n    },\r\n    error: function (err) {\r\n        console.error(err);\r\n        frappe.msgprint('An error occurred while fetching data from CB Request. Please check the console for details.');\r\n    }\r\n});\r\n\r\n},\r\n\r\n    \r\n   \r\n\r\n    go_to_financial_analysis: function(frm) {\r\n        frappe.new_doc('Financial Analysis');\r\n        frappe.route_options = {\r\n            buyer: frm.doc.buyer\r\n        };\r\n    },\r\n\r\n    director_share_holder_exposure: function(frm) {\r\n        openDirectorShareholderExposure(frm);\r\n    },\r\n\r\n    onload: function(frm) {\r\n       \r\n        \r\n\r\n            \r\n    //  frappe.call({\r\n    //   method: 'frappe.client.get_list',\r\n    //   args: {\r\n    //     'doctype': 'Credit Limit Processing',\r\n    //     'filters': {\r\n    //       'workflow_state': 'Approved'\r\n    //     },\r\n    //     'fields': ['policy_holder_name'],\r\n    //      limit_page_length: 100  // Adjust this value as needed\r\n\r\n    //   },\r\n    //   callback: function(submittedProposalsResponse) {\r\n    //     if (submittedProposalsResponse.message) {\r\n    //       var submittedProposals = submittedProposalsResponse.message.map(function(proposal) {\r\n    //         return proposal.policy_holder_name;\r\n    //       });\r\n    //       console.log(\"** Submitted Proposals:\", submittedProposals);\r\n \r\n    //       console.log(\"** Fetching Approved Quotations **\");\r\n    //       frm.set_df_property('ph_name', 'options', submittedProposals);\r\n    //     }\r\n    //   }\r\n    // }); // Close outer frappe.call\r\n  \r\n  \r\n  frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Credit Limit Processing',\r\n            'filters': {\r\n          'workflow_state': 'Approved'\r\n        },\r\n            fields: ['policy_holder_name'],\r\n            limit_page_length: 100000  // Adjust this value as needed\r\n\r\n        },\r\n        callback: function(response) {\r\n            console.log(\"policy_holder_name received:\", response);\r\n            let DataArray = response.message;\r\n            let uniquepolicy_holder_names = new Set();\r\n \r\n            // Collect unique policy_holder_name values\r\n            for (let x of DataArray) {\r\n                uniquepolicy_holder_names.add(x.policy_holder_name);\r\n            }\r\n \r\n            // Convert set to array\r\n            let FinalArray = Array.from(uniquepolicy_holder_names);\r\n \r\n            frm.set_df_property('ph_name', 'options', FinalArray);\r\n            console.log(\"final\", FinalArray);\r\n        },\r\n        error: function(xhr, textStatus, errorThrown) {\r\n            console.error(\"Error fetching policy_holder_name:\", textStatus, errorThrown);\r\n        }\r\n    });  \r\n    \r\n    \r\n// frappe.call({\r\n//             method: 'frappe.client.get_list',\r\n//             args: {\r\n//                 doctype: 'Buyer',\r\n//                 fields: ['buyer_name'],\r\n//                 limit_page_length: 100000  // Add this line to retrieve up to 100 records\r\n//             },\r\n//             callback: function(response) {\r\n//                 let DataArray = response.message;\r\n//                 let FinalArray = [];\r\n//                 for (let x of DataArray) {\r\n//                     FinalArray.push(x.buyer_name);\r\n//                 }\r\n//                 frm.set_df_property('buyer', 'options', FinalArray);\r\n//                 console.log(\"final\", FinalArray);\r\n//             },\r\n//             error: function(xhr, textStatus, errorThrown) {\r\n//                 console.error(\"Error fetching approved bonds:\", textStatus, errorThrown);\r\n//             }\r\n//         });\r\n    \r\n//     if (frm.doc.policy_number && frm.doc.ph_name) {\r\n//     frappe.call({\r\n//         method: 'frappe.client.get_list',\r\n//         args: {\r\n//             doctype: 'Credit Limit Processing',\r\n//             filters: {\r\n//                 policy_no: frm.doc.policy_number,\r\n//                 policy_holder_name: frm.doc.ph_name\r\n//             },\r\n//             fields: ['buyer_name'],\r\n//             limit_page_length: 100000\r\n//         },\r\n//         callback: function(response) {\r\n//             if (response.message && response.message.length > 0) {\r\n//                 // Extract unique buyer names\r\n//                 let buyerList = [...new Set(response.message.map(x => x.buyer_name))];\r\n//                 frm.set_df_property('buyer', 'options', buyerList.join('\\n'));\r\n//                 frm.refresh_field('buyer');\r\n//                 console.log(\"\u2705 Final Buyer List:\", buyerList);\r\n//             } else {\r\n//                 frm.set_df_property('buyer', 'options', '');\r\n//                 frm.refresh_field('buyer');\r\n//                 console.log(\"\u26a0\ufe0f No buyers found for given filters.\");\r\n//             }\r\n//         },\r\n//         error: function(xhr, textStatus, errorThrown) {\r\n//             console.error(\"\u274c Error fetching buyer list:\", textStatus, errorThrown);\r\n//         }\r\n//     });\r\n// }\r\n\r\n    \r\n    //   frappe.call({\r\n    //         method: 'frappe.client.get_list',\r\n    //         args: {\r\n    //             doctype: 'Credit Limit Reviews', // Replace with the actual doctype name\r\n    //             filters: {\r\n    //                 // Define your filters here\r\n    //                 ph_name: frm.doc.ph_name,\r\n    //                 buyer: frm.doc.buyer,\r\n    //                 // Add more filters if needed\r\n    //             },\r\n    //             fields: ['clreview_no', 'date', 'cl_review_date', 'current_limit', 'reasons']\r\n    //         },\r\n    //         callback: function(response) {\r\n    //             if (response.message && response.message.length > 0) {\r\n    //                 response.message.forEach(function(row) {\r\n    //                     // Add row to review_history child table\r\n    //                     let new_row = frm.add_child('review_history');\r\n    //                     new_row.cl_review_no = row.clreview_no;\r\n    //                     new_row.review_date = row.date;\r\n    //                     new_row.expiry_date = row.cl_review_date;\r\n    //                     new_row.credit_limit = row.current_limit;\r\n    //                     new_row.reason = row.reasons;\r\n    //                 });\r\n    //                 frm.refresh_field('review_history');\r\n    //             }\r\n            \r\n    //     }\r\n    \r\n    // });\r\n    \r\n    \r\n\r\n    \r\n\r\n},\r\n\r\n\r\nbuyer: function(frm){\r\nfrappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Buyer',\r\n        filters: {\r\n            buyer_name: frm.doc.buyer\r\n        },\r\n        fields: ['estddate', 'no_of_employees']\r\n    },\r\n    callback: function(response) {\r\n        // Check if response is valid\r\n                if (response.message && response.message.length > 0) {\r\n\r\n                var buyerdata = response.message[0];\r\n\r\n\r\n                // Example: Set values to fields in the form\r\n                frm.set_value('estd_date', buyerdata.estddate || '');\r\n                frm.set_value('no_of_employees', buyerdata.no_of_employees || '');\r\n   \r\n                }\r\n                else{\r\n                    frm.set_value('estd_date', '');\r\n                    frm.set_value('no_of_employees', '');\r\n                }\r\n                }\r\n});\r\n\r\n\r\n\r\n                         fetchAndPopulateReviewHistory(frm);\r\n                         \r\n                         \r\n                         \r\n\r\n\r\n\r\n\r\n},\r\n\r\n// ph_name: function(frm) {\r\n//     frappe.call({\r\n//         method: 'frappe.client.get_list',\r\n//         args: {\r\n//             doctype: 'Credit Limit Processing',\r\n//             filters: {\r\n//                 policy_holder_name: frm.doc.ph_name\r\n//             },\r\n//             fields: ['policy_no'],\r\n//             limit_page_length: 0\r\n//         },\r\n//         callback: function(response) {\r\n//             console.log(\"Response:\", response); // Debug: full response\r\n\r\n//             if (response.message && response.message.length > 0) {\r\n//                 // Extract and deduplicate policy numbers\r\n//                 let policyNumbers = [...new Set(response.message.map(item => item.policy_number))];\r\n//                 console.log(\"Unique Policy Numbers:\", policyNumbers); // Debug: unique list\r\n\r\n//                 // Set dropdown options\r\n//                 frm.set_df_property('policy_number', 'options', policyNumbers.join('\\n'));\r\n//                 frm.refresh_field('policy_number');\r\n//             } else {\r\n//                 // Clear dropdown if nothing found\r\n//                 frm.set_df_property('policy_number', 'options', '');\r\n//                 frm.refresh_field('policy_number');\r\n//             }\r\n//         }\r\n//     });\r\n\r\n\r\n// },\r\n\r\n\r\nph_name: function(frm) {\r\n    if (!frm.doc.ph_name) {\r\n        frm.set_df_property('policy_number', 'options', '');\r\n        frm.refresh_field('policy_number');\r\n        return;\r\n    }\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Credit Limit Processing',\r\n            filters: {\r\n                policy_holder_name: frm.doc.ph_name\r\n            },\r\n            fields: ['policy_no'],   // \u2714 Correct field\r\n            limit_page_length: 0\r\n        },\r\n        callback: function(response) {\r\n            console.log(\"Response:\", response);\r\n\r\n            if (response.message && response.message.length > 0) {\r\n\r\n                // \u2714 Extract and deduplicate policy_no values\r\n                let policyNumbers = [...new Set(response.message.map(item => item.policy_no))];\r\n\r\n                console.log(\"Unique Policy Numbers:\", policyNumbers);\r\n\r\n                // \u2714 Load into dropdown\r\n                frm.set_df_property('policy_number', 'options', policyNumbers.join('\\n'));\r\n                frm.refresh_field('policy_number');\r\n\r\n            } else {\r\n                // \u2714 No records\r\n                frm.set_df_property('policy_number', 'options', '');\r\n                frm.refresh_field('policy_number');\r\n            }\r\n        }\r\n    });\r\n},\r\n\r\n \r\n\r\n\r\n\r\n// ph_name: function(frm) {\r\n//         var phName = frm.doc.ph_name;\r\n\r\n//         // Fetch data from Credit Limit Processing based on policy_holder_name\r\n//         frappe.call({\r\n//             method: 'frappe.client.get_list',\r\n//             args: {\r\n//                 doctype: 'Credit Limit Processing',\r\n//                 filters: {\r\n//                     policy_holder_name: phName\r\n//                 },\r\n//                 fields: ['days_from','policy_number','credit_limit_no', 'use_of_the_credit_limit', 'capture_date', 'policy_holder_name', 'trading__style', 'credit_limit', 'business_organisation', 'type_of_business', 'customers', 'location', 'present_mgt_in_control_since', 'management_experience', 'bank_risk_category', 'itc_clearence', 'main_productservice', 'total_exposure', 'level_of_competition', 'management_consists_of', 'credit_bureau_opinion', 'financials', 'trading_experience', 'overdue_amount', 'balance_sheet_analysis', 'annual_sales_for_the_last_23_years', 'terms_of_payments', 'outstanding_amount', 'repayment_ability', 'comments', 'policy_type']\r\n//             },\r\n//             callback: function(response) {\r\n//                 console.log(\"Credit Limit Processing response:\", response);\r\n\r\n//                 if (response.message && response.message.length > 0) {\r\n//                     var data = response.message[0];\r\n\r\n//                     // Populate fields if data is found\r\n//                     frm.set_value('policy_number', data.policy_number || '');\r\n//                     frm.set_value('credit_limit_no', data.credit_limit_no || '');\r\n//                     frm.set_value('use_of_the_credit_limit', data.use_of_the_credit_limit || '');\r\n//                     frm.set_value('inception_date', data.capture_date || '');\r\n//                     frm.set_value('ph_name', data.policy_holder_name || '');\r\n//                     frm.set_value('trading_style', data.trading__style || '');\r\n//                     frm.set_value('current_limit', data.credit_limit || '');\r\n//                     frm.set_value('business_organisation', data.business_organisation || '');\r\n//                     frm.set_value('type__of_business', data.type_of_business || '');\r\n//                     frm.set_value('customers', data.customers || '');\r\n//                     frm.set_value('location', data.location || '');\r\n//                     frm.set_value('present_mgt_in_control_since', data.present_mgt_in_control_since || '');\r\n//                     frm.set_value('management_experience', data.management_experience || '');\r\n//                     frm.set_value('bank_risk_category', data.bank_risk_category || '');\r\n//                     frm.set_value('itc_clearence', data.itc_clearence || '');\r\n//                     frm.set_value('main_product_service', data.main_productservice || '');\r\n//                     frm.set_value('total_exposure', data.total_exposure || '');\r\n//                     frm.set_value('level_of_competition', data.level_of_competition || '');\r\n//                     frm.set_value('management_consists_of', data.management_consists_of || '');\r\n//                     frm.set_value('credit_bureau_opinion', data.credit_bureau_opinion || '');\r\n//                     frm.set_value('financials', data.financials || '');\r\n//                     frm.set_value('trading_experience', data.trading_experience || '');\r\n//                     frm.set_value('overdue_amount', data.overdue_amount || '');\r\n//                     frm.set_value('balance_sheet_analysis', data.balance_sheet_analysis || '');\r\n//                     frm.set_value('annual_sales_for_the_last_23years', data.annual_sales_for_the_last_23_years || '');\r\n//                     frm.set_value('terms_of_payments', data.terms_of_payments || '');\r\n//                     frm.set_value('outstanding_amount', data.outstanding_amount || '');\r\n//                     frm.set_value('repayment_ability', data.repayment_ability || '');\r\n//                     frm.set_value('comments1', data.comments || '');\r\n//                     frm.set_value('policy_type', data.policy_type || '');\r\n//                     frm.set_value('days_from', data.days_from || '');\r\n//                 } else {\r\n//                     // Clear fields if no matching record found\r\n//                     frm.set_value('policy_number', '');\r\n//                     frm.set_value('days_from', '');\r\n//                     frm.set_value('credit_limit_no', '');\r\n//                     frm.set_value('use_of_the_credit_limit', '');\r\n//                     frm.set_value('inception_date', '');\r\n//                     frm.set_value('ph_name', '');\r\n//                     frm.set_value('trading__style', '');\r\n//                     frm.set_value('current_limit', '');\r\n//                     frm.set_value('business_organisation', '');\r\n//                     frm.set_value('type_of_business', '');\r\n//                     frm.set_value('customers', '');\r\n//                     frm.set_value('location', '');\r\n//                     frm.set_value('present_mgt_in_control_since', '');\r\n//                     frm.set_value('management_experience', '');\r\n//                     frm.set_value('bank_risk_category', '');\r\n//                     frm.set_value('itc_clearence', '');\r\n//                     frm.set_value('main_productservice', '');\r\n//                     frm.set_value('total_exposure', '');\r\n//                     frm.set_value('level_of_competition', '');\r\n//                     frm.set_value('management_consists_of', '');\r\n//                     frm.set_value('credit_burea_report', '');\r\n//                     frm.set_value('financials', '');\r\n//                     frm.set_value('trading_experience', '');\r\n//                     frm.set_value('overdue_amount', '');\r\n//                     frm.set_value('balance_sheet_analysis', '');\r\n//                     frm.set_value('annual_sales_for_the_last_23years', '');\r\n//                     frm.set_value('terms_of_payments', '');\r\n//                     frm.set_value('outstanding_amount', '');\r\n//                     frm.set_value('repayment_ability', '');\r\n//                     frm.set_value('comments1', '');\r\n//                     frm.set_value('policy_type', '');\r\n//                     frappe.msgprint('No matching record found in Credit Limit Processing.');\r\n//                 }\r\n\r\n//                 // Fetch and populate review_history child table\r\n//                 fetchReviewHistory(frm, phName);\r\n//             },\r\n            \r\n//         });\r\n        \r\n        \r\n       \r\n\r\n\r\n//     },\r\n    \r\n    \r\n    \r\n    \r\n    \r\n    // policy_number: function(frm) {\r\n    //     var PolicyNumber = frm.doc.policy_number;\r\n    //     frm.set_value('policy_number1', PolicyNumber);\r\n\r\n\r\n    //     // Fetch data from Credit Limit Processing based on policy_holder_name\r\n    //     frappe.call({\r\n    //         method: 'frappe.client.get_list',\r\n    //         args: {\r\n    //             doctype: 'Credit Limit Processing',\r\n    //             filters: {\r\n    //                 policy_number: PolicyNumber\r\n    //             },\r\n    //             fields: ['days_from','credit_limit_no', 'use_of_the_credit_limit', 'capture_date', 'trading__style', 'credit_limit', 'business_organisation', 'type_of_business', 'customers', 'location', 'present_mgt_in_control_since', 'management_experience', 'bank_risk_category', 'itc_clearence', 'main_productservice', 'total_exposure', 'level_of_competition', 'management_consists_of', 'credit_bureau_opinion', 'financials', 'trading_experience', 'overdue_amount', 'balance_sheet_analysis', 'annual_sales_for_the_last_23_years', 'terms_of_payments', 'outstanding_amount', 'repayment_ability', 'comments', 'policy_type']\r\n    //         },\r\n    //         callback: function(response) {\r\n    //             console.log(\"Credit Limit Processing response:\", response);\r\n\r\n    //             if (response.message && response.message.length > 0) {\r\n    //                 var data = response.message[0];\r\n\r\n    //                 // Populate fields if data is found\r\n    //                 // frm.set_value('policy_number', data.policy_number || '');\r\n    //                 frm.set_value('credit_limit_no', data.credit_limit_no || '');\r\n    //                 frm.set_value('use_of_the_credit_limit', data.use_of_the_credit_limit || '');\r\n    //                 frm.set_value('inception_date', data.capture_date || '');\r\n    //                 // frm.set_value('ph_name', data.policy_holder_name || '');\r\n    //                 frm.set_value('trading_style', data.trading__style || '');\r\n    //                 frm.set_value('current_limit', data.credit_limit || '');\r\n    //                 frm.set_value('business_organisation', data.business_organisation || '');\r\n    //                 frm.set_value('type__of_business', data.type_of_business || '');\r\n    //                 frm.set_value('customers', data.customers || '');\r\n    //                 frm.set_value('location', data.location || '');\r\n    //                 frm.set_value('present_mgt_in_control_since', data.present_mgt_in_control_since || '');\r\n    //                 frm.set_value('management_experience', data.management_experience || '');\r\n    //                 frm.set_value('bank_risk_category', data.bank_risk_category || '');\r\n    //                 frm.set_value('itc_clearence', data.itc_clearence || '');\r\n    //                 frm.set_value('main_product_service', data.main_productservice || '');\r\n    //                 frm.set_value('total_exposure', data.total_exposure || '');\r\n    //                 frm.set_value('level_of_competition', data.level_of_competition || '');\r\n    //                 frm.set_value('management_consists_of', data.management_consists_of || '');\r\n    //                 frm.set_value('credit_bureau_opinion', data.credit_bureau_opinion || '');\r\n    //                 frm.set_value('financials', data.financials || '');\r\n    //                 frm.set_value('trading_experience', data.trading_experience || '');\r\n    //                 frm.set_value('overdue_amount', data.overdue_amount || '');\r\n    //                 frm.set_value('balance_sheet_analysis', data.balance_sheet_analysis || '');\r\n    //                 frm.set_value('annual_sales_for_the_last_23years', data.annual_sales_for_the_last_23_years || '');\r\n    //                 frm.set_value('terms_of_payments', data.terms_of_payments || '');\r\n    //                 frm.set_value('outstanding_amount', data.outstanding_amount || '');\r\n    //                 frm.set_value('repayment_ability', data.repayment_ability || '');\r\n    //                 frm.set_value('comments1', data.comments || '');\r\n    //                 frm.set_value('policy_type', data.policy_type || '');\r\n    //                 frm.set_value('days_from', data.days_from || '');\r\n    //             } else {\r\n    //                 // Clear fields if no matching record found\r\n    //                 // frm.set_value('policy_number', '');\r\n    //                 frm.set_value('days_from', '');\r\n    //                 frm.set_value('credit_limit_no', '');\r\n    //                 frm.set_value('use_of_the_credit_limit', '');\r\n    //                 frm.set_value('inception_date', '');\r\n    //                 // frm.set_value('ph_name', '');\r\n    //                 frm.set_value('trading_style', '');\r\n    //                 frm.set_value('current_limit', '');\r\n    //                 frm.set_value('business_organisation', '');\r\n    //                 frm.set_value('type__of_business', '');\r\n    //                 frm.set_value('customers', '');\r\n    //                 frm.set_value('location', '');\r\n    //                 frm.set_value('present_mgt_in_control_since', '');\r\n    //                 frm.set_value('management_experience', '');\r\n    //                 frm.set_value('bank_risk_category', '');\r\n    //                 frm.set_value('itc_clearence', '');\r\n    //                 frm.set_value('main_product_service', '');\r\n    //                 frm.set_value('total_exposure', '');\r\n    //                 frm.set_value('level_of_competition', '');\r\n    //                 frm.set_value('management_consists_of', '');\r\n    //                 frm.set_value('credit_burea_report', '');\r\n    //                 frm.set_value('financials', '');\r\n    //                 frm.set_value('trading_experience', '');\r\n    //                 frm.set_value('overdue_amount', '');\r\n    //                 frm.set_value('balance_sheet_analysis', '');\r\n    //                 frm.set_value('annual_sales_for_the_last_23years', '');\r\n    //                 frm.set_value('terms_of_payments', '');\r\n    //                 frm.set_value('outstanding_amount', '');\r\n    //                 frm.set_value('repayment_ability', '');\r\n    //                 frm.set_value('comments1', '');\r\n    //                 frm.set_value('policy_type', '');\r\n    //             }\r\n\r\n    //             // Fetch and populate review_history child table\r\n    //             fetchReviewHistory(frm, phName);\r\n    //         },\r\n            \r\n    //     });\r\n        \r\n        \r\n       \r\n\r\n\r\n    // },///main\r\n\r\n\r\n\r\npolicy_number: function(frm) {\r\n    var PolicyNumber = frm.doc.policy_number;\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Credit Limit Processing',\r\n            filters: {\r\n                policy_number: PolicyNumber\r\n            },\r\n            fields: ['buyer_id','days_from', 'credit_limit_no', 'use_of_the_credit_limit',\r\n            'capture_date', 'trading__style', 'credit_limit', 'business_organisation',\r\n            'type_of_business', 'customers', 'location', 'present_mgt_in_control_since', \r\n            'management_experience', 'bank_risk_category', 'itc_clearence', \r\n            'main_productservice', 'total_expouse', 'level_of_competition', \r\n            'management_consists_of', 'credit_bureau_opinion', 'financials', \r\n            'trading_experience', 'overdue_amount', 'balance_sheet_analysis', \r\n            'annual_sales_for_the_last_23_years', 'terms_of_payments', 'outstanding_amount',\r\n            'repayment_ability', 'comments', 'policy_type','yes','no']\r\n        },\r\n        callback: function(response) {\r\n            console.log(\"Credit Limit Processing response:\", response);\r\n\r\n            if (response.message && response.message.length > 0) {\r\n                var data = response.message[0];\r\n\r\n                frappe.call({\r\n                    method: 'frappe.client.get_list',\r\n                    args: {\r\n                        doctype: 'Credit Limit Reviews',\r\n                        filters: {\r\n                            policy_number: PolicyNumber,\r\n                            workflow_state: 'Approved'\r\n                        },\r\n                        fields: ['policy_number']\r\n                    },\r\n                    callback: function(approvedResponse) {\r\n                        // if (approvedResponse.message && approvedResponse.message.length > 0) {\r\n                        //     frappe.msgprint('This policy number is already approved.');\r\n                        // } \r\n                            // Populate fields if data is found\r\n                            frm.set_value('credit_limit_no', data.credit_limit_no || '');\r\n                            frm.set_value('buyer_id', data.buyer_id || '');\r\n                            frm.set_value('yes', data.yes || '');\r\n                            frm.set_value('no', data.no || '');\r\n\r\n\r\n\r\n                            frm.set_value('use_of_the_credit_limit', data.use_of_the_credit_limit || '');\r\n                            frm.set_value('inception_date', data.capture_date || '');\r\n                \r\n                            frm.set_value('trading_style', data.trading__style || '');\r\n                            frm.set_value('current_limit', data.credit_limit || '');\r\n                            frm.set_value('business_organisation', data.business_organisation || '');\r\n                            frm.set_value('type__of_business', data.type_of_business || '');\r\n                            frm.set_value('customers', data.customers || '');\r\n                            frm.set_value('location', data.location || '');\r\n                            frm.set_value('present_mgt_in_control_since', data.present_mgt_in_control_since || '');\r\n                            frm.set_value('management_experience', data.management_experience || '');\r\n                            frm.set_value('bank_risk_category', data.bank_risk_category || '');\r\n                            frm.set_value('itc_clearence', data.itc_clearence || '');\r\n                            frm.set_value('main_product_service', data.main_productservice || '');\r\n                            frm.set_value('total_exposure', data.total_expouse || '');\r\n                            frm.set_value('level_of_competition', data.level_of_competition || '');\r\n                            frm.set_value('management_consists_of', data.management_consists_of || '');\r\n                            frm.set_value('credit_bureau_opinion', data.credit_bureau_opinion || '');\r\n                            frm.set_value('financials', data.financials || '');\r\n                            frm.set_value('trading_experience', data.trading_experience || '');\r\n                            frm.set_value('overdue_amount', data.overdue_amount || '');\r\n                            frm.set_value('balance_sheet_analysis', data.balance_sheet_analysis || '');\r\n                            frm.set_value('annual_sales_for_the_last_23years', data.annual_sales_for_the_last_23_years || '');\r\n                            frm.set_value('terms_of_payments', data.terms_of_payments || '');\r\n                            frm.set_value('outstanding_amount', data.outstanding_amount || '');\r\n                            frm.set_value('repayment_ability', data.repayment_ability || '');\r\n                            frm.set_value('comments1', data.comments || '');\r\n                            frm.set_value('policy_type', data.policy_type || '');\r\n                            frm.set_value('days_from', data.days_from || '');\r\n                        \r\n                    },\r\n                    error: function(err) {\r\n                        console.error(\"Error fetching approved policy numbers:\", err);\r\n                        frappe.msgprint('An error occurred while checking approved policy numbers. Please check the console for details.');\r\n                    }\r\n                });\r\n\r\n                \r\n\r\n            } else {\r\n                // Clear fields if no matching record found\r\n                frm.set_value('buyer_id', '');\r\n                frm.set_value('days_from', '');\r\n                frm.set_value('credit_limit_no', '');\r\n                frm.set_value('use_of_the_credit_limit', '');\r\n                frm.set_value('inception_date', '');\r\n                frm.set_value('trading_style', '');\r\n                frm.set_value('current_limit', '');\r\n                frm.set_value('business_organisation', '');\r\n                frm.set_value('type__of_business', '');\r\n                frm.set_value('customers', '');\r\n                frm.set_value('location', '');\r\n                frm.set_value('present_mgt_in_control_since', '');\r\n                frm.set_value('management_experience', '');\r\n                frm.set_value('bank_risk_category', '');\r\n                frm.set_value('itc_clearence', '');\r\n                frm.set_value('main_product_service', '');\r\n                frm.set_value('total_exposure', '');\r\n                frm.set_value('level_of_competition', '');\r\n                frm.set_value('management_consists_of', '');\r\n                frm.set_value('credit_bureau_opinion', '');\r\n                frm.set_value('financials', '');\r\n                frm.set_value('trading_experience', '');\r\n                frm.set_value('overdue_amount', '');\r\n                frm.set_value('balance_sheet_analysis', '');\r\n                frm.set_value('annual_sales_for_the_last_23years', '');\r\n                frm.set_value('terms_of_payments', '');\r\n                frm.set_value('outstanding_amount', '');\r\n                frm.set_value('repayment_ability', '');\r\n                frm.set_value('comments1', '');\r\n                frm.set_value('policy_type', '');\r\n                frm.set_value('yes', '');\r\n                frm.set_value('no', '');\r\n\r\n            }\r\n        },\r\n        error: function(err) {\r\n            console.error(\"Error fetching Credit Limit Processing data:\", err);\r\n            frappe.msgprint('An error occurred while fetching Credit Limit Processing data. Please check the console for details.');\r\n        }\r\n    });\r\n    \r\n//   frappe.call({\r\n//         method: 'frappe.client.get_list',\r\n//         args: {\r\n//             doctype: 'Credit Limit Processing',\r\n//             filters: {\r\n//                 policy_no: frm.doc.policy_number,\r\n//                 policy_holder_name: frm.doc.ph_name\r\n//             },\r\n//             fields: ['buyer_name'],\r\n//             limit_page_length: 100000\r\n//         },\r\n//         callback: function(response) {\r\n//             if (response.message && response.message.length > 0) {\r\n//                 // Extract unique buyer names\r\n//                 let buyerList = [...new Set(response.message.map(x => x.buyer_name))];\r\n//                 frm.set_df_property('buyer', 'options', buyerList.join('\\n'));\r\n//                 frm.refresh_field('buyer');\r\n//                 console.log(\"\u2705 Final Buyer List:\", buyerList);\r\n//             } else {\r\n//                 frm.set_df_property('buyer', 'options', '');\r\n//                 frm.refresh_field('buyer');\r\n//                 console.log(\"\u26a0\ufe0f No buyers found for given filters.\");\r\n//             }\r\n//         },\r\n//         error: function(xhr, textStatus, errorThrown) {\r\n//             console.error(\"\u274c Error fetching buyer list:\", textStatus, errorThrown);\r\n//         }\r\n//     }); \r\n\r\n\r\nfrappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Credit Limit Processing',\r\n        filters: {\r\n            policy_no: frm.doc.policy_number,\r\n            policy_holder_name: frm.doc.ph_name\r\n        },\r\n        fields: ['buyer_name'],\r\n        limit_page_length: 100000\r\n    },\r\n        callback: function(response) {\r\n            if (response.message && response.message.length > 0) {\r\n                var buyerList = [...new Set(response.message.map(x => x.buyer_name))];\r\n                frm.set_df_property('buyer', 'options', buyerList.join('\\n'));\r\n                frm.refresh_field('buyer');\r\n                console.log(\"\u2705 Final Buyer List:\", buyerList);\r\n            } else {\r\n                frm.set_df_property('buyer', 'options', '');\r\n                frm.refresh_field('buyer');\r\n                console.log(\"\u26a0\ufe0f No buyers found for given filters.\");\r\n            }\r\n        },\r\n    error: function(xhr, textStatus, errorThrown) {\r\n        console.error(\"\u274c Error fetching buyer list:\", textStatus, errorThrown);\r\n    }\r\n});\r\n\r\n    \r\n},\r\n\r\n\r\n\r\n\r\n\r\n    inception_date: function(frm){\r\n \r\n      frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Policy Approvals',\r\n                filters: {\r\n                    policy_holder: frm.doc.ph_name\r\n                },\r\n                fields: ['inception_date']\r\n            },\r\n            callback: function(response) {\r\n                console.log('capture');\r\n                if (response.message && response.message.length > 0) {\r\n                    var policyApproval = response.message[0];\r\n                    var inceptionDate = policyApproval.inception_date;\r\n\r\n                    console.log(\"Inception Date:\", inceptionDate);\r\n                    \r\n\r\n                    var expiryDate = new Date(inceptionDate);\r\n                    expiryDate.setFullYear(expiryDate.getFullYear() + 1);\r\n\r\n                    frm.set_value('policy_expiry_date', frappe.datetime.str_to_user(expiryDate));\r\n                    console.log(\"Policy Expiry Date:\", frm.doc.policy_expiry_date);\r\n                } \r\n            }\r\n        }); \r\n    },\r\n    \r\n    \r\n  \r\n   });\r\n\r\n\r\n\r\nfunction generateNumber(frm) {\r\n    if (!frm.doc.clreview_no) {\r\n        var currentYear = new Date().getFullYear();\r\n        var prefix = `CLRV/${currentYear}/`;\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Credit Limit Reviews',\r\n                fields: ['clreview_no', 'creation'],\r\n                order_by: 'creation desc',\r\n                limit: 1\r\n            },\r\n            callback: function(r) {\r\n                if (r.message && r.message.length > 0) {\r\n                    var lastClreviewNo = r.message[0].clreview_no;\r\n                    var lastNumber = parseInt(lastClreviewNo.split(\"/\").pop());\r\n                    if (!isNaN(lastNumber)) {\r\n                        var newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n                        frm.set_value('clreview_no', prefix + newNumber);\r\n                    }\r\n                } else {\r\n                    frm.set_value('clreview_no', prefix + '0001');\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error('Error fetching credit limit reviews:', err);\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\nfunction openDirectorShareholderExposure(frm) {\r\n    frappe.new_doc('Director and Shareholder Exposure');\r\n    frappe.route_options = {\r\n        buyer_name: frm.doc.buyer\r\n    };\r\n        frappe.ui.form.on('Director and Shareholder Exposure', {\r\n        onload: function(frm) {\r\n            // Hide the specific fields and search button\r\n            frm.toggle_display('director_shareholder', false);\r\n            frm.toggle_display('search',false);\r\n            // Replace 'director_shareholder_field' with the actual field name you want to hide\r\n            frm.page.btn_primary.hide(); // Hides the primary button, typically the save button\r\n \r\n           \r\n            $('.search-btn-class').hide();\r\n        }\r\n    });\r\n\r\n}\r\n\r\nfunction fetchAndPopulateReviewHistory(frm) {\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Credit Limit Reviews',\r\n            filters: {\r\n                ph_name: frm.doc.ph_name,\r\n                buyer: frm.doc.buyer\r\n            },\r\n            fields: ['clreview_no', 'date', 'cl_review_date', 'current_limit', 'reasons']\r\n        },\r\n        callback: function(response) {\r\n            if (response.message) {\r\n                console.log('Fetched records:', response.message); // Log fetched records for debugging\r\n\r\n                // Clear existing child table rows\r\n                frm.clear_table('review_history');\r\n\r\n                // Iterate through fetched records and add to child table\r\n                response.message.forEach(function(row) {\r\n                    let new_row = frm.add_child('review_history');\r\n                    new_row.cl_review_no = row.clreview_no;\r\n                    new_row.review_date = row.date;\r\n                    new_row.expiry_date = row.cl_review_date;\r\n                    new_row.credit_limit = row.current_limit;\r\n                    new_row.reason = row.reasons;\r\n                });\r\n\r\n                // Refresh the child table field\r\n                frm.refresh_field('review_history');\r\n            } else {\r\n                console.log('No records found or error fetching data.'); // Log error message if no records found\r\n            }\r\n        },\r\n        error: function(err) {\r\n            console.log('Error fetching data:', err.responseText); // Log error response if fetch fails\r\n        }\r\n    });\r\n}\r\n\r\n\r\n\r\n\r\n\r\nfunction alignFields(frm) {\r\n    const rightAlignedFields = [\r\n        'total_exposure',\r\n        'outstanding_amount',\r\n        'overdue_amount',\r\n        'no_of_employees',\r\n        'current_limit',\r\n        'required_limit',\r\n        'approved_limit',\r\n        'recomended_exposure'\r\n    ];\r\n    const centerAlignedFields = [\r\n        'terms_of_payments'\r\n    ];\r\n    \r\n    rightAlignedFields.forEach(field => {\r\n        frm.fields_dict[field].$input.css(\"text-align\", \"right\");\r\n    });\r\n\r\n    centerAlignedFields.forEach(field => {\r\n        frm.fields_dict[field].$input.css(\"text-align\", \"center\");\r\n    });\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "DCI Proposals",
  "enabled": 1,
  "modified": "2025-12-12 06:59:24.401161",
  "module": "Marketing",
  "name": "DCI Proposals",
  "script": "frappe.ui.form.on('DCI Proposals', {\r\n//   validate: function(frm) {\r\n//         var fieldsToValidate = ['proposal_application', 'financial_statements__age_analysis', 'current_debtor_schedule'];\r\n//         var allowedExtensions = ['xlsx', 'xls', 'pdf'];\r\n\r\n//         fieldsToValidate.forEach(function(fieldname) {\r\n//             var file = frm.doc[fieldname];\r\n//             if (file) {\r\n//                 var fileExtension = file.split('.').pop();\r\n//                 if (!allowedExtensions.includes(fileExtension.toLowerCase())) {\r\n//                     frappe.msgprint(__(\"Please upload a file with extension .xlsx, .xls, or .pdf\"));\r\n//                     frm.set_value(fieldname, '');\r\n//                 }\r\n//             }\r\n//         });\r\n//     },\r\n\r\n  validate(frm) {\r\n\r\n        // ---------- FILE VALIDATION ----------\r\n        var fieldsToValidate = ['proposal_application', 'financial_statements__age_analysis', 'current_debtor_schedule'];\r\n        var allowedExtensions = ['xlsx', 'xls', 'pdf'];\r\n\r\n        fieldsToValidate.forEach(function(fieldname) {\r\n            var file = frm.doc[fieldname];\r\n            if (file) {\r\n                var fileExtension = file.split('.').pop().toLowerCase();\r\n                if (!allowedExtensions.includes(fileExtension)) {\r\n                    frappe.msgprint(__(\"Please upload a valid file (.xlsx, .xls, .pdf)\"));\r\n                    frm.set_value(fieldname, '');\r\n                }\r\n            }\r\n        });\r\n\r\n        // ---------- BUYER VALIDATION ----------\r\n        let child_rows = frm.doc.debtorsheduletable || [];\r\n\r\n        if (child_rows.length === 0) return;\r\n\r\n        let missing_buyers = [];\r\n        let checked = 0;\r\n\r\n        child_rows.forEach(row => {\r\n            if (!row.buyer) {\r\n                checked++;\r\n                return;\r\n            }\r\n\r\n            let normalized = String(row.buyer).replace(/\\s+/g, \" \").trim();\r\n\r\n            frappe.db.get_list('Buyer', {\r\n                filters: { buyer_name: normalized },\r\n                fields: ['name'],\r\n                limit: 1\r\n            }).then(res => {\r\n                if (!res || res.length === 0) {\r\n                    missing_buyers.push(normalized);\r\n                }\r\n            }).finally(() => {\r\n                checked++;\r\n\r\n                // When all rows are finished\r\n                if (checked === child_rows.length) {\r\n                    if (missing_buyers.length > 0) {\r\n                        frappe.msgprint({\r\n                            title: \"Missing Buyers\",\r\n                            message:\r\n                                \"These buyer(s) are NOT present in Buyer Master:<br><br><b>\" +\r\n                                missing_buyers.join(\"<br>\") +\r\n                                \"</b>\",\r\n                            indicator: \"red\"\r\n                        });\r\n                        frappe.validated = false;   // <-- STOP SAVE\r\n                    }\r\n                }\r\n            });\r\n        });\r\n    },\r\n\r\n\r\n    upload(frm) {\r\n        console.log(\"file is uploaded\");\r\n    var file = frm.doc.upload;\r\n  \r\n    // Check if a file is uploaded\r\n    if (file) {\r\n        console.log(\"it is a file\");\r\n       \r\n        // Get the file extension\r\n        var fileExtension = file.split('.').pop().toLowerCase();\r\n\r\n        // Allowed file extensions (Excel and PDF)\r\n        var allowedExtensions = ['xlsx', 'xls'];\r\n\r\n\r\n        // Check if the file extension is allowed\r\n        if (!allowedExtensions.includes(fileExtension)) {\r\n            \r\n              console.log(\"exept excel file it is not uploaded any different files\");\r\n            // Show an error message\r\n            frappe.msgprint(__(\"Only Excel (.xlsx, .xls) files are allowed\"));\r\n            // Clear the file field\r\n            frm.set_value('upload');\r\n             console.log(\"upload\", upload)\r\n            // clearTableAndTotal(frm);\r\n            // return;\r\n        }\r\n\r\n        // If the uploaded file is an Excel file, make the API call\r\n        frm.call({\r\n            doc: frm.doc,\r\n            method: 'extractData',\r\n            callback: function(response) {\r\n                 console.log(response, \"response\");\r\n                console.log(response.message, \"res\");\r\n\r\n                if (!response.exc) {\r\n                    console.log(response.message, \"hi\");\r\n\r\n                    var data = response.message;\r\n\r\n                    // Clear the form before loading data into the child table\r\n                  //  frappe.model.clear_doc(frm.doc);\r\n                    frm.clear_table('debtorsheduletable');\r\n\r\n                    var grandTotal = 0; // Initialize grand total to 0\r\n\r\n                    for (let x of data) {\r\n                        var child = frappe.model.add_child(frm.doc, \"Debtor Schedule Child\", \"debtorsheduletable\");\r\n\r\n\r\n                        console.log('Adding child:', child);\r\n\r\n\r\n                        frappe.model.set_value(child.doctype, child.name, \"buyer\", x.Buyer);\r\n                        frappe.model.set_value(child.doctype, child.name, \"current\", x.Current);\r\n                        frappe.model.set_value(child.doctype, child.name, \"tdays\", x['30Days']);\r\n                        frappe.model.set_value(child.doctype, child.name, \"sdays\", x['60Days']);\r\n                        frappe.model.set_value(child.doctype, child.name, \"ndays\", x['90Days']);\r\n                        frappe.model.set_value(child.doctype, child.name, \"odays\", x['120Days']);\r\n\r\n                        // Calculate total for each row\r\n                        var total = x.Current + x['30Days'] + x['60Days'] + x['90Days'] + x['120Days'];\r\n                        frappe.model.set_value(child.doctype, child.name, \"total\", total);\r\n\r\n                        // Add total to grand total\r\n                        grandTotal += total;\r\n                    }\r\n\r\n                    frm.refresh_fields('debtorsheduletable');\r\n\r\n                    // Set grand total in the 'grand_total' field of the parent form\r\n                  //  frm.set_value('grand_total', grandTotal);\r\n\r\n                    console.log(data);\r\n                } else {\r\n                    console.error(response.exc);\r\n                }\r\n            }\r\n        });\r\n    } else {\r\n        // If no file is uploaded, clear the table and grand_total field\r\n        clearTableAndTotal(frm);\r\n        return;\r\n    }\r\n},\r\n\r\n // Replace 'YourDocType' with the name of your doctype\r\n    for_the_period_of: function(frm) {\r\n        // This function is triggered when the value of 'for_the_period_of' field changes\r\n\r\n        // Get the value of the month field\r\n        var monthValue = frm.doc.for_the_period_of;\r\n\r\n        // Check if the month value is within the range of 1 to 12\r\n        if (monthValue && (monthValue < 1 || monthValue > 99)) {\r\n            // Show an error message\r\n            frappe.msgprint(__(\"Month must be a number between 1 and 99\"));\r\n            // Clear the value of the month field\r\n            frm.set_value('for_the_period_of', '');\r\n        }\r\n    },\r\n    \r\n  \r\n    \r\n    debtor_schedule:function(frm){\r\n      // Hide the \"Add Row\" button from the debtorsheduletable\r\n         frm.set_df_property('debtorsheduletable', 'cannot_add_rows', true);\r\n                   \r\n\r\n    },\r\n    \r\n    alternate_information: function(frm) {\r\n        // Hide the \"Add Row\" button from the alternate_information_table\r\n         frm.set_df_property('alternate_information_table', 'cannot_add_rows', true);\r\n    },\r\n    \r\n    \r\n   \r\nrefresh(frm) {\r\n  \r\n     alignFieldsRight(frm, fieldsToAlignRight);\r\n     frm.set_df_property('debtorsheduletable', 'cannot_add_rows', true);\r\n     \r\n      function adjustButtonVerticalPosition() {\r\n            setTimeout(function() {\r\n                var buttonWrapper = frm.fields_dict['calculate'].$wrapper;\r\n\r\n                if (buttonWrapper.length) {\r\n                    // Apply styles to center the button vertically\r\n                    buttonWrapper.css({\r\n                        'display': 'flex',\r\n                        'flex-direction': 'column',\r\n                        'justify-content': 'center',\r\n                        'height': '100%', // Adjust height to fill container\r\n                        'margin-top': '20px', // Optional: Adjust spacing\r\n                        'margin-bottom': '20px' // Optional: Adjust spacing\r\n                    });\r\n                    \r\n                    buttonWrapper.find('button').css({\r\n                        'margin-top': '10px', // Adjust spacing if needed\r\n                        'margin-bottom': '10px' // Adjust spacing if needed\r\n                    });\r\n                } else {\r\n                    console.error('Button wrapper not found');\r\n                }\r\n            }, 100); // Adjust delay if needed\r\n        }\r\n        \r\n        // Call the function to adjust the button position\r\n        adjustButtonVerticalPosition();\r\n    \r\n// frm.fields_dict.for_the_period_of.$input.css(\"text-align\", \"right\");\r\n// frm.fields_dict.estimated_loss.$input.css(\"text-align\", \"right\");\r\n// frm.fields_dict.on_a_turnover.$input.css(\"text-align\", \"right\");\r\n// frm.fields_dict.actual_loss.$input.css(\"text-align\", \"right\");\r\n// frm.fields_dict.currentyear_turnover.$input.css(\"text-align\", \"right\");\r\n// frm.fields_dict.govtsales.$input.css(\"text-align\", \"right\");\r\n// frm.fields_dict.nextyear_turnover.$input.css(\"text-align\", \"right\");\r\n// frm.fields_dict.govtsales2.$input.css(\"text-align\", \"right\");\r\n// frm.fields_dict.normal.$input.css(\"text-align\", \"right\");\r\n// frm.fields_dict.maximum.$input.css(\"text-align\", \"right\");\r\n// frm.fields_dict.total_debtors.$input.css(\"text-align\", \"right\");\r\n// frm.fields_dict.account_on_which_amount_exceeds.$input.css(\"text-align\", \"right\");\r\n// frm.fields_dict.estimated_of_the_total_monthly_book_debits.$input.css(\"text-align\", \"right\");\r\n\r\n\r\n\r\n    //Only get Active Records\r\n    frm.fields_dict['client_name'].get_query = function(doc) {\r\n            return {\r\n                filters: {\r\n                    \"status\": \"Active\"\r\n                }\r\n            };\r\n        };\r\n \r\n      frm.set_df_property('directors_shareholders_table', 'cannot_add_rows', true);\r\n      frm.set_df_property('buyer_experience_child_table', 'cannot_add_rows', true);\r\n      frm.set_df_property('debt_history_child_table', 'cannot_add_rows', true);\r\n      frm.set_df_property('principal_buyer_child_table', 'cannot_add_rows', true);\r\n    \r\n        // Replace 'your_child_table_fieldname' with the name of your child table field\r\n          // frm.fields_dict.calculate_grand_total.$input.addClass('btn-primary');\r\n    frm.fields_dict.directors_shareholder_add_new.$input.addClass('btn-primary');\r\n    frm.fields_dict.buyer_experience_add_new.$input.addClass('btn-primary');\r\n    \r\n    frm.fields_dict.debt_history_add_new.$input.addClass('btn-primary');\r\n    \r\n    frm.fields_dict.calculate.$input.addClass('btn-primary');\r\n        \r\n          // frm.fields_dict.debtor_schedule_add_new.$input.addClass('btn-primary');\r\n        \r\n\r\n  \r\n     frm.fields_dict.principal_buyer_add_new.$input.addClass('btn-primary');\r\n     \r\n     frm.fields_dict.calculate_grand_total.$input.addClass('btn-primary');\r\n     \r\n     \r\n      \r\n    //  frm.fields_dict.debtor_schedule_add_new.$input.toggle(frm.fields_dict.alternate_information.get_value());\r\n\r\n    //     frm.fields_dict.alternate_information.$input.on('change', function() {\r\n    //         frm.fields_dict.debtor_schedule_add_new.$input.toggle(frm.fields_dict.alternate_information.get_value());\r\n    //     });\r\n    \r\n    \r\n    \r\n    \r\n    \r\n  let workflow = frm.doc.workflow_state;\r\n\r\n        // ----------------------------------------------------------------------\r\n        // 1\ufe0f\u20e3 PRINT PROPOSAL BUTTON (ONLY IF Submitted)\r\n        // ----------------------------------------------------------------------\r\n        if (workflow === \"Submitted\") {\r\n\r\n            frm.add_custom_button(__('Print Proposal'), async function () {\r\n\r\n                // --------- CHECK IF ALREADY EXISTS ---------\r\n                let existing = await frappe.call({\r\n                    method: \"frappe.client.get_list\",\r\n                    args: {\r\n                        doctype: \"Print Proposal DCI\",\r\n                        filters: { data5: frm.doc.proposal_no },\r\n                        fields: [\"name\"]\r\n                    }\r\n                });\r\n\r\n                if (existing.message && existing.message.length > 0) {\r\n                    // \ud83d\udc49 OPEN EXISTING DOCUMENT\r\n                    frappe.set_route(\"Form\", \"Print Proposal DCI\", existing.message[0].name);\r\n                    return;\r\n                }\r\n\r\n                // \ud83d\udc49 CREATE NEW DOCUMENT\r\n                frappe.route_options = {\r\n                    data1: frm.doc.client_name,\r\n                    data5: frm.doc.proposal_no,\r\n                    data3: frm.doc.signed_on,\r\n                    data4: frm.doc.establishmentdate\r\n                };\r\n\r\n                frappe.new_doc(\"Print Proposal DCI\");\r\n            }).addClass(\"btn-primary\");\r\n        }\r\n\r\n\r\n        // ----------------------------------------------------------------------\r\n        // 2\ufe0f\u20e3 REJECTION LETTER (ONLY IF Declined)\r\n        // ----------------------------------------------------------------------\r\n        if (workflow === \"Declined\") {\r\n\r\n            frm.add_custom_button(__('Rejection Letter'), async function () {\r\n\r\n                let existing = await frappe.call({\r\n                    method: \"frappe.client.get_list\",\r\n                    args: {\r\n                        doctype: \"Rejection Letter\",\r\n                        filters: { proposal_no: frm.doc.proposal_no },\r\n                        fields: [\"name\"]\r\n                    }\r\n                });\r\n\r\n                if (existing.message && existing.message.length > 0) {\r\n                    // \ud83d\udc49 OPEN SAVED RECORD\r\n                    frappe.set_route(\"Form\", \"Rejection Letter\", existing.message[0].name);\r\n                    return;\r\n                }\r\n\r\n                // \ud83d\udc49 CREATE NEW DOCUMENT\r\n                frappe.route_options = {\r\n                    to: frm.doc.signed_by,\r\n                    client: frm.doc.client_name,\r\n                    proposal_no: frm.doc.proposal_no,\r\n                    regisration_no: frm.doc.registrationno,\r\n                    date: frm.doc.establishmentdate,\r\n                    information: frm.doc.remarks\r\n                };\r\n\r\n                frappe.new_doc('Rejection Letter');\r\n            }).addClass(\"btn-primary\");\r\n        }\r\n\r\n    \r\n\r\n},\r\n    \r\n \r\n    \r\n    //  onload_post_render(frm) {\r\n    //     // Add class to the debtor_schedule_add_new button\r\n    //     frm.fields_dict.debtor_schedule_add_new.$input.addClass('btn-primary');\r\n    // },\r\n\r\n   \r\n    \r\n//   onload_post_render: function(frm) {\r\n//         // Check if debtor_schedule_add_new is defined and $input exists before adding class\r\n//         if (frm.fields_dict.debtor_schedule_add_new && frm.fields_dict.debtor_schedule_add_new.$input) {\r\n//             frm.fields_dict.debtor_schedule_add_new.$input.addClass('btn-primary');\r\n//         }\r\n//      },\r\n\r\n\r\n onload: function(frm) {\r\n         \r\n         alignFieldsRight(frm, fieldsToAlignRight);\r\n      \r\n        if (!frm.doc.proposal_no) {\r\n            generateNumber(frm);\r\n        }\r\n        \r\n        \r\n\r\n        \r\n        \r\n\r\n        // Function to calculate total number of debtors\r\n        function calculateTotalDebtors() {\r\n            var total_debtors = 0;\r\n            var child_table = frm.doc.alternate_information_table || [];\r\n\r\n            // Loop through child table rows and sum up number_of_debtors\r\n            child_table.forEach(function(row) {\r\n                total_debtors += row.number_of_debtors ? parseFloat(row.number_of_debtors) : 0;\r\n            });\r\n\r\n            frm.doc.total_debtors = total_debtors;\r\n            frm.refresh_field('total_debtors');\r\n        }\r\n\r\n        // Call the function initially\r\n        calculateTotalDebtors();\r\n\r\n        // Refresh total number of debtors when a row is added or removed in the child table\r\n        frm.fields_dict['alternate_information_table'].grid.on_grid_refresh = calculateTotalDebtors;\r\n        \r\n\r\n    },\r\n    \r\n     client_name: function(frm) {\r\n        if (frm.doc.client_name) {\r\n            //  Check if this client_name already exists in DCI Proposals\r\n            frappe.db.get_value('DCI Proposals', { client_name: frm.doc.client_name }, ['establishmentdate', 'registrationno'])\r\n                .then(r => {\r\n                    if (r && r.message && (r.message.establishmentdate || r.message.registrationno)) {\r\n                        frappe.msgprint(__('Client \"{0}\" already exists.', [frm.doc.client_name]));\r\n                        frm.set_value('establishmentdate', r.message.establishmentdate);\r\n                        frm.set_value('registrationno', r.message.registrationno);\r\n                    } else {\r\n                        frm.set_value('establishmentdate', '');\r\n                        frm.set_value('registrationno', '');\r\n                    }\r\n                })\r\n                .then(() => {\r\n                    //Fetch additional fields from Company-Details\r\n                    frappe.db.get_value('Company-Details', frm.doc.client_name, ['status', 'trading_name'])\r\n                        .then(r2 => {\r\n                            if (r2 && r2.message) {\r\n                                frm.set_value('status', r2.message.status || '');\r\n                                frm.set_value('trading_name', r2.message.trading_name || '');\r\n                            } else {\r\n                                frm.set_value('status', '');\r\n                                frm.set_value('trading_name', '');\r\n                            }\r\n                        });\r\n                });\r\n        } else {\r\n            // Reset all fields if client_name is cleared\r\n            frm.set_value('establishmentdate', '');\r\n            frm.set_value('registrationno', '');\r\n            frm.set_value('status', '');\r\n            frm.set_value('trading_name', '');\r\n        }\r\n    },\r\n    \r\n\r\n  \r\n  \r\n  \r\n\r\n// Directors and shareholders \r\n directors_shareholder_add_new: function(frm) {\r\n     const style = document.createElement('style');\r\n    style.innerHTML = `\r\n        .frappe-control[data-fieldname=\"contact_no\"] .form-control {\r\n            padding-top: 1px; /* Adjust the padding to shift the text */\r\n            box-sizing: border-box; /* Ensure padding does not affect the field's overall size */\r\n        }\r\n    `;\r\n    document.head.appendChild(style);\r\n      frappe.prompt([\r\n        {'fieldname': 'id_type', 'fieldtype': 'Select', 'options': 'DRIVING LICENSE\\nREAD ID NUMBER\\nPASSPORT', 'label': 'ID Type', 'reqd': 1},\r\n        {'fieldname': 'id_number', 'fieldtype': 'Data', 'label': 'ID No', 'reqd': 1},\r\n        {'fieldname': 'surname', 'fieldtype': 'Data', 'label': 'Surname','reqd': 1},\r\n        {'fieldname': 'first_name', 'fieldtype': 'Data', 'label': 'First Name', 'reqd': 1},\r\n        {'fieldname': 'middle_name', 'fieldtype': 'Data', 'label': 'Middle Name'},\r\n        {'fieldname': '', 'fieldtype': 'Column Break', 'label': ''},\r\n        {'fieldname': 'e_mail_address', 'fieldtype': 'Data', 'label': 'Email Address', 'reqd': 1},\r\n        {'fieldname': 'fax', 'fieldtype': 'Data', 'label': 'Fax'},\r\n        {'fieldname': 'contact_no', 'fieldtype': 'Phone', 'label': 'Contact No', 'reqd': 1},\r\n        {'fieldname': 'designation', 'fieldtype': 'Select', 'options': 'DIRECTOR\\nMEMBER\\nMANAGER\\nOTHERS\\nPARTNERS\\nPROPRIETOR', 'label': 'Designation', 'reqd': 1}\r\n\r\n\r\n    ],\r\n    \r\n    function(values){\r\n        var director_name = `${values.first_name || ''} ${values.middle_name || ''} ${values.surname || ''}`.trim();\r\n\r\n        var data = {\r\n            id_type: values.id_type,\r\n            id_number: values.id_number,\r\n            director_name: director_name,\r\n            e_mail_address: values.e_mail_address,\r\n            fax: values.fax,\r\n            contact_no: values.contact_no,\r\n            designation: values.designation,\r\n        };\r\n\r\n        // Save the object to LocalStorage\r\n        localStorage.setItem('Directors_Shareholders_table', JSON.stringify(data));\r\n\r\n        // Retrieve the data from LocalStorage\r\n        var Directors_Shareholders_table = JSON.parse(localStorage.getItem('Directors_Shareholders_table'));\r\n\r\n        // Add the retrieved data to the child table\r\n        addDataToChildTable(frm, Directors_Shareholders_table);\r\n    }, \r\n    'Directors/ShareHolders');\r\n    },\r\n    \r\n//Buyer Experience    \r\nbuyer_experience_add_new: function(frm){\r\n    \r\n    // by venkatesh\r\n     // Generate dynamic years list (2000 to 2050)\r\n    let years = [];\r\n    for (let y = 2000; y <= 2050; y++) {\r\n        years.push(y.toString());\r\n    }\r\n    \r\n    \r\n        frappe.prompt([\r\n            // {'fieldname': 'financial_year', 'fieldtype': 'Select','options': '   \\n2000\\n2001\\n2002\\n2003\\n2004\\n2005\\n2006\\n2007\\n2008\\n2009\\n2010\\n2011\\n2012\\n2013\\n2014\\n2015\\n2016\\n2017\\n2018\\n2019\\n2020\\n2021\\n2022\\n2023\\n2024\\n2025\\n2026\\n2027\\n2028\\n2029\\n2030',  'label': 'Financial Year','reqd': 1},\r\n            \r\n            \r\n            \r\n               {\r\n                 fieldname: 'financial_year',\r\n                 fieldtype: 'Select',\r\n                 options: years.join(\"\\n\"),\r\n                 label: 'Financial Year',\r\n                 reqd: 1\r\n               },\r\n            {'fieldname': 'turnover', 'fieldtype': 'Currency', 'label': 'Turnover','reqd': 1,options: 'USD',default: 0,currency: 'USD'},\r\n            {'fieldname': 'relative_bad_debt_loss', 'fieldtype': 'Currency', 'label': 'Relative Bad Debt Loss', 'reqd': 1},\r\n            {'fieldname': 'largest_lost_client_name', 'fieldtype': 'Link', 'options': 'Company-Details', 'label': 'Largest Lost (Client Name)'},\r\n            {'fieldname': '', 'fieldtype': 'Column Break', 'label': ''},\r\n            {'fieldname': 'largest_loss', 'fieldtype': 'Currency', 'label': 'Largest Loss','reqd': 1},\r\n        ],\r\n        function(values){\r\n            // Construct an object with the field values\r\n            var data = {\r\n                financial_year: values.financial_year,\r\n                turnover: values.turnover,\r\n                relative_bad_debt_loss: values.relative_bad_debt_loss,\r\n                largest_loss: values.largest_loss,\r\n                largest_lost_client_name: values.largest_lost_client_name,\r\n            };\r\n\r\n            // Save the object to LocalStorage\r\n            localStorage.setItem('Buyer_experience_ch', JSON.stringify(data));\r\n\r\n            // Retrieve the data from LocalStorage\r\n            var Buyer_experience_ch = JSON.parse(localStorage.getItem('Buyer_experience_ch'));\r\n\r\n            // Add the retrieved data to the child table\r\n            BuyeraddDataToChildTable(frm, Buyer_experience_ch);\r\n        },\r\n        'Buyer Experience');\r\n       \r\n    },\r\n\r\n\r\n\r\n    \r\n//debt History\r\ndebt_history_add_new: function(frm){\r\n    frappe.prompt([\r\n        {\r\n            'fieldname': 'month',\r\n            'fieldtype': 'Select',\r\n            'options': '\\nJanuary\\nFebruary\\nMarch\\nApril\\nMay\\nJune\\nJuly\\nAugust\\nSeptember\\nOctober\\nNovember\\nDecember',\r\n            'label': 'Month',\r\n            'reqd': 1\r\n        },\r\n        {\r\n            'fieldname': 'last_year_debt',\r\n            'fieldtype': 'Currency',\r\n            'label': 'Last Year Debt',\r\n            'reqd': 1\r\n        },\r\n        {\r\n            'fieldname': 'this_year_debt',\r\n            'fieldtype': 'Currency',\r\n            'label': 'This Year Debt',\r\n            'reqd': 1\r\n        },\r\n    ],\r\n    function(values){\r\n        // Construct an object with the field values\r\n        var data = {\r\n            month: values.month,\r\n            last_year_debt: values.last_year_debt,\r\n            this_year_debt: values.this_year_debt,\r\n        };\r\n\r\n        // Save the object to LocalStorage\r\n        localStorage.setItem('Debt_History_Child', JSON.stringify(data));\r\n\r\n        // Retrieve the data from LocalStorage\r\n        var Debt_History_Child = JSON.parse(localStorage.getItem('Debt_History_Child'));\r\n\r\n        // Add the retrieved data to the child table\r\n        Debt_HistoryaddDataToChildTable(frm, Debt_History_Child);\r\n    },\r\n    'Debt History');\r\n  },\r\n  \r\n//debtor schedule(Alternate Information Add New)\r\ndebtor_schedule_add_new: function(frm){\r\n     frappe.prompt([\r\n            {'fieldname': 'debt_range_from', 'fieldtype': 'Data',  'label': 'Debt Range from','reqd': 1},\r\n            {'fieldname': 'debt_range_to', 'fieldtype': 'Data', 'label': 'Debt Range To','reqd': 1},\r\n            {'fieldname': 'number_of_debtors', 'fieldtype': 'Data', 'label': 'Number Of Debtors'},\r\n            \r\n        ],\r\n        function(values){\r\n            // Construct an object with the field values\r\n            var data = {\r\n                debt_range_from: values.debt_range_from,\r\n                debt_range_to: values.debt_range_to,\r\n                number_of_debtors: values.number_of_debtors,\r\n                \r\n            };\r\n\r\n            // Save the object to LocalStorage\r\n            localStorage.setItem('Alter_Child_table', JSON.stringify(data));\r\n            \r\n            // frm.set_value('total_debtors', values.number_of_debtors);\r\n\r\n            // Retrieve the data from LocalStorage\r\n            var Alter_Child_table = JSON.parse(localStorage.getItem('Alter_Child_table'));\r\n\r\n            // Add the retrieved data to the child table\r\n            debtor_schedule_addDataToChildTable(frm, Alter_Child_table);\r\n        },\r\n        'Debtor Schedule');\r\n},\r\n  \r\n\r\n\r\ncalculate: function(frm) {\r\n    if (frm.doc.all_buyers || frm.doc.account_on_which_amount_exceeds) {\r\n        if (frm.doc.all_buyers ||frm.doc.select_buyers || (frm.doc.account_on_which_amount_exceeds && frm.doc.amount)) {\r\n            calculateMonthlyDebitsPercentage(frm);\r\n        } else {\r\n           // frappe.msgprint(\"Please select the 'All buyers'.\"); \r\n        }\r\n    } else {\r\n       // frappe.msgprint(\"Please select 'All buyers' and enter the 'Amount'.\"); \r\n    }\r\n},\r\n\r\n\r\n\r\n\r\nprincipal_buyer_add_new: function(frm) {\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Buyer',\r\n            filters: {'dci': 1},\r\n            fields: ['name', 'buyer_name'],\r\n                limit_page_length: 0  \r\n        },\r\n        callback: function(response) {\r\n            var dci_buyers = response.message || [];\r\n\r\n            // Prepare options list for Select field\r\n            var options = dci_buyers.map(buyer => buyer.buyer_name);\r\n\r\n            frappe.prompt([\r\n                {\r\n                    fieldname: 'buyer_name',\r\n                    fieldtype: 'Select',\r\n                    label: 'Buyer Name',\r\n                    reqd: 1,\r\n                    options: options,\r\n                    onchange: function() {\r\n                        var buyer_name = this.get_value();\r\n                        if (buyer_name) {\r\n                            // Fetch physical address from selected buyer\r\n                            frappe.db.get_value('Buyer', {'buyer_name': buyer_name}, 'physical_address', function(r) {\r\n                                if (r && r.physical_address) {\r\n                                    cur_dialog.fields_dict.address.set_value(r.physical_address);\r\n                                } else {\r\n                                    cur_dialog.fields_dict.address.set_value('');\r\n                                }\r\n                            });\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    fieldname: 'add_buyer',\r\n                    fieldtype: 'Button',\r\n                    label: 'Add New Buyer',\r\n                    click: function() {\r\n                        frappe.new_doc('Buyer');\r\n                    }\r\n                },\r\n                {\r\n                    fieldname: 'address',\r\n                    fieldtype: 'Data',\r\n                    label: 'Address'\r\n                },\r\n                {\r\n                    fieldname: 'amount_outstanding',\r\n                    fieldtype: 'Data',\r\n                    label: 'Amount Outstanding',\r\n                    'reqd': 1\r\n                }\r\n            ],\r\n            function(values) {\r\n                var data = {\r\n                    buyer_name: values.buyer_name,\r\n                    address: values.address,\r\n                    amount_outstanding: values.amount_outstanding\r\n                };\r\n\r\n                // Save the object to LocalStorage\r\n                localStorage.setItem('Principal_Buyer_ch', JSON.stringify(data));\r\n\r\n                // Retrieve and add to child table\r\n                var Principal_Buyer_ch = JSON.parse(localStorage.getItem('Principal_Buyer_ch'));\r\n                Principal_Buyer_addDataToChildTable(frm, Principal_Buyer_ch);\r\n            },\r\n            'Principal Buyer');\r\n        }\r\n    })\r\n},\r\n\r\n\r\ncalculate_grand_total: function(frm) {\r\n        let total_sum = 0;\r\n        let any_checked = false;\r\n\r\n        if (frm.doc.debtorsheduletable && frm.doc.debtorsheduletable.length > 0) {\r\n\r\n            // \u2705 Check selected rows\r\n            frm.doc.debtorsheduletable.forEach(row => {\r\n                if (row.select_buyer === 1) {\r\n                    any_checked = true;\r\n                    total_sum += row.total || 0;\r\n                }\r\n            });\r\n\r\n            // \u2705 If none selected \u2192 use all rows\r\n            if (!any_checked) {\r\n                frm.doc.debtorsheduletable.forEach(row => {\r\n                    total_sum += row.total || 0;\r\n                });\r\n\r\n                // \u2705 Set ALL BUYERS TRUE, SELECTED FALSE\r\n                frm.set_value(\"all_buyers\", 1);\r\n                frm.set_value(\"select_buyers\", 0);\r\n            } \r\n            else {\r\n                // \u2705 Set SELECTED TRUE, ALL BUYERS FALSE\r\n                frm.set_value(\"select_buyers\", 1);\r\n                frm.set_value(\"all_buyers\", 0);\r\n            }\r\n\r\n            // \u2705 Update Grand Total\r\n            frm.set_value(\"grand_total\", total_sum);\r\n\r\n            frm.refresh_field(\"grand_total\");\r\n            frm.refresh_field(\"all_buyers\");\r\n            frm.refresh_field(\"select_buyers\");\r\n\r\n            frappe.msgprint(\"Grand Total calculated successfully.\");\r\n        } \r\n        else {\r\n            frappe.msgprint(\"No buyers found in the debtor schedule table.\");\r\n        }\r\n    }\r\n\r\n\r\n\r\n\r\n});\r\n\r\n\r\n\r\n\r\n// Function to calculate monthly debits percentage\r\nfunction calculateMonthlyDebitsPercentage(frm) {\r\n    var grandTotal = frm.doc.grand_total || 0;\r\n\r\n    // Check if the grand total is greater than zero\r\n    if (grandTotal > 0) {\r\n        // var allBuyersChecked = frm.doc.all_buyers || false;\r\n        var accountExceeds = frm.doc.account_on_which_amount_exceeds || 0;\r\n\r\n        // Calculate the estimated monthly debits percentage\r\n        var estimatedPercentage = accountExceeds/grandTotal * 100;\r\n\r\n        // Update the field with the calculated percentage\r\n        frm.set_value('estimated_of_the_total_monthly_book_debits', estimatedPercentage);\r\n \r\n\r\n       \r\n    } else {\r\n        // If grand total is zero, show the message\r\n        frappe.msgprint('There is no Buyers');\r\n    }\r\n}\r\n\r\nfunction addDataToChildTable(frm, data) {\r\n    var childTable = frm.fields_dict['directors_shareholders_table'].grid;\r\n    var newRow = childTable.add_new_row();\r\n\r\n    // Set values for each field in the row, ensuring that they match the child table field names and types\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'id_type', data.id_type);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'id_number', data.id_number);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'directorname', data.director_name);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'emailaddress', data.e_mail_address);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'fax', data.fax);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'contact_no', data.contact_no);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'designation', data.designation);\r\n\r\n    // Refresh the child table to reflect the changes\r\n    childTable.refresh();\r\n}\r\n\r\n\r\n\r\n\r\n\r\n//Buyer_Experience_addDataToChildTable in Buyer Experience table\r\n//Local storage data displaying in child table\r\n// Add data to Buyer Experience child table\r\nfunction BuyeraddDataToChildTable(frm, data) {\r\n    var childTable = frm.fields_dict['buyer_experience_child_table'].grid;\r\n    var newRow = childTable.add_new_row();\r\n\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'financial_year', data.financial_year);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'turnover', data.turnover);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'relative_bad_debt_loss', data.relative_bad_debt_loss);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'largest_loss', data.largest_loss);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'largest_lost_client_name', data.largest_lost_client_name);\r\n\r\n    childTable.refresh();\r\n    \r\n    calculatetotal_turnover(frm);\r\n    calculatetotal_baddebts(frm);\r\n    calculateTotalYear(frm)\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n//Debt_HistoryaddDataToChildTable in Debt History table\r\n//Local storage data displaying in child table\r\n// Add data to Dibt History child table\r\nfunction Debt_HistoryaddDataToChildTable(frm, data) {\r\n    var childTable = frm.fields_dict['debt_history_child_table'].grid;\r\n    var newRow = childTable.add_new_row();\r\n\r\n    // Set values for each field in the row\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'month', data.month);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'last_year_debt', data.last_year_debt);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'this_year_debt', data.this_year_debt);\r\n\r\n    // Refresh the child table to reflect the changes\r\n    childTable.refresh();\r\n}\r\n\r\n\r\n///debtor_schedule_addDataToChildTable in debtorschedule table\r\nfunction debtor_schedule_addDataToChildTable(frm, data) {\r\n    var childTable = frm.fields_dict['alternate_information_table'].grid;\r\n    var newRow = childTable.add_new_row();\r\n\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'debt_range_from', data.debt_range_from);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'debt_range_to', data.debt_range_to);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'number_of_debtors', data.number_of_debtors);\r\n\r\n    childTable.refresh();\r\n    \r\n    calculatetotal_debtors(frm)\r\n}\r\n\r\n// Function to clear table and grand_total field\r\nfunction clearTableAndTotal(frm) {\r\n    // Clear the table\r\n    frm.clear_table('debtorsheduletable');\r\n    // Clear the grand_total field\r\n    frm.set_value('grand_total', '');\r\n}\r\n\r\n//Principal_buyer_addDataToChildTable in debtorschedule table\r\nfunction Principal_Buyer_addDataToChildTable(frm, data) {\r\n    var childTable = frm.fields_dict['principal_buyer_child_table'].grid;\r\n    var newRow = childTable.add_new_row();\r\n\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'buyer_name', data.buyer_name);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'address', data.address);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'amount_outstanding', data.amount_outstanding);\r\n\r\n    childTable.refresh();\r\n}\r\n\r\n//Auto generation of Proposal No for all users\r\nfunction generateNumber(frm) {\r\n    // Check if the proposal number field is already populated\r\n    if (!frm.doc.proposal_no) {\r\n        // Get the current year\r\n        let currentYear = new Date().getFullYear();\r\n        let prefix = `DCI/${currentYear}/`;\r\n\r\n        // Make a call to get the last number asynchronously\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'DCI Proposals',\r\n                fields: ['proposal_no', 'creation'],\r\n                order_by: 'creation desc',\r\n                limit: 1\r\n            },\r\n            callback: function(r) {\r\n                console.log(r,\"proposal no\");\r\n                if (r.message && r.message.length > 0) {\r\n                    let lastProposalNo = r.message[0].proposal_no;\r\n                    let lastNumber = parseInt(lastProposalNo.split(\"/\").pop()); // Extract last part and parse it as integer\r\n                    if (!isNaN(lastNumber)) {\r\n                        // Increment the last number and pad it with leading zeros\r\n                        let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n                        frm.set_value('proposal_no', prefix + newNumber);\r\n                    }\r\n                } else {\r\n                    // If no previous numbers exist, set to default '0001'\r\n                    frm.set_value('proposal_no', prefix + '0001');\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\n\r\n\r\n\r\nfunction calculatetotal_debtors(frm){\r\n    var childTableData = frm.doc.alternate_information_table || [];\r\n\r\n    // Calculate Total Turnover\r\n    var totalDebtors = childTableData.reduce(function(number_of_debtors, row) {\r\n        // Convert row.turnover to a number using parseFloat or parseInt\r\n        var rowDebtors = parseFloat(row.number_of_debtors) || 0; // Convert to float; default to 0 if NaN\r\n\r\n        return number_of_debtors + rowDebtors;\r\n    }, 0);\r\n\r\n    // Update Total Turnover field in the form\r\n    frm.set_value('total_debtors', totalDebtors);\r\n}\r\n\r\n\r\n\r\n\r\nfunction calculatetotal_turnover(frm){\r\n    var childTableData = frm.doc.buyer_experience_child_table || [];\r\n\r\n    // Calculate Total Turnover\r\n    var totalTurnover = childTableData.reduce(function(turnover, row) {\r\n        // Convert row.turnover to a number using parseFloat or parseInt\r\n        var rowTurnover = parseFloat(row.turnover) || 0; // Convert to float; default to 0 if NaN\r\n\r\n        return turnover + rowTurnover;\r\n    }, 0);\r\n\r\n    // Update Total Turnover field in the form\r\n    frm.set_value('total_turnover', totalTurnover);\r\n}\r\n\r\n\r\nfunction calculatetotal_baddebts(frm){\r\n    var childTableData = frm.doc.buyer_experience_child_table || [];\r\n\r\n    // Calculate Total Turnover\r\n    var totalBadDebts = childTableData.reduce(function(relative_bad_debt_loss, row) {\r\n        // Convert row.turnover to a number using parseFloat or parseInt\r\n        var rowBadDebts = parseFloat(row.relative_bad_debt_loss) || 0; // Convert to float; default to 0 if NaN\r\n\r\n        return relative_bad_debt_loss + rowBadDebts;\r\n    }, 0);\r\n\r\n    // Update Total Turnover field in the form\r\n    frm.set_value('total_bad_debt', totalBadDebts);\r\n}\r\n\r\n\r\n\r\nfunction calculateTotalYear(frm) {\r\n    var childTableData = frm.doc.buyer_experience_child_table || [];\r\n\r\n    // Get the number of records (length of the array)\r\n    var yearCount = childTableData.length;\r\n\r\n    // Update 'year_count' field in the form with the count\r\n    frm.set_value('year_count', yearCount);\r\n}\r\n\r\n     \r\n    \r\n\r\n\r\n\r\n// List of field names to align right\r\nlet fieldsToAlignRight = ['for_the_period_of', 'estimated_loss', 'on_a_turnover','actual_loss','currentyear_turnover','govtsales','nextyear_turnover','govtsales2',\r\n'normal','maximum','total_debtors','account_on_which_amount_exceeds','estimated_of_the_total_monthly_book_debits'];\r\n\r\n// Function to apply the styles\r\nfunction alignFieldsRight(frm, fields) {\r\n    fields.forEach(field => {\r\n        let fieldElement = frm.fields_dict[field];\r\n        if (fieldElement && fieldElement.input) {\r\n            fieldElement.input.style.direction = 'rtl';\r\n            fieldElement.input.style.textAlign = 'right';\r\n        }\r\n    });\r\n};\r\n\r\nfrappe.ui.form.on('Print Proposal DCI', {\r\n    onload(frm) {\r\n\r\n        // Make child table read-only\r\n        frm.set_df_property('proposal_child', 'cannot_add_rows', true);\r\n        frm.set_df_property('print_proposal_child', 'cannot_add_rows', true);\r\n\r\n        // ------------------------------------------------------------------\r\n        // GET postal address from Company-Details\r\n        // ------------------------------------------------------------------\r\n        frappe.call({\r\n            method: 'frappe.client.get_value',\r\n            args: {\r\n                doctype: 'Company-Details',\r\n                filters: { name1: frm.doc.data1 },\r\n                fieldname: ['postal_address']\r\n            },\r\n            callback: function (r) {\r\n                if (!r.exc && r.message) {\r\n                    frm.set_value('data2', r.message.postal_address || '');\r\n                    frm.refresh_field('data2');\r\n                }\r\n            }\r\n        });\r\n\r\n        // ------------------------------------------------------------------\r\n        // GET Buyer Experience child table\r\n        // ------------------------------------------------------------------\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: {\r\n                doctype: \"DCI Proposals\",\r\n                filters: { client_name: frm.doc.data1 }\r\n            },\r\n            callback: function (r) {\r\n\r\n                if (!r.exc && r.message && r.message.buyer_experience_child_table) {\r\n\r\n                    const data = r.message.buyer_experience_child_table;\r\n\r\n                    frm.clear_table('print_proposal_child');\r\n\r\n                    let total_turnover = 0;\r\n                    let total_bad_debts = 0;\r\n\r\n                    data.forEach(x => {\r\n                        let child = frappe.model.add_child(frm.doc, \"Print Child\", \"print_proposal_child\");\r\n\r\n                        frappe.model.set_value(child.doctype, child.name, \"financial_year_ending\", x.financial_year);\r\n                        frappe.model.set_value(child.doctype, child.name, \"turnover\", x.turnover);\r\n                        frappe.model.set_value(child.doctype, child.name, \"bad_debt_losses_total\", x.relative_bad_debt_loss);\r\n                        frappe.model.set_value(child.doctype, child.name, \"largest_individual_loss\", x.largest_loss);\r\n                        frappe.model.set_value(child.doctype, child.name, \"name_of_largest_individual_loss\", x.largest_lost_client_name);\r\n\r\n                        total_turnover += Number(x.turnover) || 0;\r\n                        total_bad_debts += Number(x.relative_bad_debt_loss) || 0;\r\n                    });\r\n\r\n                    frm.refresh_field('print_proposal_child');\r\n\r\n                    frm.set_value(\"total_turnover\", total_turnover);\r\n                    frm.set_value(\"total_bad_debts\", total_bad_debts);\r\n                }\r\n            }\r\n        });\r\n\r\n        // ------------------------------------------------------------------\r\n        // GET Debt History child table\r\n        // ------------------------------------------------------------------\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: {\r\n                doctype: \"DCI Proposals\",\r\n                filters: { client_name: frm.doc.data1 }\r\n            },\r\n            callback: function (r) {\r\n\r\n                if (!r.exc && r.message && r.message.debt_history_child_table) {\r\n\r\n                    const data = r.message.debt_history_child_table;\r\n\r\n                    frm.clear_table('proposal_child');\r\n\r\n                    data.forEach(x => {\r\n                        let child = frappe.model.add_child(frm.doc, \"Proposal Child\", \"proposal_child\");\r\n\r\n                        frappe.model.set_value(child.doctype, child.name, \"month_of\", x.month);\r\n                        frappe.model.set_value(child.doctype, child.name, \"last_financial_year_in_000s_usd\", x.last_year_debt);\r\n                        frappe.model.set_value(child.doctype, child.name, \"this_financial_year_in_000s_usd\", x.this_year_debt);\r\n                    });\r\n\r\n                    frm.refresh_field('proposal_child');\r\n\r\n                    let total_estimated = 0;\r\n\r\n                    frm.doc.proposal_child.forEach(row => {\r\n                        total_estimated += Number(row.this_financial_year_in_000s_usd) || 0;\r\n                    });\r\n\r\n                    frm.set_value(\"estimatted_amount\", total_estimated);\r\n                }\r\n            }\r\n        });\r\n        \r\n        \r\n frappe.call({\r\n    method: \"frappe.client.get\",\r\n    args: {\r\n        doctype: \"DCI Proposals\",\r\n        filters: { client_name: frm.doc.data1 }\r\n    },\r\n    callback: function (r) {\r\n        console.log(\"DCI Proposals Response:\", r);\r\n\r\n        if (!r.exc && r.message && r.message.principal_buyer_child_table && r.message.principal_buyer_child_table.length > 0) {\r\n\r\n            const data = r.message.principal_buyer_child_table;\r\n            const proposalNo = r.message.proposal_no || \"\";\r\n\r\n            // Clear existing table\r\n            frm.clear_table('proposals_child');\r\n\r\n            // Loop principal buyer table\r\n            data.forEach(row => {\r\n\r\n                // Add new child row\r\n                const child = frappe.model.add_child(frm.doc, \"Proposals Child\", \"proposals_child\");\r\n\r\n                frappe.model.set_value(child.doctype, child.name, \"name_of_buyers\", row.buyer_name);\r\n                frappe.model.set_value(child.doctype, child.name, \"adress\", row.address);\r\n                frappe.model.set_value(child.doctype, child.name, \"maximum\", row.amount_outstanding);\r\n\r\n                // Proposal number\r\n                frappe.model.set_value(child.doctype, child.name, \"buyer_ref_no\", proposalNo);\r\n\r\n                // \ud83d\udd25 Fetch bank + branch + ac_no for THIS buyer\r\n                frappe.call({\r\n                    method: \"frappe.client.get_list\",\r\n                    args: {\r\n                        doctype: \"Buyer\",\r\n                        filters: {\r\n                            buyer_name: row.buyer_name      // match exact buyer in child table\r\n                        },\r\n                        fields: [\"bank\", \"branch\"]\r\n                    },\r\n                    callback: function (res) {\r\n                        if (!res.exc && res.message && res.message.length > 0) {\r\n\r\n                            let buyer = res.message[0];\r\n\r\n                            let bank   = buyer.bank   || \"\";\r\n                            let branch = buyer.branch || \"\";\r\n                          \r\n\r\n                            // Final display format\r\n                            let combined = `${bank}/${branch}`;\r\n\r\n                            frappe.model.set_value(\r\n                                child.doctype,\r\n                                child.name,\r\n                                \"bankers\",\r\n                                combined\r\n                            );\r\n\r\n                            frm.refresh_field('proposals_child');\r\n                        }\r\n                    }\r\n                });\r\n\r\n            });\r\n\r\n            frm.refresh_field('proposals_child');\r\n        } \r\n        else {\r\n            console.warn(\"No data found in DCI Proposals\");\r\n        }\r\n    }\r\n});\r\nfrappe.call({\r\n    method: \"frappe.client.get_value\",\r\n    args: {\r\n          doctype: \"DCI Proposals\",\r\n        filters: { client_name: frm.doc.data1 },\r\n        fieldname: [\"for_the_period_of\",\"on_a_turnover\",\"currentyear_turnover\",\"grand_total\",\"normal\",\"maximum\",\"account_on_which_amount_exceeds\",\"estimated_of_the_total_monthly_book_debits\"]\r\n    },\r\n    callback: function(r) {\r\n        console.log(\"Currency Response:\", r);\r\n\r\n        if (r.message) {\r\n            frm.set_value(\"dbox\", r.message.for_the_period_of);\r\n              frm.set_value(\"dbox2\", r.message.on_a_turnover);\r\n               frm.set_value(\"dbox3\", r.message.on_a_turnover);\r\n                frm.set_value(\"dbox4\", r.message.currentyear_turnover);\r\n                  frm.set_value(\"dbox5\", r.message.grand_total);\r\n                    frm.set_value(\"dbox7\", r.message.normal);\r\n                      frm.set_value(\"dbox6\", r.message.maximum);\r\n                        frm.set_value(\"dbox10\", r.message.account_on_which_amount_exceeds); \r\n                        frm.set_value(\"dbox11\", r.message.estimated_of_the_total_monthly_book_debits);\r\n                          \r\n            \r\n            console.log(\"Currency Set:\", r.message.currency);\r\n        } else {\r\n            console.log(\"No currency found\");\r\n            \r\n                frm.set_value(\"dbox\", \"\");\r\n                  frm.set_value(\"dbox1\", \"\");  \r\n                  frm.set_value(\"dbox2\", \"\");\r\n                    frm.set_value(\"dbox3\", \"\");\r\n                      frm.set_value(\"dbox4\", \"\");\r\n                        frm.set_value(\"dbox5\", \"\");\r\n                          frm.set_value(\"dbox6\", \"\"); \r\n                          frm.set_value(\"dbox7\", \"\");\r\n                            //frm.set_value(\"dbox8\", \"\");\r\n                              frm.set_value(\"dbox10\", \"\");\r\n                                frm.set_value(\"dbox11\", \"\");\r\n        }\r\n    }\r\n});\r\n\r\n\r\n\r\n\r\n    }\r\n});\r\nfrappe.ui.form.on('Rejection Letter', {\r\n    refresh(frm) {\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get',\r\n            args: {\r\n                doctype: 'Company-Details',\r\n                filters: { name1: frm.doc.client },\r\n                fields: ['postal_address', 'location', 'physical_address']\r\n            },\r\n            callback: function (r) {\r\n                if (!r.exc && r.message) {\r\n                    let address = \"\";\r\n\r\n                    if (r.message.name1) address += r.message.name1 + \"\\n\";\r\n                    if (r.message.location) address += r.message.location + \"\\n\";\r\n                    if (r.message.physical_address) address += r.message.physical_address + \"\\n\";\r\n                    if (r.message.postal_address) address += r.message.postal_address + \"\\n\";\r\n\r\n                    frm.set_value('address', address.trim());\r\n                }\r\n            }\r\n        });\r\n\r\n    }\r\n});\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "_liked_by": "[\"sandhya.m@techbulls.co.in\"]",
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Policy Approval1",
  "enabled": 1,
  "modified": "2025-11-10 12:53:15.092967",
  "module": null,
  "name": "Policy Approvals script",
  "script": "frappe.ui.form.on('Policy Approvals', {\r\n    onload: function(frm) {\r\n        \r\n    \r\n       // frm.set_value('date1', frappe.datetime.get_today());\r\n        \r\n    if (!frm.doc.policy_number) {\r\n            generateNumber(frm, 'policy_number');\r\n        }\r\n       \r\n// if (!frm.doc.date) {\r\n//             frm.set_value('today', frappe.datetime.get_today());\r\n//         }\r\n    console.log(\"starting\");\r\n\r\n    frappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'DCI Quotation',\r\n        filters: {\r\n            'workflow_state': 'Approved'\r\n        },\r\n        fields: ['schedule_no'],\r\n        limit_page_length: 1000  // Adjust this value as needed\r\n    },\r\n    callback: function(dci_response) {\r\n        console.log(\"DCI schedule_no received:\", dci_response);\r\n\r\n        if (dci_response.message) {\r\n            let dciArray = dci_response.message.map(x => x.schedule_no);\r\n\r\n            // Fetch ECI Quotations after getting DCI Quotation \r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'ECI Quotations',\r\n                    filters: {\r\n                        'workflow_state': 'Approved'\r\n                    },\r\n                    fields: ['schedule_no'],\r\n                    limit_page_length: 1000  // Adjust this value as needed\r\n                },\r\n                callback: function(eci_response) {\r\n                    console.log(\"ECI schedule_no received:\", eci_response);\r\n\r\n                    if (eci_response.message) {\r\n                        let eciArray = eci_response.message.map(x => x.schedule_no);\r\n                        let finalArray = dciArray.concat(eciArray);  // Combine both arrays\r\n                        frm.set_df_property('quotation_numbers', 'options', finalArray);\r\n                        console.log(\"final\", finalArray);\r\n                    }\r\n                },\r\n                error: function(xhr, textStatus, errorThrown) {\r\n                    console.error(\"Error fetching ECI Quotations:\", textStatus, errorThrown);\r\n                }\r\n            });\r\n        }\r\n    },\r\n    error: function(xhr, textStatus, errorThrown) {\r\n        console.error(\"Error fetching DCI Quotation :\", textStatus, errorThrown);\r\n    }\r\n});\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n        doctype: 'Policy Approvals',\r\n        filters: {\r\n           //workflow_state: 'Approved',\r\n           workflow_state: 'Accpeted',\r\n           \r\n           \r\n            quotation_numbers: ['in', submittedDCIQuotations.concat(submittedECIQuotations)]\r\n          },\r\n        fields: ['quotation_numbers']\r\n        \r\n      \r\n       },\r\n       \r\n       callback: function(approvedPolicyApprovalsResponse) {\r\n        if (approvedPolicyApprovalsResponse.message) {\r\n            var approvedPolicyApprovals = approvedPolicyApprovalsResponse.message.map(function(policyApproval) {\r\n                return policyApproval.quotation_numbers;\r\n            });\r\n\r\n            console.log(\"** Approved Policy Approvals:\", approvedPolicyApprovals);\r\n\r\n            var filteredQuotations = submittedDCIQuotations.concat(submittedECIQuotations).filter(function(quotation) {\r\n                return !approvedPolicyApprovals.includes(quotation);\r\n            });\r\n\r\n            console.log(\"** Filtered Quotations:\", filteredQuotations);\r\n\r\n            frm.set_df_property('quotation_numbers', 'options', filteredQuotations);\r\n        }\r\n    }\r\n});\r\n\r\n    \r\n        \r\n        \r\n        \r\n        // frappe.call({\r\n        //     method: 'frappe.client.get_list',\r\n        //     args: {\r\n        //         doctype: 'DCI Quotation',\r\n        //         filters: {\r\n        //             workflow_state: 'Approved'\r\n        //         },\r\n        //         fields: ['schedule_no'],\r\n        //         limit_page_length: 100\r\n        //     },\r\n        //     callback: function(submittedDCIQuotationsResponse) {\r\n        //         if (submittedDCIQuotationsResponse.message) {\r\n        //             var submittedDCIQuotations = submittedDCIQuotationsResponse.message.map(function(quotation) {\r\n        //                 return quotation.schedule_no;\r\n        //             });\r\n\r\n        //             console.log(\"** Submitted DCI Quotation:\", submittedDCIQuotations);\r\n\r\n        //             console.log(\"** Fetching Submitted ECI Quotations **\");\r\n\r\n        //             frappe.call({\r\n        //                 method: 'frappe.client.get_list',\r\n        //                 args: {\r\n        //                     doctype: 'ECI Quotations',\r\n        //                     filters: {\r\n        //                         workflow_state: 'Approved'\r\n        //                     },\r\n        //                     fields: ['schedule_no'],\r\n        //                     limit_page_length: 100\r\n        //                 },\r\n        //                 callback: function(submittedECIQuotationsResponse) {\r\n        //                     if (submittedECIQuotationsResponse.message) {\r\n        //                         var submittedECIQuotations = submittedECIQuotationsResponse.message.map(function(quotation) {\r\n        //                             return quotation.schedule_no;\r\n        //                         });\r\n\r\n        //                         console.log(\"** Submitted ECI Quotations:\", submittedECIQuotations);\r\n\r\n        //                         console.log(\"** Fetching Approved Policy Approvals **\");\r\n\r\n        //                         frappe.call({\r\n        //                             method: 'frappe.client.get_list',\r\n        //                             args: {\r\n        //                                 doctype: 'Policy Approvals',\r\n        //                                 filters: {\r\n        //                                     workflow_state: 'Approved',\r\n        //                                     quotation_numbers: ['in', submittedDCIQuotations.concat(submittedECIQuotations)]\r\n        //                                 },\r\n        //                                 fields: ['quotation_numbers']\r\n        //                             },\r\n        //                             callback: function(approvedPolicyApprovalsResponse) {\r\n        //                                 if (approvedPolicyApprovalsResponse.message) {\r\n        //                                     var approvedPolicyApprovals = approvedPolicyApprovalsResponse.message.map(function(policyApproval) {\r\n        //                                         return policyApproval.quotation_numbers;\r\n        //                                     });\r\n\r\n        //                                     console.log(\"** Approved Policy Approvals:\", approvedPolicyApprovals);\r\n\r\n        //                                     var filteredQuotations = submittedDCIQuotations.concat(submittedECIQuotations).filter(function(quotation) {\r\n        //                                         return !approvedPolicyApprovals.includes(quotation);\r\n        //                                     });\r\n\r\n        //                                     console.log(\"** Filtered Quotations:\", filteredQuotations);\r\n\r\n        //                                     frm.set_df_property('quotation_numbers', 'options', filteredQuotations);\r\n        //                                 }\r\n        //                             }\r\n        //                         });\r\n        //                     }\r\n        //                 }\r\n        //             });\r\n        //         }\r\n        //     }\r\n        // });\r\n\r\n    },\r\n\r\n    quotation_numbers: function(frm) {\r\n        frm.set_value('policy_holder', '');\r\n        frm.set_value('proposal_no', '');\r\n        frm.set_value('inception_date', '');\r\n        frm.set_value('premium_rate', '');\r\n        frm.set_value('status', '');\r\n        frm.set_value('premium', '');\r\n        frm.set_value('policy_type', '');\r\n        frm.set_value('goods_services', '');\r\n\r\n        let quotationNumber = frm.doc.quotation_numbers;\r\n\r\n        frm.toggle_enable('quotation_numbers', true);\r\n\r\n        if (quotationNumber.startsWith(\"DCQT\")) {\r\n            console.log(\"Fetching data from DCI Quotation...\");\r\n            frappe.call({\r\n                method: 'frappe.client.get_value',\r\n                args: {\r\n                    doctype: 'DCI Quotation',\r\n                    filters: {\r\n                        schedule_no: quotationNumber\r\n                    },\r\n                    fieldname: ['client_name', 'proposal_no2', 'inception_date', 'premium_rate', 'status11', 'expected_annual_premium','goods_services']\r\n                },\r\n                callback: function(r) {\r\n                    if (!r.exc && r.message) {\r\n                        frm.set_value('policy_holder', r.message.client_name);\r\n                       // frm.set_value('proposal_no', r.message.proposal_no);\r\n                        frm.set_value('proposal_no', r.message.proposal_no2);\r\n                        frm.set_value('inception_date', r.message.inception_date);\r\n                        frm.set_value('premium_rate', r.message.premium_rate);\r\n                        frm.set_value('status', r.message.status11);\r\n                        frm.set_value('premium', r.message.expected_annual_premium);\r\n                        frm.set_value('goods_services', r.message.goods_services);\r\n                        frm.fields_dict.policy_type.set_value('DCI');\r\n\r\n                        // Generate policy number after setting policy holder\r\n                       generateNumber(frm, 'policy_number');\r\n                    } else {\r\n                        console.error(\"Error occurred while fetching data from DCI Quotation:\", r.exc);\r\n                    }\r\n                },\r\n            });\r\n        } else if (quotationNumber.startsWith(\"ECQT\")) {\r\n            console.log(\"Fetching data from ECI Quotations...\");\r\n            frappe.call({\r\n                method: 'frappe.client.get_value',\r\n                args: {\r\n                    doctype: 'ECI Quotations',\r\n                    filters: {\r\n                        schedule_no: quotationNumber\r\n                    },\r\n                    fieldname: ['client_name', 'proposal_no1', 'inception_date','status1', 'amt','goods_services']\r\n                },\r\n                callback: function(r) {\r\n                    if (!r.exc && r.message) {\r\n                        frm.set_value('policy_holder', r.message.client_name);\r\n                       // frm.set_value('proposal_no', r.message.proposal_no);\r\n                        frm.set_value('proposal_no', r.message.proposal_no1);\r\n                        frm.set_value('inception_date', r.message.inception_date);\r\n                        frm.set_value('status', r.message.status1);\r\n                        frm.set_value('premium', r.message.amt);\r\n                        frm.set_value('goods_services', r.message.goods_services);\r\n                        frm.fields_dict.policy_type.set_value('ECI');\r\n\r\n                        // Generate policy number after setting policy holder\r\n                        generateNumber(frm, 'policy_number');\r\n                    } else {\r\n                        console.error(\"Error occurred while fetching data from ECI Quotations:\", r.exc);\r\n                    }\r\n                },\r\n            });\r\n        } else {\r\n            console.log(\"Unknown prefix:\", quotationNumber);\r\n        }\r\n    },\r\n\r\n    refresh: function(frm) {\r\n        \r\n      frm.fields_dict.premium.$input.css(\"text-align\", \"right\");\r\n      frm.fields_dict.premium_rate.$input.css(\"text-align\", \"right\");\r\n       \r\n      \r\n\r\n       \r\n        $('.underlined').on('click', function(event) {\r\n            event.preventDefault();\r\n            var linkText = $(this).text().trim();\r\n            var workflowState = frm.doc.workflow_state;  // Assuming workflow_state is the field name in your form\r\n\r\n            switch (linkText) {\r\n                case 'Covering Letter':\r\n                    if (workflowState === 'Accepted' || workflowState === 'Rejected') {\r\n                        openDocument(frm, 'Covering Letter Policy Approvals');\r\n                    } else {\r\n                        frappe.msgprint(\"Acceptance is required to access the document.\");\r\n                     }\r\n                    break;\r\n                    \r\n                case 'Policy Document':\r\n                    if (workflowState === 'Accepted' || workflowState === 'Rejected') {\r\n                        openDocument(frm, 'Policy Document Policy Approvals');\r\n                    } else {\r\n                        frappe.msgprint(\"Acceptance is required to access the document.\");\r\n                     }\r\n                    break;\r\n                    \r\n                case 'Policy Schedule':\r\n                    if (workflowState === 'Accepted' || workflowState === 'Rejected') {\r\n                        openDocument(frm, 'Policy Schedule Policy Approvals');\r\n                    } else {\r\n                        frappe.msgprint(\"Acceptance is required to access the document.\");\r\n                     }\r\n                    break;\r\n                    \r\n                case 'Policy Administration Guidelines':\r\n                    if (workflowState === 'Accepted' || workflowState === 'Rejected') {\r\n                        openDocument(frm, 'Policy Administration guidelines');\r\n                    } else {\r\n                        frappe.msgprint(\"Acceptance is required to access the document.\");\r\n                      }\r\n                    break;\r\n                    \r\n                case 'Credit Limit Application Forms':\r\n                    if (workflowState === 'Accepted' || workflowState === 'Rejected') {\r\n                        openDocument(frm, 'Credit Limit Application  Forms');\r\n                    } else {\r\n                      frappe.msgprint(\"Acceptance is required to access the document.\");\r\n                      }\r\n                    break;\r\n                    \r\n                default:\r\n                    console.log(\"No action defined for\", linkText);\r\n            }\r\n        });\r\n\r\n\r\n//  if (frm.doc.workflow_state === \"Approved\") {\r\nif (frm.doc.workflow_state === \"Accepted\") {\r\n            // Add the custom button\r\n            frm.add_custom_button(__('Proforma Invoice'), function() {\r\n                // Calculate the values needed\r\n                var percent14 = (14 / 100) * frm.doc.premium;\r\n                percent14 = Number(percent14.toFixed(2));\r\n                var data4 = (parseFloat(frm.doc.premium) + percent14).toFixed(2);\r\n\r\n                // Set route options for the new document\r\n                frappe.route_options = {\r\n                    invoice_to: frm.doc.policy_holder,\r\n                    data1: frm.doc.premium,\r\n                    data2: frm.doc.premium,\r\n                    data3: percent14,\r\n                    data4: data4\r\n                };\r\n\r\n                // Create a new Proforma Invoice document\r\n                 frappe.new_doc('Proforma Invoice');\r\n\r\n                console.log(\"Proforma Invoice button clicked!\");\r\n            }).addClass(\"btn-primary\");\r\n        } else {\r\n            // Optionally clear the button if needed\r\n            frm.page.clear_inner_btn_group();\r\n        }\r\n    },\r\n    \r\n     policy_type: function(frm) {\r\n        toggle_fields(frm);\r\n    }\r\n     \r\n    \r\n});\r\n\r\n//   function openDocument(frm, doctype) {\r\n//     var parameters = {\r\n//         policy_number: frm.doc.policy_number,\r\n//         policy_holder: frm.doc.policy_holder,\r\n//         proposal_no: frm.doc.proposal_no,\r\n//         quotation_numbers: frm.doc.quotation_numbers,\r\n//         attention_mr: frm.doc.policy_holder,\r\n//         to: frm.doc.policy_holder\r\n//     };\r\n\r\n//     frappe.new_doc(doctype, parameters);\r\n// }\r\n\r\n  function openDocument(frm, doctype) {\r\n    var parameters = {\r\n        policy_no: frm.doc.policy_number,\r\n        policy_holder: frm.doc.policy_holder,\r\n        proposal_no: frm.doc.proposal_no,\r\n        to:frm.doc.policy_holder,\r\n        policy_number:frm.doc.policy_number,\r\n        quotation_numbers:frm.doc.policy_number,\r\n        \r\n        quotation1: frm.doc.quotation_numbers,\r\n        date: frm.doc.acceptance_date,\r\n        client_name: frm.doc.policy_holder,\r\n        signed_by: frm.doc.autharoized_signatory,\r\n        quotation2: frm.doc.quotation_numbers,\r\n        maximum_terms_of_payment: frm.doc.payment_terms,\r\n        name_of_insured: frm.doc.policy_holder,\r\n        premium_rate: frm.doc.premium_rate,\r\n        description_of_goods:frm.doc.goods_services,\r\n\r\n        \r\n    };\r\n\r\n    frappe.new_doc(doctype, parameters);\r\n}\r\n\r\n\r\n  function generateNumber(frm, field_name) {\r\n    let currentYear = new Date().getFullYear();\r\n    let prefix = `PLY/${currentYear}/`;\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Policy Approvals',\r\n            fields: [field_name, 'creation'],\r\n            order_by: 'creation desc',\r\n            limit: 1\r\n        },\r\n        callback: function(r) {\r\n            if (r.message && r.message.length > 0) {\r\n                let lastPolicyNo = r.message[0][field_name];\r\n                let lastNumber = parseInt(lastPolicyNo.split(\"/\").pop());\r\n                if (!isNaN(lastNumber)) {\r\n                    let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n                    frm.set_value(field_name, prefix + newNumber);\r\n                }\r\n            } else {\r\n                frm.set_value(field_name, prefix + '0001');\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n\r\n  function toggle_fields(frm) {\r\n    if (frm.doc.policy_type === 'DCI') {\r\n        frm.set_df_property('premium_rate', 'hidden', 0);\r\n        frm.set_df_property('premium', 'hidden', 0);\r\n    } else {\r\n        frm.set_df_property('premium_rate', 'hidden', 1);\r\n         frm.set_df_property('premium', 'hidden', 0);\r\n       \r\n    }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n  // function generateNumber(frm, field_name) {\r\n//     let currentYear = new Date().getFullYear();\r\n//     let policyHolder = frm.doc.policy_holder || 'PLY';\r\n//     let prefix = `${policyHolder.substring(0, 3).toUpperCase()}/${currentYear}/`;\r\n\r\n//     frappe.call({\r\n//         method: 'frappe.client.get_list',\r\n//         args: {\r\n//             doctype: 'Policy Approvals',\r\n//             fields: [field_name, 'creation'],\r\n//             order_by: 'creation desc',\r\n//             limit: 1\r\n//         },\r\n//         callback: function(r) {\r\n//             if (r.message && r.message.length > 0) {\r\n//                 let lastPolicyNo = r.message[0][field_name];\r\n//                 let lastNumber = parseInt(lastPolicyNo.split(\"/\").pop());\r\n//                 if (!isNaN(lastNumber)) {\r\n//                     let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n//                     frm.set_value(field_name, prefix + newNumber);\r\n//                 }\r\n//             } else {\r\n//                 frm.set_value(field_name, prefix + '0001');\r\n//             }\r\n//         }\r\n//     });\r\n// }\r\n  // frm.add_custom_button(__('Proforma Invoice'), function() {\r\n        //     var percent14 = (14 / 100) * frm.doc.premium;\r\n        //     percent14 = Number(percent14.toFixed(2));\r\n        //     var data4 = (parseFloat(frm.doc.premium) + percent14).toFixed(2);\r\n\r\n        //     frappe.route_options = {\r\n        //         invoice_to: frm.doc.policy_holder,\r\n        //         data1: frm.doc.premium,\r\n        //         data2: frm.doc.premium,\r\n        //         data3: percent14,\r\n        //         data4: data4\r\n        //     };\r\n\r\n        //     frappe.new_doc('Proforma Invoice');\r\n\r\n        //     console.log(\"Proforma Invoice clicked!\");\r\n        // }).addClass(\"btn-primary\");\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// frappe.ui.form.on('Policy Approvals', {\r\n//     onload: function(frm) {\r\n//         if (!frm.doc.policy_number && frm.doc.policy_holder) {\r\n//             generateNumber(frm, 'policy_number');\r\n//         }\r\n\r\n//         console.log(\"** Fetching Submitted DCI Quotation **\");\r\n\r\n//         frappe.call({\r\n//             method: 'frappe.client.get_list',\r\n//             args: {\r\n//                 doctype: 'DCI Quotation',\r\n//                 filters: {\r\n//                     workflow_state: 'Approved'\r\n//                 },\r\n//                 fields: ['schedule_no']\r\n//             },\r\n//             callback: function(submittedDCIQuotationsResponse) {\r\n//                 if (submittedDCIQuotationsResponse.message) {\r\n//                     var submittedDCIQuotations = submittedDCIQuotationsResponse.message.map(function(quotation) {\r\n//                         return quotation.schedule_no;\r\n//                     });\r\n\r\n//                     console.log(\"** Submitted DCI Quotation:\", submittedDCIQuotations);\r\n\r\n//                     console.log(\"** Fetching Submitted ECI Quotations **\");\r\n\r\n//                     frappe.call({\r\n//                         method: 'frappe.client.get_list',\r\n//                         args: {\r\n//                             doctype: 'ECI Quotations',\r\n//                             filters: {\r\n//                                 workflow_state: 'Approved'\r\n//                             },\r\n//                             fields: ['schedule_no']\r\n//                         },\r\n//                         callback: function(submittedECIQuotationsResponse) {\r\n//                             if (submittedECIQuotationsResponse.message) {\r\n//                                 var submittedECIQuotations = submittedECIQuotationsResponse.message.map(function(quotation) {\r\n//                                     return quotation.schedule_no;\r\n//                                 });\r\n\r\n//                                 console.log(\"** Submitted ECI Quotations:\", submittedECIQuotations);\r\n\r\n//                                 console.log(\"** Fetching Approved Policy Approvals **\");\r\n\r\n//                                 frappe.call({\r\n//                                     method: 'frappe.client.get_list',\r\n//                                     args: {\r\n//                                         doctype: 'Policy Approvals',\r\n//                                         filters: {\r\n//                                             workflow_state: 'Approved',\r\n//                                             quotation_numbers: ['in', submittedDCIQuotations.concat(submittedECIQuotations)]\r\n//                                         },\r\n//                                         fields: ['quotation_numbers']\r\n//                                     },\r\n//                                     callback: function(approvedPolicyApprovalsResponse) {\r\n//                                         if (approvedPolicyApprovalsResponse.message) {\r\n//                                             var approvedPolicyApprovals = approvedPolicyApprovalsResponse.message.map(function(policyApproval) {\r\n//                                                 return policyApproval.quotation_numbers;\r\n//                                             });\r\n\r\n//                                             console.log(\"** Approved Policy Approvals:\", approvedPolicyApprovals);\r\n\r\n//                                             var filteredQuotations = submittedDCIQuotations.concat(submittedECIQuotations).filter(function(quotation) {\r\n//                                                 return !approvedPolicyApprovals.includes(quotation);\r\n//                                             });\r\n\r\n//                                             console.log(\"** Filtered Quotations:\", filteredQuotations);\r\n\r\n//                                             frm.set_df_property('quotation_numbers', 'options', filteredQuotations);\r\n//                                         }\r\n//                                     }\r\n//                                 });\r\n//                             }\r\n//                         }\r\n//                     });\r\n//                 }\r\n//             }\r\n//         });\r\n//     },\r\n\r\n//     quotation_numbers: function(frm) {\r\n//         frm.set_value('policy_holder', '');\r\n//         frm.set_value('proposal_no', '');\r\n//         frm.set_value('inception_date', '');\r\n//         frm.set_value('premium_rate', '');\r\n//         frm.set_value('status', '');\r\n//         frm.set_value('premium', '');\r\n//         frm.set_value('policy_type', '');\r\n\r\n//         let quotationNumber = frm.doc.quotation_numbers;\r\n\r\n//         frm.toggle_enable('quotation_numbers', true);\r\n\r\n//         if (quotationNumber.startsWith(\"DCQT\")) {\r\n//             console.log(\"Fetching data from DCI Quotation...\");\r\n//             frappe.call({\r\n//                 method: 'frappe.client.get_value',\r\n//                 args: {\r\n//                     doctype: 'DCI Quotation',\r\n//                     filters: {\r\n//                         schedule_no: quotationNumber\r\n//                     },\r\n//                     fieldname: ['client_name', 'proposal_no', 'inception_date', 'premium_rate', 'status12', 'insured_turnover']\r\n//                 },\r\n//                 callback: function(r) {\r\n//                     if (!r.exc && r.message) {\r\n//                         frm.set_value('policy_holder', r.message.client_name);\r\n//                         frm.set_value('proposal_no', r.message.proposal_no);\r\n//                         frm.set_value('inception_date', r.message.inception_date);\r\n//                         frm.set_value('premium_rate', r.message.premium_rate);\r\n//                         frm.set_value('status', r.message.status12);\r\n//                         frm.set_value('premium', r.message.insured_turnover);\r\n//                         frm.fields_dict.policy_type.set_value('DCI');\r\n\r\n//                         // Generate policy number after setting policy holder\r\n//                         if (!frm.doc.policy_number) {\r\n//                             generateNumber(frm, 'policy_number');\r\n//                         }\r\n//                     } else {\r\n//                         console.error(\"Error occurred while fetching data from DCI Quotation:\", r.exc);\r\n//                     }\r\n//                 },\r\n//             });\r\n//         } else if (quotationNumber.startsWith(\"ECQT\")) {\r\n//             console.log(\"Fetching data from ECI Quotations...\");\r\n//             frappe.call({\r\n//                 method: 'frappe.client.get_value',\r\n//                 args: {\r\n//                     doctype: 'ECI Quotations',\r\n//                     filters: {\r\n//                         schedule_no: quotationNumber\r\n//                     },\r\n//                     fieldname: ['client_name', 'proposal_no', 'inception_date', 'premium_rate', 'status1', 'min_premium_depositp']\r\n//                 },\r\n//                 callback: function(r) {\r\n//                     if (!r.exc && r.message) {\r\n//                         frm.set_value('policy_holder', r.message.client_name);\r\n//                         frm.set_value('proposal_no', r.message.proposal_no);\r\n//                         frm.set_value('inception_date', r.message.inception_date);\r\n//                         frm.set_value('premium_rate', r.message.premium_rate);\r\n//                         frm.set_value('status', r.message.status1);\r\n//                         frm.set_value('premium', r.message.min_premium_depositp);\r\n//                         frm.fields_dict.policy_type.set_value('ECI');\r\n\r\n//                         // Generate policy number after setting policy holder\r\n//                         if (!frm.doc.policy_number) {\r\n//                             generateNumber(frm, 'policy_number');\r\n//                         }\r\n//                     } else {\r\n//                         console.error(\"Error occurred while fetching data from ECI Quotations:\", r.exc);\r\n//                     }\r\n//                 },\r\n//             });\r\n//         } else {\r\n//             console.log(\"Unknown prefix:\", quotationNumber);\r\n//         }\r\n//     },\r\n\r\n//     refresh: function(frm) {\r\n//         $('.underlined').on('click', function(event) {\r\n//             event.preventDefault();\r\n//             var linkText = $(this).text().trim();\r\n//             var workflowState = frm.doc.workflow_state;  // Assuming workflow_state is the field name in your form\r\n\r\n//             switch (linkText) {\r\n//                 case 'Covering Letter':\r\n//                     if (workflowState === 'Approved' || workflowState === 'Rejected') {\r\n//                         openDocument(frm, 'Covering letter_CIGIS');\r\n//                     } else {\r\n//                         frappe.msgprint(\"Approval is required to access the document.\");\r\n//                      }\r\n//                     break;\r\n                    \r\n//                 case 'Policy document':\r\n//                     if (workflowState === 'Approved' || workflowState === 'Rejected') {\r\n//                         openDocument(frm, 'New_Policy_Doc');\r\n//                     } else {\r\n//                         frappe.msgprint(\"Approval is required to access the document.\");\r\n//                      }\r\n//                     break;\r\n                    \r\n//                 case 'Policy schedule':\r\n//                     if (workflowState === 'Approved' || workflowState === 'Rejected') {\r\n//                         openDocument(frm, 'Policy Schedule _CIGIS');\r\n//                     } else {\r\n//                         frappe.msgprint(\"Approval is required to access the document.\");\r\n//                      }\r\n//                     break;\r\n                    \r\n//                 case 'Policy Administration guidelines':\r\n//                     if (workflowState === 'Approved' || workflowState === 'Rejected') {\r\n//                         openDocument(frm, 'Policy Administration guidelines');\r\n//                     } else {\r\n//                         frappe.msgprint(\"Approval is required to access the document.\");\r\n//                       }\r\n//                     break;\r\n                    \r\n//                 case 'Credit Limit Application Forms':\r\n//                     if (workflowState === 'Approved' || workflowState === 'Rejected') {\r\n//                         openDocument(frm, 'Credit Limit Application  Forms');\r\n//                     } else {\r\n//                       frappe.msgprint(\"Approval is required to access the document.\");\r\n//                       }\r\n//                     break;\r\n                    \r\n//                 default:\r\n//                     console.log(\"No action defined for\", linkText);\r\n//             }\r\n//         });\r\n\r\n//         frm.add_custom_button(__('Proforma Invoice'), function() {\r\n//             var percent14 = (14 / 100) * frm.doc.premium;\r\n//             percent14 = Number(percent14.toFixed(2));\r\n//             var data4 = (parseFloat(frm.doc.premium) + percent14).toFixed(2);\r\n\r\n//             frappe.route_options = {\r\n//                 invoice_to: frm.doc.policy_holder,\r\n//                 data1: frm.doc.premium,\r\n//                 data2: frm.doc.premium,\r\n//                 data3: percent14,\r\n//                 data4: data4\r\n//             };\r\n\r\n//             frappe.new_doc('Proforma Invoice');\r\n\r\n//             console.log(\"Proforma Invoice clicked!\");\r\n//         }).addClass(\"btn-primary\");\r\n//     }\r\n// });\r\n\r\n// function openDocument(frm, doctype) {\r\n//     var parameters = {\r\n//         policy_number: frm.doc.policy_number,\r\n//         policy_holder: frm.doc.policy_holder,\r\n//         proposal_no: frm.doc.proposal_no,\r\n//         quotation_numbers: frm.doc.quotation_numbers,\r\n//         attention_mr: frm.doc.policy_holder,\r\n//         to: frm.doc.policy_holder\r\n//     };\r\n\r\n//     frappe.new_doc(doctype, parameters);\r\n// }\r\n\r\n// function generateNumber(frm, field_name) {\r\n//     let currentYear = new Date().getFullYear();\r\n//     let policyHolder = frm.doc.policy_holder || 'PLY';\r\n//     let prefix = `${policyHolder.substring(0, 3).toUpperCase()}/${currentYear}/`;\r\n\r\n//     frappe.call({\r\n//         method: 'frappe.client.get_list',\r\n//         args: {\r\n//             doctype: 'Policy Approvals',\r\n//             fields: [field_name, 'creation'],\r\n//             order_by: 'creation desc',\r\n//             limit: 1\r\n//         },\r\n//         callback: function(r) {\r\n//             if (r.message && r.message.length > 0) {\r\n//                 let lastPolicyNo = r.message[0][field_name];\r\n//                 let lastNumber = parseInt(lastPolicyNo.split(\"/\").pop());\r\n//                 if (!isNaN(lastNumber)) {\r\n//                     let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n//                     frm.set_value(field_name, prefix + newNumber);\r\n//                 }\r\n//             } else {\r\n//                 frm.set_value(field_name, prefix + '0001');\r\n//             }\r\n//         }\r\n//     });\r\n// }\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Follow-UP",
  "enabled": 1,
  "modified": "2024-06-20 06:29:49.086572",
  "module": null,
  "name": "Follow Ups",
  "script": "\nfunction generateNumber(frm) {\n   \n    if (!frm.doc.followup_id) {\n   \n        let currentYear = new Date().getFullYear();\n        let prefix = `FUP/${currentYear}/`;\n\n      \n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Follow Ups',\n                fields: ['followup_id'],\n                limit: 1,\n                order_by: 'creation desc'\n            },\n           callback: function(r) {\n                if (r.message && r.message.length > 0) {\n                    let lastClaimRefNo = r.message[0].followup_id;\n                    let lastNumber = lastClaimRefNo ? parseInt(lastClaimRefNo.split(\"/\").pop()) : null;\n                    if (!isNaN(lastNumber)) {\n                        let newNumber = (lastNumber + 1).toString().padStart(4, '0');\n                        frm.set_value('followup_id', prefix + newNumber);\n                    }\n                } else {\n                    frm.set_value('followup_id', prefix + '0001');\n                }\n            }\n        });\n\n                // Make a call to get the last deputy sheriff bond number asynchronously\n                // frappe.call({\n                //     method: 'frappe.client.get_list',\n                //     args: {\n                //         doctype: 'Deputy Sheriff Bond',\n                //         fields: ['bond_no'],\n                //         limit: 1,\n                //         order_by: 'creation desc'\n                //     },\n                //     callback: function(response) {\n                //         console.log(response, \"deputy sheriff bond no\");\n                //         let lastDeputySheriffBondNo = response.message && response.message.length > 0 ? response.message[0].bond_no : '0';\n                //         let lastDeputySheriffBondNumber = parseInt(lastDeputySheriffBondNo.split(\"/\").pop());\n\n                //         // Get the maximum of the two last bond numbers\n                //         let maxLastNumber = Math.max(lastNumber, lastDeputySheriffBondNumber);\n\n                //         if (!isNaN(maxLastNumber)) {\n                //             // Increment the last number and pad it with leading zeros\n                //             let newNumber = (maxLastNumber + 1).toString().padStart(4, '0');\n                //             frm.set_value('bond_no', prefix + newNumber);\n                //         } else {\n                //             // If no previous numbers exist, set to default '0001'\n                //             frm.set_value('bond_no', prefix + '0001');\n                //         }\n                //     }\n                // });\n            }\n        \n    }\n\n\n\n\nfrappe.ui.form.on('Follow-UP', {\n    // onload(frm) {\n    //     // Check if the serial number exists in the local storage, initialize if not\n    //     if (!localStorage.getItem('policySerialNumber')) {\n    //         localStorage.setItem('policySerialNumber', '1');\n    //     }\n\n    //     const currentYear = new Date().getFullYear();\n    //     let serialNumber = parseInt(localStorage.getItem('policySerialNumber'));\n    //     const serialNumberFormatted = serialNumber.toString().padStart(4, '0');\n\n    //     frm.set_value('followup_id', `FUP/${currentYear}/${serialNumberFormatted}`);\n\n    //     // Increment the serial number\n    //     serialNumber++;\n\n    //     // Update the serial number in local storage\n    //     localStorage.setItem('policySerialNumber', serialNumber.toString());\n    // },\n    \n    onload(frm) {\n     if (!frm.doc.followup_id) {\n           generateNumber(frm)\n        }\n    },\n    \n     validate (frm) {\n        var selectedDate = frm.doc.schdate;\n        var currentDate = frappe.datetime.get_today();\n        if (selectedDate <= currentDate) {\n            frappe.msgprint(__(\"Please select Scheduledate Should be greater than the current date.\"));\n            frappe.validated = false;  \n        };\n    },\n     \n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Company-Details",
  "enabled": 1,
  "modified": "2025-11-27 08:01:58.724988",
  "module": null,
  "name": "Company-Details CS",
  "script": "frappe.ui.form.on('Company-Details', {\n    \nonload:function(frm){ \n\n  },\n    \n   \n    refresh: function(frm) {\n   \n        \n        const country_map = {\n\"AA\": \"Andorra\",\n\"AC\": \"Ascension Island\",\n\"AD\": \"Abu Dhabi\",\n\"AG\": \"Antigua & Barbuda\",\n\"AI\": \"Anguilla\",\n\"AM\": \"Ajman\",\n\"AN\": \"Netherlands Antilles\",\n\"AO\": \"Angola\",\n\"AR\": \"Argentina\",\n\"AT\": \"Austria\",\n\"AU\": \"Australia\",\n\"AW\": \"Aruba\",\n\"AZ\": \"Azores\",\n\"BB\": \"Barbados\",\n\"BE\": \"Belgium\",\n\"BH\": \"Bahrain\",\n\"BM\": \"Bermuda\",\n\"BN\": \"Brunei\",\n\"BO\": \"Bolivia\",\n\"BR\": \"Brazil\",\n\"BS\": \"Bahamas\",\n\"BW\": \"Botswana\",\n\"BZ\": \"Belize\",\n\"CA\": \"Canada\",\n\"CC\": \"Cocos Islands\",\n\"CE\": \"Ceuta & Melilla\",\n\"CH\": \"Switzerland\",\n\"CI\": \"Canary Islands\",\n\"CK\": \"Cook Islands\",\n\"CL\": \"Chile\",\n\"CN\": \"China\",\n\"CO\": \"Colombia\",\n\"CS\": \"Channel Islands\",\n\"CX\": \"Christmas Islands\",\n\"CY\": \"Cyprus\",\n\"CZ\": \"Czech Republic\",\n\"DC\": \"Congo DRC\",\n\"DE\": \"Germany\",\n\"DK\": \"Denmark\",\n\"DO\": \"Dominican Republic\",\n\"DU\": \"Dubai\",\n\"EC\": \"Ecuador\",\n\"EG\": \"Egypt\",\n\"EI\": \"Eire\",\n\"ES\": \"Spain\",\n\"FI\": \"Finland\",\n\"FJ\": \"Fiji\",\n\"FK\": \"Falkland Islands\",\n\"FM\": \"Micronesia, Federated States of\",\n\"FO\": \"Faroe Islands\",\n\"FR\": \"France\",\n\"FU\": \"Fujairah\",\n\"UK\": \"United Kingdom\",\n\"GD\": \"Grenada\",\n\"GF\": \"French Guiana\",\n\"GH\": \"Ghana\",\n\"GI\": \"Gibraltar\",\n\"GL\": \"Greenland\",\n\"GP\": \"Guadeloupe\",\n\"GR\": \"Greece\",\n\"GS\": \"South Georgia & South Sandwich Islands\",\n\"GT\": \"Guatemala\",\n\"GU\": \"Guam\",\n\"HK\": \"Hong Kong\",\n\"HN\": \"Honduras\",\n\"HU\": \"Hungary\",\n\"IL\": \"Israel\",\n\"IM\": \"Isle of Man\",\n\"IN\": \"India\",\n\"IS\": \"Iceland\",\n\"IT\": \"Italy\",\n\"JM\": \"Jamaica\",\n\"JO\": \"Jordan\",\n\"JP\": \"Japan\",\n\"KE\": \"Kenya\",\n\"KI\": \"Kiribati\",\n\"KN\": \"St. Kitts & Nevis\",\n\"KR\": \"Korea (South)\",\n\"KW\": \"Kuwait\",\n\"KY\": \"Cayman Islands\",\n\"LA\": \"Laos\",\n\"LC\": \"Saint Lucia\",\n\"LI\": \"Liechtenstein\",\n\"LK\": \"Sri Lanka\",\n\"LU\": \"Luxembourg\",\n\"MA\": \"Morocco\",\n\"MC\": \"Monaco\",\n\"MH\": \"Marshall Islands\",\n\"MI\": \"Madeira\",\n\"MO\": \"Macao\",\n\"MP\": \"Northern Mariana Islands\",\n\"MQ\": \"Martinique\",\n\"MS\": \"Montserrat\",\n\"MT\": \"Malta\",\n\"MU\": \"Mauritius\",\n\"MV\": \"Maldives\",\n\"MW\": \"Malawi\",\n\"MX\": \"Mexico\",\n\"MY\": \"Malaysia\",\n\"MZ\": \"Mozambique\",\n\"NA\": \"Namibia\",\n\"NC\": \"New Caledonia\",\n\"NF\": \"Norfolk Islands\",\n\"NI\": \"Nicaragua\",\n\"NL\": \"Netherlands\",\n\"NO\": \"Norway\",\n\"NU\": \"Niue\",\n\"NZ\": \"New Zealand\",\n\"OM\": \"Oman\",\n\"PA\": \"Panama\",\n\"PF\": \"French Polynesia\",\n\"PH\": \"Philippines\",\n\"PK\": \"Pakistan\",\n\"PL\": \"Poland\",\n\"PM\": \"St. Pierre & Miquelon\",\n\"PN\": \"Pitcairn Island\",\n\"PR\": \"Puerto Rico\",\n\"PT\": \"Portugal\",\n\"PW\": \"Palau\",\n\"PY\": \"Paraguay\",\n\"QA\": \"Qatar\",\n\"RE\": \"Reunion\",\n\"RK\": \"Ras Al Khaimah\",\n\"SA\": \"South Africa\",\n\"SB\": \"Solomon Islands\",\n\"SC\": \"Seychelles\",\n\"SE\": \"Sweden\",\n\"SG\": \"Singapore\",\n\"SH\": \"St. Helena\",\n\"SJ\": \"Sharjah\",\n\"SM\": \"San Marino\",\n\"SN\": \"Samoa, American\",\n\"SV\": \"El Salvador\",\n\"SW\": \"Senegal\",\n\"SZ\": \"Swaziland\",\n\"TC\": \"Turks and Caicos Islands\",\n\"TD\": \"Tristan da Cunha\",\n\"TH\": \"Thailand\",\n\"TK\": \"Tokelau\",\n\"TN\": \"Tunisia\",\n\"TO\": \"Tonga\",\n\"TR\": \"Turkey\",\n\"TT\": \"Trinidad and Tobago\",\n\"TV\": \"Tuvalu\",\n\"TW\": \"Taiwan\",\n\"UQ\": \"Umm Al Quwain\",\n\"US\": \"United States of America\",\n\"UY\": \"Uruguay\",\n\"VA\": \"Vatican City\",\n\"VC\": \"Saint Vincent & The Grenadines\",\n\"VG\": \"Virgin Islands British\",\n\"VI\": \"Virgin Islands, US\",\n\"VU\": \"Vanuatu\",\n\"WF\": \"Wallis & Futuna Islands\",\n\"WS\": \"Samoa, Western\",\n\"YE\": \"Yemen\",\n\"YT\": \"Mayotte\",\n\"ZA\": \"Saudi Arabia\",\n\"ZM\": \"Zambia\",\n\"ZW\": \"Zimbabwe\",\n\n\n            \n            // Add more country codes and names as needed\n        };\n\n        // Get the current value of the country field\n        let country_code = frm.doc.country;\n\n        // Check if the country code exists in the map\n        if (country_map[country_code]) {\n            // Update the display value in the UI\n            frm.set_df_property('country', 'options', [country_map[country_code]]);\n            frm.set_value('country', country_map[country_code]);\n        }\n        \n       \n       \n       \n         \n        \n        \n        \n        // Add 'btn-primary' class to buttons (if applicable)\n        \n        // Fetch options for select fields\n        fetchOptionsForSelectField(frm);\n        // fetchOptionsForSelectField1(frm);\n\n// frappe.call({\n//             method: 'frappe.client.get_list',\n//             args: {\n//                 doctype: 'Country Details',\n//                 fields: ['country'],\n//                 limit_page_length: 100  // Add this line to retrieve up to 100 records\n//             },\n//             callback: function(response) {\n//                 let DataArray = response.message;\n//                 let FinalArray = [];\n//                 for (let x of DataArray) {\n//                     FinalArray.push(x.country);\n//                 }\n//                 frm.set_df_property('country', 'options', FinalArray);\n//                 console.log(\"final\", FinalArray);\n//             },\n//             error: function(xhr, textStatus, errorThrown) {\n//                 console.error(\"Error fetching approved bonds:\", textStatus, errorThrown);\n//             }\n//         });\n\n\n\n    // frm.fields_dict.fax.$input.css(\"text-align\", \"right\");\n    // frm.fields_dict.registration_number.$input.css(\"text-align\", \"right\");\n    // frm.fields_dict.taxno.$input.css(\"text-align\", \"right\");\n    // frm.fields_dict.your_fieldname.$input.css(\"text-align\", \"right\");\n    \n     \n        \n    },\n   \n    validate: function(frm) {\n        \n          \n        \n        // Additional validation logic if needed\n\n        // Get the email field value\n        // var email = frm.doc.email;\n\n        // console.log(email); // Check the value of email\n\n        // // Validate the email using a regular expression\n        // var emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n        // if (!emailRegex.test(email)) {\n        //     frappe.msgprint(__(\"Please enter a valid email address.\"));\n        //     frappe.validated = false; // Prevent form submission\n        // }\n        \n        \n        \n//         var email = frm.doc.email;\n\n// console.log(email); // Check the value of email\n\n// if (email) { // Only validate if email is not empty\n//     // Validate the email using a regular expression\n//     var emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n//     if (!emailRegex.test(email)) {\n//         frappe.msgprint(__(\"Please enter a valid email address.\"));\n//         frappe.validated = false; // Prevent form submission\n//     }\n// }\n\n        \n        \n        \n\n        // Get the ac_no field value\n        var acNo = frm.doc.ac_no;\n\n        console.log(acNo); // Check the value of ac_no\n\n        // Validate the ac_no to ensure it is exactly 10 digits\n        var acNoRegex = /^\\d{1,15}$/;\n        if (!acNoRegex.test(acNo)) {\n            frappe.msgprint(__(\"It allows only 15-digit for account number field.\"));\n            frappe.validated = false; // Prevent form submission\n        }\n\n        \n        \n        // var status = frm.doc.status;\n\n        // console.log(status); // Check the value of status\n\n        // // Validate the status to ensure it is either \"Active\" or \"Inactive\"\n        // if (status !== \"ACTIVE\" && status !== \"INACTIVE\") {\n        //     frappe.msgprint(__(\"Select only 'ACTIVE' or 'INACTIVE' for the status field.\"));\n        //     frappe.validated = false; // Prevent form submission\n        // }\n        \n        let telephone = frm.doc.telephone;\n        \n        // Remove any non-digit characters (like spaces, dashes, etc.)\n        let digits_only = telephone.replace(/\\D/g, '');\n        \n        // Check if the number of digits is 11 or fewer\n        if (digits_only.length > 11) {\n            frappe.msgprint(__('Telephone number should not exceed 11 digits.'));\n            frappe.validated = false;  // Prevent form from saving\n        }\n    }\n});\n\n// Function to fetch options for the 'industry' select field\nfunction fetchOptionsForSelectField(frm) {\n    // Make an AJAX call to fetch values from another DocType\n    // frappe.call({\n    //     method: 'frappe.client.get_list',\n    //     args: {\n    //         doctype: 'Industry Sector',\n    //         filters: {},\n    //         fields: ['name'],\n    //         order_by: 'name asc',\n    //         limit_page_length: 1000 // Adjust the limit as per your requirement\n    //     },\n    //     callback: function(r) {\n    //         // Callback function to handle the response\n    //         if (r.message) {\n    //             var options = [];\n    //             $.each(r.message, function(i, d) {\n    //                 options.push(d.name);\n    //             });\n    //             // Set options for the Select field\n    //             frm.set_df_property('industry', 'options', options.join('\\n'));\n    //         }\n    //     }\n    // });\n}\n\n// Function to fetch options for the 'business' select field\n// function fetchOptionsForSelectField1(frm) {\n//     // Make an AJAX call to fetch values from another DocType\n//     frappe.call({\n//         method: 'frappe.client.get_list',\n//         args: {\n//             doctype: 'Industry Type',\n//             filters: {},\n//             fields: ['name'],\n//             order_by: 'name asc',\n//             limit_page_length: 1000 // Adjust the limit as per your requirement\n//         },\n//         callback: function(r) {\n//             // Callback function to handle the response\n//             if (r.message) {\n//                 var options = [];\n//                 $.each(r.message, function(i, d) {\n//                     options.push(d.name);\n//                 });\n//                 // Set options for the Select field\n//                 frm.set_df_property('business', 'options', options.join('\\n'));\n//             }\n//         }\n//     });\n// }\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n// frappe.ui.form.on('Company-Details', {\n//     refresh: function(frm) {\n//         // Add 'btn-primary' class to buttons (if applicable)\n        \n//         // Fetch options for select fields\n//         fetchOptionsForSelectField(frm);\n//         fetchOptionsForSelectField1(frm);\n\n//         // Set the 'establisheddate' field to today's date\n//         // frm.set_value('establisheddate', frappe.datetime.get_today());\n//     },\n    \n//     validate: function(frm) {\n//         // Additional validation logic if needed\n\n//         // Get the email field value\n//         var email = frm.doc.email;\n\n//         console.log(email); // Check the value of email\n\n//         // Validate the email using a regular expression\n//         var emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n//         if (!emailRegex.test(email)) {\n//             frappe.msgprint(__(\"Please enter a valid email address.\"));\n//             frappe.validated = false; // Prevent form submission\n//         }\n//     }\n// });\n\n// // Function to fetch options for the 'industry' select field\n// function fetchOptionsForSelectField(frm) {\n//     // Make an AJAX call to fetch values from another DocType\n//     frappe.call({\n//         method: 'frappe.client.get_list',\n//         args: {\n//             doctype: 'Industry Sector',\n//             filters: {},\n//             fields: ['name'],\n//             order_by: 'name asc',\n//             limit_page_length: 1000 // Adjust the limit as per your requirement\n//         },\n//         callback: function(r) {\n//             // Callback function to handle the response\n//             if (r.message) {\n//                 var options = [];\n//                 $.each(r.message, function(i, d) {\n//                     options.push(d.name);\n//                 });\n//                 // Set options for the Select field\n//                 frm.set_df_property('industry', 'options', options.join('\\n'));\n//             }\n//         }\n//     });\n// }\n\n// // Function to fetch options for the 'business' select field\n// function fetchOptionsForSelectField1(frm) {\n//     // Make an AJAX call to fetch values from another DocType\n//     frappe.call({\n//         method: 'frappe.client.get_list',\n//         args: {\n//             doctype: 'Industry Type',\n//             filters: {},\n//             fields: ['name'],\n//             order_by: 'name asc',\n//             limit_page_length: 1000 // Adjust the limit as per your requirement\n//         },\n//         callback: function(r) {\n//             // Callback function to handle the response\n//             if (r.message) {\n//                 var options = [];\n//                 $.each(r.message, function(i, d) {\n//                     options.push(d.name);\n//                 });\n//                 // Set options for the Select field\n//                 frm.set_df_property('business', 'options', options.join('\\n'));\n//             }\n//         }\n//     });\n// }\n\n    ",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Bond Facility Quotation",
  "enabled": 0,
  "modified": "2025-11-10 08:45:41.387197",
  "module": null,
  "name": "Bond Facility Quotation Script",
  "script": "frappe.ui.form.on('Bond Facility Quotation', {\r\n    onload: function(frm) {\r\n          \r\n        // if (!frm.doc.quotation_no) {\r\n        //     generateNumber(frm);\r\n        // }\r\n\r\n        // Set created_date field as read-only initially when creating a new form\r\n        if (frm.doc.__islocal) {\r\n            frm.set_df_property('created_date', 'read_only', true);\r\n        }\r\n\r\n        console.log('hello onload');\r\n\r\n        // frm.fields_dict['name1'].get_query = function(doc) {\r\n        //     return {\r\n        //         filters: {\r\n        //             \"workflow_state\": \"Submitted\"\r\n        //         }\r\n                \r\n        //     }\r\n        // }\r\n    frappe.call({\r\n            method: \"frappe.client.get_list\",\r\n            args: {\r\n                doctype: \"Bond Facility\",\r\n                filters: {\r\n                  //  workflow_state: 'Submitted'\r\n                },\r\n                fields: [\"client_name\"],\r\n                limit_page_length: 0\r\n            },\r\n            callback: function(response) {\r\n                if (response.message) {\r\n                    // Extract client names into a list\r\n                    let clientNames = response.message.map(row => row.client_name);\r\n\r\n                    // Set options in the name1 dropdown field\r\n                    frm.set_df_property('name1', 'options', [''].concat(clientNames));\r\n                }\r\n            }\r\n        });\r\n\r\n// Frappe call to fetch GM Approvers\r\n// frappe.call({\r\n//     method: \"frappe.client.get_list\",\r\n//     args: {\r\n//         doctype: \"User\",\r\n//         filters: {\r\n//             enabled: 1\r\n//         },\r\n//         fields: [\"name\", \"full_name\"]\r\n//     },\r\n//     callback: function(r) {\r\n//         if (r.message) {\r\n//             console.log(\"GM Approvers: \", r.message);\r\n\r\n//             let gm_approvers = r.message;\r\n//             let options = gm_approvers.map(approver => {\r\n//                 return { 'label': approver.full_name, 'value': approver.name };\r\n//             });\r\n\r\n//             console.log(\"Options: \", options);\r\n\r\n//             // Add options to the send_to field\r\n//             frm.set_df_property('send_to', 'options', options);\r\n//             frm.refresh_field('send_to');\r\n//         } else {\r\n//             console.log(\"No GM Approvers found\");\r\n//         }\r\n//     }\r\n// });\r\n\r\n},\r\n    error: function(err) {\r\n        console.log(\"Error: \", err);\r\n    },\r\n     name1: function(frm) {\r\n        if (frm.doc.name1) {\r\n            frappe.call({\r\n                method: 'frappe.client.get_value',\r\n                args: {\r\n                    doctype: 'Bond Facility',\r\n                    filters: {\r\n                        client_name: frm.doc.name1   // \u2705 Correct filter syntax\r\n                    },\r\n                    fieldname: ['facility_no', 'signed_on']  // \u2705 Correct key is fieldname (not fieldnames)\r\n                },\r\n                callback: function(r) {\r\n                    if (r.message) {\r\n                        // \u2705 Set values in your Quotation form\r\n                        frm.set_value('bond_facility_no', r.message.facility_no);\r\n                        frm.set_value('quotation_date', r.message.signed_on);\r\n                    } else {\r\n                        frappe.msgprint('No Bond Facility found for this client.');\r\n                        frm.set_value('bond_facility_no', '');\r\n                        frm.set_value('quotation_date', '');\r\n                    }\r\n                }\r\n            });\r\n        } else {\r\n            frm.set_value('bond_facility_no', '');\r\n            frm.set_value('quotation_date', '');\r\n        }\r\n    },\r\n//  name1: function(frm) {\r\n//         if (frm.doc.name1) {\r\n//             frappe.call({\r\n//                 method: 'frappe.client.get_value',\r\n//                 args: {\r\n//                     doctype: 'Bond Facility',\r\n//                     filters: { 'client_name': frm.doc.name1 },\r\n//                     fieldname: ['facility_no', 'client_name', 'workflow_state']\r\n//                 },\r\n//                 callback: function(r) {\r\n//                     if (r.message && r.message.client_name) {\r\n//                         frm.set_value('bond_facility_no', r.message.facility_no);\r\n//                         frm.set_value('quotation_status', r.message.workflow_state);\r\n//                     }\r\n//                 }\r\n//             });\r\n//         }\r\n//  },\r\n \r\n c1: function(frm) {\r\n        var c1_value = frm.doc.c1;\r\n\r\n        if (c1_value > 0) {\r\n            // Add 1 to the c1 value and store in bond_facility_limit2\r\n            var bondFacilityLimit = c1_value + 1;\r\n            frm.set_value('bond_facility_limit2', bondFacilityLimit);\r\n        } else {\r\n            // If c1 is 0 or less, store 0 in bond_facility_limit2\r\n            frm.set_value('bond_facility_limit2', 0);\r\n        }\r\n    },\r\n   c2: function(frm) {\r\n        var c2_value = frm.doc.c2;  // Correctly fetch the value of c2\r\n\r\n        if (c2_value > 0) {\r\n            // Add 1 to the c2 value and store in bond_facility_limit3\r\n            var bondFacilityLimit1 = c2_value + 1;\r\n            frm.set_value('bond_facility_limit3', bondFacilityLimit1);\r\n        } else {\r\n            // If c2 is 0 or less, store 0 in bond_facility_limit3\r\n            frm.set_value('bond_facility_limit3', 0);\r\n        }\r\n    },\r\n    c3: function(frm) {\r\n        var c3_value = frm.doc.c3;  // Correctly fetch the value of c3\r\n\r\n        if (c3_value > 0) {\r\n            // Add 1 to the c3 value and store in bond_facility_limit4\r\n            var bondFacilityLimit2 = c3_value + 1;\r\n            frm.set_value('bond_facility_limit4', bondFacilityLimit2);\r\n        } else {\r\n            // If c3 is 0 or less, store 0 in bond_facility_limit4\r\n            frm.set_value('bond_facility_limit4', 0);\r\n        }\r\n    },\r\n    c4: function(frm) {\r\n        var c4_value = frm.doc.c4;  // Correctly fetch the value of c4\r\n\r\n        if (c4_value > 0) {\r\n            // Add 1 to the c4 value and store in net_bond_facility\r\n            var bondFacilityLimit3 = c4_value + 1;\r\n            frm.set_value('net_bond_facility', bondFacilityLimit3);\r\n        } else {\r\n            // If c4 is 0 or less, store 0 in net_bond_facility\r\n            frm.set_value('net_bond_facility', 0);\r\n        }\r\n    },\r\n\r\n     refresh: function(frm) {\r\n        toggleFieldsBasedOnWorkflow(frm);\r\n    if (frm.is_new() && !frm.doc.quotation_no) {\r\n            frappe.call({\r\n                method: \"frappe.client.get_list\",\r\n                args: {\r\n                    doctype: \"Bond Facility Quotation\",\r\n                    fields: [\"quotation_no\"],\r\n                    filters: {\r\n                        quotation_no: [\"like\", \"BQT/\" + new Date().getFullYear() + \"/%\"]\r\n                    },\r\n                    order_by: \"quotation_no desc\",\r\n                    limit_page_length: 1\r\n                },\r\n                callback: function(r) {\r\n                    let year = new Date().getFullYear();\r\n                    let prefix = \"BQT/\" + year + \"/\";\r\n                    let next_number = 1;\r\n\r\n                    if (r.message && r.message.length > 0) {\r\n                        let last_no = r.message[0].quotation_no;\r\n                        let last_num = parseInt(last_no.split(\"/\")[2]) || 0;\r\n                        next_number = last_num + 1;\r\n                    }\r\n\r\n                    frm.set_value(\"quotation_no\", prefix + String(next_number).padStart(4, \"0\"));\r\n                }\r\n            });\r\n        }\r\n    \r\n         \r\n        frm.fields_dict.bond_facility_limit1.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.bond_facility_limit2.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.bond_facility_limit3.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.bond_facility_limit4.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.net_bond_facility.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.c1.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.c2.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.c3.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.c4.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.c5.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.security_percentage_for_limit_1.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.security_percentage_for_limit_2.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.security_percentage_for_limit_3.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.security_percentage_for_limit_4.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.security_percentage_for_limit_5.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.guarantee_fee_percentage.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.min_fee_guarantee.$input.css(\"text-align\", \"right\");\r\n        \r\n        \r\n      \r\n\r\n    //     // Basic logging to verify the script runs\r\n    //     console.log(\"Refresh event triggered\");\r\n\r\n    //     const fields = [\r\n    //         'gmapprover_remark', 'quotation_authorized_by', 'section_break_x2nfv',\r\n    //         'send_to_recommendation', 'column_break_vi09k',\r\n    //         'send_to', 'column_break_lg95e', 'send_to_recommendation',\r\n    //         'column_break_pwves', 'include_marketing_as_mail_recipient'\r\n    //     ];\r\n\r\n    //     // Ensure the document has a workflow_state before proceeding\r\n    //     if (!frm.doc.workflow_state) {\r\n    //         console.log(\"No workflow_state found\");\r\n    //         return;\r\n    //     }\r\n\r\n    //     // Log current workflow state for debugging\r\n    //     console.log(\"Current workflow state:\", frm.doc.workflow_state);\r\n\r\n    //     // Show fields based on workflow_state\r\n    //     if (['Pending', 'Reject', 'Declined', 'Approved'].includes(frm.doc.workflow_state)) {\r\n    //         console.log(`Showing fields for ${frm.doc.workflow_state} state`);\r\n    //         fields.forEach(field => {\r\n    //             frm.toggle_display(field, true);\r\n    //             console.log(\"Showing field:\", field);\r\n    //         });\r\n    //     } else {\r\n    //         // Hide fields for other states\r\n    //         console.log(\"Hiding fields for states other than Pending, Reject, Declined, and Approved\");\r\n    //         fields.forEach(field => {\r\n    //             frm.toggle_display(field, false);\r\n    //             console.log(\"Hiding field:\", field);\r\n    //         });\r\n    //     }\r\n    },\r\n    \r\n  \r\n\r\n    max_period_year: function(frm) {\r\n        let value = frm.doc.max_period_year;\r\n        let $field = frm.fields_dict.max_period_year.$wrapper.find('input');\r\n\r\n        if (value && value.toString().length > 2) {\r\n            $field.css('border', '2px solid red');\r\n        } else {\r\n            $field.css('border', ''); // Reset the border if the condition is not met\r\n        }\r\n    },\r\n// Created Date Code\r\n    // before_save: function(frm) {\r\n    //     // Set created_date if it's not already set\r\n    //     setCreatedDate(frm);\r\n    // },\r\n    \r\n    \r\n    \r\n \r\n});\r\n// original code\r\n\r\nfunction toggleFieldsBasedOnWorkflow(frm) {\r\n    if (frm.doc.workflow_state === 'Pending') {\r\n            // Show all fields for Pending\r\n            frm.fields.forEach(df => frm.toggle_display(df.fieldname, true));\r\n        } \r\n        else if (frm.doc.workflow_state === 'Approved' || frm.doc.workflow_state === 'Rejected') {\r\n            // Only show these two fields for Approved/Rejected\r\n            frm.fields.forEach(df => frm.toggle_display(df.fieldname, false));\r\n            frm.toggle_display('gmapprover_remark', true);\r\n            frm.toggle_display('quotation_authorized_by', true);\r\n        }\r\n}\r\n// original code\r\n\r\n// -------------------------------\r\n// \u2705 FUNCTION: Toggle Field Visibility\r\n// -------------------------------\r\n// function toggleFieldsBasedOnWorkflow(frm) {\r\n//     // \ud83d\udfe9 Fields to show when form is first created or in \"Save\"/Draft mode\r\n//   const always_visible = [\r\n//         \"name1\", \"bond_facility_no\", \"quotation_date\", \"quotation_no\",\r\n//         \"bond_facility_limit1\", \"bond_facility_limit2\", \"bond_facility_limit3\", \"bond_facility_limit4\",\r\n//         \"net_bond_facility\", \"c1\", \"c2\", \"c3\", \"c4\", \"c5\",\r\n//         \"security_percentage_for_limit_1\", \"security_percentage_for_limit_2\",\r\n//         \"security_percentage_for_limit_3\", \"security_percentage_for_limit_4\",\r\n//         \"security_percentage_for_limit_5\",\r\n//         \"note1\", \"note2\", \"note3\", \"note4\", \"note5\",\r\n//         \"guarantee_fee_percentage\", \"min_fee_guarantee\",\r\n//         \"min_period_month\", \"max_period_year\",\r\n//         \"reinsurer_sending_date\", \"reinsurer_response_date\",\r\n//         \"reinsurer_feedback\", \"ue_remake\"\r\n//     ];\r\n    \r\n//      // Fields visible only when Pending\r\n//     const pending_fields = [\r\n//         \"gmapprover_remark\", \"quotation_authorized_by\", \"send_to\", \"send_to_recommendation\", \"send_to_recomendation\", \"include_marketing_as_mail_recipient\"\r\n//     ];\r\n\r\n//  // Step 1: Hide all fields first\r\n//     Object.keys(frm.fields_dict).forEach(fieldname => {\r\n//         frm.set_df_property(fieldname, 'hidden', 1);\r\n//     });\r\n\r\n//     // Step 2: Always show the base fields\r\n//     always_visible.forEach(fieldname => {\r\n//         frm.set_df_property(fieldname, 'hidden', 0);\r\n//     });\r\n\r\n//     // Step 3: If workflow is Pending, show the extra fields too\r\n//     if (frm.doc.workflow_state === \"Pending\") {\r\n//         pending_extra.forEach(fieldname => {\r\n//             frm.set_df_property(fieldname, 'hidden', 0);\r\n//         });\r\n//     }\r\n\r\n//     frm.refresh_fields();\r\n// }\r\n\r\n// -------------------------------\r\n// \u2705 FUNCTION: Set created_date\r\n// -------------------------------\r\n\r\n// Define a function to set the created_date field\r\nfunction setCreatedDate(frm) {\r\n    if (!frm.doc.created_date) {\r\n        frm.set_value('created_date', frappe.datetime.now_datetime());\r\n    }\r\n\r\n    // Enable the created_date field after saving the record\r\n    frm.set_df_property('created_date', 'read_only', false);\r\n}\r\n\r\n// \r\n// \r\n// frappe.ui.form.on('Bond Facility Quotation', {\r\n//     onload: function(frm) {\r\n//         console.log('hello onload');\r\n\r\n//         // Auto-generate quotation number if not already set\r\n//         if (!frm.doc.quotation_no) {\r\n//             generateNumber(frm);\r\n//         }\r\n\r\n//         // Set created_date field as read-only initially when creating a new form\r\n//         if (frm.doc.__islocal) {\r\n//             frm.set_df_property('created_date', 'read_only', true);\r\n//         }\r\n\r\n//         // Filter name1 field to show only approved records\r\n//         frm.fields_dict['name1'].get_query = function(doc) {\r\n//             return {\r\n//                 filters: {\r\n//                     \"workflow_state\": \"Submitted\"\r\n//                 }\r\n//             };\r\n//         };\r\n\r\n//         // Fetch GM Approvers (Users)\r\n//         frappe.call({\r\n//             method: \"frappe.client.get_list\",\r\n//             args: {\r\n//                 doctype: \"User\",\r\n//                 filters: { enabled: 1 },\r\n//                 fields: [\"name\", \"full_name\"]\r\n//             },\r\n//             callback: function(r) {\r\n//                 if (r.message) {\r\n//                     console.log(\"GM Approvers:\", r.message);\r\n//                     let options = r.message.map(approver => ({\r\n//                         label: approver.full_name,\r\n//                         value: approver.name\r\n//                     }));\r\n//                     frm.set_df_property('send_to', 'options', options);\r\n//                     frm.refresh_field('send_to');\r\n//                 } else {\r\n//                     console.log(\"No GM Approvers found\");\r\n//                 }\r\n//             }\r\n//         });\r\n//     },\r\n\r\n//     // Fetch data from Bond Facility when name1 changes\r\n//     name1: function(frm) {\r\n//         if (frm.doc.name1) {\r\n//             console.log(\"Selected Buyer:\", frm.doc.name1);\r\n\r\n//             frappe.call({\r\n//                 method: 'frappe.client.get_value',\r\n//                 args: {\r\n//                     doctype: 'Bond Facility',\r\n//                     filters: { client_name: frm.doc.name1 },\r\n//                     fieldname: ['facility_no', 'client_name', 'workflow_state']\r\n//                 },\r\n//                 callback: function(r) {\r\n//                     if (r.message) {\r\n//                         console.log(\"Fetched Bond Facility:\", r.message);\r\n//                         frm.set_value('bond_facility_no', r.message.facility_no || '');\r\n//                         frm.set_value('quotation_status', r.message.workflow_state || '');\r\n//                     } else {\r\n//                         frappe.msgprint(__('No Bond Facility found for the selected client.'));\r\n//                         frm.set_value('bond_facility_no', '');\r\n//                         frm.set_value('quotation_status', '');\r\n//                     }\r\n//                 }\r\n//             });\r\n//         } else {\r\n//             frappe.msgprint(__('Please select a client name.'));\r\n//         }\r\n//     },\r\n\r\n//     // Calculation logic for limits\r\n//     c1: function(frm) {\r\n//         let val = frm.doc.c1;\r\n//         frm.set_value('bond_facility_limit2', val > 0 ? val + 1 : 0);\r\n//     },\r\n//     c2: function(frm) {\r\n//         let val = frm.doc.c2;\r\n//         frm.set_value('bond_facility_limit3', val > 0 ? val + 1 : 0);\r\n//     },\r\n//     c3: function(frm) {\r\n//         let val = frm.doc.c3;\r\n//         frm.set_value('bond_facility_limit4', val > 0 ? val + 1 : 0);\r\n//     },\r\n//     c4: function(frm) {\r\n//         let val = frm.doc.c4;\r\n//         frm.set_value('net_bond_facility', val > 0 ? val + 1 : 0);\r\n//     },\r\n\r\n//     // UI alignment for numeric fields\r\n//     refresh: function(frm) {\r\n//         const rightAlign = [\r\n//             'bond_facility_limit1', 'bond_facility_limit2', 'bond_facility_limit3',\r\n//             'bond_facility_limit4', 'net_bond_facility', 'c1', 'c2', 'c3', 'c4', 'c5',\r\n//             'security_percentage_for_limit_1', 'security_percentage_for_limit_2',\r\n//             'security_percentage_for_limit_3', 'security_percentage_for_limit_4',\r\n//             'security_percentage_for_limit_5', 'guarantee_fee_percentage', 'min_fee_guarantee'\r\n//         ];\r\n//         rightAlign.forEach(field => {\r\n//             if (frm.fields_dict[field]) {\r\n//                 frm.fields_dict[field].$input.css(\"text-align\", \"right\");\r\n//             }\r\n//         });\r\n//     },\r\n\r\n//     // Validation for max_period_year\r\n//     max_period_year: function(frm) {\r\n//         let value = frm.doc.max_period_year;\r\n//         let $field = frm.fields_dict.max_period_year.$wrapper.find('input');\r\n\r\n//         if (value && value.toString().length > 2) {\r\n//             $field.css('border', '2px solid red');\r\n//         } else {\r\n//             $field.css('border', '');\r\n//         }\r\n//     },\r\n\r\n//     // Before save logic\r\n//     before_save: function(frm) {\r\n//         setCreatedDate(frm);\r\n//     }\r\n// });\r\n\r\n// // Define function to set created_date field\r\n// function setCreatedDate(frm) {\r\n//     if (!frm.doc.created_date) {\r\n//         frm.set_value('created_date', frappe.datetime.now_datetime());\r\n//     }\r\n//     frm.set_df_property('created_date', 'read_only', false);\r\n// }\r\n\r\n// // Auto-generate quotation number\r\n// function generateNumber(frm) {\r\n//     if (!frm.doc.quotation_no) {\r\n//         let currentYear = new Date().getFullYear();\r\n//         let prefix = `BQT/${currentYear}/`;\r\n\r\n//         frappe.call({\r\n//             method: 'frappe.client.get_list',\r\n//             args: {\r\n//                 doctype: 'Bond Facility Quotation',\r\n//                 fields: ['quotation_no', 'creation'],\r\n//                 order_by: 'creation desc',\r\n//                 limit: 1\r\n//             },\r\n//             callback: function(r) {\r\n//                 console.log(\"Last Quotation Record:\", r);\r\n\r\n//                 if (r.message && r.message.length > 0 && r.message[0].quotation_no) {\r\n//                     let lastQuotationNo = r.message[0].quotation_no;\r\n//                     let lastNumber = parseInt(lastQuotationNo.split(\"/\").pop());\r\n\r\n//                     if (!isNaN(lastNumber)) {\r\n//                         let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n//                         frm.set_value('quotation_no', prefix + newNumber);\r\n//                     } else {\r\n//                         frm.set_value('quotation_no', prefix + '0001');\r\n//                     }\r\n//                 } else {\r\n//                     frm.set_value('quotation_no', prefix + '0001');\r\n//                 }\r\n//             }\r\n//         });\r\n//     }\r\n// }\r\n\r\n\r\n// \r\n// \r\n\r\n\r\n\r\n// frappe.ui.form.on('Bond Facility Quotation', {\r\n//     onload: function(frm) {\r\n          \r\n//         if (!frm.doc.quotation_no) {\r\n//             generateNumber(frm);\r\n//         }\r\n\r\n//         // Set created_date field as read-only initially when creating a new form\r\n//         if (frm.doc.__islocal) {\r\n//             frm.set_df_property('created_date', 'read_only', true);\r\n//         }\r\n\r\n//         console.log('hello onload');\r\n\r\n//         frm.fields_dict['name1'].get_query = function(doc) {\r\n//             return {\r\n//                 filters: {\r\n//                     \"workflow_state\": \"Approved\"\r\n//                 }\r\n                \r\n//             }\r\n//         }\r\n    \r\n\r\n// // Frappe call to fetch GM Approvers\r\n// frappe.call({\r\n//     method: \"frappe.client.get_list\",\r\n//     args: {\r\n//         doctype: \"User\",\r\n//         filters: {\r\n//             enabled: 1\r\n//         },\r\n//         fields: [\"name\", \"full_name\"]\r\n//     },\r\n//     callback: function(r) {\r\n//         if (r.message) {\r\n//             console.log(\"GM Approvers: \", r.message);\r\n\r\n//             let gm_approvers = r.message;\r\n//             let options = gm_approvers.map(approver => {\r\n//                 return { 'label': approver.full_name, 'value': approver.name };\r\n//             });\r\n\r\n//             console.log(\"Options: \", options);\r\n\r\n//             // Add options to the send_to field\r\n//             frm.set_df_property('send_to', 'options', options);\r\n//             frm.refresh_field('send_to');\r\n//         } else {\r\n//             console.log(\"No GM Approvers found\");\r\n//         }\r\n//     }\r\n// });\r\n\r\n// },\r\n//     error: function(err) {\r\n//         console.log(\"Error: \", err);\r\n//     },\r\n//     // \r\n//     // \r\n// //  name1: function(frm) {\r\n// //         if (frm.doc.name1) {\r\n// //             frappe.call({\r\n// //                 method: 'frappe.client.get_value',\r\n// //                 args: {\r\n// //                     doctype: 'Bond Facility',\r\n// //                     filters: { 'client_name': frm.doc.name1 },\r\n// //                     fieldname: ['facility_no', 'client_name', 'workflow_state']\r\n// //                 },\r\n// //                 callback: function(r) {\r\n// //                     if (r.message && r.message.client_name) {\r\n// //                         frm.set_value('bond_facility_no', r.message.facility_no);\r\n// //                         frm.set_value('quotation_status', r.message.workflow_state);\r\n// //                     }\r\n// //                 }\r\n// //             });\r\n// //         }\r\n// //  },\r\n// //  \r\n// // \r\n//  c1: function(frm) {\r\n//         var c1_value = frm.doc.c1;\r\n\r\n//         if (c1_value > 0) {\r\n//             // Add 1 to the c1 value and store in bond_facility_limit2\r\n//             var bondFacilityLimit = c1_value + 1;\r\n//             frm.set_value('bond_facility_limit2', bondFacilityLimit);\r\n//         } else {\r\n//             // If c1 is 0 or less, store 0 in bond_facility_limit2\r\n//             frm.set_value('bond_facility_limit2', 0);\r\n//         }\r\n//     },\r\n//   c2: function(frm) {\r\n//         var c2_value = frm.doc.c2;  // Correctly fetch the value of c2\r\n\r\n//         if (c2_value > 0) {\r\n//             // Add 1 to the c2 value and store in bond_facility_limit3\r\n//             var bondFacilityLimit1 = c2_value + 1;\r\n//             frm.set_value('bond_facility_limit3', bondFacilityLimit1);\r\n//         } else {\r\n//             // If c2 is 0 or less, store 0 in bond_facility_limit3\r\n//             frm.set_value('bond_facility_limit3', 0);\r\n//         }\r\n//     },\r\n//     c3: function(frm) {\r\n//         var c3_value = frm.doc.c3;  // Correctly fetch the value of c3\r\n\r\n//         if (c3_value > 0) {\r\n//             // Add 1 to the c3 value and store in bond_facility_limit4\r\n//             var bondFacilityLimit2 = c3_value + 1;\r\n//             frm.set_value('bond_facility_limit4', bondFacilityLimit2);\r\n//         } else {\r\n//             // If c3 is 0 or less, store 0 in bond_facility_limit4\r\n//             frm.set_value('bond_facility_limit4', 0);\r\n//         }\r\n//     },\r\n//     c4: function(frm) {\r\n//         var c4_value = frm.doc.c4;  // Correctly fetch the value of c4\r\n\r\n//         if (c4_value > 0) {\r\n//             // Add 1 to the c4 value and store in net_bond_facility\r\n//             var bondFacilityLimit3 = c4_value + 1;\r\n//             frm.set_value('net_bond_facility', bondFacilityLimit3);\r\n//         } else {\r\n//             // If c4 is 0 or less, store 0 in net_bond_facility\r\n//             frm.set_value('net_bond_facility', 0);\r\n//         }\r\n//     },\r\n\r\n//     refresh: function(frm) {\r\n//         frm.fields_dict.bond_facility_limit1.$input.css(\"text-align\", \"right\");\r\n//         frm.fields_dict.bond_facility_limit2.$input.css(\"text-align\", \"right\");\r\n//         frm.fields_dict.bond_facility_limit3.$input.css(\"text-align\", \"right\");\r\n//         frm.fields_dict.bond_facility_limit4.$input.css(\"text-align\", \"right\");\r\n//         frm.fields_dict.net_bond_facility.$input.css(\"text-align\", \"right\");\r\n//         frm.fields_dict.c1.$input.css(\"text-align\", \"right\");\r\n//         frm.fields_dict.c2.$input.css(\"text-align\", \"right\");\r\n//         frm.fields_dict.c3.$input.css(\"text-align\", \"right\");\r\n//         frm.fields_dict.c4.$input.css(\"text-align\", \"right\");\r\n//         frm.fields_dict.c5.$input.css(\"text-align\", \"right\");\r\n//         frm.fields_dict.security_percentage_for_limit_1.$input.css(\"text-align\", \"right\");\r\n//         frm.fields_dict.security_percentage_for_limit_2.$input.css(\"text-align\", \"right\");\r\n//         frm.fields_dict.security_percentage_for_limit_3.$input.css(\"text-align\", \"right\");\r\n//         frm.fields_dict.security_percentage_for_limit_4.$input.css(\"text-align\", \"right\");\r\n//         frm.fields_dict.security_percentage_for_limit_5.$input.css(\"text-align\", \"right\");\r\n//         frm.fields_dict.guarantee_fee_percentage.$input.css(\"text-align\", \"right\");\r\n//         frm.fields_dict.min_fee_guarantee.$input.css(\"text-align\", \"right\");\r\n\r\n//         // Basic logging to verify the script runs\r\n//     //     console.log(\"Refresh event triggered\");\r\n\r\n//     //     const fields = [\r\n//     //         'gmapprover_remark', 'quotation_authorized_by', 'section_break_x2nfv',\r\n//     //         'send_to_recommendation', 'column_break_vi09k',\r\n//     //         'send_to', 'column_break_lg95e', 'send_to_recommendation',\r\n//     //         'column_break_pwves', 'include_marketing_as_mail_recipient'\r\n//     //     ];\r\n\r\n//     //     // Ensure the document has a workflow_state before proceeding\r\n//     //     if (!frm.doc.workflow_state) {\r\n//     //         console.log(\"No workflow_state found\");\r\n//     //         return;\r\n//     //     }\r\n\r\n//     //     // Log current workflow state for debugging\r\n//     //     console.log(\"Current workflow state:\", frm.doc.workflow_state);\r\n\r\n//     //     // Show fields based on workflow_state\r\n//     //     if (['Pending', 'Reject', 'Declined', 'Approved'].includes(frm.doc.workflow_state)) {\r\n//     //         console.log(`Showing fields for ${frm.doc.workflow_state} state`);\r\n//     //         fields.forEach(field => {\r\n//     //             frm.toggle_display(field, true);\r\n//     //             console.log(\"Showing field:\", field);\r\n//     //         });\r\n//     //     } else {\r\n//     //         // Hide fields for other states\r\n//     //         console.log(\"Hiding fields for states other than Pending, Reject, Declined, and Approved\");\r\n//     //         fields.forEach(field => {\r\n//     //             frm.toggle_display(field, false);\r\n//     //             console.log(\"Hiding field:\", field);\r\n//     //         });\r\n//     //     }\r\n//     },\r\n\r\n//     max_period_year: function(frm) {\r\n//         let value = frm.doc.max_period_year;\r\n//         let $field = frm.fields_dict.max_period_year.$wrapper.find('input');\r\n\r\n//         if (value && value.toString().length > 2) {\r\n//             $field.css('border', '2px solid red');\r\n//         } else {\r\n//             $field.css('border', ''); // Reset the border if the condition is not met\r\n//         }\r\n//     },\r\n\r\n//     before_save: function(frm) {\r\n//         // Set created_date if it's not already set\r\n//         setCreatedDate(frm);\r\n//     }\r\n \r\n// });\r\n\r\n// // Define a function to set the created_date field\r\n// function setCreatedDate(frm) {\r\n//     if (!frm.doc.created_date) {\r\n//         frm.set_value('created_date', frappe.datetime.now_datetime());\r\n//     }\r\n\r\n//     // Enable the created_date field after saving the record\r\n//     frm.set_df_property('created_date', 'read_only', false);\r\n// }\r\n// // \r\n\r\n// Define generateNumber function outside the frappe.ui.form.on calls\r\n// function generateNumber(frm) {\r\n//     if (!frm.doc.quotation_no) {\r\n//         let currentYear = new Date().getFullYear();\r\n//         let prefix = `BQT/${currentYear}/`;\r\n//         frappe.call({\r\n//             method: 'frappe.client.get_list',\r\n//             args: {\r\n//                 doctype: 'Bond Facility Quotation',\r\n//                 fields: ['quotation_no', 'creation'],\r\n//                 order_by: 'creation desc',\r\n//                 limit: 1\r\n//             },\r\n//             callback: function(r) {\r\n//                 console.log(r, \"quotation no\");\r\n//                 if (r.message && r.message.length > 0) {\r\n//                     let lastQuotationNo = r.message[0].quotation_no;\r\n//                     let lastNumber = parseInt(lastQuotationNo.split(\"/\").pop());\r\n//                     if (!isNaN(lastNumber)) {\r\n//                         let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n//                         frm.set_value('quotation_no', prefix + newNumber);\r\n//                     }\r\n//                 } else {\r\n//                     frm.set_value('quotation_no', prefix + '0001');\r\n//                 }\r\n//             }\r\n//         });\r\n//     }\r\n// }\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Bond Facility Quotation Acceptance",
  "enabled": 1,
  "modified": "2025-12-05 08:33:48.575803",
  "module": null,
  "name": "Bond Facility Quotation Acceptance Script",
  "script": "frappe.ui.form.on('Bond Facility Quotation Acceptance', {\r\n    onload: function (frm) {\r\n        console.log('hello onload')\r\n        //   frm.fields_dict['name1'].get_query = function(doc) {\r\n        //     return {\r\n        //         filters: {\r\n        //           // \"Workflow_state\": \"Approved\",Accepted\r\n                   \r\n        //           \"Workflow_state\": \"Accepted\",\r\n                   \r\n        //         }\r\n        //     };\r\n        // };\r\n        \r\n        // frappe.call({\r\n        //     method: \"frappe.client.get_list\",\r\n        //     args: {\r\n        //         doctype: \"Bond Facility Quotation\",\r\n        //         filters: {\r\n        //             workflow_state: 'Accepted'\r\n        //         },\r\n        //         fields: [\"name1\"],\r\n        //         limit_page_length: 0\r\n        //     },\r\n        //     callback: function(response) {\r\n        //         if (response.message) {\r\n        //             // Extract client names into a list\r\n        //             let clientNames = response.message.map(row => row.name1);\r\n\r\n        //             // Set options in the name1 dropdown field\r\n        //             frm.set_df_property('name1', 'options', [''].concat(clientNames));\r\n        //         }\r\n        //     }\r\n        // });\r\n        \r\n//         frappe.call({\r\n//     method: \"frappe.client.get_list\",\r\n//     args: {\r\n//         doctype: \"Bond Facility Quotation\",\r\n//         filters: {\r\n//             workflow_state: 'Accepted'\r\n//         },\r\n//         fields: [\"name1\"],\r\n//         limit_page_length: 0\r\n//     },\r\n//     callback: function(response) {\r\n//         if (response.message) {\r\n\r\n//             // Extract all names\r\n//             let clientNames = response.message.map(row => row.name1);\r\n\r\n//             // \u2705 Remove duplicate names\r\n//             let uniqueNames = [...new Set(clientNames)];\r\n            \r\n//             uniqueNames.sort();\r\n\r\n//             // Add blank option at top + set dropdown options\r\n//             frm.set_df_property('name1', 'options', [''].concat(uniqueNames));\r\n//         }\r\n//     }\r\n// });\r\n\r\n//Alphabeticla order\r\nfrappe.call({\r\n    method: \"frappe.client.get_list\",\r\n    args: {\r\n        doctype: \"Bond Facility Quotation\",\r\n        filters: {\r\n            workflow_state: 'Accepted'\r\n        },\r\n        fields: [\"name1\"],\r\n        limit_page_length: 0\r\n    },\r\n    callback: function(response) {\r\n        if (response.message) {\r\n\r\n            // Extract names\r\n            let clientNames = response.message.map(r => r.name1);\r\n\r\n            // Remove blank and duplicates\r\n            let uniqueNames = [...new Set(clientNames.filter(n => n && n.trim() !== \"\"))];\r\n\r\n            // Sort alphabetically\r\n            uniqueNames.sort();\r\n\r\n            // Add blank option at top\r\n            let options = [\"\", ...uniqueNames].join(\"\\n\");\r\n\r\n            // Set dropdown options\r\n            frm.set_df_property(\"name1\", \"options\", options);\r\n            frm.refresh_field(\"name1\");\r\n        }\r\n    }\r\n});\r\n\r\n     },\r\n  \r\n\r\n  name1: function (frm) {\r\n    if (!frm.doc.name1) return;\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Bond Facility Quotation',\r\n            filters: {\r\n                name1: frm.doc.name1\r\n            },\r\n            fields: ['quotation_no'],\r\n            limit_page_length: 0\r\n        },\r\n        callback: function (response) {\r\n            if (response.message && response.message.length > 0) {\r\n\r\n                let quotationList = response.message.map(row => row.quotation_no);\r\n\r\n                // Set dropdown options\r\n                frm.set_df_property('quotation_no', 'options', quotationList.join('\\n'));\r\n\r\n                // Clear value if it is not in the list\r\n                if (!quotationList.includes(frm.doc.quotation_no)) {\r\n                    frm.set_value('quotation_no', '');\r\n                }\r\n            }\r\n        }\r\n    });\r\n},\r\n\r\n        quotation_no: function(frm) {\r\n        if (frm.doc.quotation_no) {\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Bond Facility Quotation',\r\n                    filters: {\r\n                        quotation_no: frm.doc.quotation_no\r\n                    },\r\n                    fields: [\r\n                         'bond_facility_no', 'quotation_authorized_by','bond_facility_limit1','bond_facility_limit2','bond_facility_limit3','bond_facility_limit4','net_bond_facility',\r\n                                'security_percentage_for_limit_1','security_percentage_for_limit_2','security_percentage_for_limit_3','security_percentage_for_limit_4','security_percentage_for_limit_5','c1','c2','c3','c4','c5','note1','note2','note3','note4','note5'\r\n                        // 'quotation_no',\r\n                        // 'bond_facility_no',\r\n                        // 'bond_facility_limit1',\r\n                        // 'bond_facility_limit2',\r\n                        // 'bond_facility_limit3',\r\n                        // 'bond_facility_limit4',\r\n                        // 'net_bond_facility',\r\n                        // 'quotation_authorized_by',\r\n                        // 'security_percentage_for_limit_1',\r\n                        // 'security_percentage_for_limit_2',\r\n                        // 'security_percentage_for_limit_3',\r\n                        // 'security_percentage_for_limit_4',\r\n                        // 'security_percentage_for_limit_5'\r\n                    ],\r\n                    limit_page_length: 0\r\n                },\r\n                callback: function(response) {\r\n                    if (response.message && response.message.length > 0) {\r\n                        let details = response.message[0];\r\n                        console.log(\"Fetched details:\", details);\r\n\r\n                        // \u2705 Ensure fieldnames exactly match your DocType fields\r\n                      //frm.set_value('name1', details.name1);\r\n                               // frm.set_value('quotation_no', details.quotation_no);\r\n                                frm.set_value('faciity_no', details.bond_facility_no);\r\n                                frm.set_value('bond_quotation_is_authorized_by', details.quotation_authorized_by);\r\n                                frm.set_value('bond_facility_limit1', details.bond_facility_limit1);\r\n                                frm.set_value('bond_facility_limit2', details.bond_facility_limit2);\r\n                                frm.set_value('bond_facility_limit3', details.bond_facility_limit3);\r\n                                frm.set_value('bond_facility_limit4', details.bond_facility_limit4);\r\n                                frm.set_value('net_facility_amount', details.net_bond_facility);\r\n                                frm.set_value('currency1', details.c1);\r\n                                frm.set_value('currency2', details.c2);\r\n                                frm.set_value('currency3', details.c3);\r\n                                frm.set_value('currency4', details.c4);\r\n                                frm.set_value('currency5', details.c5);\r\n                                frm.set_value('security_percentage_for_limit1', details.security_percentage_for_limit_1);\r\n                                frm.set_value('security_percentage_for_limit2', details.security_percentage_for_limit_2);\r\n                                frm.set_value('security_percentage_for_limit3', details.security_percentage_for_limit_3);\r\n                                frm.set_value('security_percentage_for_limit4', details.security_percentage_for_limit_4);\r\n                                frm.set_value('security_percentage_for_limit5', details.security_percentage_for_limit_5);\r\n                    } else {\r\n                        frappe.msgprint('No matching record found for the selected client.');\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    },\r\n    //   name1(frm) {\r\n    //         let name1 = frm.doc.name1;\r\n    //         if (name1) {\r\n    //           console.log(\"hi\")\r\n                       \r\n    //                     frappe.call({\r\n    //                         method: 'frappe.client.get_list',\r\n    //                         args: {\r\n    //                             doctype: 'Bond Facility Quotation', \r\n    //                             filters: { 'name1': name1 },\r\n    //                             fields: ['name1', 'quotation_no', 'bond_facility_no', 'quotation_authorized_by','bond_facility_limit1','bond_facility_limit2','bond_facility_limit3','bond_facility_limit4','net_bond_facility',\r\n    //                             'security_percentage_for_limit_1','security_percentage_for_limit_2','security_percentage_for_limit_3','security_percentage_for_limit_4','security_percentage_for_limit_5','note1','note2','note3','note4','note5'],\r\n    //                         },\r\n    //                         callback: function(response) {\r\n    //                             console.log(response,\"response\")\r\n    //                             let details = response.message[0];\r\n\r\n    //                             console.log(details,\"hello print all details\")\r\n    //                             frm.set_value('name1', details.name1);\r\n    //                             frm.set_value('quotation_no', details.quotation_no);\r\n    //                             frm.set_value('faciity_no', details.bond_facility_no);\r\n    //                             frm.set_value('bond_quotation_is_authorized_by', details.quotation_authorized_by);\r\n    //                             frm.set_value('bond_facility_limit1', details.bond_facility_limit1);\r\n    //                             frm.set_value('bond_facility_limit2', details.bond_facility_limit2);\r\n    //                             frm.set_value('bond_facility_limit3', details.bond_facility_limit3);\r\n    //                             frm.set_value('bond_facility_limit4', details.bond_facility_limit4);\r\n    //                             frm.set_value('net_facility_amount', details.net_bond_facility);\r\n    //                             // frm.set_value('currency1', details.c1);\r\n    //                             // frm.set_value('currency2', details.c2);\r\n    //                             // frm.set_value('currency3', details.c3);\r\n    //                             // frm.set_value('currency4', details.c4);\r\n    //                             // frm.set_value('currency5', details.c5);\r\n    //                             frm.set_value('security_percentage_for_limit1', details.security_percentage_for_limit_1);\r\n    //                             frm.set_value('security_percentage_for_limit2', details.security_percentage_for_limit_2);\r\n    //                             frm.set_value('security_percentage_for_limit3', details.security_percentage_for_limit_3);\r\n    //                             frm.set_value('security_percentage_for_limit4', details.security_percentage_for_limit_4);\r\n    //                             frm.set_value('security_percentage_for_limit5', details.security_percentage_for_limit_5);\r\n                                \r\n                \r\n    //                         }\r\n    //                     });\r\n    //         }\r\n        \r\n        \r\n    //      frappe.call({\r\n    //         method: \"frappe.client.get_list\",\r\n    //         args: {\r\n    //             doctype: \"User\",\r\n    //             filters: {\r\n    //                 enabled: 1\r\n    //             },\r\n    //             fields: [\"name\", \"full_name\"]\r\n    //         },\r\n    //         callback: function(r) {\r\n    //             if (r.message) {\r\n    //                 console.log(\"GM Approvers: \", r.message);\r\n                    \r\n    //                 let gm_approvers = r.message;\r\n    //                 let options = gm_approvers.map(approver => {\r\n    //                     return {'label': approver.full_name, 'value': approver.name};\r\n    //                 });\r\n\r\n    //                 console.log(\"Options: \", options);\r\n\r\n    //                 // Add options to the send_to field\r\n    //                 frm.set_df_property('send_to', 'options', options);\r\n    //                 frm.refresh_field('send_to');\r\n    //             } else {\r\n    //                 console.log(\"No GM Approvers found\");\r\n    //             }\r\n    //         },\r\n    //         error: function(err) {\r\n    //             console.log(\"Error: \", err);\r\n    //         }\r\n    //     });\r\n    // },\r\n    // currency1: function(frm) {\r\n    //     var currency1_value = frm.doc.currency1;\r\n\r\n    //     if (currency1_value > 0) {\r\n    //         // Add 1 to the c1 value and store in bond_facility_limit2\r\n    //         var bondFacilityLimit = currency1_value + 1;\r\n    //         frm.set_value('bond_facility_limit2', bondFacilityLimit);\r\n    //     } else {\r\n    //         // If c1 is 0 or less, store 0 in bond_facility_limit2\r\n    //         frm.set_value('bond_facility_limit2', 0);\r\n    //     }\r\n    // },\r\n    // currency2: function(frm) {\r\n    //     var currency2_value = frm.doc.currency2;\r\n\r\n    //     if (currency2_value > 0) {\r\n    //         // Add 1 to the c1 value and store in bond_facility_limit2\r\n    //         var bondFacilityLimit1 = currency2_value + 1;\r\n    //         frm.set_value('bond_facility_limit3', bondFacilityLimit1);\r\n    //     } else {\r\n    //         // If c1 is 0 or less, store 0 in bond_facility_limit2\r\n    //         frm.set_value('bond_facility_limit3', 0);\r\n    //     }\r\n    // },\r\n    // currency3: function(frm) {\r\n    //     var currency3_value = frm.doc.currency3;\r\n\r\n    //     if (currency3_value > 0) {\r\n    //         // Add 1 to the c1 value and store in bond_facility_limit2\r\n    //         var bondFacilityLimit2 = currency3_value + 1;\r\n    //         frm.set_value('bond_facility_limit4', bondFacilityLimit2);\r\n    //     } else {\r\n    //         // If c1 is 0 or less, store 0 in bond_facility_limit2\r\n    //         frm.set_value('bond_facility_limit4', 0);\r\n    //     }\r\n    // },\r\n    // currency4: function(frm) {\r\n    //     var currency4_value = frm.doc.currency4;\r\n\r\n    //     if (currency4_value > 0) {\r\n    //         // Add 1 to the c1 value and store in bond_facility_limit2\r\n    //         var bondFacilityLimit3 = currency4_value + 1;\r\n    //         frm.set_value('net_facility_amount', bondFacilityLimit3);\r\n    //     } else {\r\n    //         // If c1 is 0 or less, store 0 in bond_facility_limit2\r\n    //         frm.set_value('net_facility_amount', 0);\r\n    //     }\r\n    // },\r\n    \r\nrefresh: function(frm) {\r\n        frm.fields_dict.bond_facility_limit1.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.bond_facility_limit2.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.bond_facility_limit3.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.bond_facility_limit4.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.net_facility_amount.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.currency1.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.currency2.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.currency3.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.currency4.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.currency5.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.security_percentage_for_limit1.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.security_percentage_for_limit2.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.security_percentage_for_limit3.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.security_percentage_for_limit4.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.security_percentage_for_limit5.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.guarantee_fee_percentage.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.min_fee_guarantee.$input.css(\"text-align\", \"right\");\r\n\r\n    // Basic logging to verify the script runs\r\n    console.log(\"Refresh event triggered\");\r\n    \r\n    \r\n    const fields = [\r\n        'gmapprover_remark', 'quotation_authorized_by', 'section_break_x2nfv',\r\n        'send_to_recommendation', 'column_break_vi09k',\r\n        'send_to', 'column_break_lg95e', 'send_to_recommendation',\r\n        'column_break_pwves', 'include_marketing_as_mail_recipient', \r\n        // 'decline',\r\n        // 'column_break_n6qwn', 'approved', 'column_break_emazr',\r\n        // 'update', 'column_break_teue7', 'cancel'\r\n    ];\r\n\r\n    // Ensure the document has a workflow_state before proceeding\r\n    if (!frm.doc.workflow_state) {\r\n        console.log(\"No workflow_state found\");\r\n        return;\r\n    }\r\n\r\n    // Log current workflow state for debugging\r\n    console.log(\"Current workflow state:\", frm.doc.workflow_state);\r\n\r\n    // Show fields based on workflow_state\r\n    if (['Pending', 'Reject', 'Declined', 'Approved'].includes(frm.doc.workflow_state)) {\r\n        console.log(`Showing fields for ${frm.doc.workflow_state} state`);\r\n        fields.forEach(field => {\r\n            frm.toggle_display(field, true);\r\n            console.log(\"Showing field:\", field);\r\n        });\r\n    } else {\r\n        // Hide fields for other states\r\n        console.log(\"Hiding fields for states other than Pending, Reject, Declined, and Approved\");\r\n        fields.forEach(field => {\r\n            frm.toggle_display(field, false);\r\n            console.log(\"Hiding field:\", field);\r\n        });\r\n    }\r\n        // Set the created_date if it's not already set\r\n        setCreatedDate(frm);\r\n    },\r\n\r\n    // before_save: function(frm) {\r\n    //     // Set created_date if it's not already set\r\n    //     setCreatedDate(frm);\r\n    // }\r\n});\r\n\r\n// Define a function to set the created_date field\r\nfunction setCreatedDate(frm) {\r\n    if (!frm.doc.created_date) {\r\n        frm.set_value('created_date', frappe.datetime.now_datetime());\r\n    }\r\n\r\n}\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Bond Application",
  "enabled": 1,
  "modified": "2025-12-09 11:43:24.908692",
  "module": "UnderWriting",
  "name": "Bond Application",
  "script": "frappe.ui.form.on('Bond Application', {\r\n    refresh: function (frm) {\r\n          frm.fields_dict.add_new.$input.addClass('btn-primary');\r\n            frm.fields_dict.calculate_security.$input.addClass('btn-primary');\r\n              frm.fields_dict.new_insurer.$input.addClass('btn-primary');\r\n               frm.fields_dict.new.$input.addClass('btn-primary');\r\n        frm.set_df_property('table','cannot_add_rows', true);\r\nfrm.fields_dict.exchange_rate.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.amount_in_pula.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.foreign_currency_amount.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.risk_percentage.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.beci_ref_number.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.guarantee_amount.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.total_beci_exposure_onincl_this_gurantee.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.total_in_excess_of_beci_exposure_limit_per_insured.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.excess_insurable_by_reisurer.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.guarantee_fee.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.guarantee_fee_p.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.portion_of_guarantee_guarantee_vat_p.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.reinsurer_portion_of_guarantee_fee_p.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.total_amount_payable_to_beci.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.reinsurer_portion_of_guarantee_amount.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.beci_commission_p.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.reinsurer_commissions.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.other_insurer_commissions.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.total_amount_payable_to_reinsurer.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.reinsurer_refnumber.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.less_beci_exposure_limit_per_insured.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.amount_insurable_by_reinsurer_beci.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.month.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.portion_of_guarantee_to_beci.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.beci_portion_of_gurantee_fee.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.beci_portion_of_gurantee_amount_p.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.beci_commission.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.reinsurer_commission.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.other_insurer_commission.$input.css(\"text-align\", \"right\");\r\n\r\n\r\n        var workflowState = frm.doc.workflow_state;\r\n\r\n        if (frm.doc.workflow_state === \"Approved\") {\r\n\r\n            frm.add_custom_button('Prepare Invoice', function() {\r\n\r\n                // First check if invoice exists\r\n                frappe.call({\r\n                    method: \"frappe.client.get_list\",\r\n                    args: {\r\n                        doctype: \"Bond Invoice\",\r\n                        filters: { bond_no: frm.doc.bond_no },\r\n                        fields: [\"name\"],\r\n                        limit_page_length: 1\r\n                    },\r\n                    callback: function (r) {\r\n\r\n                        // 1\ufe0f\u20e3 If invoice exists \u2192 open it\r\n                        if (r.message && r.message.length > 0) {\r\n                            frappe.set_route(\"Form\", \"Bond Invoice\", r.message[0].name);\r\n                            return;\r\n                        }\r\n\r\n                        // 2\ufe0f\u20e3 Else create new and pass bond_no\r\n                        frappe.route_options = {\r\n                            bond_no: frm.doc.bond_no\r\n                        };\r\n\r\n                        frappe.new_doc(\"Bond Invoice\");\r\n                    }\r\n                });\r\n\r\n            }).addClass(\"btn-primary\");\r\n        }\r\n   \r\n\r\n        \r\n            frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Bond Facility',\r\n                filters: {\r\n                    workflow_state: \"Submitted\"\r\n                },\r\n                fields: ['client_name'],\r\n                limit_page_length: 0\r\n            },\r\n            callback: function(response) {\r\n                console.log(\"client_name received:\", response);\r\n                let DataArray = []\r\n                DataArray = response.message;\r\n                let FinalArray = [];\r\n\r\n                for (let x of DataArray) {\r\n                    console.log(x.client_name)\r\n                    FinalArray.push(x.client_name)\r\n\r\n                }\r\n                \r\n                FinalArray.sort();\r\n                frm.set_df_property('facility_name', 'options', FinalArray);\r\n                console.log(\"final\", FinalArray)\r\n\r\n            },\r\n            error: function(xhr, textStatus, errorThrown) {\r\n                console.error(\"Error fetching approved bonds:\", textStatus, errorThrown);\r\n            }\r\n        });\r\n        \r\n        \r\n},\r\n\r\n\r\n    onload: function (frm) {\r\n        \r\n        \r\n        // frappe.call({\r\n        //     method: 'frappe.client.get_list',\r\n        //     args: {\r\n        //         doctype: 'Bond Facility',\r\n        //         filters: {\r\n        //             workflow_state: \"Submitted\"\r\n        //         },\r\n        //         fields: ['client_name'],\r\n        //         limit_page_length: 1000\r\n        //     },\r\n        //     callback: function(response) {\r\n        //         console.log(\"client_name received:\", response);\r\n        //         let DataArray = []\r\n        //         DataArray = response.message;\r\n        //         let FinalArray = [];\r\n\r\n        //         for (let x of DataArray) {\r\n        //             console.log(x.client_name)\r\n        //             FinalArray.push(x.client_name)\r\n\r\n        //         }\r\n        //         frm.set_df_property('facility_name', 'options', FinalArray);\r\n        //         console.log(\"final\", FinalArray)\r\n\r\n        //     },\r\n        //     error: function(xhr, textStatus, errorThrown) {\r\n        //         console.error(\"Error fetching approved bonds:\", textStatus, errorThrown);\r\n        //     }\r\n        // });\r\n       \r\n        if (!frm.doc.bond_no) {\r\n            generateNumber(frm);\r\n        }\r\n        \r\n   \r\n        \r\n    frappe.call({\r\n      method: 'frappe.client.get_list',\r\n      args: {\r\n          doctype: 'VAT',\r\n          fields: ['vat'],\r\n      },\r\n    callback: function (response) {\r\n        console.log(response, \"client short name\");\r\n        if (!response.exc) {\r\n            var data = response.message;\r\n            if (data && data.length > 0) {\r\n                frm.set_value('vat', data[0].vat);\r\n            } else {\r\n                console.error(\"VAT document not found for the given filter.\");\r\n            }\r\n        } else {\r\n            console.error(\"Error occurred:\", response.exc);\r\n        }\r\n    }\r\n});\r\n\r\n\r\n\r\n        \r\n\r\n    },\r\n    \r\n\r\n\r\n    facility_name: function(frm) {\r\n        \r\n//         frappe.call({\r\n//          method: 'frappe.client.get',\r\n//          args: {\r\n//             doctype: 'Bond Facility Quotation Acceptance',\r\n//             filters: {\r\n//                 name1: frm.doc.facility_name\r\n            \r\n//              },\r\n//           fields: ['net_facility_amount','name1']\r\n//         },\r\n//       callback: function (r) {\r\n//                 console.log(r, \"client details_Bomd\");\r\n\r\n//                 if (!r.exc) {\r\n//                     if (r.message) {\r\n//                         frm.set_value('total_facility_amt', r.message.net_facility_amount);\r\n//                 // frm.refresh();\r\n//             }\r\n//         } else {\r\n//             console.error(\"Error occurred:\", r.exc);\r\n//         }\r\n//     }\r\n// });\r\n// old code\r\n//         frappe.call({\r\n//         method: 'frappe.client.get',\r\n//          args: {\r\n//             doctype: 'Security',\r\n//             filters: {\r\n//                 name1: frm.doc.facility_name,\r\n//              },\r\n//           fields: ['net_security','facilityamount','client']\r\n//         },\r\n//       callback: function (r) {\r\n//                 console.log(r, \"client details\");\r\n \r\n//                 if (!r.exc) {\r\n//                     if (r.message) {\r\n//                         frm.set_value('total_security_amt', r.message.net_security);\r\n//                         frm.set_value('total_facility_amt', r.message.facilityamount);\r\n//                 // frm.refresh();\r\n//             }\r\n//         } else {\r\n//           // console.error(\"Error occurred:\", r.exc);\r\n//           frappe.msgprint(\"No Security records have facility_name\");\r\n//         }\r\n//     }\r\n// });\r\n\r\n// New code\r\n\r\nfrappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Security',\r\n        filters: {\r\n            name1: frm.doc.facility_name\r\n        },\r\n        fields: ['name', 'net_security', 'facilityamount'],\r\n        limit: 1\r\n    },\r\n    callback: function(r) {\r\n        console.log(\"\ud83d\udd0d Security record response:\", r);\r\n\r\n        if (r.message && r.message.length > 0) {\r\n            const record = r.message[0];\r\n            frm.set_value('total_security_amt', record.net_security);\r\n            frm.set_value('total_facility_amt', record.facilityamount);\r\n        } else {\r\n            // \u2705 Show a popup dialog (modal)\r\n            frappe.msgprint({\r\n               \r\n                message: __(`No Security record found for Facility Name <b>${frm.doc.facility_name}</b>.`),\r\n                \r\n              \r\n            });\r\n\r\n            // Optionally clear values if nothing found\r\n            frm.set_value('total_security_amt', '');\r\n            frm.set_value('total_facility_amt', '');\r\n        }\r\n    }\r\n});\r\n\r\n\r\n\r\n //-----------facility names filtering\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Bond Facility',\r\n                filters: {\r\n                    client_name: frm.doc.facility_name\r\n                },\r\n                fields: ['facility_no', 'status1','reg_no','estd_date','broker']\r\n            },\r\n            callback: function(response) {\r\n                console.log(\"Bond Facility response:\", response);\r\n                if (response.message && response.message.length > 0) {\r\n                    var data_from_proposals = response.message[0];\r\n \r\n                    // Populate fields if data is found\r\n                    frm.set_value('status', data_from_proposals.status1 || '');\r\n                    frm.set_value('facility_no', data_from_proposals.facility_no || '');\r\n                    frm.set_value('reg_no', data_from_proposals.reg_no || '');\r\n                    frm.set_value('reg_date', data_from_proposals.estd_date || '');\r\n                     frm.set_value('broker', data_from_proposals.broker || '');\r\n                } else {\r\n                    // Clear fields if no matching record found\r\n                    frm.set_value('status', '');\r\n                    frm.set_value('facility_no', '');\r\n                    frm.set_value('reg_no', '');\r\n                    frm.set_value('reg_date', '');\r\n                    frm.set_value('broker', '');\r\n                    \r\n                    frappe.msgprint('No matching record found in Bond Facility.');\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error(err);\r\n                //frappe.msgprint('An error occurred while fetching data from DCI Proposals. Please check the console for details.');\r\n            }\r\n        });\r\n        \r\n        \r\n        var facilityName = frm.doc.facility_name;\r\n\r\n        // Check if facility name is empty\r\n        if (facilityName) {\r\n            // Make API call to fetch data only if facility name is entered\r\n            fetchBondInFavourData(frm, facilityName);\r\n        } else {\r\n            // Clear table if facility name is empty\r\n            frm.clear_table('table');\r\n        }\r\n    \r\n \r\n\r\n   \r\n\r\n\r\n    },\r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    vat: function(frm){\r\n        calculatetotalbeci_Amount(frm);\r\n    },\r\n    \r\n    \r\n//     exchange_rate: function(frm){\r\n//         calculatetotal_Amount(frm);\r\n    \r\n// },\r\n\r\n//     foreign_currency_amount: function(frm){\r\n//     calculatetotal_Amount(frm);\r\n// },\r\n\r\n\r\n //Calculate balanced facility Amount\r\n \r\n    // balanced_facilty_amt: function(frm){\r\n        \r\n    //     calculatefacilityamt(frm);\r\n    // },\r\n    \r\n    // balanced_security_amt:function(frm){\r\n    \r\n    //     calculatesecurityamt(frm);\r\n    // },\r\n    \r\n//     utilized_facilty_amt:function(frm){\r\n//         // calculatetotal_bond_value(frm);\r\n//         calculatefacilityamt(frm);\r\n        \r\n//         // calculateUtilizedfacilityAmount(frm);\r\n        \r\n    \r\n// },\r\n     \r\n    // utilized_security_amt:function(frm){\r\n    //     calculatetotal_security_value(frm);\r\n    //     calculatesecurityamt(frm);\r\n    // },\r\n    \r\n    // amount_in_pula: function(frm){\r\n    //     // calculatetotal_bond_value(frm);\r\n    // },\r\n    \r\n    period_from:function(frm){\r\n        var periodfrom = frm.doc.period_from;\r\n        frm.set_value('premium_charged_for_period_of',periodfrom);\r\n        \r\n    },\r\n    \r\n    to:function(frm){\r\n        var to = frm.doc.to;\r\n        frm.set_value('to_',to);\r\n        \r\n    },\r\n    \r\n      amount_in_pula:function(frm){\r\n        var amount_in_pula = frm.doc.amount_in_pula;\r\n        frm.set_value('guarantee_amount',amount_in_pula);\r\n        \r\n    },\r\n\r\n    add_new: function (frm) {\r\n        frappe.new_doc('Company-Details');\r\n    },\r\n    \r\n    new_insurer:function(frm){\r\n       frappe.new_doc('Company-Details'); \r\n    },\r\n    \r\n    new:function(frm){\r\n         frappe.new_doc('Company-Details');\r\n    },\r\n    \r\n    calculate_security:function(frm){\r\n        frappe.new_doc('Security Calculation');\r\n          frappe.route_options = {\r\n               currency_code: frm.doc.amount_in_pula,\r\n                    facility_no: frm.doc.facility_no,\r\n                    bond_no: frm.doc.bond_no,\r\n                   \r\n                }\r\n    },\r\n\r\n \r\n    bond_type: function(frm) {\r\n    var bondType = frm.doc.bond_type;\r\n\r\n    frm.set_df_property('bond_subtype', 'options', ['Select']);\r\n\r\n    if (bondType === 'CONSTRUCTION BOND') {\r\n        frm.set_df_property('bond_subtype', 'options', [\r\n            'Performance Bond',\r\n            'Advance Payment Bond',\r\n            'Tender Bond',\r\n            'Retention Bond',\r\n            'Payment Guarantee',\r\n            'Payment Bond'\r\n        ]);\r\n        msgprint(\"Please select Bond sub type.\");\r\n    } else if (bondType === 'CUSTOMS BONDS') {\r\n        frm.set_df_property('bond_subtype', 'options', [\r\n            'Vat Deferral',\r\n            'Temporary Importation',\r\n            'Bonded Warehouse',\r\n            'Clearing Agent'\r\n        ]);\r\n        msgprint(\"Please select Bond sub type.\");\r\n    }\r\n},\r\n  \r\n    bond_no: function(frm) {\r\n        frm.set_value('beci_ref_number', frm.doc.bond_no);\r\n    },\r\n//     currency_code: function(frm) {\r\n//     var currencyCode = frm.doc.currency_code;\r\n\r\n//     // Regular expression to match any string of alphabets\r\n//     var currencyRegex = /^[A-Za-z]+$/;\r\n\r\n//     if (!currencyRegex.test(currencyCode)) {\r\n//         frappe.msgprint(__(\"Please enter a valid currency code (Pula,USD).\"));\r\n//         frm.set_value('currency_code', '');\r\n//     }\r\n    \r\n    \r\n    \r\n    \r\n    \r\n// },\r\nrefer_to_reinsurer:  function(frm) {\r\n        frm.set_value('reinsurer', frm.doc.refer_to_reinsurer);\r\n    },\r\n\r\n    //Calculation of Months\r\n    premium_charged_for_period_of: function(frm) {\r\n        calculateMonths(frm);\r\n    },\r\n    \r\n    to_: function(frm) {\r\n        calculateMonths(frm);\r\n    },\r\n    \r\n    \r\n  //Calculation of Gaurantee fee and ReinsurePortion og Gurantee amount\r\n   month: function(frm) {\r\n        calculateTotal(frm);\r\n    },\r\n    guarantee_fee: function(frm) {\r\n        calculateTotal(frm);\r\n    },\r\n    \r\n    guarantee_amount: function(frm) {\r\n        calculateTotal(frm);\r\n        calculateReinsurePortionofguaranteeamount(frm);\r\n        calculateBCIPortionofGuranteeAmount(frm);\r\n        // calculatetotalbeci_Amount(frm);\r\n        \r\n    },\r\n     \r\n \r\n //Calculation of Portion of Gurantee to BECI % and Reinsure Portion of Guarantee Fee and ReinsurePortion og Gurantee amount\r\n  portion_of_guarantee_guarantee_vat_p: function(frm) {\r\n        calculatePortionOfGurantee(frm);\r\n        calculateReinsureportionofGurantee(frm);\r\n        calculateReinsurePortionofguaranteeamount(frm);\r\n        \r\n    },\r\n \r\n //Calculation of BECI Portion of Guarantee Fee and Reinsure Portion of Guarantee Fee\r\n guarantee_fee_p: function(frm) {\r\n        calculateBECIportionofGurantee(frm);\r\n        calculateReinsureportionofGurantee(frm);\r\n        calculateOtherInsureCommission(frm);\r\n         calculatetotalbeci_Amount(frm);\r\n    },\r\n portion_of_guarantee_to_beci: function(frm) {\r\n        calculateBECIportionofGurantee(frm);\r\n        calculateBCIPortionofGuranteeAmount(frm);\r\n    },\r\n\r\n//Calculation of Reinsure Commission\r\n beci_portion_of_gurantee_fee: function(frm) {\r\n        calculateReinsureCommission(frm);\r\n    },\r\n reinsurer_commissions: function(frm) {\r\n        calculateReinsureCommission(frm);\r\n    },\r\n\r\n//Calculation of BECI Commission\r\nreinsurer_portion_of_guarantee_fee_p: function(frm) {\r\n        calculateBCICommission(frm);\r\n        calculateTotalAmountPayableToReinsure(frm) ;\r\n    },\r\n    \r\n beci_commission_p: function(frm) {\r\n        calculateBCICommission(frm);\r\n        calculateTotalAmountPayableToReinsure(frm) \r\n    },\r\n    \r\n//Calculate Other insure Commission\r\nother_insurer_commissions: function(frm) {\r\n        calculateOtherInsureCommission(frm);\r\n       \r\n    },\r\n    \r\n\r\n  \r\n});\r\nfrappe.ui.form.on('Bond Invoice', {\r\n    refresh(frm) {\r\n\r\n        if (!frm.doc.bond_no) return;\r\n\r\n       frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Bond Application',\r\n                filters: {\r\n                    bond_no: frm.doc.bond_no\r\n                },\r\n                fields: ['bond_no','broker','facility_name','bond_type','period_from','bond_subtype','month','reinsurer','beci_commission_p','reinsurer_commission','reinsurer_commissions','other_insurer_commission','other_insurer_commissions','beci_commission','to','bond_in_favour','demand_date','guarantee_amount','beci_portion_of_gurantee_fee','reinsurer_refnumber','reinsurer_portion_of_guarantee_fee_p','portion_of_guarantee_guarantee_vat_p','portion_of_guarantee_to_beci','guarantee_fee','vat']\r\n            },\r\n            callback: function(r) {\r\n                if (!r.exc && r.message && r.message.length > 0) {\r\n                    var bondApp = r.message[0];\r\n                    frm.set_value('facility_name', bondApp.facility_name); \r\n                    frm.set_value('bond_invoice_no', bondApp.bond_no); \r\n                    frm.set_value('bond_type', bondApp.bond_type);\r\n                    frm.set_value('period_from', bondApp.period_from);\r\n                    frm.set_value('bond_subtype', bondApp.bond_subtype);\r\n                    frm.set_value('month', bondApp.month);\r\n                    frm.set_value('reinsurer', bondApp.reinsurer); \r\n                    frm.set_value('beci_commission_p', bondApp.beci_commission_p);\r\n                    frm.set_value('reinsurer_commissions', bondApp.reinsurer_commissions);\r\n                    frm.set_value('other_insurer_commissions', bondApp.other_insurer_commissions);\r\n                    frm.set_value('beci_commission', bondApp.beci_commission);\r\n                    frm.set_value('to', bondApp.to); \r\n                    frm.set_value('bond_in_favour', bondApp.bond_in_favour);\r\n                    frm.set_value('demand_date', bondApp.demand_date);\r\n                    frm.set_value('guarantee_amount', bondApp.guarantee_amount);\r\n                    frm.set_value('beci_portion_of_gurantee_amount_p', bondApp.beci_portion_of_gurantee_fee);\r\n                    frm.set_value('reinsurer_refnumber', bondApp.bond_no);\r\n                    frm.set_value('reinsurer1', bondApp.portion_of_guarantee_guarantee_vat_p);\r\n                    frm.set_value('premium_p', bondApp.beci_portion_of_gurantee_fee); \r\n                    frm.set_value('beci', bondApp.portion_of_guarantee_to_beci);\r\n                    frm.set_value('premium_rate', bondApp.guarantee_fee);\r\n                    frm.set_value('vat', bondApp.vat);\r\n                    frm.set_value('reinsurer_commission', bondApp.reinsurer_commission);\r\n                    frm.set_value('portion_of_guarantee_guarantee_vat_p', bondApp.reinsurer_portion_of_guarantee_fee_p);\r\n                    frm.set_value('other_insurer_commission', bondApp.other_insurer_commission);\r\n                    frm.set_value('total_due_without_vat', bondApp.beci_portion_of_gurantee_fee);\r\n                    frm.set_value('broker1', bondApp.broker);\r\n                     var total_vat = bondApp.beci_portion_of_gurantee_fee || 0;\r\n                      var vat = bondApp.vat || 0;\r\n\r\n                      var total = total_vat * (vat / 100);\r\n\r\n                     frm.set_value('vat_p', Number(total).toFixed(2));\r\n\r\n                   \r\n                } else {\r\n                    console.error(\"Error occurred:\", r.exc);\r\n                }\r\n            }\r\n\r\n    })\r\n    },\r\n\r\n    total_due_without_vat(frm) {\r\n        calculateTotal_due(frm);\r\n    },\r\n\r\n    vat_p(frm) {\r\n        calculateTotal_due(frm);\r\n    },\r\n\r\n    guarantee_amount(frm) {\r\n        calculateBroker(frm);\r\n    },\r\n\r\n    broker(frm) {\r\n        calculateBroker(frm);\r\n    }\r\n});\r\n\r\n\r\n\r\n\r\n\r\n        \r\n// // Function to calculate  Utilized facility Amount\r\nfunction calculatetotalutilizedfacilityamount(frm) {\r\n var childTableData = frm.doc.table || [];\r\n    var totalBondValueApproved = 0;\r\n\r\n    // Calculate Total Bond Value for Approved records\r\n    for (var i = 0; i < childTableData.length; i++) {\r\n        if (childTableData[i].status === 'Approved') {\r\n            totalBondValueApproved += parseFloat(childTableData[i].amount_in_pula) || 0;\r\n        }\r\n    }\r\n    \r\n    // Update Utilized Facility Amount field in the form\r\n     frm.set_value('utilized_facilty_amt', totalBondValueApproved);\r\n    \r\n}\r\n\r\nfunction calculateBalancedFacilityAmount(frm) {\r\n    var childTableData = frm.doc.table || [];\r\n    var totalBondValueApproved = 0;\r\n\r\n    // Calculate Total Bond Value for Approved records\r\n    for (var i = 0; i < childTableData.length; i++) {\r\n        if (childTableData[i].status === 'Approved') {\r\n            totalBondValueApproved += parseFloat(childTableData[i].amount_in_pula) || 0;\r\n        }\r\n    }\r\n\r\n    var totalFacilityAmt = frm.doc.total_facility_amt || 0;\r\n\r\n    // Calculate the balanced facility amount\r\n    var balancedFacilityAmt = totalFacilityAmt - totalBondValueApproved;\r\n\r\n    // Update the balanced_facilty_amt field in the form\r\n    frm.set_value('balanced_facilty_amt', balancedFacilityAmt);\r\n}\r\n\r\n\r\n\r\n// // Function to calculate Utilized Security Amount\r\nfunction calculatetotalutilizedsecurityamount(frm) {\r\n    var childTableData = frm.doc.table || [];\r\n    var totalBondValueApproved = 0;\r\n\r\n    // Calculate Total Bond Value for Approved records\r\n    for (var i = 0; i < childTableData.length; i++) {\r\n        if (childTableData[i].status === 'Approved') {\r\n            totalBondValueApproved += parseFloat(childTableData[i].security_required) || 0;\r\n        }\r\n    }\r\n\r\n     console.log(totalBondValueApproved,\"toooooooo\")\r\n    // Update Utilized Security Amount field in the form\r\n    frm.set_value('utilized_security_amt', totalBondValueApproved);\r\n}\r\n\r\nfunction calculatebalancedsecurityamt(frm) {\r\n    var childTableData = frm.doc.table || [];\r\n    var totalBondValueApproved = 0;\r\n\r\n    // Calculate Total Security Amount for Approved records\r\n    for (var i = 0; i < childTableData.length; i++) {\r\n        if (childTableData[i].status === 'Approved') {\r\n            totalBondValueApproved += parseFloat(childTableData[i].security_required) || 0;\r\n        }\r\n    }\r\n    \r\n    var totalSecurityAmount = frm.doc.total_security_amt || 0;\r\n    \r\n    // Perform Calculation here\r\n    var balancedSecurityAmt = totalSecurityAmount - totalBondValueApproved;\r\n\r\n    console.log(balancedSecurityAmt, 'balanced_security_amt');\r\n    \r\n    // Update the balanced_security_amt field in the form\r\n    frm.set_value('balanced_security_amt', balancedSecurityAmt);\r\n}\r\n\r\n\r\n\r\n\r\nfunction calculateOtherInsureCommission(frm) {\r\n    var field1_value = frm.doc.guarantee_fee_p;\r\n    var field2_value = frm.doc.other_insurer_commissions;\r\n  \r\n      // Perform your calculation here\r\n    var total =field1_value *(field2_value/100)\r\n\r\n    frm.set_value('other_insurer_commission', total);\r\n      \r\n }\r\n\r\nfunction calculateTotalAmountPayableToReinsure(frm) {\r\n    var field1_value = frm.doc.reinsurer_portion_of_guarantee_fee_p;\r\n    var field2_value = frm.doc.beci_commission_p;\r\n  \r\n      // Perform your calculation here\r\n    var total = field1_value - field2_value\r\n\r\n    frm.set_value('total_amount_payable_to_reinsurer', total);\r\n      \r\n }\r\n\r\nfunction calculateBCICommission(frm) {\r\n    var field1_value = frm.doc.reinsurer_portion_of_guarantee_fee_p;\r\n    var field2_value = frm.doc.beci_commission_p;\r\n  \r\n      // Perform your calculation here\r\n    var total = field1_value * (field2_value/100)\r\n\r\n    frm.set_value('beci_commission', total);\r\n      \r\n }\r\n\r\nfunction calculateBCIPortionofGuranteeAmount(frm) {\r\n    var field1_value = frm.doc.guarantee_amount;\r\n    var field2_value = frm.doc.portion_of_guarantee_to_beci;\r\n  \r\n      // Perform your calculation here\r\n    var total = field1_value * (field2_value/100)\r\n\r\n    frm.set_value('beci_portion_of_gurantee_amount_p', total);\r\n      \r\n }\r\n\r\n\r\nfunction calculateReinsurePortionofguaranteeamount(frm) {\r\n    var field1_value = frm.doc.guarantee_amount;\r\n    console.log(field1_value); // Access the value from frm.doc\r\n\r\n    var field2_value = frm.doc.portion_of_guarantee_guarantee_vat_p;\r\n    console.log(field2_value); // Access the value from frm.doc\r\n\r\n    // Perform your calculation here\r\n    var total = field1_value * (field2_value / 100);\r\n    console.log(total, \"insurecommission\");\r\n\r\n    frm.set_value('reinsurer_portion_of_guarantee_amount', total);\r\n}\r\n\r\n\r\nfunction calculateReinsureCommission(frm) {\r\n    var field1_value = frm.doc.beci_portion_of_gurantee_fee;\r\n    var field2_value = frm.doc.reinsurer_commissions;\r\n  \r\n      // Perform your calculation here\r\n    var total = field1_value * (field2_value/100)\r\n\r\n    frm.set_value('reinsurer_commission', total);\r\n      \r\n }\r\n\r\n\r\nfunction calculateReinsureportionofGurantee(frm) {\r\n    var field1_value = frm.doc.guarantee_fee_p;\r\n    var field2_value = frm.doc.portion_of_guarantee_guarantee_vat_p;\r\n  \r\n      // Perform your calculation here\r\n    var total = field1_value*(field2_value/100)\r\n\r\n    frm.set_value('reinsurer_portion_of_guarantee_fee_p', total);\r\n      \r\n }\r\n\r\n\r\nfunction calculateBECIportionofGurantee(frm) {\r\n    var field1_value = frm.doc.guarantee_fee_p;\r\n    var field2_value = frm.doc.portion_of_guarantee_to_beci;\r\n  \r\n      // Perform your calculation here\r\n    var total = field1_value * (field2_value/100)\r\n\r\n    frm.set_value('beci_portion_of_gurantee_fee', total);\r\n      \r\n }\r\n\r\n\r\nfunction calculatePortionOfGurantee(frm) {\r\n    var field1_value = frm.doc.portion_of_guarantee_guarantee_vat_p;\r\n  \r\n      // Perform your calculation here\r\n    var total = 100-field1_value;\r\n\r\n    frm.set_value('portion_of_guarantee_to_beci', total);\r\n      \r\n }\r\n\r\n\r\nfunction calculateMonths(frm) {\r\n    console.log('calculateMonths function called');\r\n    var from_date = frm.doc.premium_charged_for_period_of;\r\n    var to_date = frm.doc.to_;\r\n\r\n    console.log('from_date:', from_date);\r\n    console.log('to_date:', to_date);\r\n\r\n    if (from_date && to_date) {\r\n        var from_date_obj = frappe.datetime.str_to_obj(from_date);\r\n        var to_date_obj = frappe.datetime.str_to_obj(to_date);\r\n\r\n        var monthsDiff = (to_date_obj.getFullYear() - from_date_obj.getFullYear()) * 12;\r\n        monthsDiff -= from_date_obj.getMonth();\r\n        monthsDiff += to_date_obj.getMonth();\r\n        \r\n        console.log('Months difference:', monthsDiff);\r\n        frm.set_value('month', monthsDiff);\r\n    } else {\r\n        console.log('One or both dates are empty');\r\n        frm.set_value('month', '');\r\n    }\r\n}\r\n\r\n\r\n function calculateTotal(frm) {\r\n    var field1_value = frm.doc.month;\r\n    var field2_value = frm.doc.guarantee_fee;\r\n    var field3_value = frm.doc.guarantee_amount;\r\n    \r\n    // Perform your calculation here\r\n    var total = (field1_value / 12) * (field2_value / 100) * field3_value;\r\n\r\n    frm.set_value('guarantee_fee_p', total);\r\n      \r\n }\r\n\r\n\r\n// Function to update fields\r\nfunction updateFields(frm) {\r\n    var periodFromField = frm.fields_dict['period_from'];\r\n    var toField = frm.fields_dict['to'];\r\n    var amountInPulaField = frm.fields_dict['amount_in_pula'];\r\n    \r\n\r\n    var periodFromValue = periodFromField.get_value();\r\n    var toValue = toField.get_value();\r\n    var amountInPulaValue = amountInPulaField.get_value();\r\n    \r\n\r\n    frm.set_value('premium_charged_for_period_of', periodFromValue);\r\n    frm.set_value('to_', toValue);\r\n    frm.set_value('guarantee_amount', amountInPulaValue);\r\n}\r\n\r\n\r\n\r\n// //Generate bond number\r\n// function generateNumber(frm) {\r\n//     if (!frm.doc.bond_no) {\r\n//         let currentYear = new Date().getFullYear();\r\n//         let prefix = `BND/${currentYear}/`;\r\n\r\n//         frappe.call({\r\n//             method: 'frappe.client.get_list',\r\n//             args: {\r\n//                 doctype: 'Bond Application',\r\n//                 fields: ['bond_no', 'creation'],\r\n//                 order_by: 'creation desc',\r\n//                 limit: 1\r\n//             },\r\n//             callback: function (r) {\r\n//                 if (r.message && r.message.length > 0) {\r\n//                     let lastBondNo = r.message[0].bond_no;\r\n//                     let lastNumber = parseInt(lastBondNo.split(\"/\").pop()) || 0;\r\n//                     let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n//                     frm.set_value('bond_no', prefix + newNumber);\r\n//                 } else {\r\n//                     frm.set_value('bond_no', prefix + '0001');\r\n//                 }\r\n//             }\r\n//         });\r\n//     }\r\n// }\r\n\r\nfunction generateNumber(frm) {\r\n    // Check if the bond number field is already populated\r\n    if (!frm.doc.bond_no) {\r\n        // Get the current year\r\n        let currentYear = new Date().getFullYear();\r\n        let prefix = `BND/${currentYear}/`;\r\n\r\n        // Make a call to get the last bond number asynchronously\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Bond Application',\r\n                fields: ['bond_no'],\r\n                limit: 1,\r\n                order_by: 'creation desc'\r\n            },\r\n            callback: function(response) {\r\n                console.log(response, \"bond no\");\r\n                let lastBondNo = response.message && response.message.length > 0 ? response.message[0].bond_no : '0';\r\n                let lastNumber = parseInt(lastBondNo.split(\"/\").pop()); // Extract last part and parse it as integer\r\n\r\n                // Make a call to get the last deputy sheriff bond number asynchronously\r\n                frappe.call({\r\n                    method: 'frappe.client.get_list',\r\n                    args: {\r\n                        doctype: 'Deputy Sheriff Bond',\r\n                        fields: ['bond_no'],\r\n                        limit: 1,\r\n                        order_by: 'creation desc'\r\n                    },\r\n                    callback: function(response) {\r\n                        console.log(response, \"deputy sheriff bond no\");\r\n                        let lastDeputySheriffBondNo = response.message && response.message.length > 0 ? response.message[0].bond_no : '0';\r\n                        let lastDeputySheriffBondNumber = parseInt(lastDeputySheriffBondNo.split(\"/\").pop());\r\n\r\n                        // Get the maximum of the two last bond numbers\r\n                        let maxLastNumber = Math.max(lastNumber, lastDeputySheriffBondNumber);\r\n\r\n                        if (!isNaN(maxLastNumber)) {\r\n                            // Increment the last number and pad it with leading zeros\r\n                            let newNumber = (maxLastNumber + 1).toString().padStart(4, '0');\r\n                            frm.set_value('bond_no', prefix + newNumber);\r\n                        } else {\r\n                            // If no previous numbers exist, set to default '0001'\r\n                            frm.set_value('bond_no', prefix + '0001');\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\n\r\n\r\n\r\n// function calculatefacilityamt(frm){\r\n//     var field_value1 = frm.doc.total_facility_amt;\r\n//     var field_value2 = frm.doc.utilized_facilty_amt;\r\n//     console.log(field_value1,'field_value1')\r\n//     //Perform Calculation here\r\n//     var total = field_value1 - field_value2;\r\n//     console.log(total,'total_facility_amt')\r\n//     frm.set_value('balanced_facilty_amt', total);\r\n// }\r\n\r\n\r\n\r\n// function calculatesecurityamt(frm){\r\n//     var field_value3 = frm.doc.total_security_amt;\r\n//     var field_value4 = frm.doc.utilized_security_amt;\r\n//     console.log(field_value3,'field_value3')\r\n//     //Perform Calculation here\r\n//     var total = field_value3 - field_value4;\r\n//     console.log(total,'total_facility_amt')\r\n//     frm.set_value('balanced_security_amt', total);\r\n// }\r\n\r\n\r\n// function calculatetotal_bond_value(frm){\r\n//     var childTableData = frm.doc.table || [];\r\n\r\n//     // Calculate Total Bond Value\r\n//     var totalBondValue = childTableData.reduce(function(amount_in_pula, row) {\r\n//         // Convert row.amount_in_pula to a number using parseFloat or parseInt\r\n//         var rowBondValue = parseFloat(row.amount_in_pula) || 0; // Convert to float; default to 0 if NaN\r\n\r\n//         // Accumulate bond values for each row\r\n//         return amount_in_pula + rowBondValue;\r\n//     }, 0);\r\n\r\n//     // Update Total Bond Value field in the form\r\n//     frm.set_value('utilized_facilty_amt', totalBondValue);\r\n// }\r\n\r\n\r\n\r\n// function calculatetotal_security_value(frm){\r\n// var childTableData = frm.doc.table || [];\r\n\r\n//     // Calculate Total Bond Value\r\n//     var totalSecurityValue = childTableData.reduce(function(security_required, row) {\r\n//         // Convert row.amount_in_pula to a number using parseFloat or parseInt\r\n//         var rowSecurityValue = parseFloat(row.security_required) || 0; // Convert to float; default to 0 if NaN\r\n\r\n//         // Accumulate bond values for each row\r\n//         return security_required + rowSecurityValue;\r\n//     }, 0);\r\n\r\n//     // Update Total Bond Value field in the form\r\n//     frm.set_value('utilized_security_amt', totalSecurityValue);\r\n    \r\n// }\r\n\r\n\r\n\r\n// function calculatetotal_Amount(frm){\r\n//     var field1_value = frm.doc.exchange_rate;\r\n//     var field2_value = frm.doc.foreign_currency_amount;\r\n    \r\n    \r\n//     // Perform your calculation here\r\n//     var total = (field1_value * field2_value);\r\n\r\n//     frm.set_value('amount_in_pula', total);\r\n//     frm.set_value('guarantee_amount', total);\r\n      \r\n// }\r\n \r\n \r\n function calculatetotalbeci_Amount(frm){\r\n    var vat_value = frm.doc.vat;\r\n    var guarantee_fee_p = frm.doc.guarantee_fee_p;\r\n    \r\n    \r\n    // Perform your calculation here\r\n    var total = guarantee_fee_p + (guarantee_fee_p * (vat_value / 100));\r\n\r\n    frm.set_value('total_amount_payable_to_beci', total);\r\n      \r\n }\r\n\r\n\r\n//Fetch the data in to child table\r\nfunction fetchBondInFavourData(frm, facilityName) {\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Bond Application',\r\n            filters: {\r\n                facility_name: facilityName\r\n            },\r\n            fields: ['name', 'workflow_state', 'bond_no', 'bond_in_favour', 'period_from', 'to', 'amount_in_pula', 'security_required','workflow_state'],\r\n            limit: 2,\r\n        },\r\n        callback: function(r) {\r\n            if (!r.exc) {\r\n                var data = r.message;\r\n\r\n                frm.clear_table('table');\r\n\r\n                for (let x of data) {\r\n                    var child = frappe.model.add_child(frm.doc, \"Previous Bond Details\", \"table\");\r\n\r\n                    frappe.model.set_value(child.doctype, child.name, \"bond_no\", x.bond_no);\r\n                    frappe.model.set_value(child.doctype, child.name, \"bond_in_favour\", x.bond_in_favour);\r\n                    frappe.model.set_value(child.doctype, child.name, \"period_from\", x.period_from);\r\n                    frappe.model.set_value(child.doctype, child.name, \"to\", x.to);\r\n                    frappe.model.set_value(child.doctype, child.name, \"amount_in_pula\", x.amount_in_pula);\r\n                    frappe.model.set_value(child.doctype, child.name, \"security_required\", x.security_required);\r\n                    frappe.model.set_value(child.doctype, child.name, \"status\", x.workflow_state); // Set workflow state\r\n                }\r\n                frm.refresh_fields('table');\r\n                // calculatetotal_security_value(frm)\r\n                \r\n                 calculatetotalutilizedfacilityamount(frm);\r\n    \r\n     calculatetotalutilizedsecurityamount(frm);\r\n     \r\n     calculateBalancedFacilityAmount(frm);\r\n       \r\n     calculatebalancedsecurityamt(frm);\r\n        \r\n                \r\n            } else {\r\n                console.error(r.exc);\r\n            }\r\n        }\r\n    });\r\n    \r\n  \r\n    \r\n}\r\n\r\n\r\nfunction calculateTotal_due(frm) {\r\n    var total_vat = Number(frm.doc.total_due_without_vat) || 0;\r\n    var vat_p = Number(frm.doc.vat_p) || 0;\r\n\r\n    var total = total_vat + vat_p;\r\n\r\n    frm.set_value('total_due', total);\r\n}\r\n\r\nfunction calculateBroker(frm) {\r\n    var guarantee_amount = frm.doc.guarantee_amount || 0;\r\n    var brokerPercent = frm.doc.broker || 0;\r\n\r\n    // Calculate broker commission\r\n    var brokerCommission = (guarantee_amount * brokerPercent / 100);\r\n\r\n    // Set the value of broker_commission__p field\r\n    frm.set_value('broker_commission__p', brokerCommission);\r\n}\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "ECI Proposal",
  "enabled": 1,
  "modified": "2025-12-08 07:38:54.964312",
  "module": "Marketing",
  "name": "ECI Proposal",
  "script": "// =====================================================\r\n// GLOBAL CUSTOM SCRIPT - ECI Proposal & Related Doctypes\r\n// =====================================================\r\n\r\nfrappe.ui.form.on('ECI Proposal', {\r\n    // -----------------------\r\n    // VALIDATION\r\n    // -----------------------\r\n    validate(frm) {\r\n        const fieldsToValidate = [\r\n            'proposal_application',\r\n            'financial_statements__age_analysis',\r\n            'current_debtor_schedule'\r\n        ];\r\n        const allowedExtensions = ['xlsx', 'xls', 'pdf'];\r\n\r\n        fieldsToValidate.forEach(fieldname => {\r\n            const file = frm.doc[fieldname];\r\n            if (file) {\r\n                const fileExtension = file.split('.').pop();\r\n                if (!allowedExtensions.includes((fileExtension || '').toLowerCase())) {\r\n                    frappe.msgprint(__(\"Please upload a file with extension .xlsx, .xls, or .pdf\"));\r\n                    frm.set_value(fieldname, '');\r\n                }\r\n            }\r\n        });\r\n    },\r\n\r\n    // -----------------------\r\n    // REFRESH\r\n    // -----------------------\r\n     refresh(frm) {\r\n\r\n        // ----------------------------------------------------------\r\n        // 1\ufe0f\u20e3 SHOW DYNAMIC CHECKBOXES\r\n        // ----------------------------------------------------------\r\n        show_dynamic_country_checkboxes(frm);\r\n\r\n        // ----------------------------------------------------------\r\n        // 2\ufe0f\u20e3 FILTER CLIENT NAME (ONLY ACTIVE)\r\n        // ----------------------------------------------------------\r\n        if (frm.fields_dict.client_name) {\r\n            frm.fields_dict.client_name.get_query = function () {\r\n                return {\r\n                    filters: { status: \"Active\" }\r\n                };\r\n            };\r\n        }\r\n\r\n        // ----------------------------------------------------------\r\n        // 3\ufe0f\u20e3 DISABLE MANUAL ROW ADDING IN CHILD TABLES\r\n        // ----------------------------------------------------------\r\n        frm.set_df_property('directors_shareholders_table', 'cannot_add_rows', true);\r\n        frm.set_df_property('export_turnover', 'cannot_add_rows', true);\r\n        frm.set_df_property('principal_buyer', 'cannot_add_rows', true);\r\n        frm.set_df_property('baddebts', 'cannot_add_rows', true);\r\n\r\n        // ----------------------------------------------------------\r\n        // 4\ufe0f\u20e3 STYLE \"ADD NEW\" BUTTONS SAFELY\r\n        // ----------------------------------------------------------\r\n        try {\r\n            frm.fields_dict.directors_shareholder_add_new?.$input?.addClass(\"btn-primary\");\r\n            frm.fields_dict.export_turnover_add_new?.$input?.addClass(\"btn-primary\");\r\n            frm.fields_dict.principal_buyer_add_new?.$input?.addClass(\"btn-primary\");\r\n            frm.fields_dict.baddebts_add_new?.$input?.addClass(\"btn-primary\");\r\n        } catch (e) {\r\n            console.log(\"Button styling issue:\", e);\r\n        }\r\n\r\n        // ----------------------------------------------------------\r\n        // WORKFLOW CHECK\r\n        // ----------------------------------------------------------\r\n        const workflow = frm.doc.workflow_state;\r\n\r\n\r\n\r\n        // ==========================================================\r\n        // 5\ufe0f\u20e3 PRINT PROPOSAL BUTTON (When Submitted)\r\n        // ==========================================================\r\n        if (workflow === \"Submitted\") {\r\n\r\n            frm.add_custom_button(__('Print Proposals'), async function () {\r\n\r\n                // \ud83d\udd0d CHECK IF DOCUMENT ALREADY EXISTS\r\n                let existing = await frappe.call({\r\n                    method: \"frappe.client.get_list\",\r\n                    args: {\r\n                        doctype: \"Print Proposal ECI\",\r\n                        filters: { ae_no: frm.doc.proposal_no },\r\n                        fields: [\"name\"]\r\n                    }\r\n                });\r\n\r\n                if (existing.message && existing.message.length > 0) {\r\n                    // OPEN EXISTING DOCUMENT\r\n                    frappe.set_route(\"Form\", \"Print Proposal ECI\", existing.message[0].name);\r\n                    return;\r\n                }\r\n\r\n                // CREATE NEW DOCUMENT\r\n                frappe.route_options = {\r\n                    name1: frm.doc.client_name,\r\n                    date_established: frm.doc.establishment_date,\r\n                    ae_no: frm.doc.proposal_no\r\n                };\r\n\r\n                frappe.new_doc(\"Print Proposal ECI\");\r\n            }).addClass(\"btn-primary\");\r\n        }\r\n\r\n\r\n\r\n        // ==========================================================\r\n        // 6\ufe0f\u20e3 REJECTION LETTER BUTTON (When Declined)\r\n        // ==========================================================\r\n        if (workflow === \"Declined\") {\r\n\r\n            frm.add_custom_button(__('Rejection Letter'), async function () {\r\n\r\n                // \ud83d\udd0d CHECK IF ALREADY EXISTS\r\n                let existing = await frappe.call({\r\n                    method: \"frappe.client.get_list\",\r\n                    args: {\r\n                        doctype: \"ECI Rejection Letter\",\r\n                        filters: { proposal_no: frm.doc.proposal_no },\r\n                        fields: [\"name\"]\r\n                    }\r\n                });\r\n\r\n                if (existing.message && existing.message.length > 0) {\r\n                    // OPEN EXISTING DOCUMENT\r\n                    frappe.set_route(\"Form\", \"ECI Rejection Letter\", existing.message[0].name);\r\n                    return;\r\n                }\r\n\r\n                // CREATE NEW DOCUMENT\r\n                frappe.route_options = {\r\n                    client: frm.doc.client_name,\r\n                    to: frm.doc.signed_by,\r\n                    proposal_no: frm.doc.proposal_no,\r\n                    regisration_no: frm.doc.registration_no,\r\n                    date: frm.doc.captured_on,\r\n                    information: frm.doc.remarks\r\n                };\r\n\r\n                frappe.new_doc(\"ECI Rejection Letter\");\r\n            }).addClass(\"btn-primary\");\r\n        }\r\n\r\n    },\r\n\r\n    \r\n    // refresh(frm) {\r\n    //     // Dynamic checkboxes for Export Turnover countries\r\n    //     show_dynamic_country_checkboxes(frm);\r\n\r\n    //     // Filter client_name link field\r\n    //     if (frm.fields_dict.client_name) {\r\n    //         frm.fields_dict.client_name.get_query = function () {\r\n    //             return {\r\n    //                 filters: {\r\n    //                     status: \"Active\"\r\n    //                 }\r\n    //             };\r\n    //         };\r\n    //     }\r\n\r\n    //     // Prevent manual row addition on child tables\r\n    //     frm.set_df_property('directors_shareholders_table', 'cannot_add_rows', true);\r\n    //     frm.set_df_property('export_turnover', 'cannot_add_rows', true);\r\n    //     frm.set_df_property('principal_buyer', 'cannot_add_rows', true);\r\n    //     frm.set_df_property('baddebts', 'cannot_add_rows', true);\r\n\r\n    //     // Style \"Add New\" buttons (if they exist)\r\n    //     try {\r\n    //         frm.fields_dict.directors_shareholder_add_new?.$input?.addClass('btn-primary');\r\n    //         frm.fields_dict.export_turnover_add_new?.$input?.addClass('btn-primary');\r\n    //         frm.fields_dict.principalbuyer_add_new?.$input?.addClass('btn-primary');\r\n    //         frm.fields_dict.baddebts_addnew?.$input?.addClass('btn-primary');\r\n    //     } catch (e) {\r\n    //         console.log('Button styling issue:', e);\r\n    //     }\r\n\r\n    //     const workflow = frm.doc.workflow_state;\r\n\r\n    //     // -----------------------\r\n    //     // Print Proposal Button (when Submitted)\r\n    //     // -----------------------\r\n    //     if (workflow === \"Submitted\") {\r\n    //         frm.add_custom_button(__('Print Proposals'), function () {\r\n    //             frappe.route_options = {\r\n    //                 name1: frm.doc.client_name,\r\n    //                 date_established: frm.doc.establishment_date,\r\n    //                 ae_no: frm.doc.proposal_no\r\n    //             };\r\n    //             frappe.new_doc('Print Proposal ECI');\r\n    //         }).addClass(\"btn-primary\");\r\n    //     }\r\n\r\n    //     // -----------------------\r\n    //     // Rejection Letter Button (when Declined)\r\n    //     // -----------------------\r\n    //     if (workflow === \"Declined\") {\r\n    //         frm.add_custom_button(__('Rejection Letter'), function () {\r\n    //             frappe.route_options = {\r\n    //                 client: frm.doc.client_name,\r\n    //                 to: frm.doc.signed_by,\r\n    //                 proposal_no: frm.doc.proposal_no,\r\n    //                 regisration_no: frm.doc.registration_no,\r\n    //                 date: frm.doc.captured_on,\r\n    //                 information: frm.doc.remarks\r\n    //             };\r\n    //             frappe.new_doc('ECI Rejection Letter');\r\n    //         }).addClass(\"btn-primary\");\r\n    //     }\r\n    // },\r\n\r\n    // -----------------------\r\n    // ONLOAD\r\n    // -----------------------\r\n    onload(frm) {\r\n        if (!frm.doc.proposal_no) {\r\n            generateNumber(frm);\r\n        }\r\n    },\r\n\r\n    // -----------------------\r\n    // CLIENT NAME CHANGE\r\n    // -----------------------\r\n    client_name(frm) {\r\n        if (frm.doc.client_name) {\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'DCI Proposals',\r\n                    filters: { client_name: frm.doc.client_name },\r\n                    fields: ['registrationno', 'establishmentdate'],\r\n                    limit_page_length: 1\r\n                },\r\n                callback(r) {\r\n                    if (r.message && r.message.length > 0) {\r\n                        const dci = r.message[0];\r\n                        frm.set_value('registration_no', dci.registrationno);\r\n                        frm.set_value('establishment_date', dci.establishmentdate);\r\n                    } else {\r\n                        // Clear fields if not found\r\n                        frm.set_value('registration_no', '');\r\n                        frm.set_value('establishment_date', '');\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    },\r\n\r\n    // -----------------------\r\n    // DIRECTORS / SHAREHOLDERS ADD NEW\r\n    // -----------------------\r\n    directors_shareholder_add_new(frm) {\r\n        // Adjust contact_no padding\r\n        const style = document.createElement('style');\r\n        style.innerHTML = `\r\n            .frappe-control[data-fieldname=\"contact_no\"] .form-control {\r\n                padding-top: 1px;\r\n                box-sizing: border-box;\r\n            }\r\n        `;\r\n        document.head.appendChild(style);\r\n\r\n        frappe.prompt([\r\n            {\r\n                fieldname: 'id_type',\r\n                fieldtype: 'Select',\r\n                options: '\\nDRIVING LICENSE\\nREAD ID NUMBER\\nPASSPORT',\r\n                label: 'ID Type',\r\n                reqd: 1\r\n            },\r\n            { fieldname: 'id_number', fieldtype: 'Data', label: 'ID No', reqd: 1 },\r\n            { fieldname: 'surname', fieldtype: 'Data', label: 'Surname', reqd: 1 },\r\n            { fieldname: 'first_name', fieldtype: 'Data', label: 'First Name', reqd: 1 },\r\n            { fieldname: 'middle_name', fieldtype: 'Data', label: 'Middle Name' },\r\n            { fieldname: '', fieldtype: 'Column Break' },\r\n            { fieldname: 'e_mail_address', fieldtype: 'Data', label: 'Email Address' },\r\n            { fieldname: 'fax', fieldtype: 'Data', label: 'Fax' },\r\n            { fieldname: 'contact_no', fieldtype: 'Phone', label: 'Contact No', reqd: 1 },\r\n            {\r\n                fieldname: 'designation',\r\n                fieldtype: 'Select',\r\n                options: '\\nDIRECTOR\\nMEMBER\\nMANAGER\\nOTHERS\\nPARTNERS\\nPROPRIETOR',\r\n                label: 'Designation',\r\n                reqd: 1\r\n            }\r\n        ], function (values) {\r\n            const director_name = `${values.first_name || ''} ${values.middle_name || ''} ${values.surname || ''}`.trim();\r\n\r\n            const data = {\r\n                id_type: values.id_type,\r\n                id_number: values.id_number,\r\n                director_name: director_name,\r\n                surname: values.surname,\r\n                first_name: values.first_name,\r\n                middle_name: values.middle_name,\r\n                e_mail_address: values.e_mail_address,\r\n                fax: values.fax,\r\n                contact_no: values.contact_no,\r\n                designation: values.designation\r\n            };\r\n\r\n            localStorage.setItem('directors_shareholders_table', JSON.stringify(data));\r\n\r\n            const Directors_Shareholders_table = JSON.parse(localStorage.getItem('directors_shareholders_table'));\r\n            addDataToChildTable(frm, Directors_Shareholders_table);\r\n        }, 'Directors/ShareHolders');\r\n    },\r\n\r\n    // -----------------------\r\n    // SIGNED ON DATE VALIDATION\r\n    // -----------------------\r\n    signed_on(frm) {\r\n        const signed_on = frm.doc.signed_on;\r\n        const establishment_date = frm.doc.establishment_date;\r\n\r\n        if (signed_on && establishment_date) {\r\n            const signedOnDate = new Date(signed_on);\r\n            const establishmentDate = new Date(establishment_date);\r\n\r\n            if (signedOnDate <= establishmentDate) {\r\n                frappe.msgprint(__('Signed On date must be greater than Establishment Date'));\r\n                frm.set_value('signed_on', '');\r\n            }\r\n        }\r\n    },\r\n\r\n    // -----------------------\r\n    // EXPORT TURNOVER - ADD NEW\r\n    // -----------------------\r\n    export_turnover_add_new(frm) {\r\n        frappe.prompt([\r\n            { fieldname: 'buyer_type', fieldtype: 'Heading', label: 'Type of Buyer' },\r\n            { fieldname: '', fieldtype: 'Section Break' },\r\n            { fieldname: 'associate_companies', fieldtype: 'Check', label: 'ASSOCIATED COMPANIES' },\r\n            { fieldname: '', fieldtype: 'Column Break' },\r\n            { fieldname: 'government_buyers', fieldtype: 'Check', label: 'GOVERNMENT BUYERS' },\r\n            { fieldname: '', fieldtype: 'Column Break' },\r\n            { fieldname: 'private_buyers', fieldtype: 'Check', label: 'PRIVATE BUYERS' },\r\n            { fieldname: '', fieldtype: 'Section Break' },\r\n            {\r\n                fieldname: 'country_of_dest',\r\n                fieldtype: 'Link',\r\n                options: 'Country Details',\r\n                label: 'Country',\r\n                reqd: 1\r\n            },\r\n            {\r\n                fieldname: 'currency_invoiced_eg_pularandsusd',\r\n                fieldtype: 'Select',\r\n                options: '\\nNamibian Doller\\nBOTSWANA PULA\\nSouth African Rands\\nUS DOLLAR',\r\n                label: 'Currency',\r\n                reqd: 1\r\n            },\r\n            {\r\n                fieldname: 'total_turnoverlast_year',\r\n                fieldtype: 'Currency',\r\n                label: 'Last Turnover',\r\n                reqd: 1\r\n            },\r\n            {\r\n                fieldname: 'estturnovernext_12_months',\r\n                fieldtype: 'Currency',\r\n                label: 'Estimated Turnover',\r\n                reqd: 1\r\n            },\r\n            { fieldname: '', fieldtype: 'Column Break' },\r\n            {\r\n                fieldname: 'terms_of_payment',\r\n                fieldtype: 'Select',\r\n                options: '\\n1-3m\\n1-3mLC\\n4-6m\\n4-6mLC\\ncad\\ncadlc\\nTT7d',\r\n                label: 'Terms of Payment',\r\n                reqd: 1\r\n            }\r\n        ], function (values) {\r\n            const data = {\r\n                buyer_type:\r\n                    values.associate_companies ? 'Associated Companies' :\r\n                        values.government_buyers ? 'Government Buyers' :\r\n                            values.private_buyers ? 'Private Buyers' : '',\r\n                associate_companies: values.associate_companies,\r\n                government_buyers: values.government_buyers,\r\n                private_buyers: values.private_buyers,\r\n                country_of_dest: values.country_of_dest,\r\n                total_turnoverlast_year: values.total_turnoverlast_year,\r\n                estturnovernext_12_months: values.estturnovernext_12_months,\r\n                currency_invoiced_eg_pularandsusd: values.currency_invoiced_eg_pularandsusd,\r\n                terms_of_payment: values.terms_of_payment\r\n            };\r\n\r\n            export_turnover_addDataToChildTable(frm, data);\r\n            show_dynamic_country_checkboxes(frm);\r\n        }, 'Export TurnOver');\r\n    },\r\n\r\n    // -----------------------\r\n    // PRINCIPAL BUYER - ADD NEW\r\n    // -----------------------\r\n    principalbuyer_add_new(frm) {\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Buyer',\r\n                filters: { eci: 1 },\r\n                fields: [\r\n                    'buyer_name',\r\n                    'country',\r\n                    'associated_companies',\r\n                    'government_buyers',\r\n                    'private_buyers'\r\n                ],\r\n                limit_page_length: 0\r\n            },\r\n            callback(response) {\r\n                const eci_buyers = response.message || [];\r\n                const options = [];\r\n                const buyer_country_map = {};\r\n                const buyer_type = {};\r\n\r\n                eci_buyers.sort((a, b) => (a.buyer_name || '').localeCompare(b.buyer_name || ''));\r\n\r\n                eci_buyers.forEach(buyer => {\r\n                    options.push(buyer.buyer_name);\r\n                    buyer_country_map[buyer.buyer_name] = buyer.country;\r\n\r\n                    const types = [];\r\n                    if (buyer.associated_companies) types.push('Associated Companies');\r\n                    if (buyer.government_buyers) types.push('Government Buyers');\r\n                    if (buyer.private_buyers) types.push('Private Buyers');\r\n                    buyer_type[buyer.buyer_name] = types.join(', ');\r\n                });\r\n\r\n                frappe.prompt([\r\n                    {\r\n                        fieldname: 'buyer_name',\r\n                        fieldtype: 'Select',\r\n                        label: 'Buyer Name',\r\n                        reqd: 1,\r\n                        options: options,\r\n                        onchange: function () {\r\n                            const buyer_name = this.value;\r\n                            cur_dialog.set_value('buyer_country', buyer_country_map[buyer_name] || '');\r\n                            cur_dialog.set_value('buyer_type', buyer_type[buyer_name] || '');\r\n                        }\r\n                    },\r\n                    {\r\n                        fieldname: 'add_buyer',\r\n                        fieldtype: 'Button',\r\n                        label: 'Add New Buyer',\r\n                        click: function () {\r\n                            frappe.new_doc('Buyer');\r\n                        }\r\n                    },\r\n                    { fieldname: 'buyer_type', fieldtype: 'Data', label: 'Buyer Type' },\r\n                    { fieldname: 'buyer_country', fieldtype: 'Data', label: 'Buyer Country' },\r\n                    { fieldname: '', fieldtype: 'Column Break' },\r\n                    {\r\n                        fieldname: 'bank',\r\n                        fieldtype: 'Link',\r\n                        options: 'Banks',\r\n                        label: 'Bank Name',\r\n                        reqd: 1\r\n                    },\r\n                    { fieldname: 'accno', fieldtype: 'Data', label: 'Account No', reqd: 1 },\r\n                    { fieldname: 'branch', fieldtype: 'Data', label: 'Branch' },\r\n                    {\r\n                        fieldname: 'amount_outstanding',\r\n                        fieldtype: 'Currency',\r\n                        label: 'Outstanding Amount',\r\n                        reqd: 1\r\n                    }\r\n                ], function (values) {\r\n                    const data = {\r\n                        buyer_name: values.buyer_name,\r\n                        buyer_country: values.buyer_country,\r\n                        buyer_type: values.buyer_type,\r\n                        bank: values.bank,\r\n                        accno: values.accno,\r\n                        branch: values.branch,\r\n                        amount_outstanding: values.amount_outstanding\r\n                    };\r\n\r\n                    localStorage.setItem('Principal_Buyer_Table', JSON.stringify(data));\r\n                    const Principal_Buyer_Table = JSON.parse(localStorage.getItem('Principal_Buyer_Table'));\r\n                    principle_buyer_addDataToChildTable(frm, Principal_Buyer_Table);\r\n                }, 'Principal Buyer');\r\n            }\r\n        });\r\n    },\r\n\r\n    // -----------------------\r\n    // BAD DEBTS - ADD NEW\r\n    // -----------------------\r\n    baddebts_addnew(frm) {\r\n        frappe.prompt([\r\n            {\r\n                fieldname: 'country',\r\n                fieldtype: 'Link',\r\n                options: 'Country',\r\n                label: 'Country',\r\n                reqd: 1\r\n            },\r\n            { fieldname: '', fieldtype: 'Column Break' },\r\n            { fieldname: 'no_of_cases', fieldtype: 'Data', label: 'No of Cases', reqd: 1 },\r\n            { fieldname: '', fieldtype: 'Section Break' },\r\n            {\r\n                fieldname: 'baddebts_in_last_3years',\r\n                fieldtype: 'Heading',\r\n                label: 'Bad Debts in last 3Years'\r\n            },\r\n            { fieldname: 'year1', fieldtype: 'Currency', label: 'Year1', reqd: 1 },\r\n            { fieldname: 'year2', fieldtype: 'Currency', label: 'Year2', reqd: 1 },\r\n            { fieldname: 'year3', fieldtype: 'Currency', label: 'Year3', reqd: 1 },\r\n            { fieldname: '', fieldtype: 'Column Break' },\r\n            {\r\n                fieldname: 'baddebts_for_subsequent_period_till_date',\r\n                fieldtype: 'Heading',\r\n                label: 'Bad Debts for subsequent Period till Date'\r\n            },\r\n            {\r\n                fieldname: 'actualand_estimated',\r\n                fieldtype: 'Currency',\r\n                label: 'Actual and Estimated',\r\n                reqd: 1\r\n            }\r\n        ], function (values) {\r\n            const data = {\r\n                country: values.country,\r\n                no_of_cases: values.no_of_cases,\r\n                year1: values.year1,\r\n                year2: values.year2,\r\n                year3: values.year3,\r\n                actualand_estimated: values.actualand_estimated\r\n            };\r\n\r\n            localStorage.setItem('BadDebts_Table', JSON.stringify(data));\r\n            const BadDebts_Table = JSON.parse(localStorage.getItem('BadDebts_Table'));\r\n            baddebts_addDataToChildTable(frm, BadDebts_Table);\r\n        }, 'Past Experience');\r\n    }\r\n});\r\n\r\n// =====================================================\r\n// PRINT PROPOSAL ECI - FILL DATA ON REFRESH\r\n// =====================================================\r\nfrappe.ui.form.on('Print Proposal ECI', {\r\n    refresh(frm) {\r\n        // ---------- Company Details ----------\r\n        if (frm.doc.name1) {\r\n            frappe.call({\r\n                method: 'frappe.client.get_value',\r\n                args: {\r\n                    doctype: 'Company-Details',\r\n                    filters: { name1: frm.doc.name1 },\r\n                    fieldname: [\r\n                        'ac_no',\r\n                        'bank',\r\n                        'branch',\r\n                        'fax',\r\n                        'director_1',\r\n                        'is_group_company',\r\n                        'physical_address'\r\n                    ]\r\n                },\r\n                callback(r) {\r\n                    const msg = r.message;\r\n                    if (!msg) return;\r\n\r\n                    // Group / Holding text\r\n                    if (msg.is_group_company == 1) {\r\n                        frm.set_value('holding_or_parent_company', \"Is a Group Company\");\r\n                    } else {\r\n                        frm.set_value('holding_or_parent_company', \"Holding\");\r\n                    }\r\n\r\n                    frm.set_value('physical_address', msg.physical_address);\r\n                    frm.set_value('directorspartners', msg.director_1);\r\n                    frm.set_value('account_no', msg.ac_no);\r\n\r\n                    // Bank + branch combined\r\n                    let combined_address = '';\r\n                    if (msg.bank) combined_address += msg.bank;\r\n                    if (msg.branch) combined_address += (combined_address ? ' , ' : '') + msg.branch;\r\n\r\n                    frm.set_value('bankers_branch', combined_address);\r\n                    frm.refresh_fields(['account_no', 'bank', 'branch', 'fax']);\r\n                }\r\n            });\r\n        }\r\n\r\n        // ---------- ECI Proposal: Export Turnover, Bad Debts, Buyer Types ----------\r\n        if (frm.doc.name1) {\r\n            // First get the ECI Proposal name for this client\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'ECI Proposal',\r\n                    filters: { client_name: frm.doc.name1 },\r\n                    fields: ['name'],\r\n                    limit_page_length: 1\r\n                },\r\n                callback(res) {\r\n                    if (!res.message || !res.message.length) {\r\n                        console.warn(\"No ECI Proposal found for this client.\");\r\n                        return;\r\n                    }\r\n\r\n                    const proposal_name = res.message[0].name;\r\n\r\n                    frappe.call({\r\n                        method: 'frappe.client.get',\r\n                        args: {\r\n                            doctype: 'ECI Proposal',\r\n                            name: proposal_name\r\n                        },\r\n                        callback(r2) {\r\n                            const doc = r2.message;\r\n                            if (!doc) return;\r\n\r\n                            // ---- Export Turnover (child table) ----\r\n                            if (doc.export_turnover && doc.export_turnover.length > 0) {\r\n                                const data = doc.export_turnover;\r\n                                frm.clear_table('exportturnover');\r\n\r\n                                data.forEach(x => {\r\n                                    const child = frappe.model.add_child(frm.doc, \"Print Proposal Eci Child\", \"exportturnover\");\r\n                                    frappe.model.set_value(child.doctype, child.name, \"countries_of_destination\", x.country_of_dest);\r\n                                    frappe.model.set_value(child.doctype, child.name, \"total_turnover_during_preceding_year\", x.total_turnoverlast_year);\r\n                                    frappe.model.set_value(child.doctype, child.name, \"anticipated_total_turnover_for_next_12_months\", x.estturnovernext_12_months);\r\n                                    frappe.model.set_value(child.doctype, child.name, \"currency_contracted_in\", x.currency_invoiced_eg_pularandsusd);\r\n                                    frappe.model.set_value(child.doctype, child.name, \"terms_of_payment_period_of_credit_given_to_buyers_normal\", x.terms_of_payment);\r\n                                    frappe.model.set_value(child.doctype, child.name, \"terms_of_payment_period_of_credit_given_to_buyers_maximum\", x.terms_of_payment);\r\n                                });\r\n\r\n                                frm.refresh_field('exportturnover');\r\n                            }\r\n\r\n                            // ---- Bad Debts / Past Experience table ----\r\n                            if (doc.baddebts && doc.baddebts.length > 0) {\r\n                                const data = doc.baddebts;\r\n                                frm.clear_table(\"pastexperiencetable\");\r\n\r\n                                data.forEach(x => {\r\n                                    const child = frm.add_child(\"pastexperiencetable\");\r\n                                    child.country = x.country;\r\n                                    child.no_of_cases = x.noof_cases;\r\n                                    child.actual_and_estimates = x.estimated;\r\n\r\n                                    const years = [x.year1, x.year2, x.year3].filter(Boolean).join(', ');\r\n                                    child.for_each_of_the_3_last_completed_financial_years_ending = years;\r\n                                });\r\n\r\n                                frm.refresh_field(\"pastexperiencetable\");\r\n                            }\r\n\r\n                            // ---- Business Type & Private Buyers (checkbox summary) ----\r\n                            const business_type_fields = [\"manufacturer\", \"retailer\", \"wholesaler\", \"others\"];\r\n                            const private_buyer_fields = [\"associated_companies\", \"government\", \"private_buyers\"];\r\n        const goods_services_fields = [\r\n                        \"agriculture\",\r\n                        \"airconditioning\",\r\n                        \"aluminium_boats\",\r\n                        \"animal_vaccines\",\r\n                        \"arts_crafts\",\r\n                        \"batteries\",\r\n                        \"building_materials\",\r\n                        \"canning_cans\",\r\n                        \"cellular\",\r\n                        \"cereals\",\r\n                        \"cigarettes\",\r\n                        \"computer_electronic\",\r\n                        \"concrete_products\",\r\n                        \"corporate_clothing\",\r\n                        \"cosmetics\",\r\n                        \"couriers\",\r\n                        \"engraving\",\r\n                        \"fmcg\",\r\n                        \"frozen_chicken\",\r\n                        \"fuel\",\r\n                        \"gas\",\r\n                        \"hair_products\",\r\n                        \"heavy_plant\",\r\n                        \"invoice_factoring\",\r\n                        \"leather_products\",\r\n                        \"logistics\",\r\n                        \"lubricants__fuel\",\r\n                        \"meat_products\",\r\n                        \"media__radio\",\r\n                        \"merchandise\",\r\n                        \"packaging_materials\",\r\n                        \"perishable_goods\",\r\n                        \"pharmaceuticals\",\r\n                        \"plastics_spices\",\r\n                        \"road_construction\",\r\n                        \"salt\",\r\n                        \"security_services\",\r\n                        \"soda_ash\",\r\n                        \"stationary_diaries\",\r\n                        \"steel_doors\",\r\n                        \"steel_merchants\",\r\n                        \"timber_products\",\r\n                        \"travelling_bags\",\r\n                      \"water_supplies\"\r\n                        \r\n                        \r\n                        \r\n                    ];\r\n\r\n                            const business_type_selected = [];\r\n                            const private_buyer_selected = [];\r\n    const goods_services_selected = [];\r\n                            business_type_fields.forEach(field => {\r\n                                if (doc[field] === 1) {\r\n                                    business_type_selected.push(frappe.model.unscrub(field));\r\n                                }\r\n                            });\r\n\r\n                            private_buyer_fields.forEach(field => {\r\n                                if (doc[field] === 1) {\r\n                                    private_buyer_selected.push(frappe.model.unscrub(field));\r\n                                }\r\n                            });\r\n         goods_services_fields.forEach(field => {\r\n                        if (doc[field] === 1) goods_services_selected.push(frappe.model.unscrub(field));\r\n                    });\r\n\r\n                            frm.set_value(\"bussiness_type\", business_type_selected.join(\", \"));\r\n                            frm.set_value(\"private_buyers\", private_buyer_selected.join(\", \"));\r\n                               frm.set_value(\"goods_services\", goods_services_selected.join(\", \"));\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        }\r\n        \r\n    \r\n\r\n        \r\n        \r\n// if (frm.doc.name1) {\r\n// frappe.call({\r\n//     method: \"frappe.client.get\",\r\n//     args: {\r\n//         doctype: \"ECI Proposal\",\r\n//         filters: {\r\n//             client_name: frm.doc.client_name\r\n//         },\r\n//         fields: [\"principal_buyer\"]\r\n//     },\r\n\r\n//     callback: function (r) {\r\n\r\n//         console.log(\"ECI Proposal data:\", r);\r\n\r\n//         // -----------------------------------------------\r\n//         // PRINCIPAL BUYER TABLE UPDATE\r\n//         // -----------------------------------------------\r\n//         if (r.message && r.message.principal_buyer) {\r\n\r\n//             let data2 = r.message.principal_buyer;\r\n\r\n//             // Clear existing table\r\n//             frm.clear_table(\"principal_buyer_table\");\r\n\r\n//             // Add new rows\r\n//             data2.forEach(item => {\r\n//                 let child = frm.add_child(\"principal_buyer_table\");\r\n\r\n//                  child.name_of_buyers = item.buyer_name;\r\n                           \r\n//                             child.bankers = item.bank;\r\n//                             child.country = item.buyer_country;\r\n//                             child.outstanding = item.amount_outstanding;\r\n//                             child.credit_limits_required = item.amount_outstanding;\r\n//             });\r\n\r\n//             // Refresh UI\r\n//             frm.refresh_field(\"principal_buyer_table\");\r\n\r\n//             console.log(\"Principal Buyer table updated:\", data2);\r\n//         }\r\n//     }\r\n// });\r\n\r\n// }\r\nif (frm.doc.name1) {\r\n    // Fetch ECI Proposal data for the selected client\r\n    frappe.call({\r\n        method: \"frappe.client.get\",\r\n        args: {\r\n            doctype: \"ECI Proposal\",\r\n            filters: { client_name: frm.doc.name1 }\r\n        },\r\n        callback: function (r) {\r\n            console.log(\"ECI Proposal Response:\", r);\r\n\r\n            if (!r.exc && r.message && r.message.principal_buyer && r.message.principal_buyer.length > 0) {\r\n                const data = r.message.principal_buyer;\r\n                const proposalNo = r.message.proposal_no || \"\";  // \u2705 Get proposal_no from parent\r\n\r\n                // Clear existing child table rows\r\n                frm.clear_table('principal_buyer_table');\r\n\r\n                data.forEach(x => {\r\n                    const child = frappe.model.add_child(frm.doc, \"principal_buyer_table\", \"principal_buyer_table\");\r\n\r\n                    frappe.model.set_value(child.doctype, child.name, \"name_of_buyers\", x.buyer_name);\r\n                    frappe.model.set_value(child.doctype, child.name, \"bankers\", x.bank);\r\n                    frappe.model.set_value(child.doctype, child.name, \"country\", x.buyer_country);\r\n                    frappe.model.set_value(child.doctype, child.name, \"outstanding\", x.amount_outstanding);\r\n                    frappe.model.set_value(child.doctype, child.name, \"credit_limits_required\", x.amount_outstanding);\r\n\r\n                    // \u2705 Set proposal number into each child row\r\n                    frappe.model.set_value(child.doctype, child.name, \"buyer_ref_numbers\", proposalNo);\r\n\r\n                    console.log(\"Child row added:\", child);\r\n                });\r\n\r\n                // Refresh the child table UI\r\n                frm.refresh_field('principal_buyer_table');\r\n                console.log(\"Principal Buyer table fully updated.\");\r\n            } else {\r\n                console.warn(\"No Principal Buyer data found in ECI Proposal for this client.\");\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n\r\n\r\n\r\n        \r\n\r\n\r\n\r\n\r\n        \r\n    }\r\n});\r\n\r\n// =====================================================\r\n// ECI REJECTION LETTER - FILL ADDRESS ON REFRESH\r\n// =====================================================\r\nfrappe.ui.form.on('ECI Rejection Letter', {\r\n    refresh(frm) {\r\n        if (!frm.doc.client) return;\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_value',\r\n            args: {\r\n                doctype: 'Company-Details',\r\n                filters: { name1: frm.doc.client },\r\n                fieldname: ['name1', 'postal_address', 'location', 'physical_address']\r\n            },\r\n            callback(r) {\r\n                const msg = r.message;\r\n                if (!msg) return;\r\n\r\n                let address = '';\r\n                if (msg.name1) address += msg.name1 + '\\n';\r\n                if (msg.location) address += msg.location + '\\n';\r\n                if (msg.physical_address) address += msg.physical_address + '\\n';\r\n                if (msg.postal_address) address += msg.postal_address + '\\n';\r\n\r\n                address = address.trim();\r\n                frm.set_value('address', address);\r\n            }\r\n        });\r\n    }\r\n});\r\n\r\n// =====================================================\r\n// HELPER FUNCTIONS\r\n// =====================================================\r\n\r\n// Directors & Shareholders child table\r\nfunction addDataToChildTable(frm, data) {\r\n    if (!data) return;\r\n\r\n    const childTable = frm.fields_dict['directors_shareholders_table'].grid;\r\n    const newRow = childTable.add_new_row();\r\n\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'id_type', data.id_type);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'id_number', data.id_number);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'directorname', data.director_name);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'emailaddress', data.e_mail_address);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'fax', data.fax);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'contact_no', data.contact_no);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'designation', data.designation);\r\n\r\n    childTable.refresh();\r\n}\r\n\r\n// Export Turnover child table\r\nfunction export_turnover_addDataToChildTable(frm, data) {\r\n    if (!data) return;\r\n\r\n    const childTable = frm.fields_dict['export_turnover'].grid;\r\n    const newRow = childTable.add_new_row();\r\n\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'buyer_type', data.buyer_type);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'country_of_dest', data.country_of_dest);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'total_turnoverlast_year', data.total_turnoverlast_year);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'estturnovernext_12_months', data.estturnovernext_12_months);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'currency_invoiced_eg_pularandsusd', data.currency_invoiced_eg_pularandsusd);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'terms_of_payment', data.terms_of_payment);\r\n\r\n    childTable.refresh();\r\n}\r\n\r\n// Principal Buyer child table\r\nfunction principle_buyer_addDataToChildTable(frm, data) {\r\n    if (!data) return;\r\n\r\n    const childTable = frm.fields_dict['principal_buyer'].grid;\r\n    const newRow = childTable.add_new_row();\r\n\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'buyer_name', data.buyer_name);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'bank', data.bank);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'buyer_type', data.buyer_type);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'accno', data.accno);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'amount_outstanding', data.amount_outstanding);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'buyer_country', data.buyer_country);\r\n\r\n    childTable.refresh();\r\n}\r\n\r\n// Bad Debts child table\r\nfunction baddebts_addDataToChildTable(frm, data) {\r\n    if (!data) return;\r\n\r\n    const childTable = frm.fields_dict['baddebts'].grid;\r\n    const newRow = childTable.add_new_row();\r\n\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'country', data.country);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'noof_cases', data.no_of_cases);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'year1', data.year1);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'year2', data.year2);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'year3', data.year3);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'estimated', data.actualand_estimated);\r\n\r\n    childTable.refresh();\r\n}\r\n\r\n// Auto-generate Proposal No\r\nfunction generateNumber(frm) {\r\n    if (frm.doc.proposal_no) return;\r\n\r\n    const currentYear = new Date().getFullYear();\r\n    const prefix = `ECI/${currentYear}/`;\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'ECI Proposal',\r\n            fields: ['proposal_no', 'creation'],\r\n            order_by: 'creation desc',\r\n            limit_page_length: 1\r\n        },\r\n        callback(r) {\r\n            if (r.message && r.message.length > 0) {\r\n                const lastProposalNo = r.message[0].proposal_no || '';\r\n                const parts = lastProposalNo.split('/');\r\n                const lastNumber = parseInt(parts[parts.length - 1], 10);\r\n\r\n                if (!isNaN(lastNumber)) {\r\n                    const newNumber = String(lastNumber + 1).padStart(4, '0');\r\n                    frm.set_value('proposal_no', prefix + newNumber);\r\n                    return;\r\n                }\r\n            }\r\n            // First proposal of the year\r\n            frm.set_value('proposal_no', prefix + '0001');\r\n        }\r\n    });\r\n}\r\n\r\n// Dynamic country checkboxes based on Export Turnover table\r\nfunction show_dynamic_country_checkboxes(frm) {\r\n    const field = frm.fields_dict.country_text;\r\n    if (!field || !field.$wrapper) return;\r\n\r\n    const wrapper = field.$wrapper;\r\n\r\n    // Remove old checkboxes\r\n    if (frm.custom_country_controls && frm.custom_country_controls.length) {\r\n        frm.custom_country_controls.forEach(ctrl => ctrl.$wrapper.remove());\r\n    }\r\n    frm.custom_country_controls = [];\r\n\r\n    // Unique country list from export_turnover child table\r\n    const countries_in_table = [\r\n        ...new Set(\r\n            (frm.doc.export_turnover || [])\r\n                .map(row => (row.country_of_dest || '').trim().toLowerCase())\r\n        )\r\n    ].filter(Boolean);\r\n\r\n    countries_in_table.forEach(country => {\r\n        const checkbox = frappe.ui.form.make_control({\r\n            df: {\r\n                fieldtype: 'Check',\r\n                label: frappe.utils.to_title_case(country),\r\n                fieldname: `checkbox_${country.replace(/\\s+/g, '_')}`,\r\n                default: 1\r\n            },\r\n            parent: wrapper,\r\n            render_input: true\r\n        });\r\n        frm.custom_country_controls.push(checkbox);\r\n    });\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Acceptance Advice Letter ECI",
  "enabled": 0,
  "modified": "2024-03-25 10:49:50.313106",
  "module": null,
  "name": "Acceptance Advice letter Script",
  "script": "frappe.ui.form.on('Acceptance Advice letter', {\n refresh: function(frm) {\n        console.log(\"Acceptance letter\");\n\n      \n        var proposalnumber = sessionStorage.getItem('proposalnumber');\n        var Schedulenumber = sessionStorage.getItem('Schedulenumber');\n\n        console.log(proposalnumber, \"retrieved from sessionStorage\");\n\n        if (proposalnumber && Schedulenumber) {\n            \n            frm.set_value('proposal_no', proposalnumber);\n            frm.set_value('policy_no', Schedulenumber);\n            console.log(proposalnumber, \"set to the to field\");\n            \n               frm.toggle_enable('proposal_no', false);\n               frm.toggle_enable('policy_no', false);\n        } else {\n            console.log(\"Not found in sessionStorage\");\n        }\n    }\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Covering Letter ECI",
  "enabled": 1,
  "modified": "2025-11-05 13:42:39.460154",
  "module": null,
  "name": "covering Letter Script",
  "script": "frappe.ui.form.on('cover letter ECI', {\n    refresh(frm) {\n        // Get the value of 'to' field from current form\n        var to_value = frm.doc.to;\n\n        // Fetch matching Company Details record where name1 == to_value\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Company-Details',\n                filters: {\n                    'name1': to_value\n                },\n                fields: ['postal_address'],\n                limit: 1\n            },\n            callback: function(response) {\n                if (response.message && response.message.length > 0) {\n                    frm.set_value('address', response.message[0].postal_address);\n                } else {\n                    frappe.msgprint(\"No matching Company Details found for: \" + to_value);\n                }\n            },\n            error: function(err) {\n                console.error(err);\n                frappe.msgprint('An error occurred while fetching Company Details.');\n            }\n        });\n    }\n});\n\n\n\n// frappe.ui.form.on('covering Letter_ECI', {\n//     refresh(frm) {\n//         // Get the value of name1 field\n//         var name1 = frm.doc.name1;\n \n//         frappe.call({\n//             method: 'frappe.client.get_list',\n//             args: {\n//                 doctype: 'Company-Details',\n//                 filters: {\n//                     'name1': name1,\n//                 },\n//                 fields: ['postal_address'],\n//                 limit: 1 \n//             },\n//             callback: function(response) {\n//                 if (response.message && response.message.length > 0) {\n//                     frm.set_value('address', response.message[0].postal_address);\n//                 } else {\n//                     // Handle case where no matching Company Details document is found\n//                     frappe.msgprint(\"No matching Company Details found for: \" + name1);\n//                 }\n//             },\n//             error: function(err) {\n//                 console.error(err);\n//                 frappe.msgprint('An error occurred while fetching Company Details.');\n//             }\n//         });\n//     }\n// });\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Bond Invoice",
  "enabled": 0,
  "modified": "2025-11-11 07:28:22.035484",
  "module": "Finance",
  "name": "Button_Blue_colour",
  "script": "\r\nfunction InternalPrint(frm) {\r\n    console.log(\"Internal Print button clicked.\");\r\n\r\n    if (frm.doc.bond_application === 1) {\r\n        console.log(frm.doc.bond_application, \"type is selected\");\r\n        frappe.model.with_doctype('Print Internal Invoice', () => {\r\n            let doc = frappe.model.get_new_doc('Print Internal Invoice');\r\n            console.log(frm.doc, \"get all data bond invoice to print \");\r\n            console.log(frm.doc.facility_name)\r\n            doc.client = frm.doc.facility_name;\r\n            doc.bond_no = frm.doc.bond_no;\r\n            doc.period = frm.doc.period_from;\r\n            doc.to = frm.doc.to;\r\n            doc.month = frm.doc.month;\r\n            doc.bond_sub_type = frm.doc.bond_type;\r\n            doc.guarantee_amount = frm.doc.bond_guarantee_amount;\r\n            doc.rate = frm.doc.guarantee_amount;\r\n            doc.premiumpula = frm.doc.premium_rate;\r\n            doc.vat__14_ = frm.doc.vat_p;\r\n            doc.total_due = frm.doc.total_due_without_vat;\r\n            doc.reinsurer_refno = frm.doc.reinsurer_refnumber;\r\n            doc.invoice_no  = frm.doc.bond_no;\r\n\r\n            var premiumRate = parseFloat(frm.doc.premium_rate) || 0;\r\n            var guaranteeFeeRate = parseFloat(frm.doc.guarantee_fee_rate) || 0;\r\n            var bondGuaranteeAmount = parseFloat(frm.doc.bond_guarantee_amount) || 0;\r\n            var Totalamt = premiumRate + guaranteeFeeRate + bondGuaranteeAmount;\r\n            doc.sub_total = Totalamt;\r\n            console.log(doc.sub_total, \"total amount\");\r\n\r\n            doc.renewal_top_buttons = \"1\";\r\n\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Renewals',\r\n                    filters: {\r\n                        bond_holder: frm.doc.client\r\n                    },\r\n                    fields: ['bond_no', 'client', 'principal', 'description', 'bondtype1']\r\n                },\r\n                callback: function(response) {\r\n                    if (response.message && response.message.length > 0) {\r\n                        console.log(response.message, \"response data\");\r\n                        let prepareInvoiceData = response.message[0];\r\n                        console.log(prepareInvoiceData, 'deputy shireff prepare invoice data');\r\n                        doc.description = prepareInvoiceData.description;\r\n                        // doc.bond_sub_type = prepareInvoiceData.bondtype1;\r\n                        // doc.client = prepareInvoiceData.client;\r\n                        // doc.principal = prepareInvoiceData.principal;\r\n                        // doc.description1 = prepareInvoiceData.description;\r\n                        // doc.bond_no = prepareInvoiceData.bond_no;\r\n\r\n                        doc.other_bonds = frm.doc.bond_application;\r\n                    } else {\r\n                        console.log(\"No Deputy Sheriff Prepare Invoice found for the given criteria.\");\r\n                    }\r\n\r\n                    // Save the current document before navigating to the next doctype\r\n                    frappe.call({\r\n                        method: 'frappe.client.insert',\r\n                        args: {\r\n                            doc: doc\r\n                        },\r\n                        callback: function(response) {\r\n                            if (!response.exc) {\r\n                                frappe.set_route('Form', 'Print Internal Invoice', response.message.name);\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        });\r\n    } \r\n    else if (frm.doc.deputy_sheriff === 1) {\r\n        console.log(\"Deputy Sheriff Bond application selected.\");\r\n        frappe.model.with_doctype('Print Internal Invoice', () => {\r\n            let doc = frappe.model.get_new_doc('Print Internal Invoice');\r\n            console.log(doc, \"get all data bond invoice to print \");\r\n            console.log(frm.doc.facility_name)\r\n            doc.client = frm.doc.facility_name;\r\n            doc.bond_no = frm.doc.bond_no;\r\n            doc.period = frm.doc.period_from;\r\n            doc.to = frm.doc.to;\r\n            doc.month = frm.doc.month;\r\n            doc.bond_sub_type = frm.doc.bond_type;\r\n            doc.guarantee_amount = frm.doc.bond_guarantee_amount;\r\n            doc.rate = frm.doc.guarantee_amount;\r\n            doc.premiumpula = frm.doc.premium_rate;\r\n            doc.vat__14_ = frm.doc.vat_p;\r\n            doc.total_due = frm.doc.total_due_without_vat;\r\n            doc.reinsurer_refno = frm.doc.bond_no;\r\n            doc.invoice_no  = frm.doc.bond_no;\r\n\r\n            var premiumRate = parseFloat(frm.doc.premium_rate) || 0;\r\n            var guaranteeFeeRate = parseFloat(frm.doc.guarantee_fee_rate) || 0;\r\n            var bondGuaranteeAmount = parseFloat(frm.doc.bond_guarantee_amount) || 0;\r\n            var subTotal = premiumRate + guaranteeFeeRate + bondGuaranteeAmount;\r\n            doc.sub_total = subTotal;\r\n            console.log(subTotal, \"total amount\");\r\n            doc.renewal_top_buttons = \"1\";\r\n\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Renewals',\r\n                    filters: {\r\n                        bond_holder: frm.doc.client\r\n                    },\r\n                    fields: ['bond_no', 'principal', 'description', 'bondtype1']\r\n                },\r\n                callback: function(response) {\r\n                    if (response.message && response.message.length > 0) {\r\n                        console.log(response.message, \"response data\");\r\n                        let prepareInvoiceData = response.message[0];\r\n                        console.log(prepareInvoiceData, 'deputy shireff prepare invoice data');\r\n                        doc.description = prepareInvoiceData.description;\r\n                        // doc.bond_sub_type = prepareInvoiceData.bondtype1;\r\n                        // doc.client = prepareInvoiceData.client;\r\n                        doc.principal = prepareInvoiceData.principal;\r\n                        doc.description1 = prepareInvoiceData.description;\r\n                        doc.bond_no = prepareInvoiceData.bond_no;\r\n\r\n                        doc.deputy_sheriff = frm.doc.deputy_sheriff;\r\n                    } else {\r\n                        console.log(\"No Deputy Sheriff Prepare Invoice found for the given criteria.\");\r\n                    }\r\n\r\n                    // Save the current document before navigating to the next doctype\r\n                    frappe.call({\r\n                        method: 'frappe.client.insert',\r\n                        args: {\r\n                            doc: doc\r\n                        },\r\n                        callback: function(response) {\r\n                            if (!response.exc) {\r\n                                frappe.set_route('Form', 'Print Internal Invoice', response.message.name);\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        });\r\n    }\r\n}\r\nfunction ExternalPrint(frm) {\r\n    console.log(\"external Print button clicked.\");\r\n\r\n    if (frm.doc.bond_application === 1) {\r\n        console.log(frm.doc.bond_application, \"type is selected\");\r\n        frappe.model.with_doctype('Print External Invoice', () => {\r\n            let doc = frappe.model.get_new_doc('Print External Invoice');\r\n            doc.account  = frm.doc.facility_name;\r\n            doc.invoice_n0 = frm.doc.bond_no;\r\n            doc.amount1 = frm.doc.premium_rate;\r\n            doc.amount2 = frm.doc.premium_p;\r\n            doc.amount3 =frm.doc.vat;\r\n            doc.amount4 = frm.doc.vat_p;\r\n            doc.amount6 = frm.doc.reinsurer1;\r\n            doc.amount9  = frm.doc.broker;\r\n            doc.amount11 = frm.doc.beci;\r\n            doc.amount12 =frm.doc.beci_commission;\r\n            doc.amount15 = frm.doc.total_due\r\n                 \r\n             var premium = parseFloat(frm.doc.premium_p) || 0;\r\n             var vat = parseFloat(frm.doc.vat_p) || 0;\r\n            var Total1 = premium + vat;\r\n            doc.amount5 = Total1;\r\n            console.log(doc.amount5, \"total amount\");\r\n            \r\n          var reinsurer1 = parseFloat(frm.doc.reinsurer1) || 0;\r\n         var broker = parseFloat(frm.doc.broker) || 0;\r\n         var beci_commission = parseFloat(frm.doc.beci) || 0;\r\n         var TotalAmount1 = reinsurer1 + broker + beci_commission;\r\n         doc.amount13 = TotalAmount1;\r\n        console.log(doc.amount13, \"total amount\");\r\n\r\n            doc.renewal_top_buttons = \"1\";\r\n            doc.other_bonds = frm.doc.bond_application;\r\n             frappe.call({\r\n                        method: 'frappe.client.insert',\r\n                        args: {\r\n                            doc: doc\r\n                        },\r\n                        callback: function(response) {\r\n                            if (!response.exc) {\r\n                                frappe.set_route('Form', 'Print External Invoice', response.message.name);\r\n                            }\r\n                        }\r\n                    });\r\n\r\n            \r\n        });\r\n    } else if (frm.doc.deputy_sheriff === 1) {\r\n    console.log(\"Deputy Sheriff Bond application selected.\");\r\n    frappe.model.with_doctype('Print External Invoice', () => {\r\n        let doc = frappe.model.get_new_doc('Print External Invoice');\r\n        doc.amount1 = frm.doc.premium_rate;\r\n        doc.amount2 = frm.doc.premium_p;\r\n        doc.amount3 = frm.doc.vat;\r\n        doc.amount4 = frm.doc.vat_p;\r\n        doc.amount6 = frm.doc.reinsurer1;\r\n        doc.amount9 = frm.doc.broker;\r\n        doc.amount11 = frm.doc.beci;\r\n        doc.amount12 = frm.doc.beci_commission;\r\n        doc.amount15 = frm.doc.total_due;\r\n        doc.account  = frm.doc.sheriff_name;\r\n        doc.invoice_n0 = frm.doc.bond_no;\r\n\r\n        var premium = parseFloat(frm.doc.premium_p) || 0;\r\n        var vat = parseFloat(frm.doc.vat_p) || 0;\r\n       \r\n        var Total = premium + vat;\r\n        doc.amount5 = Total;\r\n        console.log(doc.amount5, \"total amount\");\r\n\r\n        var reinsurer1 = parseFloat(frm.doc.reinsurer1) || 0;\r\n        var broker = parseFloat(frm.doc.broker) || 0;\r\n        var beci_commission = parseFloat(frm.doc.beci) || 0;\r\n        var TotalAmount = reinsurer1 + broker + beci_commission;\r\n        doc.amount13 = TotalAmount;\r\n        console.log(doc.amount13, \"total amount\");\r\n\r\n        doc.renewal_top_buttons = \"1\";\r\n        doc.deputyshierff_bonds = frm.doc.deputy_sheriff;\r\n        \r\n          frappe.call({\r\n                        method: 'frappe.client.insert',\r\n                        args: {\r\n                            doc: doc\r\n                        },\r\n                        callback: function(response) {\r\n                            if (!response.exc) {\r\n                                frappe.set_route('Form', 'Print External Invoice', response.message.name);\r\n                            }\r\n                        }\r\n                    });\r\n\r\n    });\r\n}\r\n\r\n}\r\n\r\nfrappe.ui.form.on('Bond Invoice', {      \r\n    refresh(frm) {\r\n        \r\n        \r\n        \r\n        console.log(\"Form refreshed.\");\r\n        console.log(\"Renewal top buttons value:\", frm.doc.renewal_top_buttons);\r\n\r\n        if (frm.doc.renewal_top_buttons === \"1\") {\r\n            console.log(\"Renewal top buttons enabled.\");\r\n\r\n            frm.add_custom_button(__('Print Internal Invoice'), function() {\r\n                console.log(\"heloooooo\");\r\n                InternalPrint(frm);\r\n            }).addClass(\"btn-primary\");\r\n\r\n            frm.add_custom_button(__('Print External Invoice'), function() {\r\n                console.log(\"External Print button clicked.\");\r\n                ExternalPrint(frm)\r\n            }).addClass(\"btn-primary\");\r\n        }\r\n        \r\n        else if(frm.doc.top_button === \"1\"){\r\n         frm.add_custom_button(__('Print Internal Invoice'), function() {\r\n                console.log(\"heloooooo\");\r\n                InternalPrint(frm);\r\n            }).addClass(\"btn-primary\");\r\n\r\n            frm.add_custom_button(__('Print External Invoice'), function() {\r\n                console.log(\"External Print button clicked.\");\r\n                ExternalPrint(frm)\r\n            }).addClass(\"btn-primary\");\r\n        }\r\n\r\nfrm.fields_dict.month.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.premium_rate.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.reinsurer.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.reinsurer_refnumber.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.reinsurer1.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.portion_of_guarantee_guarantee_vat_p.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.beci_commission_p.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.reinsurer_commissions.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.other_insurer_commissions.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.broker.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.total_due_without_vat.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.vat.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.total_due.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.demand_date.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.guarantee_amount.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.premium_p.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.beci.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.beci_portion_of_gurantee_amount_p.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.beci_commission.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.reinsurer_commission.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.other_insurer_commission.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.broker_commission__p.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.vat_p.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.ecgc_ref_no.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.bond_guarantee_amount.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.bond_month.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.guarantee_fee_rate.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.reinsure.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.reinsurern_refnumber.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.reinsurer_per.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.portion_of_guarantee_amount_to_reinsurer.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.portion_of_guarantee_fee_to_reinsurer.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.ecgc_commission_.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.broker_.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.total_duewith_out_vat.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.vat_.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.bond_total_due.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.guarantee_fee.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.ecgc.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.portion_of_guarantee_to_amount_ecgc.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.portion_of_guarante_fee_to_ecgc.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.ecgc_commission.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.broker_commission.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.v_at.$input.css(\"text-align\", \"right\");\r\n\r\n\r\n        // if(frm.doc.top_button){\r\n        //          frm.add_custom_button(__('Internal Print'), function() {F\r\n        //           }).addClass(\"btn-primary\");\r\n        \r\n        //          frm.add_custom_button(__('External Print'), function() {\r\n        //   }).addClass(\"btn-primary\");\r\n        // }\r\n        \r\n        // else if(frm.doc.renewal_top_buttons){\r\n        //       frm.add_custom_button(__('Internal Print'), function() {\r\n        //           }).addClass(\"btn-primary\");\r\n        \r\n        //   frm.add_custom_button(__('External Print'), function() {\r\n        //   }).addClass(\"btn-primary\");\r\n        // }\r\n        \r\n        \r\n//   if (frm.doc.ecgc_ref_no) {\r\n//     getthedatadeputysheriff(frm);\r\n//      } \r\n   \r\n//     else if (frm.doc.bond_no) {\r\n//     getthedatabondapplication(frm);\r\n//      }\r\n    \r\n    \r\n   if (frm.doc.ecgc_ref_no !== undefined && frm.doc.ecgc_ref_no !== null && frm.doc.ecgc_ref_no !== \"\") {\r\n       \r\n         // Disable the fields you want here\r\n              frm.set_df_property('bond_details', 'hidden', 1); // hide field\r\n              frm.set_df_property('bond_no', 'hidden', 1);\r\n              frm.set_df_property('facility_name', 'hidden', 1);\r\n              frm.set_df_property('period_from', 'hidden', 1);\r\n              frm.set_df_property('bond_type', 'hidden', 1);\r\n              frm.set_df_property('bond_subtype', 'hidden', 1);\r\n              frm.set_df_property('bond_invoice_no', 'hidden', 1);\r\n              frm.set_df_property('month', 'hidden', 1);\r\n              frm.set_df_property('premium_rate', 'hidden', 1);\r\n              frm.set_df_property('invoice_date', 'hidden', 1);\r\n              frm.set_df_property('reinsurer', 'hidden', 1);\r\n              frm.set_df_property('reinsurer_refnumber', 'hidden', 1);\r\n              frm.set_df_property('reinsurer1', 'hidden', 1);\r\n              frm.set_df_property('portion_of_guarantee_guarantee_vat_p', 'hidden', 1);\r\n              frm.set_df_property('beci_commission_p', 'hidden', 1);\r\n              frm.set_df_property('reinsurer_commissions', 'hidden', 1);\r\n              frm.set_df_property('other_insurer_commissions', 'hidden', 1);\r\n              frm.set_df_property('broker1', 'hidden', 1);\r\n              \r\n              frm.set_df_property('broker', 'hidden', 1);\r\n              frm.set_df_property('with_vat', 'hidden', 1);\r\n              frm.set_df_property('with_out_vat', 'hidden', 1);\r\n              frm.set_df_property('total_due_without_vat', 'hidden', 1);\r\n              frm.set_df_property('vat', 'hidden', 1);\r\n              frm.set_df_property('total_due', 'hidden', 1);\r\n              frm.set_df_property('demand_date', 'hidden', 1);\r\n              frm.set_df_property('bond_in_favour', 'hidden', 1);\r\n              \r\n               frm.set_df_property('guarantee_amount', 'hidden', 1);\r\n              frm.set_df_property('premium_p', 'hidden', 1);\r\n              frm.set_df_property('to', 'hidden', 1);\r\n              frm.set_df_property('beci', 'hidden', 1);\r\n              frm.set_df_property('beci_portion_of_gurantee_amount_p', 'hidden', 1);\r\n              \r\n              frm.set_df_property('beci_commission', 'hidden', 1);\r\n              frm.set_df_property('reinsurer_commission', 'hidden', 1);\r\n              frm.set_df_property('other_insurer_commission', 'hidden', 1);\r\n              frm.set_df_property('broker_commission__p', 'hidden', 1);\r\n              frm.set_df_property('vat_p', 'hidden', 1);\r\n              \r\n        \r\n    }\r\n    \r\n    else if (frm.doc.bond_no !== undefined && frm.doc.bond_no !== null && frm.doc.bond_no !== \"\") {\r\n        \r\n            // Disable the fields you want here\r\n              frm.set_df_property('bond_invoice', 'hidden', 1); // hide field\r\n              frm.set_df_property('ecgc_ref_no', 'hidden', 1);\r\n              frm.set_df_property('sheriff_name', 'hidden', 1);\r\n              frm.set_df_property('bond_guarantee_amount', 'hidden', 1);\r\n              frm.set_df_property('bond_period_from', 'hidden', 1);\r\n              frm.set_df_property('bond_month', 'hidden', 1);\r\n              frm.set_df_property('guarantee_fee_rate', 'hidden', 1);\r\n              frm.set_df_property('reinsure', 'hidden', 1);\r\n              frm.set_df_property('reinsurern_refnumber', 'hidden', 1);\r\n              frm.set_df_property('reinsurer_per', 'hidden', 1);\r\n              frm.set_df_property('portion_of_guarantee_amount_to_reinsurer', 'hidden', 1);\r\n              frm.set_df_property('portion_of_guarantee_fee_to_reinsurer', 'hidden', 1);\r\n              frm.set_df_property('ecgc_commission_', 'hidden', 1);\r\n              frm.set_df_property('bond_broker', 'hidden', 1);\r\n              frm.set_df_property('broker_', 'hidden', 1);\r\n              frm.set_df_property('total_duewith_out_vat', 'hidden', 1);\r\n              frm.set_df_property('vat_', 'hidden', 1);\r\n              frm.set_df_property('v_at', 'hidden', 1);\r\n              frm.set_df_property('bond_total_due', 'hidden', 1);\r\n              frm.set_df_property('bond_invoice_date', 'hidden', 1);\r\n              frm.set_df_property('bond_period_to', 'hidden', 1);\r\n              frm.set_df_property('guarantee_fee', 'hidden', 1);\r\n              frm.set_df_property('ecgc', 'hidden', 1);\r\n              frm.set_df_property('portion_of_guarantee_to_amount_ecgc', 'hidden', 1);\r\n              frm.set_df_property('portion_of_guarante_fee_to_ecgc', 'hidden', 1);\r\n              frm.set_df_property('ecgc_commission', 'hidden', 1);\r\n              frm.set_df_property('broker_commission', 'hidden', 1);\r\n              frm.set_df_property('top_button', 'hidden', 1);\r\n              frm.set_df_property('renewal_top_buttons','hidden', 1)\r\n               \r\n    }\r\n    //----------------------------merge code from  Internal And External print\r\n    \r\n    \r\n    \r\n    \r\n    \r\n   \r\n    },                                                     \r\n\r\n    total_due_without_vat: function(frm) {\r\n        calculateVat_p(frm);\r\n        calculateTotal_due(frm);\r\n    },\r\n    \r\n    //Bond Invoice\r\n    guarantee_amount: function(frm) {\r\n        calculateBroker(frm);\r\n    },\r\n    broker: function(frm) {\r\n        calculateBroker(frm);\r\n    },\r\n   \r\n    \r\n    \r\n    //Bond Sheriff calculations \r\n    bond_broker: function(frm) {\r\n        // Check if the Broker field has a value\r\n        if (frm.doc.bond_broker) {\r\n            // If Broker has a value, show the Broker Percentage field\r\n            frm.set_value('broker_', 10);\r\n        } else {\r\n            frm.set_value('broker_', '');\r\n        }\r\n    },\r\n    \r\n    //Deputy Sheriff Calculation of Months\r\n    bond_period_from: function(frm) {\r\n        calculateMonths(frm);\r\n    },\r\n    \r\n    bond_period_to: function(frm) {\r\n        calculateMonths(frm);\r\n    },\r\n    \r\n    reinsurer_per: function(frm) {\r\n        calculateECGpercentage(frm); \r\n        calculatePortionofGuaranteeamounttoreinsurer(frm);\r\n        calculatePortionofGuaranteefeetoreinsurer(frm);\r\n    },\r\n    \r\n    bond_guarantee_amount: function(frm) {\r\n        calculatePortionofGuaranteeamounttoreinsurer(frm); \r\n        calculateportionofguaranteeamounttoECGC(frm);\r\n    },\r\n    \r\n    ecgc: function(frm) {\r\n        calculateportionofguaranteeamounttoECGC(frm);\r\n    },\r\n    \r\n    guarantee_fee: function(frm) {\r\n        calculatePortionofGuaranteefeetoreinsurer(frm); \r\n        calculateportionofguaranteefeetoECG(frm);\r\n        calculatetotaldduewithoutvat(frm);\r\n        calculatevat(frm);\r\n        calculatebrokercommission(frm);\r\n    },\r\n    \r\n    ecgc_commission_: function(frm) {\r\n        calculateportionofguaranteefeetoECG(frm);  \r\n    },\r\n    \r\n    vat_: function(frm) {\r\n        calculatevat(frm);\r\n    },\r\n    \r\n    broker_: function(frm) {\r\n        calculatebrokercommission(frm);\r\n    },\r\n    \r\n    \r\n\r\n});\r\n\r\n// Function definitions...\r\n\r\n\r\nfunction calculateVat_p(frm) {\r\n    var total_vat = frm.doc.total_due_without_vat || 0;\r\n    var vat = frm.doc.vat || 0;\r\n\r\n    var total = total_vat * (vat / 100);\r\n\r\n    frm.set_value('vat_p', total);\r\n}\r\n\r\n\r\nfunction calculateTotal_due(frm) {\r\n    var total_vat = frm.doc.total_due_without_vat || 0;\r\n    var vat_p = frm.doc.vat_p || 0;\r\n\r\n    var total = total_vat + vat_p;\r\n\r\n    frm.set_value('total_due', total);\r\n}\r\n\r\n\r\n\r\n//Deputy Sheriff month calculation code\r\nfunction calculateMonths(frm) {\r\n    console.log('calculateMonths function called');\r\n    var from_date = frm.doc.bond_period_from;\r\n    var to_date = frm.doc.bond_period_to;\r\n \r\n    console.log('from_date:', from_date);\r\n    console.log('to_date:', to_date);\r\n \r\n    if (from_date && to_date) {\r\n        var from_date_obj = frappe.datetime.str_to_obj(from_date);\r\n        var to_date_obj = frappe.datetime.str_to_obj(to_date);\r\n \r\n        var monthsDiff = (to_date_obj.getFullYear() - from_date_obj.getFullYear()) * 12;\r\n        monthsDiff -= from_date_obj.getMonth();\r\n        monthsDiff += to_date_obj.getMonth();\r\n        console.log('Months difference:', monthsDiff);\r\n        frm.set_value('bond_month', monthsDiff);\r\n    } else {\r\n        console.log('One or both dates are empty');\r\n        frm.set_value('bond_month', '');\r\n    }\r\n}\r\n\r\n//Calculate ECG%\r\nfunction calculateECGpercentage(frm){\r\n    var reinsurerrate = frm.doc.reinsurer_per;\r\n    \r\n    var ecgpercentage = 100-reinsurerrate;\r\n    \r\n    frm.set_value('ecgc',ecgpercentage);\r\n}\r\n\r\n//Calculate Portion of guarantee amount to Reinsurer\r\nfunction calculatePortionofGuaranteeamounttoreinsurer(frm){\r\n    var guaranteeamount=frm.doc.bond_guarantee_amount;\r\n    var reinsurerrate = frm.doc.reinsurer_per;\r\n    \r\n    var portionofguaranteeamounttoreinsurer = guaranteeamount*(reinsurerrate/100);\r\n    \r\n    frm.set_value('portion_of_guarantee_amount_to_reinsurer',portionofguaranteeamounttoreinsurer);\r\n    \r\n}\r\n\r\n//Calculate Portion of guarantee Amount to ECGC\r\nfunction calculateportionofguaranteeamounttoECGC(frm){\r\n    \r\n    var portion_of_guarantee_amount = frm.doc.bond_guarantee_amount;\r\n    \r\n    var ecgpercent = frm.doc.ecgc;\r\n    \r\n    var portion_of_guarantee_amounttoecg = portion_of_guarantee_amount*(ecgpercent/100);\r\n    \r\n     frm.set_value('portion_of_guarantee_to_amount_ecgc',portion_of_guarantee_amounttoecg);\r\n}\r\n\r\n//Calculate Portion of Guarantee fee to Reinsurer\r\nfunction calculatePortionofGuaranteefeetoreinsurer(frm){\r\n    var guaranteefee = frm.doc.guarantee_fee;\r\n    var reinsurerrate = frm.doc.reinsurer_per;\r\n    var guaranteefeetoreinsurer = guaranteefee*(reinsurerrate/100);\r\n    var ecgccommission = guaranteefeetoreinsurer*[(100-reinsurerrate)/100];\r\n    frm.set_value('portion_of_guarantee_fee_to_reinsurer',guaranteefeetoreinsurer);\r\n    frm.set_value('ecgc_commission',ecgccommission);\r\n}\r\n\r\n//Calculate portion of Guarantee fee to ECG\r\nfunction calculateportionofguaranteefeetoECG(frm){\r\n    var guaranteefee = frm.doc.guarantee_fee;\r\n    var becipercent = frm.doc.ecgc_commission_;\r\n    var guaranteefeetoECGC = guaranteefee*(becipercent/100);\r\n    frm.set_value('portion_of_guarante_fee_to_ecgc',guaranteefeetoECGC);\r\n    \r\n}\r\n\r\n//Calculate Total Due with ot Vat\r\n function calculatetotaldduewithoutvat(frm){\r\n     var guaranteefee = frm.doc.guarantee_fee;\r\n     var totalduewithoutvat = guaranteefee/1.1;\r\n     frm.set_value('total_duewith_out_vat',totalduewithoutvat);\r\n     \r\n }\r\n\r\n//calculate Vat\r\n// function calculatevat(frm){\r\n//       var guaranteefee = frm.doc.guarantee_fee;\r\n//       var vatpercentage = frm.doc.vat_;\r\n//       var vat = guaranteefee*(vatpercentage/100);\r\n//       frm.set_value('v_at',vat);\r\n// }\r\n\r\n//Calculate Broker Commission\r\n function calculatebrokercommission(frm){\r\n    var guaranteefee = frm.doc.guarantee_fee;\r\n    var brokerrate = frm.doc.broker_;\r\n    var brokercommission = guaranteefee*(brokerrate/100);\r\n    frm.set_value('broker_commission', brokercommission);\r\n    \r\n }\r\n\r\n// function getthedatadeputysheriff(frm){\r\n    \r\n//          frappe.call({\r\n//             method: 'frappe.client.get_list',\r\n//             args: {\r\n//                 doctype: 'Deputy Sheriff Bond',\r\n//                 filters: {\r\n//                     bond_no: frm.doc.ecgc_ref_no\r\n//                 },\r\n//                 fields: ['sheriff_name','period_to','period_from','bond_value','reinsurer_ref_numbeecgc_invoice_no','reinsurer_rate','premium','premium_rate','broker','reinsurer','ecgc_reinsurance_commission']\r\n//             },\r\n//             callback: function(r) {\r\n//                 if (!r.exc && r.message && r.message.length > 0) {\r\n//                     var bondApp = r.message[0];\r\n//                     frm.set_value('sheriff_name', bondApp.sheriff_name);\r\n//                     frm.set_value('bond_period_from', bondApp.period_from); \r\n//                     frm.set_value('bond_period_to', bondApp.period_to);\r\n//                     frm.set_value('bond_guarantee_amount', bondApp.bond_value);\r\n//                     frm.set_value('reinsurern_refnumber', bondApp.reinsurer_ref_numbeecgc_invoice_no);\r\n//                     frm.set_value('reinsurer_per', bondApp.reinsurer_rate);\r\n//                     frm.set_value('guarantee_fee', bondApp.premium); \r\n//                     frm.set_value('bond_total_due', bondApp.premium);\r\n//                     frm.set_value('guarantee_fee_rate', bondApp.premium_rate);\r\n//                     frm.set_value('bond_broker', bondApp.broker);\r\n//                     frm.set_value('reinsure', bondApp.reinsurer);\r\n//                     frm.set_value('ecgc_commission_', bondApp.ecgc_reinsurance_commission);\r\n                \r\n                  \r\n//                 } else {\r\n//                      console.error(\"Error occurred:\", r.exc);\r\n//                 }\r\n//             }\r\n//         });\r\n    \r\n// }\r\n\r\n// function getthedatabondapplication(frm){\r\n    \r\n//       frappe.call({\r\n//             method: 'frappe.client.get_list',\r\n//             args: {\r\n//                 doctype: 'Bond Application',\r\n//                 filters: {\r\n//                     bond_no: frm.doc.bond_no\r\n//                 },\r\n//                 fields: ['bond_no','broker','facility_name','bond_type','period_from','bond_subtype','month','reinsurer','beci_commission_p','reinsurer_commission','reinsurer_commissions','other_insurer_commission','other_insurer_commissions','beci_commission','to','bond_in_favour','demand_date','guarantee_amount','beci_portion_of_gurantee_fee','reinsurer_refnumber','reinsurer_portion_of_guarantee_fee_p','portion_of_guarantee_guarantee_vat_p','portion_of_guarantee_to_beci','guarantee_fee','vat']\r\n//             },\r\n//             callback: function(r) {\r\n//                 if (!r.exc && r.message && r.message.length > 0) {\r\n//                     var bondApp = r.message[0];\r\n//                     frm.set_value('facility_name', bondApp.facility_name); \r\n//                     frm.set_value('bond_invoice_no', bondApp.bond_no); \r\n//                     frm.set_value('bond_type', bondApp.bond_type);\r\n//                     frm.set_value('period_from', bondApp.period_from);\r\n//                     frm.set_value('bond_subtype', bondApp.bond_subtype);\r\n//                     frm.set_value('month', bondApp.month);\r\n//                     frm.set_value('reinsurer', bondApp.reinsurer); \r\n//                     frm.set_value('beci_commission_p', bondApp.beci_commission_p);\r\n//                     frm.set_value('reinsurer_commissions', bondApp.reinsurer_commissions);\r\n//                     frm.set_value('other_insurer_commissions', bondApp.other_insurer_commissions);\r\n//                     frm.set_value('beci_commission', bondApp.beci_commission);\r\n//                     frm.set_value('to', bondApp.to); \r\n//                     frm.set_value('bond_in_favour', bondApp.bond_in_favour);\r\n//                     frm.set_value('demand_date', bondApp.demand_date);\r\n//                     frm.set_value('guarantee_amount', bondApp.guarantee_amount);\r\n//                     frm.set_value('beci_portion_of_gurantee_amount_p', bondApp.beci_portion_of_gurantee_fee);\r\n//                     frm.set_value('reinsurer_refnumber', bondApp.reinsurer_refnumber);\r\n//                     frm.set_value('reinsurer1', bondApp.portion_of_guarantee_guarantee_vat_p);\r\n//                     frm.set_value('premium_p', bondApp.beci_portion_of_gurantee_fee); \r\n//                     frm.set_value('beci', bondApp.portion_of_guarantee_to_beci);\r\n//                     frm.set_value('premium_rate', bondApp.guarantee_fee);\r\n//                     frm.set_value('vat', bondApp.vat);\r\n//                     frm.set_value('reinsurer_commission', bondApp.reinsurer_commission);\r\n//                     frm.set_value('portion_of_guarantee_guarantee_vat_p', bondApp.reinsurer_portion_of_guarantee_fee_p);\r\n//                     frm.set_value('other_insurer_commission', bondApp.other_insurer_commission);\r\n//                     frm.set_value('total_due_without_vat', bondApp.beci_portion_of_gurantee_fee);\r\n//                     frm.set_value('broker1', bondApp.broker);\r\n                    \r\n                   \r\n//                 } else {\r\n//                     console.error(\"Error occurred:\", r.exc);\r\n//                 }\r\n//             }\r\n//         });   \r\n      \r\n   \r\n    \r\n// }\r\n\r\n\r\nfunction calculateBroker(frm) {\r\n    var guarantee_amount = frm.doc.guarantee_amount || 0;\r\n    var brokerPercent = frm.doc.broker || 0;\r\n\r\n    // Calculate broker commission\r\n    var brokerCommission = (guarantee_amount * brokerPercent / 100);\r\n\r\n    // Set the value of broker_commission__p field\r\n    frm.set_value('broker_commission__p', brokerCommission);\r\n}\r\n\r\n\r\n\r\nfunction InternalPrint(frm) {\r\n    console.log(\"Internal Print button clicked.\");\r\n\r\n    if (frm.doc.bond_application === 1) {\r\n        console.log(frm.doc.bond_application, \"type is selected\");\r\n        frappe.model.with_doctype('Print Internal Invoice', () => {\r\n            let doc = frappe.model.get_new_doc('Print Internal Invoice');\r\n            console.log(frm.doc, \"get all data bond invoice to print \");\r\n            console.log(frm.doc.facility_name)\r\n            doc.client = frm.doc.facility_name;\r\n            doc.bond_no = frm.doc.bond_no;\r\n            doc.period = frm.doc.period_from;\r\n            doc.to = frm.doc.to;\r\n            doc.month = frm.doc.month;\r\n            doc.bond_sub_type = frm.doc.bond_type;\r\n            doc.guarantee_amount = frm.doc.bond_guarantee_amount;\r\n            doc.rate = frm.doc.guarantee_amount;\r\n            doc.premiumpula = frm.doc.premium_rate;\r\n            doc.vat__14_ = frm.doc.vat_p;\r\n            doc.total_due = frm.doc.total_due_without_vat;\r\n            doc.reinsurer_refno = frm.doc.reinsurer_refnumber;\r\n            doc.invoice_no  = frm.doc.bond_no;\r\n\r\n            var premiumRate = parseFloat(frm.doc.premium_rate) || 0;\r\n            var guaranteeFeeRate = parseFloat(frm.doc.guarantee_fee_rate) || 0;\r\n            var bondGuaranteeAmount = parseFloat(frm.doc.bond_guarantee_amount) || 0;\r\n            var Totalamt = premiumRate + guaranteeFeeRate + bondGuaranteeAmount;\r\n            doc.sub_total = Totalamt;\r\n            console.log(doc.sub_total, \"total amount\");\r\n\r\n            doc.renewal_top_buttons = \"1\";\r\n\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Renewals',\r\n                    filters: {\r\n                        bond_holder: frm.doc.client\r\n                    },\r\n                    fields: ['bond_no', 'client', 'principal', 'description', 'bondtype1']\r\n                },\r\n                callback: function(response) {\r\n                    if (response.message && response.message.length > 0) {\r\n                        console.log(response.message, \"response data\");\r\n                        let prepareInvoiceData = response.message[0];\r\n                        console.log(prepareInvoiceData, 'deputy shireff prepare invoice data');\r\n                        doc.description = prepareInvoiceData.description;\r\n                        // doc.bond_sub_type = prepareInvoiceData.bondtype1;\r\n                        // doc.client = prepareInvoiceData.client;\r\n                        // doc.principal = prepareInvoiceData.principal;\r\n                        // doc.description1 = prepareInvoiceData.description;\r\n                        // doc.bond_no = prepareInvoiceData.bond_no;\r\n\r\n                        doc.other_bonds = frm.doc.bond_application;\r\n                    } else {\r\n                        console.log(\"No Deputy Sheriff Prepare Invoice found for the given criteria.\");\r\n                    }\r\n\r\n                    // Save the current document before navigating to the next doctype\r\n                    frappe.call({\r\n                        method: 'frappe.client.insert',\r\n                        args: {\r\n                            doc: doc\r\n                        },\r\n                        callback: function(response) {\r\n                            if (!response.exc) {\r\n                                frappe.set_route('Form', 'Print Internal Invoice', response.message.name);\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        });\r\n    } else if (frm.doc.deputy_sheriff === 1) {\r\n        console.log(\"Deputy Sheriff Bond application selected.\");\r\n        frappe.model.with_doctype('Print Internal Invoice', () => {\r\n            let doc = frappe.model.get_new_doc('Print Internal Invoice');\r\n            console.log(doc, \"get all data bond invoice to print \");\r\n            console.log(frm.doc.facility_name)\r\n            doc.client = frm.doc.facility_name;\r\n            doc.bond_no = frm.doc.bond_no;\r\n            doc.period = frm.doc.period_from;\r\n            doc.to = frm.doc.to;\r\n            doc.month = frm.doc.month;\r\n            doc.bond_sub_type = frm.doc.bond_type;\r\n            doc.guarantee_amount = frm.doc.bond_guarantee_amount;\r\n            doc.rate = frm.doc.guarantee_amount;\r\n            doc.premiumpula = frm.doc.premium_rate;\r\n            doc.vat__14_ = frm.doc.vat_p;\r\n            doc.total_due = frm.doc.total_due_without_vat;\r\n            doc.reinsurer_refno = frm.doc.bond_no;\r\n            doc.invoice_no  = frm.doc.bond_no;\r\n\r\n            var premiumRate = parseFloat(frm.doc.premium_rate) || 0;\r\n            var guaranteeFeeRate = parseFloat(frm.doc.guarantee_fee_rate) || 0;\r\n            var bondGuaranteeAmount = parseFloat(frm.doc.bond_guarantee_amount) || 0;\r\n            var subTotal = premiumRate + guaranteeFeeRate + bondGuaranteeAmount;\r\n            doc.sub_total = subTotal;\r\n            console.log(subTotal, \"total amount\");\r\n            doc.renewal_top_buttons = \"1\";\r\n\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Renewals',\r\n                    filters: {\r\n                        bond_holder: frm.doc.client\r\n                    },\r\n                    fields: ['bond_no', 'principal', 'description', 'bondtype1']\r\n                },\r\n                callback: function(response) {\r\n                    if (response.message && response.message.length > 0) {\r\n                        console.log(response.message, \"response data\");\r\n                        let prepareInvoiceData = response.message[0];\r\n                        console.log(prepareInvoiceData, 'deputy shireff prepare invoice data');\r\n                        doc.description = prepareInvoiceData.description;\r\n                        // doc.bond_sub_type = prepareInvoiceData.bondtype1;\r\n                        // doc.client = prepareInvoiceData.client;\r\n                        doc.principal = prepareInvoiceData.principal;\r\n                        doc.description1 = prepareInvoiceData.description;\r\n                        doc.bond_no = prepareInvoiceData.bond_no;\r\n\r\n                        doc.deputy_sheriff = frm.doc.deputy_sheriff;\r\n                    } else {\r\n                        console.log(\"No Deputy Sheriff Prepare Invoice found for the given criteria.\");\r\n                    }\r\n\r\n                    // Save the current document before navigating to the next doctype\r\n                    frappe.call({\r\n                        method: 'frappe.client.insert',\r\n                        args: {\r\n                            doc: doc\r\n                        },\r\n                        callback: function(response) {\r\n                            if (!response.exc) {\r\n                                frappe.set_route('Form', 'Print Internal Invoice', response.message.name);\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        });\r\n    }\r\n}\r\nfunction ExternalPrint(frm) {\r\n    console.log(\"external Print button clicked.\");\r\n\r\n    if (frm.doc.bond_application === 1) {\r\n        console.log(frm.doc.bond_application, \"type is selected\");\r\n        frappe.model.with_doctype('Print External Invoice', () => {\r\n            let doc = frappe.model.get_new_doc('Print External Invoice');\r\n            doc.account  = frm.doc.facility_name;\r\n            doc.invoice_n0 = frm.doc.bond_no;\r\n            doc.amount1 = frm.doc.premium_rate;\r\n            doc.amount2 = frm.doc.premium_p;\r\n            doc.amount3 =frm.doc.vat;\r\n            doc.amount4 = frm.doc.vat_p;\r\n            doc.amount6 = frm.doc.reinsurer1;\r\n            doc.amount9  = frm.doc.broker;\r\n            doc.amount11 = frm.doc.beci;\r\n            doc.amount12 =frm.doc.beci_commission;\r\n            doc.amount15 = frm.doc.total_due\r\n                 \r\n             var premium = parseFloat(frm.doc.premium_p) || 0;\r\n             var vat = parseFloat(frm.doc.vat_p) || 0;\r\n            var Total1 = premium + vat;\r\n            doc.amount5 = Total1;\r\n            console.log(doc.amount5, \"total amount\");\r\n            \r\n          var reinsurer1 = parseFloat(frm.doc.reinsurer1) || 0;\r\n         var broker = parseFloat(frm.doc.broker) || 0;\r\n         var beci_commission = parseFloat(frm.doc.beci) || 0;\r\n         var TotalAmount1 = reinsurer1 + broker + beci_commission;\r\n         doc.amount13 = TotalAmount1;\r\n        console.log(doc.amount13, \"total amount\");\r\n\r\n            doc.renewal_top_buttons = \"1\";\r\n            doc.other_bonds = frm.doc.bond_application;\r\n             frappe.call({\r\n                        method: 'frappe.client.insert',\r\n                        args: {\r\n                            doc: doc\r\n                        },\r\n                        callback: function(response) {\r\n                            if (!response.exc) {\r\n                                frappe.set_route('Form', 'Print External Invoice', response.message.name);\r\n                            }\r\n                        }\r\n                    });\r\n\r\n            \r\n        });\r\n    } else if (frm.doc.deputy_sheriff === 1) {\r\n    console.log(\"Deputy Sheriff Bond application selected.\");\r\n    frappe.model.with_doctype('Print External Invoice', () => {\r\n        let doc = frappe.model.get_new_doc('Print External Invoice');\r\n        doc.amount1 = frm.doc.premium_rate;\r\n        doc.amount2 = frm.doc.premium_p;\r\n        doc.amount3 = frm.doc.vat;\r\n        doc.amount4 = frm.doc.vat_p;\r\n        doc.amount6 = frm.doc.reinsurer1;\r\n        doc.amount9 = frm.doc.broker;\r\n        doc.amount11 = frm.doc.beci;\r\n        doc.amount12 = frm.doc.beci_commission;\r\n        doc.amount15 = frm.doc.total_due;\r\n        doc.account  = frm.doc.sheriff_name;\r\n        doc.invoice_n0 = frm.doc.bond_no;\r\n\r\n        var premium = parseFloat(frm.doc.premium_p) || 0;\r\n        var vat = parseFloat(frm.doc.vat_p) || 0;\r\n       \r\n        var Total = premium + vat;\r\n        doc.amount5 = Total;\r\n        console.log(doc.amount5, \"total amount\");\r\n\r\n        var reinsurer1 = parseFloat(frm.doc.reinsurer1) || 0;\r\n        var broker = parseFloat(frm.doc.broker) || 0;\r\n        var beci_commission = parseFloat(frm.doc.beci) || 0;\r\n        var TotalAmount = reinsurer1 + broker + beci_commission;\r\n        doc.amount13 = TotalAmount;\r\n        console.log(doc.amount13, \"total amount\");\r\n\r\n        doc.renewal_top_buttons = \"1\";\r\n        doc.deputyshierff_bonds = frm.doc.deputy_sheriff;\r\n        \r\n          frappe.call({\r\n                        method: 'frappe.client.insert',\r\n                        args: {\r\n                            doc: doc\r\n                        },\r\n                        callback: function(response) {\r\n                            if (!response.exc) {\r\n                                frappe.set_route('Form', 'Print External Invoice', response.message.name);\r\n                            }\r\n                        }\r\n                    });\r\n\r\n    });\r\n}\r\n\r\n}\r\n\r\n// frappe.ui.form.on('Bond Invoice', {\r\n//     refresh(frm) {\r\n//         console.log(\"Form refreshed.\");\r\n//         console.log(\"Renewal top buttons value:\", frm.doc.renewal_top_buttons);\r\n\r\n//         if (frm.doc.renewal_top_buttons === \"1\") {\r\n//             console.log(\"Renewal top buttons enabled.\");\r\n\r\n//             frm.add_custom_button(__('Print Internal Invoice '), function() {\r\n//                 console.log(\"heloooooo\");\r\n//                 InternalPrint(frm);\r\n//             }).addClass(\"btn-primary\");\r\n\r\n//             frm.add_custom_button(__('Print External Invoice '), function() {\r\n//                 console.log(\"External Print button clicked.\");\r\n//                 ExternalPrint(frm)\r\n//             }).addClass(\"btn-primary\");\r\n//         }\r\n        \r\n//         else if(frm.doc.top_button === \"1\")\r\n//          frm.add_custom_button(__('Print Internal Invoice '), function() {\r\n//                 console.log(\"heloooooo\");\r\n//                 InternalPrint(frm);\r\n//             }).addClass(\"btn-primary\");\r\n\r\n//             frm.add_custom_button(__('Print External Invoice '), function() {\r\n//                 console.log(\"External Print button clicked.\");\r\n//                 ExternalPrint(frm)\r\n//             }).addClass(\"btn-primary\");\r\n//     }\r\n// });\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Print proposal",
  "enabled": 0,
  "modified": "2025-10-31 07:25:19.158370",
  "module": "Marketing",
  "name": "print",
  "script": "frappe.ui.form.on('Print proposal', {\r\n    onload: function (frm) {\r\n        // Client details\r\n        frappe.call({\r\n            method: 'frappe.client.get',\r\n            args: {\r\n                doctype: 'Company-Details',\r\n                name: frm.doc.client_name\r\n            },\r\n            callback: function (r) {\r\n                console.log(r, \"client details\");\r\n\r\n                if (r.message) {\r\n                    frm.set_value('postal_address', r.message.postal_address);\r\n                    frm.set_value('physical_address', r.message.physical_address);\r\n                    frm.set_value('fax', r.message.fax);\r\n                    frm.set_value('registrationno', r.message.registration_number);\r\n                    frm.set_value('establishmentdate', r.message.establisheddate);\r\n                    frm.set_value('bankers', r.message.bank);\r\n                    frm.set_value('telephone', r.message.telephone);\r\n                    frm.set_value('account_no', r.message.ac_no);\r\n                    frm.set_value('email', r.message.email);\r\n\r\n                    // Refresh the form to reflect the changes\r\n                    frm.refresh();\r\n                } else {\r\n                    console.error(\"Error occurred in client details:\", r.exc);\r\n                }\r\n            }\r\n        });\r\n\r\n        // Fetch trade style data\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'DCI Proposals',\r\n                filters: {\r\n                    client_name: frm.doc.client_name\r\n                },\r\n                fields: ['associated_companies', 'government', 'retailers', 'manufacturers', 'wholesalers'],\r\n                limit_page_length: 1 // Limit to one result for efficiency\r\n            },\r\n            callback: function(response) {\r\n                if (response.message && response.message.length > 0) {\r\n                    var data_from_proposals = response.message[0];\r\n                    var trade_styles = [];\r\n\r\n                    if (data_from_proposals.associated_companies) {\r\n                        trade_styles.push('Associated Companies');\r\n                    }\r\n                    if (data_from_proposals.government) {\r\n                        trade_styles.push('Government');\r\n                    }\r\n                    if (data_from_proposals.retailers) {\r\n                        trade_styles.push('Retailers');\r\n                    }\r\n                    if (data_from_proposals.manufacturers) {\r\n                        trade_styles.push('Manufacturers');\r\n                    }\r\n                    if (data_from_proposals.wholesalers) {\r\n                        trade_styles.push('Wholesalers');\r\n                    }\r\n\r\n                    frm.set_value('trade_style', trade_styles.join(', '));\r\n                } else {\r\n                    frm.set_value('trade_style', ''); // Ensure 'trade_style' is cleared if no data is found\r\n                }\r\n            },\r\n            error: function(error) {\r\n                console.error(\"Error in frappe.call:\", error);\r\n                frm.set_value('trade_style', ''); // Clear the field in case of an error\r\n            }\r\n        });\r\n\r\n        // DCI Proposals data\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: {\r\n                doctype: \"DCI Proposals\",\r\n                filters: {\r\n                    client_name: frm.doc.client_name\r\n                },\r\n                fields: [\"directors_shareholders_table\"]\r\n            },\r\n            callback: function (r) {\r\n                console.log(r, \"DCI Proposals data\");\r\n\r\n                if (r.message && r.message.directors_shareholders_table) {\r\n                    var data = r.message.directors_shareholders_table;\r\n\r\n                    // Clear the child table before adding new rows\r\n                    frm.clear_table('table');\r\n\r\n                    for (let x of data) {\r\n                        var child = frappe.model.add_child(frm.doc, \"Print Child\", \"table\");\r\n                        frappe.model.set_value(child.doctype, child.name, \"designation\", x.designation);\r\n                        frappe.model.set_value(child.doctype, child.name, \"share_holder\", x.directorname);\r\n\r\n                        // Add more fields as needed\r\n                    }\r\n\r\n                    frm.refresh_fields('table');\r\n                    console.log(data);\r\n                } else {\r\n                    console.error(\"Error occurred in DCI Proposals data:\", r.exc);\r\n                }\r\n            }\r\n        });\r\n    },\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Specimen Policy Document ECI",
  "enabled": 1,
  "modified": "2025-11-05 13:41:48.922391",
  "module": null,
  "name": "Specimen script",
  "script": "frappe.ui.form.on('Specimen Policy Document ECI', {\r\n    onload: function(frm) {\r\n        // Fetch data from Policy Approvals based on proposal number\r\n        var proposalNumber = frm.doc.proposal_no;\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Policy Approvals',\r\n                filters: {\r\n                    proposal_no: proposalNumber\r\n                },\r\n                fields: ['policy_number', 'proposal_no'],\r\n                limit_page_length: 1\r\n            },\r\n            callback: function(response) {\r\n                if (response && response.message && response.message.length > 0) {\r\n                    var policyApprovalData = response.message[0];\r\n                    frm.set_value('policy_no', policyApprovalData.policy_number);\r\n                    frm.set_value('proposal_no', policyApprovalData.proposal_no);\r\n                } else {\r\n                    frappe.msgprint('No matching record found in Policy Approvals.');\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error('Error fetching data from Policy Approvals:', err);\r\n                frappe.msgprint('An error occurred while fetching data from Policy Approvals.');\r\n            }\r\n        });\r\n},\r\n\r\n refresh: function(frm) {\r\n        // Fetch postal address from Company-Details based on `to` field\r\n        var Name = frm.doc.to;\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Company-Details',\r\n                filters: {\r\n                    name1: Name\r\n                },\r\n                fields: ['postal_address'],\r\n                limit_page_length: 1\r\n            },\r\n            callback: function(response) {\r\n                console.log(\"API Response Company-Details:\", response); // Log the response for debugging\r\n\r\n                if (response && response.message && response.message.length > 0) {\r\n                    var companyDetailsData = response.message[0];\r\n                    frm.set_value('of', companyDetailsData.postal_address);\r\n                } else {\r\n                    frappe.msgprint('No matching record found in Company-Details for ' + Name);\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error('Error fetching data from Company-Details:', err);\r\n                frappe.msgprint('An error occurred while fetching data from Company-Details.');\r\n            }\r\n        });\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Bond Extensions",
  "enabled": 1,
  "modified": "2025-12-10 07:30:22.800560",
  "module": null,
  "name": "Bond Extension",
  "script": "frappe.ui.form.on('Bond Extensions', {\r\n    \r\n    \r\n    \r\n    \r\n\r\n  refresh(frm) {\r\n const workflowState = frm.doc.workflow_state;\r\n\r\n        if (workflowState === \"Approved\") {\r\n            // Show data field, hide select field\r\n            frm.toggle_display('bond_holder', true);\r\n            frm.toggle_display('bond_holder2', false);\r\n\r\n            // Copy value from select to data field (if not already copied)\r\n            if (frm.doc.bond_holder2 && frm.doc.bond_holder !== frm.doc.bond_holder2) {\r\n                frm.set_value('bond_holder', frm.doc.bond_holder2);\r\n            }\r\n            frm.toggle_display('bond_no', true);\r\n            frm.toggle_display('bond_no2', false);\r\n\r\n            if (frm.doc.bond_no2 && frm.doc.bond_no !== frm.doc.bond_no2) {\r\n                frm.set_value('bond_no', frm.doc.bond_no2);\r\n            }\r\n        } else {\r\n            // For new, draft, pending, etc.\r\n            frm.toggle_display('bond_holder', false);\r\n            frm.toggle_display('bond_holder2', true);\r\n            \r\n            frm.toggle_display('bond_no', false);\r\n            frm.toggle_display('bond_no2', true);\r\n        }\r\n        \r\n\r\n\r\n      // ---------------------\r\n// PREPARE INVOICE BUTTON\r\n// ---------------------\r\nif (frm.doc.workflow_state == 'Approved') {\r\n\r\n    frm.add_custom_button(__('Prepare Invoice'), function () {\r\n\r\n        // Validation: only one bond should be selected\r\n        if (frm.doc.other_bonds === 1 && frm.doc.deputyshreiff_bond === 1) {\r\n            frappe.msgprint(\"Please select only one type of bond.\");\r\n            return;\r\n        }\r\n\r\n        // Common field\r\n        let ref_no = frm.doc.extension_req_no;\r\n\r\n        // -------------------------------------------\r\n        // \ud83d\udd0d STEP 1 \u2014 CHECK IF PREPARE INVOICE EXISTS\r\n        // -------------------------------------------\r\n        frappe.call({\r\n            method: \"frappe.client.get_list\",\r\n            args: {\r\n                doctype: \"Prepare Invoice\",\r\n                filters: { credsure_refno: ref_no },\r\n                fields: [\"name\"]\r\n            },\r\n            callback: function (res) {\r\n\r\n                if (res.message && res.message.length > 0) {\r\n\r\n                    // -----------------------------------\r\n                    // \ud83d\udfe2 IF FOUND \u2192 OPEN THE EXISTING DOC\r\n                    // -----------------------------------\r\n                    frappe.set_route(\"Form\", \"Prepare Invoice\", res.message[0].name);\r\n                    return;\r\n                }\r\n\r\n                // --------------------------------------------------\r\n                // \ud83d\udd34 IF NOT FOUND \u2192 CREATE NEW PREPARE INVOICE BELOW\r\n                // --------------------------------------------------\r\n\r\n                // ------------------------------\r\n                // 1\ufe0f\u20e3 DEPUTY SHERIFF BOND LOGIC\r\n                // ------------------------------\r\n                if (frm.doc.deputyshreiff_bond === 1) {\r\n\r\n                    frappe.route_options = {\r\n                        credsure_refno: frm.doc.extension_req_no,\r\n                        bond_period_from: frm.doc.bond_period_from,\r\n                        bond_period_to: frm.doc.bond_period_to,\r\n                        reinsurer_refnumber: frm.doc.bond_no,\r\n                        client: frm.doc.bond_holder,\r\n                        principal: frm.doc.principal,\r\n                        bond_type: frm.doc.bond_type_1,\r\n                        deputy_sheriff_bond: 1\r\n                    };\r\n\r\n                    frappe.new_doc(\"Prepare Invoice\");\r\n\r\n                    // LOAD DATA AFTER NEW DOC OPENS\r\n                    frappe.ui.form.on(\"Prepare Invoice\", {\r\n                        refresh(frm) {\r\n\r\n                            frappe.call({\r\n                                method: \"frappe.client.get_value\",\r\n                                args: {\r\n                                    doctype: \"Deputy Sheriff Bond\",\r\n                                    filters: { bond_no: frm.doc.reinsurer_refnumber },\r\n                                    fieldname: [\r\n                                        \"premium_without_vat\", \"premium_rate\", \"reinsurer\",\r\n                                        \"broker\", \"premium\", \"reinsurer_rate\", \"bond_value\",\r\n                                        \"ecgc_reinsurance_commission\"\r\n                                    ]\r\n                                },\r\n                                callback(r) {\r\n                                    if (r && r.message) {\r\n\r\n                                        frm.set_value(\"guarantee_fee_rate\", Number(r.message.premium_rate).toFixed(2));\r\n                                        frm.set_value(\"total_duewith_out_vat\", Number(r.message.premium_without_vat).toFixed(2));\r\n                                        frm.set_value(\"guarantee_amount\", Number(r.message.bond_value).toFixed(2));\r\n                                        frm.set_value(\"credsure_commission\", Number(r.message.ecgc_reinsurance_commission).toFixed(2));\r\n\r\n                                        frm.set_value(\"reinsure\", r.message.reinsurer);\r\n                                        frm.set_value(\"broker\", r.message.broker);\r\n                                        frm.set_value(\"guarantee_fee\", r.message.premium);\r\n                                        frm.set_value(\"reinsurer\", r.message.reinsurer_rate);\r\n\r\n                                        calculate_vat(frm);\r\n                                    }\r\n                                }\r\n                            });\r\n\r\n                            // Calculate months\r\n                            if (frm.doc.bond_period_from && frm.doc.bond_period_to) {\r\n                                let from_date = frappe.datetime.str_to_obj(frm.doc.bond_period_from);\r\n                                let to_date = frappe.datetime.str_to_obj(frm.doc.bond_period_to);\r\n\r\n                                let monthsDiff = (to_date.getFullYear() - from_date.getFullYear()) * 12 +\r\n                                    (to_date.getMonth() - from_date.getMonth());\r\n\r\n                                if (to_date.getDate() < from_date.getDate()) {\r\n                                    monthsDiff--;\r\n                                }\r\n\r\n                                frm.set_value('month', monthsDiff);\r\n                            }\r\n\r\n                        }\r\n                    });\r\n\r\n                    return;\r\n                }\r\n\r\n                // --------------------------\r\n                // 2\ufe0f\u20e3 OTHER BONDS LOGIC\r\n                // --------------------------\r\n                if (frm.doc.other_bonds === 1) {\r\n\r\n                    frappe.route_options = {\r\n                        credsure_refno: frm.doc.extension_req_no,\r\n                        bond_period_from: frm.doc.bond_period_from,\r\n                        bond_period_to: frm.doc.bond_period_to,\r\n                        guarantee_amount: frm.doc.bond_value,\r\n                        reinsurer_refnumber: frm.doc.bond_no,\r\n                        client: frm.doc.bond_holder,\r\n                        principal: frm.doc.principal,\r\n                        bond_type: frm.doc.bond_type_1\r\n                    };\r\n\r\n                    frappe.new_doc(\"Prepare Invoice\");\r\n\r\n                    frappe.ui.form.on(\"Prepare Invoice\", {\r\n                        refresh(frm) {\r\n\r\n                            frappe.call({\r\n                                method: 'frappe.client.get_list',\r\n                                args: {\r\n                                    doctype: 'Bond Application',\r\n                                    filters: { bond_no: frm.doc.reinsurer_refnumber },\r\n                                    fields: [\r\n                                        'broker', 'bond_subtype', 'month', 'reinsurer',\r\n                                        'guarantee_amount', 'vat', 'guarantee_fee_p',\r\n                                        'guarantee_fee', 'beci_commission_p',\r\n                                        'portion_of_guarantee_guarantee_vat_p'\r\n                                    ]\r\n                                },\r\n                                callback: function (r) {\r\n                                    if (!r.exc && r.message && r.message.length > 0) {\r\n\r\n                                        let bondApp = r.message[0];\r\n\r\n                                        frm.set_value('month', bondApp.month);\r\n                                        frm.set_value('broker', bondApp.broker);\r\n                                        frm.set_value('reinsure', bondApp.reinsurer);\r\n\r\n                                        frm.set_value('guarantee_fee', bondApp.guarantee_fee_p);\r\n                                        frm.set_value('guarantee_fee_rate', bondApp.guarantee_fee);\r\n\r\n                                        frm.set_value('credsure_commission', bondApp.beci_commission_p);\r\n                                        frm.set_value('reinsurer', bondApp.portion_of_guarantee_guarantee_vat_p);\r\n\r\n                                        let guarantee_fee = parseFloat(bondApp.guarantee_fee_p) || 0;\r\n                                        let total_due_without_vat = (guarantee_fee / 1.10).toFixed(2);\r\n\r\n                                        frm.set_value('total_duewith_out_vat', total_due_without_vat);\r\n\r\n                                        calculate_vat(frm);\r\n                                    }\r\n                                }\r\n                            });\r\n\r\n                        }\r\n                    });\r\n\r\n                    return;\r\n                }\r\n\r\n                // If nothing selected\r\n                frappe.msgprint(\"Please select Other Bonds or Deputy Sheriff Bond.\");\r\n            }\r\n        });\r\n\r\n    }).addClass(\"btn-primary\");\r\n}\r\n\r\n        \r\n        \r\n    \r\n\r\n\r\n        if (!frm.doc.extension_req_no) {\r\n            generateNumber(frm);\r\n        }\r\n         \r\n\r\n        frm.fields_dict.bond_value.$input.css(\"text-align\", \"right\");\r\n        // frm.fields_dict.extension_req_no.$input.css(\"text-align\",\"right\");\r\n        frm.fields_dict.new_bond_value.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.new_premium_rate.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.bond_value1.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.extension_req_no1.$input.css(\"text-align\", \"right\")\r\n\r\n        frm.fields_dict['deputyshreiff_bond'].df.onchange = handleFieldChange(frm, 'deputyshreiff_bond', 'deputyshreiff_bond1');\r\n        frm.fields_dict['other_bonds'].df.onchange = handleFieldChange(frm, 'other_bonds', 'other_bonds1');\r\n        frm.fields_dict['bond_holder2'].df.onchange = handleFieldChange(frm, 'bond_holder2', 'bond_holder2');\r\n\r\n    },\r\n    \r\n    onload(frm) {\r\n\r\n        // Only generate for NEW form\r\n        if (!frm.is_new()) return;\r\n\r\n        let currentYear = new Date().getFullYear();\r\n        let prefix = `BRQ/${currentYear}/`;\r\n\r\n        let lastRenewal = 0;\r\n        let lastExtension = 0;\r\n\r\n        // Get last number from Renewals\r\n        frappe.call({\r\n            method: \"frappe.client.get_list\",\r\n            args: {\r\n                doctype: \"Renewals\",\r\n                fields: [\"extension_req_no\"],\r\n                filters: { extension_req_no: [\"like\", `${prefix}%`] },\r\n                order_by: \"extension_req_no desc\",\r\n                limit_page_length: 1\r\n            },\r\n            callback: function (r) {\r\n                if (r.message && r.message.length > 0) {\r\n                    let parts = r.message[0].extension_req_no.split(\"/\");\r\n                    lastRenewal = parseInt(parts[2]);\r\n                }\r\n\r\n                // Now get last from Bond Extensions\r\n                frappe.call({\r\n                    method: \"frappe.client.get_list\",\r\n                    args: {\r\n                        doctype: \"Bond Extensions\",\r\n                        fields: [\"extension_req_no\"],\r\n                        filters: { extension_req_no: [\"like\", `${prefix}%`] },\r\n                        order_by: \"extension_req_no desc\",\r\n                        limit_page_length: 1\r\n                    },\r\n                    callback: function (r2) {\r\n                        if (r2.message && r2.message.length > 0) {\r\n                            let parts2 = r2.message[0].extension_req_no.split(\"/\");\r\n                            lastExtension = parseInt(parts2[2]);\r\n                        }\r\n\r\n                        // FINAL number\r\n                        let next = Math.max(lastRenewal, lastExtension) + 1;\r\n                        frm.set_value(\"extension_req_no\", prefix + next.toString().padStart(4, \"0\"));\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    },\r\n    \r\n    other_bonds(frm) {\r\n\r\n        if (frm.doc.deputyshreiff_bond === 1 && frm.doc.other_bonds === 1) {\r\n            frappe.msgprint('Please select only one type of bond.');\r\n            frm.set_value('deputyshreiff_bond', '0');\r\n            frm.set_value('other_bonds', '0');\r\n        }\r\n\r\n        var other_bonds = frm.doc.other_bonds;\r\n\r\n        if (other_bonds == 1) {\r\n frappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Bond Application',\r\n        filters: { workflow_state: \"Approved\" },\r\n        fields: ['facility_name'],\r\n        limit_page_length: 100000000\r\n    },\r\n    callback: function (response) {\r\n        let DataArray = response.message;\r\n\r\n        // Extract facility names\r\n        let FinalArray = DataArray.map(item => item.facility_name);\r\n\r\n        // Make values unique + sort alphabetically\r\n        FinalArray = [...new Set(FinalArray)].sort();\r\n\r\n        // Set dropdown options\r\n        frm.set_df_property('bond_holder2', 'options', FinalArray);\r\n    },\r\n    error: function (xhr, textStatus, errorThrown) {\r\n        console.error(\"Error fetching approved bonds:\", textStatus, errorThrown);\r\n    }\r\n});\r\n\r\n\r\n        } else {\r\n            let FinalArray = []\r\n            frm.set_df_property('bond_holder2', 'options', FinalArray);\r\n        }\r\n\r\n        if (other_bonds === 0) {\r\n            frm.set_value('bond_holder2', '');\r\n            frm.set_value('bond_no2', '');\r\n            frm.set_value('bond_extnreq_date', '');\r\n            frm.set_value('client', '');\r\n            frm.set_value('principal', '');\r\n            frm.set_value('project', '');\r\n            frm.set_value('description', '');\r\n            frm.set_value('bond_period_from', '');\r\n            frm.set_value('bond_period_to', '');\r\n            frm.set_value('bond_value', '');\r\n            frm.set_value('bond_type_1', '');\r\n            frm.set_value('new_bond_value', '');\r\n        }\r\n    },\r\n\r\n    deputyshreiff_bond(frm) {\r\n\r\n        if (frm.doc.deputyshreiff_bond === 1 && frm.doc.other_bonds === 1) {\r\n            frappe.msgprint('Please select only one type of bond.');\r\n            frm.set_value('deputyshreiff_bond', '0');\r\n            frm.set_value('other_bonds', '0');\r\n        }\r\n\r\n        var deputyshreiff = frm.doc.deputyshreiff_bond;\r\n\r\n        if (deputyshreiff === 1) {\r\n\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Deputy Sheriff Bond',\r\n                    filters: {},\r\n                    fields: ['sheriff_name'],\r\n                    limit_page_length: 1\r\n                },\r\n                callback: function (response) {\r\n                    let uniquedata = new Set(response.message.map(item => item.sheriff_name));\r\n                    let FinalArray = Array.from(uniquedata);\r\n                    \r\n                    FinalArray.sort();\r\n                    frm.set_df_property('bond_holder2', 'options', FinalArray);\r\n                },\r\n                error: function (xhr, textStatus, errorThrown) {\r\n                    console.error(\"Error fetching policy_holder:\", textStatus, errorThrown);\r\n                }\r\n            });\r\n\r\n        } else {\r\n            let FinalArray = []\r\n            frm.set_df_property('bond_holder2', 'options', FinalArray);\r\n\r\n            frm.set_value('bond_holder2', '');\r\n            frm.set_value('bond_no2', '');\r\n            frm.set_value('bond_period_from', '');\r\n            frm.set_value('description', '');\r\n            frm.set_value('bond_period_to', '');\r\n            frm.set_value('bond_value', '');\r\n            frm.set_value('client', '');\r\n            frm.set_value('principal', '');\r\n        }\r\n    },\r\n\r\n    bond_holder2: function (frm) {\r\n         frm.set_value('bond_holder', frm.doc.bond_holder2);\r\n        frm.set_value('bond_no2', '');\r\n        frm.set_value('bond_extnreq_date', '');\r\n        frm.set_value('client', '');\r\n        frm.set_value('principal', '');\r\n        frm.set_value('project', '');\r\n        frm.set_value('description', '');\r\n        frm.set_value('bond_period_from', '');\r\n        frm.set_value('bond_period_to', '');\r\n        frm.set_value('bond_value', '');\r\n        //frm.set_value('extension_req_no', '');\r\n        frm.set_value('bond_type_1', '');\r\n        frm.set_value('new_bond_value', '');\r\n\r\n        if (frm.doc.other_bonds == 1) {\r\n            frm.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Bond Application',\r\n                    filters: { facility_name: frm.doc.bond_holder2 },\r\n                    fields: ['bond_no']\r\n                },\r\n                callback: function (response) {\r\n                    console.log(response, 'Get the data');\r\n                    if (response.message && response.message.length > 0) {\r\n                        let DataArray = response.message;\r\n                        let FinalArray = DataArray.map(x => x.bond_no);\r\n                        frm.set_df_property('bond_no2', 'options', FinalArray);\r\n                    }\r\n                },\r\n                error: function (xhr, textStatus, errorThrown) {\r\n                    console.error(\"Error fetching details from Bond Application:\", textStatus, errorThrown);\r\n                }\r\n            });\r\n        }\r\n\r\n        if (frm.doc.deputyshreiff_bond == 1) {\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Deputy Sheriff Bond',\r\n                    filters: { sheriff_name: frm.doc.bond_holder2 },\r\n                    fields: ['bond_no'],\r\n                    limit_page_length: 0\r\n                },\r\n                callback: function (response) {\r\n                    console.log(\"Get the data\", response);\r\n                    if (response.message && response.message.length > 0) {\r\n                        let finalArray = response.message.map(x => x.bond_no);\r\n                        frm.set_df_property('bond_no2', 'options', finalArray.join('\\n'));\r\n                    } else {\r\n                        frappe.msgprint(\"No Bonds found for this Sheriff Name\");\r\n                        frm.set_df_property('bond_no2', 'options', []);\r\n                    }\r\n                },\r\n                error: function (xhr, textStatus, errorThrown) {\r\n                    console.error(\"Error fetching details:\", textStatus, errorThrown);\r\n                }\r\n            });\r\n        }\r\n    },\r\n\r\n    bond_no2(frm) {\r\n\r\n        var bondno = frm.doc.bond_no2;\r\n        frm.set_value('bond_no', bondno);\r\n\r\n        if (frm.doc.other_bonds == 1) {\r\n\r\n            frm.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Bond Application',\r\n                    filters: { bond_no: frm.doc.bond_no2 },\r\n                    fields: [\r\n                        'facility_name', 'bond_no', 'reg_date', 'bond_in_favour', 'project', 'description_contract',\r\n                        'period_from', 'to', 'amount_in_pula', 'reg_no', 'bond_type'\r\n                    ],\r\n                },\r\n                callback: function (response) {\r\n                    if (response.message && response.message.length > 0) {\r\n                        let bondDetails = response.message[0];\r\n                        frm.set_value('bond_extnreq_date', bondDetails.reg_date);\r\n                        frm.set_value('client', bondDetails.facility_name);\r\n                        frm.set_value('principal', bondDetails.bond_in_favour);\r\n                        frm.set_value('project', bondDetails.project);\r\n                        frm.set_value('description', bondDetails.description_contract);\r\n                        frm.set_value('bond_period_from', bondDetails.period_from);\r\n                        frm.set_value('bond_period_to', bondDetails.to);\r\n                        frm.set_value('bond_value', bondDetails.amount_in_pula);\r\n                        frm.set_value('bond_type_1', bondDetails.bond_type);\r\n                        frm.set_value('new_bond_value', bondDetails.amount_in_pula);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n\r\n        if (frm.doc.deputyshreiff_bond == 1) {\r\n            frm.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Deputy Sheriff Bond',\r\n                    filters: { bond_no: frm.doc.bond_no2 },\r\n                    fields: ['sheriff_name', 'bond_no', 'period_from', 'bond_value', 'description_of_contract', 'period_to']\r\n                },\r\n                callback: function (r) {\r\n                    if (r.message && r.message.length > 0) {\r\n                        var message = r.message[0];\r\n                        frm.set_value('bond_period_from', message.period_from);\r\n                        frm.set_value('description', message.description_of_contract);\r\n                        frm.set_value('bond_period_to', message.period_to);\r\n                        frm.set_value('bond_value', message.bond_value);\r\n                        frm.set_value('new_bond_value', message.bond_value);\r\n                        frm.set_value('client', message.sheriff_name);\r\n                        frm.set_value('principal', 'High Court');\r\n                        frm.set_value('bond_extnreq_date', message.period_from);\r\n                        frm.set_value('bond_type_1', 'DEPUTY SHERIFF BOND');\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    },\r\n\r\n\r\n});\r\n\r\n\r\nfunction handleFieldChange(frm, field, field1) {\r\n    return function () {\r\n        var value = frm.doc[field];\r\n        frm.doc[field1] = value;\r\n        frm.refresh_field(field1);\r\n    };\r\n}\r\n\r\n\r\n// function generateNumber(frm) {\r\n\r\n//     let currentYear = new Date().getFullYear();\r\n//     let prefix = `BRQ/${currentYear}/`;\r\n\r\n//     frappe.call({\r\n//         method: 'frappe.client.get_list',\r\n//         args: {\r\n//             doctype: 'Bond Extensions',\r\n//             fields: ['extension_req_no'],\r\n//             filters: { extension_req_no: ['like', `${prefix}%`] },\r\n//             limit_page_length: 1000,\r\n//             order_by: 'extension_req_no desc'\r\n//         },\r\n//         callback: function (r) {\r\n//             if (r.message && r.message.length > 0) {\r\n//                 let lastReviewNo = r.message[0].extension_req_no;\r\n//                 let parts = lastReviewNo.split(\"/\");\r\n//                 let lastNumber = parseInt(parts[2]) || 0;\r\n//                 let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n//                 frm.set_value('extension_req_no', prefix + newNumber);\r\n//             } else {\r\n//                 frm.set_value('extension_req_no', prefix + '0001');\r\n//             }\r\n//         }\r\n//     });\r\n// }\r\n\r\n\r\n\r\n\r\nfunction calculate_vat(frm) {\r\n\r\n    let guarantee_fee_rate = Number(frm.doc.guarantee_fee_rate) || 0;  // corrected field\r\n    let vat = Number(frm.doc.vat) || 0;\r\n\r\n    let vat_amount = (guarantee_fee_rate * vat) / 100;\r\n\r\n    // Always set 2 decimals\r\n    frm.set_value(\"v_at\", vat_amount.toFixed(2));\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Advance Premium",
  "enabled": 1,
  "modified": "2025-12-03 09:59:15.841682",
  "module": "UnderWriting",
  "name": "Advance Premium Script",
  "script": "frappe.ui.form.on('Advance Premium', {\r\n\r\n    refresh: function(frm) {\r\n        alignFieldsRight(frm, fieldsToAlignRight);\r\n\r\n        // policy_no visibility for new vs saved\r\n        if (frm.is_new()) {\r\n            frm.toggle_display('policy_no', true);\r\n            frm.toggle_display('policy_no1', false);\r\n        } else {\r\n            frm.toggle_display('policy_no', false);\r\n            frm.toggle_display('policy_no1', true);\r\n        }\r\n\r\n        // populate policy_holder options\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Policy Approvals',\r\n                fields: ['policy_holder'],\r\n                limit_page_length: 0\r\n            },\r\n            callback: function(response) {\r\n                if (response.message) {\r\n                    let uniquePolicyHolders = [\r\n                        ...new Set(response.message.map(item => item.policy_holder))\r\n                    ].sort();\r\n                    frm.set_df_property('policy_holder', 'options', uniquePolicyHolders.join('\\n'));\r\n                }\r\n            }\r\n        });\r\n\r\n        // make child table read-only\r\n        frm.set_df_property('child_table', 'cannot_add_rows', true);\r\n\r\n        // Show Submit button only if APPROVED and SAVED DOCUMENT\r\n        if (!frm.doc.__islocal && frm.doc.workflow_state === \"Approved\") {\r\n\r\n            frm.add_custom_button('Submit to Finance', function () {\r\n\r\n                // First check if invoice already created for this policy holder\r\n                frappe.call({\r\n                    method: \"frappe.client.get_list\",\r\n                    args: {\r\n                        doctype: \"Advance Premium Invoice\",\r\n                        filters: {\r\n                            policy_holder: frm.doc.policy_holder\r\n                        },\r\n                        fields: [\"name\"]\r\n                    },\r\n                    callback(r) {\r\n\r\n                        // If invoice exists \u2192 open the existing invoice\r\n                        if (r.message && r.message.length > 0) {\r\n                            frappe.set_route(\"Form\", \"Advance Premium Invoice\", r.message[0].name);\r\n                            return;\r\n                        }\r\n\r\n                        // If invoice does NOT exist \u2192 create NEW invoice with data passed\r\n                        frappe.flags._ap_data = {\r\n                            policy_holder: frm.doc.policy_holder,\r\n                            policy_no: frm.doc.policy_no,\r\n                            estimated_turnover_for_year: frm.doc.estimated_turnover_for_year,\r\n                            comments: frm.doc.comments,\r\n                            date: frm.doc.date,\r\n                            premium_rate: frm.doc.premium_rate,\r\n                            premium_amount: frm.doc.estimated_premium,\r\n                            total_amount: frm.doc.total_amount,\r\n                            invoice_amount: frm.doc.invoice_amount,\r\n                            advance_amount: frm.doc.advance_premium,\r\n                            premium_adjusted_amount: frm.doc.total_amount\r\n                        };\r\n\r\n                        frappe.new_doc(\"Advance Premium Invoice\");\r\n                    }\r\n                });\r\n            }).addClass(\"btn-primary\");\r\n        }\r\n\r\n        // prevent selecting payment_type before months is selected\r\n        if (frm.fields_dict['payment_type'] && frm.fields_dict['payment_type'].$input) {\r\n            frm.fields_dict['payment_type'].$input.on('focus', function() {\r\n                if (!frm.doc.noof_months_for_the_purpose) {\r\n                    frappe.msgprint('Please select the No.of Months for the Purpose field first.');\r\n                    frm.set_value('payment_type', '');\r\n                }\r\n            });\r\n        }\r\n\r\n        // initial loads for NEW document\r\n        if (frm.doc.__islocal) {\r\n            fetchDataForNewDocument(frm);\r\n            fetchApprovedPolicyNumbers(frm);\r\n        }\r\n\r\n        frm.refresh_field('child_table');\r\n    },\r\n\r\n\r\n    onload: function(frm) {\r\n        if (!frm.doc.adv_premium_no) {\r\n            generateNumber(frm);\r\n        }\r\n        alignFieldsRight(frm, fieldsToAlignRight);\r\n    },\r\n\r\n    // ---- Inputs that trigger recalculation ----\r\n\r\n    invoice_amount: function(frm) {\r\n        // Premium Adjusted Amount (total_amount) = invoice_amount - advance_premium\r\n        let advance = Number(frm.doc.advance_premium) || 0;\r\n        let invoice = Number(frm.doc.invoice_amount) || 0;\r\n        frm.set_value('total_amount', (invoice - advance).toFixed(2));\r\n    },\r\n    estimated_turnover_for_year: function(frm) {\r\n        calculateEstimatedPremium(frm);\r\n    },\r\n\r\n    premium_rate: function(frm) {\r\n        calculateEstimatedPremium(frm);\r\n    },\r\n\r\n    // credit limit related changes\r\n    // credit_limit_fee: function(frm) {\r\n    //     calculateFeesAndInvoice(frm);\r\n    // },\r\n    credit_limit: function(frm) {\r\n        calculateFeesAndInvoice(frm);\r\n    },\r\n    credit_limit_enquiry_fee: function(frm) {\r\n        calculateFeesAndInvoice(frm);\r\n    },\r\n    credit_limits: function(frm) {\r\n        calculateFeesAndInvoice(frm);\r\n    },\r\n\r\n    // when payment type or months change -> update premium_charges and child table\r\n    payment_type: function(frm) {\r\n        timeCal(frm);\r\n        AdvancePremium(frm);\r\n        calculateFeesAndInvoice(frm);\r\n    },\r\n\r\n    noof_months_for_the_purpose: function(frm) {\r\n        // if months change, recalc payment split\r\n        if (frm.doc.payment_type) {\r\n            timeCal(frm);\r\n            AdvancePremium(frm);\r\n            calculateFeesAndInvoice(frm);\r\n        }\r\n    },\r\n\r\n    // advance_premium is always set from estimated_premium (Option A)\r\n    // we still recalc invoice when it changes indirectly\r\n    advance_premium: function(frm) {\r\n        calculateFeesAndInvoice(frm);\r\n    },\r\n\r\n    // keep add button behavior\r\n    add: function(frm) {\r\n        AdvancePremium(frm);\r\n    },\r\n\r\n    policy_holder: function(frm) {\r\n        if (frm.doc.policy_holder) {\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Policy Approvals',\r\n                    filters: { 'policy_holder': frm.doc.policy_holder },\r\n                    fields: ['policy_number']\r\n                },\r\n                callback: function(r) {\r\n                    if (r.message) {\r\n                        let options = r.message.map(policy => policy.policy_number);\r\n                        frm.set_df_property('policy_no', 'options', options.join('\\n'));\r\n                        frm.set_value('policy_no1', options.join(', '));\r\n                        frm.refresh_field('policy_no');\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    },\r\n\r\n    policy_no: function(frm) {\r\n        if (frm.doc.policy_no) {\r\n            frm.set_value('policy_no1', frm.doc.policy_no);\r\n        } else {\r\n            frm.set_value('policy_no1', '');\r\n        }\r\n        fetchPolicyData(frm);\r\n    },\r\n\r\n    after_save: function(frm) {\r\n        frm.toggle_display('policy_no', false);\r\n        frm.toggle_display('policy_no1', true);\r\n    }\r\n\r\n});\r\n\r\n// ---------------- Utility / Calculation Functions (cleaned) ----------------\r\n\r\n// function fetchDataForNewDocument(frm) {\r\n//     frappe.call({\r\n//         method: 'frappe.client.get',\r\n//         args: {\r\n//             doctype: 'DCI Quotation',\r\n//             filters: { client_name: frm.doc.policy_holder },\r\n//             fields: ['fee_for_cl_per_month','fee_per_enquiry']\r\n//         },\r\n//         callback: function(r) {\r\n//             if (r.message) {\r\n//                 //frm.set_value('credit_limit_fee', r.message.fee_for_cl_per_month || 0);\r\n//               // frm.set_value('credit_limit_enquiry_fee', r.message.fee_per_enquiry || 0);\r\n//                 calculateFeesAndInvoice(frm);\r\n//             }\r\n//         }\r\n//     });\r\n\r\n//     // frappe.call({\r\n//     //     method: 'frappe.client.get',\r\n//     //     args: { doctype: 'VAT', filters: {} },\r\n//     //     callback: function(r) {\r\n//     //         if (r.message) {\r\n//     //             frm.set_value('vat', r.message.vat || 0);\r\n//     //             calculateFeesAndInvoice(frm);\r\n//     //         }\r\n//     //     }\r\n//     // });\r\n// }\r\n\r\nfunction fetchApprovedPolicyNumbers(frm) {\r\n    // kept placeholder \u2013 left commented to avoid heavy calls; implement if needed\r\n}\r\n\r\nfunction fetchPolicyData(frm) {\r\n    var policyNo = frm.doc.policy_no;\r\n    if (!policyNo) return;\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Policy Approvals',\r\n            filters: { policy_number: policyNo },\r\n            fields: ['premium_rate']\r\n        },\r\n        callback: function(response) {\r\n            if (response.message && response.message.length > 0) {\r\n                var data = response.message[0];\r\n                frm.set_value('premium_rate', data.premium_rate || 0);\r\n                calculateEstimatedPremium(frm);\r\n            } else {\r\n                frm.set_value('premium_rate', 0);\r\n                calculateEstimatedPremium(frm);\r\n            }\r\n        },\r\n        error: function(err) {\r\n            console.error('Error fetching policy:', err);\r\n        }\r\n    });\r\n}\r\n\r\nfunction generateNumber(frm) {\r\n    if (!frm.doc.adv_premium_no) {\r\n        let currentYear = new Date().getFullYear();\r\n        let prefix = `ADV/${currentYear}/`;\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: { doctype: 'Advance Premium', fields: ['adv_premium_no', 'creation'], order_by: 'creation desc', limit: 1 },\r\n            callback: function(r) {\r\n                if (r.message && r.message.length > 0) {\r\n                    let last = r.message[0].adv_premium_no || '';\r\n                    let lastNumber = parseInt(last.split('/').pop()) || 0;\r\n                    let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n                    frm.set_value('adv_premium_no', prefix + newNumber);\r\n                } else {\r\n                    frm.set_value('adv_premium_no', prefix + '0001');\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\n// Calculate estimated premium and set advance_premium = estimated_premium (Option A)\r\nfunction calculateEstimatedPremium(frm) {\r\n    let est_turnover = Number(frm.doc.estimated_turnover_for_year) || 0;\r\n    let rate = Number(frm.doc.premium_rate) || 0;\r\n    let estimated_premium = (est_turnover * rate) / 100;\r\n\r\n    estimated_premium = parseFloat(estimated_premium.toFixed(2));\r\n    frm.set_value('estimated_premium', estimated_premium);\r\n\r\n    // Option A: advance_premium mirrors estimated_premium\r\n    frm.set_value('advance_premium', estimated_premium);\r\n\r\n    // After recalculating premium, recalc fees & invoice\r\n    calculateFeesAndInvoice(frm);\r\n}\r\n\r\n// // Calculate a, b and then invoice & total\r\n// function calculateFeesAndInvoice(frm) {\r\n//     // calculate a and b\r\n//     var credit_limit_fee = Number(frm.doc.credit_limit_fee) || 0;\r\n//     var credit_limit = Number(frm.doc.credit_limit) || 0;\r\n//     var credit_limit_enquiry_fee = Number(frm.doc.credit_limit_enquiry_fee) || 0;\r\n//     var credit_limits = Number(frm.doc.credit_limits) || 0;\r\n\r\n//     var a = credit_limit_fee * credit_limit;\r\n//     var b = credit_limit_enquiry_fee * credit_limits;\r\n\r\n//     a = parseFloat(a.toFixed(2));\r\n//     b = parseFloat(b.toFixed(2));\r\n\r\n//     frm.set_value('a', a);\r\n//     frm.set_value('b', b);\r\n\r\n//     // invoice & total calculation\r\n//     calculateInvoiceAndTotal(frm);\r\n// }\r\n\r\n// Core invoice & total calculation without circular dependencies\r\n// function calculateInvoiceAndTotal(frm) {\r\n//     // base_amount excludes the advance_premium so that final_total = invoice - advance\r\n//     var a = Number(frm.doc.a) || 0;\r\n//     var b = Number(frm.doc.b) || 0;\r\n//     var premium_charges = Number(frm.doc.premium_charges) || 0;\r\n//     var advance_premium = Number(frm.doc.advance_premium) || 0;\r\n//     var vat_percent = Number(frm.doc.vat) || 0;\r\n\r\n//     // base is what we will invoice (fees + premium_charges)\r\n//     var base_amount = a + b + premium_charges;\r\n\r\n//     var invoice_amount = base_amount + (base_amount * vat_percent / 100);\r\n//     invoice_amount = parseFloat(invoice_amount.toFixed(2));\r\n//     frm.set_value('invoice_amount', invoice_amount);\r\n\r\n//     // Final total after deducting advance_premium (per your rule)\r\n//     var final_total = invoice_amount - advance_premium;\r\n//     final_total = parseFloat(final_total.toFixed(2));\r\n//     frm.set_value('total_amount', final_total);\r\n// }\r\n\r\n// Populate child table with the three lines (premium, credit limit fee, enquiry fee)\r\n// function AdvancePremium(frm) {\r\n//     // ensure premium_charges is up to date\r\n//     var premium_charges = Number(frm.doc.premium_charges) || 0;\r\n//     var credit_limit_fee = Number(frm.doc.credit_limit_fee) || 0;\r\n//     var credit_limit_enquiry_fee = Number(frm.doc.credit_limit_enquiry_fee) || 0;\r\n//     var credit_limit = Number(frm.doc.credit_limit) || 0;\r\n//     var credit_limits = Number(frm.doc.credit_limits) || 0;\r\n\r\n//     // clear existing child table and repopulate\r\n//     if (frm.doc.child_table && frm.doc.child_table.length) {\r\n//         frm.clear_table('child_table');\r\n//     }\r\n\r\n//     // 1. Premium Charges\r\n//     let c1 = frappe.model.add_child(frm.doc, 'Advance Premium Child', 'child_table');\r\n//     frappe.model.set_value(c1.doctype, c1.name, 'description', 'Premium Charges');\r\n//     frappe.model.set_value(c1.doctype, c1.name, 'price', premium_charges);\r\n//     frappe.model.set_value(c1.doctype, c1.name, 'qty', 1);\r\n//     frappe.model.set_value(c1.doctype, c1.name, 'amount', premium_charges * 1);\r\n\r\n//     // 2. Credit Limit Fee\r\n//     let c2 = frappe.model.add_child(frm.doc, 'Advance Premium Child', 'child_table');\r\n//     frappe.model.set_value(c2.doctype, c2.name, 'description', 'Credit Limit Fee');\r\n//     frappe.model.set_value(c2.doctype, c2.name, 'price', credit_limit_fee);\r\n//     frappe.model.set_value(c2.doctype, c2.name, 'qty', credit_limit);\r\n//     frappe.model.set_value(c2.doctype, c2.name, 'amount', credit_limit_fee * credit_limit);\r\n\r\n//     // 3. Credit Limit Enquiry Fee\r\n//     let c3 = frappe.model.add_child(frm.doc, 'Advance Premium Child', 'child_table');\r\n//     frappe.model.set_value(c3.doctype, c3.name, 'description', 'Credit Limit Enquiry Fee');\r\n//     frappe.model.set_value(c3.doctype, c3.name, 'price', credit_limit_enquiry_fee);\r\n//     frappe.model.set_value(c3.doctype, c3.name, 'qty', credit_limits);\r\n//     frappe.model.set_value(c3.doctype, c3.name, 'amount', credit_limit_enquiry_fee * credit_limits);\r\n\r\n//     frm.refresh_field('child_table');\r\n// }\r\n\r\n// Compute premium_charges according to payment_type & months\r\n// function timeCal(frm) {\r\n//     let paymentType = frm.doc.payment_type;\r\n//     let paymentValue = 1;\r\n//     if (paymentType === 'Monthly') paymentValue = 1;\r\n//     else if (paymentType === 'Quarterly') paymentValue = 3;\r\n//     else if (paymentType === 'Half Yearly') paymentValue = 6;\r\n//     else if (paymentType === 'Yearly') paymentValue = 12;\r\n\r\n//     let estimatedPremium = Number(frm.doc.estimated_premium) || 0;\r\n//     let noofMonths = Number(frm.doc.noof_months_for_the_purpose) || 1;\r\n\r\n//     // guard against division by zero\r\n//     if (noofMonths === 0) noofMonths = 1;\r\n\r\n//     let value = (estimatedPremium * paymentValue) / noofMonths;\r\n//     value = parseFloat(value.toFixed(2));\r\n\r\n//     // set the periodic values\r\n//     frm.set_value('monthly_premium_value', paymentType === 'Monthly' ? value : (frm.doc.monthly_premium_value || 0));\r\n//     frm.set_value('quartely_premium_value', paymentType === 'Quarterly' ? value : (frm.doc.quartely_premium_value || 0));\r\n//     frm.set_value('half_yearly_premium_value', paymentType === 'Half Yearly' ? value : (frm.doc.half_yearly_premium_value || 0));\r\n//     frm.set_value('yearly_premium_value', paymentType === 'Yearly' ? value : (frm.doc.yearly_premium_value || 0));\r\n\r\n//     // set premium_charges (used in child table and invoice base)\r\n//     frm.set_value('premium_charges', value);\r\n// }\r\n\r\n// Align numeric fields to RHS\r\nlet fieldsToAlignRight = ['premium_rate',\r\n'estimated_turnover_for_year',\r\n'estimated_premium',\r\n'vat',\r\n'monthly_premium_value',\r\n'quartely_premium_value',\r\n'half_yearly_premium_value',\r\n'yearly_premium_value',\r\n'noof_months_for_the_purpose',\r\n'credit_limit_fee',\r\n'credit_limit',\r\n'credit_limits',\r\n'b',\r\n'a',\r\n'credit_limit_enquiry_fee'];\r\n\r\nfunction alignFieldsRight(frm, fields) {\r\n    fields.forEach(field => {\r\n        let fieldElement = frm.fields_dict[field];\r\n        if (fieldElement && fieldElement.input) {\r\n            fieldElement.input.style.direction = 'rtl';\r\n            fieldElement.input.style.textAlign = 'right';\r\n        }\r\n    });\r\n}\r\n\r\n// Hook alignment for realtime changes\r\nfieldsToAlignRight.forEach(field => {\r\n    frappe.ui.form.on('Advance Premium', field, function(frm) { alignFieldsRight(frm, [field]); });\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Premium",
  "enabled": 1,
  "modified": "2024-03-18 10:15:18.996429",
  "module": null,
  "name": "Premium_amounts",
  "script": "frappe.ui.form.on('Premium', {\n    // onload: function(frm) {\n    //     // Set default value for min_premium field\n    //     if (!frm.doc.min_premium) {\n    //         frm.set_value('min_premium', 18000); // Set your default value here\n    //     }\n    //     // if (!frm.doc.max_premium) {\n    //     //     frm.set_value('min_premium', 100); // Set your default value here\n    //     // }\n        \n    // }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Next Extension",
  "enabled": 1,
  "modified": "2024-05-05 05:45:41.064730",
  "module": null,
  "name": "Next Extension",
  "script": "function  prepare_invoices(frm) {\r\n    console.log(\"hii\");\r\n    console.log('bondholder2',frm.doc.bond_holder)\r\n    if (frm.doc.bond_holder) {\r\n        if (frm.doc.other_bonds === 1 && frm.doc.deputyshreiff_bond === 1) {\r\n            frappe.msgprint('Please select only one type of bond.');\r\n        } \r\n        else if (frm.doc.other_bonds === 1) {\r\n            console.log('calling Api')\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Bond Application',\r\n                    filters: {\r\n                        facility_name: frm.doc.bond_holder\r\n                    },\r\n                    fields: ['beci_ref_number', 'guarantee_amount', 'guarantee_fee','month', 'guarantee_fee_p', 'reinsurer', 'beci_commission_p', 'reinsurer_commissions', 'reinsurer_refnumber', 'portion_of_guarantee_guarantee_vat_p', 'portion_of_guarantee_to_beci', 'reinsurer_portion_of_guarantee_fee_p', 'beci_portion_of_gurantee_amount_p', 'beci_commission', 'beci_commission_p', 'vat', 'reinsurer_commissions', 'reinsurer_refnumber']\r\n                },\r\n                callback: function(r) {\r\n                    console.log(r, 'hello');\r\n                    let extensionData = r.message[0];\r\n                    // Check if bond_holder is defined and not empty\r\n                    if (frm.doc.bond_holder) {\r\n                        frappe.model.with_doctype('Prepare Invoice', function() {\r\n                            var doc = frappe.model.get_new_doc('Prepare Invoice');\r\n                            doc.bond_holder = frm.doc.bond_holder;\r\n                            doc.bond_no = frm.doc.bond_no;\r\n                            doc.bondextentreq_date = frm.doc.bond_extnreq_date;\r\n                            doc.client = frm.doc.client;\r\n                            doc.principal = frm.doc.principal;\r\n                            doc.project = frm.doc.project;\r\n                            doc.description = frm.doc.description;\r\n                            doc.bond_period_from = frm.doc.bond_period_from;\r\n                            doc.bond_period_to = frm.doc.bond_period_to;\r\n                            doc.bond_value = frm.doc.bond_value;\r\n                            doc.extension_req_no = frm.doc.extension_req_no;\r\n                            doc.bondtype1 = frm.doc.bond_type_1;\r\n                            doc.month = extensionData.month;\r\n                            doc.beci_ref_no = extensionData.beci_ref_number;\r\n                            doc.guarantee_amount = extensionData.guarantee_amount;\r\n                            doc.guarantee_fee = extensionData.guarantee_fee;\r\n                            doc.guarantee_fee1 = extensionData.guarantee_fee_p;\r\n                            doc.reinsure = extensionData.reinsurer;\r\n                            doc.portion_of_guarantee_amount_to_reinsurer = extensionData.portion_of_guarantee_guarantee_vat_p;\r\n                            doc.portion_of_guarantee_amount_to_beci = extensionData.portion_of_guarantee_to_beci;\r\n                            doc.portion_of_guarantee_fee_to_reinsurer = extensionData.portion_of_guarantee_guarantee_vat_p;\r\n                            doc.portion_of_guarantee_fee_to_beci = extensionData.portion_of_guarantee_to_beci;\r\n                            doc.beci_commission = extensionData.beci_commission;\r\n                            doc.beci_commission_ = extensionData.beci_commission_p;\r\n                            doc.vat = extensionData.vat;\r\n                            doc.total = extensionData.guarantee_fee_p;\r\n                            doc.reinsurer_ = extensionData.reinsurer_commissions;\r\n                            doc.reinsurer_ref_number = extensionData.reinsurer_refnumber;\r\n                            // Calculate vat1 based on vat and guarantee_fee_p\r\n                            doc.vat1 = ((extensionData.vat + extensionData.guarantee_fee_p) / 100).toFixed(2);\r\n                            doc.total_due_with_vat = (parseFloat(extensionData.guarantee_fee_p) + parseFloat(doc.vat1)).toFixed(2);\r\n                            console.log(\"total_due_with_vat:\", doc.total_due_with_vat);\r\n                            \r\n                            // Set other_bonds flag\r\n                            doc.other_bonds = frm.doc.other_bonds;\r\n                            \r\n                            //Save the current document before navigating to the next doctype\r\n                            frappe.call({\r\n                                method: 'frappe.client.insert',\r\n                                args: {\r\n                                    doc: doc\r\n                                },\r\n                                callback: function(response) {\r\n                                    if (!response.exc) {\r\n                                        frappe.set_route('Form', 'Prepare Invoice', response.message.name);\r\n                                    }\r\n                                }\r\n                            });\r\n                        });\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    \r\n  else if (frm.doc.deputyshreiff_bond === 1) {\r\n    console.log('deputyshreiff_bond');\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Deputy Sheriff Bond',\r\n            filters: {\r\n                bond_no: frm.doc.beci_ref_no\r\n            },\r\n           \r\n        },\r\n        callback: function(r) {\r\n            console.log(r, 'hello');\r\n            if (r.message && r.message.length > 0) {\r\n                // let extensionData = r.message[0];\r\n               \r\n                // Check if bond_holder is defined and not empty\r\n                if (frm.doc.bond_holder) {\r\n                    frappe.model.with_doctype('Prepare Invoice', function() {\r\n                        var doc = frappe.model.get_new_doc('Prepare Invoice');\r\n                        doc.bond_holder = frm.doc.bond_holder;\r\n                        doc.bond_no = frm.doc.bond_no;\r\n                        doc.bondextentreq_date = frm.doc.bond_extnreq_date;\r\n                        doc.client = frm.doc.client;\r\n                        doc.principal = frm.doc.principal;\r\n                        doc.project = frm.doc.project;\r\n                        doc.description = frm.doc.description;\r\n                        doc.bond_period_from = frm.doc.bond_period_from;\r\n                        doc.bond_period_to = frm.doc.bond_period_to;\r\n                        doc.bond_value = frm.doc.bond_value;\r\n                        doc.extension_req_no = frm.doc.extension_req_no;\r\n                        doc.bondtype1 = frm.doc.bond_type_1;\r\n                        \r\n\r\n                        // Fetch data from another doctype\r\n                        frappe.call({\r\n                            method: 'frappe.client.get_list',\r\n                            args: {\r\n                                doctype: 'Deputy Sheriff Prepare Invoice',\r\n                                filters: {\r\n                                    ecgc_refno: frm.doc.beci_ref_no\r\n                                },\r\n                                fields: ['ecgc_refno', 'guarantee_amount', 'month','guarantee_fee_rate','reinsure','date','reinsurer_ref_number','reinsurer_','portion_of_guarantee_amount_to_reinsurer','portion_of_guarantee_fee_to_reinsurer','ecgc_comission_','broker','broker_','broker_commission','total_due_with_out_vat','vat_','vat','total_due','invoice_date','bond_period_to','guarantee_fee','ecgc_','portion_of_guarantee_amount_to_ecgc','portion_of_guarantee_fee_to_ecgc','ecgc_commission']\r\n                            },\r\n                            callback: function(response) {\r\n                                if (response.message && response.message.length > 0) {\r\n                                    console.log(response.message,\"response data\")\r\n                                    let prepareInvoiceData = response.message[0];\r\n                                    console.log(prepareInvoiceData,'deputy shireff prepare invoice data')\r\n                                    doc.beci_ref_no = prepareInvoiceData.ecgc_refno;\r\n                                    doc.guarantee_amount = prepareInvoiceData.guarantee_amount;\r\n                                    doc.month = prepareInvoiceData.month;\r\n                                    doc.guarantee_fee= prepareInvoiceData.guarantee_fee_rate;\r\n                                    doc.reinsure = prepareInvoiceData.reinsure;\r\n                                    doc.bond_period_from =prepareInvoiceData.date;\r\n                                    doc.reinsurer_ref_number =prepareInvoiceData.reinsurer_ref_number;\r\n                                    doc.reinsurer_ =prepareInvoiceData.reinsurer_;\r\n                                    doc.portion_of_guarantee_amount_to_reinsurer =prepareInvoiceData.portion_of_guarantee_amount_to_reinsurer;\r\n                                    doc.portion_of_guarantee_fee_to_reinsurer   = prepareInvoiceData.portion_of_guarantee_fee_to_reinsurer;\r\n                                    doc.beci_commission_ =prepareInvoiceData.ecgc_comission_;\r\n                                    doc.broker =prepareInvoiceData.broker;\r\n                                    doc.broker_ =prepareInvoiceData.broker_;\r\n                                    doc.broker_commission =prepareInvoiceData.broker_commission;\r\n                                    doc.total  = prepareInvoiceData.total_due_with_out_vat;\r\n                                    doc.vat = prepareInvoiceData.vat_;\r\n                                    doc.vat1 = prepareInvoiceData.vat;\r\n                                    doc.total_due_with_vat =prepareInvoiceData.total_due;\r\n                                    doc.invoice_date =prepareInvoiceData.invoice_date;\r\n                                    doc.bond_period_to =prepareInvoiceData.bond_period_to;\r\n                                    doc.guarantee_fee1 =prepareInvoiceData.guarantee_fee;\r\n                                    doc.beci_ =prepareInvoiceData.ecgc_;\r\n                                    doc.portion_of_guarantee_amount_to_beci =prepareInvoiceData.portion_of_guarantee_amount_to_ecgc;\r\n                                    doc.portion_of_guarantee_fee_to_beci =prepareInvoiceData.portion_of_guarantee_fee_to_ecgc;\r\n                                    doc.beci_commission = prepareInvoiceData.ecgc_commission;\r\n                                    doc.deputy_shreiff_bond = frm.doc.deputyshreiff_bond;\r\n                                } else {\r\n                                    console.log(\"No Deputy Sheriff Prepare Invoice found for the given criteria.\");\r\n                                }\r\n\r\n                                // Save the current document before navigating to the next doctype\r\n                                frappe.call({\r\n                                    method: 'frappe.client.insert',\r\n                                    args: {\r\n                                        doc: doc\r\n                                    },\r\n                                    callback: function(response) {\r\n                                        if (!response.exc) {\r\n                                            frappe.set_route('Form', 'Prepare Invoice', response.message.name);\r\n                                        }\r\n                                    }\r\n                                });\r\n                            }\r\n                        });\r\n                    });\r\n                }\r\n            } else {\r\n                console.log(\"No Deputy Sheriff Bond found for the given sheriff name.\");\r\n            }\r\n        }\r\n    });\r\n}\r\n}\r\n\r\n}\r\n\r\n    \r\n\r\nfrappe.ui.form.on('Next Extension', {\r\n    refresh(frm){\r\n        \r\n        if (frm.doc.workflow_state === 'Approved') {\r\n             frm.add_custom_button(__('Prepare Invoice'), function() {\r\n            prepare_invoices(frm)\r\n\r\n        }).addClass(\"btn-primary\");\r\n        } \r\n        \r\n    },\r\n  \r\n//   prepare_invoice: function(frm) {\r\n//     console.log(\"hii\");\r\n//     console.log('bondholder2',frm.doc.bond_holder)\r\n//     if (frm.doc.bond_holder) {\r\n//         if (frm.doc.other_bonds === 1 && frm.doc.deputyshreiff_bond === 1) {\r\n//             frappe.msgprint('Please select only one type of bond.');\r\n//         } \r\n//         else if (frm.doc.other_bonds === 1) {\r\n//             console.log('calling Api')\r\n//             frappe.call({\r\n//                 method: 'frappe.client.get_list',\r\n//                 args: {\r\n//                     doctype: 'Bond Application',\r\n//                     filters: {\r\n//                         facility_name: frm.doc.bond_holder\r\n//                     },\r\n//                     fields: ['beci_ref_number', 'guarantee_amount', 'month', 'guarantee_fee', 'guarantee_fee_p', 'reinsurer', 'beci_commission_p', 'reinsurer_commissions', 'reinsurer_refnumber', 'portion_of_guarantee_guarantee_vat_p', 'portion_of_guarantee_to_beci', 'reinsurer_portion_of_guarantee_fee_p', 'beci_portion_of_gurantee_amount_p', 'beci_commission', 'beci_commission_p', 'vat', 'reinsurer_commissions', 'reinsurer_refnumber']\r\n//                 },\r\n//                 callback: function(r) {\r\n//                     console.log(r, 'hello');\r\n//                     let extensionData = r.message[0];\r\n//                     // Check if bond_holder is defined and not empty\r\n//                     if (frm.doc.bond_holder) {\r\n//                         frappe.model.with_doctype('Prepare Invoice', function() {\r\n//                             var doc = frappe.model.get_new_doc('Prepare Invoice');\r\n//                             doc.bond_holder = frm.doc.bond_holder;\r\n//                             doc.bond_no = frm.doc.bond_no;\r\n//                             doc.bondextentreq_date = frm.doc.bond_extnreq_date;\r\n//                             doc.client = frm.doc.client;\r\n//                             doc.principal = frm.doc.principal;\r\n//                             doc.project = frm.doc.project;\r\n//                             doc.description = frm.doc.description;\r\n//                             doc.bond_period_from = frm.doc.bond_period_from;\r\n//                             doc.bond_period_to = frm.doc.bond_period_to;\r\n//                             doc.bond_value = frm.doc.bond_value;\r\n//                             doc.extension_req_no = frm.doc.extension_req_no;\r\n//                             doc.bondtype1 = frm.doc.bond_type_1;\r\n//                             doc.beci_ref_no = extensionData.beci_ref_number;\r\n//                             doc.guarantee_amount = extensionData.guarantee_amount;\r\n//                             doc.month = extensionData.month;\r\n//                             doc.guarantee_fee = extensionData.guarantee_fee;\r\n//                             doc.guarantee_fee1 = extensionData.guarantee_fee_p;\r\n//                             doc.reinsure = extensionData.reinsurer;\r\n//                             doc.portion_of_guarantee_amount_to_reinsurer = extensionData.portion_of_guarantee_guarantee_vat_p;\r\n//                             doc.portion_of_guarantee_amount_to_beci = extensionData.portion_of_guarantee_to_beci;\r\n//                             doc.portion_of_guarantee_fee_to_reinsurer = extensionData.portion_of_guarantee_guarantee_vat_p;\r\n//                             doc.portion_of_guarantee_fee_to_beci = extensionData.portion_of_guarantee_to_beci;\r\n//                             doc.beci_commission = extensionData.beci_commission;\r\n//                             doc.beci_commission_ = extensionData.beci_commission_p;\r\n//                             doc.vat = extensionData.vat;\r\n//                             doc.total = extensionData.guarantee_fee_p;\r\n//                             doc.reinsurer_ = extensionData.reinsurer_commissions;\r\n//                             doc.reinsurer_ref_number = extensionData.reinsurer_refnumber;\r\n//                             // Calculate vat1 based on vat and guarantee_fee_p\r\n//                             doc.vat1 = ((extensionData.vat + extensionData.guarantee_fee_p) / 100).toFixed(2);\r\n//                             doc.total_due_with_vat = (parseFloat(extensionData.guarantee_fee_p) + parseFloat(doc.vat1)).toFixed(2);\r\n//                             console.log(\"total_due_with_vat:\", doc.total_due_with_vat);\r\n                            \r\n//                             // Set other_bonds flag\r\n//                             doc.other_bonds = frm.doc.other_bonds;\r\n                            \r\n//                             //Save the current document before navigating to the next doctype\r\n//                             frappe.call({\r\n//                                 method: 'frappe.client.insert',\r\n//                                 args: {\r\n//                                     doc: doc\r\n//                                 },\r\n//                                 callback: function(response) {\r\n//                                     if (!response.exc) {\r\n//                                         frappe.set_route('Form', 'Prepare Invoice', response.message.name);\r\n//                                     }\r\n//                                 }\r\n//                             });\r\n//                         });\r\n//                     }\r\n//                 }\r\n//             });\r\n//         }\r\n    \r\n//  else if (frm.doc.deputyshreiff_bond === 1) {\r\n//     console.log('deputyshreiff_bond');\r\n//     frappe.call({\r\n//         method: 'frappe.client.get_list',\r\n//         args: {\r\n//             doctype: 'Deputy Sheriff Bond',\r\n//             filters: {\r\n//                 sheriff_name: frm.doc.bond_holder\r\n//             },\r\n//             fields: ['reinsurer', 'reinsurer_ref_numbeecgc_invoice_no', 'reinsurer_rate', 'broker']\r\n//         },\r\n//         callback: function(r) {\r\n//             console.log(r, 'hello');\r\n//             if (r.message && r.message.length > 0) {\r\n//                 let extensionData = r.message[0];\r\n//                 // Check if bond_holder is defined and not empty\r\n//                 if (frm.doc.bond_holder) {\r\n//                     frappe.model.with_doctype('Prepare Invoice', function() {\r\n//                         var doc = frappe.model.get_new_doc('Prepare Invoice');\r\n//                         doc.bond_holder = frm.doc.bond_holder;\r\n//                         doc.bond_no = frm.doc.bond_no;\r\n//                         doc.bondextentreq_date = frm.doc.bond_extnreq_date;\r\n//                         doc.client = frm.doc.client;\r\n//                         doc.principal = frm.doc.principal;\r\n//                         doc.project = frm.doc.project;\r\n//                         doc.description = frm.doc.description;\r\n//                         doc.bond_period_from = frm.doc.bond_period_from;\r\n//                         doc.bond_period_to = frm.doc.bond_period_to;\r\n//                         doc.bond_value = frm.doc.bond_value;\r\n//                         doc.extension_req_no = frm.doc.extension_req_no;\r\n//                         doc.bondtype1 = frm.doc.bond_type_1;\r\n//                         doc.reinsure = extensionData.reinsurer;\r\n//                         doc.reinsurer_ref_number = extensionData.reinsurer_ref_numbeecgc_invoice_no;\r\n//                         doc.reinsurer_rate = extensionData.reinsurer_rate;\r\n//                         doc.broker = extensionData.broker;\r\n//                         doc.deputy_shreiff_bond = frm.doc.deputyshreiff_bond;\r\n\r\n                        \r\n//                           frappe.call({\r\n//                         method: 'frappe.client.get_list',\r\n//                         args: {\r\n//                             doctype: 'Deputy Sheriff Prepare Invoice',\r\n//                             filters: {\r\n//                               ecgc_refno: \"beci_ref_no\"\r\n//                             },\r\n//                             fields: ['ecgc_refno', 'guarantee_amount','month'] \r\n//                         },\r\n//                         callback: function(response) {\r\n//                             if (response.message && response.message.length > 0) {\r\n//                                 let prepareInvoiceData = response.message[0];\r\n//                                 doc.beci_ref_no = prepareInvoiceData.ecgc_refno;\r\n//                                 doc.guarantee_amount = prepareInvoiceData.guarantee_amount;\r\n//                                 // doc.month = prepareInvoiceData.month;\r\n//                             } else {\r\n//                                 console.log(\"No Deputy Sheriff Prepare Invoice found for the given criteria.\");\r\n//                             }\r\n//                         }\r\n//                     }); \r\n                        \r\n                        \r\n                        \r\n                        \r\n//                         // Save the current document before navigating to the next doctype\r\n//                         frappe.call({\r\n//                             method: 'frappe.client.insert',\r\n//                             args: {\r\n//                                 doc: doc\r\n//                             },\r\n//                             callback: function(response) {\r\n//                                 if (!response.exc) {\r\n//                                     frappe.set_route('Form', 'Prepare Invoice', response.message.name);\r\n//                                 }\r\n//                             }\r\n//                         });\r\n//                     });\r\n\r\n//                     // Now, make another call to get data from another doctype\r\n                    \r\n//                 }\r\n//             } else {\r\n//                 console.log(\"No Deputy Sheriff Bond found for the given sheriff name.\");\r\n//             }\r\n//         }\r\n//     });\r\n// }\r\n\r\n\r\n//     }\r\n//   }\r\n    })\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n    \r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "DeputySheriffBond_Details",
  "enabled": 1,
  "modified": "2024-07-03 09:38:17.736117",
  "module": null,
  "name": "DSFchg",
  "script": "frappe.ui.form.on('DeputySheriffBond_Details', {\n   \tonload:function(frm){\n\t    reinsureload(frm);\n\t    sheriffnameload(frm);\n\t    if(!frm.doc.bondno)\n\t    {\n\t        generateBondNumber(frm);\n\t    }\n\t}, \n\trefresh(frm) {\n\n\t},\n\t\n\t//To call another Doctype\n\taddnew(frm)\n\t{\n\t    frappe.set_route('Form','DeputySheriffBond');\n\t},\n});\n\n//Automatic generation of bondno)\nfunction generateBondNumber(frm) {\n    var currentYear = new Date().getFullYear();\n    \n    frappe.call({\n        method: 'frappe.client.get_value',\n        args: {\n            'doctype': 'DeputySheriffBond_Details',\n            'filters': {\n                'bondno': currentYear.toString() // Assuming bondno is a data type field storing the year\n            },\n            'fieldname': 'bondno',\n            'order_by': 'creation',\n            'sort_order': 'desc'\n        },\n        callback: function(response) {\n            var lastBondNo = response.message.bondno;\n            var currentCounter = lastBondNo ? parseInt(lastBondNo.split('/')[2]) + 1 : 1;\n            var newBondNo = 'BND/' + currentYear + '/' + ('000' + currentCounter).slice(-4);\n            frm.set_value('bondno', newBondNo);\n            frm.fields_dict.bondvalue.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.premiumwithoutvat.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.invoiceno.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.commission.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.premiumrate.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.reinsureamt.$input.css(\"text-align\", \"right\");\n             frm.fields_dict.ecgc_ref_no.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.guarentee_amount.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.month.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.guarentee_fee_rate.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.reinsure1.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.reinsurer_ref_number.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.portion_of_guarentee_amount_to_reinsurer.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.portion_of_guarentee_feeto_reinsurer.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.ecgc_commission.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.total_due_with_out_vat.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.vat.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.vat1.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.total_due.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.guarentee_fee.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.ecgc.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.portion_of_guarentee_amount_to_ecgc.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.portion_of_guarentee_fee_to_ecgc.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.ecgc1.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.broker_commission.$input.css(\"text-align\", \"right\");\n           \n \n\n        }\n    });\n}\n\n\n\n//To load the ReInsure Name \nfunction reinsureload(frm) {\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'ReInsurers_Details',\n            fields: ['reinsurename']\n        },\n        callback: function(response) {\n            if (response.message) {\n                var options = [];\n                $.each(response.message, function(i, item) {\n                    options.push( item.reinsurename);\n                });\n                frm.set_df_property('reinsure', 'options', options);\n            }\n        }\n    });\n}\n\n\n\n//To load the sheriff Name \nfunction sheriffnameload(frm) {\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'DeputySheriffBond',\n            fields: ['sheriffname']\n        },\n        callback: function(response) {\n            if (response.message) {\n                var options = [];\n                $.each(response.message, function(i, item) {\n                    options.push( item.sheriffname);\n                });\n                frm.set_df_property('dsheriffname', 'options', options);\n            }\n        }\n    \n    });\n}\n\n\nfrappe.ui.form.on('DeputySheriffBond_Details', {\n\n    bondvalue: function(frm) {\n\n        calculateResult(frm);\n\n    },\n\n    premium: function(frm) {\n\n        calculateResult(frm);\n\n    }\n\n});\n \nfunction calculateResult(frm) {\n\n    var bondvalue = frm.doc.bondvalue || 0; // Get the value of field1, default to 0 if empty\n\n    var premium = frm.doc.premium || 0; // Get the value of field2, default to 0 if empty\n\n    var result = bondvalue * premium; // Calculate the result\n \n    frm.set_value('premiumwithoutvat', result); // Set the calculated result to result_field\n    \n}\n\nfrappe.ui.form.on('DeputySheriffBond_Details', {\n\n    premiumwithoutvat: function(frm) {\n\n        calculateResults(frm);\n\n    },\n\n   \n\n});\n \nfunction calculateResults(frm) {\n\n    var premiumwithoutvat = frm.doc.premiumwithoutvat || 0; // Get the value of field1, default to 0 if empty\n\n    var results = premiumwithoutvat * 0.14; // Calculate the results\n \n    frm.set_value('premiumrate', results); // Set the calculated result to result_field\n\n    \n}\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Insured_Main",
  "enabled": 0,
  "modified": "2024-04-24 13:44:45.686381",
  "module": "Insured_Module",
  "name": "Insured Main Script",
  "script": "frappe.ui.form.on('Insured_Main', {\nonload(frm) {\n        let query = {};\n \n        if (frm.doc.short_name) {\n            query.short_name = frm.doc.short_name;\n        }\n        if (frm.doc.insured) {\n            query.name1 = frm.doc.insured;\n        }\n      \n        // Call to fetch data\n        frm.call({\n            method: \"frappe.client.get_list\",\n            args: {\n                doctype: \"Insured_Details\",\n                filters: query,\n                fields: [\"short_name\", \"name1\", \"contact_person\", \"telephone\",\"postal_address\",\"location\",\"physical_address\",\"location1\",\"fax\",\"status\",\"country\",\"vat_registration_no\",\"e_mail\"]\n            },\n            callback: function(r) {\n                console.log(r, \"hello\");\n                frm.doc.Search_Results = [];\n                frm.refresh_field('childtable');\n                var data = r.message;\n                for (let x of data) {\n                    var child = frappe.model.add_child(frm.doc, \"Insured_Child\", \"childtable\");\n                    console.log(child, \"s\")\n \n                    // Add a new row to the \"Search_Results\" child table\n                    frappe.model.set_value(child.doctype, child.name, \"short_name\", x.short_name);\n                    frappe.model.set_value(child.doctype, child.name, \"name1\", x.name1);\n                    frappe.model.set_value(child.doctype, child.name, \"contact_person\", x.contact_person);\n                    frappe.model.set_value(child.doctype, child.name, \"telephone\", x.telephone);\n                    frappe.model.set_value(child.doctype, child.name, \"postal_address\", x.postal_address);\n                    frappe.model.set_value(child.doctype, child.name, \"location\", x.location);\n                    frappe.model.set_value(child.doctype, child.name, \"physical_address\", x.physical_address);\n                    frappe.model.set_value(child.doctype, child.name, \"location1\", x.location1);\n                    frappe.model.set_value(child.doctype, child.name, \"fax\", x.fax);\n                    frappe.model.set_value(child.doctype, child.name, \"status\", x.status);\n                    frappe.model.set_value(child.doctype, child.name, \"country\", x.country);\n                    frappe.model.set_value(child.doctype, child.name, \"vat_registration_no\", x.vat_registration_no);\n                    frappe.model.set_value(child.doctype, child.name, \"e_mail\", x.e_mail);\n                }\n \n                // Refresh the form to display the updated child table\n                frm.refresh_fields('childtable');\n \n                console.log(data); // Corrected variable name\n            }\n        });\n \n        frappe.validated = false;\n    },\n    // Refresh the form after clearing the child table\n    \n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Single Buyer CL Processing",
  "enabled": 0,
  "modified": "2025-11-07 13:04:06.840220",
  "module": "UnderWriting",
  "name": "filter_approved",
  "script": "frappe.ui.form.on('Single Buyer CL Processing', {\r\n   \r\n// refresh: function(frm){\r\n//         var workflowState = frm.doc.workflow_state;\r\n//       if (frm.doc.yes) {\r\n//         if (workflowState === \"Pending\" || workflowState === \"Approved\") {\r\n//             frm.add_custom_button(__('View CB Report'), function() {\r\n//             frappe.call({\r\n//              method: \"frappe.client.get\",\r\n//             args: {\r\n//             doctype: \"CB Report\",\r\n//             filters: {\r\n//                 buyer: frm.doc.buyer,\r\n//                 refnumber: frm.doc.cl_check_no,\r\n//             },\r\n//             fields: [\"cb_request_number\", \"reqdate\", \"buyer\", \"refnumber\", \"date\", \"catagory\", \"code\", \"details\", \"description\"]\r\n//         },\r\n//         callback: function (r) {\r\n//             if (!r.exc) {\r\n//                 var cbReportData = r.message;\r\n//                 if (cbReportData) {\r\n//                     // Open prompt dialog only if data is found\r\n//                     frappe.prompt([\r\n//                         {'fieldname': 'credit_bureau_request', 'fieldtype': 'Heading', 'label': 'Credit Bureau Request'},\r\n//                         {'fieldname': 'section_break_2','fieldtype': 'Section Break','label': ''},\r\n//                         {'fieldname': 'cb_request_number', 'fieldtype': 'Data', 'label': 'CB Req Number', 'default': cbReportData.cb_request_number},\r\n//                         {'fieldname': 'reqdate', 'fieldtype': 'Date', 'label': 'Req.Date', 'default': cbReportData.reqdate},\r\n//                         {'fieldname': 'buyer', 'fieldtype': 'Data', 'label': 'Buyer', 'default': cbReportData.buyer},\r\n//                         {'fieldname': 'column_break_1','fieldtype': 'Column Break','label': ''},\r\n//                         {'fieldname': 'refnumber', 'fieldtype': 'Data', 'label': 'Ref.Number','default': cbReportData.refnumber},\r\n//                         {'fieldname': 'section_break_3','fieldtype': 'Section Break','label': ''},\r\n//                         {'fieldname': 'section_break_4','fieldtype': 'Section Break','label': ''},\r\n//                         {'fieldname': 'credit_bureau_responce', 'fieldtype': 'Heading', 'label': 'Credit Bureau Response'},\r\n//                         {'fieldname': 'section_break_5','fieldtype': 'Section Break','label': ''},\r\n//                         {'fieldname': 'date', 'fieldtype': 'Date', 'label': 'Date', 'default': cbReportData.date},\r\n//                         {'fieldname': 'catagory', 'fieldtype': 'Data', 'label': 'Category', 'default': cbReportData.catagory},\r\n//                         {'fieldname': 'code', 'fieldtype': 'Data', 'label': 'Code',  'default': cbReportData.code},\r\n//                         {'fieldname': 'column_break_2','fieldtype': 'Column Break','label': ''},\r\n//                         {'fieldname': 'details', 'fieldtype': 'Data', 'label': 'Details',  'default': cbReportData.details},\r\n//                         {'fieldname': 'description', 'fieldtype': 'Small Text', 'label': 'Description', 'default': cbReportData.description},\r\n//                     ], function(values){\r\n//                         // Handle user input if needed\r\n//                     }, 'CB Report');\r\n//                 } else {\r\n//                      frappe.msgprint(\"No CB Report data found for the selected buyer and credit limit number.\");\r\n//                      //frappe.msgprint(\"CB Report is not Available for this Buyer\");\r\n\r\n//                 }\r\n//             } else {\r\n//                 console.error(\"Error occurred while fetching CB Report data:\", r.exc);\r\n//                  frappe.msgprint(\"Error occurred while fetching CB Report data. Please try again.\");\r\n//             }\r\n//         }\r\n//     });   \r\n\r\n\r\n//             }).addClass(\"btn-primary\");\r\n//         }\r\n//          }\r\n\r\n              \r\n \r\n//         if(frm.doc.yes){\r\n//         if (workflowState === \"Pending\" || workflowState === \"Approved\") {\r\n//             frm.toggle_display('cbreport', true);\r\n//             frm.toggle_display('report', false);\r\n//             frm.toggle_display('cb_request', false);\r\n//             // frm.toggle_display('table', false);\r\n\r\n//         }\r\n            \r\n//         }   \r\n//     },\r\ncb_requests:function(frm){\r\n      frappe.new_doc('CB Request'); \r\n          frappe.route_options = {\r\n             buyer: frm.doc.buyer,\r\n             refnumber: frm.doc.cl_check_no,\r\n             policy_type: frm.doc.buyer_type\r\n        }\r\n     },\r\n     \r\n     \r\n onload: function(frm){\r\n        \r\n    //  frappe.call({\r\n    //   method: 'frappe.client.get_list',\r\n    //   args: {\r\n    //     'doctype': 'Single Buyer CL Application',\r\n    //     'filters': {\r\n    //       'workflow_state': 'Approved'\r\n    //     },\r\n    //     'fields': ['credit_limit_no']\r\n    //   },\r\n    //   callback: function(submittedProposalsResponse) {\r\n    //     if (submittedProposalsResponse.message) {\r\n    //       var submittedProposals = submittedProposalsResponse.message.map(function(proposal) {\r\n    //         return proposal.credit_limit_no;\r\n    //       });\r\n    //       console.log(\"** Submitted Proposals:\", submittedProposals);\r\n    //       console.log(\"** Fetching Approved Quotations **\");\r\n    //       frappe.call({\r\n    //         method: 'frappe.client.get_list',\r\n    //         args: {\r\n    //           'doctype': 'Single Buyer CL Processing',\r\n    //           'filters': {\r\n    //             'workflow_state': 'Approved'\r\n    //           },\r\n    //           'fields': ['cl_check_no']\r\n    //         },\r\n    //         callback: function(approvedQuotationsResponse) {\r\n    //             console.log(approvedQuotationsResponse,\"approvedQuotationsResponse\")\r\n    //           if (approvedQuotationsResponse.message) {\r\n    //             var approvedQuotations = approvedQuotationsResponse.message.map(function(quotation) {\r\n    //               return quotation.cl_check_no;\r\n    //             });\r\n    //             console.log(\"** Approved Quotations:\", approvedQuotations);\r\n    //             // Filter client names (include only proposals not in approved quotations)\r\n    //             var filteredClientNames = submittedProposals.filter(function(proposal) {\r\n    //               return !approvedQuotations.includes(proposal);\r\n    //             });\r\n    //             console.log(\"** Filtered Client Names:\", filteredClientNames);\r\n    //               frm.set_df_property('cl_check_no', 'options', filteredClientNames);\r\n                  \r\n    //               frm.fields_dict.credit_limit_required.$input.css(\"text-align\", \"right\");\r\n    //               frm.fields_dict.outstanding_amount.$input.css(\"text-align\", \"right\");\r\n    //               frm.fields_dict.total_exposure.$input.css(\"text-align\", \"right\");\r\n    //               frm.fields_dict.overdue_amount.$input.css(\"text-align\", \"right\");\r\n    //               frm.fields_dict.recommended_exposure.$input.css(\"text-align\", \"right\");\r\n    //               frm.fields_dict.approved_amount.$input.css(\"text-align\", \"right\");\r\n\r\n\r\n \r\n\r\n                  \r\n\r\n    //           }\r\n    //         }\r\n    //       }); // Close inner frappe.call\r\n    //     }\r\n    //   }\r\n    // }); // Close outer frappe.call\r\n\r\n      frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'User',\r\n                filters: {\r\n                    enabled: 1  // Fetch only active users\r\n                },\r\n                fields: ['name', 'full_name']\r\n            },\r\n            callback: function(response) {\r\n                if (response.message) {\r\n                    var user_options = response.message.map(user => ({\r\n                        value: user.name,\r\n                        label: user.full_name\r\n                    }));\r\n\r\n                    frm.set_df_property('recommended_to', 'options', user_options);\r\n                } else {\r\n                    frappe.msgprint('No users found.');\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error(err);\r\n                frappe.msgprint('An error occurred while fetching the user list.');\r\n            }\r\n        });\r\n \r\n    },\r\n    name1: function(frm) {\r\n        // Get the value entered in the name1 field\r\n        var name1Value = frm.doc.name1;\r\n        // Check if the name1 value is not empty and has at least 4 characters\r\n        if (name1Value && name1Value.length >= 4) {\r\n            // Extract the first 4 characters from the name1 value\r\n            var shortNameValue = name1Value.substring(0, 4);\r\n            // Set the shortname field value to the extracted short name\r\n            frm.set_value('client1', shortNameValue);\r\n        } else {\r\n            // If name1 value is empty or has less than 4 characters, clear the shortname field\r\n            frm.set_value('client1', '');\r\n        }\r\n    },\r\n    \r\n\r\n\r\n// cl_check_no: function(frm) {\r\n//         var policyNo = frm.doc.cl_check_no;\r\n        \r\n//         frappe.call({\r\n//             method: 'frappe.client.get_list',\r\n//             args: {\r\n//                 doctype: 'Single Buyer CL Application',\r\n//                 filters: {\r\n//                     credit_limit_no: policyNo\r\n//                 },\r\n//                 fields: [\r\n//                     'buyer', 'client1', 'comment', 'buyer_short_name', 'credit_limit_required', 'cl_application_date',  'address1', 'dci_buyer', 'eci_buyer'\r\n//                      ]\r\n//             },\r\n//             callback: function(response) {\r\n//                 console.log('response',response)\r\n//                 if (response.message && response.message.length > 0) {\r\n//                     var data_from_proposals = response.message[0];\r\n                    \r\n//                     frm.set_value('name1', data_from_proposals.client1 || '');\r\n//                     frm.set_value('buyer', data_from_proposals.buyer_short_name || '');\r\n//                     frm.set_value('buyer_name', data_from_proposals.buyer || '');\r\n//                     frm.set_value('credit_limit_required', data_from_proposals.credit_limit_required || '');\r\n//                     frm.set_value('comment', data_from_proposals.comment || '');\r\n//                     frm.set_value('date', data_from_proposals.cl_application_date || '');\r\n//                     frm.set_value('location', data_from_proposals.address1 || '');\r\n\r\n//                     // Determine the bond_type based on eci and dci\r\n//                   if (data_from_proposals.eci_buyer) {\r\n//                         frm.set_value('buyer_type', 'ECI');\r\n//                     } else if (data_from_proposals.dci_buyer) {\r\n//                         frm.set_value('buyer_type', 'DCI');\r\n//                     } else {\r\n//                         frm.set_value('buyer_type', '');\r\n//                     }\r\n//                 } else {\r\n//                     // Clear fields if no matching record found\r\n//                     frm.set_value('client1', '');\r\n//                     frm.set_value('name1', '');\r\n//                     frm.set_value('buyer', '');\r\n//                     frm.set_value('buyer_name', '');\r\n//                     frm.set_value('credit_limit_required', '');\r\n//                     frm.set_value('comment', '');\r\n//                     frm.set_value('date', '');\r\n//                     frm.set_value('location', '');\r\n//                     frm.set_value('buyer_type', '');\r\n// // Get the selected quotation number\r\n// let cl_check_no = frm.doc.cl_check_no;\r\n\r\n// // Re-enable the dropdown field after selection\r\n// frm.toggle_enable('cl_check_no', true);\r\n\r\n\r\n//                     frappe.msgprint('No matching record found in Single Buyer CL Application.');\r\n//                 }\r\n//             },\r\n//             error: function(err) {\r\n//                 console.error(err);\r\n//                 frappe.msgprint('An error occurred while fetching data from Single Buyer CL Application. Please check the console for details.');\r\n//             }\r\n            \r\n            \r\n//         });\r\n//     }\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n//     cb_requests: function(frm){\r\n//         frappe.route_options = {\r\n//             buyer: frm.doc.buyer\r\n           \r\n//         };\r\n          \r\n//       frappe.new_doc('CB Request'); \r\n//         //   frappe.route_options = {\r\n//         //      buyer: frm.doc.buyer_name,\r\n//         //      refnumber: frm.doc.credit_limit_no,\r\n//         //      policy_type: frm.doc.policy_type,\r\n            \r\n//         // }; \r\n//     }\r\n    \r\n// });\r\n// //     onload: function(frm) {\r\n// //         frm.fields_dict['cl_check_no'].get_query = function(doc) {\r\n// //             return {\r\n// //                 filters: {\r\n// //                     \"workflow_state\": \"Approved\"\r\n// //                 }\r\n// //             };\r\n// //         };\r\n// //     },\r\n// //     refresh: function(frm) {\r\n// //         // Your refresh logic here\r\n// //     }\r\n// // });\r\n\r\n        \r\n//             frappe.ui.form.on('Single Buyer CL Processing', {\r\n//     refresh: function(frm) {\r\n//         frm.add_custom_button(__('View CB Report'), function() {\r\n//             // Define cbReportData with actual data\r\n//             let cbReportData = {\r\n//                 cb_request_number: 'REQ12345',\r\n//                 reqdate: '2024-05-16',\r\n//                 buyer: 'John Doe',\r\n//                 refnumber: 'REF67890',\r\n//                 date: '2024-05-16',\r\n//                 category: 'Finance',\r\n//                 code: '123',\r\n//                 details: 'Sample details',\r\n//                 description: 'Sample description'\r\n//             };\r\n\r\n//             frappe.prompt([\r\n//                 {'fieldname': 'Cbreport', 'fieldtype': 'Heading', 'label': 'CB Report'},\r\n//                 {'fieldname': 'section_break_2', 'fieldtype': 'Section Break', 'label': ''},\r\n//                 {'fieldname': 'credit_bureau_request', 'fieldtype': 'Heading', 'label': 'Credit Bureau Request'},\r\n//                 {'fieldname': 'section_break_2', 'fieldtype': 'Section Break', 'label': ''},\r\n//                 {'fieldname': 'cb_req_number', 'fieldtype': 'Data', 'label': 'CB Req Number', 'default': cbReportData.cb_request_number},\r\n//                 {'fieldname': 'reqdate', 'fieldtype': 'Date', 'label': 'Req.Date', 'default': cbReportData.reqdate},\r\n//                 {'fieldname': 'buyer', 'fieldtype': 'Data', 'label': 'Buyer', 'default': cbReportData.buyer},\r\n//                 {'fieldname': 'column_break_1', 'fieldtype': 'Column Break', 'label': ''},\r\n//                 {'fieldname': 'refnumber', 'fieldtype': 'Data', 'label': 'Ref.Number', 'default': cbReportData.refnumber},\r\n//                 {'fieldname': 'section_break_3', 'fieldtype': 'Section Break', 'label': ''},\r\n//                 {'fieldname': 'section_break_4', 'fieldtype': 'Section Break', 'label': ''},\r\n//                 {'fieldname': 'credit_bureau_responce', 'fieldtype': 'Heading', 'label': 'Credit Bureau Response'},\r\n//                 {'fieldname': 'section_break_5', 'fieldtype': 'Section Break', 'label': ''},\r\n//                 {'fieldname': 'date', 'fieldtype': 'Date', 'label': 'Date', 'default': cbReportData.date},\r\n//                 {'fieldname': 'category', 'fieldtype': 'Data', 'label': 'Category', 'default': cbReportData.category},\r\n//                 {'fieldname': 'code', 'fieldtype': 'Data', 'label': 'Code', 'default': cbReportData.code},\r\n//                 {'fieldname': 'column_break_2', 'fieldtype': 'Column Break', 'label': ''},\r\n//                 {'fieldname': 'details', 'fieldtype': 'Data', 'label': 'Details', 'default': cbReportData.details},\r\n//                 {'fieldname': 'description', 'fieldtype': 'Small Text', 'label': 'Description', 'default': cbReportData.description},\r\n//             ], function(values){\r\n//                 // Handle user input if needed\r\n//                 console.log(values);\r\n//             }, 'CB Report');\r\n//         });\r\n//     }\r\n// });\r\n\r\n\r\n\r\n \r\n\r\n\r\n    \r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Addendum and Endorsements to the policy",
  "enabled": 0,
  "modified": "2024-03-26 06:07:27.399032",
  "module": "Marketing",
  "name": "Addendum script",
  "script": "frappe.ui.form.on('Addendum and Endorsements to the policy', {\n\t \n// onload: function (frm) {\n//     const storedProposalNo = sessionStorage.getItem('proposal_no');\n    \n//     if (storedProposalNo) {\n//         frm.set_value('proposal_no', storedProposalNo);\n//         console.log(\"Updated proposal number:\", frm.doc.proposal_no);\n//     } else {\n//         console.log(\"Proposal number not found in sessionStorage\");\n//     }\n// }\n\nonload: function(frm) {\n        var selectedProposalNo = sessionStorage.getItem('selectedProposalNo');\n        console.log(\"Stored Proposal No in TargetDocType:\", selectedProposalNo);\n        frm.set_value('proposal_no', selectedProposalNo);\n        console.log(\"Updated proposal number:\", frm.doc.proposal_no);\n}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Guide to the Administration of the Policy",
  "enabled": 1,
  "modified": "2025-09-26 09:13:18.788528",
  "module": "Marketing",
  "name": "Guide to the Administration of the policy script",
  "script": "frappe.ui.form.on('Guide to the Administration of the Policy', {\n    refresh:function(frm){\n        frm.set_df_property('table','cannot_add_rows', true);\n        $(frm.fields_dict['table'].grid.wrapper).find('.btn-grid-delete-row').prop('disabled', true);\n \n// Apply CSS to hide the Edit button\nvar css = `.btn-open-row {\ndisplay: none !important;\n}\n`;\n \n$('<style>' + css + '</style>').appendTo('head');\n    },\nonload:function(frm) {\n        // Call to fetch data\n        frm.call({\n            method: \"frappe.client.get_list\",\n            args: {\n                doctype: \"Guide Store Data\",\n                fields: [\"period_overdue_days\", \"action_to_be_taken\"]\n            },\n            callback: function (r) {\n                console.log(r, \"hello\");\n                frm.doc.table = [];\n                var data = r.message;\n                for (let x of data) {\n                    var child = frappe.model.add_child(frm.doc, \"Guide_Child_Table\", \"table\");\n                    console.log(child, \"s\");\n\n                    // Add a new row to the \"table\" child table\n                    frappe.model.set_value(child.doctype, child.name, \"period_overdue_days\", x.period_overdue_days);\n                    frappe.model.set_value(child.doctype, child.name, \"action_to_be_taken\", x.action_to_be_taken);\n                }\n\n                // Refresh the form to display the updated child table\n                frm.refresh_field('table');\n\n                console.log(data); // Corrected variable name\n            }\n        });\n    }\n});\n\t\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Addendum _and Endorsements to the policy",
  "enabled": 1,
  "modified": "2024-03-20 11:14:38.226399",
  "module": "Marketing",
  "name": "Addendum",
  "script": "frappe.ui.form.on('Addendum _and Endorsements to the policy', {\n \nrefresh(frm) {\n        console.log(\"covering Letter - refresh function executed\");\n \n        // Retrieve client name from sessionStorage\n        var selectedProposalNo = sessionStorage.getItem('selectedProposalNo');\n \n        console.log(selectedProposalNo, \"retrieved from sessionStorage\");\n \n        if (selectedProposalNo) {\n            // Set the 'to' field in the 'covering Letter' doctype\n            frm.set_value('proposal_no', selectedProposalNo);\n            console.log(selectedProposalNo, \"set to the to field\");\n        } else {\n            console.log(\"No client name found in sessionStorage\");\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Acceptance Form",
  "enabled": 0,
  "modified": "2024-04-12 07:16:14.566393",
  "module": "Marketing",
  "name": "script",
  "script": "  frappe.ui.form.on('Acceptance Form', {\r\n   refresh(frm) {\r\n        console.log(\"covering Letter - refresh function executed\");\r\n \r\n        // Retrieve client name from sessionStorage\r\n        var selectedProposalNo = sessionStorage.getItem('selectedProposalNo');\r\n \r\n        console.log(selectedProposalNo, \"retrieved from sessionStorage\");\r\n \r\n        if (selectedProposalNo) {\r\n            // Set the 'to' field in the 'covering Letter' doctype\r\n            frm.set_value('proposal_no', selectedProposalNo);\r\n            console.log(selectedProposalNo, \"set to the to field\");\r\n        } else {\r\n            console.log(\"No client name found in sessionStorage\");\r\n        }\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Credit Limit",
  "enabled": 1,
  "modified": "2025-11-24 12:37:42.199206",
  "module": null,
  "name": "Creditlimitdisplay",
  "script": "frappe.ui.form.on('Credit Limit', {\n    \n    refresh: function(frm){\n        $(frm.fields_dict['credit_limit'].grid.wrapper).find('.btn-grid-delete-row').prop('disabled', true);\n \n       // Apply CSS to hide the Edit button\n         var css = `.btn-open-row {display: none !important;}`;\n \n        $('<style>' + css + '</style>').appendTo('head');\n        \n       frm.set_df_property('credit_limit','cannot_add_rows', true);\n\n    frappe.call({\n            method: \"frappe.client.get_list\",\n            args: {\n                doctype: \"Credit Limit Processing\",\n                // filters: {\n                //     // Add filter to match names with the current form\n                //     // name1: frm.doc.name1\n                // },\n                //fields: [\"credit_limit_no\", \"policy_holder_name\", \"buyer_name\",\"approved_amount\",\"approved_date\"],\n                 fields: [\"credit_limit_no\", \"policy_holder_name\", \"buyer_name\",\"approved_amount\",\"approved_date\"],\n                limit_page_length: 0\n            },\n            callback: function (r) {\n                if (!r.exc) {\n                    console.log(r.message, \"hi\");\n \n                    var data = r.message;\n \n                    frm.clear_table('credit_limit');\n \n                    for (let x of data) {\n                        var child = frappe.model.add_child(frm.doc, \"CreditLimitDisplaychild\", \"credit_limit\",\"date\");\n                        console.log(child, \"s\")\n \n                        frappe.model.set_value(child.doctype, child.name, \"creditlimitno\", x.credit_limit_no);\n                        frappe.model.set_value(child.doctype, child.name, \"policyholder\", x.policy_holder_name);\n                        frappe.model.set_value(child.doctype, child.name, \"buyer\", x.buyer_name);\n                        frappe.model.set_value(child.doctype, child.name, \"creditlimitamount\", x.approved_amount);\n                        frappe.model.set_value(child.doctype, child.name, \"approvedon\", x.approved_date);\n                       \n                    }\n                    frm.refresh_fields('credit_limit');\n                    console.log(data);\n                } else {\n                    console.error(r.exc);\n                }\n            }\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Claim Register",
  "enabled": 1,
  "modified": "2025-12-05 09:02:11.825391",
  "module": "Finance",
  "name": "Claim Register Script",
  "script": "//AmruthaCode\r\nfrappe.ui.form.on('Claim Register', {\r\n    refresh: function(frm) {\r\n        frm.fields_dict.claim_value.$input.css(\"text-align\", \"right\");\r\n          toggle_fields(frm);\r\n        // var workflowState = frm.doc.workflow_state;\r\n        // // if (workflowState === \"Accpeted\") {\r\n        // //     frm.toggle_display('policyno', true);\r\n        // //     frm.toggle_display('policy_no', false);\r\n        //}\r\n        \r\n        \r\n        \r\n    },\r\n\r\nonload: function(frm) {\r\n    \r\n     toggle_fields(frm);\r\n        if (!frm.doc.claim_reg_no) {\r\n            generateNumber(frm);\r\n        }\r\n\r\n        // // Fetch unique policy holders from Policy Approvals\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Policy Approvals',\r\n                fields: ['policy_holder'],\r\n                workflow_state: 'Accepted',\r\n                limit_page_length: 1000000\r\n            },\r\n            callback: function(response) {\r\n                console.log(\"policy_holder received:\", response);\r\n\r\n                if (response.message) {\r\n                    let uniquePolicyHolders = [];\r\n                    response.message.forEach(function(record) {\r\n                        if (!uniquePolicyHolders.includes(record.policy_holder)) {\r\n                            uniquePolicyHolders.push(record.policy_holder);\r\n                        }\r\n                        uniquePolicyHolders.sort();\r\n                    });\r\n\r\n                    frm.set_df_property('ph_name', 'options', uniquePolicyHolders);\r\n                    console.log(\"final\", uniquePolicyHolders);\r\n                }\r\n            },\r\n            error: function(xhr, textStatus, errorThrown) {\r\n                console.error(\"Error fetching policy holders:\", textStatus, errorThrown);\r\n            }\r\n        });\r\n    },\r\n\r\n// ph_name: function(frm) {\r\n//     var phName = frm.doc.ph_name;\r\n\r\n//     // Fetch data from Policy Approvals based on selected policy_holder\r\n//     frappe.call({\r\n//         method: 'frappe.client.get_list',\r\n//         args: {\r\n//             doctype: 'Policy Approvals',\r\n//             filters: {\r\n//                 policy_holder: phName,\r\n//             //  status: 'Accepted' // Assuming you only want approved records\r\n//             },\r\n//             fields: ['policy_number']\r\n//         },\r\n//         callback: function(r) {\r\n//             console.log(r, \"policy details\");\r\n\r\n//             if (!r.exc && r.message && r.message.length > 0) {\r\n//                 // Collect all policy numbers\r\n//                 let policyNumbers = r.message.map(x => x.policy_number);\r\n\r\n//                 // Set options and value for policy_no\r\n//                 frm.set_df_property('policy_no', 'options', policyNumbers);\r\n//                 //frm.set_value('policy_no', policyNumbers[0]);\r\n//                 frm.refresh_field('policy_no'); \r\n//                 //frm.set_value('policyno', buyers.join('\\n'));  \r\n//             } else {\r\n//                 // Handle case where no matching records are found\r\n//                 frm.set_df_property('policy_no', 'options', []);\r\n//                 frm.set_value('policy_no', '');\r\n//                 frm.refresh_field('policy_no'); \r\n//                 console.log(\"No matching records found\");\r\n//             }\r\n//         },\r\n//         error: function(r) {\r\n//             console.error(\"Error occurred:\", r.exc);\r\n//             frappe.msgprint(\"Error occurred while fetching policy details\");\r\n//         }\r\n//     });\r\n// },\r\n// policy_no: function(frm) {    \r\n//       var phName = frm.doc.ph_name;\r\n//         var phNo = frm.doc.policy_no;\r\n\r\n//         // Fetch data from Credit Limits Application based on selected policy number\r\n//         frappe.call({\r\n//             method: 'frappe.client.get_list',\r\n//             args: {\r\n//                 doctype: 'Credit Limits Application',\r\n//                 filters: {\r\n//                   policy_holder_name: phName,\r\n//                   policy_number: phNo\r\n                    \r\n//                 },\r\n//                 fields: ['buyer']\r\n//             },\r\n//             callback: function(r) {\r\n//                 console.log(r, \"buyer details\");\r\n\r\n//                 if (!r.exc && r.message && r.message.length > 0) {\r\n//                     var buyers = r.message.map(function(record) {\r\n//                         return record.buyer;\r\n//                     });\r\n\r\n//                     // Set options and set value for buyer\r\n//                     frm.set_df_property('buyer', 'options', buyers);\r\n//                     // frm.set_value('buyer', buyers[0]);  // Set the first buyer as default\r\n//                     // frm.set_value('buyerinfo', buyers.join('\\n'));  // Set the buyerinfo field\r\n//                      frm.refresh_field('buyer');\r\n\r\n//                     // // Set value for policyno field\r\n//                     // frm.set_value('policyno', phNo);\r\n//                 } \r\n//                 else {\r\n//                     // // Handle case where no matching records are found\r\n//                     // frm.set_df_property('buyer', 'options', []);\r\n//                     // frm.set_value('buyer', '');  // Clear the field or set a default value\r\n//                     // frm.set_value('buyerinfo', '');  // Clear the buyerinfo field\r\n//                     // console.log(\"No matching records found\");\r\n//                      frm.refresh_field('buyer');\r\n//                 }\r\n//             },\r\n//             error: function(r) {\r\n//                 console.error(\"Error occurred:\", r.exc);\r\n//                 frappe.msgprint(\"Error occurred while fetching buyer details\");\r\n//             }\r\n//         });\r\n//     }\r\n\r\n\r\nph_name: function(frm) {\r\n    var phName = frm.doc.ph_name;\r\n\r\n    // Step 1: Get already used policy_no from this DocType (exclude current draft)\r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: frm.doctype,\r\n            filters: {\r\n                name: [\"!=\", frm.doc.name] // exclude current form record\r\n            },\r\n            fields: [\"policy_no\"],\r\n            limit_page_length: 0\r\n        },\r\n        callback: function(usedRes) {\r\n\r\n            // convert used policy numbers list\r\n            let usedPolicyNos = usedRes.message\r\n                .map(d => d.policy_no)\r\n                .filter(x => x);        // remove null/empty\r\n\r\n            console.log(\"Used policy numbers:\", usedPolicyNos);\r\n\r\n            // Step 2: Fetch policy numbers for selected policy holder\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Policy Approvals',\r\n                    filters: { policy_holder: phName },\r\n                    fields: ['policy_number'],\r\n                    limit_page_length: 0\r\n                },\r\n                callback: function(r) {\r\n                    console.log(\"Policy details:\", r);\r\n\r\n                    if (r.message && r.message.length > 0) {\r\n\r\n                        // list of policy numbers for this policy holder\r\n                        let policyNumbers = r.message\r\n                            .map(x => x.policy_number)\r\n                            .filter(x => !usedPolicyNos.includes(x)); // REMOVE already used ones\r\n\r\n                        console.log(\"Filtered available policy numbers:\", policyNumbers);\r\n\r\n                        // set dropdown options\r\n                        frm.set_df_property('policy_no', 'options', policyNumbers);\r\n\r\n                        // auto-set first value if available\r\n                        frappe.model.set_value(frm.doctype, frm.docname, 'policy_no', policyNumbers[0] || '');\r\n                        frm.refresh_field('policy_no');\r\n\r\n                    } else {\r\n                        // no policies found\r\n                        frm.set_df_property('policy_no', 'options', []);\r\n                        frappe.model.set_value(frm.doctype, frm.docname, 'policy_no', '');\r\n                        frm.refresh_field('policy_no');\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    });\r\n},\r\n\r\n\r\n\r\n\r\n// original code\r\n// ph_name: function(frm) {\r\n//     var phName = frm.doc.ph_name;\r\n    \r\n    \r\n    \r\n//     frappe.call({\r\n//         method: 'frappe.client.get_list',\r\n//         args: {\r\n//             doctype: 'Policy Approvals',\r\n//             filters: { policy_holder: phName },\r\n//             fields: ['policy_number']\r\n//         },\r\n//         callback: function(r) {\r\n//             console.log(\"Policy details:\", r);\r\n\r\n//             if (r.message && r.message.length > 0) {\r\n//                 let policyNumbers = r.message.map(x => x.policy_number);\r\n                \r\n\r\n//                 frm.set_df_property('policy_no', 'options', policyNumbers);\r\n//                 frappe.model.set_value(frm.doctype, frm.docname, 'policy_no', policyNumbers[0]); // Ensure it's saved\r\n//                 frm.refresh_field('policy_no');\r\n//             } else {\r\n//                 frm.set_df_property('policy_no', 'options', []);\r\n//                 frappe.model.set_value(frm.doctype, frm.docname, 'policy_no', '');\r\n//                 frm.refresh_field('policy_no');\r\n//             }\r\n//         }\r\n//     });\r\n// },\r\n// original code\r\n\r\npolicy_no: function(frm) {\r\n    var phName = frm.doc.ph_name;\r\n    var phNo = frm.doc.policy_no;\r\n    frm.set_value('policyno', phNo);\r\n\r\n    // Fetch data from Credit Limits Application based on selected policy number\r\n    // frappe.call({\r\n    //     method: 'frappe.client.get_list',\r\n    //     args: {\r\n    //         doctype: 'Credit Limits Application',\r\n    //         filters: {\r\n    //             policy_holder_name: phName\r\n    //         },\r\n    //         fields: ['buyer']\r\n    //     },\r\n    //     callback: function(r) {\r\n    //         console.log(r, \"buyer details\");\r\n\r\n    //         if (!r.exc && r.message && r.message.length > 0) {\r\n    //             var buyers = r.message.map(record => record.buyer);\r\n\r\n    //             frm.set_df_property('buyer', 'options', buyers);\r\n    //             frm.set_value('buyer', buyers[0]);\r\n    //             frm.refresh_field('buyer');  // Refresh to ensure persistence\r\n    //         } else {\r\n    //             frm.set_df_property('buyer', 'options', []);\r\n    //             frm.set_value('buyer', '');\r\n    //             frm.refresh_field('buyer');\r\n    //             console.log(\"No matching records found\");\r\n    //         }\r\n    //     }\r\n    // });\r\n    \r\n    frappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Credit Limits Application',\r\n        filters: {\r\n            policy_holder_name: phName\r\n        },\r\n        fields: ['buyer']\r\n    },\r\n    callback: function(r) {\r\n        console.log(r, \"buyer details\");\r\n\r\n        if (!r.exc && r.message && r.message.length > 0) {\r\n            var buyers = r.message.map(record => record.buyer);\r\n\r\n            // Set buyer dropdown options and default value\r\n            frm.set_df_property('buyer', 'options', buyers);\r\n            frm.set_value('buyer', buyers[0]);\r\n            frm.set_value('buyerinfo', buyers[0]); // Set buyerinfo also\r\n\r\n            frm.refresh_field('buyer');\r\n            frm.refresh_field('buyerinfo');\r\n        } else {\r\n            frm.set_df_property('buyer', 'options', []);\r\n            frm.set_value('buyer', '');\r\n            frm.set_value('buyerinfo', '');\r\n            frm.refresh_field('buyer');\r\n            frm.refresh_field('buyerinfo');\r\n            console.log(\"No matching records found\");\r\n        }\r\n    }\r\n});\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// policy_no: function(frm) {\r\n//     var phNo = frm.doc.policy_no;\r\n//     var phName = frm.doc.ph_name;\r\n\r\n//     if (phNo && phName) {\r\n//         console.log(\"Fetching buyers for Policy No:\", phNo, \"and Policy Holder:\", phName);\r\n\r\n//         frappe.call({\r\n//             method: 'frappe.client.get_list',\r\n//             args: {\r\n//                 doctype: 'Credit Limits Application',\r\n//                 filters: {\r\n//                     //policy_no: phNo,\r\n//                     policy_holder_name: phName\r\n//                 },\r\n//                 fields: ['buyer']\r\n//             },\r\n//             callback: function(r) {\r\n//                 console.log(\"API Response:\", r);  // Debugging response\r\n\r\n//                 if (r.message && Array.isArray(r.message)) {\r\n//                     let buyers = r.message.map(record => record.buyer).filter(b => b); // Ensure no null values\r\n\r\n//                     if (buyers.length > 0) {\r\n//                         frm.set_df_property('buyer', 'options', [''].concat(buyers));\r\n//                         frm.set_value('buyer', buyers[0] || '');  // Set first buyer as default\r\n//                         frm.set_value('buyerinfo', buyers.join('\\n'));  // Store all buyers in buyerinfo\r\n//                     } else {\r\n//                         frm.set_df_property('buyer', 'options', ['']);\r\n//                         frm.set_value('buyer', '');\r\n//                         frm.set_value('buyerinfo', '');\r\n//                         console.warn(\"No buyers found for Policy No:\", phNo);\r\n//                     }\r\n//                 } else {\r\n//                     console.error(\"Unexpected API response format:\", r);\r\n//                 }\r\n//             },\r\n//             error: function(r) {\r\n//                 console.error(\"Error fetching buyer details:\", r);\r\n//                 frappe.msgprint(\"Error fetching buyer details. Check console for more info.\");\r\n//             }\r\n//         });\r\n//     } else {\r\n//         console.warn(\"Policy No or Policy Holder Name is missing!\");\r\n//     }\r\n// }\r\n\r\n\r\n\r\n\r\n});\r\nfunction generateNumber(frm) {\r\n\r\n    // Check if the proposal number field is already populated\r\n\r\n    if (!frm.doc.claim_reg_no) {\r\n\r\n        // Get the current year\r\n\r\n        let currentYear = new Date().getFullYear();\r\n\r\n        let prefix = `RCLM/${currentYear}/`;\r\n \r\n        // Make a call to get the last number asynchronously\r\n\r\n        frappe.call({\r\n\r\n            method: 'frappe.client.get_list',\r\n\r\n            args: {\r\n\r\n                doctype: 'Claim Register',\r\n\r\n                fields: ['claim_reg_no', 'creation'],\r\n\r\n                order_by: 'creation desc',\r\n\r\n                limit: 1\r\n\r\n            },\r\n\r\n            callback: function(r) {\r\n\r\n                console.log(r,\"ClaimRegNo\");\r\n\r\n                if (r.message && r.message.length > 0) {\r\n\r\n                    let lastClaimRegNo = r.message[0].claim_reg_no;\r\n\r\n                    let lastNumber = parseInt(lastClaimRegNo.split(\"/\").pop()); // Extract last part and parse it as integer\r\n\r\n                    if (!isNaN(lastNumber)) {\r\n\r\n                        // Increment the last number and pad it with leading zeros\r\n\r\n                        let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n\r\n                        frm.set_value('claim_reg_no', prefix + newNumber);\r\n\r\n                    }\r\n\r\n                } else {\r\n\r\n                    // If no previous numbers exist, set to default '0001'\r\n\r\n                    frm.set_value('claim_reg_no', prefix + '0001');\r\n\r\n                }\r\n\r\n            }\r\n\r\n        });\r\n\r\n    }\r\n\r\n}\r\n\r\n// Helper function to toggle field visibility\r\nfunction toggle_fields(frm) {\r\n    if (frm.is_new()) {\r\n        // For new / unsaved record\r\n        frm.set_df_property('buyer', 'hidden', 0);\r\n        frm.set_df_property('buyerinfo', 'hidden', 1);\r\n        frm.set_df_property('policy_no', 'hidden', 0);\r\n        frm.set_df_property('policyno', 'hidden', 1);\r\n    } else {\r\n        // For saved record\r\n        frm.set_df_property('buyer', 'hidden', 1);\r\n        frm.set_df_property('buyerinfo', 'hidden', 0);\r\n        frm.set_df_property('policy_no', 'hidden', 1);\r\n        frm.set_df_property('policyno', 'hidden', 0);\r\n    }\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "sample",
  "enabled": 0,
  "modified": "2024-03-26 06:53:56.869263",
  "module": null,
  "name": "s",
  "script": " frappe.ui.form.on('sample', {\r\n    onload: function(frm) {\r\n        frm.fields_dict['click'].$input.on('click', function() {\r\n            frappe.new_doc('Export Declaration Invoice');\r\n        });\r\n    },\r\n\r\n    click: function(frm) {\r\n        frappe.route_options = {\r\n            credit_limit_fee: frm.doc.currency,\r\n            credit_limit_enquiry_fee: frm.doc.dollar\r\n        };\r\n        frappe.new_doc('Export Declaration Invoice');\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Addendum and Endorsements to the policy",
  "enabled": 0,
  "modified": "2024-04-12 07:19:33.353919",
  "module": "Marketing",
  "name": "Addendum_script",
  "script": "frappe.ui.form.on('Addendum and Endorsements to the policy', {\n onload: function(frm) {\n        var proposal_no = frm.doc.proposal_no;\n \n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Policy Approvals',\n                filters: {\n                    proposal_no: proposal_no\n                },\n                fields: ['policy_holder', 'policy_number','proposal_no'],\n                limit: 1\n            },\n            callback: function(response) {\n                if (response && response.message && response.message.length > 0) {\n                    var policyApprovalData = response.message[0];\n \n                    frm.set_value('policy_name', policyApprovalData.policy_holder);\n                    frm.set_value('policy_no', policyApprovalData.policy_number);\n                    frm.set_value('proposal_no', policyApprovalData.proposal_no);\n                   // frm.set_value('quotation_no', policyApprovalData.quotation_numbers);\n                } else {\n                    frappe.msgprint('No matching record found in Policy Approvals.');\n                }\n            },\n            error: function(err) {\n                console.error('Error fetching data from Policy Approvals:', err);\n                frappe.msgprint('An error occurred while fetching data from Policy Approvals.');\n            }\n        });\n    }\n});\n  \n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "List Of Quotations",
  "enabled": 1,
  "modified": "2024-03-21 12:56:47.106994",
  "module": null,
  "name": "List Of Quotations CS",
  "script": "// frappe.ui.form.on('List Of Quotations', {\r\n//     display_result(frm) {\r\n//         let query = {};\r\n\r\n//         // Call to fetch data\r\n//         frm.call({\r\n//             method: \"frappe.client.get_list\",\r\n//             args: {\r\n//                 doctype: \"DCIQuotation\",\r\n//                 filters: query,\r\n//                 fields: [\"schedule_no\", \"inception_date\", \"proposal_no\", \"client_name\", \"maximum_liability\", \"premium_rate\"]\r\n//             },\r\n//             callback: function(r) {\r\n//                 console.log(r, \"hello\");\r\n//                 frm.doc.result = [];\r\n//                 frm.refresh_field('result');\r\n//                 var data = r.message;\r\n//                 for (let x of data) {\r\n//                     var child = frappe.model.add_child(frm.doc, \"Result\", \"result\");\r\n//                     console.log(child, \"s\")\r\n//                     // Add a new row to the \"Search_Results\" child table\r\n//                     frappe.model.set_value(child.doctype, child.name, \"qutn_no\", x.schedule_no);\r\n//                     frappe.model.set_value(child.doctype, child.name, \"prop_no\", x.proposal_no);\r\n//                     frappe.model.set_value(child.doctype, child.name, \"client\", x.client_name);\r\n//                     frappe.model.set_value(child.doctype, child.name, \"date\", x.inception_date);\r\n//                     frappe.model.set_value(child.doctype, child.name, \"maximum_polictical_liability\", x.maximum_liability);\r\n//                     frappe.model.set_value(child.doctype, child.name, \"prem_rate\", x.premium_rate);\r\n//                     frappe.model.set_value(child.doctype, child.name, \"prop_date\", x.inception_date);\r\n//                 }\r\n//                 // Refresh the form to display the updated child table\r\n//                 frm.refresh_fields('result');\r\n//                 console.log(data); // Corrected variable name\r\n//             }\r\n//         });\r\n//     },\r\n\r\n//     refresh(frm) {\r\n//         frm.fields_dict.display_result.$input.addClass('btn-primary');\r\n//                 frm.fields_dict.generate_report.$input.addClass('btn-primary');\r\n\r\n//     }\r\n// });\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\nfrappe.ui.form.on('List Of Quotations', {\r\n    display_result(frm) {\r\n        let query = {};\r\n\r\n        // Call to fetch data\r\n        frm.call({\r\n            method: \"frappe.client.get_list\",\r\n            args: {\r\n                doctype: \"DCIQuotation\",\r\n                filters: query,\r\n                fields: [\"schedule_no\", \"inception_date\", \"proposal_no\", \"client_name\", \"maximum_liability\", \"premium_rate\"]\r\n            },\r\n            callback: function(r) {\r\n                console.log(r, \"hello\");\r\n                frm.doc.result = [];\r\n                frm.refresh_field('result');\r\n                var data = r.message;\r\n                for (let x of data) {\r\n                    var child = frappe.model.add_child(frm.doc, \"Result\", \"result\");\r\n                    console.log(child, \"s\")\r\n                    // Add a new row to the \"Search_Results\" child table\r\n                    frappe.model.set_value(child.doctype, child.name, \"qutn_no\", x.schedule_no);\r\n                    frappe.model.set_value(child.doctype, child.name, \"prop_no\", x.proposal_no);\r\n                    frappe.model.set_value(child.doctype, child.name, \"client\", x.client_name);\r\n                    frappe.model.set_value(child.doctype, child.name, \"date\", x.inception_date);\r\n                    frappe.model.set_value(child.doctype, child.name, \"maximum_polictical_liability\", x.maximum_liability);\r\n                    frappe.model.set_value(child.doctype, child.name, \"prem_rate\", x.premium_rate);\r\n                    frappe.model.set_value(child.doctype, child.name, \"prop_date\", x.inception_date);\r\n                }\r\n                // Refresh the form to display the updated child table\r\n                frm.refresh_fields('result');\r\n                console.log(data); // Corrected variable name\r\n            }\r\n        });\r\n    },\r\n\r\n    generate_report(frm) {\r\n        // Print the report after generating the data\r\n        frm.save()\r\n        setTimeout(function() {\r\n                    frm.print_doc();\r\n                }, 5000); // Example delay of 2000 milliseconds (2 seconds)\r\n    },\r\n\r\n    refresh(frm) {\r\n        frm.fields_dict.display_result.$input.addClass('btn-primary');\r\n        frm.fields_dict.generate_report.$input.addClass('btn-primary');\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Letter Of Intends",
  "enabled": 1,
  "modified": "2025-12-05 08:35:14.709203",
  "module": "UnderWriting",
  "name": "Letter_of_intends",
  "script": "frappe.ui.form.on('Letter Of Intends', {\r\n     \r\n     \r\nrefresh:function(frm){\r\n   \r\nfrm.fields_dict.total_letter_of_intend_issued.$input.css(\"text-align\", \"right\");\r\n    frm.fields_dict.add_new.$input.addClass('btn-primary');\r\nfrm.set_df_property('letter_of_intends_details', 'cannot_add_rows', true);\r\n \r\nfrm.set_df_property('letter_of_intends_no_table', 'cannot_add_rows', true);\r\n \r\n frm.fields_dict.bond_facility_amount.$input.css(\"text-align\", \"right\");\r\n},\r\nonload: function(frm){\r\n frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Security',\r\n                fields: ['name1'],\r\n                limit_page_length: 0\r\n            },\r\n            callback: function(response) {\r\n                console.log(\"name received:\", response);\r\n\r\n                if (response.message && response.message.length > 0) {\r\n\r\n                    let uniqueFacilityNames = [...new Set(\r\n                        response.message\r\n                            .filter(x => x.name1)\r\n                            .map(x => x.name1)\r\n                    )];\r\n                   uniqueFacilityNames.sort();\r\n                    // Set dropdown correctly\r\n                    frm.set_df_property(\r\n                        'bondname',\r\n                        'options',\r\n                        uniqueFacilityNames.join(\"\\n\")\r\n                    );\r\n\r\n                    frm.refresh_field(\"bondname\");\r\n                } else {\r\n                    frappe.msgprint(\"No Security records found.\");\r\n                }\r\n            }\r\n        });\r\n\r\n\r\n},\r\nbondname: function(frm){\r\n\r\nfrappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Security',\r\n        fields: ['name', 'facility_no'],   // include name always\r\n         filters: {\r\n                    name1: frm.doc.bondname\r\n                },\r\n        limit_page_length: 0            // fetch all\r\n    },\r\n    callback: function(response) {\r\n        console.log(\"facility_no received:\", response);\r\n\r\n        if (response.message && response.message.length > 0) {\r\n            let uniqueFacilityNos = [...new Set(\r\n                response.message\r\n                .filter(x => x.facility_no)\r\n                .map(x => x.facility_no)\r\n            )];\r\n\r\n            frm.set_df_property('bond_facility_no', 'options', uniqueFacilityNos);\r\n            console.log(\"final\", uniqueFacilityNos);\r\n        } else {\r\n            frappe.msgprint(\"No Security records have facility_no\");\r\n        }\r\n    }\r\n});\r\n},\r\n\r\nbond_facility_number: function(frm) {\r\n    \r\n    \r\n      frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Bond Facility Quotation Acceptance',\r\n                filters: { \r\n                    faciity_no: frm.doc.bond_facility_no \r\n                    \r\n                },\r\n                fields: ['facility_inception_date', 'name1' , 'currency5']\r\n            },\r\n            callback: function(response) {\r\n                console.log(\"Bond Facility response:\", response);\r\n                if (response.message && response.message.length > 0) {\r\n                    var data = response.message[0];\r\n                   // frm.set_value('bondname', data.name1 || '');\r\n                    frm.set_value('facility_date', data.facility_inception_date || '');\r\n                    frm.set_value('bond_facility_amount', data.currency5 || '');\r\n                } else {\r\n                   // frm.set_value('bondname', \"\");\r\n                    frm.set_value('facility_date', \"\");\r\n                     frm.set_value('bond_facility_amount', \"\");\r\n                  \r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error(err);\r\n                frappe.msgprint('An error occurred while fetching data from DCI Proposals. Please check the console for details.');\r\n            }\r\n        });\r\n    \r\n    \r\n    \r\n    \r\n    \r\n},\r\n\r\n  add_new: function(frm) {\r\n    function getNextLoiNo() {\r\n        var currentYear = (new Date()).getFullYear();\r\n        var currentNumber = 1;\r\n        var lastLoiNo;\r\n\r\n        // Check if the child table is empty\r\n        if (!frm.doc.letter_of_intends_no_table || frm.doc.letter_of_intends_no_table.length === 0) {\r\n            // Retrieve the last used LOI number from the database\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Letter Of Intends',\r\n                    fields: ['loi', 'creation', 'bond_facility_no'],\r\n                    order_by: 'creation desc',\r\n                    limit: 1\r\n                },\r\n                async: false,\r\n                callback: function(response) {\r\n                    if (response.message && response.message[0]) {\r\n                        lastLoiNo = response.message[0].loi;\r\n                    }\r\n                }\r\n            });\r\n        } else {\r\n            // Retrieve the last used LOI number from local storage\r\n            lastLoiNo = localStorage.getItem('last_loi_no');\r\n        }\r\n\r\n        // If the child table is not empty, or no records found in the database, use local storage for incrementation\r\n        if (lastLoiNo) {\r\n            var lastNumber = parseInt(lastLoiNo.split('/')[2]);\r\n            currentNumber = lastNumber + 1;\r\n        }\r\n\r\n        var nextLoiNo = `LOI/${currentYear}/${('000' + currentNumber).slice(-4)}`;\r\n        return nextLoiNo;\r\n    }\r\n\r\n    frappe.prompt([\r\n        {'fieldname': 'loi_no', 'fieldtype': 'Data', 'label': 'LOI Req. No:', 'default': getNextLoiNo()},\r\n        {'fieldname': 'principal', 'fieldtype': 'Link','options': 'Company-Details', 'label': 'Principal:',   reqd: 1},\r\n        {'fieldname': 'new', 'fieldtype': 'Button', 'label': 'New', 'click': function() {\r\n            frappe.new_doc('Company'); \r\n        }},\r\n        {'fieldname': 'tender_no', 'fieldtype': 'Data', 'label': 'Tender No:',   reqd: 1},\r\n        {'fieldname': 'project_description', 'fieldtype': 'Long Text', 'label': 'Project Description',   reqd: 1},\r\n        {'fieldname': '', 'fieldtype': 'Column Break', 'label': ''},\r\n        {'fieldname': 'letter_of_intent_date', 'fieldtype': 'Date', 'label': 'Letter Of Intent Date',   reqd: 1},\r\n        {'fieldname': 'bond_value', 'fieldtype': 'Currency', 'label': 'Bond Value : P'},\r\n        {'fieldname': 'project_sum', 'fieldtype': 'Currency', 'label': 'Project Sum: P'},\r\n        {'fieldname': 'bond_facility_no', 'fieldtype': 'Data', 'label': 'Bond Facility No', 'default': frm.doc.bond_facility_no}, // Set default value to bond_facility_no field\r\n    ],\r\n    function(values) {\r\n        var data = {\r\n            loi_no: values.loi_no,\r\n            principal: values.principal,\r\n            tender_no: values.tender_no,\r\n            project_description: values.project_description,\r\n            letter_of_intent_date: values.letter_of_intent_date,\r\n            bond_value: values.bond_value,\r\n            project_sum: values.project_sum,\r\n             bond_facility_no: values.bond_facility_no,\r\n        };\r\n\r\n        var nextLoiNo = getNextLoiNo();\r\n        localStorage.setItem('last_loi_no', nextLoiNo);\r\n\r\n        // Add the retrieved data to the child table\r\n        addDataToChildTable(frm, data);\r\n    },\r\n    'Letter Of Intends No Table');\r\n},\r\n\r\n\r\n \r\n    // Set the last row's loi_no into the loi field before saving the record\r\n  before_save: function(frm) {\r\n    if (frm.doc.letter_of_intends_no_table && frm.doc.letter_of_intends_no_table.length > 0) {\r\n        var lastRowLoiNo = frm.doc.letter_of_intends_no_table[frm.doc.letter_of_intends_no_table.length - 1].loi_no;\r\n        frm.set_value('loi', lastRowLoiNo);\r\n        console.log(lastRowLoiNo,'number')\r\n    }\r\n}\r\n});\r\n \r\nfunction addDataToChildTable(frm, data) {\r\n    var childTable = frm.fields_dict['letter_of_intends_no_table'].grid;\r\n    var newRow = childTable.add_new_row();\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'loi_no', data.loi_no);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'principal', data.principal);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'tender_no', data.tender_no);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'project_description', data.project_description);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'letter_of_intent_date', data.letter_of_intent_date);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'bond_value', data.bond_value);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'project_sum', data.project_sum);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'bond_facility_no', data.bond_facility_no);\r\n    childTable.refresh();\r\n    calculate_intend_issued(frm);\r\n}\r\n \r\n \r\n \r\nfunction calculate_intend_issued(frm){\r\n    var childTableData = frm.doc.letter_of_intends_no_table || [];\r\n \r\n    // Calculate Total Turnover\r\n    var totalBondValue = childTableData.reduce(function(bond_value, row) {\r\n        // Convert row.turnover to a number using parseFloat or parseInt\r\n        var rowBondValue = parseFloat(row.bond_value) || 0; // Convert to float; default to 0 if NaN\r\n \r\n        return bond_value + rowBondValue;\r\n    }, 0);\r\n \r\n    // Update Total Turnover field in the form\r\n    frm.set_value('total_letter_of_intend_issued', totalBondValue);\r\n}\r\n\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Renewals",
  "enabled": 1,
  "modified": "2025-12-10 07:52:40.386327",
  "module": null,
  "name": "Renewals",
  "script": "frappe.ui.form.on('Renewals', {\r\n//new code\r\nrefresh(frm) {\r\n\r\n    if (frm.doc.workflow_state === 'Approved') {\r\n\r\n        frm.add_custom_button(__('Prepare Invoice'), function () {\r\n\r\n            if (frm.doc.other_bonds === 1 && frm.doc.deputyshreiff_bond === 1) {\r\n                frappe.msgprint(\"Please select only one type of bond.\");\r\n                return;\r\n            }\r\n\r\n            // ----------------------------------------------------------------------\r\n            // \ud83d\udd0d COMMON LOGIC: CHECK IF PREPARE INVOICE ALREADY EXISTS\r\n            // ----------------------------------------------------------------------\r\n            frappe.call({\r\n                method: \"frappe.client.get_list\",\r\n                args: {\r\n                    doctype: \"Prepare Invoice\",\r\n                    filters: {\r\n                        credsure_refno: frm.doc.extension_req_no      // <--- Unique Linking Field\r\n                    },\r\n                    fields: [\"name\"]\r\n                },\r\n                callback: function (r) {\r\n\r\n                    // \u2714 If Exists \u2192 Open It\r\n                    if (r.message && r.message.length > 0) {\r\n                        frappe.set_route(\"Form\", \"Prepare Invoice\", r.message[0].name);\r\n                        return;\r\n                    }\r\n\r\n                    // \u274c If NOT exists \u2192 create NEW\r\n                    // Now we continue your original logic\r\n                    // ----------------------------------------------------------------------\r\n                    // \ud83d\udd35 CASE 1: DEPUTY SHERIFF BOND\r\n                    // ----------------------------------------------------------------------\r\n                    if (frm.doc.deputyshreiff_bond === 1) {\r\n\r\n                        frappe.route_options = {\r\n                            bond_type: frm.doc.bondtype1,\r\n                            credsure_refno: frm.doc.extension_req_no,\r\n                            bond_period_from: frm.doc.bond_period_from,\r\n                            bond_period_to: frm.doc.bond_period_to,\r\n                            reinsurer_refnumber: frm.doc.bond_no,\r\n                            deputy_sheriff_bond: 1,\r\n                            client: frm.doc.client,\r\n                            principal: frm.doc.principal\r\n                        };\r\n\r\n                        frappe.new_doc(\"Prepare Invoice\");\r\n\r\n                        // Your original Prepare Invoice refresh logic (UNCHANGED)\r\n                        frappe.ui.form.on(\"Prepare Invoice\", {\r\n                            refresh(frm) {\r\n                                frappe.call({\r\n                                    method: \"frappe.client.get_value\",\r\n                                    args: {\r\n                                        doctype: \"Deputy Sheriff Bond\",\r\n                                        filters: { bond_no: frm.doc.reinsurer_refnumber },\r\n                                        fieldname: [\r\n                                            \"premium_without_vat\",\r\n                                            \"premium_rate\",\r\n                                            \"reinsurer\",\r\n                                            \"broker\",\r\n                                            \"premium\",\r\n                                            \"reinsurer_rate\",\r\n                                            \"bond_value\",\r\n                                            \"ecgc_reinsurance_commission\"\r\n                                        ]\r\n                                    },\r\n                                    callback(r) {\r\n                                        if (r && r.message) {\r\n\r\n                                            frm.set_value(\"guarantee_fee_rate\", Number(r.message.premium_rate).toFixed(2));\r\n                                            frm.set_value(\"total_duewith_out_vat\", Number(r.message.premium_without_vat).toFixed(2));\r\n                                            frm.set_value(\"guarantee_amount\", Number(r.message.bond_value).toFixed(2));\r\n                                            frm.set_value(\"credsure_commission\", Number(r.message.ecgc_reinsurance_commission).toFixed(2));\r\n\r\n                                            frm.set_value(\"reinsure\", r.message.reinsurer);\r\n                                            frm.set_value(\"broker\", r.message.broker);\r\n                                            frm.set_value(\"guarantee_fee\", r.message.premium);\r\n                                            frm.set_value(\"reinsurer\", r.message.reinsurer_rate);\r\n\r\n                                        } else {\r\n                                            frappe.msgprint(\"No matching Deputy Sheriff Bond found.\");\r\n                                        }\r\n                                    }\r\n                                });\r\n\r\n                                // Month calculation (unchanged)\r\n                                if (frm.doc.bond_period_from && frm.doc.bond_period_to) {\r\n                                    let from_date = frappe.datetime.str_to_obj(frm.doc.bond_period_from);\r\n                                    let to_date = frappe.datetime.str_to_obj(frm.doc.bond_period_to);\r\n\r\n                                    let monthsDiff =\r\n                                        (to_date.getFullYear() - from_date.getFullYear()) * 12 +\r\n                                        (to_date.getMonth() - from_date.getMonth());\r\n\r\n                                    if (to_date.getDate() < from_date.getDate()) {\r\n                                        monthsDiff--;\r\n                                    }\r\n\r\n                                    frm.set_value('month', monthsDiff);\r\n                                }\r\n                            }\r\n                        });\r\n\r\n                        return;\r\n                    }\r\n\r\n                    // ----------------------------------------------------------------------\r\n                    // \ud83d\udd35 CASE 2: OTHER BONDS\r\n                    // ----------------------------------------------------------------------\r\n                    if (frm.doc.other_bonds === 1) {\r\n\r\n                        frappe.route_options = {\r\n                            credsure_refno: frm.doc.extension_req_no,\r\n                            bond_period_from: frm.doc.bond_period_from,\r\n                            bond_period_to: frm.doc.bond_period_to,\r\n                            guarantee_amount: frm.doc.bond_value,\r\n                            reinsurer_refnumber: frm.doc.bond_no,\r\n                            client: frm.doc.client,\r\n                            principal: frm.doc.principal,\r\n                            bond_type: frm.doc.bondtype1,\r\n                            other_bonds: 1\r\n                        };\r\n\r\n                        frappe.new_doc(\"Prepare Invoice\");\r\n\r\n                        // Your original refresh logic for Other Bonds (unchanged)\r\n                        frappe.ui.form.on(\"Prepare Invoice\", {\r\n                            refresh(frm) {\r\n                                frappe.call({\r\n                                    method: 'frappe.client.get_list',\r\n                                    args: {\r\n                                        doctype: 'Bond Application',\r\n                                        filters: { bond_no: frm.doc.bond_no },\r\n                                        fields: [\r\n                                            'broker',\r\n                                            'bond_subtype',\r\n                                            'month',\r\n                                            'reinsurer',\r\n                                            'guarantee_amount',\r\n                                            'vat',\r\n                                            'guarantee_fee_p',\r\n                                            'guarantee_fee',\r\n                                            'beci_commission_p',\r\n                                            'portion_of_guarantee_guarantee_vat_p'\r\n                                        ]\r\n                                    },\r\n                                    callback: function (r) {\r\n                                        if (r.message && r.message.length > 0) {\r\n                                            let bondApp = r.message[0];\r\n\r\n                                            frm.set_value('month', bondApp.month);\r\n                                            frm.set_value('broker', bondApp.broker);\r\n                                            frm.set_value('reinsure', bondApp.reinsurer);\r\n                                            frm.set_value('guarantee_fee', bondApp.guarantee_fee_p);\r\n                                            frm.set_value('guarantee_fee_rate', bondApp.guarantee_fee);\r\n                                            frm.set_value('credsure_commission', bondApp.beci_commission_p);\r\n                                            frm.set_value('reinsurer', bondApp.portion_of_guarantee_guarantee_vat_p);\r\n                                            frm.set_value('vat', bondApp.vat);\r\n\r\n                                        }\r\n                                    }\r\n                                });\r\n                            }\r\n                        });\r\n\r\n                        return;\r\n                    }\r\n\r\n                    frappe.msgprint(\"Please select Other Bonds or Deputy Sheriff Bond.\");\r\n                }\r\n            });\r\n        }).addClass(\"btn-primary\");\r\n    }\r\n},\r\n\r\n    \r\n    \r\nonload(frm) {\r\n\r\n    if (frm.doc.deputyshreiff_bond == 1) {\r\n        deputyshrieffbonds(frm)\r\n    } \r\n    \r\n    else if(frm.doc.other_bonds == 1){\r\n        otherbons(frm)\r\n    }\r\n     if (!frm.is_new()) return;\r\n\r\n        let currentYear = new Date().getFullYear();\r\n        let prefix = `BRQ/${currentYear}/`;\r\n\r\n        let lastRenewal = 0;\r\n        let lastExtension = 0;\r\n\r\n        // Get last number from Renewals\r\n        frappe.call({\r\n            method: \"frappe.client.get_list\",\r\n            args: {\r\n                doctype: \"Renewals\",\r\n                fields: [\"extension_req_no\"],\r\n                filters: { extension_req_no: [\"like\", `${prefix}%`] },\r\n                order_by: \"extension_req_no desc\",\r\n                limit_page_length: 1\r\n            },\r\n            callback: function (r) {\r\n                if (r.message && r.message.length > 0) {\r\n                    let parts = r.message[0].extension_req_no.split(\"/\");\r\n                    lastRenewal = parseInt(parts[2]);\r\n                }\r\n\r\n                // Now check Bond Extensions\r\n                frappe.call({\r\n                    method: \"frappe.client.get_list\",\r\n                    args: {\r\n                        doctype: \"Bond Extensions\",\r\n                        fields: [\"extension_req_no\"],\r\n                        filters: { extension_req_no: [\"like\", `${prefix}%`] },\r\n                        order_by: \"extension_req_no desc\",\r\n                        limit_page_length: 1\r\n                    },\r\n                    callback: function (r2) {\r\n                        if (r2.message && r2.message.length > 0) {\r\n                            let parts2 = r2.message[0].extension_req_no.split(\"/\");\r\n                            lastExtension = parseInt(parts2[2]);\r\n                        }\r\n\r\n                        // FINAL number\r\n                        let next = Math.max(lastRenewal, lastExtension) + 1;\r\n                        frm.set_value(\"extension_req_no\", prefix + next.toString().padStart(4, \"0\"));\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    \r\n\r\n    \r\n    // if (frm.doc.deputyshreiff_bond == 1) {\r\n    //     deputyshrieffbonds(frm)\r\n    // } \r\n    \r\n    // else if(frm.doc.other_bonds == 1){\r\n    //     otherbons(frm)\r\n    // }\r\n},\r\nbond_holder(frm) {\r\n\r\nfrm.set_value('bond_no', '');\r\nfrm.set_value('request_date', '');\r\nfrm.set_value('client', '');\r\nfrm.set_value('principal', '');\r\nfrm.set_value('project', '');\r\nfrm.set_value('description', '');\r\nfrm.set_value('bond_period_from', '');\r\nfrm.set_value('bond_period_to', '');\r\nfrm.set_value('bond_value', '');\r\nfrm.set_value('request_date', '');\r\nfrm.set_value('bondtype1', '');\r\nfrm.set_value('new_bond_value', '');\r\n\r\nif(frm.doc.other_bonds == 1 ){\r\nfrm.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Bond Application',\r\n        filters: {\r\n            facility_name: frm.doc.bond_holder,\r\n            workflow_state: \"Approved\"\r\n        },\r\n        fields: ['bond_no']\r\n    },\r\n    callback: function(response) {\r\n        console.log(response, 'Get the data12');\r\n        if (response.message && response.message.length > 0) {\r\n            let DataArray = response.message;\r\n            let FinalArray = DataArray.map(x => x.bond_no);\r\n            frm.set_df_property('bond_no', 'options', FinalArray.join('\\n'));\r\n        }\r\n    },\r\n    error: function(xhr, textStatus, errorThrown) {\r\n        console.error(\"Error fetching details from Bond Application:\", textStatus, errorThrown);\r\n    }\r\n});\r\n}\r\n\r\nif(frm.doc.deputyshreiff_bond == 1 ){\r\n\r\nfrm.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Deputy Sheriff Bond',\r\n        filters: {\r\n            sheriff_name: frm.doc.bond_holder,\r\n            workflow_state: \"Approved\"\r\n        },\r\n        fields: ['bond_no']\r\n    },\r\n    callback: function(response) {\r\n        console.log(response, 'Get the data');\r\n        if (response.message && response.message.length > 0) {\r\n            let DataArray = response.message;\r\n            let FinalArray = DataArray.map(x => x.bond_no);\r\n            \r\n            FinalArray.sort();\r\n            frm.set_df_property('bond_no', 'options', FinalArray.join('\\n'));\r\n        }\r\n    },\r\n    error: function(xhr, textStatus, errorThrown) {\r\n        console.error(\"Error fetching details from Bond Application:\", textStatus, errorThrown);\r\n    }\r\n});\r\n}\r\n    },\r\n    //  when bond select fetch the data from bond application\r\nbond_no(frm) {\r\n       \r\n            var bondno = frm.doc.bond_no;\r\n           frm.set_value('bond_no',bondno);\r\n        if(frm.doc.other_bonds == 1 ){\r\n            frm.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Bond Application',\r\n                filters: {\r\n                    bond_no: frm.doc.bond_no,\r\n                    workflow_state: \"Approved\"\r\n                },\r\n                fields: ['facility_name', 'bond_no', 'reg_date', 'bond_in_favour', 'project', 'description_contract', 'period_from', 'to', 'amount_in_pula', 'reg_no', 'bond_type'],\r\n                 limit_page_length: 100\r\n            },\r\n            callback: function(r) {\r\n                console.log(r, \"client details\");\r\n                // frm.set_df_property('bond_no', 'read_only', 1);\r\n                if (r.message && r.message.length > 0) {\r\n                    var bondNoWithClient = r.message[0].bond_no + ' - ' + r.message[0].facility_name;\r\n                    //frm.set_value('bond_no', bondNoWithClient);\r\n                    //frm.set_value('renewal_req_no', r.message[0].reg_date);\r\n                    frm.set_value('client', r.message[0].facility_name);\r\n                    frm.set_value('principal', r.message[0].bond_in_favour);\r\n                    frm.set_value('project', r.message[0].project);\r\n                    frm.set_value('description', r.message[0].description_contract);\r\n                    frm.set_value('bond_period_from', r.message[0].period_from);\r\n                    frm.set_value('bond_period_to', r.message[0].to);\r\n                    frm.set_value('bond_value', r.message[0].amount_in_pula);\r\n                    // frm.set_value('renewal_req_no', r.message[0].reg_no);\r\n                    frm.set_value('bondtype1', r.message[0].bond_type);\r\n                    frm.set_value('new_bond_value', r.message[0].amount_in_pula);\r\n                }\r\n            }\r\n        });\r\n        }\r\n        // deputyshreiff select fetch the data from  DeputySheriffBond_Details\r\n        if(frm.doc.deputyshreiff_bond == 1 ){\r\n             frm.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Deputy Sheriff Bond',\r\n                filters: {\r\n                   bond_no: frm.doc.bond_no,\r\n                   workflow_state: \"Approved\"\r\n                },\r\n                fields: ['sheriff_name', 'bond_no', 'period_from', 'bond_value', 'description_of_contract', 'period_to','premium_rate']  \r\n            },\r\n            callback: function(r) {\r\n                console.log(r, \"client details\");\r\n                // frm.set_df_property('bond_no', 'read_only', 1);\r\n              if (r.message && r.message.length > 0) {\r\n                   var message = r.message[0]; \r\n                    \r\n                    frm.set_value('new_premium_rate', message.premium_rate);\r\n                    frm.set_value('bond_period_from', message.period_from);\r\n                    frm.set_value('description', message.description_of_contract);\r\n                    frm.set_value('bond_period_to', message.period_to);\r\n                    frm.set_value('bond_value', message.bond_value);\r\n                    frm.set_value('new_bond_value', message.bond_value);\r\n                    frm.set_value('client', message.sheriff_name); \r\n                    frm.set_value('principal', message.sheriff_name);\r\n                    frm.set_value('bondtype1', 'DEPUTY SHREIFF BOND');\r\n\r\n                }\r\n            }\r\n        });\r\n        }\r\n    },\r\n\t// others bond selected fetch the bond holder from the bond application\r\nother_bonds(frm) {\r\n     \r\n         var other_bonds = frm.doc.other_bonds;\r\n        \r\n        if(other_bonds == 1){\r\n            \r\n             var other_bonds = frm.doc.other_bonds;\r\n              frappe.call({\r\n              method: 'frappe.client.get_list',\r\n              args: {\r\n             doctype: 'Bond Application',\r\n              filters: {\r\n                    workflow_state: \"Approved\"  \r\n                },\r\n          fields: ['facility_name'],\r\n          limit_page_length: 0\r\n    },\r\n    callback: function(response) {\r\n        console.log(\"facility_name received:\", response);\r\n       let uniquedata = new Set(response.message.map(item => item.facility_name));\r\n       let FinalArray = Array.from(uniquedata);\r\n       \r\n       FinalArray.sort();\r\n       frm.set_df_property('bond_holder', 'options', FinalArray.join('\\n'));\r\n       console.log(\"final\", FinalArray);\r\n    },\r\n    error: function(xhr, textStatus, errorThrown) {\r\n        console.error(\"Error fetching policy_holder:\", textStatus, errorThrown);\r\n    }\r\n});\r\n      \r\n        \r\n        }\r\n        else{\r\n            let FinalArray = []\r\n            frm.set_df_property('bond_holder', 'options', FinalArray);\r\n        }\r\n        \r\n        var other_bonds = frm.doc.other_bonds;\r\n        if (other_bonds === 0) {\r\n            // Clear all fields when 'other_bonds' is unchecked\r\n\r\n            frm.set_value('bond_holder', '');\r\n            frm.set_value('bond_no', '');\r\n            // frm.set_value('bond_no', '');\r\n            frm.set_value('request_date', '');\r\n            frm.set_value('client', '');\r\n            frm.set_value('principal', '');\r\n            frm.set_value('project', '');\r\n            frm.set_value('description', '');\r\n            frm.set_value('bond_period_from', '');\r\n            frm.set_value('bond_period_to', '');\r\n            frm.set_value('bond_value', '');\r\n            frm.set_value('request_date', '');\r\n            frm.set_value('bondtype1', '');\r\n            frm.set_value('new_bond_value', '');\r\n        }\r\n\r\n\r\n    },\r\n// deputy sheiffbond selected fetch the bond holder from the deputyshreiff_bond\r\ndeputyshreiff_bond(frm) {\r\n            \r\n        var deputyshreiff = frm.doc.deputyshreiff_bond;\r\n        if (deputyshreiff === 1) {\r\n    // Fetch details from deputyshreiff_bond \r\n             frappe.call({\r\n              method: 'frappe.client.get_list',\r\n              args: {\r\n             doctype: 'Deputy Sheriff Bond',\r\n              filters: {\r\n                    workflow_state: \"Approved\" \r\n                },\r\n          fields: ['sheriff_name'],\r\n          limit_page_length: 0\r\n    },\r\n    callback: function(response) {\r\n        console.log(\"sheriff_name received:\", response);\r\n        let uniquedata = new Set(response.message.map(item => item.sheriff_name));\r\n        let FinalArray = Array.from(uniquedata);\r\n        \r\n        FinalArray.sort();\r\n        frm.set_df_property('bond_holder', 'options', FinalArray.join('\\n'));\r\n        console.log(\"final\", FinalArray);\r\n    },\r\n    error: function(xhr, textStatus, errorThrown) {\r\n        console.error(\"Error fetching policy_holder:\", textStatus, errorThrown);\r\n    }\r\n});\r\n            \r\n        } else {\r\n\r\n            let FinalArray = []\r\n            frm.set_df_property('bond_holder', 'options', FinalArray);\r\n            console.log(\"bond_holder\",frm.doc.bond_holder)\r\n            \r\n             frm.set_value('bond_holder', '');\r\n            frm.set_value('bond_no', '');\r\n            frm.set_value('bond_period_from', '');\r\n            frm.set_value('description', '');\r\n            frm.set_value('bond_period_to', '');\r\n            frm.set_value('bond_value', '');\r\n             frm.set_value('client', '');\r\n            frm.set_value('principal', '');\r\n        }\r\n    },\r\n    \r\n   \r\n\r\n \r\n\r\n    \r\n});\r\n\r\nfunction handleFieldChange(frm, field, field1) {\r\n    return function() { // Return a function to be executed when onchange event occurs\r\n        console.log(field + \" onchange triggered\");\r\n        var value = frm.doc[field];\r\n        console.log(\"value:\", value);\r\n        frm.doc[field1] = value;\r\n        frm.refresh_field(field1);\r\n    };\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Next Renewal",
  "enabled": 1,
  "modified": "2024-05-06 07:07:59.048508",
  "module": null,
  "name": "Next Renewal",
  "script": "function prepare_invoice(frm) {\r\n    console.log(\"hiii\");\r\n    if (frm.doc.bond_holder) {\r\n        console.log(\"hello\");\r\n        if (frm.doc.other_bonds === 1 && frm.doc.deputyshireff_bond === 1) {\r\n            frappe.msgprint('Please select only one type of bond.');\r\n        } else if (frm.doc.other_bonds === 1) {\r\n            console.log('calling Api');\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Bond Application',\r\n                    filters: {\r\n                        facility_name: frm.doc.bond_holder\r\n                    },\r\n                    fields: ['beci_ref_number', 'guarantee_amount', 'month', 'guarantee_fee', 'guarantee_fee_p', 'reinsurer', 'beci_commission_p', 'reinsurer_commissions', 'reinsurer_refnumber', 'portion_of_guarantee_guarantee_vat_p', 'portion_of_guarantee_to_beci', 'reinsurer_portion_of_guarantee_fee_p', 'beci_portion_of_gurantee_amount_p', 'beci_commission', 'beci_commission_p', 'vat', 'reinsurer_commissions', 'reinsurer_refnumber']\r\n                },\r\n                callback: function(r) {\r\n                    console.log(r, 'hello');\r\n                    let extensionData = r.message[0];\r\n                    // Check if bond_holder is defined and not empty\r\n                    if (frm.doc.bond_holder) {\r\n                        frappe.model.with_doctype('Renewal Prepare Invoice', function() {\r\n                            var doc = frappe.model.get_new_doc('Renewal Prepare Invoice');\r\n                            doc.bond_holder = frm.doc.bond_holder;\r\n                            doc.bond_no = frm.doc.bond_no;\r\n                            doc.date = frm.doc.date;\r\n                            doc.client = frm.doc.client;\r\n                            doc.principal = frm.doc.principal;\r\n                            doc.project = frm.doc.project;\r\n                            doc.description = frm.doc.description;\r\n                            doc.bond_period_from = frm.doc.bond_period_from;\r\n                            doc.bond_period_to = frm.doc.bond_period_to;\r\n                            doc.bond_value = frm.doc.bond_value;\r\n                            doc.renewal_req_no = frm.doc.renewal_req_no;\r\n                            doc.bond_type = frm.doc.bond_type1;\r\n                            doc.beci_refno = extensionData.beci_ref_number;\r\n                            doc.guarantee_amount = extensionData.guarantee_amount;\r\n                            doc.month = extensionData.month;\r\n                            doc.guarantee = extensionData.guarantee_fee;\r\n                            doc.guarantee_fee = extensionData.guarantee_fee_p;\r\n                            doc.reinsure = extensionData.reinsurer;\r\n                            doc.portion_of_guarantee_amount_to_reinsurer = extensionData.portion_of_guarantee_guarantee_vat_p;\r\n                            doc.portion_of_guarantee_amount_to__beci = extensionData.portion_of_guarantee_to_beci;\r\n                            doc.portion_of_guarantee_fee_to_reinsurer = extensionData.portion_of_guarantee_guarantee_vat_p;\r\n                            doc.portion_of_guarantee_fee_to_beci = extensionData.portion_of_guarantee_to_beci;\r\n                            doc.beci_commission = extensionData.beci_commission;\r\n                            doc.beci_commission_ = extensionData.beci_commission_p;\r\n                            doc.vat_ = extensionData.vat;\r\n                            doc.total = extensionData.guarantee_fee_p;\r\n                            doc.reinsurer_ = extensionData.reinsurer_commissions;\r\n                            doc.reinsurer_ref_number = extensionData.reinsurer_refnumber;\r\n                            doc.total_due__with_out_vat = extensionData.guarantee_fee;\r\n                            // Calculate vat1 based on vat and guarantee_fee_p\r\n                            doc.vat = ((extensionData.vat + extensionData.guarantee_fee) / 100).toFixed(2);\r\n                            doc.total_due = (parseFloat(extensionData.guarantee_fee) + parseFloat(doc.vat)).toFixed(2);\r\n\r\n                            // set the other bonds\r\n                            doc.other_bonds = frm.doc.other_bonds;\r\n\r\n                            //Save the current document before navigating to the next doctype\r\n                            frappe.call({\r\n                                method: 'frappe.client.insert',\r\n                                args: {\r\n                                    doc: doc\r\n                                },\r\n                                callback: function(response) {\r\n                                    if (!response.exc) {\r\n                                        frappe.set_route('Form', 'Renewal Prepare Invoice', response.message.name);\r\n                                    }\r\n                                }\r\n                            });\r\n                        });\r\n                    }\r\n                }\r\n            });\r\n        } else if (frm.doc.deputyshireff_bond === 1) {\r\n            console.log('deputyshireff_bond');\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Deputy Sheriff Bond',\r\n                    filters: {\r\n                        bond_no: frm.doc.beci_ref_no\r\n                    },\r\n                },\r\n                callback: function(r) {\r\n                    console.log(r, 'hello');\r\n                    let extensionData = r.message[0];\r\n                    // Check if bond_holder is defined and not empty\r\n                    if (frm.doc.bond_holder) {\r\n                        frappe.model.with_doctype('Renewal Prepare Invoice', function() {\r\n                            var doc = frappe.model.get_new_doc('Renewal Prepare Invoice');\r\n                            doc.bond_holder = frm.doc.bond_holder;\r\n                            doc.bond_no = frm.doc.bond_no;\r\n                            doc.date = frm.doc.date;\r\n                            doc.client = frm.doc.client;\r\n                            doc.principal = frm.doc.principal;\r\n                            doc.project = frm.doc.project;\r\n                            doc.description = frm.doc.description;\r\n                            doc.bond_period_from = frm.doc.bond_period_from;\r\n                            doc.bond_period_to = frm.doc.bond_period_to;\r\n                            doc.bond_value = frm.doc.bond_value;\r\n                            doc.renewal_req_no = frm.doc.renewal_req_no;\r\n                            doc.bond_type = frm.doc.bond_type1;\r\n\r\n                            frappe.call({\r\n                                method: 'frappe.client.get_list',\r\n                                args: {\r\n                                    doctype: 'Deputy Sheriff Prepare Invoice',\r\n                                    filters: {\r\n                                        ecgc_refno: frm.doc.beci_ref_no\r\n                                    },\r\n                                    fields: ['ecgc_refno', 'guarantee_amount', 'month', 'guarantee_fee_rate', 'reinsure', 'date', 'reinsurer_ref_number', 'reinsurer_', 'portion_of_guarantee_amount_to_reinsurer', 'portion_of_guarantee_fee_to_reinsurer', 'ecgc_comission_', 'broker', 'broker_', 'broker_commission', 'total_due_with_out_vat', 'vat_', 'vat', 'total_due', 'invoice_date', 'bond_period_to', 'guarantee_fee', 'ecgc_', 'portion_of_guarantee_amount_to_ecgc', 'portion_of_guarantee_fee_to_ecgc', 'ecgc_commission']\r\n                                },\r\n                                callback: function(response) {\r\n                                    if (response.message && response.message.length > 0) {\r\n                                        console.log(response.message, \"response data\");\r\n                                        let prepareInvoiceData = response.message[0];\r\n                                        console.log(prepareInvoiceData, 'deputy shireff prepare invoice data');\r\n                                        doc.beci_refno = prepareInvoiceData.ecgc_refno;\r\n                                        doc.guarantee_amount = prepareInvoiceData.guarantee_amount;\r\n                                        doc.month = prepareInvoiceData.month;\r\n                                        doc.guarantee = prepareInvoiceData.guarantee_fee_rate;\r\n                                        doc.reinsure = prepareInvoiceData.reinsure;\r\n                                        doc.bond_period_from = prepareInvoiceData.date;\r\n                                        doc.reinsurer_ref_number = prepareInvoiceData.reinsurer_ref_number;\r\n                                        doc.reinsurer_ = prepareInvoiceData.reinsurer_;\r\n                                        doc.portion_of_guarantee_amount_to_reinsurer = prepareInvoiceData.portion_of_guarantee_amount_to_reinsurer;\r\n                                        // doc.portion_of_guarantee_fee_to_reinsurer   = prepareInvoiceData.portion_of_guarantee_fee_to_reinsurer;\r\n                                        doc.beci_commission_ = prepareInvoiceData.ecgc_comission_;\r\n                                        doc.broker = prepareInvoiceData.broker;\r\n                                        doc.broker_ = prepareInvoiceData.broker_;\r\n                                        doc.broker_commission = prepareInvoiceData.broker_commission;\r\n                                        doc.total_due__with_out_vat = prepareInvoiceData.total_due_with_out_vat;\r\n                                        doc.vat_ = prepareInvoiceData.vat_;\r\n                                        doc.vat = prepareInvoiceData.vat;\r\n                                        doc.total_due = prepareInvoiceData.total_due;\r\n                                        doc.invoice_date = prepareInvoiceData.invoice_date;\r\n                                        doc.bond_period_to = prepareInvoiceData.bond_period_to;\r\n                                        doc.guarantee_fee = prepareInvoiceData.guarantee_fee;\r\n                                        doc.beci_ = prepareInvoiceData.ecgc_;\r\n                                        doc.portion_of_guarantee_amount_to__beci = prepareInvoiceData.portion_of_guarantee_amount_to_ecgc;\r\n                                        // doc.portion_of_guarantee_fee_to_beci =prepareInvoiceData.portion_of_guarantee_fee_to_ecgc;\r\n                                        doc.ecgc_commission = prepareInvoiceData.ecgc_commission;\r\n                                        doc.deputyshreiff_bond = frm.doc.deputyshireff_bond;\r\n                                    } else {\r\n                                        console.log(\"No Deputy Sheriff Prepare Invoice found for the given criteria.\");\r\n                                    }\r\n\r\n                                    // Save the current document before navigating to the next doctype\r\n                                    frappe.call({\r\n                                        method: 'frappe.client.insert',\r\n                                        args: {\r\n                                            doc: doc\r\n                                        },\r\n                                        callback: function(response) {\r\n                                            if (!response.exc) {\r\n                                                frappe.set_route('Form', 'Renewal Prepare Invoice', response.message.name);\r\n                                            }\r\n                                        }\r\n                                    });\r\n                                }\r\n                            });\r\n                        });\r\n                    } else {\r\n                        console.log(\"No Deputy Sheriff Bond found for the given sheriff name.\");\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    }\r\n}\r\n\r\nfrappe.ui.form.on('Next Renewal', {\r\n    refresh: function(frm) {\r\n        console.log(\"hellooo\");\r\n        // Uncomment this section if you want to call prepare_invoice function when the form refreshes\r\n        if (frm.doc.workflow_state === 'Approved') {\r\n            frm.add_custom_button(__('Prepare Invoice'), function() {\r\n                prepare_invoice(frm);\r\n            }).addClass(\"btn-primary\");\r\n        }\r\n    },\r\n});\r\n",
  "view": "Form"
 },
 {
  "_liked_by": "[]",
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Security",
  "enabled": 1,
  "modified": "2025-11-10 09:01:56.841252",
  "module": "UnderWriting",
  "name": "Generate",
  "script": "frappe.ui.form.on('Security', {\n     \n        \n    onload: function(frm) {\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Bond Facility Quotation Acceptance',\n                filters: {\n                   // workflow_state: \"Accepted\"\n                },\n                fields: ['name1'],\n                \n                 limit_page_length: 0\n            },\n            callback: function(response) {\n                console.log(\"Client names received:\", response);\n                let finalArray = response.message.map(x => x.name1);\n                frm.set_df_property('name1', 'options', finalArray);\n                console.log(\"Final array:\", finalArray);\n            },\n            error: function(xhr, textStatus, errorThrown) {\n                console.error(\"Error fetching approved bonds:\", textStatus, errorThrown);\n            }\n        });\n    },\n\n    refresh: function(frm) { \n        \n      \n       \nfrm.fields_dict.total_security_registered.$input.css(\"text-align\", \"right\");\n frm.fields_dict.released_security.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.net_security.$input.css(\"text-align\", \"right\");\n \n        frm.fields_dict.add_security.$input.addClass('btn-primary');\n        frm.set_df_property('link', 'cannot_add_rows', true);\n    },\n\n    name1: function(frm) {\n        var name = frm.doc.name1;\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Bond Facility Quotation Acceptance',\n                filters: { name1: name },\n                fields: ['name1', 'quotation_no', 'faciity_no', 'currency5']\n            },\n            callback: function(response) {\n                console.log(\"Bond Facility response:\", response);\n                if (response.message && response.message.length > 0) {\n                    var data = response.message[0];\n                    frm.set_value('name1', data.name1 || '');\n                    frm.set_value('quotation_no', data.quotation_no || '');\n                    frm.set_value('facility_no', data.faciity_no || '');\n                     frm.set_value('facilityamount', data.currency5 || '');\n                } else {\n                    frm.set_value('name1', \"\");\n                    frm.set_value('quotation_no', \"\");\n                    frm.set_value('facility_no', \"\");\n                     frm.set_value('facilityamount', \"\");\n                    frappe.msgprint('No matching record found in Bond Facility.');\n                }\n            },\n            error: function(err) {\n                console.error(err);\n                frappe.msgprint('An error occurred while fetching data from DCI Proposals. Please check the console for details.');\n            }\n        });\n    },\n\n    add_security: function(frm) {\n        function getNextIdNo() {\n            var currentYear = (new Date()).getFullYear();\n            var currentNumber = 1;\n            var lastIdNo;\n\n            if (!frm.doc.link || frm.doc.link.length === 0) {\n                frappe.call({\n                    method: 'frappe.client.get_list',\n                    args: {\n                        doctype: 'Security',\n                        fields: ['id', 'creation'],\n                        order_by: 'creation desc',\n                        limit: 1\n                    },\n                    async: false,\n                    callback: function(response) {\n                        if (response.message && response.message[0]) {\n                            lastIdNo = response.message[0].id;\n                        }\n                    }\n                });\n            } else {\n                lastIdNo = localStorage.getItem('last_id_no');\n            }\n\n            if (lastIdNo) {\n                var lastNumber = parseInt(lastIdNo.split('/')[2]);\n                currentNumber = lastNumber + 1;\n            }\n\n            var nextIdNo = `SID/${currentYear}/${('000' + currentNumber).slice(-4)}`;\n            return nextIdNo;\n        }\n\n        frappe.prompt([\n            {'fieldname': 'id', 'fieldtype': 'Data', 'label': 'ID', 'default': getNextIdNo()},\n            {'fieldname': 'securitytype', 'fieldtype': 'Select', 'options': 'BOARD RESOLUTION\\nCASH DEPOSIT\\nCOUNTER INDEMNITY\\nCASH INVESTMENT\\nMORTGAGE\\nPERSONAL SURITIES\\nRECIPROCAL INDEMNITY', 'label': 'Security Type'},\n            {'fieldname': 'details2', 'fieldtype': 'Text', 'label': 'Details','reqd':1},\n             {'fieldname': '', 'fieldtype': 'Column Break', 'label': ''},\n              {'fieldname': 'status', 'fieldtype': 'Select','options': 'In Use\\nRelease', 'label': 'Status'},\n            {'fieldname': 'security_value', 'fieldtype': 'Int', 'label': 'Security Value'},\n            {'fieldname': 'security_signed_by', 'fieldtype': 'Data', 'label': 'Security Signed By', 'reqd': 1},\n           \n           \n        ],\n        function(values) {\n            var data = {\n                id: values.id,\n                securitytype: values.securitytype,\n                details2: values.details2,\n                security_value: values.security_value,\n                security_signed_by: values.security_signed_by,\n                status: values.status,\n            };\n\n            var nextIdNo = getNextIdNo();\n            localStorage.setItem('last_id_no', nextIdNo);\n\n            addDataToChildTable(frm, data);\n        },\n        'Security');\n    },\n\n    before_save: function(frm) {\n        if (frm.doc.link && frm.doc.link.length > 0) {\n        var lastRowLoiNo = frm.doc.link[frm.doc.link.length - 1].id;\n        frm.set_value('id', lastRowLoiNo);\n        console.log(lastRowLoiNo,'number')\n    }\n    }\n });\n\nfunction addDataToChildTable(frm, data) {\n    var childTable = frm.fields_dict['link'].grid;\n    var newRow = childTable.add_new_row();\n    frappe.model.set_value(newRow.doctype, newRow.name, 'id', data.id);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'securitytype', data.securitytype);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'details2', data.details2);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'security_value', data.security_value);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'security_signed_by', data.security_signed_by);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'status', data.status);\n    childTable.refresh();\n    calculate_intend_issued(frm);\n}\n\n\nfunction calculate_intend_issued(frm) {\n    var childTableData = frm.doc.link || [];\n\n    // Initialize total values\n    var totalSecurityValue = 0;\n    var releasedSecurityValue = 0;\n\n    // Calculate Total Security Value and Released Security Value\n    childTableData.forEach(function(row) {\n        var rowSecurityValue = parseFloat(row.security_value) || 0; // Convert to float; default to 0 if NaN\n\n        // Add to Total Security Registered\n        totalSecurityValue += rowSecurityValue;\n\n        // If status is 'release', add to Released Security\n        if (row.status && row.status.toLowerCase() === 'release') {\n            releasedSecurityValue += rowSecurityValue;\n        }\n    });\n\n    // Calculate Net Security as Total Security Registered minus Released Security\n    var netSecurityValue = totalSecurityValue - releasedSecurityValue;\n\n    // Update the fields in the form with calculated values\n    frm.set_value('total_security_registered', totalSecurityValue);\n    frm.set_value('released_security', releasedSecurityValue);\n    frm.set_value('net_security', netSecurityValue);\n\n    // Align the fields to the right\n    //frm.fields_dict.total_security_registered.$input.css(\"text-align\", \"right\");\n    frm.fields_dict.released_security.$input.css(\"text-align\", \"right\");\n    frm.fields_dict.net_security.$input.css(\"text-align\", \"right\");\n}\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Agenda and Endorsements for ECI Quotation",
  "enabled": 1,
  "modified": "2024-07-03 13:46:49.729841",
  "module": null,
  "name": "fetch policy data",
  "script": "frappe.ui.form.on('Agenda and Endorsements for ECIS', {\r\n    onload: function(frm) {\r\n        var proposalNumber = frm.doc.proposal_no;\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Policy Approvals',\r\n                filters: {\r\n                    proposal_no: proposalNumber\r\n                },\r\n                fields: ['policy_holder', 'policy_number', 'proposal_no'],\r\n                limit: 1\r\n            },\r\n            callback: function(response) {\r\n                if (response && response.message && response.message.length > 0) {\r\n                    var policyApprovalData = response.message[0];\r\n\r\n                    frm.set_value('policy_name', policyApprovalData.policy_holder);\r\n                    frm.set_value('policy_number', policyApprovalData.policy_number);\r\n                    frm.set_value('proposal_no', policyApprovalData.proposal_no);\r\n                } else {\r\n                    frappe.msgprint('No matching record found in Policy Approvals.');\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error('Error fetching data from Policy Approvals:', err);\r\n                frappe.msgprint('An error occurred while fetching data from Policy Approvals.');\r\n            }\r\n        });\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Policy Schedule For ECIS",
  "enabled": 1,
  "modified": "2025-09-29 13:23:31.400703",
  "module": null,
  "name": "fetch data from eci",
  "script": "frappe.ui.form.on('Policy Schedule For ECIS', {\r\n    onload: function(frm) {\r\n           frm.set_df_property('eci_policy', 'cannot_add_rows', true);\r\n        \r\n          $(frm.fields_dict['eci_policy'].grid.wrapper).find('.btn-grid-delete-row').prop('disabled', true);\r\n        // Apply CSS to hide the Edit button\r\n        var css = `\r\n            .btn-open-row {\r\n                display: none !important;\r\n            }\r\n        `;\r\n        $('<style>' + css + '</style>').appendTo('head');\r\n    },\r\n    refresh: function(frm) {\r\n       \r\n        var proposalNumber = frm.doc.proposal_no;\r\n\r\n        // Fetch data from ECI Quotations based on Proposal number\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'ECI Quotations',\r\n                filters: {\r\n                    proposal_no: proposalNumber\r\n                },\r\n                fields: ['inception_date','goods_services','limit_of_descrition','insured_commercial_risks_for_all_insured_companies','franchise_lossp',\r\n                'min_premium_depositp','total_pre_amt','individual_first_lossp','premium_rate','cl_per_monthp','per_enquiryp','premium_rate'], \r\n                limit: 1\r\n            },\r\n            callback: function(response) {\r\n                if (response && response.message && response.message.length > 0) {\r\n                    var inceptionDate = response.message[0].inception_date;\r\n                    var GoodsServices = response.message[0].goods_services;\r\n                    var limitDescription = response.message[0].limit_of_descrition;\r\n                    var insuredCommerical = response.message[0].insured_commercial_risks_for_all_insured_companies;\r\n                    var franchiseLoss = response.message[0].franchise_lossp;\r\n                    var minPremium = response.message[0].min_premium_depositp;\r\n                    var totalPreamt = response.message[0].total_pre_amt;\r\n                    var individualFirstloss = response.message[0].individual_first_lossp;\r\n                    var premiumrate = response.message[0].premium_rate;\r\n                    var cl_per_month = response.message[0].cl_per_monthp;\r\n                    var cl_per_enquiry = response.message[0].per_enquiryp;\r\n                    var premium_rate = response.message[0].premium_rate;\r\n\r\n                    // Function to populate child table\r\n                    function populateChildTable() {\r\n                        // Clear existing rows in the child table\r\n                        frm.clear_table('eci_policy');\r\n\r\n          // Add rows to the child table with each number explicitly mentioned\r\n                                      \r\n            var row1 = frappe.model.add_child(frm.doc, 'ECI Policy Schedule Letter', 'eci_policy');\r\n            row1.section = '1';\r\n            row1.policy = 'Definition 14';\r\n            row1.reference = 'Inception Date: ' + \"   \"+ inceptionDate;\r\n                        \r\n                        \r\nvar row2 = frappe.model.add_child(frm.doc, 'ECI Policy Schedule Letter', 'eci_policy');\r\nrow2.section = '2';\r\nrow2.policy = 'Definition 15';\r\nrow2.reference = 'Goods/Services: ' + \"   \"+ GoodsServices;\r\n\r\n\r\n                         \r\n            var row3 = frappe.model.add_child(frm.doc, 'ECI Policy Schedule Letter', 'eci_policy');\r\n            row3.section = '3';\r\n            row3.policy = 'Definition 8';\r\n            row3.reference = 'Insured percentages:' + \"   \"+ insuredCommerical;                       \r\n                         \r\n            var row4 = frappe.model.add_child(frm.doc, 'ECI Policy Schedule Letter', 'eci_policy');\r\n            row4.section = '4';\r\n            row4.policy = 'Proviso 8B';\r\n            row4.reference = 'Limit of Discretion:' + \"   \"+ limitDescription;\r\n\r\n            var row5 = frappe.model.add_child(frm.doc, 'ECI Policy Schedule Letter', 'eci_policy');\r\n            row5.section = '5';\r\n            row5.policy = 'Definition';\r\n            row5.reference = 'Franchise Loss:' + \"   \"+ franchiseLoss ;\r\n\r\n            var row6 = frappe.model.add_child(frm.doc, 'ECI Policy Schedule Letter', 'eci_policy');\r\n            row6.section = '6(a)';\r\n            row6.policy = 'Proviso 13A';\r\n            row6.reference = 'Minimum Premium:P' + \"   \"+ minPremium ;\r\n\r\n            var row7 = frappe.model.add_child(frm.doc, 'ECI Policy Schedule Letter', 'eci_policy');\r\n            row7.section = '6(b)';\r\n            row7.policy = 'Proviso 13B';\r\n            row7.reference = 'Premium Rate(exclusive of VAT):' + \"   \"+ premiumrate ;\r\n\r\n            // var row8 = frappe.model.add_child(frm.doc, 'ECI Policy Schedule Letter', 'eci_policy');\r\n            // row8.section = '6(c)';\r\n            // row8.policy = 'Proviso 13C';\r\n            // row8.reference = 'per_enquiryp(P per CL):' + cl_per_enquiry;\r\n            \r\n           var row8 = frappe.model.add_child(frm.doc, 'ECI Policy Schedule Letter', 'eci_policy');\r\n           row8.section = '6(c)';\r\n           row8.policy = 'Proviso 13C';\r\n           row8.reference = 'cl_per_monthp(P per CL): ' + \"   \"+ cl_per_month + ',\\nper_enquiryp(P per CL): ' + cl_per_enquiry;\r\n\r\n\r\n\r\n\r\n\r\n            var row9 = frappe.model.add_child(frm.doc, 'ECI Policy Schedule Letter', 'eci_policy');\r\n            row9.section = '7';\r\n            row9.policy = 'Definition 12';\r\n            row9.reference = 'Maximum Liability: P' + \"   \"+ totalPreamt;\r\n\r\n            var row10 = frappe.model.add_child(frm.doc, 'ECI Policy Schedule Letter', 'eci_policy');\r\n            row10.section = '8';\r\n            row10.policy = 'Definition 10';\r\n            row10.reference = 'First Loss Limit: P'  + \"   \"+ individualFirstloss;\r\n            \r\n            \r\n            var row11 = frappe.model.add_child(frm.doc, 'ECI Policy Schedule Letter', 'eci_policy');\r\n            row11.section = '9(a)';\r\n            row11.policy = 'Proviso 26';\r\n            row11.reference = 'Premium rate and Credit Limit fees are exclusive of VAT:'+ \"   \"+ '';\r\n\r\n                        // Add more rows here similarly\r\n\r\n                        // Refresh the child table\r\n                        frm.refresh_field('eci_policy');\r\n                    }\r\n\r\n                    // Call the function to populate child table\r\n                    populateChildTable();\r\n                } else {\r\n                    frappe.msgprint('No matching record found in ECI Quotations.');\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error('Error fetching data from ECI Quotations:', err);\r\n                frappe.msgprint('An error occurred while fetching data from ECI Quotations.');\r\n            }\r\n        });\r\n        \r\n        \r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n          args: {\r\n                doctype: 'Policy Approvals',\r\n                filters: {\r\n                    proposal_no: proposalNumber\r\n                },\r\n                fields: ['policy_holder', 'policy_number','proposal_no','quotation_numbers'],\r\n                limit: 1\r\n            },\r\n            callback: function(response) {\r\n                if (response && response.message && response.message.length > 0) {\r\n                    var policyApprovalData = response.message[0];\r\n \r\n                    frm.set_value('name_of_insured', policyApprovalData.policy_holder);\r\n                    frm.set_value('policy_number', policyApprovalData.policy_number);\r\n                    // frm.set_value('proposal_no', policyApprovalData.proposal_no);\r\n                    frm.set_value('quotation_no', policyApprovalData.quotation_numbers);\r\n                } else {\r\n                    frappe.msgprint('No matching record found in Policy Approvals.');\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error('Error fetching data from Policy Approvals:', err);\r\n                frappe.msgprint('An error occurred while fetching data from Policy Approvals.');\r\n            }\r\n        });\r\n    }\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Cancellation",
  "enabled": 1,
  "modified": "2025-12-05 08:50:28.209757",
  "module": "UnderWriting",
  "name": "Cancellation",
  "script": "\r\nfunction deputyshrieffbonds(frm){\r\n    console.log(\"temp\")\r\n    frm.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Deputy Sheriff Bond',  \r\n                     filters: {\r\n                    workflow_state: \"Approved\",\r\n                },\r\n                    fields: ['sheriff_name'] ,\r\n                    limit_page_length: 0\r\n\r\n                },\r\n                callback: function(response) {\r\n                    console.log(response, 'Get the data')\r\n                    if (response.message && response.message.length > 0) {\r\n                        \r\n                         let DataArray = response.message || [];\r\n                         let FinalArray = DataArray.map(x => x.sheriff_name);\r\n                         \r\n                         FinalArray.sort();\r\n                         frm.set_df_property('bond_holder', 'options', FinalArray);\r\n                     \r\n                        \r\n                    }\r\n                },\r\n                error: function(xhr, textStatus, errorThrown) {\r\n                    console.error(\"Error fetching details from Deputy Shreiff Bond:\", textStatus, errorThrown);\r\n                }\r\n            });\r\n}\r\nfunction otherbons(frm){\r\n    frm.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Bond Application',\r\n                filters: {\r\n                    workflow_state: \"Approved\"\r\n                },\r\n                fields: ['facility_name']\r\n            },\r\n            callback: function(response) {\r\n                console.log(\"facility_name received:\", response);\r\n                let DataArray = response.message || [];\r\n                let FinalArray = DataArray.map(x => x.facility_name);\r\n                \r\n                FinalArray.sort();\r\n                frm.set_df_property('bond_holder', 'options', FinalArray);\r\n                console.log(\"final\", FinalArray);\r\n            },\r\n            error: function(xhr, textStatus, errorThrown) {\r\n                console.error(\"Error fetching approved bonds:\", textStatus, errorThrown);\r\n            }\r\n        });\r\n    \r\n}\r\nfunction handleFieldChange(frm, field, field1) {\r\n    return function() { // Return a function to be executed when onchange event occurs\r\n        console.log(field + \" onchange triggered\");\r\n        var value = frm.doc[field];\r\n        console.log(\"value:\", value);\r\n        frm.doc[field1] = value;\r\n        frm.refresh_field(field1);\r\n    };\r\n}\r\n\r\n\r\n    \r\n\r\nfunction generateNumber(frm) {\r\n\r\n    let currentYear = new Date().getFullYear();\r\n    let prefix = `BRQ/${currentYear}/`;\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Cancellation',\r\n            fields: ['cancellation_req_no'],\r\n            filters: { cancellation_req_no: ['like', `${prefix}%`] },\r\n            limit_page_length: 1000,\r\n            order_by: 'cancellation_req_no desc'\r\n        },\r\n        callback: function (r) {\r\n            if (r.message && r.message.length > 0) {\r\n                let lastReviewNo = r.message[0].cancellation_req_no;\r\n                let parts = lastReviewNo.split(\"/\");\r\n                let lastNumber = parseInt(parts[2]) || 0;\r\n                let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n                frm.set_value('cancellation_req_no', prefix + newNumber);\r\n            } else {\r\n                frm.set_value('cancellation_req_no', prefix + '0001');\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n\r\nfrappe.ui.form.on('Cancellation', {\r\n//   bond_no:function(frm){\r\n//     var bondno = frm.doc.bond_no;\r\n//     frm.set_value('bond_no1',bondno);\r\n//     },\r\n//   date:function(frm){\r\n//     var date = frm.doc.date;\r\n//     frm.set_value('date',date1);\r\n//     },\r\n//   client:function(frm){\r\n//     var client = frm.doc.client;\r\n//     frm.set_value('client',client);\r\n//     },\r\n//   principal:function(frm){\r\n//     var principal = frm.doc.principal;\r\n//     frm.set_value('principal',principal);\r\n//     },\r\n//   description1:function(frm){\r\n//     var description1 = frm.doc.description1;\r\n//     frm.set_value('description2',description1);\r\n//     },\r\n//   description:function(frm){\r\n//     var description = frm.doc.description;\r\n//     frm.set_value('description3',description);\r\n//     },\r\n//   bond_period_from:function(frm){\r\n//     var bond_period_from = frm.doc.bond_period_from;\r\n//     frm.set_value('bond_period_from',bond_period_from);\r\n//     },\r\n//   bond_period_to:function(frm){\r\n//     var bond_period_to = frm.doc.bond_period_to;\r\n//     frm.set_value('bond_period_to1',bond_period_to);\r\n//     },\r\n//   bond_value:function(frm){\r\n//     var bond_value = frm.doc.bond_value;\r\n//     frm.set_value('bond_value1',bond_value);\r\n//     },\r\n//   cancellation_req_no:function(frm){\r\n//     var cancellation_req_no = frm.doc.cancellation_req_no;\r\n//     frm.set_value('cancellation_req_no1',cancellation_req_no);\r\n//     },\r\n//   bondtype1:function(frm){\r\n//     var bondtype1 = frm.doc.bondtype1;\r\n//     frm.set_value('bondtype2',bondtype1);\r\n//     },\r\nrefresh(frm) {\r\n    \r\n    //   frm.fields_dict.cancellation_req_no.$input.css(\"text-align\",\"right\");\r\n        frm.fields_dict.bond_value.$input.css(\"text-align\",\"right\");\r\n        // frm.fields_dict.cancellation_req_no1.$input.css(\"text-align\",\"right\");\r\n        frm.fields_dict.bond_value1.$input.css(\"text-align\",\"right\");\r\n       \r\n        \r\n        \r\n        frm.fields_dict['deputyshreiff_bond'].df.onchange = handleFieldChange(frm, 'deputyshreiff_bond', 'deputyshreiff_bond1');\r\n        frm.fields_dict['other_bonds'].df.onchange = handleFieldChange(frm, 'other_bonds');\r\n        frm.fields_dict['bond_holder'].df.onchange = handleFieldChange(frm, 'bond_holder');\r\n       \r\n          \r\n    // if (frm.doc.bond_no !== \"\") {\r\n    //     frm.set_df_property('bond_no', 'read_only', 0);\r\n    //     frm.set_df_property('bond_no', 'read_only', 1);\r\n    // }\r\n    },\r\nonload(frm) {\r\n    \r\n    \r\n     if (!frm.doc.cancellation_req_no) {\r\n            generateNumber(frm);\r\n        }\r\n    \r\n    if (frm.doc.deputyshreiff_bond == 1) {\r\n        deputyshrieffbonds(frm)\r\n    } \r\n    \r\n    else if(frm.doc.other_bonds == 1){\r\n        otherbons(frm)\r\n    }\r\n},\r\nbond_holder(frm) {\r\n frm.set_value('bond_no', '');\r\n frm.set_value('client', '');\r\n frm.set_value('principal', '');\r\n frm.set_value('description', '');\r\n frm.set_value('bond_period_from', '');\r\n frm.set_value('bond_period_to', '');\r\n frm.set_value('bond_value', '');\r\n frm.set_value('bondtype1', '');\r\n \r\nif(frm.doc.other_bonds == 1 ){\r\nfrm.call({\r\n     method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Bond Application',\r\n        filters: {\r\n            facility_name: frm.doc.bond_holder,\r\n            workflow_state: \"Approved\"\r\n        },\r\n        fields: ['bond_no']\r\n    },\r\n    callback: function(response) {\r\n        console.log(response, 'Get the data');\r\n        if (response.message && response.message.length > 0) {\r\n            let DataArray = response.message;\r\n            console.log(response.message[0].bond_no,\"dattaata\")\r\n            let FinalArray = DataArray.map(x => x.bond_no);\r\n            frm.set_df_property('bond_no', 'options', FinalArray);\r\n           // console.log(bond_no,\"bond number\")\r\n        }\r\n    },\r\n    error: function(xhr, textStatus, errorThrown) {\r\n        console.error(\"Error fetching details from Bond Application:\", textStatus, errorThrown);\r\n    }\r\n});\r\n}\r\nif(frm.doc.deputyshreiff_bond == 1 ){\r\nfrm.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Deputy Sheriff Bond',\r\n        filters: {\r\n            sheriff_name: frm.doc.bond_holder,\r\n            workflow_state: \"Approved\"\r\n        },\r\n        fields: ['bond_no']\r\n    },\r\n    callback: function(response) {\r\n        console.log(response, 'Get the data');\r\n        if (response.message && response.message.length > 0) {\r\n            let DataArray = response.message;\r\n            let FinalArray = DataArray.map(x => x.bond_no);\r\n            frm.set_df_property('bond_no', 'options', FinalArray.join('\\n'));\r\n        }\r\n    },\r\n    error: function(xhr, textStatus, errorThrown) {\r\n        console.error(\"Error fetching details from Bond Application:\", textStatus, errorThrown);\r\n    }\r\n});\r\n}\r\n    },\r\n//  when bond no select fetch the data from bond application\r\nbond_no(frm) {\r\n        console.log(frm.doc.bond_holder, \"frm.doc.bond_holder\");\r\n            var bondno = frm.doc.bond_no;\r\n            frm.set_value('bond_no',bondno);\r\n        if(frm.doc.other_bonds == 1 ){\r\n            frm.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Bond Application',\r\n                filters: {\r\n                    bond_no: frm.doc.bond_no,\r\n                    workflow_state: \"Approved\"\r\n                },\r\n                fields: ['facility_name', 'bond_no', 'reg_date', 'bond_in_favour',  'description_contract', 'period_from', 'to', 'amount_in_pula', 'reg_no', 'bond_type'],\r\n                 limit_page_length: 100\r\n            },\r\n            callback: function(r) {\r\n                console.log(r, \"client details\");\r\n                // frm.set_df_property('bond_no', 'read_only', 1);\r\n                if (r.message && r.message.length > 0) {\r\n                    var bondNoWithClient = r.message[0].bond_no + ' - ' + r.message[0].facility_name;\r\n                    //frm.set_value('bond_no', bondNoWithClient);\r\n                    frm.set_value('client', r.message[0].facility_name);\r\n                    frm.set_value('principal', r.message[0].bond_in_favour);\r\n                    frm.set_value('description', r.message[0].description_contract);\r\n                    frm.set_value('bond_period_from', r.message[0].period_from);\r\n                    frm.set_value('bond_period_to', r.message[0].to);\r\n                    frm.set_value('bond_value', r.message[0].amount_in_pula);\r\n                    frm.set_value('bondtype1', r.message[0].bond_type);\r\n                    \r\n                }\r\n            }\r\n        });\r\n        }\r\n        // deputyshreiff select fetch the data from  DeputySheriffBond_Details\r\n        if(frm.doc.deputyshreiff_bond == 1 ){\r\n             frm.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Deputy Sheriff Bond',\r\n                filters: {\r\n                   bond_no: frm.doc.bond_no,\r\n                   workflow_state: \"Approved\"\r\n                },\r\n                 fields: ['sheriff_name', 'bond_no', 'period_from', 'bond_value', 'description_of_contract', 'period_to'] \r\n            },\r\n            callback: function(r) {\r\n                console.log(r, \"client details\");\r\n                // frm.set_df_property('bond_no', 'read_only', 1);\r\n              if (r.message && r.message.length > 0) {\r\n                   var message = r.message[0]; \r\n                    frm.set_value('bond_period_from', message.period_from);\r\n                    frm.set_value('description', message.description_of_contract);\r\n                    frm.set_value('bond_period_to', message.period_to);\r\n                    frm.set_value('bond_value', message.bond_value);\r\n                    frm.set_value('client', message.sheriff_name); \r\n                    frm.set_value('bondtype1', 'DEPUTY SHREIFF BOND');\r\n                }\r\n            }\r\n        });\r\n        }\r\n    },\r\n// others bond selected fetch the bond holder from the bond application\r\nother_bonds(frm) {\r\n           if (frm.doc.deputyshreiff_bond === 1 && frm.doc.other_bonds === 1) {\r\n            frappe.msgprint('Please select only one type of bond.');\r\n            frm.set_value('deputyshreiff_bond', '0');\r\n            frm.set_value('other_bonds', '0');\r\n         }\r\n         var other_bonds = frm.doc.other_bonds;\r\n        \r\n        if(other_bonds == 1){\r\n            \r\n             var other_bonds = frm.doc.other_bonds;\r\n       \r\n        // frm.call({\r\n        //     method: 'frappe.client.get_list',\r\n        //     args: {\r\n        //         doctype: 'Bond Application',\r\n        //         filters: {\r\n        //             workflow_state: \"Approved\"\r\n        //         },\r\n        //         fields: ['facility_name']\r\n        //     },\r\n        //     callback: function(response) {\r\n        //         console.log(\"facility_name received:\", response);\r\n        //         let DataArray = response.message || [];\r\n        //         let FinalArray = DataArray.map(x => x.facility_name);\r\n        //         frm.set_df_property('bond_holder', 'options', FinalArray);\r\n        //         console.log(\"final\", FinalArray);\r\n        //     },\r\n        //     error: function(xhr, textStatus, errorThrown) {\r\n        //         console.error(\"Error fetching approved bonds:\", textStatus, errorThrown);\r\n        //     }\r\n        // });\r\n        \r\n         frappe.call({\r\n              method: 'frappe.client.get_list',\r\n              args: {\r\n             doctype: 'Bond Application',\r\n              filters: {\r\n                    workflow_state: \"Approved\"  \r\n                },\r\n          fields: ['facility_name'],\r\n    },\r\n    callback: function(response) {\r\n        console.log(\"facility_name received:\", response);\r\n       let uniquedata = new Set(response.message.map(item => item.facility_name));\r\n       let FinalArray = Array.from(uniquedata);\r\n       \r\n       FinalArray.sort();\r\n       frm.set_df_property('bond_holder', 'options', FinalArray.join('\\n'));\r\n       console.log(\"final\", FinalArray);\r\n    },\r\n    error: function(xhr, textStatus, errorThrown) {\r\n        console.error(\"Error fetching policy_holder:\", textStatus, errorThrown);\r\n    }\r\n});\r\n\r\n        // frm.set_df_property('bond_no', 'read_only', 1);\r\n        // frm.set_df_property('bond_no', 'read_only', 0);\r\n        \r\n        }\r\n        else{\r\n            let FinalArray = []\r\n            frm.set_df_property('bond_holder', 'options', FinalArray);\r\n        }\r\n        \r\n        var other_bonds = frm.doc.other_bonds;\r\n        if (other_bonds === 0) {\r\n            // Clear all fields when 'other_bonds' is unchecked\r\n\r\n            frm.set_value('bond_holder', '');\r\n            frm.set_value('bond_no', '');\r\n            frm.set_value('bond_no', '');\r\n            frm.set_value('client', '');\r\n            frm.set_value('principal', '');\r\n            frm.set_value('description', '');\r\n            frm.set_value('bond_period_from', '');\r\n            frm.set_value('bond_period_to', '');\r\n            frm.set_value('bond_value', '');\r\n            frm.set_value('bondtype1', '');\r\n        \r\n        }\r\n\r\n\r\n    },\r\n// deputy sheiffbond selected fetch the bond holder from the deputyshreiff_bond\r\ndeputyshreiff_bond(frm) {\r\n            if (frm.doc.deputyshreiff_bond === 1 && frm.doc.other_bonds === 1) {\r\n            frappe.msgprint('Please select only one type of bond.');\r\n            frm.set_value('deputyshreiff_bond', '0');\r\n            frm.set_value('other_bonds', '0');\r\n         }\r\n        var deputyshreiff = frm.doc.deputyshreiff_bond;\r\n        if (deputyshreiff === 1) {\r\n    // Fetch details from deputyshreiff_bond \r\n            //  frm.call({\r\n            //     method: 'frappe.client.get_list',\r\n            //     args: {\r\n            //         doctype: 'Deputy Sheriff Bond',  \r\n            //          filters: {\r\n            //         workflow_state: \"Approved\"\r\n            //     },\r\n            //         fields: ['sheriff_name']  \r\n            //     },\r\n            //     callback: function(response) {\r\n            //         console.log(response, 'Get the data')\r\n            //         if (response.message && response.message.length > 0) {\r\n                        \r\n            //              let DataArray = response.message || [];\r\n            //              let FinalArray = DataArray.map(x => x.sheriff_name);\r\n            //              frm.set_df_property('bond_holder', 'options', FinalArray);\r\n                     \r\n                        \r\n            //         }\r\n            //     },\r\n            //     error: function(xhr, textStatus, errorThrown) {\r\n            //         console.error(\"Error fetching details from Deputy Shreiff Bond:\", textStatus, errorThrown);\r\n            //     }\r\n            // });\r\n            \r\n             frappe.call({\r\n              method: 'frappe.client.get_list',\r\n              args: {\r\n             doctype: 'Deputy Sheriff Bond',\r\n              filters: {\r\n                    workflow_state: \"Approved\" \r\n                },\r\n          fields: ['sheriff_name'],\r\n    },\r\n    callback: function(response) {\r\n        console.log(\"sheriff_name received:\", response);\r\n        let uniquedata = new Set(response.message.map(item => item.sheriff_name));\r\n        let FinalArray = Array.from(uniquedata);\r\n        frm.set_df_property('bond_holder', 'options', FinalArray.join('\\n'));\r\n        console.log(\"final\", FinalArray);\r\n    },\r\n    error: function(xhr, textStatus, errorThrown) {\r\n        console.error(\"Error fetching policy_holder:\", textStatus, errorThrown);\r\n    }\r\n});\r\n            \r\n        } else {\r\n\r\n            let FinalArray = []\r\n            FinalArray.sort();\r\n            frm.set_df_property('bond_holder', 'options', FinalArray);\r\n            console.log(\"bond_holder\",frm.doc.bond_holder2)\r\n            \r\n             frm.set_value('bond_holder', '');\r\n            frm.set_value('bond_no', '');\r\n            frm.set_value('bond_period_from', '');\r\n            frm.set_value('description', '');\r\n            frm.set_value('bond_period_to', '');\r\n            frm.set_value('bond_value', '');\r\n        }\r\n    },\r\n    \r\n    \r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Policy Reviews",
  "enabled": 0,
  "modified": "2025-11-12 12:15:09.773101",
  "module": null,
  "name": "Policy Reviews CS",
  "script": "frappe.ui.form.on('Policy Reviews', {\n    refresh: function(frm) {\n        if (!frm.doc.pr_number) {\n            generateProposalNumber(frm);\n        }\n\n        if (frm.doc.__islocal) {\n            fetchAndFilterPolicyNumbers(frm);\n        }\n       \n            {         \n              frm.set_df_property('child_table', 'cannot_add_rows', true); \n            } \n      \n        frm.fields_dict.add.$input.addClass('btn-primary');\n        frm.fields_dict.get_info.$input.addClass('btn-primary');\n        \n        \t\tfrappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Country Details',\n                fields: ['country'],\n                limit_page_length: 100  // Add this line to retrieve up to 100 records\n            },\n            callback: function(response) {\n                let DataArray = response.message;\n                let FinalArray = [];\n                for (let x of DataArray) {\n                    FinalArray.push(x.country);\n                }\n                frm.set_df_property('country', 'options', FinalArray);\n                console.log(\"final\", FinalArray);\n            },\n            error: function(xhr, textStatus, errorThrown) {\n                console.error(\"Error fetching approved bonds:\", textStatus, errorThrown);\n            }\n        });\n        \nfrm.fields_dict.expected_insured_turnover1.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.actual_insured_turnover1.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.excess_shortfall1.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.claims_as_of_actual_premium1.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.total_cl_fee1.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.maximum_liability.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.commercial_liability.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.premium_rate.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.political_liability.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.cl_enquiry_fee.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.cl_per_month.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.no_of_cls.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.no_of_enquiry.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.insured.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.maximum_liability1.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.commercial_liability1.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.premium_rate1.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.political_liability1.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.cl_enquiry_fee1.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.cl_per_month1.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.no_of_cls1.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.no_of_enquiry1.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.insured1.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.maximum_liability2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.commercial_liability2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.premium_rate2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.political_liability2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.cl_enquiry_fee2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.cl_per_month2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.no_of_cls2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.no_of_enquiry2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.insured2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.expected_insured_turnover.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.actual_insured_turnover.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.excess_shortfall.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.claims_as_of_actual_premium.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.total_cl_fee.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.expected_premium.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.actual_premium_charged.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.claims_provision.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.actual_claims.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.total_cl_enq_fee.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.expected_insured_turnover2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.actual_insured_turnover2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.excess_shortfall2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.claims_as_of_actual_premium2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.total_cl_fee2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.expected_premium2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.actual_premium_charged2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.claims_provision2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.actual_claims2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.total_cl_enq_fee2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.total_receipts.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.total_amount_of_claims.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.cost_of_credit_information.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.actual_profit_loss_on_policy.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.total_receipts1.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.total_amount_claims1.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.cost_of_credit_information1.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.actual_profit_loss_on_policy1.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.total_receipts2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.total_amount_claims2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.cost_of_credit_information2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.actual_profit_loss_on_policy2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.to_estimate_for_next_12_months.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.maximum_liabilityrev.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.commercial_liabilityrev.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.premium_raterev.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.political_liabilityrev.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.limit_of_discretion.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.first_limit_loss.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.cl_enquiry_fee3.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.cl_per_month3.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.insured3.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.franchise_loss.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.commercial_pre_rate.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.political_pre_rate.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.turnover.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.political_premium_amt.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.premium_rate_eci.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.commercial_premium_amt.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.total_pre_amtadd.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.expected_premium1.$input.css(\"text-align\", \"right\"); \nfrm.fields_dict.actual_premium_charged1.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.claims_provision1.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.actual_claims1.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.total_cl_enq_fee1.$input.css(\"text-align\", \"right\");\n\n\nvar workflow_state = frm.doc.workflow_state;\n         if (workflow_state === \"Approved\" || workflow_state === \"Pending\") {\n            // Show fields\n            frm.toggle_display('policy_number', true);\n            frm.toggle_display('policy_ho', true);\n\n            // Hide fields\n            frm.toggle_display('policy_no', false);\n            frm.toggle_display('policy_holder', false);\n        } else {\n            // Reverse display\n            frm.toggle_display('policy_number', false);\n            frm.toggle_display('policy_ho', false);\n\n            frm.toggle_display('policy_no', true);\n            frm.toggle_display('policy_holder', true);\n        }\n\n\n    },\n    \n    \n onload: function(frm) {\n        console.log(\"** Fetching Approved Policy Holders **\");\n\n        // Fetch only approved policy approvals\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Policy Approvals',\n                filters: { workflow_state: 'Accepted' },\n                fields: ['policy_holder', 'policy_number'],\n                limit_page_length: 200\n            },\n            callback: function(res) {\n                if (res.message) {\n                    let approved = res.message;\n                    console.log(\"Approved Policies:\", approved);\n\n                    // Get unique policy holders\n                    let uniqueHolders = [...new Set(approved.map(p => p.policy_holder))];\n                    frm.set_df_property('policy_holder', 'options', uniqueHolders);\n                }\n            }\n        });\n        \n    \n        \n        \n    },\n\n    policy_holder: function(frm) {\n        if (!frm.doc.policy_holder) return;\n\n        console.log(\"Fetching policies for holder:\", frm.doc.policy_holder);\n\n        // Fetch approved policy numbers for selected holder\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Policy Approvals',\n                filters: {\n                    policy_holder: frm.doc.policy_holder,\n                    workflow_state: 'Accepted'\n                },\n                fields: ['policy_number']\n            },\n            callback: function(res) {\n                if (res.message) {\n                    let policyNos = res.message.map(p => p.policy_number);\n                    frm.set_df_property('policy_no', 'options', policyNos);\n                    frm.set_value('policy_no', '');\n                }\n            }\n        });\n    },\n    \n    policy_no: function(frm) {\n        // Clear previous values\n        frm.set_value('policy_type', '');\n        frm.set_value('inception_date', '');\n        frm.set_value('policy_expiry_date', '');\n\n        let selectedPolicyNo = frm.doc.policy_no;\n        let selectedHolder = frm.doc.policy_holder;\n\n        if (selectedPolicyNo && selectedHolder) {\n            console.log(\"Checking approval status for:\", selectedPolicyNo);\n\n            // Check if this policy is already approved for this holder\n            frappe.call({\n                method: 'frappe.client.get_value',\n                args: {\n                    doctype: 'Policy Approvals',\n                    filters: {\n                        policy_number: selectedPolicyNo,\n                        policy_holder: selectedHolder,\n                        workflow_state: 'Accepted'\n                    },\n                    fieldname: ['policy_type', 'inception_date']\n                },\n                callback: function(r) {\n                    console.log(\"Response from Policy Approvals:\", r);\n                    if (!r.exc && r.message) {\n                        frappe.msgprint(__('Policy No already approved for this holder.'));\n                        frm.set_value('policy_type', r.message.policy_type || '');\n                        frm.set_value('inception_date', r.message.inception_date || '');\n\n                        // Calculate expiry date (1 year after inception)\n                        if (r.message.inception_date) {\n                            let inceptionDate = new Date(r.message.inception_date);\n                            let expiryDate = new Date(inceptionDate);\n                            expiryDate.setFullYear(expiryDate.getFullYear() + 1);\n                            frm.set_value('policy_expiry_date', frappe.datetime.str_to_user(expiryDate));\n                        }\n                    }\n                }\n            });\n        }\n\n        \n    },\n    \n    add_new: function(frm) {\n    // List of country names\n    var country_names = [\n        'Afghanistan', 'Albania', 'Algeria', 'Andorra', 'Angola', 'Antigua and Barbuda', 'Argentina', 'Armenia', 'Australia', 'Austria',\n        'Azerbaijan', 'Bahamas', 'Bahrain', 'Bangladesh', 'Barbados', 'Belarus', 'Belgium', 'Belize', 'Benin', 'Bhutan', 'Bolivia',\n        'Bosnia and Herzegovina', 'Botswana', 'Brazil', 'Brunei', 'Bulgaria', 'Burkina Faso', 'Burundi', 'Cabo Verde', 'Cambodia',\n        'Cameroon', 'Canada', 'Central African Republic', 'Chad', 'Chile', 'China', 'Colombia', 'Comoros', 'Congo (Congo-Brazzaville)',\n        'Costa Rica', 'Croatia', 'Cuba', 'Cyprus', 'Czechia (Czech Republic)', 'Democratic Republic of the Congo', 'Denmark', 'Djibouti',\n        'Dominica', 'Dominican Republic', 'Ecuador', 'Egypt', 'El Salvador', 'Equatorial Guinea', 'Eritrea', 'Estonia', 'Eswatini (fmr. \"Swaziland\")',\n        'Ethiopia', 'Fiji', 'Finland', 'France', 'Gabon', 'Gambia', 'Georgia', 'Germany', 'Ghana', 'Greece', 'Grenada', 'Guatemala', 'Guinea',\n        'Guinea-Bissau', 'Guyana', 'Haiti', 'Holy See', 'Honduras', 'Hungary', 'Iceland', 'India', 'Indonesia', 'Iran', 'Iraq', 'Ireland',\n        'Israel', 'Italy', 'Jamaica', 'Japan', 'Jordan', 'Kazakhstan', 'Kenya', 'Kiribati', 'Kuwait', 'Kyrgyzstan', 'Laos', 'Latvia', 'Lebanon',\n        'Lesotho', 'Liberia', 'Libya', 'Liechtenstein', 'Lithuania', 'Luxembourg', 'Madagascar', 'Malawi', 'Malaysia', 'Maldives', 'Mali', 'Malta',\n        'Marshall Islands', 'Mauritania', 'Mauritius', 'Mexico', 'Micronesia', 'Moldova', 'Monaco', 'Mongolia', 'Montenegro', 'Morocco', 'Mozambique',\n        'Myanmar (formerly Burma)', 'Namibia', 'Nauru', 'Nepal', 'Netherlands', 'New Zealand', 'Nicaragua', 'Niger', 'Nigeria', 'North Korea', 'North Macedonia (formerly Macedonia)',\n        'Norway', 'Oman', 'Pakistan', 'Palau', 'Palestine State', 'Panama', 'Papua New Guinea', 'Paraguay', 'Peru', 'Philippines', 'Poland', 'Portugal',\n        'Qatar', 'Romania', 'Russia', 'Rwanda', 'Saint Kitts and Nevis', 'Saint Lucia', 'Saint Vincent and the Grenadines', 'Samoa', 'San Marino',\n        'Sao Tome and Principe', 'Saudi Arabia', 'Senegal', 'Serbia', 'Seychelles', 'Sierra Leone', 'Singapore', 'Slovakia', 'Slovenia', 'Solomon Islands',\n        'Somalia', 'South Africa', 'South Korea', 'South Sudan', 'Spain', 'Sri Lanka', 'Sudan', 'Suriname', 'Sweden', 'Switzerland', 'Syria', 'Tajikistan',\n        'Tanzania', 'Thailand', 'Timor-Leste', 'Togo', 'Tonga', 'Trinidad and Tobago', 'Tunisia', 'Turkey', 'Turkmenistan', 'Tuvalu', 'Uganda', 'Ukraine',\n        'United Arab Emirates', 'United Kingdom', 'United States of America', 'Uruguay', 'Uzbekistan', 'Vanuatu', 'Venezuela', 'Vietnam', 'Yemen', 'Zambia', 'Zimbabwe'\n    ];\n\n    // Display a prompt to enter field values with country options\n    frappe.prompt([\n        { label: 'Country', fieldname: 'country', fieldtype: 'Select', options: country_names, reqd: 1 },\n        { label: 'Terms Of Payment', fieldname: 'terms_of_paymentan', fieldtype: 'Select', options: '1-3m\\n1-mLC\\n4-6m\\n4-6mLC\\ncad\\ncadLC\\nTT7d', reqd: 1 },\n        { label: 'Commercial Pre Rate (%)', fieldname: 'commercial_pre_ratean', fieldtype: 'Currency', reqd: 1 },\n        { label: 'Political Pre Rate (%)', fieldname: 'political_pre_ratean', fieldtype: 'Currency', reqd: 1 },\n        { label: 'Premium Rate (%)', fieldname: 'premium_ratean', fieldtype: 'Currency', default: 0 }, // Include premium_ratean field\n\n        { label: '', fieldname: '', fieldtype: 'Column Break' },\n\n        { label: 'Commercial Premium Amount', fieldname: 'commercial_premium_amountan', fieldtype: 'Currency' },\n        { label: 'Political Premium Amount', fieldname: 'political_premium_amountan', fieldtype: 'Currency' },\n        { label: 'Total Premium Amount', fieldname: 'total_pre_amountan', fieldtype: 'Currency' },\n\n        { label: 'Buyer type', fieldname: 'buyer_type', fieldtype: 'Select', options: 'ASSOCIATED COMPANIES\\nGOVERNMENT BUYERS\\nPRIVATE BUYERS', reqd: 1 },\n        { label: 'Turnover', fieldname: 'turnover', fieldtype: 'Currency', reqd: 1 }\n    ], function(values) {\n        // Calculate premium_ratean based on commercial_pre_ratean and political_pre_ratean\n        const premium_ratean = parseFloat(values.commercial_pre_ratean) + parseFloat(values.political_pre_ratean);\n        \n        // Set premium_ratean value in the prompt\n        values.premium_ratean = premium_ratean;\n\n        // Validate all required fields\n        const requiredFields = ['country', 'terms_of_paymentan', 'commercial_pre_ratean', 'political_pre_ratean', 'buyer_type', 'turnover'];\n        const missingFields = requiredFields.filter(field => !values[field]);\n\n        if (missingFields.length > 0) {\n            const errorMessage = `Please fill out all required fields: ${missingFields.join(', ')}`;\n            frappe.msgprint(errorMessage); // Show error message\n            return;\n        }\n\n        // Calculate commercial_premium_amountan and political_premium_amountan\n        const commercial_premium_amountan = parseFloat(values.turnover) * (parseFloat(values.commercial_pre_ratean) / 100);\n        const political_premium_amountan = parseFloat(values.turnover) * (parseFloat(values.political_pre_ratean) / 100);\n\n        // Calculate total_pre_amountan based on turnover and premium_ratean\n        const total_pre_amountan = parseFloat(values.turnover) * (premium_ratean / 100);\n\n        // Proceed with adding a new row to the child table\n        var new_row = frappe.model.add_child(frm.doc, 'Policy Reviews Child', 'child_table');\n        new_row.country = values.country;\n        new_row.terms_of_payment = values.terms_of_paymentan;\n        new_row.comm_pre_rate = values.commercial_pre_ratean;\n        new_row.political_pre_rate = values.political_pre_ratean;\n        new_row.pre_rate = premium_ratean;\n       \n\n        // Refresh the child table\n        frm.refresh_field('child_table');\n    }, 'Enter Policy Details');\n},\n\nget_info: function(frm) {\n    var policy_type = frm.doc.policy_type;\n    var policy_holder = frm.doc.policy_holder;\n\n    // Hide or display fields based on policy_type\n    if (policy_type === 'DCI') {\n        // Hide fields for ECI\n        frm.toggle_display(['commercial_liability','child_table','add','add_new','premium_rate_eci','commercial_premium_amt','country','terms_of_payment','commercial_pre_rate','buyer_type','political_pre_rate','turnover','political_premium_amt','total_pre_amt','political_liabilityrev','commercial_liabilityrev','political_liability','commercial_liability1','political_liability1','commercial_liability2','political_liability2']);\n        // Display fields for DCI\n        frm.toggle_display(['field_to_display_for_dci'], true);\n    } else if (policy_type === 'ECI') {\n        // Hide fields for DCI\n        frm.toggle_display(['maximum_liability','premium_raterev','maximum_liabilityrev', 'premium_rate','maximum_liability1', 'premium_rate1','maximum_liability2', 'premium_rate2']);\n        // Display fields for ECI\n        frm.toggle_display(['field_to_hide_for_dci']);\n        frm.toggle_display(['field_to_display_for_eci'], true);\n    }\n\n    // Fetch and set values based on policy_type\n    if (policy_type === 'DCI') {\n        frappe.call({\n            method: 'frappe.client.get',\n            args: {\n                doctype: 'DCI Quotation',\n                filters: { 'name': frm.doc.dci_quotation, 'client_name': policy_holder },\n                fieldname: ['maximum_liability','insured_turnover','expected_premium_income','expected_insured_turnover','limit_of_discretion','franchise_loss', 'premium_rate', 'insured_turnover', 'fee_per_enquiry', 'fee_for_cl_per_month', 'expected_insured_turnover']\n            },\n            callback: function(response) {\n                var dciQuotation = response.message;\n                if (dciQuotation) {\n                    frm.set_value('maximum_liability', dciQuotation.maximum_liability);\n                    frm.set_value('premium_rate', dciQuotation.premium_rate);\n                    frm.set_value('insured', dciQuotation.insured_turnover);\n                    frm.set_value('cl_enquiry_fee', dciQuotation.fee_per_enquiry);\n                    frm.set_value('cl_per_month', dciQuotation.fee_for_cl_per_month);\n                    frm.set_value('cl_enquiry_fee3', dciQuotation.fee_per_enquiry);\n                    frm.set_value('cl_per_month3', dciQuotation.fee_for_cl_per_month);\n                    frm.set_value('total_cl_enq_fee', dciQuotation.fee_per_enquiry);\n                    frm.set_value('total_cl_fee', dciQuotation.fee_for_cl_per_month);\n                    frm.set_value('actual_insured_turnover', dciQuotation.insured_turnover);\n                    frm.set_value('expected_premium', dciQuotation.expected_premium_income);\n                    frm.set_value('expected_insured_turnover', dciQuotation.expected_insured_turnover);\n                    frm.set_value('premium_raterev', dciQuotation.premium_rate);\n                    frm.set_value('maximum_liabilityrev', dciQuotation.maximum_liability);\n                }\n            }\n        });\n    } else if (policy_type === 'ECI') {\n        frappe.call({\n            method: 'frappe.client.get',\n            args: {\n                doctype: 'ECI Quotations',\n                filters: { 'name': frm.doc.eci_quotation, 'client_name': policy_holder },\n                fieldname: ['premium_rate','insured_commercial_risks_for_all_insured_companies','individual_first_lossp','limit_of_descrition', 'political_pre_rate', 'franchise_lossp', 'buyer_type', 'commercial', 'political', 'country_of_dest', 'terms_of_payment', 'commercial_pre_rate', 'turnover__p', 'political_premium_amt', 'total_pre_amt', 'cl_per_monthp', 'per_enquiryp', 'commercial_premium_amt_p']\n\n                // ['premium_rate','','','political_pre_rate','franchise_lossp','buyer_type','commercial', 'political', 'country_of_dest', 'terms_of_payment', 'commercial_pre_rate', 'political_pre_rate', 'turnover__p', 'political_premium_amt', 'total_pre_amt', 'buyer_type', 'cl_per_monthp', 'per_enquiryp', 'commercial_premium_amt_p']\n            },\n            callback: function(response) {\n                var eciQuotation = response.message;\n                if (eciQuotation) {\n                    frm.set_value('commercial_liability', eciQuotation.commercial);\n                    frm.set_value('political_liability', eciQuotation.political);\n                    // frm.set_value('country', eciQuotation.country_of_dest);\n                    // frm.set_value('terms_of_payment', eciQuotation.terms_of_payment);\n                    // frm.set_value('commercial_pre_rate', eciQuotation.commercial_pre_rate);\n                    // frm.set_value('commercial_premium_amt', eciQuotation.commercial_premium_amt_p);\n                    frm.set_value('cl_enquiry_fee', eciQuotation.per_enquiryp);\n                    frm.set_value('cl_per_month', eciQuotation.cl_per_monthp);\n                    \n                    frm.set_value('cl_enquiry_fee3', eciQuotation.per_enquiryp);\n                    frm.set_value('cl_per_month3', eciQuotation.cl_per_monthp);\n\n                    \n                    // frm.set_value('premium_rate_eci', eciQuotation.premium_rate);                    \n                    // frm.set_value('buyer_type', eciQuotation.buyer_type);  \n                    \n                    frm.set_value('franchise_loss', eciQuotation.franchise_lossp); \n                    \n                    // frm.set_value('political_pre_rate', eciQuotation.political_pre_rate); \n                    \n                    \n                    // frm.set_value('political_premium_amt', eciQuotation.political_premium_amt);                    \n                    frm.set_value('first_limit_loss', eciQuotation.individual_first_lossp);  \n                    frm.set_value('limit_of_discretion', eciQuotation.limit_of_descrition);    \n                    \n                    frm.set_value('commercial_liabilityrev', eciQuotation.commercial);               \n                    frm.set_value('political_liabilityrev', eciQuotation.political);\n                    // frm.set_value('turnover', eciQuotation.turnover__p);\n                    frm.set_value('insured3', eciQuotation.insured_commercial_risks_for_all_insured_companies);\n                    // frm.set_value('total_pre_amt', eciQuotation.total_pre_amt);\n                    frappe.msgprint('click the Add button after giving the values for the Country,Terms of Payment,Commercial Pre Rate,Political Pre Rate,Buyer Type,Turnover fields under the Limit of Discretion ');\n\n                }\n            }\n        });\n    }\n\n    var period_from = frm.doc.period_from;\n    var period_to = frm.doc.period_to;\n    var period_under_review = formatDate(period_from) + ' to ' + formatDate(period_to);\n    frm.set_value('period_under_review', period_under_review);\n},\n\n add: function(frm) {\n        policychild(frm);\n    }\n\n});\n\nfunction generateProposalNumber(frm) {\n    let currentYear = new Date().getFullYear();\n    let prefix = `PRV/${currentYear}/`;\n\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Policy Reviews',\n            fields: ['pr_number'],\n            order_by: 'creation desc',\n            limit: 1\n        },\n        callback: function(r) {\n            if (r.message && r.message.length > 0) {\n                let lastPRNumber = r.message[0].pr_number;\n                let lastNumber = parseInt(lastPRNumber.split(\"/\").pop());\n                if (!isNaN(lastNumber)) {\n                    let newNumber = (lastNumber + 1).toString().padStart(4, '0');\n                    frm.set_value('pr_number', prefix + newNumber);\n                }\n            } else {\n                frm.set_value('pr_number', prefix + '0001');\n            }\n        }\n    });\n}\n\nfunction fetchAndFilterPolicyNumbers(frm) {\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Policy Reviews',\n            filters: {\n                workflow_state: 'Approved'\n            },\n            fields: ['policy_no']\n\n        },\n        callback: function(response) {\n            if (response && response.message) {\n                var approvedPolicyNumbers = response.message.map(function(review) {\n                    return review.policy_no;\n                });\n\n                var policyNoField = frm.fields_dict['policy_no'];\n\n                if (policyNoField) {\n                    policyNoField.df.options = policyNoField.df.options.filter(function(policyNo) {\n                        return approvedPolicyNumbers.indexOf(policyNo) === -1;\n                    });\n                    policyNoField.refresh();\n                }\n            } else {\n                console.error('Error fetching approved policy numbers from Policy Reviews.');\n            }\n        },\n        error: function(xhr, textStatus, errorThrown) {\n            console.error('Error:', errorThrown);\n        }\n    });\n}\n\nfunction formatDate(date) {\n    var formattedDate = frappe.datetime.str_to_user(date);\n    return formattedDate;\n}\n\n\n\nfunction policychild(frm) {\n    // Parse values from document fields\n    const commercial_pre_rate = parseFloat(frm.doc.commercial_pre_rate);\n    const political_pre_rate = parseFloat(frm.doc.political_pre_rate);\n    const turnover = parseFloat(frm.doc.turnover);\n\n\n    // Check if parsed values are valid numbers\n    if (!isNaN(commercial_pre_rate) && !isNaN(political_pre_rate) && !isNaN(turnover)) {\n        // Calculate premium_rate_eci\n        const premium_rate_eci = commercial_pre_rate + political_pre_rate;\n        frm.set_value('premium_rate_eci', premium_rate_eci);\n\n        // Calculate commercial_premium_amt\n        const commercial_premium_amt = turnover * (commercial_pre_rate / 100);\n        frm.set_value('commercial_premium_amt', commercial_premium_amt);\n\n        // Calculate political_premium_amt\n        const political_premium_amt = turnover * (political_pre_rate / 100);\n        frm.set_value('political_premium_amt', political_premium_amt);\n\n        // Calculate total_pre_amtadd\n        const total_pre_amtadd = turnover * (premium_rate_eci / 100);\n        frm.set_value('total_pre_amtadd', total_pre_amtadd);\n\n\n        // Access other document fields\n        var country = frm.doc.country;\n        var terms_of_payment = frm.doc.terms_of_payment;\n\n        // Add a new row to the child table\n        var new_row = frappe.model.add_child(frm.doc, 'Policy Reviews Child', 'child_table');\n        new_row.country = country;\n        new_row.pre_rate = premium_rate_eci; // Use the calculated premium_rate_eci\n        new_row.comm_pre_rate = commercial_pre_rate;\n        new_row.political_pre_rate = political_pre_rate;\n        new_row.terms_of_payment = terms_of_payment;\n        new_row.total_pre_amt = total_pre_amtadd;\n        new_row.political_premium_amt = political_premium_amt;\n        new_row.commercial_premium_amt = commercial_premium_amt;\n\n        // Refresh the child table to reflect the changes\n        frm.refresh_field('child_table');\n\n        // Reset the fields\n        frm.set_value('country', '');\n        frm.set_value('terms_of_payment', '');\n        frm.set_value('commercial_pre_rate', 0);\n        frm.set_value('commercial_premium_amt', 0);\n        frm.set_value('political_pre_rate', 0);\n        frm.set_value('political_premium_amt', 0);\n        frm.set_value('buyer_type', '');\n        frm.set_value('premium_rate_eci', 0);\n        frm.set_value('total_pre_amtadd', 0);\n        frm.set_value('turnover', '');\n    } else {\n        // Handle error or set default values if parsing fails\n        frm.set_value('premium_rate_eci', 0);\n        frm.set_value('commercial_premium_amt', 0);\n        frm.set_value('political_premium_amt', 0);\n        frm.set_value('total_pre_amtadd', 0);\n        frm.set_value('turnover', '');\n\n        // Display an error message or log the error\n        // frappe.msgprint('Invalid input values. Please enter the values for Country,Terms of Payment,Turnover,Commercial Pre Rate,Political Pre Rate, Buyer Type and click on Add Button.');\n    }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Prepare Invoice",
  "enabled": 0,
  "modified": "2025-11-11 07:26:34.345681",
  "module": null,
  "name": "Prepare Invoice",
  "script": "\n    function submit_to_finance(frm) {\n        console.log(\"Submit to finance button clicked.\");\n        console.log(\"Value of bond_application:\", frm.doc.other_bonds);\n        \n          if (frm.doc.other_bonds === 1) {\n            console.log(\"Bond application selected.\");\n            frappe.model.with_doctype('Bond Invoice', () => {\n                console.log(\"Creating new Bond Invoice document.\");\n                \n                let doc = frappe.model.get_new_doc('Bond Invoice');\n                 \n                doc.facility_name = frm.doc.bond_holder;\n                doc.bond_no = frm.doc.bond_no;\n                doc.bond_type = frm.doc.bondtype1;\n                doc.bond_application = frm.doc.other_bonds;\n                doc.period_from = frm.doc.bond_period_from;\n                doc.bond_invoice_no = frm.doc.bond_no;\n                doc.month = frm.doc.month;\n                doc.reinsurer = frm.doc.reinsure;\n                doc.reinsurer_refnumber = frm.doc.reinsurer_ref_number;\n                doc.reinsurer1 = frm.doc.reinsurer_;\n                doc.portion_of_guarantee_guarantee_vat_p = frm.doc.portion_of_guarantee_amount_to_reinsurer;\n                doc.beci_commission_p = frm.doc.beci_commission_;\n                doc.broker1 = frm.doc.broker;\n                doc.broker = frm.doc.broker_;\n                doc.total_due_without_vat = frm.doc.total;\n                doc.vat = frm.doc.vat;\n                doc.total_due = frm.doc.total_due_with_vat;\n                doc.bond_in_favour = frm.doc.principal;\n                doc.bond_guarantee_amount = frm.doc.guarantee_amount;\n                doc.to = frm.doc.bond_period_to;\n                doc.beci = frm.doc.beci_;\n                doc.beci_portion_of_gurantee_amount_p = frm.doc.portion_of_guarantee_fee_to_beci;\n                doc.vat_p = frm.doc.vat_;\n                doc.bond_application = frm.doc.other_bonds; \n                doc.top_button = \"1\"\n                frappe.set_route('Form', 'Bond Invoice', doc.name);\n                console.log(\"Redirecting to Bond Invoice form.\");\n            });\n        }\n        else if (frm.doc.deputy_shreiff_bond === 1) {\n    console.log(\"Deputy Sheriff Bond application selected.\");\n    frappe.model.with_doctype('Bond Invoice', () => {\n        console.log(\"Creating new Bond Invoice document.\");\n        let doc = frappe.model.get_new_doc('Bond Invoice');\n        console.log(doc, \"all data\")\n        doc.facility_name = frm.doc.bond_holder;\n        doc.bond_no = frm.doc.bond_no;\n        doc.bond_type = frm.doc.bondtype1;\n        doc.bond_application = frm.doc.other_bonds;\n        doc.period_from = frm.doc.bond_period_from;\n        doc.bond_invoice_no = frm.doc.bond_no;\n        doc.ecgc_ref_no = frm.doc.beci_ref_no;\n        doc.sheriff_name = frm.doc.bond_holder;\n        doc.bond_guarantee_amount = frm.doc.guarantee_amount;\n        doc.bond_period_from = frm.doc.bond_period_from;\n        doc.month = frm.doc.month;\n        doc.guarantee_fee = frm.doc.guarantee_fee1;\n        doc.reinsurer = frm.doc.reinsure;\n        console.log(frm.doc.reinsure, \"reinsurer\")\n        doc.reinsurer_refnumber = frm.doc.reinsurer_ref_number;\n        console.log(frm.doc.reinsurer_ref_number, \"reinsurer_refnumber\")\n        doc.reinsurer1 = frm.doc.reinsurer_;\n        console.log(frm.doc.reinsurer_, \"reinsurer1\")\n        doc.portion_of_guarantee_amount_to_reinsurer = frm.doc.portion_of_guarantee_amount_to_reinsurer;\n        doc.portion_of_guarantee_guarantee_vat_p = frm.doc.portion_of_guarantee_fee_to_reinsurer;\n        doc.ecgc_commission = frm.doc.beci_commission;\n        doc.broker1 = frm.doc.broker;\n        doc.broker = frm.doc.broker_;\n        doc.total_due_without_vat = frm.doc.total;\n        doc.vat = frm.doc.vat;\n        doc.vat_p = frm.doc.vat1;\n        doc.total_duewith_out_vat = frm.doc.total_due_with_vat;\n        doc.to = frm.doc.bond_period_to;\n        doc.guarantee_fee = frm.doc.guarantee_fee1;\n        doc.beci = frm.doc.beci_;\n        doc.portion_of_guarantee_to_amount_ecgc = frm.doc.portion_of_guarantee_amount_to_beci;\n        doc.ecgc_commission_ = frm.doc.beci_commission;\n        doc.broker_commission = frm.doc.broker_commission;\n        doc.guarantee_fee_rate = frm.doc.guarantee_fee1;\n        doc.portion_of_guarante_fee_to_ecgc = frm.doc.portion_of_guarantee_fee_to_beci;\n\n        doc.deputy_sheriff = frm.doc.deputy_shreiff_bond;\n        doc.top_button = \"1\"\n        frappe.set_route('Form', 'Bond Invoice', doc.name);\n        console.log(\"Redirecting to Bond Invoice form.\");\n    });\n}\n\n    }  \n\n\n\nfrappe.ui.form.on('Prepare Invoice', {\n    \n refresh(frm){\n frm.add_custom_button(__('Submit To Finance'), function() {\n        submit_to_finance(frm)\n        }).addClass(\"btn-primary\");\n         \n     },\n\n\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Renewal Prepare Invoice",
  "enabled": 1,
  "modified": "2024-05-06 08:11:24.266244",
  "module": null,
  "name": "Renewal Prepare Invoice",
  "script": "\n    function submit_to_finance(frm) {\n        console.log(\"Submit to finance button clicked.\");\n        console.log(\"Value of bond_application:\", frm.doc.other_bonds);\n        \n          if (frm.doc.other_bonds === 1) {\n            console.log(\"Bond application selected.\");\n            frappe.model.with_doctype('Bond Invoice', () => {\n                console.log(\"Creating new Bond Invoice document.\");\n                \n                let doc = frappe.model.get_new_doc('Bond Invoice');\n                doc.facility_name = frm.doc.bond_holder;\n                doc.bond_no = frm.doc.bond_no;\n                doc.bond_type = frm.doc.bond_type;\n                doc.bond_application = frm.doc.other_bonds;\n                doc.period_from = frm.doc.bond_period_from;\n                doc.bond_invoice_no = frm.doc.bond_no;\n                doc.month = frm.doc.month;\n                doc.reinsurer = frm.doc.reinsure;\n                doc.reinsurer_refnumber = frm.doc.reinsurer_ref_number;\n                doc.reinsurer1 = frm.doc.reinsurer_;\n                doc.portion_of_guarantee_guarantee_vat_p = frm.doc.portion_of_guarantee_amount_to_reinsurer;\n                doc.beci_commission_p = frm.doc.beci_commission_;\n                doc.broker1 = frm.doc.broker;\n                doc.broker = frm.doc.broker_;\n                doc.total_due_without_vat = frm.doc.total_due__with_out_vat;\n                doc.vat = frm.doc.vat_;\n                doc.total_due = frm.doc.total_due;\n                doc.bond_in_favour = frm.doc.principal;\n                doc.bond_guarantee_amount = frm.doc.guarantee_amount;\n                doc.to = frm.doc.bond_period_to;\n                doc.beci = frm.doc.beci_;\n                doc.beci_portion_of_gurantee_amount_p = frm.doc.portion_of_guarantee_fee_to_beci;\n                doc.vat_p = frm.doc.vat_;\n                doc.bond_application = frm.doc.other_bonds; \n                doc.renewal_top_buttons = \"1\"\n                frappe.set_route('Form', 'Bond Invoice', doc.name);\n                console.log(\"Redirecting to Bond Invoice form.\");\n            });\n        }\n          else if (frm.doc.deputyshreiff_bond === 1) {\n          console.log(\"Deputy Sheriff Bond application selected.\");\n         frappe.model.with_doctype('Bond Invoice', () => {\n         console.log(\"Creating new Bond Invoice document.\");\n        let doc = frappe.model.get_new_doc('Bond Invoice');\n        console.log(doc, \"all data\")\n        doc.facility_name = frm.doc.bond_holder;\n        doc.bond_no = frm.doc.bond_no;\n        doc.bond_type = frm.doc.bond_type;\n        doc.bond_application = frm.doc.other_bonds;\n        doc.period_from = frm.doc.bond_period_from;\n        doc.bond_invoice_no = frm.doc.bond_no;\n        doc.ecgc_ref_no = frm.doc.beci_ref_no;\n        doc.sheriff_name = frm.doc.bond_holder;\n        doc.bond_guarantee_amount = frm.doc.guarantee_amount;\n        doc.bond_period_from = frm.doc.bond_period_from;\n        doc.month = frm.doc.month;\n        doc.guarantee_fee = frm.doc.guarantee_fee1;\n        doc.reinsurer = frm.doc.reinsure;\n        doc.reinsurer_refnumber = frm.doc.reinsurer_ref_number;\n        doc.reinsurer1 = frm.doc.reinsurer_;\n        doc.portion_of_guarantee_amount_to_reinsurer = frm.doc.portion_of_guarantee_amount_to_reinsurer;\n        // doc.portion_of_guarantee_guarantee_vat_p = frm.doc.portion_of_guarantee_fee_to_reinsurer;\n        doc.ecgc_commission = frm.doc.beci_commission;\n        doc.broker1 = frm.doc.broker;\n        doc.broker = frm.doc.broker_;\n        doc.total_due_without_vat = frm.doc.total_due__with_out_vat;\n        doc.vat = frm.doc.vat_;\n        doc.vat_p = frm.doc.vat;\n        doc.total_duewith_out_vat = frm.doc.total_due;\n        doc.to = frm.doc.bond_period_to;\n        doc.guarantee_fee = frm.doc.guarantee_fee1;\n        doc.beci = frm.doc.beci_;\n        doc.portion_of_guarantee_to_amount_ecgc = frm.doc.portion_of_guarantee_amount_to__beci;\n        doc.ecgc_commission_ = frm.doc.beci_commission;\n        doc.broker_commission = frm.doc.broker_commission;\n        doc.guarantee_fee_rate = frm.doc.guarantee_fee1;\n        // doc.portion_of_guarante_fee_to_ecgc = frm.doc.portion_of_guarantee_fee_to_beci;\n\n        doc.deputy_sheriff = frm.doc.deputyshreiff_bond;\n        doc.renewal_top_buttons = \"1\"\n        frappe.set_route('Form', 'Bond Invoice', doc.name);\n        console.log(\"Redirecting to Bond Invoice form.\");\n    });\n}\n    }  \n\n\n\nfrappe.ui.form.on('Renewal Prepare Invoice', {\n    \n refresh(frm){\n frm.add_custom_button(__('Submit To Finance'), function() {\n        submit_to_finance(frm)\n        }).addClass(\"btn-primary\");\n         \n     },\n\n\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Facility Review",
  "enabled": 1,
  "modified": "2025-12-05 08:52:38.610425",
  "module": "UnderWriting",
  "name": "Facility Review",
  "script": "frappe.ui.form.on('Facility Review', {\n \nrefresh: function(frm) {\n    \n    frm.fields_dict.bond_facility_limit1.$wrapper.find('input').css(\"text-align\", \"right\");\n    frm.fields_dict.bond_facility_limit2.$wrapper.find('input').css(\"text-align\", \"right\");\n    frm.fields_dict.bond_facility_limit3.$wrapper.find('input').css(\"text-align\", \"right\");\n    frm.fields_dict.bond_facility_limit4.$wrapper.find('input').css(\"text-align\", \"right\");\n    frm.fields_dict.net_facility_amount.$wrapper.find('input').css(\"text-align\", \"right\");\n    frm.fields_dict.security_per_limit1.$wrapper.find('input').css(\"text-align\", \"right\");\n    frm.fields_dict.security_per_limit2.$wrapper.find('input').css(\"text-align\", \"right\");\n    frm.fields_dict.security_per_limit3.$wrapper.find('input').css(\"text-align\", \"right\");\n    frm.fields_dict.security_per_limit4.$wrapper.find('input').css(\"text-align\", \"right\");\n    frm.fields_dict.security_per_limit5.$wrapper.find('input').css(\"text-align\", \"right\");\n    frm.fields_dict.bond_facility_limits1.$wrapper.find('input').css(\"text-align\", \"right\");\n    frm.fields_dict.bond_facility_limits2.$wrapper.find('input').css(\"text-align\", \"right\");\n    frm.fields_dict.bond_facility_limits3.$wrapper.find('input').css(\"text-align\", \"right\");\n    frm.fields_dict.bond_facility_limits4.$wrapper.find('input').css(\"text-align\", \"right\");\n    frm.fields_dict.net_facility_amounts.$wrapper.find('input').css(\"text-align\", \"right\");\n    frm.fields_dict.security_per_limits1.$wrapper.find('input').css(\"text-align\", \"right\");\n    frm.fields_dict.security_per_limits2.$wrapper.find('input').css(\"text-align\", \"right\");\n    frm.fields_dict.security_per_limits3.$wrapper.find('input').css(\"text-align\", \"right\");\n    frm.fields_dict.security_per_limits4.$wrapper.find('input').css(\"text-align\", \"right\");\n    frm.fields_dict.security_per_limits5.$wrapper.find('input').css(\"text-align\", \"right\");\n\n var workflowState = frm.doc.workflow_state;\n        // Check if the workflow state is 'Pending'\n        if (workflowState === 'Pending' ||\n            workflowState === \"Accepted\" ||\n            workflowState === \"Approved\" ||\n           workflowState === \"REFERRED TO MM\" ||\n              workflowState === \"REFERRED TO GM\" ||\n            workflowState === \"REFERRED TO UM\") {\n            // Show the fields\n            const fields_to_show = [\n                'gmapprover_remarks', 'gm_remarks', 'column_break_lw6xr', \n                'section_break_jcnbq', 'send_to_recommendation', \n                'section_break_0iqvw', 'send', 'section_break_e4pfo', \n                'documents', 'section_break_3xyof', 'upload_document', \n                'column_break_nu1ys', 'view_document', 'section_break_eroii', \n                'new_terms_accepted_by_client_details', 'accepted_by', \n                'accepted_on'\n            ];\n\n            fields_to_show.forEach(field => {\n                frm.toggle_display(field, true);\n            });\n        } else {\n            // Hide the fields\n            const fields_to_hide = [\n                'gmapprover_remarks', 'gm_remarks', 'column_break_lw6xr', \n                'section_break_jcnbq', 'send_to_recommendation', \n                'section_break_0iqvw', 'send', 'section_break_e4pfo', \n                'documents', 'section_break_3xyof', 'upload_document', \n                'column_break_nu1ys', 'view_document', 'section_break_eroii', \n                'new_terms_accepted_by_client_details', 'accepted_by', \n                'accepted_on'\n            ];\n\n            fields_to_hide.forEach(field => {\n                frm.toggle_display(field, false);\n            });\n        }\n    },\n//}); \n \n \n \n \n \n \n \n \n \n    // refresh(frm){\n    // frm.fields_dict.send_to_recommendation.$input.addClass('btn-primary');\n    //     frm.fields_dict.upload_document.$input.addClass('btn-primary');\n    //     frm.fields_dict.view_document.$input.addClass('btn-primary');\n        \n        \n        \n    //   var workflow_state = frm.doc.workflow_state;\n \n    //     // Check if the workflow state is 'Pending'\n    //     if (workflow_state === 'Pending') {\n    //         // Show the fields\n    //         frm.toggle_display('gmapprover_remarks', true);\n    //         frm.toggle_display('gm_remarks', true);\n    //          frm.toggle_display('column_break_lw6xr', true);\n    //           frm.toggle_display('section_break_jcnbq', true);\n              \n    //         frm.toggle_display('send_to_recomendation', true);\n    //         frm.toggle_display('section_break_0iqvw', true);\n    //          frm.toggle_display('send', true);\n    //           frm.toggle_display('send_to_recommendation', true);\n              \n    //           frm.toggle_display('section_break_e4pfo', true);\n    //         frm.toggle_display('documents', true);\n    //          frm.toggle_display('section_break_3xyof', true);\n    //           frm.toggle_display('upload_document', true);\n              \n    //           frm.toggle_display('column_break_nu1ys', true);\n    //         frm.toggle_display('view_document', true);\n    //          frm.toggle_display('section_break_eroii', true);\n    //           frm.toggle_display('new_terms_accepted_by_client_details', true);\n              \n    //           frm.toggle_display('accepted_by', true);\n    //         frm.toggle_display('accepted_on', true);\n           \n    //     } else {\n    //         // Hide the fields\n    //         frm.toggle_display('gmapprover_remarks', false);\n    //         frm.toggle_display('gm_remarks', false);\n    //          frm.toggle_display('column_break_lw6xr', false);\n    //           frm.toggle_display('section_break_jcnbq', false);\n              \n    //         frm.toggle_display('send_to_recomendation', false);\n    //         frm.toggle_display('section_break_0iqvw', false);\n    //          frm.toggle_display('send', false);\n    //           frm.toggle_display('send_to_recommendation', false);\n              \n    //           frm.toggle_display('section_break_e4pfo', false);\n    //         frm.toggle_display('documents', false);\n    //          frm.toggle_display('section_break_3xyof', false);\n    //           frm.toggle_display('upload_document', false);\n              \n    //           frm.toggle_display('column_break_nu1ys', false);\n    //         frm.toggle_display('view_document', false);\n    //          frm.toggle_display('section_break_eroii', false);\n    //           frm.toggle_display('new_terms_accepted_by_client_details', false);\n            \n            \n            \n            \n            \n    //         frm.toggle_display('accepted_by', false);\n    //         frm.toggle_display('accepted_on', false);\n    //     } \n        \n        \n    // },\n    \n    \n    \n\tonload: function (frm) {\n\t     if (!frm.doc.review_number) {\n            generateNumber(frm);\n        }\n\t    \nfrappe.call({\n    method: 'frappe.client.get_list',\n    args: {\n        doctype: 'Bond Facility Quotation Acceptance',\n        filters: {\n            workflow_state: \"Accepted\"\n        },\n        fields: ['name1'],\n        limit_page_length: 0\n    },\n    callback: function(response) {\n        console.log(\"Approved Bond Applications:\", response);\n\n        // Extract facility names directly\n        let finalArray = response.message.map(x => x.name1);\n        \n        finalArray.sort();\n\n        // Set dropdown options\n        frm.set_df_property('name1', 'options', finalArray);\n\n        console.log(\"Final Dropdown Options:\", finalArray);\n    },\n    error: function(xhr, textStatus, errorThrown) {\n        console.error(\"Error fetching approved bonds:\", textStatus, errorThrown);\n    }\n});\n\n\n\n\n\n\n        \n \n\t},\n\t\n\t\nname1: function(frm) {\n    frappe.call({\n        method: \"frappe.client.get_list\",\n        args: {\n            doctype: \"Bond Facility Quotation Acceptance\",\n            filters: {\n                name1: frm.doc.name1\n            },\n            fields:  [\"faciity_no\",\"currency1\",\"currency2\",\"currency3\",\"currency4\",\"currency5\",\"security_percentage_for_limit1\",\"security_percentage_for_limit2\",\"security_percentage_for_limit3\",\"security_percentage_for_limit4\",\"security_percentage_for_limit5\"],\n        },\n        callback: function(r) {\n            console.log(r, \"client short name\");\n\n            if (!r.exc) {\n                if (r.message && r.message.length > 0) {\n                    var firstRecord = r.message[0]; // Assuming you only want to consider the first record\n                    frm.set_value('facility_no', firstRecord.faciity_no);\n                     frm.set_value('bond_facility_limit1', firstRecord.currency1);\n                      frm.set_value('bond_facility_limit2', firstRecord.currency2);\n                       frm.set_value('bond_facility_limit3', firstRecord.currency3);\n                        frm.set_value('bond_facility_limit4', firstRecord.currency4);\n                    frm.set_value('net_facility_amount', firstRecord.currency5);\n                     frm.set_value('security_per_limit1', firstRecord.security_percentage_for_limit1);\n                      frm.set_value('security_per_limit2', firstRecord.security_percentage_for_limit2);\n                       frm.set_value('security_per_limit3', firstRecord.security_percentage_for_limit3);\n                        frm.set_value('security_per_limit4', firstRecord.security_percentage_for_limit4);\n                         frm.set_value('security_per_limit5', firstRecord.security_percentage_for_limit5);\n                  \n                } else {\n                    // Handle the case when no records are found\n                    console.log(\"No records found for the given filters.\");\n                }\n            } else {\n                console.error(\"Error occurred:\", r.exc);\n            }\n        }\n    });\n    \n    \n},\n send_to_recommendation: function(frm) {\n        frappe.set_route(\"List\", \"User\");\n    }\n\t\n});\n\n\nfunction generateNumber(frm) {\n    let currentYear = new Date().getFullYear();\n    let prefix = `BFR/${currentYear}/`;\n\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Facility Review',\n            fields: ['review_number', 'creation'],\n            order_by: 'creation desc',\n            limit: 1\n        },\n        callback: function (r) {\n            if (r.message && r.message.length > 0) {\n                let lastReviewNo = r.message[0].review_number;\n                let lastNumber = parseInt(lastReviewNo.split(\"/\").pop()) || 0;\n                let newNumber = (lastNumber + 1).toString().padStart(4, '0');\n                frm.set_value('review_number', prefix + newNumber);\n            } else {\n                frm.set_value('review_number', prefix + '0001');\n            }\n        }\n    });\n}\n\n\n\n\n\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Domestic Declarations",
  "enabled": 1,
  "modified": "2025-12-10 11:33:00.189237",
  "module": "UnderWriting",
  "name": "Domestic Declarations Script",
  "script": "frappe.ui.form.on('Domestic Declarations', {\r\n\r\n \r\n    refresh : function(frm) {\r\n         \r\n      alignFieldsRight(frm, fieldsToAlignRight);\r\n        \r\n      generateDDNumber(frm);\r\n      \r\n       calculateGrandTotal(frm);\r\n        calculateGrandTotal1(frm);\r\n        \r\n        calculateadjustedwithoutvat1(frm);\r\n        calculateadjustedwithoutvat(frm);\r\n      \r\n      setDeclAmount(frm);\r\n      \r\n       frm.fields_dict.add.$input.addClass('btn-primary');\r\n       \r\n\r\n\r\n    // // CASE 1: New document \u2192 show Save button\r\n    //     if (frm.is_new()) {\r\n    //         frm.enable_save();\r\n \r\n    //         setTimeout(() => {\r\n    //             frm.page.btn_primary.show();   // Show Save button\r\n    //         }, 50);\r\n    //     }\r\n \r\n    //     // CASE 2: Existing document \u2192 hide Save button\r\n    //     else {\r\n    //         frm.disable_save();\r\n \r\n    //         setTimeout(() => {\r\n    //             frm.page.btn_primary.hide();   // Hide Save\r\n    //             $('button[data-label=\"Save\"]').hide(); // Hide in menu\r\n    //         }, 50);\r\n    //     }\r\n\r\n    \r\n    frm.set_df_property('outstanding1', 'cannot_add_rows', true); \r\n    frm.set_df_property('turnover1', 'cannot_add_rows', true);\r\n\r\n\r\n     \r\n     //----------------------------------------\r\n        var workflow_state = frm.doc.workflow_state;\r\n\r\n        // Check if the workflow state is \"Approved\"\r\n        if (workflow_state === \"Approved\") {\r\n            // Show policy_holder1 field and hide policy_holder field\r\n            frm.toggle_display('policy_holder1', true);\r\n            frm.toggle_display('policy_holder', false);\r\n        } else {\r\n            // If workflow state is not \"Approved\", reverse the display\r\n            frm.toggle_display('policy_holder1', false);\r\n            frm.toggle_display('policy_holder', true);\r\n        }\r\n    \r\n    var workflow_state1 = frm.doc.workflow_state;\r\n         // Check if the workflow state is \"Approved\"\r\n        if (workflow_state1 === \"Accepted\") {\r\n            // Show policy_holder1 field and hide policy_holder field\r\n            frm.toggle_display('policy_number1', true);\r\n            frm.toggle_display('policy_number', false);\r\n        } else {\r\n            // If workflow state is not \"Approved\", reverse the display\r\n            frm.toggle_display('policy_number1', false);\r\n            frm.toggle_display('policy_number', true);\r\n        }\r\n        \r\n\r\n        \r\n        //childtable total row column\r\n   //------------------\r\n      [\"outstanding1\", \"turnover1\"].forEach(function(table_field) {\r\n            let child_rows = frm.doc[table_field] || [];\r\n            if (child_rows.length === 0) return;\r\n\r\n            let total_row = child_rows[child_rows.length - 1];\r\n            total_row.is_total_row = 1;\r\n\r\n            // Use requestAnimationFrame to ensure DOM is fully rendered\r\n            requestAnimationFrame(() => {\r\n                let grid_row = frm.fields_dict[table_field].grid.get_row(total_row.name);\r\n                if (!grid_row) return;\r\n\r\n                // Make row read-only\r\n                grid_row.toggle_editable(false);\r\n\r\n                // Hide S.No column and checkbox\r\n                grid_row.row.find(\".grid-row-check\").hide();\r\n                grid_row.row.find(\".row-index\").text(\"\"); // Clear the No.\r\n\r\n                // Label the buyer column\r\n                grid_row.row.find('[data-fieldname=\"buyer\"]').html(\"<b>TOTAL</b>\");\r\n\r\n                // Gray background\r\n                grid_row.row.css(\"background-color\", \"#f2f2f2\");\r\n            });\r\n        });\r\n        \r\n        \r\n\r\n\r\n   //-----------------\r\n  frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Policy Approvals',\r\n            'filters': {\r\n         // 'workflow_state': 'Approved',Accpeted\r\n         'workflow_state': 'Accepted',\r\n           'policy_type': 'DCI'\r\n       },\r\n            fields: ['policy_holder'],\r\n             limit_page_length: 0 \r\n        },\r\n        callback: function(response) {\r\n            console.log(\"policy_holder received:\", response);\r\n            let DataArray = response.message;\r\n            let uniqueFacilityNos = new Set();\r\n           \r\n \r\n            // Collect unique facility_no values\r\n            for (let x of DataArray) {\r\n                uniqueFacilityNos.add(x.policy_holder);\r\n            }\r\n \r\n            // Convert set to array\r\n            let FinalArray = Array.from(uniqueFacilityNos);\r\n            \r\n            FinalArray.sort();\r\n \r\n            frm.set_df_property('policy_holder', 'options', FinalArray);\r\n            console.log(\"final\", FinalArray);\r\n        },\r\n        error: function(xhr, textStatus, errorThrown) {\r\n            console.error(\"Error fetching policy_holder:\", textStatus, errorThrown);\r\n        }\r\n    });  \r\n\r\n//currency doctype\r\n      frappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Currency_Finance',\r\n        fields: ['short_name'],\r\n        limit_page_length: 10000\r\n    },\r\n    callback(response) {\r\n        const currency = response.message || [];\r\n        const unique = [...new Set(currency.map(b => b.short_name))];\r\n        unique.sort();\r\n        frm.set_df_property('curr', 'options', unique);\r\n    }\r\n});\r\n\r\n//  frappe.call({\r\n//             method: 'frappe.client.get_list',\r\n//             args: {\r\n//                 'doctype': 'Buyer',\r\n//                 'filters': {'dci': 1}, // Assuming you have a field 'dci' to identify DCI buyers\r\n//                 'fields': ['buyer_name'],\r\n//                  limit_page_length: 10000 // Adjust fields as needed\r\n//             },\r\n//             callback: function(response) {\r\n//                 var dci_buyers = response.message;\r\n//                 var options = dci_buyers.map(buyer => buyer.buyer_name);\r\n\r\n//                 // Set options for buyer_name and buyername1 fields\r\n//                 frm.set_df_property('buyer_name', 'options', options);\r\n//                 frm.set_df_property('buyername1', 'options', options);\r\n//             }\r\n//         });\r\n\r\n    frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Buyer',\r\n                filters: { 'dci': 1 },  // Only DCI buyers\r\n                fields: ['buyer_name'],\r\n                limit_page_length: 10000\r\n            },\r\n            callback: function(response) {\r\n                if (response.message) {\r\n                    const options = response.message.map(buyer => buyer.buyer_name);\r\n\r\n                    // Populate select options\r\n                    frm.set_df_property('buyer_name', 'options', options);\r\n                    frm.set_df_property('buyername1', 'options', options);\r\n                }\r\n            }\r\n        });    \r\n        \r\n\r\n    },\r\n    \r\n    onload: function(frm) {\r\n        alignFieldsRight(frm, fieldsToAlignRight);\r\n\r\n        // hide Sno.\r\n        //   $('<style>')\r\n        //     .prop('type', 'text/css')\r\n        //     .html('.row-index > span { display: none; }')\r\n        //     .appendTo('head');\r\n        \r\n   },\r\n\r\n    without_vat: function(frm) {\r\n       if (frm.doc.without_vat) {\r\n      frm.set_value('vat_percentage', frm.doc.without_vat ? 0 : '');\r\n        }\r\n    },\r\n    \r\n    with_vat: function(frm) {\r\n        if (frm.doc.with_vat) {\r\n            // Fetch VAT percentage from 'VAT' doctype\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'VAT',\r\n                    limit: 1, // Fetch the first document\r\n                    fields: ['vat']\r\n                },\r\n                callback: function(r) {\r\n                    if (r.message && r.message.length > 0) {\r\n                        frm.set_value('vat_percentage', r.message[0].vat);\r\n                        frm.set_value('without_vat', 0); // Uncheck 'without_vat' checkbox\r\n                    } else {\r\n                        frappe.msgprint(__('Unable to fetch VAT percentage. Please try again.'));\r\n                        frm.set_value('with_vat', 0); // Uncheck 'with_vat' checkbox if VAT fetch fails\r\n                    }\r\n                }\r\n            });\r\n        } else {\r\n            frm.set_value('vat_percentage', '0'); // Clear the vat_percentage field if 'with_vat' is unchecked\r\n        }\r\n    },\r\n    \r\n    policy_holder: function(frm) {\r\n    var policyHolder = frm.doc.policy_holder;\r\n    \r\n\r\n\r\n    console.log(\"Policy Holder:\", policyHolder); // Check policy_holder value\r\n\r\n    // Check if policy_holder is not empty and matches a specific condition\r\n    if (policyHolder) {\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Policy Approvals',\r\n                filters: {\r\n                    'policy_holder': policyHolder,\r\n                    'policy_type': 'DCI'\r\n                },\r\n                fields: ['policy_number']\r\n            },\r\n            callback: function(response) {\r\n                console.log(\"Response:\", response); // Check response from server\r\n\r\n                if (response.message && response.message.length > 0) {\r\n                    var policyNumbers = response.message.map(item => item.policy_number);\r\n                    console.log(\"Policy Numbers:\", policyNumbers); // Check policy numbers fetched\r\n\r\n                    // Update dropdown field options\r\n                    frm.set_df_property('policy_number', 'options', policyNumbers);\r\n                    frm.refresh_field('policy_number'); // Refresh dropdown field\r\n                } else {\r\n                    // Clear dropdown field options if no data found\r\n                    frm.set_df_property('policy_number', 'options', []);\r\n                    frm.refresh_field('policy_number'); // Refresh dropdown field\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error(\"Error fetching Policy Approvals:\", err); // Log error to console\r\n                frappe.msgprint('An error occurred while fetching data from Policy Approvals. Please check the console for details.');\r\n            }\r\n        });\r\n    } else {\r\n        // Clear dropdown field options if policy_holder condition is not met\r\n        frm.set_df_property('policy_number', 'options', []);\r\n        frm.refresh_field('policy_number'); // Refresh dropdown field\r\n    }\r\n},\r\n\r\n    policy_number: function(frm) {\r\n    var policyNumber = frm.doc.policy_number;\r\n\r\n    // Fetch data from Policy Approvals\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Policy Approvals',\r\n            filters: {\r\n                'policy_number': policyNumber,\r\n                'policy_type': 'DCI'\r\n            },\r\n            fields: ['policy_holder', 'policy_number', 'status', 'inception_date', 'expiry_date','quotation_numbers']//,'premium_rate']\r\n        },\r\n        callback: function(response) {\r\n            if (response.message && response.message.length > 0) {\r\n                var policyApprovalData = response.message[0];\r\n\r\n                // Check if the policy number is already approved in Export Declarations\r\n                frappe.call({\r\n                    method: 'frappe.client.get_list',\r\n                    args: {\r\n                        doctype: 'Domestic Declarations',\r\n                        filters: {\r\n                            'policy_number': policyNumber,\r\n                            'workflow_state': 'Approved'\r\n                        },\r\n                        fields: ['policy_number']\r\n                    },\r\n                    callback: function(approvedResponse) {\r\n                        if (approvedResponse.message && approvedResponse.message.length > 0) {\r\n                            frappe.msgprint('This policy number is already approved.');\r\n                        } else {\r\n                         \r\n                    // Populate fields if data is found\r\n                    frm.set_value('policy_holder', policyApprovalData.policy_holder || '');\r\n                    frm.set_value('policy_holder1', policyApprovalData.policy_holder || '');\r\n                    frm.set_value('policy_number', policyApprovalData.policy_number || '');\r\n                    frm.set_value('policy_number1', policyApprovalData.policy_number || '');\r\n                    frm.set_value('status', policyApprovalData.status || '');\r\n                    frm.set_value('inception_date', policyApprovalData.inception_date || '');\r\n                    frm.set_value('expiry_date', policyApprovalData.expiry_date || '');\r\n                    frm.set_value('quotation_numbers', policyApprovalData.quotation_numbers || '');\r\n                   //  frm.set_value('premium_rate', policyApprovalData.premium_rate || '');\r\n\r\n                        }\r\n                    },\r\n                    error: function(err) {\r\n                        console.error(\"Error fetching approved policy numbers:\", err);\r\n                        frappe.msgprint('An error occurred while checking approved policy numbers. Please check the console for details.');\r\n                    }\r\n                });\r\n          } else {\r\n                    // Clear fields if no matching record found\r\n                    frm.set_value('policy_holder', '');\r\n                    frm.set_value('policy_holder1', '');\r\n                    frm.set_value('policy_number', '');\r\n                    frm.set_value('policy_number1', '');\r\n                    frm.set_value('status', '');\r\n                    frm.set_value('inception_date', '');\r\n                    frm.set_value('expiry_date', '');\r\n                     frm.set_value('quotation_numbers', '');\r\n                   //    frm.set_value('premium_rate', '');\r\n\r\n                    frappe.msgprint('No matching record found in Policy Approvals for the selected policy holder.');\r\n                }\r\n        },\r\n        error: function(err) {\r\n            console.error(\"Error fetching Policy Approvals:\", err);\r\n            frappe.msgprint('An error occurred while fetching data from Policy Approvals. Please check the console for details.');\r\n        }\r\n    });\r\n},\r\n\r\n\r\n\r\n      \r\n upload1(frm) {\r\n\r\n console.log(\"upload1 function called\"); // Log to trace function call\r\n    var file1 = frm.doc.upload1;\r\n\r\n    // Check if a file is uploaded\r\n    if (file1) {\r\n      console.log(\"File uploaded: \", file1); // Log file upload\r\n        // Get the file extension\r\n        var fileExtension1 = file1.split('.').pop().toLowerCase();\r\n\r\n        // Allowed file extensions (Excel and PDF)\r\n        var allowedExtensions1 = ['xlsx', 'xls'];\r\n\r\n        // Check if the file extension is allowed\r\n        if (!allowedExtensions1.includes(fileExtension1)) {\r\n            // Show an error message\r\n             frappe.msgprint(__(\"Only Excel (.xlsx, .xls) files are allowed\"));\r\n            // Clear the file field\r\n            frm.set_value('upload1', '');\r\n            // clearTableAndTotal(frm);\r\n            // return;\r\n        }\r\n\r\n        // If the uploaded file is an Excel file, make the API call\r\n      frm.call({\r\n                doc: frm.doc,\r\n                method: 'extractData1',\r\n                callback: function(response) {\r\n                    console.log(response.message, \"res\");\r\n                    if (!response.exc) {\r\n                        console.log(response.message, \"hi\");\r\n                        var data = response.message;\r\n                        // Clear the form before loading data into child table\r\n                        frappe.model.clear_doc(frm.doc);\r\n                        frm.clear_table('outstanding1');\r\n                        var grandTotal = 0; // Initialize grand total to 0\r\n                        for (let x of data) {\r\n                            var child = frappe.model.add_child(frm.doc, \"Outstanding_Turnover_table\", \"outstanding1\");\r\n                            console.log(child, \"s\");\r\n                            frappe.model.set_value(child.doctype, child.name, \"buyer\", x.Buyer);\r\n                            frappe.model.set_value(child.doctype, child.name, \"current\", x.Current);\r\n                            frappe.model.set_value(child.doctype, child.name, \"30_days\", x['30Days']);\r\n                            frappe.model.set_value(child.doctype, child.name, \"60_days\", x['60Days']);\r\n                            frappe.model.set_value(child.doctype, child.name, \"90_days\", x['90Days']);\r\n                            frappe.model.set_value(child.doctype, child.name, \"120days\", x['120Days']);\r\n                            frappe.model.set_value(child.doctype, child.name, \"credit_days\", x['Credit Days']);\r\n                            // Calculate total for each row\r\n                            var total = parseFloat(x.Current || 0) + parseFloat(x['30Days'] || 0) + parseFloat(x['60Days'] || 0) + parseFloat(x['90Days'] || 0) + parseFloat(x['120Days'] || 0);\r\n                            frappe.model.set_value(child.doctype, child.name, \"total\", total);\r\n                           \r\n                         \r\n                            // Calculate adjust_wo_vat\r\n                            \r\n                             var vatpercentage =frm.doc.vat_percentage;\r\n                             \r\n                             var adjust_wo_vat = total / (vatpercentage / 100);\r\n                             \r\n                             frappe.model.set_value(child.doctype, child.name, \"adjust_wo_vat\", adjust_wo_vat);\r\n                             \r\n                    //set te value for \"grand total\"\r\n                              var childTableData = frm.doc.outstanding1 || [];\r\n                              var grandTotal = childTableData.reduce(function(total, row) {\r\n                              var rowTotal = parseFloat(row.total) || 0;\r\n                              return total + rowTotal;\r\n                              }, 0);\r\n                              \r\n                          //testing as that's adding twice\r\n                          \r\n                            frm.set_value('grandtotal', grandTotal);\r\n                           //  frm.set_value('grandtotal', adjustedvat);\r\n                             \r\n                    //set the value for adjusted with out vat\r\n                              var adjustedvat = childTableData.reduce(function(adjust_wo_vat, row) {\r\n                              var rowTotal = parseFloat(row.adjust_wo_vat) || 0;\r\n                              return adjust_wo_vat + rowTotal;\r\n                              }, 0);\r\n                            \r\n                              frm.set_value('outstanding_adjusted_wo_vat', adjustedvat);\r\n\r\n                             \r\n                            // calculateGrandTotal(frm);\r\n                            // calculateadjustedwithoutvat(frm); \r\n                            \r\n                        }\r\n                        frm.refresh_fields('outstanding1');\r\n                        console.log(data);\r\n                    } else {\r\n                      \r\n                        console.error(response.exc);\r\n                    }\r\n                }\r\n            });\r\n    } else {\r\n        // If no file is uploaded, clear the table and grand_total field\r\n        clearTableAndTotal(frm);\r\n        return;\r\n    }\r\n},\r\n\r\n  \r\n upload(frm) {\r\n    var file = frm.doc.upload;\r\n\r\n    // Check if a file is uploaded\r\n    if (file) {\r\n        // Get the file extension\r\n        var fileExtension = file.split('.').pop().toLowerCase();\r\n\r\n        // Allowed file extensions (Excel and PDF)\r\n        var allowedExtensions = ['xlsx', 'xls'];\r\n\r\n        // Check if the file extension is allowed\r\n        if (!allowedExtensions.includes(fileExtension)) {\r\n            // Show an error message\r\n            frappe.msgprint(__(\"Only Excel (.xlsx, .xls) files are allowed\"));\r\n            // Clear the file field\r\n            frm.set_value('upload', '');\r\n            // clearTableAndTotal(frm);\r\n            // return;\r\n        }\r\n\r\n        // If the uploaded file is an Excel file, make the API call\r\n                frm.call({\r\n                doc: frm.doc,\r\n                method: 'extractData',\r\n                callback: function(response) {\r\n                    console.log(response.message, \"res\");\r\n                    if (!response.exc) {\r\n                        console.log(response.message, \"hi\");\r\n                        var data = response.message;\r\n                        // Clear the form before loading data into child table\r\n                        frappe.model.clear_doc(frm.doc);\r\n                        frm.clear_table('turnover1');\r\n                        var grandTotal = 0; // Initialize grand total to 0\r\n                        for (let x of data) {\r\n                            var child = frappe.model.add_child(frm.doc, \"Outstanding_Turnover_table\", \"turnover1\");\r\n                            console.log(child, \"s\");\r\n                            frappe.model.set_value(child.doctype, child.name, \"buyer\", x.Buyer);\r\n                            frappe.model.set_value(child.doctype, child.name, \"current\", x.Current);\r\n                            frappe.model.set_value(child.doctype, child.name, \"30_days\", x['30Days']);\r\n                            frappe.model.set_value(child.doctype, child.name, \"60_days\", x['60Days']);\r\n                            frappe.model.set_value(child.doctype, child.name, \"90_days\", x['90Days']);\r\n                            frappe.model.set_value(child.doctype, child.name, \"120days\", x['120Days']);\r\n                            frappe.model.set_value(child.doctype, child.name, \"credit_days\", x['Credit Days']);\r\n                            // Calculate total for each row\r\n                            var total = parseFloat(x.Current || 0) + parseFloat(x['30Days'] || 0) + parseFloat(x['60Days'] || 0) + parseFloat(x['90Days'] || 0) + parseFloat(x['120Days'] || 0);\r\n                            frappe.model.set_value(child.doctype, child.name, \"total\", total);\r\n                      \r\n                             frappe.model.set_value(child.doctype, child.name, \"adjust_wo_vat\", total);\r\n                           \r\n                          //set value for rand total\r\n                          var childTableData = frm.doc.turnover1 || [];\r\n   \r\n                          var grandTotal = childTableData.reduce(function(total, row) {\r\n                          var rowTotal = parseFloat(row.total) || 0;\r\n                          return total + rowTotal;\r\n                          }, 0);\r\n     \r\n                          console.log(\"Grand Total:\", grandTotal);\r\n                             frm.set_value('grandtotal1', grandTotal);\r\n                            \r\n                            // frm.set_value('grandtotal1', adjustedvat);\r\n\r\n                            //set value for adjusted vat for turnover\r\n                          \r\n                          var adjustedvat = childTableData.reduce(function(adjust_wo_vat, row) {\r\n                          var rowTotal = parseFloat(row.adjust_wo_vat) || 0;\r\n                          return adjust_wo_vat + rowTotal;\r\n                          }, 0);\r\n                          console.log(\"Grand Total:\", grandTotal);\r\n                          frm.set_value('turnover_adjusted_wo_vat', adjustedvat);\r\n\r\n                           \r\n                            // calculateGrandTotal1(frm);\r\n                            // calculateadjustedwithoutvat1(frm); \r\n                        }\r\n                        frm.refresh_fields('turnover1');\r\n                        console.log(data);\r\n                    } else {\r\n                     \r\n                        console.error(response.exc);\r\n                    }\r\n                }\r\n            });\r\n    } else {\r\n        // If no file is uploaded, clear the table and grand_total field\r\n        clearTableAndTotal1(frm);\r\n        return;\r\n    }\r\n},\r\n    \r\n\r\n    thirty_days: function(frm) { updateTotal(frm); },\r\n    sixty_days: function(frm) { updateTotal(frm); },\r\n    current: function(frm){ updateTotal(frm); },\r\n    ninety_days: function(frm){ updateTotal(frm); },\r\n    onetwenty_days: function(frm){ updateTotal(frm); },\r\n\r\n    thirty_days1: function(frm) { updateTotal1(frm); },\r\n    sixty_days1: function(frm) { updateTotal1(frm); },\r\n    ninety_days1: function(frm){ updateTotal1(frm); },\r\n    onetwenty_days1: function(frm){ updateTotal1(frm); },\r\n    current1: function(frm){ updateTotal1(frm); },\r\n\r\n    add: function(frm){\r\n    addToChildTable(frm); \r\n    calculateGrandTotal(frm); \r\n    calculateadjustedwithoutvat(frm);    \r\n     calculateAndDisplayTotals(frm);\r\n    },\r\n    add1: function(frm){\r\n    addToChildTable1(frm); \r\n    calculateGrandTotal1(frm); \r\n    calculateadjustedwithoutvat1(frm);\r\n        calculateAndDisplayTotalsTurnover(frm);\r\n    },\r\n    \r\n    outstanding1: {\r\n        thirty_days: function(frm, cdt, cdn) {\r\n            calculateAndDisplayTotals(frm);\r\n        },\r\n        sixty_days: function(frm, cdt, cdn) {\r\n            calculateAndDisplayTotals(frm);\r\n        },\r\n        ninety_days: function(frm, cdt, cdn) {\r\n            calculateAndDisplayTotals(frm);\r\n        },\r\n        onetwenty_days: function(frm, cdt, cdn) {\r\n            calculateAndDisplayTotals(frm);\r\n        },\r\n        current: function(frm, cdt, cdn) {\r\n            calculateAndDisplayTotals(frm);\r\n        },\r\n        total: function(frm, cdt, cdn) {\r\n            calculateAndDisplayTotals(frm);\r\n        },\r\n        adjust_wo_vat: function(frm, cdt, cdn) {\r\n            calculateAndDisplayTotals(frm);\r\n        }\r\n    },\r\n    turnover1: {\r\n        current: function(frm, cdt, cdn) {\r\n            calculateAndDisplayTotalsTurnover(frm);\r\n        },\r\n        thirty_days: function(frm, cdt, cdn) {\r\n            calculateAndDisplayTotalsTurnover(frm);\r\n        },\r\n        sixty_days: function(frm, cdt, cdn) {\r\n            calculateAndDisplayTotalsTurnover(frm);\r\n        },\r\n        ninety_days: function(frm, cdt, cdn) {\r\n            calculateAndDisplayTotalsTurnover(frm);\r\n        },\r\n        onetwenty_days: function(frm, cdt, cdn) {\r\n            calculateAndDisplayTotalsTurnover(frm);\r\n        },\r\n        total: function(frm, cdt, cdn) {\r\n            calculateAndDisplayTotalsTurnover(frm);\r\n        },\r\n        adjust_wo_vat: function(frm, cdt, cdn) {\r\n            calculateAndDisplayTotalsTurnover(frm);\r\n        }\r\n    }\r\n    \r\n\r\n});\r\n\r\n\r\n    // thirty_days: function(frm) { updateTotal(frm); },\r\n    // sixty_days: function(frm) { updateTotal(frm); },\r\n    // current: function(frm){ updateTotal(frm); },\r\n    // ninety_days: function(frm){ updateTotal(frm); },\r\n    // onetwenty_days: function(frm){ updateTotal(frm); },\r\n\r\n//     thirty_days1: function(frm) { updateTotal1(frm); },\r\n//     sixty_days1: function(frm) { updateTotal1(frm); },\r\n//     ninety_days1: function(frm){ updateTotal1(frm); },\r\n//     onetwenty_days1: function(frm){ updateTotal1(frm); },\r\n//     current1: function(frm){ updateTotal1(frm); },\r\n\r\n\r\n\r\n//     add1: function(frm){\r\n//     addToChildTable1(frm); \r\n//     calculateGrandTotal1(frm); \r\n//     calculateadjustedwithoutvat1(frm);\r\n//         calculateAndDisplayTotalsTurnover(frm);\r\n//     },\r\n    \r\n//     add: function(frm){\r\n//     addToChildTable(frm); \r\n//     calculateGrandTotal(frm); \r\n//     calculateadjustedwithoutvat(frm);    \r\n//      calculateAndDisplayTotals(frm);\r\n//     },\r\n    \r\n//     outstanding1: {\r\n//         thirty_days: function(frm, cdt, cdn) {\r\n//             calculateAndDisplayTotals(frm);\r\n//         },\r\n//         sixty_days: function(frm, cdt, cdn) {\r\n//             calculateAndDisplayTotals(frm);\r\n//         },\r\n//         ninety_days: function(frm, cdt, cdn) {\r\n//             calculateAndDisplayTotals(frm);\r\n//         },\r\n//         onetwenty_days: function(frm, cdt, cdn) {\r\n//             calculateAndDisplayTotals(frm);\r\n//         },\r\n//         current: function(frm, cdt, cdn) {\r\n//             calculateAndDisplayTotals(frm);\r\n//         },\r\n//         total: function(frm, cdt, cdn) {\r\n//             calculateAndDisplayTotals(frm);\r\n//         },\r\n//         adjust_wo_vat: function(frm, cdt, cdn) {\r\n//             calculateAndDisplayTotals(frm);\r\n//         }\r\n//     }\r\n    \r\n// });\r\n    \r\n//     turnover1: {\r\n//         current: function(frm, cdt, cdn) {\r\n//             calculateAndDisplayTotalsTurnover(frm);\r\n//         },\r\n//         thirty_days: function(frm, cdt, cdn) {\r\n//             calculateAndDisplayTotalsTurnover(frm);\r\n//         },\r\n//         sixty_days: function(frm, cdt, cdn) {\r\n//             calculateAndDisplayTotalsTurnover(frm);\r\n//         },\r\n//         ninety_days: function(frm, cdt, cdn) {\r\n//             calculateAndDisplayTotalsTurnover(frm);\r\n//         },\r\n//         onetwenty_days: function(frm, cdt, cdn) {\r\n//             calculateAndDisplayTotalsTurnover(frm);\r\n//         },\r\n//         total: function(frm, cdt, cdn) {\r\n//             calculateAndDisplayTotalsTurnover(frm);\r\n//         },\r\n//         adjust_wo_vat: function(frm, cdt, cdn) {\r\n//             calculateAndDisplayTotalsTurnover(frm);\r\n//         }\r\n//     }\r\n    \r\n\r\n// });\r\n//  origial code\r\n//GENERATE NUMBER\r\n\r\n\r\n\r\n\r\nfunction generateDDNumber(frm) {\r\n    // Check if the ed_number field is already populated\r\n    if (!frm.doc.ed_number) {\r\n        // Get the current year\r\n        let currentYear = new Date().getFullYear();\r\n        let prefix = `DCL/${currentYear}/`;\r\n\r\n        // Make a call to get the last Export Declarations number asynchronously\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Export Declarations',\r\n                fields: ['ed_number'],\r\n                limit: 1,\r\n                order_by: 'creation desc'\r\n            },\r\n            callback: function(response) {\r\n                let lastEDNumber = response.message && response.message.length > 0 ? response.message[0].ed_number : '0';\r\n                let lastNumber = parseInt(lastEDNumber.split(\"/\").pop()) || 0; // Extract last part and parse it as integer\r\n\r\n                // Make a call to get the last Domestic Declarations number asynchronously\r\n                frappe.call({\r\n                    method: 'frappe.client.get_list',\r\n                    args: {\r\n                        doctype: 'Domestic Declarations',\r\n                        fields: ['ed_number'],\r\n                        limit: 1,\r\n                        order_by: 'creation desc'\r\n                    },\r\n                    callback: function(response) {\r\n                        let lastDomesticDeclarationsDDNumber = response.message && response.message.length > 0 ? response.message[0].ed_number : '0';\r\n                        let lastDomesticDeclarationsDDNo = parseInt(lastDomesticDeclarationsDDNumber.split(\"/\").pop()) || 0;\r\n\r\n                        // Get the maximum of the last two numbers\r\n                        let maxLastNumber = Math.max(lastNumber, lastDomesticDeclarationsDDNo);\r\n\r\n                        // Increment the last number and pad it with leading zeros\r\n                        let newNumber = (maxLastNumber + 1).toString().padStart(4, '0');\r\n                        frm.set_value('ed_number', prefix + newNumber);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\n\r\n// Function to clear table and grand_total field\r\nfunction clearTableAndTotal(frm) {\r\n    // Clear the table\r\n    frm.clear_table('outstanding1');\r\n    // Clear the grand_total field\r\n    frm.set_value('grandtotal', '');\r\n    frm.set_value('outstanding_adjusted_wo_vat', '');\r\n}\r\n\r\nfunction clearTableAndTotal1(frm) {\r\n    // Clear the table\r\n    frm.clear_table('turnover1');\r\n    // Clear the grand_total field\r\n    frm.set_value('grandtotal1', '');\r\n    frm.set_value('turnover_adjusted_wo_vat', '');\r\n}\r\n\r\nfunction setDeclAmount(frm) {\r\n    const gt = Number(frm.doc.grandtotal) || 0;\r\n    const gt1 = Number(frm.doc.grandtotal1) || 0;\r\n\r\n    if (gt !== 0) {\r\n        frm.set_value('decl_amt', gt);\r\n    } else if (gt1 !== 0) {\r\n        frm.set_value('decl_amt', gt1);\r\n    }\r\n    // If both are 0, do nothing (keep existing decl_amt)\r\n}\r\n\r\n\r\n// function updateTotal(frm) {\r\n//     var total30 = parseFloat(frm.doc.thirty_days) || 0;\r\n//     var total60 = parseFloat(frm.doc.sixty_days) || 0;\r\n//     var total90 = parseFloat(frm.doc.ninety_days) || 0;\r\n//     var total120 = parseFloat(frm.doc.onetwenty_days) || 0;\r\n//     var totalcurrent = parseFloat(frm.doc.current) || 0;\r\n\r\n//     var total = total30 + total60 + total90 + total120 + totalcurrent;\r\n//     frm.set_value('total', total);\r\n\r\n//     // If WITHOUT VAT checkbox is checked \u2192 no VAT\r\n//     if (frm.doc.without_vat) {\r\n//         frm.set_value('adjusted', total);\r\n//         return;\r\n//     }\r\n\r\n//     // VAT should apply only when with_vat is checked\r\n//     if (!frm.doc.with_vat) {\r\n//         frm.set_value('adjusted', total);\r\n//         return;\r\n//     }\r\n\r\n//     // VAT calculation\r\n//     var vatpercentage = parseFloat(frm.doc.vat_percentage) || 0;\r\n\r\n//     var novat = totalcurrent + total30 + total60 + total90;\r\n\r\n//     var adjusted = novat / (1 + (vatpercentage / 100));\r\n\r\n//     frm.set_value('adjusted', adjusted);\r\n// }\r\n// code without vat\r\n// function updateTotal(frm) {\r\n//     var total30 = parseFloat(frm.doc['thirty_days']) || 0;\r\n//     var total60 = parseFloat(frm.doc['sixty_days']) || 0;\r\n//     var total90 = parseFloat(frm.doc['ninety_days']) || 0;\r\n//     var total120 = parseFloat(frm.doc['onetwenty_days']) || 0;\r\n//     var totalcurrent = parseFloat(frm.doc['current']) || 0;\r\n\r\n//     var total = total30 + total60 + total90 + total120 + totalcurrent;\r\n//     frm.set_value('total', total);\r\n\r\n//     var novat = totalcurrent + total30 + total60 + total90+ total120;\r\n\r\n//     // If WITHOUT VAT checkbox is checked \u2192 show \"novat\" directly\r\n//     if (frm.doc.without_vat) {\r\n//         frm.set_value('adjusted', novat);\r\n//         return;\r\n//     }\r\n\r\n//     // Otherwise calculate with VAT\r\n//     var vatpercentage = frm.doc.vat_percentage || 0;\r\n//     var adjust_wo_vat = novat / (1 + (vatpercentage / 100));\r\n\r\n//     frm.set_value('adjusted', adjust_wo_vat);\r\n// }\r\n// code without vat\r\n//both with and without vat same\r\nfunction updateTotal(frm) {\r\n    var total30 = parseFloat(frm.doc.thirty_days) || 0;\r\n    var total60 = parseFloat(frm.doc.sixty_days) || 0;\r\n    var total90 = parseFloat(frm.doc.ninety_days) || 0;\r\n    var total120 = parseFloat(frm.doc.onetwenty_days) || 0;\r\n    var totalcurrent = parseFloat(frm.doc.current) || 0;\r\n\r\n    var total = total30 + total60 + total90 + total120 + totalcurrent;\r\n    frm.set_value('total', total);\r\n\r\n    // ALWAYS show same total in adjusted field (for both VAT and NON-VAT)\r\n    frm.set_value('adjusted', total);\r\n}\r\n\r\n\r\nfunction updateTotal1(frm) {\r\n    var total30 = parseFloat(frm.doc.thirty_days1) || 0;\r\n    var total60 = parseFloat(frm.doc.sixty_days1) || 0;\r\n    var total90 = parseFloat(frm.doc.ninety_days1) || 0;\r\n    var total120 = parseFloat(frm.doc.onetwenty_days1) || 0;\r\n    var totalcurrent = parseFloat(frm.doc.current1) || 0;\r\n\r\n    var total = total30 + total60 + total90 + total120 + totalcurrent;\r\n    frm.set_value('total1', total);\r\n\r\n    // ALWAYS show same total in adjusted field (for both VAT and NON-VAT)\r\n    frm.set_value('adjusted1', total);\r\n}\r\n\r\n// code with and without vat\r\n// function updateTotal(frm) {\r\n//     var total30 = parseFloat(frm.doc.thirty_days) || 0;\r\n//     var total60 = parseFloat(frm.doc.sixty_days) || 0;\r\n//     var total90 = parseFloat(frm.doc.ninety_days) || 0;\r\n//     var total120 = parseFloat(frm.doc.onetwenty_days) || 0;\r\n//     var totalcurrent = parseFloat(frm.doc.current) || 0;\r\n\r\n//     // TOTAL = sum of all fields\r\n//     var total = total30 + total60 + total90 + total120 + totalcurrent;\r\n//     frm.set_value('total', total);\r\n\r\n//     // If WITHOUT VAT is checked \u2192 adjusted = total\r\n//     if (frm.doc.without_vat) {\r\n//         frm.set_value('adjusted', total);\r\n//         return;\r\n//     }\r\n\r\n//     // If WITH VAT is NOT checked \u2192 adjusted = total\r\n//     if (!frm.doc.with_vat) {\r\n//         frm.set_value('adjusted', total);\r\n//         return;\r\n//     }\r\n\r\n//     // WHEN WITH VAT IS CHECKED \u2192 multiply VAT %\r\n//     var vatpercentage = parseFloat(frm.doc.vat_percentage) || 0;\r\n\r\n//     // VAT value calculation\r\n//     var vat_amount = total * (vatpercentage / 100);\r\n\r\n//     // // Adjusted = total + vat\r\n//     // var adjusted = total + vat_amount;\r\n\r\n//     frm.set_value('adjusted', vat_amount);\r\n// }\r\n\r\n// // code with and without vat\r\n\r\n// function updateTotal1(frm) {\r\n//     var total30 = parseFloat(frm.doc.thirty_days1) || 0;\r\n//     var total60 = parseFloat(frm.doc.sixty_days1) || 0;\r\n//     var total90 = parseFloat(frm.doc.ninety_days1) || 0;\r\n//     var total120 = parseFloat(frm.doc.onetwenty_days1) || 0;\r\n//     var totalcurrent = parseFloat(frm.doc.current1) || 0;\r\n\r\n//     // TOTAL = sum of all fields\r\n//     var total = total30 + total60 + total90 + total120 + totalcurrent;\r\n//     frm.set_value('total1', total);\r\n\r\n//     // If WITHOUT VAT is checked \u2192 adjusted = total\r\n//     if (frm.doc.without_vat) {\r\n//         frm.set_value('adjusted1', total);\r\n//         return;\r\n//     }\r\n\r\n//     // If WITH VAT is NOT checked \u2192 adjusted = total\r\n//     if (!frm.doc.with_vat) {\r\n//         frm.set_value('adjusted1', total);\r\n//         return;\r\n//     }\r\n\r\n//     // WHEN WITH VAT IS CHECKED \u2192 multiply VAT %\r\n//     var vatpercentage = parseFloat(frm.doc.vat_percentage) || 0;\r\n\r\n//     // VAT value calculation\r\n//     var vat_amount = total * (vatpercentage / 100);\r\n\r\n//     frm.set_value('adjusted1', vat_amount);\r\n// }\r\n\r\n\r\nfunction addToChildTable(frm) {\r\n    var row = frappe.model.add_child(frm.doc, \"Outstanding_Turnover_table\", \"outstanding1\");\r\n    row[\"buyer\"] = frm.doc['buyer_name'];\r\n    row[\"credit_days\"] = frm.doc['credit_days'];\r\n    row[\"current\"] = frm.doc['current'];\r\n    row[\"30_days\"] = frm.doc['thirty_days'];\r\n    row[\"60_days\"] = frm.doc['sixty_days'];\r\n    row[\"90_days\"] = frm.doc['ninety_days'];\r\n    row[\"120days\"] = frm.doc['onetwenty_days'];\r\n    row.total = frm.doc['total'];\r\n    row.adjust_wo_vat = frm.doc['adjusted'];\r\n    \r\n    refresh_field(\"outstanding1\");\r\n    frm.set_value(\"buyer_name\", \"\");\r\n    //frm.set_value(\"credit_days\", \"\");\r\n    frm.set_value(\"thirty_days\", \"\");\r\n    frm.set_value(\"sixty_days\", \"\");\r\n    frm.set_value(\"ninety_days\", \"\");\r\n    frm.set_value(\"onetwenty_days\", \"\");\r\n    frm.set_value(\"current\", \"\");\r\n    frm.set_value(\"total\", 0);\r\n    frm.set_value(\"adjusted\", 0);\r\n    \r\n\r\n   \r\n}\r\n\r\nfunction addToChildTable1(frm) {\r\n    var row = frappe.model.add_child(frm.doc, \"Outstanding_Turnover_table\", \"turnover1\");\r\n    row[\"buyer\"] = frm.doc['buyername1'];\r\n    row[\"credit_days\"] = frm.doc['creditdays1'];\r\n    row[\"30_days\"] = frm.doc['thirty_days1'];\r\n    row[\"60_days\"] = frm.doc['sixty_days1'];\r\n    row[\"90_days\"] = frm.doc['ninety_days1'];\r\n    row[\"120days\"] = frm.doc['onetwenty_days1'];\r\n    row[\"current\"] = frm.doc['current1'];\r\n    row.total = frm.doc['total1'];\r\n    row.adjust_wo_vat = frm.doc['adjusted1'];\r\n    \r\n    refresh_field(\"turnover1\");\r\n    frm.set_value(\"buyername1\", \"\");\r\n   // frm.set_value(\"creditdays1\", \"\");\r\n    frm.set_value(\"thirty_days1\", \"\");\r\n    frm.set_value(\"sixty_days1\", \"\");\r\n    frm.set_value(\"ninety_days1\", \"\");\r\n    frm.set_value(\"onetwenty_days1\", \"\");\r\n    frm.set_value(\"current1\", \"\");\r\n    frm.set_value(\"total1\", 0);\r\n    frm.set_value(\"adjusted1\", 0);\r\n  \r\n\r\n}\r\n\r\nfunction calculateGrandTotal(frm) {\r\n    var childTableData = frm.doc.outstanding1 || [];\r\n    var grandTotal = childTableData.reduce(function(total, row) {\r\n        var rowTotal = parseFloat(row.total) || 0;\r\n        return total + rowTotal;\r\n    }, 0);\r\n    console.log(\"Grand Total:\", grandTotal);\r\n    frm.set_value('grandtotal', grandTotal);\r\n    // frm.set_value('decl_amt', grandTotal);\r\n}\r\n\r\nfunction calculateGrandTotal1(frm) {\r\n    var childTableData = frm.doc.turnover1 || [];\r\n   \r\n    var grandTotal = childTableData.reduce(function(total, row) {\r\n        var rowTotal = parseFloat(row.total) || 0;\r\n        return total + rowTotal;\r\n    }, 0);\r\n     \r\n    console.log(\"Grand Total:\", grandTotal);\r\n    frm.set_value('grandtotal1', grandTotal);\r\n     //frm.set_value('decl_amt', grandTotal);\r\n}\r\n\r\nfunction calculateadjustedwithoutvat(frm) {\r\n    var childTableData = frm.doc.outstanding1 || [];\r\n    var grandTotal = childTableData.reduce(function(adjust_wo_vat, row) {\r\n        var rowTotal = parseFloat(row.adjust_wo_vat) || 0;\r\n        return adjust_wo_vat + rowTotal;\r\n    }, 0);\r\n    console.log(\"Grand Total:\", grandTotal);\r\n    frm.set_value('outstanding_adjusted_wo_vat', grandTotal);\r\n}\r\n\r\nfunction calculateadjustedwithoutvat1(frm) {\r\n    var childTableData = frm.doc.turnover1 || [];\r\n    var grandTotal = childTableData.reduce(function(adjust_wo_vat, row) {\r\n        var rowTotal = parseFloat(row.adjust_wo_vat) || 0;\r\n        return adjust_wo_vat + rowTotal;\r\n    }, 0);\r\n    console.log(\"Grand Total:\", grandTotal);\r\n    frm.set_value('turnover_adjusted_wo_vat', grandTotal);\r\n}\r\n\r\n\r\n\r\n\r\nfunction calculateAndDisplayTotals(frm) {\r\n    var childTableData = frm.doc.outstanding1 || [];\r\n    var grandTotal = 0;\r\n    var grandAdjustedWithoutVat = 0;\r\n    var totalcurrent = 0;\r\n    var totalThirtyDays = 0;\r\n    var totalSixtyDays = 0;\r\n    var totalNinetyDays = 0;\r\n    var totalOneTwentyDays = 0;\r\n\r\n    // Remove existing total row if present\r\n    frm.doc.outstanding1 = childTableData.filter(function(row) {\r\n        return !row.is_total_row;\r\n    });\r\n\r\n    childTableData.forEach(function(row) {\r\n        if (!row.is_total_row) {\r\n            grandTotal += parseFloat(row.total) || 0;\r\n            grandAdjustedWithoutVat += parseFloat(row.adjust_wo_vat) || 0;\r\n            totalcurrent += parseFloat(row.current) || 0;\r\n            totalThirtyDays += parseFloat(row[\"30_days\"]) || 0;\r\n            totalSixtyDays += parseFloat(row[\"60_days\"]) || 0;\r\n            totalNinetyDays += parseFloat(row[\"90_days\"]) || 0;\r\n            totalOneTwentyDays += parseFloat(row[\"120days\"]) || 0;\r\n        }\r\n    });\r\n\r\n    frm.set_value('grandtotal', grandTotal);\r\n    frm.set_value('outstanding_adjusted_wo_vat', grandAdjustedWithoutVat);\r\n\r\n     addTotalRow(frm,totalcurrent,totalThirtyDays, totalSixtyDays, totalNinetyDays, totalOneTwentyDays, grandTotal, grandAdjustedWithoutVat);\r\n}\r\n\r\n\r\nfunction addTotalRow(frm, totalcurrent,totalThirtyDays, totalSixtyDays, totalNinetyDays, totalOneTwentyDays, grandTotal, grandAdjustedWithoutVat) {\r\n    var totalRow = frappe.model.add_child(frm.doc, \"Outstanding_Turnover_table\", \"outstanding1\");\r\n\r\n    // Set fields for the total row\r\n    totalRow.is_total_row = 1;\r\n    totalRow.buyer = \"\";\r\n    totalRow.credit_days = \"\";\r\n    \r\n   totalRow.current = totalcurrent; \r\n \r\n    totalRow[\"30_days\"] = totalThirtyDays; // Set the total of 30_days\r\n    totalRow[\"60_days\"] = totalSixtyDays;\r\n    totalRow[\"90_days\"] = totalNinetyDays;\r\n    totalRow[\"120days\"] = totalOneTwentyDays;\r\n    totalRow.total = grandTotal;\r\n    totalRow.adjust_wo_vat = grandAdjustedWithoutVat;\r\n\r\n    frm.refresh_field(\"outstanding1\");\r\n}\r\n\r\n\r\n\r\nfunction calculateAndDisplayTotalsTurnover(frm) {\r\n    var childTableDataTurnover = frm.doc.turnover1 || [];\r\n    var grandTotalTurnover = 0;\r\n    var grandAdjustedWithoutVatTurnover = 0;\r\n    var totalCurrentTurnover = 0;\r\n    var totalThirtyDaysTurnover = 0;\r\n    var totalSixtyDaysTurnover = 0;\r\n    var totalNinetyDaysTurnover = 0;\r\n    var totalOneTwentyDaysTurnover = 0;\r\n \r\n    // Remove existing total row if present\r\n    frm.doc.turnover1 = childTableDataTurnover.filter(function(row) {\r\n        return !row.is_total_row;\r\n    });\r\n \r\n    // Calculate totals\r\n    childTableDataTurnover.forEach(function(row) {\r\n        if (!row.is_total_row) {\r\n            grandTotalTurnover += parseFloat(row.total) || 0;\r\n            grandAdjustedWithoutVatTurnover += parseFloat(row.adjust_wo_vat) || 0;\r\n            totalCurrentTurnover += parseFloat(row.current) || 0;\r\n            totalThirtyDaysTurnover += parseFloat(row[\"30_days\"]) || 0;\r\n            totalSixtyDaysTurnover += parseFloat(row[\"60_days\"]) || 0;\r\n            totalNinetyDaysTurnover += parseFloat(row[\"90_days\"]) || 0;\r\n            totalOneTwentyDaysTurnover += parseFloat(row[\"120days\"]) || 0;\r\n        }\r\n    });\r\n \r\n \r\n    frm.set_value('grandtotal1', grandTotalTurnover);\r\n    frm.set_value('turnover_adjusted_wo_vat', grandAdjustedWithoutVatTurnover);\r\n \r\n    // Add total row to child table\r\n    addTotalRowTurnover(frm, totalCurrentTurnover, totalThirtyDaysTurnover, totalSixtyDaysTurnover, totalNinetyDaysTurnover, totalOneTwentyDaysTurnover, grandTotalTurnover, grandAdjustedWithoutVatTurnover);\r\n}\r\n \r\nfunction addTotalRowTurnover(frm, totalCurrentTurnover, totalThirtyDaysTurnover, totalSixtyDaysTurnover, totalNinetyDaysTurnover, totalOneTwentyDaysTurnover, grandTotalTurnover, grandAdjustedWithoutVatTurnover) {\r\n    var totalRowTurnover = frappe.model.add_child(frm.doc, \"Turnover_Turnover_table\", \"turnover1\");\r\n \r\n    totalRowTurnover.is_total_row = 1;\r\n    totalRowTurnover[\"buyer\"] = \"\";\r\n    totalRowTurnover[\"credit_days\"] = \"\";\r\n    totalRowTurnover.current = totalCurrentTurnover; // Set the total of current\r\n    totalRowTurnover[\"30_days\"] = totalThirtyDaysTurnover;\r\n    totalRowTurnover[\"60_days\"] = totalSixtyDaysTurnover;\r\n    totalRowTurnover[\"90_days\"] = totalNinetyDaysTurnover;\r\n    totalRowTurnover[\"120days\"] = totalOneTwentyDaysTurnover;\r\n    totalRowTurnover.total = grandTotalTurnover;\r\n    totalRowTurnover.adjust_wo_vat = grandAdjustedWithoutVatTurnover;\r\n \r\n    frm.refresh_field(\"turnover1\");\r\n}\r\n\r\n\r\n\r\n// function removeDuplicates(arr) {\r\n//     // Function to remove duplicates from an array\r\n//     var uniqueArr = [];\r\n//     arr.forEach(function(item) {\r\n//         if (uniqueArr.indexOf(item) === -1) {\r\n//             uniqueArr.push(item);\r\n//         }\r\n//     });\r\n//     return uniqueArr;\r\n// }\r\n\r\n\r\nlet fieldsToAlignRight = ['vat_percentage','current', 'thirty_days', 'sixty_days','ninety_days','onetwenty_days','credit_days','total','adjusted','creditdays1',\r\n'current1','thirty_days1','sixty_days1','ninety_days1','onetwenty_days1','total1','adjusted1','turn'] \r\n\r\nfunction alignFieldsRight(frm, fields) {\r\n    fields.forEach(field => {\r\n        let fieldElement = frm.fields_dict[field];\r\n        if (fieldElement && fieldElement.input) {\r\n            fieldElement.input.style.direction = 'rtl';\r\n            fieldElement.input.style.textAlign = 'right';\r\n        }\r\n    });\r\n}\r\n\r\n\r\nfieldsToAlignRight.forEach(field => {\r\n    frappe.ui.form.on('Domestic Declarations', field, function(frm) {\r\n        alignFieldsRight(frm, [field]);\r\n    });\r\n});\r\n\r\n\r\n\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Proforma Invoice",
  "enabled": 1,
  "modified": "2025-12-09 07:36:28.178116",
  "module": null,
  "name": "data from companies",
  "script": "frappe.ui.form.on('Proforma Invoice', {\r\n    refresh: function(frm) {\r\n        \r\n        \r\n        \r\n//frm.fields_dict.vat_registration_no.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.taxno.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.fax.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.data1.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.data2.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.data3.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.data4.$input.css(\"text-align\", \"right\");\r\n\r\n  frm.fields_dict.back.$input.addClass('btn-primary');\r\n        var invoiceTo = frm.doc.invoice_to;\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Company-Details',\r\n                filters: {\r\n                    name1: invoiceTo\r\n                },\r\n                fields: ['director_1', 'telephone', 'fax','taxno', 'establisheddate', 'vat_reg_no', 'contact_person','physical_address','location'],\r\n                limit: 1\r\n            },\r\n            callback: function(response) {\r\n                if (response && response.message && response.message.length > 0) {\r\n                    var companyData = response.message[0];\r\n\r\n                    // Set values only if a matching record is found\r\n                    frm.set_value('name1', companyData.director_1);\r\n                    frm.set_value('telephone', companyData.telephone);\r\n                    frm.set_value('fax', companyData.fax);\r\n                    frm.set_value('taxno', companyData.taxno);\r\n                    frm.set_value('date', companyData.establisheddate);\r\n                    frm.set_value('vat_registration_no', companyData.vat_reg_no);\r\n                    frm.set_value('reference', companyData.contact_person);\r\n                    frm.set_value('address', companyData.physical_address);\r\n                    frm.set_value('city', companyData.location);\r\n                } else {\r\n                    // Reset values if no matching record is found\r\n                    frm.set_value('name1', '');\r\n                    frm.set_value('telephone', '');\r\n                    frm.set_value('fax', '');\r\n                    frm.set_value('taxno', '');\r\n                    frm.set_value('date', '');\r\n                    frm.set_value('vat_registration_no', '');\r\n                    frm.set_value('reference', '');\r\n                    frm.set_value('address', '');\r\n                    frm.set_value('city', '');\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error('Error fetching data:', err);\r\n                frappe.msgprint('An error occurred while fetching data from Company Details.');\r\n            }\r\n        });\r\n    },\r\n    \r\n      back : function(frm) {\r\n        const policy_number = frm.doc.policy_number;\r\n        const quotation_numbers = frm.doc.quotation_numbers;\r\n\r\n        if (!policy_number || !quotation_numbers) {\r\n            frappe.msgprint('policy or Quotation Number missing.');\r\n            return;\r\n        }\r\n\r\n        frappe.db.get_list('Policy Approvals', {\r\n            filters: { policy_number, quotation_numbers },\r\n            fields: ['name'],\r\n            limit_page_length: 1\r\n        }).then(result => {\r\n            if (result.length > 0) {\r\n                frappe.set_route('Form', 'Policy Approvals', result[0].name);\r\n            } else {\r\n                frappe.msgprint('No policy found for this');\r\n            }\r\n        }).catch(err => {\r\n            console.error('Error fetching policy:', err);\r\n            frappe.msgprint('Error fetching. See console.');\r\n        });\r\n    }\r\n\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Schedule Letter",
  "enabled": 1,
  "modified": "2025-10-29 12:15:18.241879",
  "module": null,
  "name": "Fetch Values to Child Table",
  "script": "frappe.ui.form.on('Schedule Letter', {\r\n    onload: function(frm) {\r\n        // Disable row addition in dci_child table\r\n        frm.set_df_property('dci_child', 'cannot_add_rows', true);\r\n\r\n        // Disable delete button in respective_bond_details grid\r\n        $(frm.fields_dict['dci_child'].grid.wrapper).find('.btn-grid-delete-row').prop('disabled', true);\r\n\r\n        // Apply CSS to hide the Edit button\r\n        var css = `\r\n            .btn-open-row {\r\n                display: none !important;\r\n            }\r\n        `;\r\n        $('<style>' + css + '</style>').appendTo('head');\r\n    },\r\n    refresh: function(frm) {\r\n        \r\n        \r\n        var proposalNumber = frm.doc.proposal_no;\r\n      // Fetch data from Policy Approvals based on Proposal number\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Policy Approvals',\r\n                filters: {\r\n                    proposal_no: proposalNumber\r\n                },\r\n                fields: ['policy_holder', 'policy_number', 'quotation_numbers'],\r\n                 limit: 1\r\n            },\r\n            callback: function(response) {\r\n                if (response && response.message && response.message.length > 0) {\r\n                    var policyApprovalData = response.message[0];\r\n                    frm.set_value('name_of_insured', policyApprovalData.policy_holder);\r\n                    frm.set_value('policy_no', policyApprovalData.policy_number);\r\n                    frm.set_value('quotation_no', policyApprovalData.quotation_numbers);\r\n                } else {\r\n                    frappe.msgprint('No matching record found in Policy Approvals.');\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error('Error fetching data from Policy Approvals:', err);\r\n                frappe.msgprint('An error occurred while fetching data from Policy Approvals.');\r\n            }\r\n        });\r\n      // Fetch data from DCI Quotations based on Proposal number\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'DCI Quotation',\r\n                filters: {\r\n                    proposal_no1: proposalNumber,\r\n                    client_name: frm.doc.name_of_insured\r\n                },\r\n                fields: ['inception_date','goods_services','limit_of_discretion', 'insured_turnover', 'franchise_loss', 'min_annual_premium', 'premium_rate',\r\n                         'fee_for_cl_per_month', 'fee_per_enquiry', 'maximum_liability', 'loss_ratio','premium_rate'], \r\n                limit: 1\r\n            },\r\n            callback: function(response) {\r\n                if (response && response.message && response.message.length > 0) {\r\n                    var inceptionDate = response.message[0].inception_date;\r\n                    var GoodsServices = response.message[0].goods_services;\r\n                    var limitdiscretion = response.message[0].limit_of_discretion;\r\n                    var insuredCommercial = response.message[0].insured_turnover;\r\n                    var franchiseLoss = response.message[0].franchise_loss;\r\n                    var minPremium = response.message[0].min_annual_premium;\r\n                    var premiumRate = response.message[0].premium_rate;\r\n                    var clPerMonth = response.message[0].fee_for_cl_per_month;\r\n                    var clPerEnquiry = response.message[0].fee_per_enquiry;\r\n                    var maxLiability = response.message[0].maximum_liability;\r\n                    var lossRatio = response.message[0].loss_ratio;\r\n                    var premium_rate = response.message[0].premium_rate;\r\n\r\n                    // Function to populate child table\r\n                    function populateChildTable() {\r\n                        // Clear existing rows in the child table\r\n                        frm.clear_table('dci_child');\r\n\r\n                        // Add rows to the child table\r\n                        var row1 = frappe.model.add_child(frm.doc, 'DCI Child Schedule Letter', 'dci_child');\r\n                        row1.section = '1';\r\n                        row1.policy = 'Definition 14';\r\n                        row1.reference = 'Inception Date: ' + inceptionDate;\r\n\r\nvar row2 = frappe.model.add_child(frm.doc, 'DCI Child Schedule Letter', 'dci_child');\r\nrow2.section = '2';\r\nrow2.policy = 'Definition 15';\r\nrow2.reference = 'Goods/Services: ' + \"   \"+ GoodsServices;\r\n\r\n\r\n                        var row3 = frappe.model.add_child(frm.doc, 'DCI Child Schedule Letter', 'dci_child');\r\n                        row3.section = '3';\r\n                        row3.policy = 'Definition 8';\r\n                        row3.reference = 'Insured percentages: ' + insuredCommercial;\r\n\r\n                        var row4 = frappe.model.add_child(frm.doc, 'DCI Child Schedule Letter', 'dci_child');\r\n                        row4.section = '4';\r\n                        row4.policy = 'Proviso 8B';\r\n                        row4.reference = 'Limit of Discretion: ' + limitdiscretion;\r\n\r\n                        var row5 = frappe.model.add_child(frm.doc, 'DCI Child Schedule Letter', 'dci_child');\r\n                        row5.section = '5';\r\n                        row5.policy = 'Definition';\r\n                        row5.reference = 'Franchise Loss: ' + franchiseLoss;\r\n\r\n                        var row6 = frappe.model.add_child(frm.doc, 'DCI Child Schedule Letter', 'dci_child');\r\n                        row6.section = '6(a)';\r\n                        row6.policy = 'Proviso 13A';\r\n                        row6.reference = 'Minimum Premium: P' + minPremium;\r\n\r\n\r\n                        var row7 = frappe.model.add_child(frm.doc, 'DCI Child Schedule Letter', 'dci_child');\r\n                        row7.section = '6(b)';\r\n                        row7.policy = 'Proviso 13B';\r\n                        row7.reference = 'Premium Rate (exclusive of VAT): ' + premiumRate;\r\n\r\n                        var row8 = frappe.model.add_child(frm.doc, 'DCI Child Schedule Letter', 'dci_child');\r\n                        row8.section = '6(c)';\r\n                        row8.policy = 'Proviso 13C';\r\n                        row8.reference = 'cl_per_monthp (P per CL): ' + clPerMonth + ', per_enquiryp (P per CL): ' + clPerEnquiry;\r\n\r\n                        var row9 = frappe.model.add_child(frm.doc, 'DCI Child Schedule Letter', 'dci_child');\r\n                        row9.section = '7';\r\n                        row9.policy = 'Definition 12';\r\n                        row9.reference = 'Maximum Liability: P' + maxLiability;\r\n\r\n                        var row10 = frappe.model.add_child(frm.doc, 'DCI Child Schedule Letter', 'dci_child');\r\n                        row10.section = '8';\r\n                        row10.policy = 'Definition 10';\r\n                        row10.reference = 'First Loss Limit: P' + lossRatio;\r\n                        \r\n                        var row11 = frappe.model.add_child(frm.doc, 'DCI Child Schedule Letter', 'dci_child');\r\n                        row11.section = '9(a)';\r\n                        row11.policy = 'Proviso 26';\r\n                        row11.reference = 'Premium rate and Credit Limit fees are exclusive of VAT: ' + '';\r\n\r\n                        // Refresh the child table\r\n                        frm.refresh_field('dci_child');\r\n                    }\r\n\r\n                    // Call the function to populate child table\r\n                    populateChildTable();\r\n                } else {\r\n                    frappe.msgprint('No matching record found in DCI Quotation.');\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error('Error fetching data from DCI Quotation:', err);\r\n                frappe.msgprint('An error occurred while fetching data from DCI Quotation.');\r\n            }\r\n        });\r\n        \r\n        \r\n       \r\n\r\n\r\n    }\r\n\r\n\r\n\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Financial Analysis",
  "enabled": 1,
  "modified": "2025-12-04 10:54:32.434746",
  "module": "UnderWriting",
  "name": "Financial analysis calculation",
  "script": "\r\n\r\n\r\nfrappe.ui.form.on('Financial Analysis', {\r\n    refresh(frm) {\r\n        // --- Populate Buyer Dropdown ---\r\nfrappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Buyer',\r\n        fields: ['buyer_name'],\r\n        limit_page_length: 0\r\n    },\r\n    callback(response) {\r\n        const buyers = response.message || [];\r\n        const unique = [...new Set(buyers.map(b => b.buyer_name))];\r\n        frm.set_df_property('buyer', 'options', unique);\r\n    }\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n    },\r\n\r\n    calculate(frm) {\r\n        calculateAll(frm);\r\n    }\r\n});\r\n\r\n\r\n// --- Helper Function ---\r\nfunction num(v) {\r\n    return parseFloat(v) || 0;\r\n}\r\n\r\n\r\n// --- Master Calculation Handler ---\r\nfunction calculateAll(frm) {\r\n\r\n    // Step 1: Totals\r\n    frm.set_value(\"tcaly\",  (num(frm.doc.cashlatestyear) + num(frm.doc.arly) + num(frm.doc.mily) + num(frm.doc.pely)).toFixed(2));\r\n    frm.set_value(\"tcaly2\", (num(frm.doc.cashlatestyear1) + num(frm.doc.arly1) + num(frm.doc.mily2) + num(frm.doc.pely2)).toFixed(2));\r\n    frm.set_value(\"tcaly3\", (num(frm.doc.cashlatestyear2) + num(frm.doc.arly3) + num(frm.doc.mily3) + num(frm.doc.pely3)).toFixed(2));\r\n\r\n    frm.set_value(\"taly\",  (num(frm.doc.tcaly) + num(frm.doc.faely)).toFixed(2));\r\n    frm.set_value(\"taly2\", (num(frm.doc.tcaly2) + num(frm.doc.faely2)).toFixed(2));\r\n    frm.set_value(\"taly3\", (num(frm.doc.tcaly3) + num(frm.doc.faely3)).toFixed(2));\r\n\r\n    // --- GM & Nifty Calculations ---\r\n    calculateGM(frm, \"latest_year\", \"cogsly\", \"gmly\");\r\n    calculateGM(frm, \"latest_year_1\", \"cogsly1\", \"gmly1\");\r\n    calculateGM(frm, \"latest_year_3\", \"cogsly2\", \"gmly2\");\r\n\r\n    calculateNifty(frm, \"gmly\",  \"ely\",  \"niftyly\");\r\n    calculateNifty(frm, \"gmly1\", \"ely1\", \"niftyly1\");\r\n    calculateNifty(frm, \"gmly2\", \"ely2\", \"niftyly2\");\r\n\r\n    // --- Current Liabilities Totals ---\r\n    frm.set_value('tclly',  (num(frm.doc.acply) + num(frm.doc.nply) + num(frm.doc.aely)).toFixed(2));\r\n    frm.set_value('tclly2', (num(frm.doc.acply2) + num(frm.doc.nply2) + num(frm.doc.aely2)).toFixed(2));\r\n    frm.set_value('tclly3', (num(frm.doc.acply3) + num(frm.doc.nply3) + num(frm.doc.aely3)).toFixed(2));\r\n\r\n    frm.set_value('tlly',  (num(frm.doc.tclly) + num(frm.doc.ltlly)).toFixed(2));\r\n    frm.set_value('tlly2', (num(frm.doc.tclly2) + num(frm.doc.ltlly2)).toFixed(2));\r\n    frm.set_value('tlly3', (num(frm.doc.tclly3) + num(frm.doc.ltlly3)).toFixed(2));\r\n\r\n    // --- Incremental Totals ---\r\n    calculateIncremental(frm, 1);\r\n    calculateIncremental(frm, 2);\r\n    calculateIncremental(frm, 3);\r\n\r\n    // --- Ratios ---\r\n    calculateRatios(frm);\r\n    calculateAllRatios(frm);\r\n    \r\n         // --- Return on Assets (ROA) ---\r\n    calculateniftylyRatio11(frm);\r\n    calculateniftylyRatio22(frm);\r\n    calculateniftylyRatio33(frm);\r\n   \r\n\r\n    // --- Accounts Receivable Turnover ---\r\n    calculateARLYRatio10(frm);\r\n    calculateARLYRatio20(frm);\r\n    calculateARLYRatio30(frm);\r\n\r\n    // --- Debt to Equity Ratio ---\r\n    calculateCOELYRatio10(frm);\r\n    calculateCOELYRatio20(frm);\r\n    calculateCOELYRatio30(frm);\r\n    \r\n     \r\n    // --- Return on Capital Employed (ROCE) ---\r\n    calculateWCRatio1(frm);\r\n    calculateWCRatio2(frm);\r\n    calculateWCRatio3(frm);\r\n     \r\n     \r\n      // --- Ratio Field Comparisons (NEW) ---\r\n    const ratioFields = [\r\n        [\"cashlatestyear\", \"cashlatestyear1\", \"cashlatestyear3\"],\r\n        [\"cashlatestyear1\", \"cashlatestyear2\", \"cashlatestyear4\"],\r\n        [\"arly\", \"arly1\", \"arly4\"],\r\n        [\"arly1\", \"arly3\", \"arly5\"],\r\n        [\"mily\", \"mily2\", \"mily4\"],\r\n        [\"mily2\", \"mily3\", \"mily5\"],\r\n        [\"pely\", \"pely2\", \"pely4\"],\r\n        [\"pely2\", \"pely3\", \"pely5\"],\r\n        [\"tcaly\", \"tcaly2\", \"tcaly4\"],\r\n        [\"tcaly2\", \"tcaly3\", \"tcaly5\"],\r\n        [\"faely\", \"faely2\", \"faely4\"],\r\n        [\"faely2\", \"faely3\", \"faely5\"],\r\n        [\"taly\", \"taly2\", \"taly4\"],\r\n        [\"taly2\", \"taly3\", \"taly5\"]\r\n    ];\r\n    ratioFields.forEach(f => calculateRatio(frm, f[0], f[1], f[2]));\r\n\r\n    // --- \"3\" Ratio Functions ---\r\n    calculateRatioSet3(frm);\r\n    \r\n    // --- NEW ADDITIONS (from your requirement) ---\r\n    calculateACPLYRatio1(frm);\r\n    calculateACPLYRatio2(frm);\r\n    calculateNPLYRatio1(frm);\r\n    calculateNPLYRatio2(frm);\r\n    calculateAELYRatio1(frm);\r\n    calculateAELYRatio2(frm);\r\n    calculateTCLLYRatio1(frm);\r\n    calculateTCLLYRatio2(frm);\r\n    calculateLTLLYRatio1(frm);\r\n    calculateLTLLYRatio2(frm);\r\n    calculateTLLYRatio1(frm);\r\n    calculateTLLYRatio2(frm);\r\n    calculateCOELYRatio1(frm);\r\n    calculateCOELYRatio2(frm);\r\n    calculateTLACOELYRatio1(frm);\r\n    calculateTLACOELYRatio2(frm);\r\n    \r\n    \r\n    \t// --- \u2705 NEW FUNCTIONS YOU REQUESTED ---\r\n     calculateNetRatioh11(frm);\r\n     calculateNetRatioh22(frm);\r\n     calculateNetRatioh33(frm);\r\n     \r\n     calculatecogslyRatioh1(frm);\r\n     calculatecogslyRatioh2(frm);\r\n     calculatecogslyRatioh3(frm);\r\n\r\n     calculateNetRatioh1(frm);\r\n     calculateNetRatioh2(frm);\r\n     calculateNetRatioh3(frm);\r\n\r\n     calculateelyRatio11(frm);\r\n     calculateelyRatio22(frm);\r\n     calculateelyRatio33(frm);\r\n\r\n     calculateniftylyRatioh1(frm);\r\n     calculateniftylyRatioh2(frm);\r\n     calculateniftylyRatioh3(frm);\r\n     \r\n     calculateTCALYRatio10;\r\n     calculateTCALYRatio20;\r\n     calculateTCALYRatio30;\r\n     \r\n    \r\n   \r\n\t\r\n\t\r\n\r\n\r\n    frappe.show_alert({ message: \"\u2705 All totals and ratios calculated!\", indicator: \"green\" });\r\n    frm.refresh_fields();\r\n}\r\n\r\n\r\n\r\n\r\n\r\n// --- Gross Margin & Nifty ---\r\nfunction calculateGM(frm, salesField, cogsField, targetField) {\r\n    frm.set_value(targetField, (num(frm.doc[salesField]) - num(frm.doc[cogsField])).toFixed(2));\r\n}\r\nfunction calculateNifty(frm, gmField, expField, targetField) {\r\n    frm.set_value(targetField, (num(frm.doc[gmField]) - num(frm.doc[expField])).toFixed(2));\r\n}\r\n\r\n\r\n// --- Incremental ---\r\nfunction calculateIncremental(frm, version) {\r\n    const tcllyField = version === 1 ? 'tclly' : `tclly${version}`;\r\n    const ltllyField = version === 1 ? 'ltlly' : `ltlly${version}`;\r\n    const targetField = version === 1 ? 'tlacoely' : `tlacoely${version}`;\r\n    frm.set_value(targetField, (num(frm.doc[tcllyField]) + num(frm.doc[ltllyField])).toFixed(2));\r\n}\r\n\r\n\r\n\r\n\r\n// --- Ratio Calculations ---\r\nfunction calculateRatios(frm) {\r\n\r\n    // --- Current Ratio ---\r\n    // \u2705 Correct formula\r\nfrm.set_value('currentratio',  ratio(num(frm.doc.tcaly),  num(frm.doc.tclly)));\r\nfrm.set_value('currentratio1', ratio(num(frm.doc.tcaly2), num(frm.doc.tclly2)));\r\nfrm.set_value('currentratio2', ratio(num(frm.doc.tcaly3), num(frm.doc.tclly3)));\r\n\r\n\r\nfrm.set_value('quickratio',  ratio(num(frm.doc.taly),  num(frm.doc.tclly)));\r\nfrm.set_value('quickratio1', ratio(num(frm.doc.taly2), num(frm.doc.tclly2)));\r\nfrm.set_value('quickratio2', ratio(num(frm.doc.taly3), num(frm.doc.tclly3)));\r\n\r\n\r\n\r\n\r\n\r\n    // --- Days Sales Outstanding ---\r\n    frm.set_value('dayssalesoutstanding',  dsor(num(frm.doc.mily)));\r\n    frm.set_value('dayssalesoutstanding1', dsor(num(frm.doc.mily2)));\r\n    frm.set_value('dayssalesoutstanding2', dsor(num(frm.doc.mily3)));\r\n\r\n    // --- Inventory Turnover ---\r\n    frm.set_value('inventoryturnover',  ratio(num(frm.doc.cogsly),  num(frm.doc.mily)));\r\n    frm.set_value('inventoryturnover1', ratio(num(frm.doc.cogsly1), num(frm.doc.mily2)));\r\n    frm.set_value('inventoryturnover2', ratio(num(frm.doc.cogsly2), num(frm.doc.mily3)));\r\n\r\n    // --- Account Payable to Sales ---\r\n    frm.set_value('accountpayabletosales',  ratio(num(frm.doc.cogsly),  num(frm.doc.acply)));\r\n    frm.set_value('accountpayabletosales1', ratio(num(frm.doc.cogsly1), num(frm.doc.acply2)));\r\n    frm.set_value('accountpayabletosales2', ratio(num(frm.doc.cogsly2), num(frm.doc.acply3)));\r\n\r\n    // --- Return on Sales ---\r\n    frm.set_value('returnonsales',  percent(num(frm.doc.niftyly),  num(frm.doc.latest_year)));\r\n    frm.set_value('returnonsales1', percent(num(frm.doc.niftyly1), num(frm.doc.latest_year_1)));\r\n    frm.set_value('returnonsales2', percent(num(frm.doc.niftyly2), num(frm.doc.latest_year_3)));\r\n\r\n    // --- Working Capital ---\r\n    frm.set_value('workingcaptial',  (num(frm.doc.tcaly)  - num(frm.doc.tclly)).toFixed(2));\r\n    frm.set_value('workingcaptial1', (num(frm.doc.tcaly2) - num(frm.doc.tclly2)).toFixed(2));\r\n    frm.set_value('workingcaptial2', (num(frm.doc.tcaly3) - num(frm.doc.tclly3)).toFixed(2));\r\n\r\n    // --- Net Worth ---\r\n    frm.set_value('networth',  (num(frm.doc.taly)  - num(frm.doc.tlly)).toFixed(2));\r\n    frm.set_value('networth1', (num(frm.doc.taly2) - num(frm.doc.tlly2)).toFixed(2));\r\n    frm.set_value('networth2', (num(frm.doc.taly3) - num(frm.doc.tlly3)).toFixed(2));\r\n\r\n    // --- Gross Profit Margin ---\r\n    frm.set_value('grossprofitmargin',  percent(num(frm.doc.latest_year),  num(frm.doc.niftyly)));\r\n    frm.set_value('grossprofitmargin1', percent(num(frm.doc.latest_year_1), num(frm.doc.niftyly1)));\r\n    frm.set_value('grossprofitmargin2', percent(num(frm.doc.latest_year_3), num(frm.doc.niftyly2)));\r\n}\r\n\r\n// --- Ratio Calculator for Ratio Fields ---\r\nfunction calculateRatio(frm, field1, field2, target) {\r\n    const v1 = num(frm.doc[field1]);\r\n    const v2 = num(frm.doc[field2]);\r\n    frm.set_value(target, v2 === 0 ? '' : ((v1 / v2) * 100).toFixed(2));\r\n}\r\n\r\n// --- All Ratios (Percentage view of main line items) ---\r\nfunction calculateAllRatios(frm) {\r\n    const n = v => parseFloat(v) || 0;\r\n\r\n    // Net Ratios\r\n    frm.set_value(\r\n        'latest_year_4', \r\n        n(frm.doc.latest_year) && n(frm.doc.latest_year_1) !== 0\r\n        ? ((n(frm.doc.latest_year)/n(frm.doc.latest_year_1))*100).toFixed(2)\r\n        : 0\r\n        );\r\n    frm.set_value(\r\n        'latest_year_5', \r\n        n(frm.doc.latest_year_1) && n(frm.doc.latest_year_3) !== 0\r\n        ? ((n(frm.doc.latest_year_1)/n(frm.doc.latest_year_3))*100).toFixed(2) \r\n        : 0\r\n        );\r\n    frm.set_value(\r\n        'latest_year_6', \r\n        n(frm.doc.latest_year_3) && n(frm.doc.latest_year_3) !== 0\r\n        ? ((n(frm.doc.latest_year_3)/n(frm.doc.latest_year_3))*100).toFixed(2) \r\n        : 0 \r\n        );\r\n\r\n    // COGS Ratios\r\n    \r\n    frm.set_value(\r\n        'cogsly3', \r\n        n(frm.doc.cogsly) && n(frm.doc.cogsly1) !== 0\r\n        ? ((n(frm.doc.cogsly)/n(frm.doc.cogsly1))*100).toFixed(2)  \r\n        : 0\r\n        );\r\n    frm.set_value(\r\n        'cogsly4', \r\n        n(frm.doc.cogsly1) && n(frm.doc.cogsly2) !== 0\r\n        ? ((n(frm.doc.cogsly1)/n(frm.doc.cogsly2))*100).toFixed(2)\r\n        : 0\r\n        );\r\n    frm.set_value(\r\n        'cogsly5', \r\n        n(frm.doc.cogsly2) && n(frm.doc.cogsly2) !== 0\r\n        ? ((n(frm.doc.cogsly2)/n(frm.doc.cogsly2))*100).toFixed(2)\r\n        : 0\r\n        );\r\n\r\n    // GM Ratios\r\nfrm.set_value(\r\n    'gmly3',\r\n    n(frm.doc.latest_year) && n(frm.doc.gmly1) !== 0\r\n        ? ((n(frm.doc.gmly) / n(frm.doc.gmly1)) * 100).toFixed(2)\r\n        : 0\r\n);\r\n\r\nfrm.set_value(\r\n    'gmly4',\r\n    n(frm.doc.latest_year_1) && n(frm.doc.gmly2) !== 0\r\n        ? ((n(frm.doc.gmly1) / n(frm.doc.gmly2)) * 100).toFixed(2)\r\n        : 0\r\n);\r\n\r\nfrm.set_value(\r\n    'gmly5',\r\n    n(frm.doc.latest_year_3) && n(frm.doc.gmly2) !== 0\r\n        ? ((n(frm.doc.gmly2) / n(frm.doc.gmly2)) * 100).toFixed(2)\r\n        : 0\r\n);\r\n\r\n\r\n    // Ely Ratios\r\n    frm.set_value(\r\n        'ely3',  \r\n       n(frm.doc.ely) && n(frm.doc.ely1) !== 0 \r\n        ? ((n(frm.doc.ely)/n(frm.doc.ely1))*100).toFixed(2) \r\n        : 0\r\n        );\r\n    frm.set_value(\r\n        'ely4', \r\n        n(frm.doc.ely1) && n(frm.doc.ely2) !== 0\r\n        ? ((n(frm.doc.ely1)/n(frm.doc.ely2))*100).toFixed(2)\r\n        : 0\r\n        );\r\n    frm.set_value(\r\n        'ely5',\r\n       n(frm.doc.ely2) && n(frm.doc.ely2) !== 0\r\n        ? ((n(frm.doc.ely2)/n(frm.doc.ely2))*100).toFixed(2)\r\n        : 0\r\n        );\r\n\r\n    // Nifty Ratios\r\n    frm.set_value(\r\n        'niftyly3', \r\n        n(frm.doc.niftyly) && n(frm.doc.niftyly1) !== 0 \r\n        ? ((n(frm.doc.niftyly)/n(frm.doc.niftyly1))*100).toFixed(2) \r\n        : 0\r\n        );\r\n    frm.set_value(\r\n        'niftyly4', \r\n         n(frm.doc.niftyly1) && n(frm.doc.niftyly2) !== 0 \r\n        ? ((n(frm.doc.niftyly1)/n(frm.doc.niftyly2))*100).toFixed(2)\r\n        : 0\r\n        );\r\n    frm.set_value(\r\n        'niftyly5', \r\n        n(frm.doc.niftyly2) && n(frm.doc.niftyly2) !== 0 \r\n        ? ((n(frm.doc.niftyly2)/n(frm.doc.niftyly2))*100).toFixed(2)\r\n        : 0\r\n        );\r\n}\r\n\r\nfunction calculateACPLYRatio1(frm){calcRatio(frm,'acply','acply2','acply4');}\r\nfunction calculateACPLYRatio2(frm){calcRatio(frm,'acply2','acply3','acply5');}\r\nfunction calculateNPLYRatio1(frm){calcRatio(frm,'nply','nply2','nply4');}\r\nfunction calculateNPLYRatio2(frm){calcRatio(frm,'nply2','nply3','nply5');}\r\nfunction calculateAELYRatio1(frm){calcRatio(frm,'aely','aely2','aely4');}\r\nfunction calculateAELYRatio2(frm){calcRatio(frm,'aely2','aely3','aely5');}\r\nfunction calculateTCLLYRatio1(frm){calcRatio(frm,'tclly','tclly2','tclly4');}\r\nfunction calculateTCLLYRatio2(frm){calcRatio(frm,'tclly2','tclly3','tclly5');}\r\nfunction calculateLTLLYRatio1(frm){calcRatio(frm,'ltlly','ltlly2','ltlly4');}\r\nfunction calculateLTLLYRatio2(frm){calcRatio(frm,'ltlly2','ltlly3','ltlly5');}\r\nfunction calculateTLLYRatio1(frm){calcRatio(frm,'tlly','tlly2','tlly4');}\r\nfunction calculateTLLYRatio2(frm){calcRatio(frm,'tlly2','tlly3','tlly5');}\r\nfunction calculateCOELYRatio1(frm){calcRatio(frm,'coely','coely2','coely4');}\r\nfunction calculateCOELYRatio2(frm){calcRatio(frm,'coely2','coely3','coely5');}\r\nfunction calculateTLACOELYRatio1(frm){calcRatio(frm,'tlacoely','tlacoely2','tlacoely4');}\r\nfunction calculateTLACOELYRatio2(frm){calcRatio(frm,'tlacoely2','tlacoely3','tlacoely5');}\r\n\r\nfunction calcRatio(frm, f1, f2, target){\r\n    var v1 = parseFloat(frm.doc[f1]) || 0;\r\n    var v2 = parseFloat(frm.doc[f2]) || 0;\r\n    if (v2 === 0) frm.set_value(target, '');\r\n    else frm.set_value(target, ((v1 / v2) * 100).toFixed(2));\r\n}\r\n\r\n\r\n// --- Helper Ratio Functions ---\r\nfunction ratio(a, b) { return b === 0 ? '' : (a / b).toFixed(2); }\r\nfunction percent(a, b) { return b === 0 ? '' : ((a / b) * 100).toFixed(2); }\r\nfunction dsor(a) { return a === 0 ? '' : (365 / a).toFixed(2); }\r\n\r\n\r\n\r\n\r\n// Return on Assets\r\nfunction calculateniftylyRatio11(frm) {\r\n    var niftyly = parseFloat(frm.doc.niftyly) || 0;\r\n    var taly = parseFloat(frm.doc.taly) || 0;\r\n\r\n    if (taly === 0 || niftyly === 0) {\r\n        frm.set_value('returnonassets', 0);\r\n    } else {\r\n        var ratio = niftyly / taly;\r\n        frm.set_value('returnonassets', ratio.toFixed(2));\r\n        frm.set_df_property('returnonassets', 'read_only', 1);\r\n    }\r\n}\r\n\r\n// Return on Assets\r\nfunction calculateniftylyRatio22(frm) {\r\n    var niftyly1 = parseFloat(frm.doc.niftyly1) || 0;\r\n    var taly2 = parseFloat(frm.doc.taly2) || 0;\r\n\r\n    if (taly2 === 0 || niftyly1 === 0) {\r\n        frm.set_value('returnonassets1', 0);\r\n    } else {\r\n        var ratio = niftyly1 / taly2;\r\n        frm.set_value('returnonassets1', ratio.toFixed(2));\r\n        frm.set_df_property('returnonassets1', 'read_only', 1);\r\n    }\r\n}\r\n\r\nfunction calculateniftylyRatio33(frm) {\r\n    var niftyly2 = parseFloat(frm.doc.niftyly2) || 0;\r\n    var taly3 = parseFloat(frm.doc.taly3) || 0;\r\n\r\n    if (taly3 === 0 || niftyly2 === 0) {\r\n        frm.set_value('returnonassets2', 0);\r\n    } else {\r\n        var ratio = niftyly2 / taly3;\r\n        frm.set_value('returnonassets2', ratio.toFixed(2));\r\n        frm.set_df_property('returnonassets2', 'read_only', 1);\r\n    }\r\n}\r\n\r\n\r\n// --- ACCOUNTS RECEIVABLE TURNOVER RATIO ---\r\nfunction calculateARLYRatio10(frm) {\r\n    var arly = parseFloat(frm.doc.arly) || 0;\r\n    var latest_year = parseFloat(frm.doc.latest_year) || 0;\r\n\r\n    if (arly === 0 || latest_year === 0) {\r\n        frm.set_value('accountreceivaleturnover', 0);\r\n    } else {\r\n        var ratio = (latest_year / arly);\r\n        frm.set_value('accountreceivaleturnover', ratio.toFixed(2));\r\n    frm.set_df_property('accountreceivaleturnover', 'read_only', 1);\r\n  }\r\n}\r\n\r\nfunction calculateARLYRatio20(frm) {\r\n    var arly1 = parseFloat(frm.doc.arly1) || 0;\r\n    var latest_year = parseFloat(frm.doc.latest_year) || 0;\r\n\r\n    if (arly1 === 0 || latest_year === 0) {\r\n        frm.set_value('accountreceivaleturnover1', 0);\r\n    } else {\r\n        var ratio = (latest_year / arly1);\r\n        frm.set_value('accountreceivaleturnover1', ratio.toFixed(2));\r\n    }\r\n    frm.set_df_property('accountreceivaleturnover1', 'read_only', 1);\r\n}\r\n\r\nfunction calculateARLYRatio30(frm) {\r\n    var arly3 = parseFloat(frm.doc.arly3) || 0;\r\n    var latest_year = parseFloat(frm.doc.latest_year) || 0;\r\n\r\n    if (arly3 === 0 || latest_year === 0) {\r\n        frm.set_value('accountreceivaleturnover2', 0);\r\n    } else {\r\n        var ratio = (latest_year / arly3);\r\n        frm.set_value('accountreceivaleturnover2', ratio.toFixed(2));\r\n    }\r\n    frm.set_df_property('accountreceivaleturnover2', 'read_only', 1);\r\n}\r\n\r\n// ============================================================\r\n// --- DEBT-TO-EQUITY RATIO ---\r\nfunction calculateCOELYRatio10(frm) {\r\n    var tclly = parseFloat(frm.doc.tclly) || 0;\r\n    var coely = parseFloat(frm.doc.coely) || 0;\r\n\r\n    if (coely === 0 || tclly === 0) {\r\n        frm.set_value('debttoquityratio', 0);\r\n    } else {\r\n        var ratio = tclly / coely;\r\n        frm.set_value('debttoquityratio', ratio.toFixed(2));\r\n        frm.set_df_property('debttoquityratio', 'read_only', 1);\r\n    }\r\n}\r\n\r\nfunction calculateCOELYRatio20(frm) {\r\n    var tclly2 = parseFloat(frm.doc.tclly2) || 0;\r\n    var coely2 = parseFloat(frm.doc.coely2) || 0;\r\n\r\n    if (coely2 === 0 || tclly2 === 0) {\r\n        frm.set_value('debttoequityratio1', 0);\r\n    } else {\r\n        var ratio = tclly2 / coely2;\r\n        frm.set_value('debttoequityratio1', ratio.toFixed(2));\r\n        frm.set_df_property('debttoequityratio1', 'read_only', 1);\r\n    }\r\n}\r\n\r\nfunction calculateCOELYRatio30(frm) {\r\n    var tclly3 = parseFloat(frm.doc.tclly3) || 0;\r\n    var coely3 = parseFloat(frm.doc.coely3) || 0;\r\n\r\n    if (coely3 === 0 || tclly3 === 0) {\r\n        frm.set_value('debttoequityratio2', 0);\r\n    } else {\r\n        var ratio = tclly3 / coely3;\r\n        frm.set_value('debttoequityratio2', ratio.toFixed(2));\r\n        frm.set_df_property('debttoequityratio2', 'read_only', 1);\r\n    }\r\n}\r\n\r\n// ============================================================\r\n// --- WORKING CAPITAL (RETURN ON CAPITAL EMPLOYED) ---\r\nfunction calculateWCRatio1(frm) {\r\n    var niftyly = parseFloat(frm.doc.niftyly) || 0;\r\n    var workingcaptial = parseFloat(frm.doc.workingcaptial) || 0;\r\n\r\n    if (workingcaptial === 0 || niftyly === 0) {\r\n        frm.set_value('returnoncaptialequity', 0);\r\n    } else {\r\n        var ratio = niftyly / workingcaptial;\r\n        frm.set_value('returnoncaptialequity', ratio.toFixed(2));\r\n    }\r\n    frm.set_df_property('returnoncaptialequity', 'read_only', 1);\r\n}\r\n\r\nfunction calculateWCRatio2(frm) {\r\n    var niftyly1 = parseFloat(frm.doc.niftyly1) || 0;\r\n    var workingcaptial1 = parseFloat(frm.doc.workingcaptial1) || 0;\r\n\r\n    if (workingcaptial1 === 0 || niftyly1 === 0) {\r\n        frm.set_value('returnoncaptialequity1', 0);\r\n    } else {\r\n        var ratio = niftyly1 / workingcaptial1;\r\n        frm.set_value('returnoncaptialequity1', ratio.toFixed(2));\r\n    }\r\n    frm.set_df_property('returnoncaptialequity1', 'read_only', 1);\r\n}\r\n\r\nfunction calculateWCRatio3(frm) {\r\n    var niftyly2 = parseFloat(frm.doc.niftyly2) || 0;\r\n    var workingcaptial2 = parseFloat(frm.doc.workingcaptial2) || 0;\r\n\r\n    if (workingcaptial2 === 0 || niftyly2 === 0) {\r\n        frm.set_value('returnoncaptialequity2', 0);\r\n    } else {\r\n        var ratio = niftyly2 / workingcaptial2;\r\n        frm.set_value('returnoncaptialequity2', ratio.toFixed(2));\r\n    }\r\n    frm.set_df_property('returnoncaptialequity2', 'read_only', 1);\r\n}\r\n/* ---------------- SALES RATIO FUNCTIONS ---------------- */\r\nfunction calculateNetRatioh11(frm) {\r\n    let current = parseFloat(frm.doc.latest_year) || 0;\r\n    let prev = parseFloat(frm.doc.latest_year_1) || 0;\r\n\r\n    if (current === 0 || prev === 0) {\r\n        frm.set_value('sales', 0);\r\n    } else {\r\n        frm.set_value('sales', (current / prev) .toFixed(2));\r\n    }\r\n    frm.set_df_property('sales', 'read_only', 1);\r\n}\r\n\r\nfunction calculateNetRatioh22(frm) {\r\n    let current = parseFloat(frm.doc.latest_year_1) || 0;\r\n    let prev = parseFloat(frm.doc.latest_year_1) || 0;\r\n\r\n    if (current === 0 || prev === 0) {\r\n        frm.set_value('salesly', 0);\r\n    } else {\r\n        frm.set_value('salesly', ((current / prev) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('salesly', 'read_only', 1);\r\n}\r\n\r\nfunction calculateNetRatioh33(frm) {\r\n    let current = parseFloat(frm.doc.latest_year_3) || 0;\r\n    let base = parseFloat(frm.doc.latest_year_3) || 0;\r\n\r\n    if (current === 0 || base === 0) {\r\n        frm.set_value('salesly2', 0);\r\n    } else {\r\n        frm.set_value('salesly2', ((current / base) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('salesly2', 'read_only', 1);\r\n}\r\n\r\n/* ---------------- COGS RATIO FUNCTIONS ---------------- */\r\nfunction calculatecogslyRatioh1(frm) {\r\n    let cogs = parseFloat(frm.doc.cogsly) || 0;\r\n    let current = parseFloat(frm.doc.latest_year) || 0;\r\n\r\n    if (cogs === 0 || current === 0) {\r\n        frm.set_value('costofgoodssold', 0);\r\n    } else {\r\n        frm.set_value('costofgoodssold', ((cogs / current) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('costofgoodssold', 'read_only', 1);\r\n}\r\n\r\nfunction calculatecogslyRatioh2(frm) {\r\n    let cogs = parseFloat(frm.doc.cogsly1) || 0;\r\n    let current = parseFloat(frm.doc.latest_year_1) || 0;\r\n\r\n    if (cogs === 0 || current === 0) {\r\n        frm.set_value('costofgoodssoldly1', 0);\r\n    } else {\r\n        frm.set_value('costofgoodssoldly1', ((cogs / current) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('costofgoodssoldly1', 'read_only', 1);\r\n}\r\n\r\nfunction calculatecogslyRatioh3(frm) {\r\n    let cogs = parseFloat(frm.doc.cogsly2) || 0;\r\n    let current = parseFloat(frm.doc.latest_year_3) || 0;\r\n\r\n    if (cogs === 0 || current === 0) {\r\n        frm.set_value('costofgoodssoldly2', 0);\r\n    } else {\r\n        frm.set_value('costofgoodssoldly2', ((cogs / current) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('costofgoodssoldly2', 'read_only', 1);\r\n}\r\n\r\n/* ---------------- GROSS MARGIN RATIO FUNCTIONS ---------------- */\r\nfunction calculateNetRatioh1(frm) {\r\n    let gm = parseFloat(frm.doc.gmly) || 0;\r\n    let current = parseFloat(frm.doc.latest_year) || 0;\r\n\r\n    if (gm === 0 || current === 0) {\r\n        frm.set_value('grossmargin', 0);\r\n    } else {\r\n        frm.set_value('grossmargin', ((gm / current) * 100).toFixed(2));\r\n    }\r\n    frm.set_df_property('grossmargin', 'read_only', 1);\r\n}\r\n\r\nfunction calculateNetRatioh2(frm) {\r\n    let gm = parseFloat(frm.doc.gmly1) || 0;\r\n    let current = parseFloat(frm.doc.latest_year_1) || 0;\r\n\r\n   \r\n        frm.set_value(\r\n            'grossmarginly1',\r\n            n(frm.doc.gmly1) && n(frm.doc.latest_year_1) !== 0\r\n            ? ((n(frm.doc.gmly1) / n(frm.doc.latest_year_1)) * 100).toFixed(2)\r\n        : 0 \r\n        );\r\n    \r\n    frm.set_df_property('grossmarginly1', 'read_only', 1);\r\n}\r\n\r\nfunction calculateNetRatioh3(frm) {\r\n    let gm = parseFloat(frm.doc.gmly2) || 0;\r\n    let current = parseFloat(frm.doc.latest_year_3) || 0;\r\n\r\n    \r\n        frm.set_value(\r\n            'grossmarginly2',\r\n            n(frm.doc.gmly2) && n(frm.doc.latest_year_3) !== 0\r\n            ? ((n(frm.doc.gmly2) / n(frm.doc.latest_year_3)) * 100).toFixed(2)\r\n        : 0\r\n        );\r\n    \r\n    frm.set_df_property('grossmarginly2', 'read_only', 1);\r\n}\r\n\r\n/* ---------------- EXPENSES RATIO FUNCTIONS ---------------- */\r\nfunction calculateelyRatio11(frm) {\r\n    let exp = parseFloat(frm.doc.ely) || 0;\r\n    let current = parseFloat(frm.doc.latest_year) || 0;\r\n\r\n    if (exp === 0 || current === 0) {\r\n        frm.set_value('expenses', 0);\r\n    } else {\r\n        frm.set_value('expenses', ((exp / current) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('expenses', 'read_only', 1);\r\n}\r\n\r\nfunction calculateelyRatio22(frm) {\r\n    let exp = parseFloat(frm.doc.ely1) || 0;\r\n    let current = parseFloat(frm.doc.latest_year_1) || 0;\r\n\r\n    if (exp === 0 || current === 0) {\r\n        frm.set_value('expensesly', 0);\r\n    } else {\r\n        frm.set_value('expensesly', ((exp / current) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('expensesly', 'read_only', 1);\r\n}\r\n\r\nfunction calculateelyRatio33(frm) {\r\n    let exp = parseFloat(frm.doc.ely2) || 0;\r\n    let current = parseFloat(frm.doc.latest_year_3) || 0;\r\n\r\n    if (exp === 0 || current === 0) {\r\n        frm.set_value('expensesly2', 0);\r\n    } else {\r\n        frm.set_value('expensesly2', ((exp / current) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('expensesly2', 'read_only', 1);\r\n}\r\n\r\n/* ---------------- NET INCOME RATIO FUNCTIONS ---------------- */\r\nfunction calculateniftylyRatioh1(frm) {\r\n    let ni = parseFloat(frm.doc.niftyly) || 0;\r\n    let current = parseFloat(frm.doc.latest_year) || 0;\r\n\r\n    if (ni === 0 || current === 0) {\r\n        frm.set_value('netincome', 0);\r\n    } else {\r\n        frm.set_value('netincome', ((ni / current) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('netincome', 'read_only', 1);\r\n}\r\n\r\nfunction calculateniftylyRatioh2(frm) {\r\n    let ni = parseFloat(frm.doc.niftyly1) || 0;\r\n    let current = parseFloat(frm.doc.latest_year_1) || 0;\r\n\r\n    if (ni === 0 || current === 0) {\r\n        frm.set_value('netincomely', 0);\r\n    } else {\r\n        frm.set_value('netincomely', ((ni / current) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('netincomely', 'read_only', 1);\r\n}\r\n\r\nfunction calculateniftylyRatioh3(frm) {\r\n    let ni = parseFloat(frm.doc.niftyly2) || 0;\r\n    let current = parseFloat(frm.doc.latest_year_3) || 0;\r\n\r\n    if (ni === 0 || current === 0) {\r\n        frm.set_value('netincomely2', 0);\r\n    } else {\r\n        frm.set_value('netincomely2', ((ni / current) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('netincomely2', 'read_only', 1);\r\n}\r\n\r\n\r\n\r\n\r\n\r\n// --- Ratio Set 3 ---\r\nfunction calculateRatioSet3(frm) {\r\n    const set = [\r\n        ['cashlatestyear5', 'cashlatestyear2'],\r\n        ['arly6', 'arly3'],\r\n        ['mily6', 'mily3'],\r\n        ['pely6', 'pely3'],\r\n        ['tcaly6', 'tcaly3'],\r\n        ['faely6', 'faely3'],\r\n        ['taly6', 'taly3'],\r\n        ['acply6', 'acply3'],\r\n        ['nply6', 'nply3'],\r\n        ['aely6', 'aely3'],\r\n        ['tclly6', 'tclly3'],\r\n        ['ltlly6', 'ltlly3'],\r\n        ['tlly6', 'tlly3'],\r\n        ['coely6', 'coely3'],\r\n        ['tlacoely6', 'tlacoely3']\r\n    ];\r\n\r\n    set.forEach(([target, source]) => {\r\n        frm.set_value(target, num(frm.doc[source]) ? 100 : 0);\r\n    });\r\n}\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Policy Schedule _CIGIS",
  "enabled": 1,
  "modified": "2025-10-24 09:03:32.321549",
  "module": null,
  "name": "details_DCI_ECI",
  "script": "frappe.ui.form.on('Policy Schedule _CIGIS', {\r\n    \r\n     onload: function(frm) {\r\n    frm.set_df_property('child_letter', 'cannot_add_rows', true);\r\n     \r\n     $(frm.fields_dict['child_letter'].grid.wrapper).find('.btn-grid-delete-row').prop('disabled', true);\r\n        // Apply CSS to hide the Edit button\r\n        var css = `\r\n            .btn-open-row {\r\n                display: none !important;\r\n            }\r\n        `;\r\n        $('<style>' + css + '</style>').appendTo('head');\r\n    },\r\n    refresh: function(frm) {\r\n        \r\n    \r\n\r\n        var proposalNumber = frm.doc.proposal_no;\r\n        \r\n        // Check if the proposal number starts with 'ECI'\r\n        if (proposalNumber.startsWith('ECI')) {\r\n            // Fetch data from ECI Quotations based on Proposal number\r\n      frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'ECI Quotations',\r\n                filters: {\r\n                    proposal_no1: proposalNumber\r\n                },\r\n                fields: ['inception_date','goods_services','limit_of_descrition','insured_commercial_risks_for_all_insured_companies',\r\n                'franchise_lossp','min_premium_depositp','total_pre_amt','individual_first_lossp','premium_rate','cl_per_monthp','per_enquiryp','premium_rate'], \r\n                limit: 1\r\n            },\r\n            callback: function(response) {\r\n                if (response && response.message && response.message.length > 0) {\r\n                    var inceptionDate = response.message[0].inception_date;\r\n                    var GoodsServices = response.message[0].goods_services;\r\n                    var limitDescription = response.message[0].limit_of_descrition;\r\n                    var insuredCommerical = response.message[0].insured_commercial_risks_for_all_insured_companies;\r\n                    var franchiseLoss = response.message[0].franchise_lossp;\r\n                    var minPremium = response.message[0].min_premium_depositp;\r\n                    var totalPreamt = response.message[0].total_pre_amt;\r\n                    var individualFirstloss = response.message[0].individual_first_lossp;\r\n                    var premiumrate = response.message[0].premium_rate;\r\n                    var cl_per_month = response.message[0].cl_per_monthp;\r\n                    var cl_per_enquiry = response.message[0].per_enquiryp;\r\n                    var premium_rate = response.message[0].premium_rate;\r\n\r\n\r\n\r\n                        // Function to populate child table\r\n                        function populateChildTable() {\r\n                            // Clear existing rows in the child table\r\n                           frm.clear_table('child_letter');\r\n\r\n                            // Add rows to the child table\r\n                            var row1 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row1.section = '1';\r\n                            row1.policy = 'Definition 14';\r\n                            row1.reference = 'Inception Date: ' + \"   \" + inceptionDate;\r\n\r\n                            var row2 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row2.section = '2';\r\n                            row2.policy = 'Definition 15';\r\n                            row2.reference = 'Goods/Services:' + \"   \" + GoodsServices ;\r\n\r\n                            var row3 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row3.section = '3';\r\n                            row3.policy = 'Definition 8';\r\n                            row3.reference = 'Insured percentages: ' + insuredCommerical;\r\n\r\n                            var row4 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row4.section = '4';\r\n                            row4.policy = 'Proviso 8B';\r\n                            row4.reference = 'Limit of Discretion: ' + limitDescription;\r\n\r\n                            var row5 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row5.section = '5';\r\n                            row5.policy = 'Definition';\r\n                            row5.reference = 'Franchise Loss: ' + franchiseLoss;\r\n\r\n                            var row6 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row6.section = '6(a)';\r\n                            row6.policy = 'Proviso 13A';\r\n                            row6.reference = 'Minimum Premium: P' + minPremium;\r\n\r\n                            var row7 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row7.section = '6(b)';\r\n                            row7.policy = 'Proviso 13B';\r\n                            row7.reference = 'Premium Rate (exclusive of VAT): ' + premiumrate;\r\n\r\n                            var row8 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row8.section = '6(c)';\r\n                            row8.policy = 'Proviso 13C';\r\n                            row8.reference = 'cl_per_monthp (P per CL): ' + cl_per_month + ', per_enquiryp (P per CL): ' + cl_per_enquiry;\r\n\r\n                            var row9 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row9.section = '7';\r\n                            row9.policy = 'Definition 12';\r\n                            row9.reference = 'Maximum Liability: P' + totalPreamt;\r\n\r\n                            var row10 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row10.section = '8';\r\n                            row10.policy = 'Definition 10';\r\n                            row10.reference = 'First Loss Limit: P' + individualFirstloss;\r\n                            \r\n                            var row11 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row11.section = '9(a)';\r\n                            row11.policy = 'Proviso 26';\r\n                            row11.reference = 'Premium rate and Credit Limit fees are exclusive of VAT: ' + '';\r\n\r\n                            // Refresh the child table\r\n                            frm.refresh_field('child_letter');\r\n                        }\r\n\r\n                        // Call the function to populate child table\r\n                        populateChildTable();\r\n                    } else {\r\n                        frappe.msgprint('No matching record found.');\r\n                    }\r\n                },\r\n                error: function(err) {\r\n                    console.error('Error fetching data:', err);\r\n                    frappe.msgprint('An error occurred while fetching data.');\r\n                }\r\n            });\r\n        } else if (proposalNumber.startsWith('DCI')) {\r\n            // Fetch data from DCI Quotations based on Proposal number\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'DCI Quotation',\r\n                    filters: {\r\n                        proposal_no1: proposalNumber\r\n                    },\r\n                    fields: [\r\n                        'inception_date',\r\n                        'goods_services',\r\n                        'limit_of_discretion',\r\n                        'insured_turnover',\r\n                        'franchise_loss',\r\n                        'min_annual_premium',\r\n                        'premium_rate',\r\n                        'fee_for_cl_per_month',\r\n                        'fee_per_enquiry',\r\n                        'maximum_liability',\r\n                        'loss_ratio',\r\n                        'premium_rate'\r\n                    ],\r\n                    limit: 1\r\n                },\r\n                callback: function(response) {\r\n                    if (response && response.message && response.message.length > 0) {\r\n                        var inceptionDate = response.message[0].inception_date;\r\n                        var GoodsServices = response.message[0].goods_services;\r\n                        var limitdiscretion = response.message[0].limit_of_discretion;\r\n                        var insuredCommercial = response.message[0].insured_turnover;\r\n                        var franchiseLoss = response.message[0].franchise_loss;\r\n                        var minPremium = response.message[0].min_annual_premium;\r\n                        var premiumRate = response.message[0].premium_rate;\r\n                        var clPerMonth = response.message[0].fee_for_cl_per_month;\r\n                        var clPerEnquiry = response.message[0].fee_per_enquiry;\r\n                        var maxLiability = response.message[0].maximum_liability;\r\n                        var lossRatio = response.message[0].loss_ratio;\r\n                        var premium_rate = response.message[0].premium_rate;\r\n\r\n\r\n                        // Function to populate child table\r\n                        function populateChildTable() {\r\n                            // Clear existing rows in the child table\r\n                           frm.clear_table('child_letter');\r\n\r\n                            // Add rows to the child table\r\n                            var row1 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row1.section = '1';\r\n                            row1.policy = 'Definition 14';\r\n                            row1.reference = 'Inception Date: ' + inceptionDate;\r\n\r\n                            var row2 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row2.section = '2';\r\n                            row2.policy = 'Definition 15';\r\n                            row2.reference = 'Goods/Services:' + GoodsServices;\r\n\r\n                            var row3 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row3.section = '3';\r\n                            row3.policy = 'Definition 8';\r\n                            row3.reference = 'Insured percentages: ' + insuredCommercial;\r\n\r\n                            var row4 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row4.section = '4';\r\n                            row4.policy = 'Proviso 8B';\r\n                            row4.reference = 'Limit of Discretion: ' + limitdiscretion;\r\n\r\n                            var row5 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row5.section = '5';\r\n                            row5.policy = 'Definition';\r\n                            row5.reference = 'Franchise Loss: ' + franchiseLoss;\r\n\r\n                            var row6 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row6.section = '6(a)';\r\n                            row6.policy = 'Proviso 13A';\r\n                            row6.reference = 'Minimum Premium: P' + minPremium;\r\n\r\n\r\n                            var row7 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row7.section = '6(b)';\r\n                            row7.policy = 'Proviso 13B';\r\n                            row7.reference = 'Premium Rate (exclusive of VAT): ' + premiumRate;\r\n\r\n                            var row8 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row8.section = '6(c)';\r\n                            row8.policy = 'Proviso 13C';\r\n                            row8.reference = 'cl_per_monthp (P per CL): ' + clPerMonth + ', per_enquiryp (P per CL): ' + clPerEnquiry;\r\n\r\n                            var row9 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row9.section = '7';\r\n                            row9.policy = 'Definition 12';\r\n                            row9.reference = 'Maximum Liability: P' + maxLiability;\r\n\r\n                            var row10 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row10.section = '8';\r\n                            row10.policy = 'Definition 10';\r\n                            row10.reference = 'First Loss Limit: P' + lossRatio;\r\n                            \r\n                            var row11 = frappe.model.add_child(frm.doc, 'Policy_schedule_childtable', 'child_letter');\r\n                            row11.section = '9(a)';\r\n                            row11.policy = 'Proviso 26';\r\n                            row11.reference = 'Premium rate and Credit Limit fees are exclusive of VAT: ' + '';\r\n\r\n                            // Refresh the child table\r\n                          frm.refresh_field('child_letter');\r\n                        }\r\n\r\n                        // Call the function to populate child table\r\n                        populateChildTable();\r\n                    } else {\r\n                        frappe.msgprint('No matching record found in DCI Quotation.');\r\n                    }\r\n                },\r\n                error: function(err) {\r\n                    console.error('Error fetching data from DCI Quotation:', err);\r\n                    frappe.msgprint('An error occurred while fetching data from DCI Quotation.');\r\n                }\r\n            });\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Assign_Lawyer",
  "enabled": 1,
  "modified": "2025-12-05 09:20:18.983632",
  "module": "Finance",
  "name": "Assign Lawyer",
  "script": "frappe.ui.form.on('Assign_Lawyer', {\r\n    \r\n    refresh(frm){\r\n      \r\n    },\r\n    \r\n    onload: function(frm) {\r\n        frm.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'CI Claim',\r\n                fields: ['ph_name1'],\r\n                limit_page_length: 10000\r\n            },\r\n           callback: function(response) {\r\n            console.log(\"policyholder received:\", response);\r\n            let data = response.message || [];\r\n\r\n            // Extract names\r\n            let finalData = data.map(x => x.ph_name1);\r\n\r\n            // \u2705 Remove duplicates\r\n            let uniqueNames = [...new Set(finalData)];\r\n            uniqueNames.sort();\r\n            // Set the unique names as dropdown options\r\n            frm.set_df_property('ph_name', 'options', uniqueNames);\r\n\r\n            console.log(\"unique names:\", uniqueNames);\r\n        }\r\n        });\r\n    },\r\n\r\n    ph_name: function(frm) {\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'CI Claim',\r\n                filters: {\r\n                    'ph_name1': frm.doc.ph_name\r\n                },\r\n                fields: ['claim_refno', 'buyer', 'policyno1', 'client_type'],\r\n                limit_page_length: 10\r\n            },\r\n            callback: function(response) {\r\n                if (response.message && response.message.length > 0) {\r\n                    var creditLimitProcessing = response.message[0];\r\n                    frm.set_value('claim_ref_no', creditLimitProcessing.claim_refno);\r\n                    frm.set_value('buyer', creditLimitProcessing.buyer);\r\n                    frm.set_value('policy_no', creditLimitProcessing.policyno1);\r\n                    frm.set_value('policy_type', creditLimitProcessing.client_type);\r\n                }\r\n            }\r\n        });\r\n    }\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// frappe.ui.form.on('Assign_Lawyer', {\r\n//     refresh(frm){\r\n//         frm.fields_dict.lawyer_.$input.css(\"text-align\",\"right\");\r\n//     },\r\n    \r\n//     onload: function(frm) {\r\n//         frm.call({\r\n//             method: 'frappe.client.get_list',\r\n//             args: {\r\n//                 doctype: 'Lawyer Debt Collector Details',\r\n//                 fields: ['name1']\r\n//             },\r\n//             callback: function(response) {\r\n//                 console.log(\"name1 received:\", response);\r\n//                 let Data = response.message || [];\r\n//                 let FinalData = Data.map(x => x.name1);\r\n//                 frm.set_df_property('lawyer', 'options', FinalData);\r\n//                 console.log(\"final\", FinalData);\r\n//             },\r\n//             error: function(xhr, textStatus, errorThrown) {\r\n//                 console.error(\"Error fetching lawyers details:\", textStatus, errorThrown);\r\n//             }\r\n//         });\r\n\r\n//         frm.call({\r\n//             method: 'frappe.client.get_list',\r\n//             args: {\r\n//                 doctype: 'Credit Limit Processing',\r\n//                 fields: ['policy_holder_name'],\r\n//                 limit_page_length: 2000\r\n//             },\r\n//             callback: function(response) {\r\n//                 console.log(\"policyholder received:\", response);\r\n//                 let Data = response.message || [];\r\n//                 let FinalData = Data.map(x => x.policy_holder_name);\r\n//                 frm.set_df_property('ph_name', 'options', FinalData);\r\n//                 console.log(\"final\", FinalData);\r\n//             },\r\n//         });\r\n//     },\r\n//     \r\n\r\n// });\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Bond Facility Ratio Analysis",
  "enabled": 1,
  "modified": "2025-12-05 08:28:38.389097",
  "module": null,
  "name": "Bond_ratio_calculation",
  "script": "frappe.ui.form.on('Bond Facility Ratio Analysis', {\r\n    refresh: function(frm) {\r\n        frm.fields_dict.calculate.$input.addClass('btn-primary');\r\n\r\n        frm.fields_dict['calculate'].$input.on('click', function() {\r\n            console.log(\"Calculation started...\");\r\n            \r\n            calculateFields(frm);\r\n            \r\n           // apply_color_logic(frm);\r\n         \r\n        });\r\n        \r\n        \r\n    //   //colour application based on value \r\n       \r\n        var fields = [\r\n            { field: 'net_profit_before3', criteria: { operator: '>', value: 0.06 } },\r\n            { field: 'net_profit_before2', criteria: { operator: '>', value: 0.06 } },\r\n            { field: 'net_profit_before1', criteria: { operator: '>', value: 0.06 } },\r\n            { field: 'beaverratio3', criteria: { operator: '>', value: 0.18 } },\r\n            { field: 'beaverratio2', criteria: { operator: '>', value: 0.18 } },\r\n            { field: 'beaverratio1', criteria: { operator: '>', value: 0.18 } },\r\n            { field: 'liquidity_ratio3', criteria: { operator: '>', value: 0.10 } },\r\n            { field: 'liquidity_ratio2', criteria: { operator: '>', value: 0.10 } },\r\n            { field: 'liquidity_ratio1', criteria: { operator: '>', value: 0.10 } },\r\n            { field: 'working_capital3', criteria: { operator: '>', value: 0.08 } },\r\n            { field: 'working_capital2', criteria: { operator: '>', value: 0.08 } },\r\n            { field: 'working_capital1', criteria: { operator: '>', value: 0.08 } },\r\n            { field: 'retained_currency3', criteria: { operator: '>', value: 0.03 } },\r\n            { field: 'retained_currency2', criteria: { operator: '>', value: 0.03 } },\r\n            { field: 'retained_currency1', criteria: { operator: '>', value: 0.03 } },\r\n            { field: 'depriciation_mevement3', criteria: { operator: '>', value: 0.25 } },\r\n            { field: 'depriciation_mevement2', criteria: { operator: '>', value: 0.25 } },\r\n            { field: 'depriciation_mevement1', criteria: { operator: '>', value: 0.25 } },\r\n            { field: 'wip_turnover3', criteria: { operator: '<', value: 0.08 } },\r\n            { field: 'wip_turnover2', criteria: { operator: '<', value: 0.08 } },\r\n            { field: 'wip_turnover1', criteria: { operator: '<', value: 0.08 } },\r\n            { field: 'debtors_turnover3', criteria: { operator: '<', value: 0.25 } },\r\n            { field: 'debtors_turnover2', criteria: { operator: '<', value: 0.25 } },\r\n            { field: 'debtors_turnover1', criteria: { operator: '<', value: 0.25 } },\r\n            { field: 'overheads_turnover3', criteria: { operator: '<', value: 0.10 } },\r\n            { field: 'overheads_turnover2', criteria: { operator: '<', value: 0.10 } },\r\n            { field: 'overheads_turnover1', criteria: { operator: '<', value: 0.10 } }\r\n        ];\r\n\r\n        // Iterate through each field and apply styles based on criteria\r\n        fields.forEach(function(item) {\r\n            var field = item.field;\r\n            var criteria = item.criteria;\r\n            var value = frm.doc[field];\r\n            var operator = criteria.operator;\r\n            var criteriaValue = criteria.value;\r\n\r\n            if (operator === '>') {\r\n                if (value < criteriaValue) {\r\n                    frm.fields_dict[field].$input.css({\r\n                        'background-color': 'red',\r\n                        'color': 'white'\r\n                    });\r\n                } else {\r\n                    frm.fields_dict[field].$input.css({\r\n                        'background-color': '',\r\n                        'color': ''\r\n                    });\r\n                }\r\n            } else if (operator === '<') {\r\n                if (value > criteriaValue) {\r\n                    frm.fields_dict[field].$input.css({\r\n                        'background-color': 'red',\r\n                        'color': 'white'\r\n                    });\r\n                } else {\r\n                    frm.fields_dict[field].$input.css({\r\n                        'background-color': '',\r\n                        'color': ''\r\n                    });\r\n                }\r\n            }\r\n        });\r\n       frappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Bond Facility',\r\n        fields: ['client_name'],\r\n        limit_page_length: 0\r\n    },\r\n    callback: function (response) {\r\n        if (response.message) {\r\n\r\n            // Extract client_name list\r\n            let options = response.message.map(row => row.client_name);\r\n            \r\n            options.sort();\r\n\r\n            // Set dropdown options\r\n            frm.set_df_property('client_name', 'options', options.join('\\n'));\r\n\r\n            // Clear value if current selection is not valid\r\n            if (!options.includes(frm.doc.client_name)) {\r\n                frm.set_value('client_name', '');\r\n            }\r\n        }\r\n    }\r\n});\r\n \r\n\r\n\r\n    },\r\n//     client_name: function (frm) {\r\n\r\n//     frappe.call({\r\n//         method: \"frappe.client.get_list\",\r\n//         args: {\r\n//             doctype: \"Bond Facility\",\r\n//             filters: {\r\n//                 client_name: frm.doc.client_name\r\n//             },\r\n//             fields: [\"facility_no\"],\r\n//             limit_page_length: 0\r\n//         },\r\n//         callback: function (response) {\r\n\r\n//             if (response.message && response.message.length > 0) {\r\n\r\n//                 // Extract all facility_no values\r\n//                 let facilities = response.message.map(row => row.facility_no);\r\n\r\n//                 // Set dropdown options (each on a new line)\r\n//                 frm.set_df_property(\"bond_facility_no\", \"options\", facilities.join(\"\\n\"));\r\n//             } else {\r\n\r\n//                 // No records found \u2192 clear dropdown\r\n//                 frm.set_df_property(\"bond_facility_no\", \"options\", \"\");\r\n//             }\r\n//         }\r\n//     });\r\n\r\n// },\r\n\r\n    client_name: function(frm) {\r\n    if (!frm.doc.client_name) return;\r\n\r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: \"Bond Facility\",\r\n            filters: {\r\n                client_name: frm.doc.client_name\r\n            },\r\n            fields: [\"facility_no\"],\r\n            limit_page_length: 1   // fetch only latest or first match\r\n        },\r\n        callback: function(response) {\r\n            if (response.message && response.message.length > 0) {\r\n\r\n                // Get the first facility_no\r\n                let facility_no = response.message[0].facility_no;\r\n\r\n                // Set value directly into the field\r\n                frm.set_value(\"bond_facility_no\", facility_no);\r\n\r\n            } else {\r\n                // Clear the field if no record found\r\n                frm.set_value(\"bond_facility_no\", \"\");\r\n            }\r\n        }\r\n    });\r\n},\r\n\r\n    onload: function(frm){\r\nfrm.fields_dict.currentassetscurrentyear.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.currentassetspreviousyear2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.currentassetspreviousyear1.$input.css(\"text-align\", \"right\");\r\n\r\n\r\n\r\n\r\nfrm.fields_dict.current_assests.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.current_assests1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.current_assests2.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.debtors1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.debtors2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.debtors3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.cruuent_liabilities1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.cruuent_liabilities2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.cruuent_liabilities3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.bank_overdraft1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.bank_overdraft2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.bank_overdraft3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.creditors1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.creditors2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.creditors3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.net_current_assests1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.net_current_assests2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.net_current_assests3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\n\r\nfrm.fields_dict.share_capital1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.share_capital2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.share_capital3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.retained_income1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.retained_income2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.retained_income3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.reatined_income4.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.reatined_income5.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.reatined_income6.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.net_profit1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.net_profit2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.net_profit3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.fixed_assets1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.fixed_assets2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.fixed_assets3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.fixed_assets4.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.fixed_assets5.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.fixed_assets6.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.overheads1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.overheads2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.overheads3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.work_in_progress1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.work_in_progress2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.work_in_progress3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.total_liabilities1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.total_liabilities2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.total_liabilities3.$input.css(\"text-align\", \"right\");\r\n\r\n//------------------\r\n\r\nfrm.fields_dict.net_profit_before1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.net_profit_before2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.net_profit_before3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.turnover1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.turnover2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.turnover3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.retained_earnings1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.retained_earnings2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.retained_earnings3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.beaverratio1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.beaverratio2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.beaverratio3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.liquidity_ratio1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.liquidity_ratio2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.liquidity_ratio3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.working_capital1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.working_capital2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.working_capital3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.retained_currency1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.retained_currency2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.retained_currency3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.depriciation_mevement1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.depriciation_mevement2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.depriciation_mevement3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.wip_turnover1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.wip_turnover2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.wip_turnover3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.debtors_turnover1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.debtors_turnover2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.debtors_turnover3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\nfrm.fields_dict.overheads_turnover1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.overheads_turnover2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.overheads_turnover3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\n\r\nfrm.fields_dict.currentratio_working1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.currentratio_working2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.currentratio_working3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\n\r\nfrm.fields_dict.turnover_growth1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.turnover_growth2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.turnover_growth3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\n\r\nfrm.fields_dict.calculated_facility1.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.calculated_facility2.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.calculated_facility3.$input.css(\"text-align\", \"right\");\r\n\r\n\r\n},\r\n\r\n    un_audited_annual_account: function(frm) {\r\n        if (frm.doc.un_audited_annual_account) {\r\n            frm.set_value('managment_account', 0);\r\n            frm.set_value('audited_financial', 0);\r\n            frm.refresh_field('managment_account');\r\n            frm.refresh_field('audited_financial');\r\n        }\r\n    },\r\n    managment_account: function(frm) {\r\n        if (frm.doc.managment_account) {\r\n            frm.set_value('un_audited_annual_account', 0);\r\n            frm.set_value('audited_financial', 0);\r\n            frm.refresh_field('un_audited_annual_account');\r\n            frm.refresh_field('audited_financial');\r\n        }\r\n    },\r\n    audited_financial: function(frm) {\r\n        if (frm.doc.audited_financial) {\r\n            frm.set_value('un_audited_annual_account', 0);\r\n            frm.set_value('managment_account', 0);\r\n            frm.refresh_field('un_audited_annual_account');\r\n            frm.refresh_field('managment_account');\r\n        }\r\n    }\r\n\r\n});\r\n\r\n// function apply_color_logic(frm) {\r\n//     const fields = [\r\n//         { field: 'net_profit_before3', criteria: { operator: '>', value: 0.06 } },\r\n//         { field: 'net_profit_before2', criteria: { operator: '>', value: 0.06 } },\r\n//         { field: 'net_profit_before1', criteria: { operator: '>', value: 0.06 } },\r\n//         { field: 'beaverratio3', criteria: { operator: '>', value: 0.18 } },\r\n//         { field: 'beaverratio2', criteria: { operator: '>', value: 0.18 } },\r\n//         { field: 'beaverratio1', criteria: { operator: '>', value: 0.18 } },\r\n//         { field: 'liquidity_ratio3', criteria: { operator: '>', value: 0.10 } },\r\n//         { field: 'liquidity_ratio2', criteria: { operator: '>', value: 0.10 } },\r\n//         { field: 'liquidity_ratio1', criteria: { operator: '>', value: 0.10 } },\r\n//         { field: 'working_capital3', criteria: { operator: '>', value: 0.08 } },\r\n//         { field: 'working_capital2', criteria: { operator: '>', value: 0.08 } },\r\n//         { field: 'working_capital1', criteria: { operator: '>', value: 0.08 } },\r\n//         { field: 'retained_currency3', criteria: { operator: '>', value: 0.03 } },\r\n//         { field: 'retained_currency2', criteria: { operator: '>', value: 0.03 } },\r\n//         { field: 'retained_currency1', criteria: { operator: '>', value: 0.03 } },\r\n//         { field: 'depriciation_mevement3', criteria: { operator: '>', value: 0.25 } },\r\n//         { field: 'depriciation_mevement2', criteria: { operator: '>', value: 0.25 } },\r\n//         { field: 'depriciation_mevement1', criteria: { operator: '>', value: 0.25 } },\r\n//         { field: 'wip_turnover3', criteria: { operator: '<', value: 0.08 } },\r\n//         { field: 'wip_turnover2', criteria: { operator: '<', value: 0.08 } },\r\n//         { field: 'wip_turnover1', criteria: { operator: '<', value: 0.08 } },\r\n//         { field: 'debtors_turnover3', criteria: { operator: '<', value: 0.25 } },\r\n//         { field: 'debtors_turnover2', criteria: { operator: '<', value: 0.25 } },\r\n//         { field: 'debtors_turnover1', criteria: { operator: '<', value: 0.25 } },\r\n//         { field: 'overheads_turnover3', criteria: { operator: '<', value: 0.10 } },\r\n//         { field: 'overheads_turnover2', criteria: { operator: '<', value: 0.10 } },\r\n//         { field: 'overheads_turnover1', criteria: { operator: '<', value: 0.10 } }\r\n//     ];\r\n\r\n//     fields.forEach(({ field, criteria }) => {\r\n//         if (!frm.fields_dict[field]) return; // skip missing fields\r\n//         const value = frm.doc[field] || 0;\r\n//         let highlight = false;\r\n\r\n//         if (criteria.operator === '>' && value < criteria.value) highlight = true;\r\n//         if (criteria.operator === '<' && value > criteria.value) highlight = true;\r\n\r\n//         frm.fields_dict[field].$input.css({\r\n//             'background-color': highlight ? 'red' : '',\r\n//             'color': highlight ? 'white' : ''\r\n//         });\r\n//     });\r\n// }\r\n\r\nfunction calculateFields(frm) {\r\n    // Current Year\r\n    // Net Current Assets\r\n    frm.set_value('net_current_assests1', frm.doc.current_assests - frm.doc.cruuent_liabilities1);\r\n    // Net Profit Before\r\n    frm.set_value('net_profit_before1', (frm.doc.net_profit1 / frm.doc.currentassetscurrentyear) * 100);\r\n    // Turnover\r\n    frm.set_value('turnover1', frm.doc.currentassetscurrentyear * 0.2);\r\n    // Retained Earnings\r\n    frm.set_value('retained_earnings1', frm.doc.reatined_income4 * 3);\r\n    // Beaver Ratio\r\n    frm.set_value('beaverratio1', (frm.doc.net_profit1 / frm.doc.total_liabilities1) * 100);\r\n    // Liquidity Ratio\r\n    frm.set_value('liquidity_ratio1', ((frm.doc.current_assests - frm.doc.cruuent_liabilities1) / frm.doc.cruuent_liabilities1) * 100);\r\n    // Working Capital\r\n    frm.set_value('working_capital1', ((frm.doc.current_assests - frm.doc.cruuent_liabilities1) / frm.doc.currentassetscurrentyear) * 100);\r\n    // Retained Currency\r\n    var LY = Math.abs(frm.doc.retained_income1);\r\n    if (LY > 0) {\r\n        frm.set_value('retained_currency1', (frm.doc.reatined_income4 - frm.doc.retained_income1) / LY * 100);\r\n    } else {\r\n        frm.set_value('retained_currency1', 100);\r\n    }\r\n    // Depreciation Movement\r\n    frm.set_value('depriciation_mevement1', (frm.doc.fixed_assets4 - frm.doc.fixed_assets1) / frm.doc.fixed_assets1 * 100);\r\n    // WIP Turnover\r\n    frm.set_value('wip_turnover1', frm.doc.work_in_progress1 / frm.doc.currentassetscurrentyear * 100);\r\n    // Debtors Turnover\r\n    frm.set_value('debtors_turnover1', frm.doc.debtors1 / frm.doc.currentassetscurrentyear * 100);\r\n    // Overheads Turnover\r\n    frm.set_value('overheads_turnover1', frm.doc.overheads1 / frm.doc.currentassetscurrentyear * 100);\r\n    // Current Ratio Working\r\n    frm.set_value('currentratio_working1', frm.doc.net_current_assests1 / frm.doc.total_liabilities1);\r\n    // Turnover Growth\r\n     frm.set_value('turnover_growth1', \r\n\t(frm.doc.currentassetscurrentyear - frm.doc.currentassetspreviousyear2) / frm.doc.currentassetspreviousyear2 * 100);\r\n\r\n    // Calculated Facility\r\n    if (frm.doc.turnover1 >= frm.doc.retained_earnings1) {\r\n        frm.set_value('calculated_facility1', frm.doc.retained_earnings1);\r\n    } else if (frm.doc.retained_earnings1 > frm.doc.turnover1) {\r\n        frm.set_value('calculated_facility1', (frm.doc.turnover1 + frm.doc.retained_earnings1) / 2);\r\n    }\r\n\r\n    // Year 1\r\n    // Net Current Assets\r\n    frm.set_value('net_current_assests2', frm.doc.current_assests1 - frm.doc.cruuent_liabilities2);\r\n    // Net Profit Before\r\n    frm.set_value('net_profit_before2', (frm.doc.net_profit2 / frm.doc.currentassetspreviousyear2) * 100);\r\n    // Turnover\r\n    frm.set_value('turnover2', frm.doc.currentassetspreviousyear2 * 0.2);\r\n    // Retained Earnings\r\n    frm.set_value('retained_earnings2', frm.doc.reatined_income5 * 3);\r\n    // Beaver Ratio\r\n    frm.set_value('beaverratio2', (frm.doc.net_profit2 / frm.doc.total_liabilities1) * 100);\r\n    // Liquidity Ratio\r\n    frm.set_value('liquidity_ratio2', ((frm.doc.current_assests1 - frm.doc.cruuent_liabilities2) / frm.doc.cruuent_liabilities2) * 100);\r\n    // Working Capital\r\n    frm.set_value('working_capital2', ((frm.doc.current_assests1 - frm.doc.cruuent_liabilities2) / frm.doc.currentassetspreviousyear2) * 100);\r\n    // Retained Currency\r\n    if (frm.doc.retained_income2 === 0) {\r\n        frm.set_value('retained_currency2', 100);\r\n    } else {\r\n        frm.set_value('retained_currency2', (frm.doc.reatined_income5 - frm.doc.retained_income2) / frm.doc.retained_income2 * 100);\r\n    }\r\n    // Depreciation Movement\r\n    frm.set_value('depriciation_mevement2', (frm.doc.fixed_assets5 - frm.doc.fixed_assets2) / frm.doc.fixed_assets2 * 100);\r\n    // WIP Turnover\r\n    frm.set_value('wip_turnover2', frm.doc.work_in_progress2 / frm.doc.currentassetspreviousyear2 * 100);\r\n    // Debtors Turnover\r\n    frm.set_value('debtors_turnover2', frm.doc.debtors2 / frm.doc.currentassetspreviousyear2 * 100);\r\n    // Overheads Turnover\r\n    frm.set_value('overheads_turnover2', frm.doc.overheads2 / frm.doc.currentassetspreviousyear2 * 100);\r\n    // Current Ratio Working\r\n    frm.set_value('currentratio_working2', frm.doc.net_current_assests2 / frm.doc.total_liabilities1);\r\n    // Turnover Growth\r\n   \r\n    \r\n    // Calculated Facility\r\n    if (frm.doc.turnover2 >= frm.doc.retained_earnings2) {\r\n        frm.set_value('calculated_facility2', frm.doc.retained_earnings2);\r\n    } else if (frm.doc.retained_earnings1 > frm.doc.turnover1) {\r\n        frm.set_value('calculated_facility2', (frm.doc.turnover2 + frm.doc.retained_earnings2) / 2);\r\n    }\r\n\r\n    // Year 2\r\n    // Net Current Assets\r\n    frm.set_value('net_current_assests3', frm.doc.current_assests2 - frm.doc.cruuent_liabilities3);\r\n    // Net Profit Before\r\n    frm.set_value('net_profit_before3', (frm.doc.net_profit3 / frm.doc.currentassetspreviousyear1) * 200);\r\n    // Turnover\r\n    frm.set_value('turnover3', frm.doc.currentassetspreviousyear1 * 0.2);\r\n    // Retained Earnings\r\n    frm.set_value('retained_earnings3', frm.doc.reatined_income6 * 3);\r\n    // Beaver Ratio\r\n    frm.set_value('beaverratio3', (frm.doc.net_profit3 / frm.doc.total_liabilities3) * 200);\r\n    // Liquidity Ratio\r\n    frm.set_value('liquidity_ratio3', ((frm.doc.current_assests2 - frm.doc.cruuent_liabilities3) / frm.doc.cruuent_liabilities3) * 200);\r\n    // Working Capital\r\n    frm.set_value('working_capital3', ((frm.doc.current_assests2 - frm.doc.cruuent_liabilities3) / frm.doc.currentassetspreviousyear1) * 200);\r\n    // Retained Currency\r\n    if (frm.doc.retained_income3 === 0) {\r\n        // frm.set_value('retained_currency3', 100);\r\n        frm.set_value('retained_currency3', 0);\r\n    } else {\r\n        frm.set_value('retained_currency3', (frm.doc.reatined_income6 - frm.doc.retained_income3) / frm.doc.retained_income3 * 200);\r\n    }\r\n    // Depreciation Movement\r\n    frm.set_value('depriciation_mevement3', (frm.doc.fixed_assets6 - frm.doc.fixed_assets3) / frm.doc.fixed_assets3 * 200);\r\n    // WIP Turnover\r\n    frm.set_value('wip_turnover3', frm.doc.work_in_progress3 / frm.doc.currentassetspreviousyear1 * 100);\r\n    // Debtors Turnover\r\n    frm.set_value('debtors_turnover3', frm.doc.debtors3 / frm.doc.currentassetspreviousyear1 * 200);\r\n    // Overheads Turnover\r\n    frm.set_value('overheads_turnover3', frm.doc.overheads3 / frm.doc.currentassetspreviousyear1 * 200);\r\n    // Current Ratio Working\r\n    frm.set_value('currentratio_working3', frm.doc.net_current_assests3 / frm.doc.total_liabilities3);\r\n    // Turnover Growth\r\n    \r\n    \r\n    // // Calculated Facility\r\n    // if (frm.doc.turnover3 > frm.doc.retained_earnings3) {\r\n    //     frm.set_value('calculated_facility3', (frm.doc.turnover3 + frm.doc.turnover3) / 2);\r\n    // } else if (frm.doc.retained_earnings3 > frm.doc.turnover3) {\r\n    //     frm.set_value('calculated_facility3', frm.doc.retained_earnings3);\r\n    // }\r\n        // Calculated Facility\r\n    if (frm.doc.turnover3 > frm.doc.retained_earnings3) {\r\n        //frm.set_value('calculated_facility3', (frm.doc.turnover3 + frm.doc.turnover3) / 2);\r\n        frm.set_value('calculated_facility3', (frm.doc.turnover3) / 2);\r\n    } else if (frm.doc.retained_earnings3 > frm.doc.turnover3) {\r\n        frm.set_value('calculated_facility3', frm.doc.retained_earnings3);\r\n    }\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Policy Reviews History",
  "enabled": 0,
  "modified": "2024-05-02 07:18:46.368304",
  "module": null,
  "name": "Colour Button",
  "script": "frappe.ui.form.on('Policy Reviews History', {\n\trefresh(frm) {\n\t  frm.fields_dict.generate_report.$input.addClass('btn-primary');\n\t  frm.fields_dict.display_result.$input.addClass('btn-primary');\n\t   frm.fields_dict.clear.$input.addClass('btn-primary');\n\t     \n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Funds",
  "enabled": 1,
  "modified": "2025-11-18 06:30:26.023626",
  "module": null,
  "name": "fetchind_Details",
  "script": "frappe.ui.form.on('Funds', {\r\n    refresh(frm){\r\n     frm.fields_dict.intialfundamount.$input.css(\"text-align\",\"right\"); \r\n    },\r\n    \r\n    onload: function(frm) {\r\n        // Fetch fund providers from the Fund doctype and populate the select field\r\n        // frappe.call({\r\n        //     method: 'frappe.client.get_list',\r\n        //     args: {\r\n        //         doctype: 'FundProviderDetail',  // Name of the DocType you want to fetch from\r\n        //         filters: {\r\n        //             // Optional filters if needed\r\n        //         },\r\n        //         fields: ['name', 'shortname'],  // Fields you want to fetch\r\n        //         order_by: 'shortname' , // Optional: order by fund_provider field\r\n        //          limit_page_length: 10000\r\n        //     },\r\n        //     callback: function(response) {\r\n        //         // Handle the response\r\n        //         var funds1 = response.message;\r\n        //         if (funds1) {\r\n        //             var options = [];\r\n        //             // Iterate through fetched funds\r\n        //             funds1.forEach(function(funds) {\r\n        //                 // Add each fund provider to the options list\r\n        //                 options.push({\r\n        //                     'label': funds.fund_provider,\r\n        //                     'value': funds.shortname\r\n        //                 });\r\n        //             });\r\n        //             // Set options to the select field\r\n        //             frm.set_df_property('fund_provider', 'options', options);\r\n        //         }\r\n        //     }\r\n        // });\r\n    },\r\n    // fund_provider(frm) {\r\n    //      frm.call({\r\n    //         method: 'frappe.client.get_list',\r\n    //         args: {\r\n    //             doctype: 'FundProviderDetail',\r\n    //             filters: {\r\n    //                 shortname: frm.doc.fund_provider\r\n    //             },\r\n    //             fields: ['shortname', 'fname', 'physicaladdress', 'status'],\r\n    //             limit_page_length: 10000\r\n    //         },\r\n    //         callback: function(r) {\r\n    //             console.log(r, \"client details\");\r\n               \r\n    //             if (r.message && r.message.length > 0) {\r\n    //                 frm.set_value('fund_provider', r.message[0].shortname);\r\n    //                 frm.set_value('fname', r.message[0].fname);\r\n    //                 frm.set_value('address', r.message[0].physicaladdress);\r\n    //                 frm.set_value('status', r.message[0].status);\r\n                   \r\n    //             }\r\n    //         }\r\n    //     });\r\n    // }\r\n    \r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Policy Reviews History",
  "enabled": 1,
  "modified": "2024-06-27 11:08:44.490135",
  "module": null,
  "name": "Fetch Data From Policy Reviews",
  "script": "frappe.ui.form.on('Policy Reviews History', {\r\n    \trefresh(frm) {\r\n\t  frm.fields_dict.generate_report.$input.addClass('btn-primary');\r\n\t  frm.fields_dict.display_result.$input.addClass('btn-primary');\r\n\t   frm.fields_dict.clear.$input.addClass('btn-primary');\r\n\t     \r\n\t},\r\n    display_result: function(frm) {\r\n        let query = {};\r\n\r\n        if (frm.doc.policy_holder) {\r\n            query.policy_holder = frm.doc.policy_holder;\r\n        }\r\n\r\n        // Call to fetch data\r\n        frappe.call({\r\n            method: \"frappe.client.get_list\",\r\n            args: {\r\n                doctype: \"Policy Reviews\",\r\n                filters: query,\r\n                fields: [\"policy_no\", \"policy_holder\",\"premium_rate1\",\"inception_date\"]//, \"date_of_review\", \"review_notes\"]\r\n            },\r\n            callback: function(r) {\r\n              \r\n                if (r.message) {\r\n                    frm.clear_table(\"result\");\r\n                    frm.refresh_field('result');\r\n                    var data = r.message; \r\n                    console.log(data,\"response\")\r\n                    \r\n                    for (let x of data) {\r\n                        var child = frappe.model.add_child(frm.doc, \"result\");\r\n                        console.log(child,\"child table data\")\r\n                        frappe.model.set_value(child.doctype, child.name, \"policy_no\", x.policy_no);\r\n                        frappe.model.set_value(child.doctype, child.name, \"policy_holder\", x.policy_holder);\r\n                        frappe.model.set_value(child.doctype, child.name, \"premium\", x.premium_rate1);\r\n                        frappe.model.set_value(child.doctype, child.name, \"date\", x.inception_date);\r\n                    }\r\n                    frm.refresh_fields(\"result\");\r\n                }\r\n            }\r\n        });\r\n        frappe.validated = false;\r\n    },\r\n\r\n    clear: function(frm) {\r\n        frm.set_value(\"policy_holder\", \"\");\r\n        frm.enable_save();\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Currency_Finance",
  "enabled": 1,
  "modified": "2024-06-27 13:35:58.354767",
  "module": null,
  "name": "Currency",
  "script": "frappe.ui.form.on('Currency_Finance', {\r\n    \r\n    refresh(frm){\r\n        \r\n        frm.fields_dict.conversion_rate_1_pula.$input.css(\"text-align\",\"right\");\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Withdrawal",
  "enabled": 1,
  "modified": "2025-11-18 09:01:03.705676",
  "module": "Finance",
  "name": "withdrawals",
  "script": "\nfrappe.ui.form.on('Withdrawal', {\n   onload(frm) {\n        frappe.call({\n    method: 'frappe.client.get_list',\n    args: {\n        doctype: 'Funds',\n        fields: ['fund_provider'],   // only field that exists\n        limit_page_length: 0\n    },\n    callback: function(response) {\n        console.log(\"Funds Data:\", response);\n\n        let data = response.message || [];\n\n        // ---- Unique Fund Providers ----\n        let uniqueProviders = [...new Set(data.map(x => x.fund_provider))];\n\n        // Set dropdown options\n        frm.set_df_property('fund_provider', 'options', uniqueProviders);\n\n        console.log(\"Unique fund_provider:\", uniqueProviders);\n    },\n    error: function(xhr, textStatus, errorThrown) {\n        console.error(\"Error fetching funds:\", textStatus, errorThrown);\n    }\n});\n\n    \n        \n       \n    },\n\n      refresh: function(frm) { \n          frm.fields_dict.initial_fund.$input.css(\"text-align\",\"right\");\n          frm.set_df_property('withdral_history', 'cannot_add_rows', true); \n            frm.fields_dict.add.$input.addClass('btn-primary');\n\n          console.log(withdral_history,\"childtable\")\n          \n      }, \n \n      \n  \n \n    \n     \n    fund_provider(frm) {\n\n    if (!frm.doc.fund_provider) return;   // correct check\n\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Funds',\n            filters: {\n                fund_provider: frm.doc.fund_provider\n            },\n            fields: [\n                'fname',\n                'fund_refid',\n                'fundname',\n                'inceptiondate',\n                'intialfundamount',\n                'status'\n            ],\n            limit_page_length: 1      // only need the first match\n        },\n        callback: function(response) {\n\n            let data = response.message && response.message.length ? response.message[0] : null;\n\n            if (data) {\n                frm.set_value('name1', data.fname || '');\n                frm.set_value('fund_ref_id', data.fund_refid || '');\n                frm.set_value('fund_inception_date', data.inceptiondate || '');\n                frm.set_value('initial_fund', data.intialfundamount || '');\n                frm.set_value('status', data.status || '');\n            } else {\n                // Reset fields if no record found\n                frm.set_value('name1', '');\n                frm.set_value('fund_ref_id', '');\n                frm.set_value('fund_inception_date', '');\n                frm.set_value('initial_fund', '');\n                frm.set_value('status', '');\n            }\n        }\n    });\n},\n\n    \n    \n    \n    \n    \n    \n    \n// add(frm) {\n//     function generateNextFundtrnno() {\n//         var childTable = frm.doc.withdral_history || [];\n//         var lastFundtrnno = '';\n \n//         if (childTable.length > 0) {\n//             lastFundtrnno = childTable[childTable.length - 1].fundtrnno;\n//         }\n \n       \n//         var lastNumber = parseInt(lastFundtrnno.split('/')[2]) || 0;\n//         var nextNumber = lastNumber + 1;\n \n       \n//         var nextFundtrnno = 'FPEP/' + (new Date()).getFullYear() + '/' + nextNumber.toString().padStart(4, '0');\n//         return nextFundtrnno;\n//     }\n \n   \n//     var nextFundtrnno = generateNextFundtrnno();\n \n  \n//     var dialog = new frappe.ui.Dialog({\n//         title: 'Withdrawal Details',\n//         fields: [\n//             {\n//                 fieldname: 'fundtrnno',\n//                 label: 'Fundtrnno',\n//                 fieldtype: 'Data',\n//                 default: nextFundtrnno, \n//                 read_only: true \n//             },\n//             {\n//                 fieldname: 'date',\n//                 label: 'Date',\n//                 fieldtype: 'Date',\n//             },\n//             {\n//                 fieldname: 'withdrawls',\n//                 label: 'Withdrawls',\n//                 fieldtype: 'Currency',\n//             },\n//         ],\n//         primary_action_label: 'Submit',\n//         primary_action: function() {\n//             var fundtrnno = dialog.get_value('fundtrnno');\n//             var date = dialog.get_value('date');\n//             var withdrawls = dialog.get_value('withdrawls');\n \n         \n//             var row = frm.add_child('withdral_history', {\n//                 'fundtrnno': fundtrnno,\n//                 'date': date,\n//                 'withdrawls': withdrawls\n//             });\n \n            \n//             frm.refresh_field('withdral_history');\n \n          \n//             dialog.hide();\n//             totalwithdrawaladdition(frm);\n//         }\n//     });\n \n  \n//     dialog.show();\n// }\n \n add: function(frm) {\n    function getNextLoiNo() {\n        var currentYear = (new Date()).getFullYear();\n        var currentNumber = 1;\n        var lastLoiNo;\n \n        // Check if the child table is empty\n        if (!frm.doc.withdral_history || frm.doc.withdral_history.length === 0) {\n            // Retrieve the last used LOI number from the database\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Withdrawal',\n                    fields: ['fundtrnno', 'creation'],\n                    order_by: 'creation desc',\n                    limit: 1\n                },\n                async: false,\n                callback: function(response) {\n                    if (response.message && response.message[0]) {\n                        lastLoiNo = response.message[0].fundtrnno;\n                    }\n                }\n            });\n        } else {\n            // Retrieve the last used LOI number from local storage\n            lastLoiNo = localStorage.getItem('last_loi_no');\n        }\n \n        // If the child table is not empty, or no records found in the database, use local storage for incrementation\n        if (lastLoiNo) {\n            var lastNumber = parseInt(lastLoiNo.split('/')[2]);\n            currentNumber = lastNumber + 1;\n        }\n \n        var nextLoiNo = `FDEP/${currentYear}/${('000' + currentNumber).slice(-4)}`;\n        return nextLoiNo;\n    }\n \n    frappe.prompt([\n        \n        {'fieldname': 'fundtrnno', 'fieldtype': 'Data', 'label': 'Fundtrnno:', 'default': getNextLoiNo()},\n        {'fieldname': 'date', 'fieldtype': 'Date','label': 'Date:', reqd: 1   },\n        {'fieldname': 'withdrawls', 'fieldtype': 'Currency', 'label': 'Withdrawls', reqd: 1   },\n         {'fieldname': 'description', 'fieldtype': 'Data', 'label': 'Description'},\n        \n    ],\n    function(values) {\n        var data = {\n            loi_no: values.fundtrnno,\n            principal: values.date,\n            tender_no: values.withdrawls,\n             description: values.description,\n            \n        };\n \n        var nextLoiNo = getNextLoiNo();\n        localStorage.setItem('last_loi_no', nextLoiNo);\n \n        // Add the retrieved data to the child table\n        addDataToChildTable(frm, data);\n    },\n    'Withdrawl details');\n},\n \n \n\n    // Set the last row's loi_no into the loi field before saving the record\n  before_save: function(frm) {\n    if (frm.doc.withdral_history && frm.doc.withdral_history.length > 0) {\n        var lastRowLoiNo = frm.doc.withdral_history[frm.doc.withdral_history.length - 1].fundtrnno;\n        frm.set_value('fundtrnno', lastRowLoiNo);\n        console.log(lastRowLoiNo,'number')\n    }\n}\n\n\n});\n\n\nfunction addDataToChildTable(frm, data) {\n    var childTable = frm.fields_dict['withdral_history'].grid;\n    var newRow = childTable.add_new_row();\n    frappe.model.set_value(newRow.doctype, newRow.name, 'fundtrnno', data.loi_no);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'date', data.principal);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'withdrawls', data.tender_no);\n      frappe.model.set_value(newRow.doctype, newRow.name, 'description', data.description);\n    \n    childTable.refresh();\n    totalwithdrawaladdition(frm);\n}\n \n \nfunction totalwithdrawaladdition(frm){\n    var childTableData = frm.doc.withdral_history || [];\n    // Initialize totalBondValue with the first row's value\n    var totalCapitalValue = childTableData.length > 0 ? parseFloat(childTableData[0].withdrawls) || 0 : 0;\n \n    // Subtract values of subsequent rows from totalBondValue\n    for (var i = 1; i < childTableData.length; i++) {\n        var rowSecurityValue = parseFloat(childTableData[i].withdrawls) || 0;\n        totalCapitalValue += rowSecurityValue;\n    }\n    frm.set_value('total_withdraw_amount', totalCapitalValue);\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "View CB Request  Form",
  "enabled": 1,
  "modified": "2024-04-15 07:46:12.422791",
  "module": "UnderWriting",
  "name": "CB_Request_report",
  "script": "frappe.ui.form.on('View CB Request  Form', {\n\trefresh(frm) {\n\t      frappe.call({\n            method: 'frappe.client.get',\n            args: {\n                doctype: 'Credit Limit Processing',\n                filters: {\n                    buyer_name: frm.doc.company_name\n                }\n            },\n            callback: function(r) {\n                if (r.message) {\n                    frm.set_value('trading_style', r.message.trading__style);\n                    frm.set_value('credit_limit', r.message.credit_limit);\n                }\n            }\n        });\n// \t\t// your code here\n\t},\n\t\nonload(frm){\n\t    \n  frappe.call({\n    method: \"frappe.client.get\",\n    args: {\n        doctype:\"CB Request\",\n        filters: {\n            buyer: frm.doc.company_name,\n            policy_type: frm.doc.policy_type\n        },\n        fields: [\"toaddress\",\"attention\",\"from\",\"attention1\",\"subject\",\"date\"]\n    },\n    callback: function (r) {\n        console.log(r, \"cb request data\");\n\n        if (!r.exc) {\n            var data = r.message; // Access the data object under 'message'\n            console.log(data,\"cb request\");\n            \n            // Now, access properties of the data object\n            frm.set_value('toaddress', data.toaddress);\n            frm.set_value('attention', data.attention);\n            frm.set_value('from', data.from);\n            frm.set_value('attention1', data.attention1);\n            frm.set_value('subject', data.subject);\n            frm.set_value('date', data.date);\n        } else {\n            // console.error(\"Error occurred in DCI Proposals data:\", r.exc);\n        }\n    }\n});\n\n\n\n//   frappe.call({\n//     method: \"frappe.client.get\",\n//     args: {\n//         doctype:\"Credit Limit Processing\",\n//         filters: {\n//             buyer_name: frm.doc.company_name,\n//             policy_type: frm.doc.policy_type\n//         },\n//         fields: [\"table\"]\n//     },\n//     callback: function (r) {\n//         console.log(r, \"DCI Proposals data\");\n\n//         if (!r.exc) {\n//             var data = r.message.table[0]; // Access the data object under 'message'\n//             console.log(data,\"rtyuio\");\n            \n//             // Now, access properties of the data object\n//             frm.set_value('toaddress', data.toaddress);\n//             frm.set_value('attention', data.attention);\n//             frm.set_value('from', data.from);\n//             frm.set_value('attention1', data.attention1);\n//             frm.set_value('subject', data.subject);\n//             frm.set_value('date', data.date);\n//         } else {\n//             console.error(\"Error occurred in DCI Proposals data:\", r.exc);\n//         }\n//     }\n// });\n\n\n\n\n  frappe.call({\n    method: \"frappe.client.get\",\n    args: {\n        doctype: \"Buyer\",\n        filters: {\n            buyer_name: frm.doc.company_name,\n            policy_type: frm.doc.policy_type\n        },\n        fields: ['physical_address','registration_no','postal_address','tel_no1','fax','country','bank','ac_no','branch','referance_1','director_1']\n    },\n    callback: function (r) {\n        console.log(r, \"Buyers data\");\n\n         if (r.message) {\n          // var data = r.message.table[0]; // Access the data object under 'message'\n            \n            // Now, access properties of the data object\n                    frm.set_value('physical_address', r.message.physical_address);\n                    frm.set_value('registration_number', r.message.registration_no);\n                    frm.set_value('postal_address', r.message.postal_address);\n                    frm.set_value('telephone_number', r.message.tel_no1);\n                    frm.set_value('fax_no', r.message.fax);\n                    frm.set_value('country', r.message.country);\n                    frm.set_value('bank', r.message.bank);\n                    frm.set_value('account_number', r.message.ac_no);\n                    frm.set_value('branch', r.message.branch);\n                    frm.set_value('trade_references', r.message.referance_1);\n                     frm.set_value('director_and_share_holders', r.message.director_1);\n                    \n                    // frm.set_value('buyer_name', data_from_proposals.company_name || '');\n                    // frm.set_value('physical_address', data_from_proposals.physical_address || '');\n                    // frm.set_value('registration_number', data_from_proposals.registration_no || '');\n                    // frm.set_value('postal_address', data_from_proposals.postal_address || '');\n                    // frm.set_value('telephone_number', data_from_proposals.tel_no1 || '');\n                    // frm.set_value('fax', data_from_proposals.fax_no || '');\n                    \n        } else {\n            console.error(\"Error occurred in DCI Proposals data:\", r.exc);\n        }\n    }\n})\n\n\n\t    \n\t    \n\t \n\t    \n\t}\n})\n\n\n\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "sample3",
  "enabled": 1,
  "modified": "2024-04-08 11:21:14.907169",
  "module": "Insured_Module",
  "name": "s5",
  "script": " frappe.ui.form.on('sample3', {\r\n    save: function(frm) {\r\n        // Save the current form data\r\n        frm.save().then(() => {\r\n            // Setting route options\r\n            var route_options = {\r\n                name: frm.doc.name\r\n            };\r\n\r\n            // Creating a new document of type 'sample4' with the specified route options\r\n            frappe.new_doc('sample4', route_options);\r\n        }).fail(() => {\r\n            frappe.msgprint(\"Failed to save 'sample3' data.\");\r\n        });\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Capital Addition",
  "enabled": 1,
  "modified": "2025-11-18 07:51:50.180303",
  "module": "Finance",
  "name": "capital Addition",
  "script": "frappe.ui.form.on('Capital Addition', {\r\n    // refresh(frm) {\r\n    //     frm.call({\r\n    //         method: 'frappe.client.get_list',\r\n    //         args: {\r\n    //             doctype: 'Funds',\r\n    //             fields: ['fund_provider','fundname']\r\n    //         },\r\n    //         callback: function (response) {\r\n    //             console.log(\"fund_provider received:\", response);\r\n                \r\n    //             let FundProviderData = response.message || [];\r\n    //             let UniqueFundProviders = [...new Set(FundProviderData.map(x => x.fund_provider))]; // Remove duplicates\r\n                \r\n    //             frm.set_df_property('fund_provider', 'options', UniqueFundProviders);\r\n    //             console.log(\"Unique fund_provider:\", UniqueFundProviders);\r\n                \r\n    //             let FundNameProviderData = response.message || []; \r\n    //             let UniqueFundNames = [...new Set(FundNameProviderData.map(x => x.fundname))]; \r\n    //             // Remove duplicates \r\n    //             frm.set_df_property('name1', 'options', UniqueFundNames); \r\n    //             console.log(\"Unique fundname:\", UniqueFundNames);\r\n                \r\n    //         },\r\n    //         error: function (xhr, textStatus, errorThrown) {\r\n    //             console.error(\"Error fetching funds details:\", textStatus, errorThrown);\r\n    //         }\r\n    //     });\r\n    // },\r\n    \r\n       refresh(frm) {\r\n           \r\n  frm.set_df_property('capital_addition','cannot_add_rows', true);\r\n  frm.fields_dict.add_new.$input.addClass('btn-primary');\r\n\r\n\r\n        frm.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Funds',\r\n                fields: ['fund_provider']\r\n            },\r\n            callback: function (response) {\r\n                console.log(\"fund_provider received:\", response);\r\n                \r\n                let FundProviderData = response.message || [];\r\n                let UniqueFundProviders = [...new Set(FundProviderData.map(x => x.fund_provider))]; // Remove duplicates\r\n                \r\n                frm.set_df_property('fund_provider', 'options', UniqueFundProviders);\r\n                console.log(\"Unique fund_provider:\", UniqueFundProviders);\r\n                \r\n                \r\n            },\r\n            error: function (xhr, textStatus, errorThrown) {\r\n                console.error(\"Error fetching funds details:\", textStatus, errorThrown);\r\n            }\r\n        });\r\n    },\r\n    \r\n    // Trigger when 'name1' field changes\r\n    name1: function (frm) {\r\n        // frappe.call({\r\n        //     method: 'frappe.client.get_list',\r\n        //     args: {\r\n        //         doctype: 'Funds',\r\n        //         filters: { fund_provider: frm.doc.fund_provider },\r\n        //         fields: ['fname', 'fstatus', 'inceptiondate', 'fund_refid', 'intialfundamount']\r\n        //     },\r\n        //     callback: function (response) {\r\n        //         console.log(\"Funds response:\", response);\r\n        //         if (response.message && response.message.length > 0) {\r\n        //             var data = response.message[0];\r\n        //             frm.set_value('name1', data.fname || '');\r\n        //             frm.set_value('status', data.fstatus || '');\r\n        //             frm.set_value('fund_inception_date', data.inceptiondate || '');\r\n        //             frm.set_value('fund_ref_id', data.fund_refid || '');\r\n        //             frm.set_value('initial_fund', data.intialfundamount || '');\r\n        //         } else {\r\n        //             frm.set_value('name1', '');\r\n        //             frm.set_value('status', '');\r\n        //             frm.set_value('fund_inception_date', '');\r\n        //             frm.set_value('fund_ref_id', '');\r\n        //             frm.set_value('initial_fund', '');\r\n        //             frappe.msgprint('No matching record found.');\r\n        //         }\r\n        //     },\r\n        //     error: function (err) {\r\n        //         console.error(err);\r\n        //         frappe.msgprint('Error fetching Funds data.');\r\n        //     }\r\n        // });\r\n    },\r\n\r\n    // Trigger calculation on change\r\n    total_capital_addition: function (frm) {\r\n        calculatetotalCapitalAddition(frm);\r\n    },\r\n\r\n    // Fetch total withdraw amount\r\n    fund_provider: function (frm) {\r\n        frappe.call({\r\n            method: 'frappe.client.get',\r\n            args: {\r\n                doctype: 'Withdrawal',\r\n                filters: { fund_provider: frm.doc.fund_provider },\r\n                fields: ['total_withdraw_amount']\r\n            },\r\n            callback: function (r) {\r\n                if (r.message) {\r\n                    frm.set_value('total_withdraw_amount', r.message.total_withdraw_amount);\r\n                }\r\n            },\r\n            error: function (err) {\r\n                console.error(\"Error fetching withdrawal amount:\", err);\r\n            }\r\n        });\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Funds',\r\n                filters: { fund_provider: frm.doc.fund_provider },\r\n                fields: ['fname', 'fstatus', 'inceptiondate', 'fund_refid', 'intialfundamount']\r\n            },\r\n            callback: function (response) {\r\n                console.log(\"Funds response:\", response);\r\n                if (response.message && response.message.length > 0) {\r\n                    var data = response.message[0];\r\n                    frm.set_value('name1', data.fname || '');\r\n                    frm.set_value('status', data.fstatus || '');\r\n                    frm.set_value('fund_inception_date', data.inceptiondate || '');\r\n                    frm.set_value('fund_ref_id', data.fund_refid || '');\r\n                    frm.set_value('initial_fund', data.intialfundamount || '');\r\n                } else {\r\n                    frm.set_value('name1', '');\r\n                    frm.set_value('status', '');\r\n                    frm.set_value('fund_inception_date', '');\r\n                    frm.set_value('fund_ref_id', '');\r\n                    frm.set_value('initial_fund', '');\r\n                    frappe.msgprint('No matching record found.');\r\n                }\r\n            },\r\n            error: function (err) {\r\n                console.error(err);\r\n                frappe.msgprint('Error fetching Funds data.');\r\n            }\r\n        });\r\n        //   frappe.call({\r\n        //     method: 'frappe.client.get_list',\r\n        //     args: {\r\n        //         doctype: 'Funds',\r\n        //         filters: { fund_provider: frm.doc.fund_provider },\r\n        //         fields: ['fundname']\r\n        //     },\r\n        //     callback: function (response) {\r\n        //         console.log(\"Funds response:\", response);\r\n        //         if (response.message && response.message.length > 0) {\r\n        //             var data = response.message[0];\r\n                    \r\n        //             frm.set_value('name1', data.fundname || '');\r\n        //         } else {\r\n        //             frm.set_value('name1', '');\r\n        //             frappe.msgprint('No matching record found.');\r\n        //         }\r\n        //     },\r\n        //     error: function (err) {\r\n        //         console.error(err);\r\n        //         frappe.msgprint('Error fetching Funds data.');\r\n        //     }\r\n        // });\r\n        \r\n    },\r\n\r\n    // Add new row in child table\r\n    add_new: function (frm) {\r\n        function getNextLoiNo() {\r\n            var currentYear = (new Date()).getFullYear();\r\n            var currentNumber = 1;\r\n            var lastLoiNo;\r\n\r\n            if (!frm.doc.capital_addition || frm.doc.capital_addition.length === 0) {\r\n                frappe.call({\r\n                    method: 'frappe.client.get_list',\r\n                    args: {\r\n                        doctype: 'Capital Addition',\r\n                        fields: ['fundtrtno'],\r\n                        order_by: 'creation desc',\r\n                        limit: 1\r\n                    },\r\n                    async: false,\r\n                    callback: function (response) {\r\n                        if (response.message && response.message[0]) {\r\n                            lastLoiNo = response.message[0].fundtrtno;\r\n                        }\r\n                    }\r\n                });\r\n            } else {\r\n                lastLoiNo = localStorage.getItem('last_loi_no');\r\n            }\r\n\r\n            if (lastLoiNo) {\r\n                var lastNumber = parseInt(lastLoiNo.split('/')[2]);\r\n                currentNumber = lastNumber + 1;\r\n            }\r\n\r\n            var nextLoiNo = `FDEP/${currentYear}/${('000' + currentNumber).slice(-4)}`;\r\n            return nextLoiNo;\r\n        }\r\n\r\n        frappe.prompt([\r\n            { fieldname: 'date', fieldtype: 'Date', label: 'Date', reqd: 1    },\r\n            { fieldname: 'description', fieldtype: 'Data', label: 'Description' },\r\n            { fieldname: 'amount', fieldtype: 'Currency', label: 'Amount' , reqd: 1   },\r\n            { fieldname: 'fundtrtno', fieldtype: 'Data', label: 'FundtrtNo', default: getNextLoiNo() }\r\n        ],\r\n        function (values) {\r\n            var data = {\r\n                loi_no: values.date,\r\n                principal: values.amount,\r\n                tender_no: values.fundtrtno,\r\n                 description: values.description\r\n            };\r\n\r\n            localStorage.setItem('last_loi_no', getNextLoiNo());\r\n            addDataToChildTable(frm, data);\r\n        },\r\n        'Capital Additions No Table');\r\n    },\r\n\r\n    // Set the last row's loi_no before saving\r\n    before_save: function (frm) {\r\n        if (frm.doc.capital_addition && frm.doc.capital_addition.length > 0) {\r\n            var lastRowLoiNo = frm.doc.capital_addition[frm.doc.capital_addition.length - 1].fundtrtno;\r\n            frm.set_value('fundtrtno', lastRowLoiNo);\r\n            console.log('Last FundtrtNo:', lastRowLoiNo);\r\n        }\r\n    }\r\n});\r\n\r\n// Helper function to add data to child table\r\nfunction addDataToChildTable(frm, data) {\r\n    var newRow = frm.add_child('capital_addition');\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'date', data.loi_no);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'amount', data.principal);\r\n    frappe.model.set_value(newRow.doctype, newRow.name, 'fundtrtno', data.tender_no);\r\n     frappe.model.set_value(newRow.doctype, newRow.name, 'description', data.description);\r\n    frm.refresh_field('capital_addition');\r\n    totaladdition(frm);\r\n}\r\n\r\n// Calculate total addition\r\nfunction totaladdition(frm) {\r\n    var initial_fund = frm.doc.initial_fund || 0;\r\n    var totalCapitalValue = 0;\r\n\r\n    (frm.doc.capital_addition || []).forEach(row => {\r\n        totalCapitalValue += parseFloat(row.amount) || 0;\r\n    });\r\n\r\n    var totalValues = initial_fund + totalCapitalValue;\r\n    frm.set_value('total_capital_addition', totalValues);\r\n    frm.set_value('total_rows', totalCapitalValue);\r\n}\r\n\r\n// Calculate total capital after withdrawal\r\nfunction calculatetotalCapitalAddition(frm) {\r\n    var total_withdraw_amount = frm.doc.total_withdraw_amount || 0;\r\n    var total_capital_addition = frm.doc.total_capital_addition || 0;\r\n    \r\n    var total = total_capital_addition - total_withdraw_amount;\r\n    frm.set_value('total1', total);\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Add Withdrawals",
  "enabled": 0,
  "modified": "2024-04-12 06:16:33.832034",
  "module": null,
  "name": "Addwithdrals",
  "script": "frappe.ui.form.on('Add Withdrawals', {\r\n\r\n    after_save: function(frm) {\r\n          frappe.route_options = {\r\n                // client_short_name: frm.doc.client_short_name,\r\n                // name1: frm.doc.name1,\r\n                // proposal_no: frm.doc.proposal_no,\r\n                // id: frm.doc.id\r\n                \r\n            };\r\n           \r\n            frm.save().then(() => {\r\n                \r\n                frappe.new_doc('Withdrawal');\r\n            });\r\n        }\r\n   \r\n\r\n    \r\n});\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "List of Securities Rigistered",
  "enabled": 1,
  "modified": "2024-04-12 18:18:54.326373",
  "module": null,
  "name": "List of Securities rigistered",
  "script": "frappe.ui.form.on('List of Securities Rigistered', {\n    display_results: function(frm) {\n        frappe.call({\n            method: \"frappe.client.get_list\",\n            args: {\n                doctype: \"Security\",\n                filters: { \"name1\": frm.doc.facility_holder },\n                fields: [\"name1\", \"facility_no\"]\n            },\n            callback: function(r) {\n                if (r.message) {\n                    var data1 = r.message;\n                    console.log(data1, \"First API Call Response\");\n \n                    // Call the second API inside the callback of the first API\n                    frappe.call({\n                        method: \"frappe.client.get\",\n                        args: {\n                            doctype: \"Security\",\n                            filters: {\n                                name1: frm.doc.facility_holder\n                            },\n                            fields: [\"link\"]\n                        },\n                        callback: function(r) {\n                            if (!r.exc && r.message && r.message.link) {\n                                var data2 = r.message.link;\n                                console.log(data2, \"Second API Call Response\");\n \n                                // Merge data from both API responses into a single row\n                                for (let x of data1) {\n                                    var child = frappe.model.add_child(frm.doc, \"result\");\n                                    var matchingData = data2.find(item => item.name1 === x.facility_holder);\n                                    if (matchingData) {\n                                        frappe.model.set_value(child.doctype, child.name, \"names_of_securities_holder\", x.name1);\n                                        frappe.model.set_value(child.doctype, child.name, \"facility_number\", x.facility_no);\n                                        frappe.model.set_value(child.doctype, child.name, \"type_of_security\", matchingData.securitytype);\n                                        frappe.model.set_value(child.doctype, child.name, \"description\", matchingData.details2);\n                                        frappe.model.set_value(child.doctype, child.name, \"value_of_property\", matchingData.security_value);\n                                        // Add more fields as needed\n                                    }\n                                }\n \n                                frm.refresh_fields();\n                            } else {\n                                console.error(\"Error occurred in second API call:\", r.exc);\n                            }\n                        }\n                    });\n                }\n            }\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Potential  Claim",
  "enabled": 0,
  "modified": "2024-04-11 12:38:11.560506",
  "module": "Finance",
  "name": "Potential Claim Script",
  "script": "frappe.ui.form.on('Potential Claim', {\n\trefresh(frm) {\n    \n\t    \n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Claim Register',\n                // filters: {\n                //      ph_name: ph_name\n                // },\n                fields: ['ph_name']\n            },\n            callback: function(r) {\n                console.log(r);\n                if (!r.exc) {\n                    if (r.message && r.message.length > 0) {\n                        var ph_names = r.message.map(entry => entry.ph_name);\n                        frm.set_df_property('ph_name', 'options', ph_names);\n                    }\n                } else {\n                    console.error(\"Error occurred:\", r.exc);\n                }\n            }\n        });\n        frappe.call({\n            method: 'frappe.client.get',\n            args: {\n                doctype: 'VAT',\n                filters: {\n                }\n            },\n            callback: function(r) {\n                if (r.message) {\n                    frm.set_value('vat', r.message.vat);\n                }\n            }\n        });\n    },\n    \n    \n    \n    \n    onload: function(frm) { \n    frappe.call({\n      method: 'frappe.client.get_list',\n      args: {\n        'doctype': 'Claim Register',\n        'filters': {\n          'workflow_state': 'Approved'\n        },\n        'fields': ['ph_name']\n      },\n      callback: function(submittedProposalsResponse) {\n        if (submittedProposalsResponse.message) {\n          var submittedProposals = submittedProposalsResponse.message.map(function(proposal) {\n            return proposal.ph_name;\n          });\n          console.log(\"** Submitted Proposals:\", submittedProposals);\n          console.log(\"** Fetching Approved Quotations **\");\n          frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n              'doctype': 'Potential Claim',\n              'filters': {\n                'workflow_state': 'Approved'\n              },\n              'fields': ['ph_name']\n            },\n            callback: function(approvedQuotationsResponse) {\n                console.log(approvedQuotationsResponse,\"approvedQuotationsResponse\")\n              if (approvedQuotationsResponse.message) {\n                var approvedQuotations = approvedQuotationsResponse.message.map(function(quotation) {\n                  return quotation.ph_name;\n                });\n                console.log(\"** Approved Quotations:\", approvedQuotations);\n                // Filter client names (include only proposals not in approved quotations)\n                var filteredPHName = submittedProposals.filter(function(proposal) {\n                  return !approvedQuotations.includes(proposal);\n                });\n                console.log(\"** Filtered PHName:\", filteredPHName);\n                  frm.set_df_property('ph_name', 'options', filteredPHName);\n\n              }\n            }\n          }); // Close inner frappe.call\n        }\n      }\n    }); // Close outer frappe.call\n \n    },\n//     buyer: function(frm) {\n//     // Get the values of ph_name, buyer, and policy_no\n//     var ph_name = frm.doc.ph_name;\n//     var buyer = frm.doc.buyer_name;\n//     var policy_no = frm.doc.policy_no;\n\n//     frappe.call({\n//         method: 'frappe.client.get_list',\n//         args: {\n//             doctype: 'Credit Limit Processing',\n//             filters: {\n//                 policy_holder_name: ph_name,\n//                 buyer_name: buyer,\n//                 policy_no: policy_no\n//             },\n//             fields: ['terms_of_payments', 'capture_date', 'credit_limit']\n//         },\n//         callback: function(response) {\n//             console.log(response);\n//             if (response.message && response.message.length > 0) {\n//                 var data_from_proposals = response.message[0];\n\n//                 // Populate fields if data is found\n//                 frm.set_value('terms_of_payment', data_from_proposals.terms_of_payments || '');\n//                 frm.set_value('cl_inception_date', data_from_proposals.capture_date || '');\n//                 frm.set_value('credit_limit', data_from_proposals.credit_limit || '');\n//             }\n//         }\n//     });\n// },\n\n// buyer: function(frm){\n//     frappe.call({\n//             method: 'frappe.client.get_list',\n//             args: {\n//                 doctype: 'Credit Limit Processing',\n//                 filters: {\n//                      policy_holder_name: ph_name,\n//                      buyer_name:buyer,\n//                      policy_no:policy_no\n//                 },\n//                 fields: ['terms_of_payments','capture_date','credit_limit']\n//             },\n//                 callback: function(response) {\n//                 console.log(response);\n             \n//                 if (response.message && response.message.length > 0) {\n//                     var data_from_proposals = response.message[0];\n \n//                     // Populate fields if data is found\n//                     frm.set_value('terms_of_payment', data_from_proposals.terms_of_payments || '');\n//                     frm.set_value('cl_inception_date', data_from_proposals.capture_date || '');\n//                     frm.set_value('credit_limit', data_from_proposals.credit_limit || '');\n                   \n                    \n                      \n//                 }\n//          }\n//         });\n//   },\n\n\n\n// ph_name: function(frm) {\n//         var ph_name = frm.doc.ph_name;\n \n//         // Fetch data from DCI Proposals based on selected client name\n//         frappe.call({\n//             method: 'frappe.client.get_list',\n//             args: {\n//                 doctype: 'Claim Register',\n//                 filters: {\n//                      ph_name: ph_name\n//                 },\n//                 fields: ['policy_no', 'date_of_claim', 'claim_reg_no','buyer']\n//             },\n//             callback: function(response) {\n//                 console.log(response)\n             \n//                 if (response.message && response.message.length > 0) {\n//                     var data_from_proposals = response.message[0];\n \n//                     // Populate fields if data is found\n//                     frm.set_value('policy_no', data_from_proposals.policy_no || '');\n//                     frm.set_value('inception_date', data_from_proposals.date_of_claim || '');\n//                     frm.set_value('caim_ref_no', data_from_proposals.claim_reg_no || '');\n//                     frm.set_value('buyer', data_from_proposals.buyer || '');\n                    \n                      \n//                 } else {\n//                     // Clear fields if no matching record found\n//                     frm.set_value('policy_no', '');\n//                     frm.set_value('claim_date', '');\n//                     frm.set_value('caim_ref_no', '');\n//                     frm.set_value('buyer', '');\n                    \n//                 }\n//             },\n//             error: function(err) {\n//                 console.error(err);\n//               // frappe.msgprint('An error occurred while fetching data from DCI Proposals. Please check the console for details.');\n//             }\n//         });\n//     },\n\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Potential Claims",
  "enabled": 1,
  "modified": "2025-12-08 08:32:55.630204",
  "module": "Finance",
  "name": "Potential claim",
  "script": "frappe.ui.form.on('Potential Claims', {\r\n    refresh: function(frm) {\r\n  frm.fields_dict.add_new.$input.addClass('btn-primary');\r\n\r\n        if (frm.is_new()) {\r\n            // If form is new, show policy_no and hide policy_no1\r\n            frm.toggle_display('policyno', true);\r\n            frm.toggle_display('policy_no', false);\r\n            \r\n            frm.toggle_display('buyer', true);\r\n            frm.toggle_display('buyer1', false);\r\n        } else {\r\n            // If form is saved, hide policy_no and show policy_no1\r\n            frm.toggle_display('buyer', false);\r\n            frm.toggle_display('buyer1', true);\r\n            \r\n            frm.toggle_display('policyno', false);\r\n            frm.toggle_display('policy_no', true);\r\n        }\r\n        frm.set_df_property('potential_claim_table', 'cannot_add_rows', true);\r\n        \r\n        \r\n        frm.fields_dict.claim_value.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.credit_limit.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.amount.$input.css(\"text-align\", \"right\");\r\n        \r\n        \r\n        \r\n        \r\n    },\r\n    \r\n\r\n    onload: function(frm) {\r\n        if (!frm.doc.claim_ref_no) {\r\n            generateNumber(frm);\r\n        }\r\n\r\n        fetchApprovedClaimRegisters(frm);\r\n        fetchBuyerNames(frm);\r\n        fetchVATDetails(frm);\r\n    },\r\n\r\n\r\n//  ph_name: function(frm) {\r\n//     if (frm.doc.ph_name) {\r\n//         frappe.call({\r\n//             method: 'frappe.client.get_list',\r\n//             args: {\r\n//                 doctype: 'Claim Register',\r\n//                 filters: { 'ph_name': frm.doc.ph_name },\r\n//                 fields: ['policy_no', 'buyer']\r\n//             },\r\n//             callback: function(r) {\r\n//                 if (r.message && r.message.length > 0) {\r\n\r\n//                     // Extract all policy numbers\r\n//                     let policies = r.message.map(x => x.policy_no);\r\n//                     let uniquePolicies = [...new Set(policies)];\r\n\r\n//                     // Extract all buyers\r\n//                     let buyers = r.message.map(x => x.buyer);\r\n//                     let uniqueBuyers = [...new Set(buyers)];\r\n\r\n//                     // Extract claim values (normally only 1)\r\n//                     let claimValue = r.message[0].claim_value || 0;\r\n\r\n//                     console.log(\"Unique Policies:\", uniquePolicies);\r\n//                     console.log(\"Unique Buyers:\", uniqueBuyers);\r\n//                     console.log(\"Claim Value:\", claimValue);\r\n\r\n//                     // --- Set Policy No Dropdown ---\r\n//                     frm.set_df_property('policyno', 'options', uniquePolicies.join('\\n'));\r\n\r\n//                     // Set first policy automatically\r\n//                     if (!frm.doc.policy_no && uniquePolicies.length > 0) {\r\n//                         frm.set_value('policy_no', uniquePolicies[0]);\r\n//                     }\r\n\r\n//                     frm.refresh_field('policy_no');\r\n\r\n//                     // --- Set Buyer Dropdown ---\r\n//                     frm.set_df_property('buyer', 'options', uniqueBuyers.join('\\n'));\r\n            \r\n\r\n//                     // --- Set Claim Value ---\r\n//                     frm.set_value('claim_value', claim_value);\r\n//                 }\r\n//             }\r\n//         });\r\n//     }\r\n// },\r\nph_name: function(frm) {\r\n\r\n    if (frm.doc.ph_name) {\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Claim Register',\r\n                filters: {\r\n                    ph_name: frm.doc.ph_name\r\n                },\r\n                fields: ['policy_no', 'buyer', 'claim_value'],\r\n                limit_page_length: 1   // \u2705 only latest record\r\n            },\r\n            callback: function(r) {\r\n\r\n                if (r.message && r.message.length > 0) {\r\n\r\n                    let row = r.message[0];\r\n\r\n                    let policies = [...new Set(r.message.map(x => x.policy_no).filter(Boolean))];\r\n                    let buyers   = [...new Set(r.message.map(x => x.buyer).filter(Boolean))];\r\n\r\n                    frm.set_df_property('policyno', 'options', policies.join('\\n'));\r\n                    frm.set_df_property('buyer', 'options', buyers.join('\\n'));\r\n\r\n                    // \u2705 FINAL & CORRECT\r\n                    frm.set_value('claim_value', row.claim_value || 0);\r\n\r\n                } else {\r\n                    frm.set_value('claim_value', 0);\r\n                }\r\n            }\r\n        });\r\n    }\r\n},\r\n\r\n\r\n\r\n    after_save: function(frm) {\r\n        // After saving, hide policy_no and show policy_no1\r\n        frm.toggle_display('policyno', false);\r\n        frm.toggle_display('policy_no', true);\r\n    },\r\n\r\n    policyno:function(frm) {\r\n        \r\n    \r\n        \r\n            frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Policy Approvals',\r\n            filters: {\r\n                policy_number: frm.doc.policyno\r\n            },\r\n            fields: ['policy_type', 'inception_date']\r\n        },\r\n\r\n        callback: function (response) {\r\n\r\n            let claimData = response.message && response.message.length > 0 \r\n                            ? response.message[0] \r\n                            : null;\r\n\r\n            if (claimData) {\r\n\r\n                // Check if Potential Claim already exists\r\n                frappe.call({\r\n                    method: 'frappe.client.get_list',\r\n                    args: {\r\n                        doctype: 'Potential Claims',\r\n                        filters: {\r\n                            policy_no: frm.doc.policyno\r\n                            // workflow_state: 'Approved'\r\n                        },\r\n                        fields: ['policyno']\r\n                    },\r\n\r\n                    callback: function (approvedResponse) {\r\n\r\n                        let alreadyApproved = approvedResponse.message && approvedResponse.message.length > 0;\r\n\r\n                        if (alreadyApproved) {\r\n                            frappe.msgprint('This Policy No is already approved.');\r\n                        } else {\r\n                            // Set fields when not approved before\r\n                            frm.set_value('client_type', claimData.policy_type);\r\n                            frm.set_value('inception_date', claimData.inception_date);\r\n                           \r\n                        }\r\n                    }\r\n                });\r\n\r\n            } else {\r\n                // No data found in Claim Register\r\n                frm.set_value('status', '');\r\n            }\r\n        }\r\n    });\r\n    },\r\n\r\n    buyer: function(frm) {\r\n      frm.set_value('buyer1', frm.doc.buyer);\r\n      fetchCreditLimitDetails(frm)\r\n    },\r\n    \r\n   add_new: function(frm) {\r\n        console.log(\"Add New Button Clicked\");\r\n        if (frm.doc.with_vat) {\r\n            updateAmtWithVat(frm);\r\n        }\r\n\r\n        exportDeclarations(frm);\r\n    },\r\n    credit_limit: function (frm) {\r\n        calculate_claim_value(frm);\r\n    },\r\n    vat: function (frm) {\r\n        calculate_claim_value(frm);\r\n    },\r\n});\r\n\r\nfunction generateNumber(frm) {\r\n    if (!frm.doc.claim_ref_no) {\r\n        let currentYear = new Date().getFullYear();\r\n        let prefix = `PCLM/${currentYear}/`;\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Potential Claims',\r\n                fields: ['claim_ref_no'],\r\n                order_by: 'creation desc',\r\n                limit: 1\r\n            },\r\n            callback: function(r) {\r\n                if (r.message && r.message.length > 0) {\r\n                    let lastClaimRefNo = r.message[0].claim_ref_no;\r\n                    let lastNumber = lastClaimRefNo ? parseInt(lastClaimRefNo.split(\"/\").pop()) : null;\r\n                    if (!isNaN(lastNumber)) {\r\n                        let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n                        frm.set_value('claim_ref_no', prefix + newNumber);\r\n                    }\r\n                } else {\r\n                    frm.set_value('claim_ref_no', prefix + '0001');\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\nfunction fetchApprovedClaimRegisters(frm) {\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Claim Register',\r\n            fields: ['ph_name'],\r\n            limit_page_length: 0\r\n        },\r\n        callback: function(response) {\r\n            console.log(\"ph_name received:\", response);\r\n            let DataArray = response.message;\r\n            let uniqueFacilityNos = new Set();\r\n \r\n            // Collect unique facility_no values\r\n            for (let x of DataArray) {\r\n                uniqueFacilityNos.add(x.ph_name);\r\n            }\r\n \r\n            // Convert set to array\r\n            let FinalArray = Array.from(uniqueFacilityNos);\r\n            \r\n            FinalArray.sort();\r\n \r\n            frm.set_df_property('ph_name', 'options', FinalArray);\r\n            console.log(\"final\", FinalArray);\r\n        },\r\n        error: function(xhr, textStatus, errorThrown) {\r\n            console.error(\"Error fetching ph_name:\", textStatus, errorThrown);\r\n        }\r\n    });\r\n   \r\n}\r\n\r\nfunction calculate_claim_value(frm) {\r\n    if (frm.doc.credit_limit && frm.doc.vat) {\r\n        let claim_value = Math.round((frm.doc.credit_limit * 100) / (100 + frm.doc.vat) * 100) / 100;\r\n        frm.set_value('claim_value', claim_value);\r\n    }\r\n}\r\n\r\n\r\nfunction fetchCreditLimitDetails(frm) {\r\n frappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Credit Limit Processing',\r\n        filters: {\r\n            buyer_name: frm.doc.buyer,\r\n            policy_number: frm.doc.policyno\r\n        },\r\n        fields: ['approved_amount', 'cl_review_date', 'estd_date'],\r\n        limit_page_length: 1\r\n    },\r\n    callback: function(response) {\r\n\r\n        if (response.message && response.message.length > 0) {\r\n            let data = response.message[0];\r\n\r\n            frm.set_value('credit_limit', data.approved_amount || 0);\r\n            frm.set_value('cl_expiry_date', data.cl_review_date || '');\r\n            frm.set_value('cl_inception_date', data.estd_date || '');\r\n        } else {\r\n            // Clear values if no matching record found\r\n            frm.set_value('credit_limit', 0);\r\n            frm.set_value('cl_expiry_date', '');\r\n            frm.set_value('cl_inception_date', '');\r\n        }\r\n    }\r\n});\r\n\r\n}\r\n\r\nfunction exportDeclarations(frm) {\r\n    console.log(\"Export Declarations Function Called\");\r\n    var type = frm.doc.type;\r\n    var invoice_no = frm.doc.invoice_no;\r\n    var date = frm.doc.date;\r\n    var amount = frm.doc.amount;\r\n    var with_vat = frm.doc.with_vat;\r\n    var without_vat = frm.doc.without_vat;\r\n\r\n    console.log(\"Type:\", type);\r\n    console.log(\"Invoice No:\", invoice_no);\r\n    console.log(\"Date:\", date);\r\n    console.log(\"Amount:\", amount);\r\n\r\n    if (!type || !date || !amount || !invoice_no) {\r\n        frappe.msgprint('Please fill all the required fields');\r\n        return;\r\n    }\r\n\r\n    // Calculate total OSAmt from existing rows\r\n    var existingOSAmt = (frm.doc.potential_claim_table || []).reduce((acc, row) => acc + row.os_amt, 0);\r\n\r\n    // Calculate OSAmt for the new row\r\n    var OSAmt = amount + existingOSAmt;\r\n\r\n    // Add a new row to the potential_claim_table\r\n    var child = frappe.model.add_child(frm.doc, \"Potential Claim Child\", \"potential_claim_table\");\r\n\r\n    frappe.model.set_value(child.doctype, child.name, \"type\", type);\r\n    frappe.model.set_value(child.doctype, child.name, \"date\", date);\r\n    frappe.model.set_value(child.doctype, child.name, \"amount\", amount);\r\n    frappe.model.set_value(child.doctype, child.name, \"balance\", amount);\r\n    frappe.model.set_value(child.doctype, child.name, \"invoice_no\", invoice_no);\r\n    frappe.model.set_value(child.doctype, child.name, \"os_amt\", OSAmt);\r\n\r\n    if (with_vat) {\r\n        var amt_wo_vat = ((amount * 100) / (100 + 14)).toFixed(2);\r\n        frappe.model.set_value(child.doctype, child.name, \"amt_wo_vat\", amt_wo_vat);\r\n    } else if (without_vat) {\r\n        frappe.model.set_value(child.doctype, child.name, \"amt_wo_vat\", amount);\r\n        frm.set_value('vat', 0);\r\n    }\r\n\r\n    frm.refresh_field('potential_claim_table');\r\n\r\n    update_statement_date(frm);\r\n    updateAmtWithVat(frm);\r\n\r\n    frm.set_value('type', '');\r\n    frm.set_value('date', '');\r\n    frm.set_value('amount', '');\r\n    frm.set_value('invoice_no', '');\r\n    frm.set_value('with_vat', 0);\r\n    frm.set_value('without_vat', 0);\r\n}\r\n\r\n\r\nfunction update_statement_date(frm) {\r\n    if (frm.doc.potential_claim_table) {\r\n        frm.doc.potential_claim_table.forEach(function(row) {\r\n            if (row.date) {\r\n                let date = new Date(row.date);\r\n                let endOfMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0);\r\n                let endOfMonthString = frappe.datetime.get_datetime_as_string(endOfMonth);\r\n                frappe.model.set_value(row.doctype, row.name, \"statement_date\", endOfMonthString);\r\n\r\n                let dueDate = new Date(endOfMonth);\r\n                dueDate.setDate(dueDate.getDate() + 30);\r\n                let dueDateString = frappe.datetime.get_datetime_as_string(dueDate);\r\n                frappe.model.set_value(row.doctype, row.name, \"due_date\", dueDateString);\r\n            }\r\n        });\r\n        frm.refresh_field('potential_claim_table');\r\n    }\r\n}\r\n\r\nfunction updateAmtWithVat(frm) {\r\n    if (frm.doc.potential_claim_table) {\r\n        frm.doc.potential_claim_table.forEach(function(row) {\r\n            if (row.amount) {\r\n                var amt_wo_vat;\r\n                \r\n                if (frm.doc.with_vat) {\r\n                    amt_wo_vat = ((row.amount * 100) / (100 + 15)).toFixed(2);\r\n                } else if (frm.doc.without_vat) {\r\n                    amt_wo_vat = row.amount;\r\n                }\r\n                frappe.model.set_value(row.doctype, row.name, \"amt_wo_vat\", amt_wo_vat);\r\n            }\r\n        });\r\n        frm.refresh_field('potential_claim_table');\r\n    }\r\n}\r\n\r\n// function updateAmtWithVat(frm) {\r\n//     if (frm.doc.potential_claim_table) {\r\n\r\n//         frm.doc.potential_claim_table.forEach(function(row) {\r\n\r\n//             if (row.amount) {\r\n//                 let amt_wo_vat;\r\n\r\n//                 // VAT from Parent\r\n//                 let vat_value = frm.doc.vat || 0;\r\n\r\n//                 if (frm.doc.with_vat === 1) {\r\n//                     amt_wo_vat = ((row.amount * 100) / (100 + vat_value)).toFixed(2);\r\n//                 } \r\n//                 else if (frm.doc.without_vat === 1) {\r\n//                     amt_wo_vat = row.amount;\r\n//                 } \r\n//                 else {\r\n//                     amt_wo_vat = row.amount; // default fallback\r\n//                 }\r\n\r\n//                 frappe.model.set_value(row.doctype, row.name, \"amt_wo_vat\", amt_wo_vat);\r\n//             }\r\n//         });\r\n\r\n//         frm.refresh_field('potential_claim_table');\r\n//     }\r\n// }\r\n\r\n\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Advance Premium Invoices",
  "enabled": 0,
  "modified": "2025-03-10 12:08:07.339632",
  "module": "Finance",
  "name": "Advance Premium  Invoice cs",
  "script": "frappe.ui.form.on('Advance Premium Invoice', {\r\n    // onload: function(frm) {\r\n    //     frappe.call({\r\n    //         method: \"frappe.client.get\",\r\n    //         args: {\r\n    //             doctype: \"Advance Premium\",\r\n    //             filters: {\r\n    //                 adv_premium_no: frm.doc.invoice_no,   // Ensure correct fieldname\r\n    //                 policy_no: frm.doc.policy_no          // Ensure correct fieldname\r\n    //             },\r\n    //             fields: [\"child_table\"]\r\n    //         },\r\n    //         callback: function (r) {\r\n    //             console.log(\"Fetched Advance Premium Data:\", r.message);\r\n\r\n    //             if (r.message && r.message.child_table && r.message.child_table.length > 0) {\r\n    //                 let data = r.message.child_table;\r\n\r\n    //                 // Clear the child table before adding new rows\r\n    //                 frm.clear_table(\"advance_premium_invoice_table\");\r\n\r\n    //                 for (let x of data) {\r\n    //                     let child = frm.add_child(\"advance_premium_invoice_table\");\r\n    //                     frappe.model.set_value(child.doctype, child.name, \"description\", x.description || \"\");\r\n    //                     frappe.model.set_value(child.doctype, child.name, \"quantity\", x.qty || 0);\r\n    //                     frappe.model.set_value(child.doctype, child.name, \"price\", x.price || 0);\r\n    //                     frappe.model.set_value(child.doctype, child.name, \"amount\", x.amount || 0);\r\n\r\n    //                     // Add more fields as needed\r\n    //                 }\r\n\r\n    //                 frm.refresh_fields(\"advance_premium_invoice_table\");\r\n    //                 console.log(\"Child Table Populated:\", data);\r\n    //             } else {\r\n    //                 console.warn(\"No matching child table data found.\");\r\n    //             }\r\n    //         }\r\n    //     });\r\n    // },\r\n\r\n    invoice_amount_without_vat: function(frm) {\r\n        console.log(\"Invoice Amount Without VAT (Before Calculation):\", frm.doc.invoice_amount_without_vat);\r\n\r\n        if (frm.doc.invoice_amount_without_vat && !isNaN(parseFloat(frm.doc.invoice_amount_without_vat))) {\r\n            // Perform VAT calculation\r\n            let vat_percentage = 14 / 100;\r\n            let vat_amount = frm.doc.invoice_amount_without_vat * vat_percentage;\r\n            let invoice_amount = parseFloat(frm.doc.invoice_amount_without_vat) + vat_amount;\r\n\r\n            // Set the calculated value to \"invoice_amount\" field\r\n            frm.set_value(\"invoice_amount\", invoice_amount.toFixed(2)); // Format to 2 decimal places\r\n\r\n            console.log(\"Calculated Invoice Amount (After VAT):\", invoice_amount);\r\n        } else {\r\n            console.warn(\"Invalid Invoice Amount Without VAT\");\r\n            frm.set_value(\"invoice_amount\", 0); // Default to 0 if input is invalid\r\n        }\r\n\r\n        frm.refresh_field(\"invoice_amount\");\r\n    }\r\n});\r\n\r\n            \r\n    // onload: function(frm) {\r\n    //   frm.set_df_property('advance_premium_invoice_table','cannot_add_rows', true);\r\n\r\n    //     // Fetch approved policy holders from Advance Premium\r\n    //     // frappe.call({\r\n    //     //     method: 'frappe.client.get_list',\r\n    //     //     args: {\r\n    //     //         doctype: 'Advance Premium',\r\n    //     //         filters: {\r\n    //     //             workflow_state: 'Approved'\r\n    //     //         },\r\n    //     //       fields: ['estimated_premium', 'premium_rate', 'total_amount', 'policy_no', 'estimated_turnover_for_year', 'vat', 'payment_month_and_year', 'year', 'noof_months_for_the_purpose', 'payment_type', 'quartely_premium_value', 'comments', 'monthly_premium_value', 'half_yearly_premium_value', 'yearly_premium_value']\r\n    //     //         // fields: ['policy_holder', 'estimated_premium', 'premium_rate', 'total_amount', 'policy_no', 'estimated_turnover_for_year', 'vat', 'payment_month_and_year', 'year', 'noof_months_for_the_purpose', 'payment_type', 'quartely_premium_value', 'comments', 'monthly_premium_value', 'half_yearly_premium_value', 'yearly_premium_value']\r\n    //     //     },\r\n    //     //     callback: function(response) {\r\n    //     //         if (response.message) {\r\n    //     //             var approvedPolicyHolders = response.message.map(function(AdvancePremium) {\r\n    //     //                 return AdvancePremium.policy_holder;\r\n    //     //             });\r\n    //     //             frm.set_df_property('policy_holder', 'options', approvedPolicyHolders);\r\n    //     //         }\r\n    //     //     }\r\n    //     // });\r\n\r\n    //     // if (frm.doc.__islocal) {\r\n    //     //     fetchAndFilterPolicyHolders(frm);\r\n    //     // }\r\n\r\n    //     // Add a custom button to add rows to the first column\r\n    // },\r\n    // policy_no:function(frm) {\r\n    //     console.log(\"policy number:\", policy_no);\r\n        // if(!frm.doc.invoice_no) {\r\n        //     return;\r\n        // }\r\n        \r\n    //  frappe.call({\r\n    //         method: \"frappe.client.get\",\r\n    //         args: {\r\n    //             doctype: \"Advance Premium\",\r\n    //             filters: {\r\n    //              adv_premium_no: frm.doc.invoice_no,\r\n    //              policy_no1: frm.doc.policy_no\r\n    //             },\r\n    //             fields: [\"child_table\"]\r\n    //         },\r\n    //         callback: function (r) {\r\n    //              console.log(\"Fetched Advance Premium Data:\", r.message);\r\n\r\n    //             if (r.message && r.message.child_table) {\r\n    //                 var data = r.message.child_table;\r\n\r\n    //                 // Clear the child table before adding new rows\r\n    //                 frm.clear_table('advance_premium_invoice_table');\r\n\r\n    //                 for (let x of data) {\r\n    //                     let child = frm.add_child(\"advance_premium_invoice_table\");\r\n    //                     frappe.model.set_value(child.doctype, child.name, \"description\", x.description || \"\");\r\n    //                     frappe.model.set_value(child.doctype, child.name, \"quantity\", x.qty || 0);\r\n    //                      frappe.model.set_value(child.doctype, child.name, \"price\", x.price || 0);\r\n    //                       frappe.model.set_value(child.doctype, child.name, \"amount\", x.amount || 0);\r\n\r\n    //                     // Add more fields as needed\r\n    //                 }\r\n\r\n    //                 frm.refresh_fields('advance_premium_invoice_table');\r\n    //               console.log(\"Child Table Populated:\", data);\r\n    //             } else {\r\n    //                 console.error(\"Error occurred in DCI Proposals data:\", r.exc);\r\n    //             }\r\n    //         }\r\n    //     });\r\n    \r\n    \r\n    \r\n//     frappe.call({\r\n//     method: \"frappe.client.get\",\r\n//     args: {\r\n//         doctype: \"Advance Premium\",\r\n//         filters: {\r\n//             adv_premium_no: frm.doc.invoice_no,   // Ensure correct fieldname\r\n//             policy_no: frm.doc.policy_no          // Ensure correct fieldname\r\n//         },\r\n//         fields: [\"child_table\"]\r\n        \r\n//     },\r\n//     callback: function (r) {\r\n//         console.log(\"Fetched Advance Premium Data:\", r.message);\r\n\r\n//         if (r.message && r.message.child_table && r.message.child_table.length > 0) {\r\n//             let data = r.message.child_table;\r\n\r\n//             // Clear the child table before adding new rows\r\n//             frm.clear_table(\"advance_premium_invoice_table\");\r\n\r\n//             for (let x of data) {\r\n//                 let child = frm.add_child(\"advance_premium_invoice_table\");\r\n//                 frappe.model.set_value(child.doctype, child.name, \"description\", x.description || \"\");\r\n//                 frappe.model.set_value(child.doctype, child.name, \"quantity\", x.qty || 0);\r\n//                 frappe.model.set_value(child.doctype, child.name, \"price\", x.price || 0);\r\n//                 frappe.model.set_value(child.doctype, child.name, \"amount\", x.amount || 0);\r\n\r\n//                 // Add more fields as needed\r\n//             }\r\n\r\n//             frm.refresh_fields(\"advance_premium_invoice_table\");\r\n//             console.log(\"Child Table Populated:\", data);\r\n//         } else {\r\n//             console.warn(\"No matching child table data found.\");\r\n//         }\r\n//     }\r\n// });\r\n//     },\r\n//     invoice_amount_without_vat: function(frm) {\r\n//         if (frm.doc.invoice_amount_without_vat) {\r\n//             // Perform the VAT calculation\r\n//             let vat_percentage = 14 / 100;\r\n//             let invoice_amount = frm.doc.invoice_amount_without_vat * (1 + vat_percentage);\r\n            \r\n//             // Set the calculated value to \"invoice_amount\" field\r\n//             frm.set_value(\"invoice_amount\", invoice_amount);\r\n\r\n//             // Refresh the field to show updated value\r\n//             frm.refresh_field(\"invoice_amount\");\r\n//         }\r\n//     }\r\n\r\n    // policy_holder: function(frm) {\r\n    //     var policyHolder = frm.doc.policy_holder;\r\n\r\n    //     frappe.call({\r\n    //         method: 'frappe.client.get_list',\r\n    //         args: {\r\n    //             doctype: 'Advance Premium',\r\n    //             filters: {\r\n    //                 policy_holder: policyHolder,\r\n    //                 workflow_state: 'Approved'\r\n    //             },\r\n    //             fields: ['policy_holder','advance_premium', 'estimated_premium', 'premium_rate', 'total_amount', 'policy_no', 'estimated_turnover_for_year', 'vat', 'payment_month_and_year', 'year', 'noof_months_for_the_purpose', 'payment_type', 'quartely_premium_value', 'comments', 'monthly_premium_value', 'half_yearly_premium_value', 'yearly_premium_value']\r\n    //         },\r\n    //         callback: function(response) {\r\n    //             if (response.message && response.message.length > 0) {\r\n    //                 var data_from_AdvancePremium = response.message[0];\r\n\r\n    //                 // Populate fields if data is found\r\n    //                 frm.set_value('premium_amount', data_from_AdvancePremium.estimated_premium || '');\r\n    //                 frm.set_value('premium_rate', data_from_AdvancePremium.premium_rate || '');\r\n    //                 frm.set_value('total_amount', data_from_AdvancePremium.advance_premium || '');\r\n    //                 frm.set_value('invoice_amount_without_vat', data_from_AdvancePremium.total_amount || '');\r\n    //                 frm.set_value('policy_no', data_from_AdvancePremium.policy_no || '');\r\n    //                 frm.set_value('estimated_turnover_for_year', data_from_AdvancePremium.estimated_turnover_for_year || '');\r\n    //                 frm.set_value('vat', data_from_AdvancePremium.vat || '');\r\n    //                 frm.set_value('payment_month', data_from_AdvancePremium.payment_month_and_year || '');\r\n    //                 frm.set_value('payment_year', data_from_AdvancePremium.year || '');\r\n    //                 frm.set_value('no_of_months_for_the_purpose', data_from_AdvancePremium.noof_months_for_the_purpose || '');\r\n    //                 frm.set_value('payment_type', data_from_AdvancePremium.payment_type || '');\r\n    //                 frm.set_value('quarterly_premium_value', data_from_AdvancePremium.quartely_premium_value || '');\r\n    //                 frm.set_value('comments', data_from_AdvancePremium.comments || '');\r\n    //                 frm.set_value('monthly_premium_value', data_from_AdvancePremium.monthly_premium_value || '');\r\n    //                 frm.set_value('half_yearly_premium_value', data_from_AdvancePremium.half_yearly_premium_value || '');\r\n    //                 frm.set_value('yearly_premium_value', data_from_AdvancePremium.yearly_premium_value || '');\r\n\r\n    //                 // Calculate the invoice amount\r\n    //                 var invoice_amount_without_vat = data_from_AdvancePremium.total_amount || 0;\r\n    //                 var vat = data_from_AdvancePremium.vat || 0;\r\n    //                 var invoice_amount = parseFloat(invoice_amount_without_vat) + (parseFloat(invoice_amount_without_vat) * parseFloat(vat) / 100);\r\n    //                 frm.set_value('invoice_amount', invoice_amount);\r\n\r\n    //                 // Refresh the form after setting values\r\n    //                 frm.refresh();\r\n    //             }\r\n    //         },\r\n    //     });\r\n    // },\r\n\r\n    // payment_type: function(frm) {\r\n    //     var paymentType = frm.doc.payment_type;\r\n\r\n    //     // Function to show or hide fields based on payment type\r\n    //     showHideFieldsBasedOnPaymentType(frm, paymentType);\r\n    // },\r\n    \r\n    \r\n//     invoice_no: function(frm){\r\n// \t\t frappe.call({\r\n//             method: \"frappe.client.get\",\r\n//             args: {\r\n//                 doctype: \"Advance Premium\",\r\n//                 filters: {\r\n//                      policy_holder: frm.doc.policy_holder\r\n//                 },\r\n//                 fields: [\"child_table\"]\r\n//             },\r\n//             callback: function (r) {\r\n\r\n//                 if (!r.exc) {\r\n//                     var data = r.message.child_table;\r\n\r\n//                     // Clear the child table before adding new rows\r\n//                     frm.clear_table('advance_premium_invoice_table');\r\n\r\n//                     for (let x of data) {\r\n//                         var child = frappe.model.add_child(frm.doc, \"Advance premium Invoice Child\", \"advance_premium_invoice_table\");\r\n//                         frappe.model.set_value(child.doctype, child.name, \"description\", x.description);\r\n//                         frappe.model.set_value(child.doctype, child.name, \"quantity\", x.qty);\r\n//                         frappe.model.set_value(child.doctype, child.name, \"price\", x.price);\r\n//                         frappe.model.set_value(child.doctype, child.name, \"amount\", x.amount);\r\n                        \r\n//                         // Add more fields as needed\r\n//                     }\r\n\r\n//                     frm.refresh_fields('advance_premium_invoice_table');\r\n//                     console.log(data);\r\n//                 } else {\r\n//                     console.error(\"Error occurred in Advance Premium  data:\", r.exc);\r\n//                 }\r\n//             }\r\n//         });\r\n\t\t\r\n// \t}\r\n\r\n    \r\n//});\r\n\r\n// Function to show or hide fields based on payment type\r\n// function showHideFieldsBasedOnPaymentType(frm, paymentType) {\r\n//     if (paymentType === 'Monthly') {\r\n//         // Show fields relevant to monthly payment\r\n//         frm.toggle_display(['monthly_premium_value'], true);\r\n//         frm.toggle_display(['quarterly_premium_value', 'half_yearly_premium_value', 'yearly_premium_value'], false);\r\n//     } else if (paymentType === 'Quarterly') {\r\n//         // Show fields relevant to quarterly payment\r\n//         frm.toggle_display(['quarterly_premium_value'], true);\r\n//         frm.toggle_display(['monthly_premium_value', 'half_yearly_premium_value', 'yearly_premium_value'], false);\r\n//     } else if (paymentType === 'Half Yearly') {\r\n//         // Show fields relevant to half yearly payment\r\n//         frm.toggle_display(['half_yearly_premium_value'], true);\r\n//         frm.toggle_display(['monthly_premium_value', 'quarterly_premium_value', 'yearly_premium_value'], false);\r\n//     } else if (paymentType === 'Yearly') {\r\n//         // Show fields relevant to yearly payment\r\n//         frm.toggle_display(['yearly_premium_value'], true);\r\n//         frm.toggle_display(['monthly_premium_value', 'quarterly_premium_value', 'half_yearly_premium_value'], false);\r\n//     } else {\r\n//         // Hide all fields if payment type is not recognized\r\n//         frm.toggle_display(['monthly_premium_value', 'quarterly_premium_value', 'half_yearly_premium_value', 'yearly_premium_value'], false);\r\n//     }\r\n// }\r\n\r\n// function fetchAndFilterPolicyHolders(frm) {\r\n//     frappe.call({\r\n//         method: 'frappe.client.get_list',\r\n//         args: {\r\n//             doctype: 'Advance Premium Invoice',\r\n//             filters: {\r\n//                 workflow_state: 'Approved'\r\n//             },\r\n//             fields: ['policy_holder']\r\n//         },\r\n//         callback: function(response) {\r\n//             if (response && response.message) {\r\n//                 var approvedPolicyHolders = response.message.map(function(holder) {\r\n//                     return holder.policy_holder;\r\n//                 });\r\n\r\n//                 var policyHolderField = frm.fields_dict['policy_holder'];\r\n\r\n//                 if (policyHolderField) {\r\n//                     policyHolderField.df.options = policyHolderField.df.options.filter(function(policyHolder) {\r\n//                         return approvedPolicyHolders.indexOf(policyHolder) === -1;\r\n//                     });\r\n//                     policyHolderField.refresh();\r\n//                 }\r\n//             } else {\r\n//                 console.error('Error fetching approved policy holders from Advance Premium.');\r\n//             }\r\n//         },\r\n//         error: function(xhr, textStatus, errorThrown) {\r\n//             console.error('Error:', errorThrown);\r\n//         }\r\n//     });\r\n// }\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "CB Request",
  "enabled": 1,
  "modified": "2025-12-03 12:24:06.127959",
  "module": "UnderWriting",
  "name": "CB Request",
  "script": "frappe.ui.form.on('CB Request', {\n\trefresh(frm) {\n\t    \n\t    frm.fields_dict.amount_required.$input.css(\"text-align\", \"right\");\n\t \n\tfrm.fields_dict.cancel.$input.addClass('btn-primary');\n        // CASE 1: New document \u2192 show Save button\n        if (frm.is_new()) {\n            frm.enable_save();\n            setTimeout(() => {\n                frm.page.btn_primary.show();   // Show Save button\n            }, 50);\n        }\n        // CASE 2: Existing document \u2192 hide Save button\n        else {\n            frm.disable_save();\n            setTimeout(() => {\n                frm.page.btn_primary.hide();   // Hide Save\n                $('button[data-label=\"Save\"]').hide(); // Hide in menu\n            }, 50);\n        }\n\t},\ncancel(frm) {\n\n    \tif (!frm.doc.policy_holder) return;\n\n    \t// \u2b50 NEW REQUIREMENT:\n    \t// Save CB Request FIRST then go to next page\n    \tfrappe.validated = false;\n\n    \tfrm.save().then(() => {\n\n    \t    // After saving \u2192 go to next DocType (example: CB Approval)\n    \t    frappe.new_doc(\"Credit Limit Processing\");\n\n    \t});\n\t},\n \n\tonload: function(frm) {\n    if (!frm.doc.cb_request_number) {\n            generateNumber(frm);\n        }\n}\n});\n\n\nfunction generateNumber(frm) {\n    // Check if the proposal number field is already populated\n    if (!frm.doc.cb_request_number) {\n        // Get the current year\n        let currentYear = new Date().getFullYear();\n        let prefix = `CBR/${currentYear}/`;\n\n        // Make a call to get the last number asynchronously\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'CB Request',\n                fields: ['cb_request_number', 'creation'],\n                order_by: 'creation desc',\n                limit: 1\n            },\n            callback: function(r) {\n                console.log(r,\"proposal no\");\n                if (r.message && r.message.length > 0) {\n                    let lastProposalNo = r.message[0].cb_request_number;\n                    let lastNumber = parseInt(lastProposalNo.split(\"/\").pop()); // Extract last part and parse it as integer\n                    if (!isNaN(lastNumber)) {\n                        // Increment the last number and pad it with leading zeros\n                        let newNumber = (lastNumber + 1).toString().padStart(4, '0');\n                        frm.set_value('cb_request_number', prefix + newNumber);\n                    }\n                } else {\n                    // If no previous numbers exist, set to default '0001'\n                    frm.set_value('cb_request_number', prefix + '0001');\n                }\n            }\n        });\n    }\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Deputy Sheriff Bond",
  "enabled": 1,
  "modified": "2025-12-04 03:28:24.300326",
  "module": "UnderWriting",
  "name": "Bond Sheriff",
  "script": "frappe.ui.form.on('Deputy Sheriff Bond', {\n    \n    refresh(frm) {\n        // Align number fields to right\n        frm.fields_dict.bond_value.$input.css(\"text-align\", \"right\");\n        frm.fields_dict.premium_without_vat.$input.css(\"text-align\", \"right\");\n        frm.fields_dict.ecgc_reinsurance_commission.$input.css(\"text-align\", \"right\");\n        frm.fields_dict.premium.$input.css(\"text-align\", \"right\");\n        frm.fields_dict.premium_rate.$input.css(\"text-align\", \"right\");\n        frm.fields_dict.reinsurer_rate.$input.css(\"text-align\", \"right\");\n\n        // Generate bond number if not present\n        if (!frm.doc.bond_no) {\n            generateBondNumber(frm);\n        }\n\n         var workflowState = frm.doc.workflow_state;\n\n        // Add Prepare Invoice button if Approved\n        if (workflowState === \"Approved\") {\n            frm.add_custom_button(__('Prepare Invoice'), function () {\n\n                let bond_no = frm.doc.bond_no;\n\n                // 1\ufe0f\u20e3 Check if Prepare Invoice already exists\n                frappe.call({\n                    method: \"frappe.client.get_list\",\n                    args: {\n                        doctype: \"Prepare Invoice\",\n                        filters: {\n                            credsure_refno: bond_no\n                        },\n                        fields: [\"name\"],\n                        limit_page_length: 1\n                    },\n                    callback: function(res) {\n\n                        if (res.message && res.message.length > 0) {\n                            // \u2714 Existing record found \u2192 open it\n                            frappe.set_route(\"Form\", \"Prepare Invoice\", res.message[0].name);\n                        } \n                        else {\n                            // \u2714 No record \u2192 create new one\n                            frappe.route_options = {\n                                credsure_refno: frm.doc.bond_no,\n                                broker: frm.doc.broker\n                            };\n                            frappe.new_doc(\"Prepare Invoice\");\n                        }\n                    }\n                });\n\n            }).addClass(\"btn-primary\");\n        }\n    },\n\n});\n\n\n\n// ===============================================================\n// Prepare Invoice Doctype Script\n// ===============================================================\n\n\n\n//Automatic generation of bondno)\n// function generateBondNumber(frm) {\n//     // Check if the proposal number field is already populated\n//     if (!frm.doc.bond_no) {\n//         // Get the current year\n//         let currentYear = new Date().getFullYear();\n//         let prefix = `BND/${currentYear}/`;\n\n//         // Make a call to get the last number asynchronously\n//         frappe.call({\n//             method: 'frappe.client.get_list',\n//             args: {\n//                 doctype: 'Deputy Sheriff Bond',\n//                 fields: ['bond_no', 'creation'],\n//                 order_by: 'creation desc',\n//                 limit: 1\n//             },\n//             callback: function(r) {\n//                 console.log(r,\"proposal no\");\n//                 if (r.message && r.message.length > 0) {\n//                     let lastProposalNo = r.message[0].bond_no;\n//                     let lastNumber = parseInt(lastProposalNo.split(\"/\").pop()); // Extract last part and parse it as integer\n//                     if (!isNaN(lastNumber)) {\n//                         // Increment the last number and pad it with leading zeros\n//                         let newNumber = (lastNumber + 1).toString().padStart(4, '0');\n//                         frm.set_value('bond_no', prefix + newNumber);\n//                     }\n//                 } else {\n//                     // If no previous numbers exist, set to default '0001'\n//                     frm.set_value('bond_no', prefix + '0001');\n//                 }\n//             }\n//         });\n//     }\n// }\nfunction generateBondNumber(frm) {\n    // Check if the bond number field is already populated\n    if (!frm.doc.bond_no) {\n        // Get the current year\n        let currentYear = new Date().getFullYear();\n        let prefix = `BND/${currentYear}/`;\n\n        // Make a call to get the last bond number asynchronously\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Bond Application',\n                fields: ['bond_no'],\n                limit: 1,\n                order_by: 'creation desc'\n            },\n            callback: function(response) {\n                console.log(response, \"bond no\");\n                let lastBondNo = response.message && response.message.length > 0 ? response.message[0].bond_no : '0';\n                let lastNumber = parseInt(lastBondNo.split(\"/\").pop()); // Extract last part and parse it as integer\n\n                // Make a call to get the last deputy sheriff bond number asynchronously\n                frappe.call({\n                    method: 'frappe.client.get_list',\n                    args: {\n                        doctype: 'Deputy Sheriff Bond',\n                        fields: ['bond_no'],\n                        limit: 1,\n                        order_by: 'creation desc'\n                    },\n                    callback: function(response) {\n                        console.log(response, \"deputy sheriff bond no\");\n                        let lastDeputySheriffBondNo = response.message && response.message.length > 0 ? response.message[0].bond_no : '0';\n                        let lastDeputySheriffBondNumber = parseInt(lastDeputySheriffBondNo.split(\"/\").pop());\n\n                        // Get the maximum of the two last bond numbers\n                        let maxLastNumber = Math.max(lastNumber, lastDeputySheriffBondNumber);\n\n                        if (!isNaN(maxLastNumber)) {\n                            // Increment the last number and pad it with leading zeros\n                            let newNumber = (maxLastNumber + 1).toString().padStart(4, '0');\n                            frm.set_value('bond_no', prefix + newNumber);\n                        } else {\n                            // If no previous numbers exist, set to default '0001'\n                            frm.set_value('bond_no', prefix + '0001');\n                        }\n                    }\n                });\n            }\n        });\n    }\n}\n\n\n\nfunction calculatepremiumwithoutvat(frm) {\n\n   \n\n    var premium = frm.doc.premium || 0; // Get the value of field2, default to 0 if empty\n\n    var result = (premium/1.1); // Calculate the result\n \n    frm.set_value('premium_without_vat', result); // Set the calculated result to result_field\n    \n}\n\n\nfunction calculateResults(frm) {\n    \n    var bondvalue = frm.doc.bond_value || 0; // Get the value of field1, default to 0 if empty\n\n    var premiumwithoutvat = frm.doc.premium_without_vat || 0; // Get the value of field1, default to 0 if empty\n\n    var results = (premiumwithoutvat * 100)/bondvalue; // Calculate the results\n \n    frm.set_value('premium_rate', results); // Set the calculated result to result_field\n    \n}\n\n\n//Deputy Sheriff month calculation code\nfunction calculateMonths(frm) {\n    console.log('calculateMonths function called');\n    var from_date = frm.doc.bond_period_from;\n    var to_date = frm.doc.bond_period_to;\n \n    console.log('from_date:', from_date);\n    console.log('to_date:', to_date);\n \n    if (from_date && to_date) {\n        var from_date_obj = frappe.datetime.str_to_obj(from_date);\n        var to_date_obj = frappe.datetime.str_to_obj(to_date);\n \n        var monthsDiff = (to_date_obj.getFullYear() - from_date_obj.getFullYear()) * 12;\n        monthsDiff -= from_date_obj.getMonth();\n        monthsDiff += to_date_obj.getMonth();\n        console.log('Months difference:', monthsDiff);\n        frm.set_value('month', monthsDiff);\n    } else {\n        console.log('One or both dates are empty');\n        frm.set_value('month', '');\n    }\n}\nfrappe.ui.form.on('Prepare Invoice', {\n\n    refresh: function (frm) {\n        calculateMonths(frm);\n\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Deputy Sheriff Bond',\n                filters: {\n                    bond_no: frm.doc.credsure_refno\n                },\n                fields: [\n                    'period_to',\n                    'period_from',\n                    'bond_value',\n                    'reinsurer_ref_numbeecgc_invoice_no',\n                    'premium_without_vat',\n                    'premium_rate',\n                    'reinsurer',\n                    'premium',\n                    'reinsurer_rate',\n                    'ecgc_reinsurance_commission',\n                    'sheriff_name'\n                ]\n            },\n\n            callback: function (r) {\n                if (!r.exc && r.message && r.message.length > 0) {\n\n                    var bondApp = r.message[0];\n\n                    frm.set_value('bond_period_from', bondApp.period_from);\n                    frm.set_value('bond_period_to', bondApp.period_to);\n                    frm.set_value('guarantee_amount', bondApp.bond_value);\n                    frm.set_value('reinsurer_refnumber', bondApp.reinsurer_ref_numbeecgc_invoice_no);\n                    frm.set_value('total_duewith_out_vat', Number(bondApp.premium_without_vat).toFixed(2));\n                    frm.set_value('guarantee_fee_rate', Number(bondApp.premium_rate).toFixed(2));\n                    frm.set_value('credsure_commission', Number(bondApp.ecgc_reinsurance_commission).toFixed(2));\n                    frm.set_value('brokers', 10);\n                    frm.set_value('reinsure', bondApp.reinsurer);\n                    frm.set_value('guarantee_fee', bondApp.premium);\n                    frm.set_value('reinsurer', bondApp.reinsurer_rate);\n                    frm.set_value('client', bondApp.sheriff_name);\n\n                    frm.set_value('principal', \"High Court\");\n                    frm.set_value('bond_type', \"Deputy Sheriff Bond\");\n\n                    // \ud83d\udc49 VAT = premium \u2212 premium_without_vat\n                    let premium = Number(bondApp.premium) || 0;\n                    let premium_without_vat = Number(bondApp.premium_without_vat) || 0;\n\n                    let v_at = premium - premium_without_vat;\n\n                    frm.set_value('v_at', v_at.toFixed(2));\n                }\n            }\n        });\n    },\n\n    bond_period_from: function(frm){\n        calculateMonths(frm);\n    },\n\n    bond_period_to: function(frm){\n        calculateMonths(frm);\n    \n    },\n\n\n\n\n\n\n\n\n\n\n\n   \n\tadd_new:function(frm){\n\t    \n\t     frappe.new_doc('DeputySheriffBond');\n\t    \n\t},\n\t\n\tbond_no: function(frm) {\n        if (frm.doc.bond_no) {\n            frm.set_value('reinsurer_ref_numbeecgc_invoice_no', frm.doc.bond_no);\n        } else {\n            frm.set_value('reinsurer_ref_numbeecgc_invoice_no', '');\n        }\n    },\n    \n    bond_value: function(frm) {\n\n        calculateResults(frm);\n\n    },\n\n    premium: function(frm) {\n\n        calculatepremiumwithoutvat(frm);\n\n    },\n    \n    premium_without_vat: function(frm) {\n\n        calculateResults(frm);\n\n    },\n\n\t\n\t\n})\n// function calculateMonths(frm) {\n//     let from_date = frm.doc.bond_period_from;\n//     let to_date = frm.doc.bond_period_to;\n\n//     if (from_date && to_date) {\n//         let from = frappe.datetime.str_to_obj(from_date);\n//         let to = frappe.datetime.str_to_obj(to_date);\n\n//         let monthsDiff = (to.getFullYear() - from.getFullYear()) * 12 + (to.getMonth() - from.getMonth());\n//         if (to.getDate() >= from.getDate()) monthsDiff += 1;\n\n//         frm.set_value('month', monthsDiff);\n//         frm.refresh_field('month');\n//     } else {\n//         frm.set_value('month', '');\n//     }\n// }\n\n// // List of field names to align right\n// let fieldsToAlignRight = ['bond_value', 'premium_without_vat', 'ecgc_reinsurance_commission','premium','premium_rate','reinsurer_rate'];\n\n// // Function to apply the styles\n// function alignFieldsRight(frm, fields) {\n//     fields.forEach(field => {\n//         let fieldElement = frm.fields_dict[field];\n//         if (fieldElement && fieldElement.input) {\n//             fieldElement.input.style.direction = 'rtl';\n//             fieldElement.input.style.textAlign = 'right';\n//         }\n//     });\n//}\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Receipt",
  "enabled": 1,
  "modified": "2025-12-08 13:46:55.922531",
  "module": "Finance",
  "name": "Receipt",
  "script": "frappe.ui.form.on('Receipt', {\r\n\r\n    refresh(frm) {\r\n        let rightAlignFields = [\r\n            \"depositamt\", \"totaldeduction\", \"depositbalance\", \"receiptamt\",\r\n            \"deductamt\", \"invoicebalanceamt\", \"no\", \"invoice_amt\"\r\n        ];\r\n\r\n        rightAlignFields.forEach(f => {\r\n            if (frm.fields_dict[f] && frm.fields_dict[f].$input) {\r\n                frm.fields_dict[f].$input.css(\"text-align\", \"right\");\r\n            }\r\n        });\r\n    },\r\n\r\n    onload(frm) {\r\n\r\n        // Only assign new number for unsaved records\r\n        if (frm.is_new()) {\r\n            if (!frm.doc.receiptno) generateNumber(frm);\r\n            frm.set_df_property('receiptno', 'reqd', 1);\r\n        }\r\n\r\n        toggle_client_fields(frm);\r\n\r\n    \r\n    },\r\n\r\n    reference(frm) {\r\n        let reference = frm.doc.reference || \"\";\r\n\r\n        // Reset fields ONLY for new/unsaved records (prevents dirty state)\r\n        if (frm.is_new()) {\r\n            frm.set_value('client', '');\r\n            frm.set_value('policyno', '');\r\n            frm.set_value('policy_number', '');\r\n        }\r\n\r\n        const fieldList = ['deduct_from_deposit', 'invoicebalanceamt', 'yes', 'no1'];\r\n\r\n        // -----------------------------\r\n        // A) ADVANCE PREMIUM\r\n        // -----------------------------\r\n        if (reference === \"Advance Premium\") {\r\n\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Advance Premium',\r\n                    fields: ['policy_holder'],\r\n                    filters: { workflow_state: \"Approved\" },\r\n                    limit_page_length: 0\r\n                },\r\n                callback(res) {\r\n                    let list = [...new Set((res.message || []).map(r => r.policy_holder))].sort();\r\n                    frm.set_df_property('client', 'options', list.join(\"\\n\"));\r\n                }\r\n            });\r\n\r\n            frm.toggle_display(fieldList, false);\r\n        }\r\n\r\n        // -----------------------------\r\n        // B) INVOICE\r\n        // -----------------------------\r\n        else if (reference === \"Invoice\") {\r\n\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'CI Invoices',\r\n                    fields: ['policy_holder'],\r\n                    limit_page_length: 0\r\n                },\r\n                callback(res) {\r\n                    let list = [...new Set((res.message || []).map(r => r.policy_holder))].sort();\r\n                    frm.set_df_property('client', 'options', list.join(\"\\n\"));\r\n                }\r\n            });\r\n\r\n            frm.toggle_display(fieldList, true);\r\n        }\r\n\r\n        // -----------------------------\r\n        // C) PREPAYMENT / PREMIUM DEPOSITE\r\n        // -----------------------------\r\n        else if (reference === \"PrePayment\" || reference === \"Premium Deposite\") {\r\n\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Bond Invoice',\r\n                    fields: ['facility_name'],\r\n                    limit_page_length: 0\r\n                },\r\n                callback(res) {\r\n                    let list = [...new Set((res.message || []).map(r => r.facility_name))].sort();\r\n                    frm.set_df_property('client', 'options', list.join(\"\\n\"));\r\n                }\r\n            });\r\n\r\n            frm.toggle_display(fieldList, false);\r\n        }\r\n    },\r\n\r\n    // ---------------------------------------------------------------------\r\n    // CLIENT CHANGE EVENT\r\n    // ---------------------------------------------------------------------\r\n    client(frm) {\r\n          \r\n        // Prevent \"Not Saved\" issue:\r\n        // Only clear values if user actually changes client\r\n        if (frm.is_dirty()) {\r\n            frm.set_value('policyno', '');\r\n            frm.set_value('policy_number', '');\r\n            frm.set_value('invoice_number', '');\r\n            frm.set_value('invoiceno', '');\r\n            frm.set_value('invoice_amt', '');\r\n            frm.set_value('receiptamt', '');\r\n            frm.set_value('deductamt', '');\r\n            frm.set_value('invoicebalanceamt', '');\r\n        }\r\n\r\n        let client = frm.doc.client;\r\n        if (!client) return;\r\n\r\n        let reference = frm.doc.reference;\r\n\r\n        // --- ALWAYS FETCH UNIQUE POLICY NUMBERS ---\r\n        frappe.call({\r\n            method: \"frappe.client.get_list\",\r\n            args: {\r\n                doctype: \"Policy Approvals\",\r\n                filters: { policy_holder: client },\r\n                fields: [\"policy_number\"],\r\n                limit_page_length: 0\r\n            },\r\n            callback(res) {\r\n                let policyNumbers = [...new Set((res.message || []).map(x => x.policy_number))];\r\n\r\n                frm.set_df_property(\"policy_number\", \"options\", policyNumbers.join(\"\\n\"));\r\n\r\n                // only reset for NEW entries\r\n                if (frm.is_new()) {\r\n                    frm.set_value(\"policy_number\", \"\");\r\n                    frm.set_value(\"policyno\", \"\");\r\n                }\r\n            }\r\n        });\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'CI Invoices',\r\n                filters: { policy_holder: client },\r\n                fields: ['invoice_no'],\r\n                limit_page_length: 0\r\n            },\r\n            callback(res) {\r\n                let invoiceList = [...new Set((res.message || []).map(x => x.invoice_no))];\r\n                frm.set_df_property('invoice_number', 'options', invoiceList.join(\"\\n\"));\r\n\r\n                if (frm.is_new()) frm.set_value('invoice_number', '');\r\n            }\r\n        });\r\n\r\n        // --- ADVANCE PREMIUM ---\r\n        if (reference === \"Advance Premium\") {\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Advance Premium',\r\n                    filters: { policy_holder: client },\r\n                    fields: ['adv_premium_no'],\r\n                    limit_page_length: 0\r\n                },\r\n                callback(res) {\r\n                    let advList = [...new Set((res.message || []).map(x => x.adv_premium_no))];\r\n                    frm.set_df_property('advance_premium_no', 'options', advList.join(\"\\n\"));\r\n\r\n                    if (frm.is_new()) frm.set_value('advance_premium_no', '');\r\n                }\r\n            });\r\n        }\r\n\r\n        // --- PREPAYMENT / PREMIUM DEPOSITE ---\r\n        else if (reference === \"PrePayment\" || reference === \"Premium Deposite\") {\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Bond Invoice',\r\n                    filters: { facility_name: client },\r\n                    fields: ['bond_no'],\r\n                    limit_page_length: 0\r\n                },\r\n                callback(res) {\r\n                    let bondList = [...new Set((res.message || []).map(x => x.bond_no))];\r\n\r\n                    if (frm.is_new()) frm.set_value('invoice_number', '');\r\n                }\r\n            });\r\n        }\r\n    },\r\n\r\n    policy_number(frm) {\r\n        frm.set_value(\"policyno\", frm.doc.policy_number);\r\n    },\r\n\r\n    advance_premium_no(frm) {\r\n         \r\n        if (frm.doc.reference !== \"Advance Premium\") return;\r\n        if (!frm.doc.advance_premium_no) return;\r\n            frm.set_value(\"advance_premium_number\", frm.doc.advance_premium_no);\r\n        frappe.call({\r\n            method: \"frappe.client.get_list\",\r\n            args: {\r\n                doctype: \"Advance Premium\",\r\n                filters: {\r\n                    adv_premium_no: frm.doc.advance_premium_no,\r\n                    policy_holder: frm.doc.client\r\n                },\r\n                fields: [\"advance_premium\"]\r\n            },\r\n            callback(r) {\r\n                if (r.message && r.message[0]) {\r\n                    let adv = Number(r.message[0].advance_premium).toFixed(2);\r\n                    frm.set_value(\"receiptamt\", adv);\r\n                } else {\r\n                    frm.set_value(\"receiptamt\", 0);\r\n                }\r\n            }\r\n        });\r\n    },\r\n\r\n    invoice_number(frm) {\r\n        frm.set_value(\"invoiceno\", frm.doc.invoice_number);\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'CI Invoices',\r\n                filters: { invoice_no: frm.doc.invoice_number },\r\n                fields: ['invoice_amount'],\r\n                limit_page_length: 1\r\n            },\r\n            callback(r) {\r\n                if (r.message && r.message.length > 0) {\r\n                    let amt = Number(r.message[0].invoice_amount).toFixed(2);\r\n                    frm.set_value('invoice_amt', amt);\r\n\r\n                    if (frm.doc.reference === \"Invoice\") {\r\n                        frm.set_value('receiptamt', amt);\r\n                    }\r\n\r\n                    calculate_balance(frm);\r\n                } else {\r\n                    frappe.call({\r\n                        method: 'frappe.client.get_list',\r\n                        args: {\r\n                            doctype: 'Bond Invoice',\r\n                            filters: { bond_no: frm.doc.invoice_number },\r\n                            fields: ['premium_p'],\r\n                            limit_page_length: 1\r\n                        },\r\n                        callback(bond_res) {\r\n                            if (bond_res.message && bond_res.message.length > 0) {\r\n                                let bondAmt = Number(bond_res.message[0].premium_p).toFixed(2);\r\n                                frm.set_value('receiptamt', bondAmt);\r\n\r\n                                frm.set_value('invoice_amt', \"\");\r\n                            } else {\r\n                                frm.set_value('invoice_amt', \"0.00\");\r\n                                frm.set_value('receiptamt', \"0.00\");\r\n                            }\r\n                            calculate_balance(frm);\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        });\r\n    },\r\n\r\n    invoice_amt(frm) { calculate_balance(frm); },\r\n    deductamt(frm) { calculate_balance(frm); },\r\nbefore_save(frm) {\r\n    frm.set_value(\"client_name\", frm.doc.client);\r\n}\r\n\r\n});\r\n\r\n\r\n\r\n\r\n// frappe.ui.form.on('Receipt', {\r\n\r\n//     refresh(frm) {\r\n//         let rightAlignFields = [\r\n//             \"depositamt\", \"totaldeduction\", \"depositbalance\", \"receiptamt\",\r\n//             \"deductamt\", \"invoicebalanceamt\", \"no\", \"invoice_amt\"\r\n//         ];\r\n\r\n//         rightAlignFields.forEach(f => {\r\n//             if (frm.fields_dict[f] && frm.fields_dict[f].$input) {\r\n//                 frm.fields_dict[f].$input.css(\"text-align\", \"right\");\r\n//             }\r\n//         });\r\n//     },\r\n\r\n//     onload(frm) {\r\n//         if (!frm.doc.receiptno) generateNumber(frm);\r\n\r\n//         frm.set_df_property('receiptno', 'reqd', 1);\r\n\r\n//         toggle_client_fields(frm);\r\n\r\n//         // display client name for existing records\r\n//         frm.set_value('client_name', frm.doc.client);\r\n//     },\r\n\r\n//     reference(frm) {\r\n//         let reference = frm.doc.reference || \"\";\r\n\r\n//         // Reset fields\r\n//         frm.set_value('client', '');\r\n//         frm.set_value('policyno', '');\r\n//         frm.set_value('policy_number', '');\r\n\r\n//         const fieldList = ['deduct_from_deposit', 'invoicebalanceamt', 'yes', 'no1'];\r\n\r\n//         // -----------------------------\r\n//         // A) ADVANCE PREMIUM\r\n//         // -----------------------------\r\n//         if (reference === \"Advance Premium\") {\r\n\r\n//             frappe.call({\r\n//                 method: 'frappe.client.get_list',\r\n//                 args: {\r\n//                     doctype: 'Advance Premium',\r\n//                     fields: ['policy_holder'],\r\n//                     filters: { workflow_state: \"Approved\" },\r\n//                     limit_page_length: 0\r\n//                 },\r\n//                 callback(res) {\r\n//                     let list = [...new Set((res.message || []).map(r => r.policy_holder))].sort();\r\n//                     frm.set_df_property('client', 'options', list.join(\"\\n\"));\r\n//                 }\r\n//             });\r\n\r\n//             frm.toggle_display(fieldList, false);\r\n//         }\r\n\r\n//         // -----------------------------\r\n//         // B) INVOICE\r\n//         // -----------------------------\r\n//         else if (reference === \"Invoice\") {\r\n\r\n//             frappe.call({\r\n//                 method: 'frappe.client.get_list',\r\n//                 args: {\r\n//                     doctype: 'CI Invoices',\r\n//                     fields: ['policy_holder'],\r\n//                     limit_page_length: 0\r\n//                 },\r\n//                 callback(res) {\r\n//                     let list = [...new Set((res.message || []).map(r => r.policy_holder))].sort();\r\n//                     frm.set_df_property('client', 'options', list.join(\"\\n\"));\r\n//                 }\r\n//             });\r\n\r\n//             frm.toggle_display(fieldList, true);\r\n//         }\r\n\r\n//         // -----------------------------\r\n//         // C) PREPAYMENT / PREMIUM DEPOSITE\r\n//         // -----------------------------\r\n//         else if (reference === \"PrePayment\" || reference === \"Premium Deposite\") {\r\n\r\n//             frappe.call({\r\n//                 method: 'frappe.client.get_list',\r\n//                 args: {\r\n//                     doctype: 'Bond Invoice',\r\n//                     fields: ['facility_name'],\r\n//                     limit_page_length: 0\r\n//                 },\r\n//                 callback(res) {\r\n//                     let list = [...new Set((res.message || []).map(r => r.facility_name))].sort();\r\n//                     frm.set_df_property('client', 'options', list.join(\"\\n\"));\r\n//                 }\r\n//             });\r\n\r\n//             frm.toggle_display(fieldList, false);\r\n//         }\r\n    \r\n\r\n//     },\r\n\r\n//     // ---------------------------------------------------------------------\r\n//     // CLIENT CHANGE EVENT\r\n//     // ---------------------------------------------------------------------\r\n//  client(frm) {\r\n\r\n//         // Clear existing values\r\n//         frm.set_value('policyno', '');\r\n//         frm.set_value('policy_number', '');\r\n//         frm.set_value('invoice_number', '');\r\n//         frm.set_value('invoiceno', '');\r\n//         frm.set_value('invoice_amt', '');\r\n//         frm.set_value('receiptamt', '');\r\n//         frm.set_value('deductamt', '');\r\n//         frm.set_value('invoicebalanceamt', '');\r\n\r\n//         let client = frm.doc.client;\r\n//         if (!client) return;\r\n\r\n//         let reference = frm.doc.reference;\r\n\r\n//         // --- ALWAYS FETCH UNIQUE POLICY NUMBERS ---\r\n//      frappe.call({\r\n//     method: \"frappe.client.get_list\",\r\n//     args: {\r\n//         doctype: \"Policy Approvals\",\r\n//         filters: { policy_holder: client },\r\n//         fields: [\"policy_number\"],\r\n//         limit_page_length: 0\r\n//     },\r\n//     callback(res) {\r\n//         let policyNumbers = [...new Set((res.message || []).map(x => x.policy_number))];\r\n\r\n//         if (policyNumbers.length === 0) {\r\n//             //frappe.msgprint(__('No policy numbers found for this client'));\r\n//             // Optionally clear the field\r\n//             frm.set_df_property(\"policy_number\", \"options\", \"\");\r\n//             frm.set_value(\"policy_number\", \"\");\r\n//             frm.set_value(\"policyno\", \"\");\r\n//         } else {\r\n//             frm.set_df_property(\"policy_number\", \"options\", policyNumbers.join(\"\\n\"));\r\n//             frm.set_value(\"policy_number\", \"\");\r\n//             frm.set_value(\"policyno\", \"\");\r\n//         }\r\n//     }\r\n// });\r\n//   frappe.call({\r\n//         method: 'frappe.client.get_list',\r\n//         args: {\r\n//             doctype: 'CI Invoices',\r\n//             filters: { policy_holder: client },\r\n//             fields: ['invoice_no'],\r\n//             limit_page_length: 0\r\n//         },\r\n//         callback(res) {\r\n//             let invoiceList = [...new Set((res.message || []).map(x => x.invoice_no))];\r\n//             frm.set_df_property('invoice_number', 'options', invoiceList.join(\"\\n\"));\r\n//             frm.set_value('invoice_number', '');\r\n//         }\r\n//     });\r\n\r\n// // --- ADVANCE PREMIUM ---\r\n// if (reference === \"Advance Premium\") {\r\n//     frappe.call({\r\n//         method: 'frappe.client.get_list',\r\n//         args: {\r\n//             doctype: 'Advance Premium',\r\n//             filters: { policy_holder: client },\r\n//             fields: ['adv_premium_no'],\r\n//             limit_page_length: 0\r\n//         },\r\n//         callback(res) {\r\n//             let advList = [...new Set((res.message || []).map(x => x.adv_premium_no))];\r\n//             frm.set_df_property('advance_premium_no', 'options', advList.join(\"\\n\"));\r\n//             frm.set_value('advance_premium_no', '');\r\n//         }\r\n//     });\r\n// }\r\n\r\n// // --- INVOICE ---\r\n// // else if (reference === \"Invoice\") {\r\n// //     frappe.call({\r\n// //         method: 'frappe.client.get_list',\r\n// //         args: {\r\n// //             doctype: 'CI Invoices',\r\n// //             filters: { policy_holder: client },\r\n// //             fields: ['invoice_no'],\r\n// //             limit_page_length: 0\r\n// //         },\r\n// //         callback(res) {\r\n// //             let invoiceList = [...new Set((res.message || []).map(x => x.invoice_no))];\r\n// //             frm.set_df_property('invoice_number', 'options', invoiceList.join(\"\\n\"));\r\n// //             frm.set_value('invoice_number', '');\r\n// //         }\r\n// //     });\r\n// // }\r\n\r\n// // --- PREPAYMENT / PREMIUM DEPOSITE ---\r\n// else if (reference === \"PrePayment\" || reference === \"Premium Deposite\") {\r\n//     frappe.call({\r\n//         method: 'frappe.client.get_list',\r\n//         args: {\r\n//             doctype: 'Bond Invoice',\r\n//             filters: { facility_name: client },\r\n//             fields: ['bond_no'],\r\n//             limit_page_length: 0\r\n//         },\r\n//         callback(res) {\r\n//             let bondList = [...new Set((res.message || []).map(x => x.bond_no))];\r\n//             //frm.set_df_property('invoice_number', 'options', bondList.join(\"\\n\"));\r\n//             frm.set_value('invoice_number', '');\r\n//         }\r\n//     });\r\n// }\r\n\r\n//     },\r\n\r\n\r\n//     // sync policy_no \u2192 policyno\r\n//     policy_number(frm) {\r\n//         frm.set_value(\"policyno\", frm.doc.policy_number);\r\n//     },\r\n//   advance_premium_no(frm) {\r\n//     // Only run for Advance Premium reference\r\n//     if (frm.doc.reference !== \"Advance Premium\") return;\r\n//     if (!frm.doc.advance_premium_no) return;\r\n\r\n//     frappe.call({\r\n//         method: \"frappe.client.get_list\",\r\n//         args: {\r\n//             doctype: \"Advance Premium\",\r\n//             filters: {\r\n//                 adv_premium_no: frm.doc.advance_premium_no,\r\n//                 policy_holder: frm.doc.client\r\n//             },\r\n//             fields: [\"advance_premium\"]\r\n//         },\r\n//         callback(r) {\r\n//             if (r.message && r.message[0]) {\r\n//                 let adv = Number(r.message[0].advance_premium).toFixed(2);\r\n//                 frm.set_value(\"receiptamt\", adv);\r\n//             } else {\r\n//                 frm.set_value(\"receiptamt\", 0);\r\n//             }\r\n//         }\r\n//     });\r\n// },\r\n\r\n\r\n// invoice_number(frm) {\r\n//     // Sync invoice_number to invoiceno\r\n//     frm.set_value(\"invoiceno\", frm.doc.invoice_number);\r\n\r\n//     // First, check in CI Invoices\r\n//     frappe.call({\r\n//         method: 'frappe.client.get_list',\r\n//         args: {\r\n//             doctype: 'CI Invoices',\r\n//             filters: { invoice_no: frm.doc.invoice_number },\r\n//             fields: ['invoice_amount'],\r\n//             limit_page_length: 1\r\n//         },\r\n//         callback(r) {\r\n//             if (r.message && r.message.length > 0) {\r\n//                 let amt = Number(r.message[0].invoice_amount).toFixed(2);\r\n//                 frm.set_value('invoice_amt', amt);\r\n\r\n//                 // Only set receipt amount if reference = Invoice\r\n//                 if (frm.doc.reference === \"Invoice\") {\r\n//                     frm.set_value('receiptamt', amt);\r\n//                 }\r\n//                 calculate_balance(frm);\r\n//             } else {\r\n//                 // Not found in CI Invoices, check Bond Invoice\r\n//                 frappe.call({\r\n//                     method: 'frappe.client.get_list',\r\n//                     args: {\r\n//                         doctype: 'Bond Invoice',\r\n//                         filters: { bond_no: frm.doc.invoice_number },\r\n//                         fields: ['premium_p'], // replace with actual amount field\r\n//                         limit_page_length: 1\r\n//                     },\r\n//                     callback(bond_res) {\r\n//                         if (bond_res.message && bond_res.message.length > 0) {\r\n//                             let bondAmt = Number(bond_res.message[0].premium_p).toFixed(2);\r\n//                             frm.set_value('receiptamt', bondAmt);\r\n\r\n//                             // Clear invoice_amt if not CI Invoice\r\n//                             frm.set_value('invoice_amt', \"\");\r\n//                         } else {\r\n//                             // Not found anywhere, clear amounts\r\n//                             frm.set_value('invoice_amt', \"0.00\");\r\n//                             frm.set_value('receiptamt', \"0.00\");\r\n//                         }\r\n//                         calculate_balance(frm);\r\n//                     }\r\n//                 });\r\n//             }\r\n//         }\r\n//     });\r\n// },\r\n\r\n\r\n\r\n//     invoice_amt(frm) { calculate_balance(frm); },\r\n//     deductamt(frm) { calculate_balance(frm); }\r\n\r\n// });\r\n\r\n// ---------------------------------------------------------------------\r\n\r\nfunction calculate_balance(frm) {\r\n    let invoice = Number(frm.doc.invoice_amt || 0);\r\n    let deduct = Number(frm.doc.deductamt || 0);\r\n\r\n    let balance = (invoice - deduct).toFixed(2);\r\n\r\n    frm.set_value('invoicebalanceamt', balance);\r\n}\r\n\r\n// ---------------------------------------------------------------------\r\n\r\nfunction generateNumber(frm) {\r\n    let currentYear = new Date().getFullYear();\r\n    let prefix = `RCPT/${currentYear}/`;\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Receipt',\r\n            fields: ['receiptno', 'creation'],\r\n            order_by: 'creation desc',\r\n            limit: 1\r\n        },\r\n        callback(r) {\r\n            if (r.message && r.message.length > 0) {\r\n                let last = r.message[0].receiptno || '';\r\n                let lastNumber = parseInt(last.split('/').pop()) || 0;\r\n                let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n                frm.set_value('receiptno', prefix + newNumber);\r\n            } else {\r\n                frm.set_value('receiptno', prefix + '0001');\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n// ---------------------------------------------------------------------\r\n\r\nfunction toggle_client_fields(frm) {\r\n\r\n    let isNew = frm.is_new();\r\n\r\n    frm.toggle_display('client', isNew);\r\n    frm.toggle_display('client_name', !isNew);\r\n\r\n    frm.toggle_display('policy_number', isNew);\r\n    frm.toggle_display('policyno', !isNew);\r\n\r\n    frm.toggle_display('invoice_number', isNew);\r\n    frm.toggle_display('invoiceno', !isNew);\r\n    \r\n     frm.toggle_display('advance_premium_no', isNew);\r\n    frm.toggle_display('advance_premium_number', !isNew);\r\n}\r\n",
  "view": "Form"
 },
 {
  "_liked_by": "[\"Administrator\"]",
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Claim Process",
  "enabled": 0,
  "modified": "2025-12-01 11:29:00.274767",
  "module": "Finance",
  "name": "claim process",
  "script": "frappe.ui.form.on('Claim Process', {\r\n   \r\n        \r\nonload: function(frm) {\r\n           \r\nhide_all_claim_fields(frm);\r\n\r\n        if (frm.doc.client) {\r\n            process_client_selection(frm, frm.doc.client);\r\n        }\r\n        // Fetch clients from CI Claim\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: { \r\n                doctype: 'CI Claim', \r\n                filters: {}, \r\n                fields: ['ph_name', 'client_type'],   // fetch client_type also\r\n                limit_page_length: 0\r\n            },\r\n            callback: function(ciResponse) {\r\n                let clientOptions = [];\r\n                if (ciResponse.message) {\r\n                    ciResponse.message.forEach(r => {\r\n                        if (r.client_type === \"DCI\") {\r\n                            clientOptions.push(`DCI[${r.ph_name}]`);\r\n                        } else if (r.client_type === \"ECI\") {\r\n                            clientOptions.push(`ECI[${r.ph_name}]`);\r\n                        } else {\r\n                            clientOptions.push(`${r.ph_name}`);\r\n                        }\r\n                    });\r\n                }\r\n\r\n                // Fetch clients from Bond Claims\r\n                frappe.call({\r\n                    method: 'frappe.client.get_list',\r\n                    args: { \r\n                        doctype: 'Bond Claims', \r\n                        filters: {}, \r\n                        fields: ['client'],\r\n                        limit_page_length: 0\r\n                    },\r\n                    callback: function(bondResponse) {\r\n                        if (bondResponse.message) {\r\n                            bondResponse.message.forEach(r => {\r\n                                clientOptions.push(`BND[${r.client}]`);\r\n                            });\r\n                        }\r\n\r\n                        // Deduplicate\r\n                        const uniqueOptions = [...new Set(clientOptions)];\r\n\r\n                        // Set dropdown options\r\n                        frm.set_df_property('client', 'options', uniqueOptions.join('\\n'));\r\n                        frm.refresh_field('client');\r\n\r\n                        console.log(\"Client dropdown options set:\", uniqueOptions);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    },\r\n    refresh: function(frm){\r\n        \r\n    hide_all_claim_fields(frm);\r\n\r\n        if (frm.doc.client) {\r\n            process_client_selection(frm, frm.doc.client);\r\n        }\r\n        \r\n        var workflowState = frm.doc.workflow_state;\r\n           if (workflowState === \"Approved\" || workflowState === \"Pending\") {\r\n            frm.toggle_display('policy_no', true);\r\n            frm.toggle_display('claim_ref_no', false);\r\n            frm.toggle_display('policy_number', false);\r\n           // frm.toggle_display('claim_refno', true);\r\n            frm.toggle_display('buyer', true);\r\n            frm.toggle_display('buyer1', false);\r\n        }\r\n        frm.fields_dict['insuredamt'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n        frm.fields_dict['beci'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n        frm.fields_dict['claimamount'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n    \r\n    },\r\n \r\n\r\n    client: function(frm) {\r\n        \r\n        frm.set_value('client1', frm.doc.client);\r\n    if (frm.doc.client) {\r\n            // Remove prefixes like DCI[ ], ECI[ ], BND[ ] and keep only inside text\r\n            let plainName = frm.doc.client.replace(/^[A-Z]+\\[|\\]$/g, '');\r\n            //frm.set_value('pname', plainName);\r\n        }\r\n    \r\n        if (!frm.doc.paymentrefno) {\r\n            generateNumber(frm);\r\n        }\r\n        var selectedClient = frm.doc.client;\r\n        console.log(\"Selected client:\", selectedClient);\r\n\r\n        if (!selectedClient) {\r\n            // reset field if no client is selected\r\n            frm.set_df_property('policy_number', 'options', []);\r\n            return;\r\n        }\r\n\r\n        // // \u2705 Remove prefix DCI[...] or BND[...] to get plain name\r\n        // let cleanClient = selectedClient.replace(/^(DCI|BND)\\[|\\]$/g, '');\r\n        // console.log(\"Clean client name:\", cleanClient);\r\n        // Remove prefixes like DCI[ ], ECI[ ], BND[ ]\r\n        let cleanClient = selectedClient.replace(/^(DCI|ECI|BND)\\[|\\]$/g, '').trim();\r\n        console.log(\"Clean client name:\", cleanClient);\r\n\r\n\r\n        // // \u2705 Decide doctype and fields dynamically\r\n        // let doctypeName = selectedClient.startsWith(\"DCI[\") ? 'CI Claim' : 'Bond Claims';\r\n        // let policyField = selectedClient.startsWith(\"DCI[\") ? 'policyno' : 'bond_no';\r\n        // let clientField = selectedClient.startsWith(\"DCI[\") ? 'ph_name' : 'client';\r\n        \r\n        // Determine doctype for DCI, ECI, BND\r\nlet doctypeName = '';\r\nlet clientField = '';\r\nlet policyField = '';\r\n\r\nif (\r\n    selectedClient.startsWith(\"DCI[\") || selectedClient.startsWith(\"DCI [\") ||\r\n    selectedClient.startsWith(\"ECI[\") || selectedClient.startsWith(\"ECI [\")\r\n    ){\r\n    doctypeName = 'CI Claim';\r\n    clientField = 'ph_name';\r\n    policyField = 'policyno';\r\n    \r\n    // set policy_type correctly\r\n    if (selectedClient.includes(\"DCI\")) {\r\n        frm.set_value(\"policy_type\", \"DCI\");\r\n    } else if (selectedClient.includes(\"ECI\")) {\r\n        frm.set_value(\"policy_type\", \"ECI\");\r\n    }\r\n\r\n} \r\n\r\nelse if (\r\n    selectedClient.startsWith(\"BND[\") || selectedClient.startsWith(\"BND [\")\r\n) {\r\n    doctypeName = \"Bond Claims\";\r\n    clientField = \"client\";\r\n    policyField = \"bond_no\";\r\n    frm.set_value(\"policy_type\", \"BND\");\r\n}\r\n// else if (selectedClient.startsWith(\"BND[\")) {\r\n//     doctypeName = 'Bond Claims';\r\n//     clientField = 'client';\r\n//     policyField = 'bond_no';\r\n// }\r\nhide_all_claim_fields(frm);\r\n        if (frm.doc.client) {\r\n            process_client_selection(frm, frm.doc.client);\r\n        }\r\nconsole.log(\"Doctype:\", doctypeName, \"Client Field:\", clientField, \"Policy Field:\", policyField);\r\n\r\n\r\n        // \u2705 Fetch policy numbers\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: doctypeName,\r\n                filters: { [clientField]: cleanClient },\r\n                fields: [policyField],\r\n                limit_page_length: 0  // fetch all policies\r\n            },\r\n            callback: function(response) {\r\n                console.log(\"Policy API response:\", response);\r\n\r\n                if (response.message && response.message.length > 0) {\r\n                    let policyNumbers = response.message.map(r => r[policyField]);\r\n                    let uniquePolicies = [...new Set(policyNumbers)];\r\n                    console.log(\"Policy numbers:\", uniquePolicies);\r\n\r\n                    // Populate dropdown with policy numbers\r\n                    frm.set_df_property('policy_number', 'options', uniquePolicies.join('\\n'));\r\n\r\n                    // Auto select if only one policy exists\r\n                    if (uniquePolicies.length === 1) {\r\n                        frm.set_value('policy_number', uniquePolicies[0]);\r\n                        console.log(\"Single policy number set:\", uniquePolicies[0]);\r\n                    }\r\n                } else {\r\n                    console.log(\"No policy numbers found for client:\", cleanClient);\r\n                    frm.set_df_property('policy_number', 'options', []);\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error(\"Error fetching policy numbers:\", err);\r\n            }\r\n        });\r\n        \r\n  \r\n    \r\n    },\r\npolicy_number: function(frm) {\r\n        var policyNumber = frm.doc.policy_number;\r\n\r\n        // also set to policy_no field\r\n        frm.set_value('policy_no', policyNumber);\r\n\r\n        // First search in CI Claim\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'CI Claim',\r\n                filters: { policyno: policyNumber },\r\n                fields: ['client_type', 'workflow_state', 'buyer', 'claim_refno'],\r\n                limit_page_length: 0\r\n            },\r\n            callback: function(cIClaimResponse) {\r\n                if (cIClaimResponse.message && cIClaimResponse.message.length > 0) {\r\n                    let record = cIClaimResponse.message[0];\r\n\r\n                    // Set fields from CI Claim\r\n                    frm.set_value('policy_type', record.client_type || '');\r\n                    frm.set_value('status', record.workflow_state || '');\r\n\r\n                  // Populate claim_ref_no dropdown\r\n                    let claimRefs = cIClaimResponse.message.map(r => r.claim_refno).filter(Boolean);\r\n                    frm.set_df_property('claim_ref_no', 'options', [...new Set(claimRefs)].join('\\n'));\r\n                    if (claimRefs.length === 1) {\r\n                        frm.set_value('claim_ref_no', claimRefs[0]);\r\n                    }\r\n\r\n                    // Populate buyer dropdown\r\n                    let buyers = cIClaimResponse.message.map(r => r.buyer).filter(Boolean);\r\n                    frm.set_df_property('buyer1', 'options', [...new Set(buyers)].join('\\n'));\r\n                    if (buyers.length === 1) {\r\n                        frm.set_value('buyer1', buyers[0]);\r\n                    }\r\n\r\n                } else {\r\n                    // If not found, search in Bond Claims\r\n                    frappe.call({\r\n                        method: 'frappe.client.get_list',\r\n                        args: {\r\n                            doctype: 'Bond Claims',\r\n                            filters: { bond_no: policyNumber },\r\n                            fields: ['policy_type', 'workflow_state', 'claim_ref_no'],\r\n                            limit_page_length: 0\r\n                        },\r\n                        callback: function(bondClaimResponse) {\r\n        if (bondClaimResponse.message && bondClaimResponse.message.length > 0) {\r\n            // Set policy_type to BND\r\n            frm.set_value('policy_type', 'BND');\r\n\r\n            // Set status from first record\r\n            frm.set_value('status', bondClaimResponse.message[0].workflow_state || '');\r\n\r\n            // Populate claim_ref_no dropdown\r\n            let claimRefs = bondClaimResponse.message.map(r => r.claim_ref_no).filter(Boolean);\r\n            frm.set_df_property('claim_ref_no', 'options', [...new Set(claimRefs)].join('\\n'));\r\n            if (claimRefs.length === 1) {\r\n                frm.set_value('claim_ref_no', claimRefs[0]);\r\n            }\r\n\r\n            // Populate buyer dropdown\r\n            let buyers = bondClaimResponse.message.map(r => r.buyer).filter(Boolean);\r\n            frm.set_df_property('buyer1', 'options', [...new Set(buyers)].join('\\n'));\r\n            if (buyers.length === 1) {\r\n                frm.set_value('buyer1', buyers[0]);\r\n            }\r\n\r\n        } else {\r\n            frappe.msgprint(__('No Bond Claim found for Policy Number: ' + policyNumber));\r\n            frm.set_df_property('buyer1', 'options', []);\r\n            frm.set_df_property('claim_ref_no', 'options', []);\r\n        }\r\n    }\r\n                    });\r\n                }\r\n            }\r\n        });\r\n    },\r\n    \r\n     bond: function(frm) {\r\n        // If Bond is checked, hide DCI and ECI\r\n        if (frm.doc.bond) {\r\n            frm.toggle_display(['dci', 'eci'], false);\r\n        } else {\r\n            frm.toggle_display(['dci', 'eci'], true);\r\n        }\r\n    },\r\n\r\n    dci: function(frm) {\r\n        // If DCI is checked, hide Bond and ECI\r\n        if (frm.doc.dci) {\r\n            frm.toggle_display(['bond', 'eci'], false);\r\n        } else {\r\n            frm.toggle_display(['bond', 'eci'], true);\r\n        }\r\n    },\r\n\r\n    eci: function(frm) {\r\n        // If ECI is checked, hide Bond and DCI\r\n        if (frm.doc.eci) {\r\n            frm.toggle_display(['bond', 'dci'], false);\r\n        } else {\r\n            frm.toggle_display(['bond', 'dci'], true);\r\n        }\r\n    },\r\n\r\n    next: function(frm) {\r\n        var selectedFields = [];\r\n\r\n        // Checking if 'Bond' is selected\r\n        if (frm.doc.bond) {\r\n            selectedFields.push('Bond');\r\n        }\r\n\r\n        // Checking if 'DCI' is selected\r\n        if (frm.doc.dci) {\r\n            selectedFields.push('DCI');\r\n        }\r\n\r\n        // Checking if 'ECI' is selected\r\n        if (frm.doc.eci) {\r\n            selectedFields.push('ECI');\r\n        }\r\n\r\n        // If no field is selected, show a message\r\n        if (selectedFields.length === 0) {\r\n            frappe.msgprint(__('Please select at least one field.'));\r\n        }\r\n        // If more than one field is selected, show a message\r\n        else if (selectedFields.length > 1) {\r\n            frappe.msgprint(__('Please select only one field at a time.'));\r\n        } else {\r\n            // Set route options based on selected field\r\n            frappe.route_options = {\r\n                client: frm.doc.client,\r\n                policy_no: frm.doc.policy_number,\r\n                type: frm.doc.policy_type,\r\n                payment_ref_no: frm.doc.paymentrefno,\r\n                buyer: frm.doc.buyer,\r\n                claim_ref_no: frm.doc.claim_ref_no,\r\n                claim_ammount: frm.doc.claimamount,\r\n                reinsure: frm.doc.reinsure,\r\n                status: frm.doc.status,\r\n               // process_date: frm.doc.processdate,\r\n                cause_of_loss: frm.doc.causeofloss,\r\n                insured_amt: frm.doc.insuredamt,\r\n                beci: frm.doc.beci\r\n            };\r\n\r\n            // Open new document based on selected field\r\n            if (selectedFields[0] === 'Bond') {\r\n                frappe.new_doc('Claim Processing Bond Claim');\r\n            } else if (selectedFields[0] === 'DCI') {\r\n                frappe.new_doc('Claim Processing Dci');\r\n            } else if (selectedFields[0] === 'ECI') {\r\n                frappe.new_doc('Claim Processing ECI');\r\n            }\r\n        }\r\n    },\r\n     \r\n    \r\n    buyer1: function(frm){\r\n        let buyer = frm.doc.buyer1;\r\n         frm.set_value('buyer', buyer);\r\n\r\n    },\r\n    \r\nclaim_ref_no: function(frm) {\r\n        let claimRef = frm.doc.claim_ref_no;\r\n        let policyNumber = frm.doc.policy_number;\r\n        //frm.set_value('claim_refno', claimRef);\r\n        // Search in CI Claim first\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'CI Claim',\r\n                filters: {\r\n                    policyno: policyNumber,\r\n                    claim_refno: claimRef\r\n                },\r\n                fields: ['cl_claim_date', 'claim_value__p', 'cause_of_loss', 'credit_limit'],\r\n                limit_page_length: 1\r\n            },\r\n            callback: function(ciResponse) {\r\n                if (ciResponse.message && ciResponse.message.length > 0) {\r\n                    let record = ciResponse.message[0];\r\n                    frm.set_value('processdate', record.cl_claim_date);\r\n                    frm.set_value('claimamount', record.claim_value__p);\r\n                    frm.set_value('causeofloss', record.cause_of_loss);\r\n                    frm.set_value('insuredamt', record.credit_limit);\r\n                } else {\r\n                    // Check Bond Claims\r\n                    frappe.call({\r\n                        method: 'frappe.client.get_list',\r\n                        args: {\r\n                            doctype: 'Bond Claims',\r\n                            filters: {\r\n                                bond_no: policyNumber,   // <-- corrected field\r\n                                claim_ref_no: claimRef\r\n                            },\r\n                            fields: ['reason', 'value', 'bond_value'],\r\n                            limit_page_length: 1\r\n                        },\r\n                        callback: function(bondResponse) {\r\n                            if (bondResponse.message && bondResponse.message.length > 0) {\r\n                                let record = bondResponse.message[0];\r\n                                frm.set_value('causeofloss', record.reason);\r\n                                frm.set_value('claimamount', record.value);\r\n                                frm.set_value('insuredamt', record.bond_value);\r\n                                //frm.set_value('processdate', record.process_date);\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        });\r\n\r\n    //   if (claimRef) {\r\n    //         hide_claim_fields(frm, false);\r\n    //     }\r\n    \r\n    if (frm.doc.policy_number) {\r\n    hide_claim_fields(frm, false);\r\n}\r\n\r\n}\r\n\r\n});\r\n\r\n\r\nfunction generateNumber(frm) {\r\n    if (!frm.doc.paymentrefno) {\r\n        let currentYear = new Date().getFullYear();\r\n        let prefix = `PMT/${currentYear}/`;\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Claim Process',\r\n                fields: ['paymentrefno', 'creation'],\r\n                order_by: 'creation desc',\r\n                limit: 1\r\n            },\r\n            callback: function(r) {\r\n                if (r.message && r.message.length > 0) {\r\n                    let lastPMTNumber = r.message[0].paymentrefno;\r\n                    let lastNumber = parseInt(lastPMTNumber.split(\"/\").pop());\r\n                    if (!isNaN(lastNumber)) {\r\n                        let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n                        frm.set_value('paymentrefno', prefix + newNumber);\r\n                    }\r\n                } else {\r\n                    frm.set_value('paymentrefno', prefix + '0001');\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\nfunction hide_all_claim_fields(frm) {\r\n    [\r\n        \"invoice_attached\",\r\n        \"delivery_notes\",\r\n        \"sureties\",\r\n        \"cl_approval_form__annexure\",\r\n        \"order_attached\",\r\n        \"statement\",\r\n        \"claims_application_form\",\r\n        \"copies_of_correspondence_with_the_buyer\",\r\n        \"claim_application\",\r\n        \"statement_to_show\",\r\n        \"demand_letter\",\r\n        \"contractor_final_account_report\"\r\n    ].forEach(f => {\r\n        frm.set_df_property(f, \"hidden\", 1);\r\n        frm.doc[f] = 0;        // instead of set_value\r\n        frm.refresh_field(f);\r\n    });\r\n}\r\n\r\n\r\n/* ---------------------------------------------\r\n   Decide which doctype to load\r\n---------------------------------------------- */\r\nfunction process_client_selection(frm, selected_value) {\r\n\r\n    let pure_name = extract_name(selected_value);\r\n\r\n    if (selected_value.startsWith(\"ECI\") || selected_value.startsWith(\"DCI\")) {\r\n        load_potential_claims(frm, pure_name);\r\n    }\r\n    else if (selected_value.startsWith(\"BND\")) {\r\n        load_bond_claims(frm, pure_name);\r\n    }\r\n}\r\n\r\n\r\n/* ---------------------------------------------\r\n   Extract actual name \u2192 ECI[rana] \u2192 rana\r\n---------------------------------------------- */\r\nfunction extract_name(text) {\r\n    if (text.includes(\"[\")) {\r\n        return text.split(\"[\")[1].replace(\"]\", \"\").trim();\r\n    }\r\n    return text;\r\n}\r\n\r\n\r\n/* ---------------------------------------------\r\n   LOAD Potential Claims\r\n---------------------------------------------- */\r\nfunction load_potential_claims(frm, client_name) {\r\n\r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: \"Potential Claims\",\r\n            filters: { ph_name: client_name },\r\n            fields: [\r\n                \"invoice_attached\",\r\n                \"delivery_notes\",\r\n                \"sureties\",\r\n                \"cl_approval_form__annexure\",\r\n                \"order_attached\",\r\n                \"statement\",\r\n                \"claims_application_form\",\r\n                \"copies_of_correspondence_with_the_buyer\"\r\n            ]\r\n        },\r\n        callback(r) {\r\n            if (!r.message || r.message.length === 0) {\r\n                frappe.msgprint(\"No Potential Claim found for \" + client_name);\r\n                return;\r\n            }\r\n\r\n            let doc = r.message[0];\r\n\r\n            // SHOW ONLY CHECKED FIELDS\r\n            [\r\n                \"invoice_attached\",\r\n                \"delivery_notes\",\r\n                \"sureties\",\r\n                \"cl_approval_form__annexure\",\r\n                \"order_attached\",\r\n                \"statement\",\r\n                \"claims_application_form\",\r\n                \"copies_of_correspondence_with_the_buyer\"\r\n            ].forEach(f => {\r\n                if (doc[f] === 1) {\r\n                    frm.set_df_property(f, \"hidden\", 0);\r\n                    frm.doc[f] = 1;     // NO set_value\r\n                    frm.refresh_field(f);\r\n                }\r\n            });\r\n\r\n            // SHOW these 2 only in ECI/DCI (unchecked)\r\n            frm.set_df_property(\"claim_application\", \"hidden\", 0);\r\n            frm.refresh_field(\"claim_application\");\r\n\r\n            frm.set_df_property(\"statement_to_show\", \"hidden\", 0);\r\n            frm.refresh_field(\"statement_to_show\");\r\n        }\r\n    });\r\n}\r\n\r\n\r\n/* ---------------------------------------------\r\n   LOAD Bond Claims\r\n---------------------------------------------- */\r\nfunction load_bond_claims(frm, client_name) {\r\n\r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: \"Bond Claims\",\r\n            filters: { client: client_name },\r\n            fields: [\"demand_letter\", \"contractor_final_account_report\"]\r\n        },\r\n        callback(r) {\r\n            if (!r.message || r.message.length === 0) {\r\n                frappe.msgprint(\"No Bond Claim found for \" + client_name);\r\n                return;\r\n            }\r\n\r\n            let doc = r.message[0];\r\n\r\n            [\"demand_letter\", \"contractor_final_account_report\"].forEach(f => {\r\n                if (doc[f] === 1) {\r\n                    frm.set_df_property(f, \"hidden\", 0);\r\n                    frm.doc[f] = 1;     // NO set_value\r\n                    frm.refresh_field(f);\r\n                }\r\n            });\r\n        }\r\n    });\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Claim Processing Dci",
  "enabled": 1,
  "modified": "2025-11-17 07:52:28.805276",
  "module": "Finance",
  "name": "process dci data script",
  "script": " frappe.ui.form.on('Claim Processing Dci', {\n     refresh: function(frm) {\n        \n         \n        frm.fields_dict['claim_ammount'].$wrapper.find('input').css(\"text-align\", \"right\");\n        frm.fields_dict['insured_amt'].$wrapper.find('input').css(\"text-align\", \"right\");\n        frm.fields_dict['beci'].$wrapper.find('input').css(\"text-align\", \"right\");\n                frm.fields_dict['cost_saving'].$wrapper.find('input').css(\"text-align\", \"right\");\n\n    },\n    next: function(frm) {\n        frappe.route_options = {\n            name1: frm.doc.client,\n            policy_numberbond_number: frm.doc.policy_no,\n            type: frm.doc.type,\n            payment_ref_no: frm.doc.payment_ref_no,\n            buyer: frm.doc.buyer,\n            claim_ref_number: frm.doc.claim_ref_no,\n            claim_ammount: frm.doc.claim_ammount,\n            reinsure: frm.doc.reinsure,\n            status: frm.doc.status,\n            process_date: frm.doc.process_date,\n            cause_of_loss: frm.doc.cause_of_loss,\n            insured_amount: frm.doc.insured_amt,\n            beci: frm.doc.beci\n        };\n        frappe.new_doc('Claim Processing Dci Status');\n    }\n});\n\n ",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Claim Processing ECI",
  "enabled": 1,
  "modified": "2024-07-02 12:14:29.576985",
  "module": null,
  "name": "process eci script",
  "script": "  frappe.ui.form.on('Claim Processing ECI', {\n      refresh: function(frm) {\n        \n         \n        frm.fields_dict['claim_ammount'].$wrapper.find('input').css(\"text-align\", \"right\");\n        frm.fields_dict['insured_amt'].$wrapper.find('input').css(\"text-align\", \"right\");\n        frm.fields_dict['beci'].$wrapper.find('input').css(\"text-align\", \"right\");\n                frm.fields_dict['cost_saving'].$wrapper.find('input').css(\"text-align\", \"right\");\n\n    },\n    next: function(frm) {\n        frappe.route_options = {\n            name1: frm.doc.client,\n            policy_number_bond_number: frm.doc.policy_no,\n            type: frm.doc.type,\n            payment_ref_no: frm.doc.payment_ref_no,\n            buyer: frm.doc.buyer,\n            claim_ref_number: frm.doc.claim_ref_no,\n            claim_amount: frm.doc.claim_amount,\n            reinsure: frm.doc.reinsure,\n            status: frm.doc.status,\n            process_date: frm.doc.process_date,\n            cause_of_loss: frm.doc.cause_of_loss,\n            insured_amount: frm.doc.insured_amt,\n            beci: frm.doc.beci\n        };\n        frappe.new_doc('Claim Processing Eci Status');\n    },\n    \n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "CI Recoveries",
  "enabled": 1,
  "modified": "2025-12-05 09:23:30.978895",
  "module": "Finance",
  "name": "Cl Recoveries Script",
  "script": "frappe.ui.form.on('CI Recoveries', {\n refresh: function(frm) {\n     frm.set_df_property('childtable','cannot_add_rows', true);\n     \n     frm.fields_dict.claim_amount.$input.css(\"text-align\", \"right\");\n     frm.fields_dict.amt_recovered.$input.css(\"text-align\", \"right\");\n     frm.fields_dict.due.$input.css(\"text-align\", \"right\");\n     frm.fields_dict.amount_recovered.$input.css(\"text-align\", \"right\");\n     frm.fields_dict.reinsurer_percentage.$input.css(\"text-align\", \"right\");\n     frm.fields_dict.beci_percentage.$input.css(\"text-align\", \"right\");\n     frm.fields_dict.reinsurer_amount.$input.css(\"text-align\", \"right\");\n     frm.fields_dict.beci_amount.$input.css(\"text-align\", \"right\");\n     \n     \n        //  var workflow_state = frm.doc.workflow_state;\n        if (workflow_state === \"Approved\") {\n            frm.toggle_display('ph_name', false);\n            frm.toggle_display('policy_holder', true);\n            // frm.toggle_display('policy_no', false);\n            frm.toggle_display('policy_number', true);\n        }\n     \n//         // // Assuming workflow_state is defined somewhere\n//         // var workflow_state = frm.doc.workflow_state;\n\n//         // // Check if workflow_state is \"Approved\"\n//         // if (workflow_state === \"Approved\") {\n//         //     // Display policy_holder field and hide ph_name field\n//         //     frm.toggle_display('policy_holder', true);\n//         //     frm.toggle_display('ph_name', false);\n//         //  }\n//         //  //else {\n//         // //     // If not \"Approved\", ensure the fields are displayed\n//         // //     frm.toggle_display('policy_holder', true);\n//         // //     frm.toggle_display('ph_name', true);\n//         // // }\n        \n//         frm.fields_dict.addnew.$input.addClass('btn-primary');\n\n\n\t\t       var workflow_state = frm.doc.workflow_state || '';\n\n        // Keep bond_no always visible\n        frm.toggle_display('policy_no', true);\n\n        // Condition 1: If Approved \u2192 Read-only\n        // Condition 2: If NOT NEW (already saved) \u2192 Read-only\n        if (workflow_state === \"Approved\" || !frm.is_new()) {\n            frm.set_df_property('policy_no', 'read_only', 1);\n        } else {\n            // Only when NEW and not approved\n            frm.set_df_property('policy_no', 'read_only', 0);\n        }\n  },\n \t\n\tonload: function(frm) {\n        if (!frm.doc.recovery_no) {\n            generateNumberRecoveryNo(frm);\n        }\n        \t if (!frm.doc.receipt_no) {\n            generateNumberReceiptNo(frm);\n        }\n        \n         frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'CI Claim',\n                'filters': {\n                'workflow_state': 'Accepted'\n            },\n            'fields': ['ph_name'],\n                limit_page_length: 0\n            },\n            callback: function(response) {\n                if (response.message) {\n                    let uniquePolicyHolders = [...new Set(response.message.map(item => item.ph_name))];\n                    \n                    uniquePolicyHolders.sort();\n                    frm.set_df_property('ph_name', 'options', uniquePolicyHolders.join('\\n'));\n                }\n            }\n        }); \n    },\n    \n    \n    ph_name: function(frm) {\n        if (frm.doc.ph_name) {\n            frappe.call({\n    method: 'frappe.client.get_list',\n    args: {\n        doctype: 'CI Claim',\n        filters: { 'ph_name': frm.doc.ph_name },\n        fields: ['policyno']\n    },\n    callback: function(r) {\n        if (r.message) {\n            // Use Set to remove duplicates\n            let uniqueOptions = [...new Set(r.message.map(policy => policy.policyno))];\n\n            frm.set_df_property('policy_no', 'options', uniqueOptions.join('\\n'));\n            frm.refresh_field('policy_no');\n        }\n    }\n});\n\n        }\n    },\n    // policy_no: function(frm) {\n    //      var policyName = frm.doc.ph_name;\n\n    // // Set the value of policy_number field\n    //  frm.set_value('policy_holder', policyName);\n    //   frm.set_value('policy_number', policy_no);\n    \n    //     frappe.call({\n    //         method: 'frappe.client.get_list',\n    //         args: {\n    //             doctype: 'CI Claim',\n    //             filters: {\n    //                 policyno: frm.doc.policy_no\n    //             },\n    //             fields: ['buyer', 'claim_refno', 'claim_value__p', 'client_type']\n    //         },\n    //         callback: function(r) {\n               \n    //             if (!r.exc) {\n    //                 if (r.message && r.message.length > 0) {\n    //                     var data = r.message[0]; // Get the first record from the fetched data\n\n    //                     // frm.set_value('policy_no', data.policyno);\n    //                     frm.set_value('buyer', data.buyer); // Assuming 'client_type' is the correct field name\n    //                     frm.set_value('claim_ref_no', data.claim_refno);\n    //                     frm.set_value('claim_amount', data.claim_value__p);\n    //                     frm.set_value('policy_type', data.client_type);\n    //                 }\n    //             } else {\n    //                 frm.set_value('status', '');\n    //                 console.error(\"Error occurred:\", r.exc);\n    //             }\n    //         }\n    //     });\n    //     frappe.call({\n    //         method: 'frappe.client.get_list',\n    //         args: {\n    //             doctype: 'Assign_Lawyer',\n    //             filters: {\n    //               ph_name : frm.doc.ph_name\n    //             },\n    //             fields: ['lawyer', 'lawyer_']\n    //         },\n    //         callback: function(response) {\n    //             console.log(\"DCI Proposals response:\", response);\n    //             if (response.message && response.message.length > 0) {\n    //                 var data_from_proposals = response.message[0];\n    //                 // Populate fields if data is found\n    //                 frm.set_value('lawyer_debt_collector', data_from_proposals.lawyer || '');\n    //                 frm.set_value('lawyer', data_from_proposals.lawyer_ || '');\n    //             } else {\n    //                 // Clear fields if no matching record found\n    //                 frm.set_value('lawyer_debt_collector', '');\n    //                 frm.set_value('lawyer', '');\n    //             }\n    //         },\n    //         error: function(err) {\n    //             console.error(err);\n    //             //frappe.msgprint('An error occurred while fetching data from DCI Proposals. Please check the console for details.');\n    //         }\n    //     });\n    // },\n\n\npolicy_no: function(frm) {\n    if (!frm.doc.policy_no) {\n        frappe.msgprint(\"Please enter a Policy Number.\");\n        return;\n    }\n\n    // Set related field values\n    if (frm.doc.ph_name) {\n        frm.set_value('policy_holder', frm.doc.ph_name);\n    }\n    frm.set_value('policy_number', frm.doc.policy_no);\n\n    // \ud83d\udd39 Fetch data from CI Claim\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'CI Claim',\n            filters: {\n                policyno: frm.doc.policy_no\n            },\n            fields: ['buyer', 'claim_refno', 'claim_value__p', 'client_type']\n        },\n        callback: function(r) {\n            if (r.message && r.message.length > 0) {\n                let data = r.message[0];\n                frm.set_value('buyer', data.buyer || '');\n                frm.set_value('claim_ref_no', data.claim_refno || '');\n                frm.set_value('claim_amount', data.claim_value__p || '');\n                frm.set_value('policy_type', data.client_type || '');\n            } else {\n                // Clear fields if no record found\n                frm.set_value('buyer', '');\n                frm.set_value('claim_ref_no', '');\n                frm.set_value('claim_amount', '');\n                frm.set_value('policy_type', '');\n            }\n        },\n        error: function(err) {\n            console.error(\"Error fetching CI Claim data:\", err);\n        }\n    });\n\n    // \ud83d\udd39 Fetch data from Assign Lawyer\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Assign_Lawyer',\n            filters: {\n                ph_name: frm.doc.ph_name\n            },\n            fields: ['lawyer', 'lawyer_']\n        },\n        callback: function(response) {\n            if (response.message && response.message.length > 0) {\n                let data_from_proposals = response.message[0];\n                frm.set_value('lawyer_debt_collector', data_from_proposals.lawyer || '');\n                frm.set_value('lawyer', data_from_proposals.lawyer_ || '');\n            } else {\n                // Clear fields if no record found\n                frm.set_value('lawyer_debt_collector', '');\n                frm.set_value('lawyer', '');\n            }\n        },\n        error: function(err) {\n            console.error(\"Error fetching Assign Lawyer data:\", err);\n        }\n    });\n},\n\n    claim_amount: function(frm){\n\t    calculatedueamount(frm);\n\t    },\n\t    \n    amt_recovered: function(frm) {\n    // Call the function to calculate due amount\n    calculatedueamount(frm);\n\n    // Get the value of amt_recovered field\n    var amt_recovered = frm.doc.amt_recovered;\n\n    // Set the value of amount_recovered field\n    frm.set_value('amount_recovered', amt_recovered);\n},\n\n    reinsurer_percentage: function(frm){\n        calculateReinsurerAndBeci(frm);\n    },\n    \n    beci_percentage: function(frm) {\n        calculateReinsurerAndBeci(frm);\n    },\n    \n    addnew: function(frm){\n      addDataToChildTable(frm); \n    }\n     \n});\n\n\nfunction calculatedueamount(frm){\n   \n    var claimamount = parseFloat(frm.doc.claim_amount) || 0; // Convert to float and handle potential non-numeric input\n    var amtrecovered = parseFloat(frm.doc.amt_recovered) || 0; // Convert to float and handle potential non-numeric input\n   \n  var due = claimamount-amtrecovered;\n   \n  frm.set_value('due',due);\n    \n}\n\nfunction addDataToChildTable(frm, data) {\n    // Get the values from your fields\n    var recpt_no = frm.doc.receipt_no;\n    var amtreceived = frm.doc.amount_recovered;\n    var date = frm.doc.date;\n \n    // Check if all required fields are filled\n    if (!recpt_no || !amtreceived || !date ) {\n        frappe.msgprint('Please fill all the required fields');\n        return;\n    }\n \n    // Check if the data already exists in the child table for the same buyer\n    var exists = false;\n    if (frm.doc.CI_Recoveries) {\n        frm.doc.CI_Recoveries.forEach(function(row) {\n            if (row.recpt_no === recpt_no) {\n                frappe.msgprint('You can only have one entry for ' + recpt_no);\n                exists = true;\n                return false; // Stop iterating\n            }\n        });\n    }\n \n    // If data doesn't exist, insert it into the child table\n    if (!exists) {\n        // Prepare the data for the child table\n        var child_data = {\n            \"doctype\": \"CI Recoveries Child\",\n            \"parent\": frm.doc.receipt_no,\n            \"parenttype\": \"Profile\",\n            \"parentfield\": \"childtable\",\n            \"recpt_no\": recpt_no,\n            \"amtreceived\": amtreceived,\n            \"date\": date,\n        };\n \n        // Add a child to the child table\n        var child = frappe.model.add_child(frm.doc, \"CI Recoveries Child\", \"childtable\");\n \n        // Set the values in the child table row\n        frappe.model.set_value(child.doctype, child.name, \"recpt_no\", recpt_no);\n        frappe.model.set_value(child.doctype, child.name, \"amtreceived\", amtreceived);\n        frappe.model.set_value(child.doctype, child.name, \"date\", date);\n        \n        // Clear the fields\n        // frm.set_value('receipt_no', '');\n        // frm.set_value('amount_recovered', '');\n        // frm.set_value('date', '');\n       \n        // Refresh the form to show the new data in the child table\n        frm.refresh_field('childtable');\n    }\n}\n\nfunction calculateReinsurerAndBeci(frm) {\n    // Retrieve necessary values from the form\n    var amountRecovered = parseFloat(frm.doc.amount_recovered);\n    var lawyerPercentage = parseFloat(frm.doc.lawyer);\n    var reinsurerPercentage = parseFloat(frm.doc.reinsurer_percentage); // Modified to use values from the form\n    var beciPercentage = parseFloat(frm.doc.beci_percentage); // Modified to use values from the form\n\n    // Check if necessary values are valid numbers\n    if (isNaN(amountRecovered) || isNaN(lawyerPercentage) || isNaN(reinsurerPercentage) || isNaN(beciPercentage)) {\n        console.error(\"One or more input values are not valid numbers.\");\n        return; // Exit function if input values are not valid\n    }\n\n    // Calculate LawAmt\n    var lawAmt = amountRecovered * (lawyerPercentage / 100);\n    console.log(\"Law Amt:\", lawAmt);\n    // Calculate Remaining\n    var remaining = amountRecovered - lawAmt;\n\n    // Calculate reinsurer_amount and beci_amount\n    var reinsurerAmount = (remaining * (reinsurerPercentage / 100)).toFixed(2);\n    var beciAmount = (remaining * (beciPercentage / 100)).toFixed(2);\n\n    // Set values in the form\n    frm.set_value('reinsurer_amount', reinsurerAmount);\n    frm.set_value('beci_amount', beciAmount);\n}\n\n\n    \n    \nfunction generateNumberRecoveryNo(frm) {\n    if (!frm.doc.recovery_no) {\n        let currentYear = new Date().getFullYear();\n        let prefix = `REC/${currentYear}/`;\n\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'CI Recoveries',\n                fields: ['recovery_no', 'creation'],\n                order_by: 'creation desc',\n                limit: 1\n            },\n            callback: function(r) {\n                if (r.message && r.message.length > 0) {\n                    let lastProposalNo = r.message[0].recovery_no;\n                    if (lastProposalNo) {\n                        let lastNumber = parseInt(lastProposalNo.split(\"/\").pop());\n                        if (!isNaN(lastNumber)) {\n                            let newNumber = (lastNumber + 1).toString().padStart(4, '0');\n                            frm.set_value('recovery_no', prefix + newNumber);\n                            return;\n                        }\n                    }\n                }\n                // Fallback if no valid last number found\n                frm.set_value('recovery_no', prefix + '0001');\n            }\n        });\n    }\n}\n\n\n\nfunction generateNumberReceiptNo(frm) {\n    if (!frm.doc.receipt_no) {\n        let currentYear = new Date().getFullYear();\n        let prefix = `RCPT/${currentYear}/`;\n\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'CI Recoveries',\n                fields: ['receipt_no', 'creation'],\n                order_by: 'creation desc',\n                limit: 1\n            },\n            callback: function(r) {\n                if (r.message && r.message.length > 0) {\n                    let lastReceiptNo = r.message[0].receipt_no;\n                    if (lastReceiptNo) {\n                        let lastNumber = parseInt(lastReceiptNo.split(\"/\").pop());\n                        if (!isNaN(lastNumber)) {\n                            let newNumber = (lastNumber + 1).toString().padStart(4, '0');\n                            frm.set_value('receipt_no', prefix + newNumber);\n                            return;\n                        }\n                    }\n                }\n                // Fallback if no valid last number found\n                frm.set_value('receipt_no', prefix + '0001');\n            }\n        });\n    }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Bond  Recoveries",
  "enabled": 1,
  "modified": "2025-12-08 08:17:17.861294",
  "module": "Finance",
  "name": "Bond Recoveries",
  "script": "frappe.ui.form.on('Bond  Recoveries', {\n\trefresh(frm) {\n\t        frm.fields_dict.add_new.$input.addClass('btn-primary');\n\n\t     frm.set_df_property('bond_recoveries','cannot_add_rows', true);\n\t\t// your code here\n\t\t   if (!frm.doc.recovery_no) {\n            generateNumberRecoveryNo(frm);\n        }\n        \t if (!frm.doc.receipt_no) {\n            generateNumberReceiptNo(frm);\n        }\n        \n         var workflowState = frm.doc.workflow_state;\n\n        // Create a custom button for \"Bond Invoice\" if the workflow state is \"Submitted\"\n        if (workflowState === \"Approved\") {\n            \n            frm.toggle_display('bondno', true);\n            frm.toggle_display('bondholder', true);\n            frm.toggle_display('bond_no', false);\n            frm.toggle_display('bond_holder', false);\n\n        }\n\n        \n\t},\n\t\n\tonload: function(frm) { \n    frappe.call({\n      method: 'frappe.client.get_list',\n      args: {\n        'doctype': 'Bond Claims',\n        'filters': {\n          'workflow_state': 'Approved'\n        },\n        'fields': ['client']\n      },\n      callback: function(submittedProposalsResponse) {\n        if (submittedProposalsResponse.message) {\n          var submittedProposals = submittedProposalsResponse.message.map(function(proposal) {\n            return proposal.client;\n          });\n          console.log(\"** Submitted Proposals:\", submittedProposals);\n \n          console.log(\"** Fetching Approved Quotations **\");\n          frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n              'doctype': 'Bond  Recoveries',\n              'filters': {\n                'workflow_state': 'Approved'\n              },\n              'fields': ['bond_holder']\n            },\n            callback: function(approvedQuotationsResponse) {\n                console.log(approvedQuotationsResponse,\"approvedQuotationsResponse\")\n              if (approvedQuotationsResponse.message) {\n                var approvedQuotations = approvedQuotationsResponse.message.map(function(quotation) {\n                  return quotation.bond_holder;\n                });\n                console.log(\"** Approved Quotations:\", approvedQuotations);\n \n                // Filter client names (include only proposals not in approved quotations)\n                var filteredClientNames = submittedProposals.filter(function(proposal) {\n                    \n                  return !approvedQuotations.includes(proposal);\n                 \n                });\n                 filteredClientNames.sort();\n                console.log(\"** Filtered Client Names:\", filteredClientNames);\n                  frm.set_df_property('bond_holder', 'options', filteredClientNames);\n \n                \n              }\n            }\n          }); // Close inner frappe.call\n        }\n      }\n    }); // Close outer frappe.call\n    \n    // frappe.call({\n    //   method: 'frappe.client.get_list',\n    //   args: {\n    //     'doctype': 'Bond Claims',\n    //     'filters': {\n    //       'workflow_state': 'Approved'\n    //     },\n    //     'fields': ['bond_no']\n    //   },\n    //   callback: function(submittedProposalsResponse) {\n    //     if (submittedProposalsResponse.message) {\n    //       var submittedProposals = submittedProposalsResponse.message.map(function(proposal) {\n    //         return proposal.bond_no;\n    //       });\n    //       console.log(\"** Submitted Proposals:\", submittedProposals);\n \n    //       console.log(\"** Fetching Approved Quotations **\");\n    //       frappe.call({\n    //         method: 'frappe.client.get_list',\n    //         args: {\n    //           'doctype': 'Bond  Recoveries',\n    //           'filters': {\n    //             'workflow_state': 'Approved'\n    //           },\n    //           'fields': ['bond_no']\n    //         },\n    //         callback: function(approvedQuotationsResponse) {\n    //             console.log(approvedQuotationsResponse,\"approvedQuotationsResponse\")\n    //           if (approvedQuotationsResponse.message) {\n    //             var approvedQuotations = approvedQuotationsResponse.message.map(function(quotation) {\n    //               return quotation.bond_no;\n    //             });\n    //             console.log(\"** Approved Quotations:\", approvedQuotations);\n \n    //             // Filter client names (include only proposals not in approved quotations)\n    //             var filteredClientNames = submittedProposals.filter(function(proposal) {\n    //               return !approvedQuotations.includes(proposal);\n    //             });\n    //             console.log(\"** Filtered Client Names:\", filteredClientNames);\n    //               frm.set_df_property('bond_no', 'options', filteredClientNames);\n \n    //             // Set dropdown query with filtered names\n    //           //  frm.set_query('client_name', function() {\n    //             //  return {\n    //              //   filters: {\n    //               //    'name': ['in', filteredClientNames]\n    //               // }\n    //               //};\n    //           // });\n    //           }\n    //         }\n    //       }); // Close inner frappe.call\n    //     }\n    //   }\n    // }); // Close outer frappe.call\n\n    },\n    \n    \n    \n    \n    bond_holder: function(frm){\n        \n        var bondholder = frm.doc.bond_holder;\n\t    frm.set_value('bondholder',bondholder);\n\t    \n        \n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Bond Claims',\n                filters: {\n                    client: frm.doc.bond_holder\n                },\n                fields: ['bond_no']\n            },\n            callback: function(response) {\n                console.log(\"DCI Proposals response:\", response);\n                if (response.message && response.message.length > 0) {\n                    var data_from_proposals = response.message[0];\n \n                    // Populate fields if data is found\n                    // frm.set_value('bond_holder', data_from_proposals.client || '');\n                   frm.set_df_property('bond_no', 'options', data_from_proposals.bond_no);\n                   \n                } else {\n                    // Clear fields if no matching record found\n                    // frm.set_value('bond_holder', '');\n                    \n               \n                }\n            },\n            error: function(err) {\n                console.error(err);\n                frappe.msgprint('An error occurred while fetching data from DCI Proposals. Please check the console for details.');\n            }\n        }); \n    },\n \n\tbond_no: function(frm) {\n\t    \n\t    var bondno = frm.doc.bond_no;\n\t    frm.set_value('bondno',bondno);\n\t    \n       \n        // Fetch data from DCI Proposals based on selected client name\n        //   frappe.call({\n        //     method: 'frappe.client.get_list',\n        //     args: {\n        //         doctype: 'Bond Claims',\n        //         filters: {\n        //             client: frm.doc.bond_holder,\n        //             bond_no: frm.doc.bond_no\n        //         },\n        //         fields: ['principal', 'claim_ref_no','reinsurer', 'workflow_state']\n        //     },\n        //     callback: function(response) {\n        //         console.log(\"DCI Proposals response:\", response);\n        //         if (response.message && response.message.length > 0) {\n        //             var data_from_proposals = response.message[0];\n \n        //             // Populate fields if data is found\n                   \n        //             frm.set_value('principal', data_from_proposals.principal || '');\n        //             frm.set_value('claim_refno', data_from_proposals.claim_ref_no || '');\n        //             frm.set_value('reinsurer', data_from_proposals.reinsurer || '');\n        //             frm.set_value('status', res.message[0].workflow_state);\n        //         } else {\n        //             // Clear fields if no matching record found\n                \n        //             frm.set_value('principal', '');\n        //             frm.set_value('claim_refno', '');\n        //             frm.set_value('reinsurer', '');\n        //             frm.set_value('status', '');\n               \n        //         }\n        //     },\n        //     error: function(err) {\n        //         console.error(err);\n        //         frappe.msgprint('An error occurred while fetching data from DCI Proposals. Please check the console for details.');\n        //     }\n        // });\n        \n        frappe.call({\n    method: 'frappe.client.get_list',\n    args: {\n        doctype: 'Bond Claims',\n        filters: {\n            client: frm.doc.bond_holder,\n            bond_no: frm.doc.bond_no\n        },\n        fields: ['principal', 'claim_ref_no', 'reinsurer', 'workflow_state'],\n        limit_page_length: 1\n    },\n    callback: function(response) {\n        console.log(\"Bond Claims response:\", response);\n\n        if (response.message && response.message.length > 0) {\n            let data = response.message[0];\n\n            // Populate fields\n            frm.set_value('principal', data.principal || '');\n            frm.set_value('claim_refno', data.claim_ref_no || '');\n            frm.set_value('reinsurer', data.reinsurer || '');\n            frm.set_value('status', data.workflow_state || '');\n\n        } else {\n            // Reset fields if no record found\n            frm.set_value('principal', '');\n            frm.set_value('claim_refno', '');\n            frm.set_value('reinsurer', '');\n            frm.set_value('status', '');\n        }\n    },\n    error: function(err) {\n        console.error(err);\n        frappe.msgprint('An error occurred while fetching Bond Claims data.');\n    }\n});\n\n          frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Assign_Lawyer',\n                filters: {\n                  ph_name : frm.doc.bond_holder\n                },\n                fields: ['lawyer', 'lawyer_']\n            },\n            callback: function(response) {\n                console.log(\"DCI Proposals response:\", response);\n                if (response.message && response.message.length > 0) {\n                    var data_from_proposals = response.message[0];\n \n                    // Populate fields if data is found\n                    frm.set_value('lawerdebt_collector', data_from_proposals.lawyer || '');\n                    frm.set_value('lawer_', data_from_proposals.lawyer_ || '');\n                  \n                } else {\n                    // Clear fields if no matching record found\n                    frm.set_value('lawerdebt_collector', '');\n                    frm.set_value('lawer_', '');\n                  \n                }\n            },\n            error: function(err) {\n                console.error(err);\n                frappe.msgprint('An error occurred while fetching data from DCI Proposals. Please check the console for details.');\n            }\n        });\n        \n        //   frappe.call({\n        //     method: 'frappe.client.get_list',\n        //     args: {\n        //         doctype: 'claim Processing',\n        //         filters: {\n        //           client  : frm.doc.bond_holder\n        //         },\n        //         fields: ['status', 'claimamount','reinsure']\n        //     },\n        //     callback: function(response) {\n        //         console.log(\"DCI Proposals response:\", response);\n        //         if (response.message && response.message.length > 0) {\n        //             var data_from_proposals = response.message[0];\n \n        //             // Populate fields if data is found\n        //             frm.set_value('status', data_from_proposals.status || '');\n        //             frm.set_value('claim_amount', data_from_proposals.claimamount || '');\n        //             frm.set_value('reinsurer_percentage', data_from_proposals.reinsure || '');\n                  \n        //         } else {\n        //             // Clear fields if no matching record found\n        //             frm.set_value('status', '');\n        //             frm.set_value('claim_amount', '');\n        //             frm.set_value('reinsurer_percentage', '');\n                   \n        //         }\n        //     },\n        //     error: function(err) {\n        //         console.error(err);\n        //         frappe.msgprint('An error occurred while fetching data from DCI Proposals. Please check the console for details.');\n        //     }\n        // });\n        \n        \n    },\n\t\n    add_new: function(frm){\n        \n        var amontrecovered = frm.doc.amtrecovered;\n        var paymentreceiptno = frm.doc.receipt_no;\n     frappe.prompt([\n        {'fieldname': 'amount_recovered', 'fieldtype': 'Data', 'label': 'Amount Recovered','default': amontrecovered },\n        \n        {'fieldname': 'payment_mode', 'fieldtype': 'Select', 'label': 'Payment Mode', 'options': ['BANK DIRECT DEPOSIT', 'BANK GUARANTEE', 'CREDIT CARD', 'CHEQUE', 'CASH']},\n        \n        {'fieldname': 'column_break', 'fieldtype': 'Column Break', 'label': ''}, // Column Break\n        \n        {'fieldname': 'date', 'fieldtype': 'Date', 'label': 'Date'},\n        \n        {'fieldname': 'payment_no', 'fieldtype': 'Data', 'label': 'Payment No','default':paymentreceiptno},\n        \n       \n       \n    ],\n    function(values) {\n            // Check if all required fields are filled\n                var data = {\n                    amountrecovered: values.amount_recovered,\n                    paymentmode: values.payment_mode,\n                    date: values.date,\n                    paymentno: values.payment_no\n                };\n                \n            // Save the object to LocalStorage\n            localStorage.setItem('Bond Recoveries Child Table', JSON.stringify(data));\n            \n            \n            // Retrieve the data from LocalStorage\n            var Bond_recoveries = JSON.parse(localStorage.getItem('Bond Recoveries Child Table'));\n            \n          \n            \n            // Add the retrieved data to the child table\n            addDataToChildTable(frm, Bond_recoveries);\n             \n        },\n        'Bond Recoveries');\n    \n    \n\t},\n\t\n\tclaim_amount: function(frm){\n\t    \n\t    calculatedueamount(frm);\n\t},\n\t\n\tamtrecovered: function(frm){\n\t    \n\t      calculatedueamount(frm);\n\t    \n\t},\n\t\n\n  \t\n\t\n});\n\nfunction calculatedueamount(frm){\n   \n    var claimamount = parseFloat(frm.doc.claim_amount) || 0; // Convert to float and handle potential non-numeric input\n    var amtrecovered = parseFloat(frm.doc.amtrecovered) || 0; // Convert to float and handle potential non-numeric input\n   \n   var due = claimamount-amtrecovered;\n   \n   frm.set_value('due',due);\n    \n}\n    \n\n\nfunction addDataToChildTable(frm, data) {\n    var childTable = frm.fields_dict['bond_recoveries'].grid;\n    var newRow = childTable.add_new_row();\n    frappe.model.set_value(newRow.doctype, newRow.name, 'recptno', data.paymentno);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'amtreceived', data.amountrecovered);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'date', data.date);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'payment_mode', data.paymentmode);\n    \n    childTable.refresh();\n}\n\nfunction generateNumberRecoveryNo(frm) {\n    // Check if the proposal number field is already populated\n    if (!frm.doc.recovery_no) {\n        // Get the current year\n        let currentYear = new Date().getFullYear();\n        let prefix = `REC/${currentYear}/`;\n \n        // Make a call to get the last number asynchronously\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Bond  Recoveries',\n                fields: ['recovery_no', 'creation'],\n                order_by: 'creation desc',\n                limit: 1\n            },\n            callback: function(r) {\n                console.log(r,\"recovery no\");\n                if (r.message && r.message.length > 0) {\n                    let lastProposalNo = r.message[0].recovery_no;\n                    let lastNumber = parseInt(lastProposalNo.split(\"/\").pop()); // Extract last part and parse it as integer\n                    if (!isNaN(lastNumber)) {\n                        // Increment the last number and pad it with leading zeros\n                        let newNumber = (lastNumber + 1).toString().padStart(4, '0');\n                        frm.set_value('recovery_no', prefix + newNumber);\n                    }\n                } else {\n                    // If no previous numbers exist, set to default '0001'\n                    frm.set_value('recovery_no', prefix + '0001');\n                }\n            }\n        });\n    }\n}\nfunction generateNumberReceiptNo(frm) {\n    // Check if the proposal number field is already populated\n    if (!frm.doc.receipt_no) {\n        // Get the current year\n        let currentYear = new Date().getFullYear();\n        let prefix = `RCPT/${currentYear}/`;\n \n        // Make a call to get the last number asynchronously\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Bond  Recoveries',\n                fields: ['receipt_no', 'creation'],\n                order_by: 'creation desc',\n                limit: 1\n            },\n            callback: function(r) {\n                console.log(r,\"receipt no\");\n                if (r.message && r.message.length > 0) {\n                    let lastProposalNo = r.message[0].receipt_no;\n                    let lastNumber = parseInt(lastProposalNo.split(\"/\").pop()); // Extract last part and parse it as integer\n                    if (!isNaN(lastNumber)) {\n                        // Increment the last number and pad it with leading zeros\n                        let newNumber = (lastNumber + 1).toString().padStart(4, '0');\n                        frm.set_value('receipt_no', prefix + newNumber);\n                    }\n                } else {\n                    // If no previous numbers exist, set to default '0001'\n                    frm.set_value('receipt_no', prefix + '0001');\n                }\n            }\n        });\n    }\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "CI Claim",
  "enabled": 1,
  "modified": "2025-11-20 07:20:46.416413",
  "module": null,
  "name": "Claim Script",
  "script": "frappe.ui.form.on('CI Claim', {\r\n    onload: function(frm) {\r\n    \r\n   \r\n    frm.set_df_property('ci_claim_table', 'cannot_add_rows', true);\r\n\r\nvar workflow_state = frm.doc.workflow_state || '';\r\n \r\n// Always keep original fields visible\r\nfrm.toggle_display('ph_name', true);\r\nfrm.toggle_display('policyno', true);\r\nfrm.toggle_display('buyer', true);\r\nfrm.toggle_display('potential_claim_no', true);\r\n \r\n// Make them read-only when approved\r\nif (workflow_state === \"Approved\") {\r\n    frm.set_df_property('ph_name', 'read_only', 1);\r\n    frm.set_df_property('policyno', 'read_only', 1);\r\n    frm.set_df_property('buyer', 'read_only', 1);\r\n    frm.set_df_property('potential_claim_no', 'read_only', 1);\r\n} else {\r\n    frm.set_df_property('ph_name', 'read_only', 0);\r\n    frm.set_df_property('policyno', 'read_only', 0);\r\n    frm.set_df_property('buyer', 'read_only', 0);\r\n    frm.set_df_property('potential_claim_no', 'read_only', 0);\r\n}\r\n        \r\n\r\n frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Potential Claims',\r\n            fields: ['ph_name'],\r\n            limit_page_length: 0\r\n        },\r\n        callback: function(response) {\r\n            if (response.message && response.message.length) {\r\n                let phOptions = Array.from(new Set(response.message.map(r => r.ph_name.trim()))).sort();\r\n                frm.set_df_property('ph_name', 'options', phOptions.join('\\n'));\r\n            }\r\n        }\r\n    });\r\n        generateClaimNumber(frm);\r\n    },\r\n\r\n\r\nph_name: function(frm) {\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Potential Claims',\r\n            filters: { ph_name: frm.doc.ph_name },\r\n            fields: ['policyno'],\r\n            limit_page_length: 0\r\n        },\r\n        callback: function(response) {\r\n            if (response.message && response.message.length) {\r\n                let policyNumbers = Array.from(new Set(response.message.map(r => r.policyno)));\r\n                frm.set_df_property('policyno', 'options', policyNumbers.join('\\n'));\r\n\r\n                if (!policyNumbers.includes(frm.doc.policyno)) {\r\n                    frm.set_value('policyno', '');\r\n                }\r\n            }\r\n        }\r\n    });\r\n},\r\npolicyno: function(frm) {\r\n     frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Potential Claims',\r\n            filters: { policyno: frm.doc.policyno },\r\n            fields: ['buyer'],\r\n            limit_page_length: 0\r\n        },\r\n        callback: function(response) {\r\n            if (response.message && response.message.length) {\r\n                let buyers = Array.from(new Set(response.message.map(r => r.buyer)));\r\n                frm.set_df_property('buyer', 'options', buyers.join('\\n'));\r\n\r\n                if (!buyers.includes(frm.doc.buyer)) {\r\n                    frm.set_value('buyer', '');\r\n                }\r\n            }\r\n        }\r\n    });\r\n},\r\nbuyer: function(frm) {\r\n   frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Potential Claims',\r\n            filters: { buyer: frm.doc.buyer },\r\n            fields: [\r\n                'terms_of_payment', 'claim_ref_no', 'cause_of_loss', 'claim_date',\r\n                'inception_date', 'credit_limit', 'cl_inception_date', 'cl_expiry_date',\r\n                'client_type', 'claim_value', 'policyno'\r\n            ],\r\n            \r\n        },\r\n        callback: function(response) {\r\n            if (response.message && response.message.length > 0) {\r\n                let data = response.message[0];\r\n                frm.set_value('terms_of_payment', data.terms_of_payment);\r\n                frm.set_value('cause_of_loss', data.cause_of_loss);\r\n                frm.set_value('cl_claim_date', data.claim_date);\r\n                frm.set_value('credit_limit', data.credit_limit);\r\n                frm.set_value('inception_date', data.inception_date);\r\n                frm.set_value('cl_inception_date', data.cl_inception_date);\r\n                frm.set_value('cl_expiry_date', data.cl_expiry_date);\r\n                frm.set_value('client_type', data.client_type);\r\n                  frm.set_value('claim_value__p', data.claim_value);\r\n                frm.set_value('policyno', data.policyno);\r\n\r\n                let claimRefNos = Array.from(new Set(response.message.map(r => r.claim_ref_no)));\r\n                frm.set_df_property('potential_claim_no', 'options', claimRefNos.join('\\n'));\r\n            }\r\n        }\r\n    }); \r\n},\r\npotential_claim_no: function(frm){\r\n     frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Potential Claims',\r\n            filters: { buyer: frm.doc.buyer },\r\n            fields: ['claim_ref_no'],\r\n            limit_page_length: 1000\r\n        },\r\n        callback: function(response) {\r\n            if (response.message && response.message.length) {\r\n                let claimNos = Array.from(new Set(response.message.map(r => r.claim_ref_no)));\r\n                frm.set_df_property('potential_claim_no', 'options', claimNos.join('\\n'));\r\n            }\r\n        }\r\n    });\r\n    \r\n    \r\n    frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: {\r\n                doctype: \"Potential Claims\",\r\n                filters: { ph_name: frm.doc.ph_name }\r\n            },\r\n            callback: function(r) {\r\n                console.log(\"Bond Facility Response:\", r);\r\n \r\n                if (!r.exc && r.message && r.message.potential_claim_table && r.message.potential_claim_table.length > 0) {\r\n                    const data = r.message.potential_claim_table;\r\n \r\n                    // Clear the existing rows before adding new ones\r\n                    frm.clear_table('potential_claim_table');\r\n \r\n                    data.forEach(x => {\r\n                        const child = frappe.model.add_child(frm.doc, \"CI Claim Child\", \"ci_claim_table\");\r\n                        frappe.model.set_value(child.doctype, child.name, \"invoice_no\", x.invoice_no);\r\n                        frappe.model.set_value(child.doctype, child.name, \"type\", x.type);\r\n                        frappe.model.set_value(child.doctype, child.name, \"date\", x.date);\r\n                        frappe.model.set_value(child.doctype, child.name, \"amount\", x.amount);\r\n                        frappe.model.set_value(child.doctype, child.name, \"balance\", x.balance);\r\n                        frappe.model.set_value(child.doctype, child.name, \"amt_wo_vat\", x.amt_wo_vat);\r\n                         frappe.model.set_value(child.doctype, child.name, \"statement_date\", x.statement_date);\r\n                        frappe.model.set_value(child.doctype, child.name, \"duedate\", x.due_date);\r\n                        frappe.model.set_value(child.doctype, child.name, \"os_amt\", x.os_amt);\r\n                        \r\n                        \r\n                        \r\n                    });\r\n \r\n                    frm.refresh_field('ci_claim_table');\r\n                } else {\r\n                    console.warn(\"No Buyer Experience data found in DCI Proposals for this client.\");\r\n                }\r\n            }\r\n        });\r\n    \r\n}\r\n\r\n  \r\n});\r\n\r\nfunction generateClaimNumber(frm) {\r\n    if (!frm.doc.claim_refno) {\r\n        let currentYear = new Date().getFullYear();\r\n        let prefix = `CLM/${currentYear}/`;\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'CI Claim',\r\n                fields: ['claim_refno', 'creation'],\r\n                order_by: 'creation desc',\r\n                limit: 1\r\n            },\r\n            callback: function(r) {\r\n                console.log(r, \"claim ref no\");\r\n                if (r.message && r.message.length > 0) {\r\n                    let lastClaimRefNo = r.message[0].claim_refno;\r\n                    let lastNumber = parseInt(lastClaimRefNo.split(\"/\").pop());\r\n                    if (!isNaN(lastNumber)) {\r\n                        let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n                        frm.set_value('claim_refno', prefix + newNumber);\r\n                    }\r\n                } else {\r\n                    frm.set_value('claim_refno', prefix + '0001');\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Claim Processing Dci Status",
  "enabled": 1,
  "modified": "2024-04-25 11:34:53.466306",
  "module": "Finance",
  "name": "calculation dci",
  "script": " \r\nfrappe.ui.form.on('Claim Processing Dci Status', {\r\n    // Trigger the calculation when the claim_amount field changes\r\n    claim_ammount: function(frm) {\r\n        calculatePaymentAmount(frm);\r\n    }\r\n});\r\n\r\nfunction calculatePaymentAmount(frm) {\r\n    // Get the value of claim_amount from the form\r\n    var claimAmount = frm.doc.claim_ammount || 0;\r\n\r\n    // Calculate payment amount based on claim_amount\r\n    var paymentAmount = (claimAmount * 80) / 100;\r\n\r\n    // Set the calculated payment amount to the field\r\n    frm.set_value('payment_amount', paymentAmount);\r\n}\r\n\r\n// Automatically trigger calculation on form load\r\nfrappe.ui.form.on('Claim Processing Dci Status', {\r\n    onload: function(frm) {\r\n        // Call the calculation function\r\n        calculatePaymentAmount(frm);\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Insured_Main",
  "enabled": 0,
  "modified": "2024-04-26 08:35:35.589458",
  "module": null,
  "name": "data from insured details",
  "script": "frappe.ui.form.on('Insured_Main', {\r\n    name1: function(frm) {\r\n        var ClientName = frm.doc.name1;\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Insure_Details',\r\n                filters: {\r\n                    name1: ClientName\r\n                },\r\n                fields: ['name1', 'short_name', 'postal_address', 'location', 'physical_address', 'location1',\r\n\t\t\t\t'telephone', 'fax', 'status', 'country', 'vat_registration_no', 'contact_person', 'e_mail']\r\n            },\r\n            callback: function(response) {\r\n                console.log(\"response:\", response);\r\n                if (response.message && response.message.length > 0) {\r\n                    var data = response.message[0];\r\n\r\n                    // Populate fields if data is found\r\n                    frm.set_value('name1', data.name1 || '');\r\n                    frm.set_value('shortname', data.short_name || '');\r\n                    frm.set_value('location1', data.location1 || '');\r\n\t\t\t\t\t\r\n\t\t\t\t\tfrm.set_value('location', data.location || '');\r\n                    frm.set_value('physicaladdress', data.physical_address || '');\r\n                    frm.set_value('postaladdress', data.postal_address || '');\r\n\t\t\t\t\t\r\n\t\t\t\t\tfrm.set_value('telephone', data.telephone || '');\r\n                    frm.set_value('fax', data.fax || '');\r\n                    frm.set_value('status', data.status || '');\r\n\t\t\t\t\t\r\n\t\t\t\t\tfrm.set_value('country', data.country || '');\r\n                    frm.set_value('vatregistrationno', data.vat_registration_no || '');\r\n                    frm.set_value('contactperson', data.contact_person || '');\r\n\t\t\t\t\tfrm.set_value('email', data.e_mail || '');\r\n                } else {\r\n                    // Clear fields if no matching record found\r\n                    frm.set_value('', '');\r\n                  \r\n                    frappe.msgprint('No matching record ');\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error(err);\r\n                frappe.msgprint('An error occurred while fetching data ');\r\n            }\r\n        });\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Claim Processing Eci Status",
  "enabled": 1,
  "modified": "2024-04-25 11:38:13.501101",
  "module": "Finance",
  "name": "calculation eci",
  "script": "frappe.ui.form.on('Claim Processing Eci Status', {\n \n\t  \n \n    // Trigger the calculation when the claim_amount field changes\n    claim_amoun: function(frm) {\n        calculatePaymentAmount(frm);\n    }\n});\n\nfunction calculatePaymentAmount(frm) {\n    // Get the value of claim_amount from the form\n    var claimAmount = frm.doc.claim_amoun || 0;\n\n    // Calculate payment amount based on claim_amount\n    var paymentAmount = (claimAmount * 85) / 100;\n\n    // Set the calculated payment amount to the field\n    frm.set_value('payment_amount', paymentAmount);\n}\n\n// Automatically trigger calculation on form load\nfrappe.ui.form.on('Claim Processing Eci Status', {\n    onload: function(frm) {\n        // Call the calculation function\n        calculatePaymentAmount(frm);\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Claim Processing Bond Claim",
  "enabled": 1,
  "modified": "2024-07-02 12:19:27.380883",
  "module": "Finance",
  "name": "calculation bond claim",
  "script": "frappe.ui.form.on('Claim Processing Bond Claim', {\n \n\n    // Trigger the calculation when the claim_amount field changes\n    claim_ammount: function(frm) {\n        calculatePaymentAmount(frm);\n    },\n     refresh: function(frm) {\n        \n         \n        frm.fields_dict['claim_ammount'].$wrapper.find('input').css(\"text-align\", \"right\");\n        frm.fields_dict['insured_amt'].$wrapper.find('input').css(\"text-align\", \"right\");\n        frm.fields_dict['beci'].$wrapper.find('input').css(\"text-align\", \"right\");\n                frm.fields_dict[' payment_amount'].$wrapper.find('input').css(\"text-align\", \"right\");\n\n    },\n});\n\nfunction calculatePaymentAmount(frm) {\n    // Get the value of claim_amount from the form\n    var claimAmount = frm.doc.claim_ammount || 0;\n\n    // Calculate payment amount based on claim_amount\n    var paymentAmount = (claimAmount * 70) / 100;\n\n    // Set the calculated payment amount to the field\n    frm.set_value('payment_amount', paymentAmount);\n}\n\n// Automatically trigger calculation on form load\nfrappe.ui.form.on('Claim Processing Bond Claim', {\n    onload: function(frm) {\n        // Call the calculation function\n        calculatePaymentAmount(frm);\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Insured_Main",
  "enabled": 0,
  "modified": "2024-04-26 07:42:45.059983",
  "module": null,
  "name": "short_name script",
  "script": "frappe.ui.form.on('Insured_Main', {\r\n    name1: function(frm) {\r\n        // Get the value entered in the name1 field\r\n        var name1Value = frm.doc.name1;\r\n        \r\n        // Check if the name1 value is not empty and has at least 4 characters\r\n        if (name1Value && name1Value.length >= 4) {\r\n            // Extract the first 4 characters from the name1 value\r\n            var shortNameValue = name1Value.substring(0, 4);\r\n            \r\n            // Set the shortname field value to the extracted short name\r\n            frm.set_value('shortname', shortNameValue);\r\n        } else {\r\n            // If name1 value is empty or has less than 4 characters, clear the shortname field\r\n            frm.set_value('shortname', '');\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Insured_Details",
  "enabled": 1,
  "modified": "2024-04-26 08:26:20.054167",
  "module": null,
  "name": "Insured_Details short name",
  "script": "frappe.ui.form.on('Insured_Details', {\r\n    name1: function(frm) {\r\n        var name1Value = frm.doc.name1;\r\n        \r\n        if (name1Value && name1Value.length >= 4) {\r\n            var shortNameValue = name1Value.substring(0, 4);\r\n            \r\n      \r\n            frm.set_value('short_name', shortNameValue);\r\n        } else {\r\n            frm.set_value('short_name', '');\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Insured_Details",
  "enabled": 1,
  "modified": "2024-04-26 08:21:45.499360",
  "module": null,
  "name": "company details",
  "script": "frappe.ui.form.on('Insured_Details', {\r\n\r\n    \r\n    refresh: function(frm) {\r\n        // Fetch policy_holder from Policy Approvals\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Country Details',\r\n                fields: ['country']\r\n            },\r\n            callback: function(response) {\r\n                console.log(\"country received:\", response);\r\n                if (response.message) {\r\n                    let finalArray = response.message.map(x => x.country);\r\n                    frm.set_df_property('country', 'options', finalArray);\r\n                    console.log(\"final\", finalArray);\r\n                }\r\n            },\r\n            error: function(xhr, textStatus, errorThrown) {\r\n                console.error(\"Error fetching policy holders:\", textStatus, errorThrown);\r\n            }\r\n        });\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "_liked_by": "[]",
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "ECI Quotations",
  "enabled": 1,
  "modified": "2025-12-08 13:43:00.293625",
  "module": "Marketing",
  "name": "ECI Quotations Script",
  "script": "frappe.ui.form.on('ECI Quotations', {\r\n    \r\n\r\n\r\n    \r\n     \r\nrefresh: function(frm) {\r\n     frm.set_df_property('eci_quo_table', 'cannot_add_rows', true);\r\n    \r\n    let workflow_state = frm.doc.workflow_state || '';\r\n\r\n        // \u2705 Always show fields\r\n        frm.set_df_property('proposal_no', 'hidden', 0);\r\n        frm.set_df_property('client_name', 'hidden', 0);\r\n\r\n        // \u2705 Read-only only when Approved\r\n        if (workflow_state === \"Approved\") {\r\n            frm.set_df_property('proposal_no', 'read_only', 1);\r\n            frm.set_df_property('client_name', 'read_only', 1);\r\n        } else {\r\n            frm.set_df_property('proposal_no', 'read_only', 0);\r\n            frm.set_df_property('client_name', 'read_only', 0);\r\n        }\r\n        \r\n\r\n\r\n        // \u2705 Force UI refresh\r\n        frm.refresh_field('proposal_no');\r\n        frm.refresh_field('client_name');\r\n\r\n\r\n\r\n    \r\n    generateScheduleNumber(frm);\r\n  \r\n    attachClickHandlers(frm);\r\n   \r\n    alignFieldsRight(frm);\r\n    \r\n\r\n\r\n\r\n},\r\n    \r\n onload: function(frm){\r\n   \r\n\r\n\r\n//Alphbeticl order\r\n\r\nfrappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'ECI Proposal',\r\n        filters: { 'workflow_state': 'Submitted' },\r\n        fields: ['client_name'],\r\n        limit_page_length: 9999\r\n    },\r\n    callback: function(submittedProposalsResponse) {\r\n\r\n        if (submittedProposalsResponse.message) {\r\n            let submittedProposals = submittedProposalsResponse.message.map(x => x.client_name);\r\n\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'ECI Quotations',\r\n                    filters: { 'workflow_state': 'Approved' },\r\n                    fields: ['client_name'],\r\n                    limit_page_length: 9999\r\n                },\r\n                callback: function(response) {\r\n\r\n                    let quotations = response.message.map(x => x.client_name);\r\n\r\n                    // Combine + remove duplicates\r\n                    let combinedNames = [...new Set([...submittedProposals, ...quotations])];\r\n\r\n                    // \u2705 Sort alphabetically\r\n                    combinedNames.sort();\r\n\r\n                    // Ensure 'frm' is defined\r\n                    if (typeof frm !== \"undefined\") {\r\n                        frm.set_df_property('client_name', 'options', combinedNames);\r\n                    }\r\n\r\n                    console.log(\"Final (sorted) client names:\", combinedNames);\r\n                }\r\n            });\r\n        }\r\n    }\r\n});\r\n\r\n\r\n\r\n\r\n\r\n },\r\n \r\n// buyer_type: function(frm) {\r\n// formatMultipleDataFields(frm, [\r\n// 'individual_first_lossp',\r\n// 'min_premium_depositp',\r\n// 'limit_of_descrition',\r\n// 'franchise_lossp',\r\n// 'insured_commercial_risks_for_all_insured_companies'\r\n// ]);\r\n// },\r\n \r\n     turnover__p: function(frm) {\r\n        calculateAllValues(frm);\r\n    },\r\n    commercial_pre_rate: function(frm) {\r\n        calculateAllValues(frm);\r\n    },\r\n    political_pre_rate: function(frm) {\r\n        calculateAllValues(frm);\r\n    },\r\n\r\n\r\n\r\n// excluded declined\r\nclient_name: function(frm) {\r\n\r\n    fetchECIProposalData(frm);\r\n\r\n    let clientName = frm.doc.client_name;\r\n    if (!clientName) return;\r\n\r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: \"ECI Quotations\",\r\n            filters: {\r\n                client_name: clientName,\r\n                workflow_state: [\"!=\", \"Declined\"]  \r\n            },\r\n            fields: [\"proposal_no\"],\r\n            limit_page_length: 9999\r\n        },\r\n        callback: function(response) {\r\n\r\n            let proposalNumbers = [];\r\n\r\n            if (response.message && response.message.length > 0) {\r\n                proposalNumbers = response.message.map(q => q.proposal_no);\r\n            }\r\n\r\n            // If no matching records found \u2192 show message\r\n            if (proposalNumbers.length === 0) {\r\n                frappe.msgprint({\r\n                    title: \"No Matching Proposals\",\r\n                    message: \"No proposal numbers found for this client (excluding Declined).\",\r\n                    indicator: \"orange\"\r\n                });\r\n            }\r\n\r\n            // Update dropdown\r\n            frm.set_df_property(\"proposal_no\", \"options\", proposalNumbers);\r\n          // frm.refresh_field(\"proposal_no\");\r\n        }\r\n    });\r\n\r\n},\r\n\r\n\r\n\r\n    \r\nproposal_no: function(frm) {\r\n        \r\n    var  ProposalNo = frm.doc.proposal_no;\r\n    checkBoxesAsText(frm);\r\n\r\n\r\n        frappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'ECI Proposal',\r\n        filters: {\r\n            proposal_no: ProposalNo\r\n        },\r\n        fields: ['status','captured_on'],\r\n        limit: 1 \r\n    },\r\n    callback: function(response) {\r\n        console.log(\"ECI Proposal response:\", response);\r\n\r\n        if (response.message && response.message.length > 0) {\r\n            var data_from_proposal = response.message[0];\r\n\r\n            // Populate fields if data is found\r\n            frm.set_value('status1', data_from_proposal.status || '');\r\n            frm.refresh_field('status1');\r\n\r\n             frm.set_value('captured_on', data_from_proposal.captured_on || '');\r\n             frm.refresh_field('captured_on');\r\n\r\n           \r\n        } else {\r\n\r\n            frappe.msgprint('No matching record found in ECI Proposal for the selected Proposal No.');\r\n        }\r\n    },\r\n    error: function(err) {\r\n        console.error(\"Error fetching ECI Proposal data:\", err);\r\n        frappe.msgprint('An error occurred while fetching data from ECI Proposal. Please check the console for details.');\r\n    }\r\n        \r\n});\r\n\r\n\r\n     console.log('fetching nature of business details');\r\n        // Check if client name is provided\r\n        if (ProposalNo) {\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'ECI Proposal',\r\n                 \r\n                    filters: {\r\n                              proposal_no: ProposalNo \r\n},\r\n                    fields: [ // Place ECI Proposal fields here\r\n                        'name',\r\n                        'agriculture',\r\n                        'airconditioning',\r\n                        'aluminium_boats',\r\n                        'animal_vaccines',\r\n                        'arts_crafts',\r\n                        'batteries',\r\n                        'building_materials',\r\n                        'canning_cans',\r\n                        'cellular',\r\n                        'cereals',\r\n                        'cigarettes',\r\n                        'computer_electronic',\r\n                        'concrete_products',\r\n                        'corporate_clothing',\r\n                        'cosmetics',\r\n                        'couriers',\r\n                        'engraving',\r\n                        'fmcg',\r\n                        'frozen_chicken',\r\n                        'fuel',\r\n                        'gas',\r\n                        'hair_products',\r\n                        'heavy_plant',\r\n                        'invoice_factoring',\r\n                        'leather_products',\r\n                        'logistics',\r\n                        'lubricants__fuel',\r\n                        'meat_products',\r\n                        'media__radio', \r\n                        'merchandise',\r\n                        'packaging_materials',\r\n                        'perishable_goods',\r\n                        'pharmaceuticals',\r\n                        'plastics_spices',\r\n                        'road_construction',\r\n                        'salt',\r\n                        'security_services',\r\n                        'soda_ash',\r\n                        'stationary_diaries',\r\n                        'steel_doors',\r\n                        'steel_merchants',\r\n                        'timber_products',\r\n                        'travelling_bags',\r\n                        'water_supplies'\r\n                    ]\r\n                },\r\n               \r\n                callback: function(response) {\r\n                    if (!response.exc) {\r\n                        var proposals = response.message;\r\n\r\n                        if (proposals.length > 0) {\r\n                            var proposal = proposals[0];\r\n                            // Synchronize fields from ECI Proposal to ECI Quotations\r\n                            frm.set_value(\"agriculture\", proposal.agriculture ? 1 : 0);\r\n                            frm.set_value(\"airconditioning\", proposal.airconditioning ? 1 : 0);\r\n                            frm.set_value(\"aluminium_boats\", proposal.aluminium_boats ? 1 : 0);\r\n                            frm.set_value(\"animal_vaccines\", proposal.animal_vaccines ? 1 : 0);\r\n                            frm.set_value(\"arts_crafts\", proposal.arts_crafts ? 1 : 0);\r\n                            frm.set_value(\"batteries\", proposal.batteries ? 1 : 0);\r\n                            frm.set_value(\"building_materials\", proposal.building_materials ? 1 : 0);\r\n                            frm.set_value(\"canning_cans\", proposal.canning_cans ? 1 : 0);\r\n                            frm.set_value(\"cellular\", proposal.cellular ? 1 : 0);\r\n                            frm.set_value(\"cereals\", proposal.cereals ? 1 : 0);\r\n                            frm.set_value(\"cigarettes\", proposal.cigarettes ? 1 : 0);\r\n                            frm.set_value(\"computer_electronic\", proposal.computer_electronic ? 1 : 0);\r\n                            frm.set_value(\"concrete_products\", proposal.concrete_products ? 1 : 0);\r\n                            frm.set_value(\"corporate_clothing\", proposal.corporate_clothing ? 1 : 0);\r\n                            frm.set_value(\"cosmetics\", proposal.cosmetics ? 1 : 0);\r\n                            frm.set_value(\"couriers\", proposal.couriers ? 1 : 0);\r\n                            frm.set_value(\"engraving\", proposal.engraving ? 1 : 0);\r\n                            frm.set_value(\"fmcg\", proposal.fmcg ? 1 : 0);\r\n                            frm.set_value(\"frozen_chicken\", proposal.frozen_chicken ? 1 : 0);\r\n                            frm.set_value(\"fuel\", proposal.fuel ? 1 : 0);\r\n                            frm.set_value(\"gas\", proposal.gas ? 1 : 0);\r\n                            frm.set_value(\"hair_products\", proposal.hair_products ? 1 : 0);\r\n                            frm.set_value(\"heavy_plant\", proposal.heavy_plant ? 1 : 0);\r\n                            frm.set_value(\"invoice_factoring\", proposal.invoice_factoring ? 1 : 0);\r\n                            frm.set_value(\"leather_products\", proposal.leather_products ? 1 : 0);\r\n                            frm.set_value(\"logistics\", proposal.logistics ? 1 : 0);\r\n                            frm.set_value(\"lubricants__fuel\", proposal.lubricants__fuel ? 1 : 0);\r\n                            frm.set_value(\"meat_products\", proposal.meat_products ? 1 : 0);\r\n                            frm.set_value(\"media__radio\", proposal.media__radio ? 1 : 0); // Corrected field name\r\n                            frm.set_value(\"merchandise\", proposal.merchandise ? 1 : 0);\r\n                            frm.set_value(\"packaging_materials\", proposal.packaging_materials ? 1 : 0);\r\n                            frm.set_value(\"perishable_goods\", proposal.perishable_goods ? 1 : 0);\r\n                            frm.set_value(\"pharmaceuticals\", proposal.pharmaceuticals ? 1 : 0);\r\n                            frm.set_value(\"plastics_spices\", proposal.plastics_spices ? 1 : 0);\r\n                            frm.set_value(\"road_construction\", proposal.road_construction ? 1 : 0);\r\n                            frm.set_value(\"salt\", proposal.salt ? 1 : 0);\r\n                            frm.set_value(\"security_services\", proposal.security_services ? 1 : 0);\r\n                            frm.set_value(\"soda_ash\", proposal.soda_ash ? 1 : 0);\r\n                            frm.set_value(\"stationary_diaries\", proposal.stationary_diaries ? 1 : 0);\r\n                            frm.set_value(\"steel_doors\", proposal.steel_doors ? 1 : 0);\r\n                            frm.set_value(\"steel_merchants\", proposal.steel_merchants ? 1 : 0);\r\n                            frm.set_value(\"timber_products\", proposal.timber_products ? 1 : 0);\r\n                            frm.set_value(\"travelling_bags\", proposal.travelling_bags ? 1 : 0);\r\n                            frm.set_value(\"water_supplies\", proposal.water_supplies ? 1 : 0);\r\n                            \r\n                            // Toggle display of fields based on checkbox values\r\n                            frm.toggle_display(\"agriculture\", proposal.agriculture ? 1 : 0);\r\n                            frm.toggle_display(\"airconditioning\", proposal.airconditioning ? 1 : 0);\r\n                            frm.toggle_display(\"aluminium_boats\", proposal.aluminium_boats ? 1 : 0);\r\n                            frm.toggle_display(\"animal_vaccines\", proposal.animal_vaccines ? 1 : 0);\r\n                            frm.toggle_display(\"arts_crafts\", proposal.arts_crafts ? 1 : 0);\r\n                            frm.toggle_display(\"batteries\", proposal.batteries ? 1 : 0);\r\n                            frm.toggle_display(\"building_materials\", proposal.building_materials ? 1 : 0);\r\n                            frm.toggle_display(\"canning_cans\", proposal.canning_cans ? 1 : 0);\r\n                            frm.toggle_display(\"cellular\", proposal.cellular ? 1 : 0);\r\n                            frm.toggle_display(\"cereals\", proposal.cereals ? 1 : 0);\r\n                            frm.toggle_display(\"cigarettes\", proposal.cigarettes ? 1 : 0);\r\n                            frm.toggle_display(\"computer_electronic\", proposal.computer_electronic ? 1 : 0);\r\n                            frm.toggle_display(\"concrete_products\", proposal.concrete_products ? 1 : 0);\r\n                            frm.toggle_display(\"corporate_clothing\", proposal.corporate_clothing ? 1 : 0);\r\n                            frm.toggle_display(\"cosmetics\", proposal.cosmetics ? 1 : 0);\r\n                            frm.toggle_display(\"couriers\", proposal.couriers ? 1 : 0);\r\n                            frm.toggle_display(\"engraving\", proposal.engraving ? 1 : 0);\r\n                            frm.toggle_display(\"fmcg\", proposal.fmcg ? 1 : 0);\r\n                            frm.toggle_display(\"frozen_chicken\", proposal.frozen_chicken ? 1 : 0);\r\n                            frm.toggle_display(\"fuel\", proposal.fuel ? 1 : 0);\r\n                            frm.toggle_display(\"gas\", proposal.gas ? 1 : 0);\r\n                            frm.toggle_display(\"hair_products\", proposal.hair_products ? 1 : 0);\r\n                            frm.toggle_display(\"heavy_plant\", proposal.heavy_plant ? 1 : 0);\r\n                            frm.toggle_display(\"invoice_factoring\", proposal.invoice_factoring ? 1 : 0);\r\n                            frm.toggle_display(\"leather_products\", proposal.leather_products ? 1 : 0);\r\n                            frm.toggle_display(\"logistics\", proposal.logistics ? 1 : 0);\r\n                            frm.toggle_display(\"lubricants__fuel\", proposal.lubricants__fuel ? 1 : 0);\r\n                            frm.toggle_display(\"meat_products\", proposal.meat_products ? 1 : 0);\r\n                            frm.toggle_display(\"media__radio\", proposal.media__radio ? 1 : 0); // Corrected field name\r\n                            frm.toggle_display(\"merchandise\", proposal.merchandise ? 1 : 0);\r\n                            frm.toggle_display(\"packaging_materials\", proposal.packaging_materials ? 1 : 0);\r\n                            frm.toggle_display(\"perishable_goods\", proposal.perishable_goods ? 1 : 0);\r\n                            frm.toggle_display(\"pharmaceuticals\", proposal.pharmaceuticals ? 1 : 0);\r\n                            frm.toggle_display(\"plastics_spices\", proposal.plastics_spices ? 1 : 0);\r\n                            frm.toggle_display(\"road_construction\", proposal.road_construction ? 1 : 0);\r\n                            frm.toggle_display(\"salt\", proposal.salt ? 1 : 0);\r\n                            frm.toggle_display(\"security_services\", proposal.security_services ? 1 : 0);\r\n                            frm.toggle_display(\"soda_ash\", proposal.soda_ash ? 1 : 0);\r\n                            frm.toggle_display(\"stationary_diaries\", proposal.stationary_diaries ? 1 : 0);\r\n                            frm.toggle_display(\"steel_doors\", proposal.steel_doors ? 1 : 0);\r\n                            frm.toggle_display(\"steel_merchants\", proposal.steel_merchants ? 1 : 0);\r\n                            frm.toggle_display(\"timber_products\", proposal.timber_products ? 1 : 0);\r\n                            frm.toggle_display(\"travelling_bags\", proposal.travelling_bags ? 1 : 0);\r\n                            frm.toggle_display(\"water_supplies\", proposal.water_supplies ? 1 : 0);\r\n                        }\r\n                    } else {\r\n                        console.error(\"Error occurred in fetching data from ECI Proposal:\", response.exc);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    },\r\n\r\n\r\nadd_new: function(frm) {\r\n\r\n    // Read form field values\r\n    var country_of_dest = frm.doc.country_of_dest;\r\n    var terms_of_payment = frm.doc.terms_of_payment;\r\n    var commercial_pre_rate = frm.doc.commercial_pre_rate || \"\";\r\n    var premium_rate = frm.doc.premium_rate || \"\";\r\n    var commercial_premium_amt_p = frm.doc.commercial_premium_amt_p || \"\";\r\n    var buyer_type = frm.doc.buyer_type;\r\n    var political_pre_rate = frm.doc.political_pre_rate || \"\";\r\n    var turnover__p = frm.doc.turnover__p || \"\";\r\n    var political_premium_amt = frm.doc.political_premium_amt || \"\";\r\n    var total_pre_amt = frm.doc.total_pre_amt || \"\";\r\n\r\n    // Add a new row in child table\r\n    var child = frappe.model.add_child(frm.doc, \"ECI quotation childtable\", \"eci_quo_table\");\r\n\r\n    // Set values\r\n    frappe.model.set_value(child.doctype, child.name, \"country\", country_of_dest);\r\n    frappe.model.set_value(child.doctype, child.name, \"payment_terms\", terms_of_payment);\r\n    frappe.model.set_value(child.doctype, child.name, \"commprerate\", commercial_pre_rate);\r\n    frappe.model.set_value(child.doctype, child.name, \"premium_rate\", premium_rate);\r\n    frappe.model.set_value(child.doctype, child.name, \"commpreamt\", commercial_premium_amt_p);\r\n    frappe.model.set_value(child.doctype, child.name, \"buyer_type\", buyer_type);\r\n    frappe.model.set_value(child.doctype, child.name, \"polprerate\", political_pre_rate);\r\n    frappe.model.set_value(child.doctype, child.name, \"turnover\", turnover__p);\r\n    frappe.model.set_value(child.doctype, child.name, \"polpreamt\", political_premium_amt);\r\n    frappe.model.set_value(child.doctype, child.name, \"total_pre_amt\", total_pre_amt);\r\n\r\n    frm.refresh_field('eci_quo_table');\r\n\r\n    // Recalculation\r\n    calculate_comm_pre_amt(frm);\r\n    calculate_poll_pre_amt(frm);\r\n    calculate_amount(frm);\r\n\r\n    // Clear main fields (ALL empty as tester requested)\r\n    frm.set_value('country_of_dest', '');\r\n    frm.set_value('terms_of_payment', '');\r\n    frm.set_value('commercial_pre_rate', '');\r\n    frm.set_value('premium_rate', '');\r\n    frm.set_value('commercial_premium_amt_p', '');\r\n    frm.set_value('political_pre_rate', '');\r\n    frm.set_value('turnover__p', '');\r\n    frm.set_value('political_premium_amt', '');\r\n    frm.set_value('total_pre_amt', '');\r\n}\r\n\r\n\r\n    \r\n});\r\n\r\n\r\n// function formatMultipleDataFields(frm, fieldnames) {\r\n// fieldnames.forEach(function(fieldname) {\r\n// let value = frm.doc[fieldname];\r\n\r\n//     if (value !== undefined && value !== null && value !== \"\") {\r\n//         frm.set_value(fieldname, parseFloat(value).toFixed(2));\r\n//     }\r\n// });\r\n\r\n//}\r\n\r\n\r\n\r\nfunction alignFieldsRight(frm) {\r\n// List of fields to align right\r\nconst rightAlignFields = [\r\n\"commercial_pre_rate\",\r\n\"premium_rate\",\r\n\"commercial_premium_amt_p\",\r\n\"political_pre_rate\",\r\n\"turnover__p\",\r\n\"political_premium_amt\",\r\n\"total_pre_amt\",\r\n\"com_pre_amt\",\r\n\"pol_pre_amt\",\r\n\"amt\",\r\n\"individual_first_lossp\",\r\n\"min_premium_depositp\",\r\n\"limit_of_descrition\",\r\n\"franchise_lossp\",\r\n\"insured_commercial_risks_for_all_insured_companies\",\r\n\"commercial\",\r\n\"political\",\r\n\"total\",\r\n\"per_enquiryp\",\r\n\"cl_per_monthp\"\r\n];\r\n\r\n\r\nrightAlignFields.forEach(fieldname => {\r\n    if (frm.fields_dict[fieldname] && frm.fields_dict[fieldname].$wrapper) {\r\n        frm.fields_dict[fieldname].$input.css(\"text-align\", \"right\");\r\n    }\r\n});\r\n\r\n// Example of locking a child table\r\nfrm.set_df_property('eci_quo_table', 'cannot_add_rows', true);\r\n\r\n\r\n}\r\n\r\n\r\n  \r\nfunction checkBoxesAsText(frm) {\r\n    const proposalNumber = frm.doc.proposal_no || frm.doc.proposal_no1;\r\n    if (!proposalNumber) return;\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_value',\r\n        args: {\r\n            doctype: 'ECI Proposal',\r\n            filters: { proposal_no: proposalNumber },\r\n            fieldname: [\r\n                'agriculture', 'airconditioning', 'aluminium_boats', 'animal_vaccines', 'arts_crafts',\r\n                'batteries', 'building_materials', 'canning_cans', 'cellular', 'cereals', 'cigarettes',\r\n                'computer_electronic', 'concrete_products', 'corporate_clothing', 'cosmetics', 'couriers',\r\n                'engraving', 'fmcg', 'frozen_chicken', 'fuel', 'gas', 'hair_products', 'heavy_plant',\r\n                'invoice_factoring', 'leather_products', 'logistics', 'lubricants__fuel', 'meat_products',\r\n                'media__radio', 'merchandise', 'packaging_materials', 'perishable_goods', 'pharmaceuticals',\r\n                'plastics_spices', 'road_construction', 'salt', 'security_services', 'soda_ash',\r\n                'stationary_diaries', 'steel_doors', 'steel_merchants', 'timber_products', 'travelling_bags',\r\n                'water_supplies'\r\n            ]\r\n        },\r\n        callback: function(response) {\r\n            if (response && response.message) {\r\n                const data = response.message;\r\n                const checkedFields = Object.keys(data).filter(field => data[field] === 1);\r\n                const newValue = checkedFields.join(', ');\r\n\r\n                const currentValue = (frm.doc.goods_services || '').trim();\r\n                const newValueTrimmed = newValue.trim();\r\n\r\n                if (currentValue !== newValueTrimmed) {\r\n                    frm.set_value('goods_services', newValueTrimmed);\r\n                    console.log(\"Updated goods_services with: \" + newValueTrimmed);\r\n                }\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\nfunction generateScheduleNumber(frm) {\r\n    // Check if the schedule number field is already populated\r\n    if (!frm.doc.schedule_no) {\r\n        // Get the current year\r\n        let currentYear = new Date().getFullYear();\r\n        let prefix = `ECQT/${currentYear}/`;\r\n\r\n        // Make a call to get the last number asynchronously\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'ECI Quotations',\r\n                fields: ['schedule_no'],\r\n                order_by: 'creation desc',\r\n                limit: 1\r\n            },\r\n            callback: function(r) {\r\n                if (r.message && r.message.length > 0) {\r\n                    let lastScheduleNo = r.message[0].schedule_no;\r\n                    let lastNumber = parseInt(lastScheduleNo.split(\"/\").pop()); // Extract last part and parse it as an integer\r\n                    if (!isNaN(lastNumber)) {\r\n                        // Increment the last number and pad it with leading zeros\r\n                        let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n                        frm.set_value('schedule_no', prefix + newNumber);\r\n                    }\r\n                } else {\r\n                    // If no previous numbers exist, set to default '0001'\r\n                    frm.set_value('schedule_no', prefix + '0001');\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\n\r\nfunction calculateAllValues(frm) {\r\n    let d = frm.doc;\r\n\r\n    let turnover = parseFloat(d.turnover__p) || 0;\r\n    let comRate = parseFloat(d.commercial_pre_rate) || 0;\r\n    let polRate = parseFloat(d.political_pre_rate) || 0;\r\n\r\n    if (turnover > 0 && (comRate > 0 || polRate > 0)) {\r\n\r\n        let commercial_premium_amt_p = turnover * comRate / 100;\r\n        let political_premium_amt = turnover * polRate / 100;\r\n        let total_pre_amt = turnover * (comRate + polRate) / 100;\r\n\r\n        frm.set_value(\"commercial_premium_amt_p\", commercial_premium_amt_p);\r\n        frm.set_value(\"political_premium_amt\", political_premium_amt);\r\n        frm.set_value(\"total_pre_amt\", total_pre_amt);\r\n    }\r\n}\r\nfunction calculate_comm_pre_amt(frm) {\r\n    let totalCommPre = (frm.doc.eci_quo_table || []).reduce((sum, row) => {\r\n        return sum + (parseFloat(row.commpreamt) || 0);\r\n    }, 0);\r\n\r\n    frm.set_value(\"com_pre_amt\", totalCommPre);\r\n\r\n    frm.set_value(\"commercial\", totalCommPre * 25);\r\n}\r\nfunction calculate_amount(frm) {\r\n    let totalAmount = (frm.doc.eci_quo_table || []).reduce((sum, row) => {\r\n        return sum + (parseFloat(row.total_pre_amt) || 0);\r\n    }, 0);\r\n\r\n    frm.set_value(\"amt\", totalAmount);\r\n\r\n    frm.set_value(\"total\", totalAmount * 25);\r\n}\r\nfunction calculate_poll_pre_amt(frm) {\r\n    let totalPollPre = (frm.doc.eci_quo_table || []).reduce((sum, row) => {\r\n        return sum + (parseFloat(row.polpreamt) || 0);\r\n    }, 0);\r\n\r\n    frm.set_value(\"pol_pre_amt\", totalPollPre);\r\n\r\n    frm.set_value(\"political\", totalPollPre * 25);\r\n}\r\n\r\n\r\n\r\n\r\n// function attachClickHandlers(frm) {\r\n//     $('.underlined').on('click', function(event) {\r\n//         event.preventDefault();\r\n//         var linkText = $(this).text().trim();\r\n//         var workflowState = frm.doc.workflow_state;  // Assuming workflow_state is the field name in your form\r\n\r\n//         switch (linkText) {\r\n//             case 'Policy Schedule':\r\n//                 if (workflowState === 'Approved' || workflowState === 'Rejected') {\r\n//                     openNewDocument('Policy Schedule ECI Quotation', frm);\r\n//                 } else {\r\n//                     frappe.msgprint(\"Approval is required to access the document.\");\r\n//                     }\r\n//                 break;\r\n         \r\n\r\n//             case 'Consent Form':\r\n//                 if (workflowState === 'Approved' || workflowState === 'Rejected') {\r\n//                     openNewDocument('Consent Form ECI Quotation', frm);\r\n//                 } else {\r\n//                     frappe.msgprint(\"Approval is required to access the document.\");\r\n//                   }\r\n//                 break;\r\n\r\n//             case 'Agenda and Endorsement':\r\n//                 if (workflowState === 'Approved' || workflowState === 'Rejected') {\r\n//                     openNewDocument('Agenda and Endorsements for ECI Quotation', frm);\r\n//                 } else {\r\n//                     frappe.msgprint(\"Approval is required to access the document.\");\r\n//                 }\r\n//                 break;\r\n//                   case 'Policy Quotation':\r\n//                 if (workflowState === 'Approved' || workflowState === 'Rejected') {\r\n//                     openNewDocument('Policy Quotation ECI Quotation', frm);\r\n//                 } else {\r\n//                     frappe.msgprint(\"Approval is required to access the document.\");\r\n//                 }\r\n//                 break;\r\n//             default:\r\n//                 console.log(\"No action defined for\", linkText);\r\n//         }\r\n//     });\r\n// }\r\n\r\n\r\nfunction attachClickHandlers(frm) {\r\n\r\n    $('.underlined').off(\"click\").on('click', function(e) {\r\n        e.preventDefault();\r\n\r\n        let linkText = $(this).text().trim();\r\n        let workflow = frm.doc.workflow_state;\r\n\r\n        // Allowed workflow states\r\n        let allowed = ['Approved', 'Rejected'];\r\n\r\n        if (!allowed.includes(workflow)) {\r\n            frappe.msgprint(\"Approval is required to access the document.\");\r\n            return;\r\n        }\r\n\r\n        // Mapping of clickable text \u2192 Doctype\r\n        const docMap = {\r\n            \"Covering Letter\": \"cover letter ECI\",\r\n            \"Specimen Policy document\": \"Specimen Policy Document ECI\",\r\n            \"Acceptance form\": \"Acceptance Form ECI Quotation\",\r\n            \"Country Listing and rate\": \"Country Listing and rates_ECI\",\r\n            \"Policy Schedule\": \"Policy Schedule ECI Quotation\",\r\n            \"Consent Form\": \"Consent Form ECI Quotation\",\r\n            \"Agenda and Endorsement\": \"Agenda and Endorsements for ECI Quotation\",\r\n            \"Policy Quotation\": \"Policy Quotation ECI Quotation\"\r\n        };\r\n\r\n        if (docMap[linkText]) {\r\n            openNewDocument(docMap[linkText], frm);\r\n        } else {\r\n            console.log(\"No action defined for:\", linkText);\r\n        }\r\n\r\n    });\r\n}\r\n\r\nfunction openNewDocument(doctype, frm) {\r\n    // Get necessary data from the current form or any other source\r\n    var data = {\r\n      // name1: frm.doc.client_name,\r\n        to:frm.doc.client_name,\r\n        proposal_no:frm.doc.proposal_no,\r\n        policy_no:frm.doc.schedule_no,\r\n        company_name:frm.doc.client_name,\r\n        draw:frm.doc.client_name,\r\n        date:frm.doc.inception_date,\r\n        client:frm.doc.client_name,\r\n        credit:frm.doc.proposal_no,\r\n        credit:frm.doc.proposal_no1,\r\n        //ourref:frm.doc.proposal_no,\r\n        ourref:frm.doc.schedule_no,\r\n        quotation:frm.doc.proposal_no,\r\n        quotation:frm.doc.proposal_no1,\r\n        //policy schedule\r\n        quotation_number:frm.doc.schedule_no,\r\n        from:frm.doc.inception_date,\r\n        date:frm.doc.captured_on,\r\n        name_of_insured:frm.doc.client_name,\r\n        description_of_goods:frm.doc.goods_services,\r\n        proposal_no:frm.doc.proposal_no,\r\n        proposal_no:frm.doc.proposal_no1,\r\n        deposit_premium:frm.doc.min_premium_depositp,\r\n    };\r\n    // Open the new doctype with the required data\r\n    frappe.new_doc(doctype, data);\r\n} \r\n\r\n\r\n\r\nfunction fetchECIProposalData(frm) {\r\n    frappe.call({\r\n        method: 'frappe.client.get',\r\n        args: {\r\n            doctype: 'ECI Proposal',\r\n            filters: {\r\n                client_name: frm.doc.client_name\r\n            },\r\n            fields: ['export_turnover']\r\n        },\r\n        callback: function(response) {\r\n            console.log(response, \"ECI Proposals data\");\r\n\r\n            if (!response.exc) {\r\n                var data = response.message.export_turnover;\r\n\r\n                for (let x of data) {\r\n                    frm.set_value(\"buyer_type\", x.buyer_type);\r\n                  //  frm.set_value(\"terms_of_payment\", x.terms_of_payment);\r\n                  //  frm.set_value(\"country_of_dest\", x.country_of_dest);\r\n                   // frm.set_value(\"currency\", x.currency_invoiced_eg_pularandsusd);\r\n                    // Add more fields as needed\r\n                }\r\n\r\n                frm.refresh_fields('buyer_type');\r\n                console.log(data);\r\n            } else {\r\n                console.error(\"Error occurred in ECI Proposals data:\", response.exc);\r\n            }\r\n        }\r\n    });\r\n}\r\n    \r\n    // Covering Letter creation (route_options BEFORE new_doc)\r\nfunction createCoveringLetter(frm) {\r\n    const reference_text = `EXPORT CREDIT INSURANCE QUOTATION - ${frm.doc.proposal_no || ''}`;\r\n\r\n    frappe.route_options = {\r\n        ourref: frm.doc.proposal_no,\r\n        date: frm.doc.captured_on,\r\n        re: reference_text,\r\n        client_name: frm.doc.client_name\r\n    };\r\n\r\n    frappe.new_doc('cover letter ECI');\r\n\r\n}\r\n\r\n\r\n  //------------------------------------------------------------        \r\n// var workflow_state = frm.doc.workflow_state || 'Approved'\r\n\r\n//   frm.toggle_display('proposal_no', true);\r\n//   frm.toggle_display('client_name', true);\r\n\r\n// if (workflow_state === \"Approved\") {\r\n//   frm.set_df_property('proposal_no', 'read_only', 1); \r\n//   frm.toggle_display('client_name', true);\r\n// } else {\r\n//     frm.set_df_property('proposal_no', 'read_only', 0);\r\n//     frm.toggle_display('client_name', true);\r\n\r\n// }\r\n\r\n\r\n\r\n         \r\n    //      $(document.body).on('click', function() {     1;\r\n    //     });\r\n        \r\n    //  attachClickHandlers(frm);\r\n\r\n    //     $('.underlined').on('click', function(event) {\r\n    //         event.preventDefault();\r\n    //         var linkText = $(this).text().trim();\r\n    //         var workflowState = frm.doc.workflow_state;  // Assuming workflow_state is the field name in your form\r\n\r\n    //     switch (linkText) {\r\n    //      case 'Covering Letter':\r\n    //     if (workflowState === 'Approved' || workflowState === 'Rejected') {\r\n    //         createCoveringLetter(frm);\r\n    //     } else {\r\n    //         frappe.msgprint(\"Approval is required to access the document.\");\r\n    //     }\r\n    //     break;\r\n\r\n\r\n    //             case 'Specimen Policy document':\r\n    //                 if (workflowState === 'Approved' || workflowState === 'Rejected') {\r\n    //                     openNewDocument('Specimen Policy Document ECI', frm);\r\n    //                 } else {\r\n    //                     frappe.msgprint(\"Approval is required to access the document.\");\r\n    //                      }\r\n    //                 break;\r\n\r\n    //             case 'Acceptance form':\r\n    //                 if (workflowState === 'Approved' || workflowState === 'Rejected') {\r\n    //                     openNewDocument('Acceptance Form ECI Quotation', frm);\r\n    //                 } else {\r\n    //                     frappe.msgprint(\"Approval is required to access the document.\");\r\n    //                     }\r\n    //                 break;\r\n\r\n    //             case 'Country Listing and rate':\r\n    //                 if (workflowState === 'Approved' || workflowState === 'Rejected') {\r\n    //                     openNewDocument('Country Listing and rates_ECI', frm);\r\n    //                 } else {\r\n    //                     frappe.msgprint(\"Approval is required to access the document.\");\r\n    //                   }\r\n    //                 break;\r\n\r\n    //             default:\r\n    //                 console.log(\"No action defined for\", linkText);\r\n    //         }\r\n    //     });\r\n        \r\n\r\n\r\n  //------------------------------------------------\r\n \r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Consent Form ECI Quotation",
  "enabled": 1,
  "modified": "2024-05-22 12:03:51.987932",
  "module": null,
  "name": "consent form script",
  "script": "frappe.ui.form.on('Consent Form', {\n    onload: function(frm) {\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Company-Details', // corrected doctype name\n                filters: {\n                    name1: frm.doc.company_name // corrected field name\n                },\n                fields: ['bank', 'ac_no', 'branch', 'contact_person','postal_address']\n            },\n            callback: function(r) {\n                console.log(r, 'hello'); // corrected console.log syntax\n                if (!r.exc) {\n                    if (r.message && r.message.length > 0) {\n                        var data = r.message[0]; \n                        frm.set_value('bank', data.bank);\n                        frm.set_value('account_number', data.ac_no); // corrected field name\n                        frm.set_value('branch', data.branch);\n                        frm.set_value('to_', data.contact_person);\n                        frm.set_value('of', data.postal_address);\n                        \n                    } else {\n                        console.error(\"No data found for the selected company.\");\n                    }\n                } else {\n                    console.error(\"Error occurred:\", r.exc);\n                }\n            }\n        });\n      \n     frappe.call({\n    method: 'frappe.client.get_list',\n    args: {\n        doctype: 'DCI Proposals', // corrected doctype name\n        filters: {\n            proposal_no: frm.doc.proposal_nos // corrected field name\n        },\n        fields: ['capacity']\n    },\n    callback: function(r) {\n        console.log(r, 'hello'); // corrected console.log syntax\n        if (!r.exc) {\n            if (r.message && r.message.length > 0) {\n                var data = r.message[0]; \n                frm.set_value('designation', data.capacity); // corrected field name\n            } else {\n                console.error(\"No data found for the selected company.\");\n            }\n        } else {\n            console.error(\"Error occurred:\", r.exc);\n        }\n    }\n});\n     \n     \n    //  var name1 = frm.doc.name1;\n    //  // Fetch Company Details document where the 'to' field matches name1\n    //     frappe.call({\n    //         method: 'frappe.client.get_list',\n    //         args: {\n    //             doctype: 'Company-Details',\n    //             filters: {\n    //                 'company_name': name1\n    //             },\n    //             fields: ['postal_address'],\n    //             limit: 1 // Limit to fetch only one document\n    //         },\n    //         callback: function(response) {\n    //             if (response.message && response.message.length > 0) {\n    //                 // Set the postal_address field to the of field in New_Policy_Doc document\n    //                 frm.set_value('of', response.message[0].postal_address);\n    //             } else {\n    //                 // Handle case where no matching Company Details document is found\n    //                 frappe.msgprint(\"No matching Company Details found for: \" + name1);\n    //             }\n    //         },\n    //         error: function(err) {\n    //             console.error(err);\n    //             frappe.msgprint('An error occurred while fetching Company Details.');\n    //         }\n    //     });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Debit Note",
  "enabled": 0,
  "modified": "2025-11-26 06:19:12.271326",
  "module": "Finance",
  "name": "Debit note",
  "script": "    \r\nfrappe.ui.form.on('Debit Note', {\r\n     invoice_no: function(frm) {\r\n        generateNumber(frm);\r\n    },\r\n    \r\n    refresh(frm) {\r\n        frm.fields_dict.vat.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.total_amountincl_vat.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.dd_amount.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.premium_rate.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.cl_fee.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.cl_enquiry_fee.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.premiumrate.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.clfee.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.clenquiryfee.$input.css(\"text-align\", \"right\");\r\n         frm.fields_dict.no_of_cls.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.no_of_cl_enq.$input.css(\"text-align\", \"right\");\r\n        \r\n \r\n        \r\n        frm.fields_dict.ddamount.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.noofcls.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.noofclenq.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.premium_rate1.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.cl_fee1.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.cl_enquiry_fee1.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.premium_rate2.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.cl_fee2.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.cl_enquiry_fee2.$input.css(\"text-align\", \"right\");\r\n        \r\n        if (!frm.doc.dedbit_note_no) {\r\n            generateNumber(frm);\r\n        }\r\n        \r\n          var workflowState = frm.doc.workflow_state;\r\n        if (workflowState === \"Approved\") {\r\n            frm.toggle_display('ph_name', true);\r\n            frm.toggle_display('policy_holder', false);\r\n        }\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: \"Export Declarations\",\r\n                filters: {},\r\n                fields: ['policy_holder']\r\n            },\r\n            callback: function(submittedProposalsResponse) {\r\n                if (submittedProposalsResponse.message) {\r\n                    var submittedProposals = submittedProposalsResponse.message.map(function(proposal) {\r\n                        return proposal.policy_holder;\r\n                    });\r\n                    console.log(\"** Submitted Proposals:\", submittedProposals);\r\n                    console.log(\"** Fetching Approved Quotations **\");\r\n\r\n                    frappe.call({\r\n                        method: 'frappe.client.get_list',\r\n                        args: {\r\n                            doctype: 'Debit Note',\r\n                            filters: {\r\n                                workflow_state: 'Approved'\r\n                            },\r\n                            fields: ['policy_holder']\r\n                        },\r\n                        callback: function(approvedQuotationsResponse) {\r\n                            console.log(approvedQuotationsResponse, \"approvedQuotationsResponse\");\r\n                            if (approvedQuotationsResponse.message) {\r\n                                var approvedQuotations = approvedQuotationsResponse.message.map(function(quotation) {\r\n                                    return quotation.policy_holder;\r\n                                });\r\n                                console.log(\"** Approved Quotations:\", approvedQuotations);\r\n\r\n                                var filteredClientNames = submittedProposals.filter(function(proposal) {\r\n                                    return !approvedQuotations.includes(proposal);\r\n                                });\r\n                                console.log(\"** Filtered Client Names:\", filteredClientNames);\r\n\r\n                                frm.set_df_property('policy_holder', 'options', filteredClientNames);\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        });\r\n\r\n        frm.add_custom_button(__('Tax Invoice'), function() {\r\n            frappe.call({\r\n                method: 'frappe.client.get_value',\r\n                args: {\r\n                    doctype: 'Company-Details',\r\n                    fieldname: ['telephone', 'fax', 'postal_address', 'location', 'contact_person', 'vat_reg_no', 'country'],\r\n                    filters: {\r\n                        name: frm.doc.policy_holder\r\n                    }\r\n                },\r\n                callback: function(r) {\r\n                    if (r.message) {\r\n                        const { telephone, fax, postal_address, location, contact_person, vat_reg_no, country } = r.message;\r\n                        frappe.route_options = {\r\n                            invoice_to: frm.doc.policy_holder,\r\n                            date: frm.doc.invoice_date,\r\n                            invoice_no: frm.doc.invoice_no,\r\n                            reference: frm.doc.debit_note_no,\r\n                            crn: frm.doc.invoice_no,\r\n                            amount6: frm.doc.dd_amount,\r\n                            amount7: frm.doc.premium_rate,\r\n                            amount8: frm.doc.premiumrate,\r\n                            amount9: frm.doc.no_of_cls,\r\n                            amount10: frm.doc.cl_fee,\r\n                            amount11: frm.doc.clfee,\r\n                            amount17: frm.doc.no_of_cl_enq,\r\n                            amount12: frm.doc.cl_enquiry_fee,\r\n                            amount13: frm.doc.clenquiryfee,\r\n                            amount15: frm.doc.vat,\r\n                            telephone: telephone,\r\n                            fax: fax,\r\n                            address: postal_address,\r\n                            city: location,\r\n                            attn: contact_person,\r\n                            vat: vat_reg_no,\r\n                            country: country,\r\n                        };\r\n\r\n                        frappe.call({\r\n                            method: 'frappe.client.get_value',\r\n                            args: {\r\n                                doctype: 'Policy Approvals',\r\n                                fieldname: ['policy_number'],\r\n                                filters: {\r\n                                    policy_holder: frm.doc.policy_holder\r\n                                }\r\n                            },\r\n                            callback: function(r) {\r\n                                if (r.message && r.message.policy_number) {\r\n                                    frappe.route_options.reference = r.message.policy_number;\r\n                                    frappe.new_doc('Debt Note Tax Invoice', frm, frappe.route_options);\r\n                                } else {\r\n                                    frappe.msgprint(__('Policy Number not found for the selected Policy Holder.'));\r\n                                }\r\n                            }\r\n                        });\r\n                    } else {\r\n                        frappe.msgprint(__('Company details not found for the selected Policy Holder.'));\r\n                    }\r\n                }\r\n            });\r\n        }).addClass('btn-primary');\r\n\r\n        frm.add_custom_button(__('Internal Invoice'), function() {\r\n            frappe.call({\r\n                method: 'frappe.client.get_value',\r\n                args: {\r\n                    doctype: 'Company-Details',\r\n                    fieldname: ['postal_address', 'location', 'vat_reg_no'],\r\n                    filters: {\r\n                        name: frm.doc.policy_holder\r\n                    }\r\n                },\r\n                callback: function(r) {\r\n                    if (r.message) {\r\n                        const postal_address = r.message.postal_address;\r\n                        const location = r.message.location;\r\n                        const vat_reg_no = r.message.vat_reg_no;\r\n                        frappe.route_options = {\r\n                            name1: frm.doc.policy_holder,\r\n                            date: frm.doc.invoice_date,\r\n                            address: postal_address,\r\n                            city: location,\r\n                            vat_registration_no: vat_reg_no,\r\n                        };\r\n                        frappe.new_doc('Debit Note Internal Invoice', frm, frappe.route_options);\r\n                    } else {\r\n                        frappe.msgprint(__('Telephone, Fax, and Postal Address not found for the selected Policy Holder.'));\r\n                    }\r\n                }\r\n            });\r\n        }).addClass('btn-primary');\r\n    },\r\n    \r\n    \r\n     \r\n    \r\n\r\n    policy_holder: function(frm) {\r\n        var clientName = frm.doc.policy_holder;\r\n        \r\n         frm.set_value('ph_name', clientName);\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'CI Invoices',\r\n                filters: { policy_holder: clientName },\r\n                fields: ['invoice_no', 'invoice_date']\r\n            },\r\n            callback: function(response) {\r\n                console.log(\"DCI Proposals response:\", response);\r\n                if (response.message && response.message.length > 0) {\r\n                    var data_from_proposals = response.message[0];\r\n                    frm.set_value('invoice_no', data_from_proposals.invoice_no || '');\r\n                    frm.set_value('invoice_date', data_from_proposals.invoice_date || '');\r\n                    frm.set_value('invoice_no', invoice.invoice_no || '');\r\ngenerateNumber(frm);\r\n\r\n                } else {\r\n                    frm.set_value('invoice_no', '');\r\n                    frm.set_value('invoice_date', '');\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error(err);\r\n                frappe.msgprint('An error occurred while fetching data from DCI Proposals. Please check the console for details.');\r\n            }\r\n        });\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Export Declaration Invoice',\r\n                filters: { policy_holder: clientName },\r\n                fields: ['credit_limit_fee', 'credit_limits', 'credit_limit_enquiry_fee', 'credit_limits1', 'total']\r\n            },\r\n            callback: function(response) {\r\n                console.log(\"DCI Proposals response:\", response);\r\n                if (response.message && response.message.length > 0) {\r\n                    var data_from_proposals = response.message[0];\r\n                    frm.set_value('cl_fee', data_from_proposals.credit_limit_fee || '');\r\n                    frm.set_value('cl_enquiry_fee', data_from_proposals.credit_limit_enquiry_fee || '');\r\n                    frm.set_value('no_of_cls', data_from_proposals.credit_limits || '');\r\n                    frm.set_value('no_of_cl_enq', data_from_proposals.credit_limits1 || '');\r\n                    frm.set_value('cl_fee1', data_from_proposals.credit_limit_fee || '');\r\n                    frm.set_value('cl_enquiry_fee1', data_from_proposals.credit_limit_enquiry_fee || '');\r\n                    frm.set_value('noofcls', data_from_proposals.credit_limits || '');\r\n                    frm.set_value('noofclenq', data_from_proposals.credit_limits1 || '');\r\n                } else {\r\n                    frm.set_value('premium_rate', '');\r\n                    frm.set_value('cl_fee', '');\r\n                    frm.set_value('cl_enquiry_fee', '');\r\n                    frm.set_value('no_of_cls', '');\r\n                    frm.set_value('no_of_cl_enq', '');\r\n                    frm.set_value('cl_fee1', '');\r\n                    frm.set_value('cl_enquiry_fee1', '');\r\n                    frm.set_value('noofcls', '');\r\n                    frm.set_value('noofclenq', '');\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error(err);\r\n                frappe.msgprint('An error occurred while fetching data from DCI Proposals. Please check the console for details.');\r\n            }\r\n        });\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get',\r\n            args: {\r\n                doctype: 'Export Declarations',\r\n                filters: { policy_holder: clientName },\r\n                fields: ['premium_rate']\r\n            },\r\n            callback: function(r) {\r\n                if (r.message) {\r\n                    frm.set_value('premium_rate', r.message.premium_rate);\r\n                    frm.set_value('premium_rate1', r.message.premium_rate);\r\n                }\r\n            }\r\n        });\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get',\r\n            args: {\r\n                doctype: 'VAT',\r\n                filters: {}\r\n            },\r\n            callback: function(r) {\r\n                if (r.message) {\r\n                    frm.set_value('vat', r.message.vat);\r\n                }\r\n            }\r\n        });\r\n    },\r\n\r\n    ////---------Invoice Details tab\r\n    dd_amount: function(frm) {\r\n        calculateDD_Amount(frm);\r\n    },\r\n    premium_rate: function(frm) {\r\n        calculateDD_Amount(frm);\r\n    },\r\n    no_of_cls: function(frm) {\r\n        calculateno_of_cls(frm);\r\n    },\r\n    cl_fee: function(frm) {\r\n        calculateno_of_cls(frm);\r\n    },\r\n    no_of_cl_enq: function(frm) {\r\n        calculateno_of_cl_enq(frm);\r\n    },\r\n    cl_enquiry_fee: function(frm) {\r\n        calculateno_of_cl_enq(frm);\r\n    },\r\n\r\n    ////---------Debit note details\r\n    ddamount: function(frm) {\r\n        calculateDDAmount1(frm);\r\n    },\r\n    premium_rate1: function(frm) {\r\n        calculateDDAmount1(frm);\r\n    },\r\n    noofcls: function(frm) {\r\n        calculateno_ofcls(frm);\r\n    },\r\n    cl_fee1: function(frm) {\r\n        calculateno_ofcls(frm);\r\n    },\r\n    noofclenq: function(frm) {\r\n        calculateno_ofclenq(frm);\r\n    },\r\n    cl_enquiry_fee1: function(frm) {\r\n        calculateno_ofclenq(frm);\r\n    },\r\n    \r\n\r\n   \r\n    \r\n});\r\n\r\n\r\n// function generateNumber(frm) {\r\n//     if (!frm.doc.dedbit_note_no) {\r\n//         let currentYear = new Date().getFullYear();\r\n//         let prefix = `INV/${currentYear}/DDR`;\r\n\r\n//         frappe.call({\r\n//             method: 'frappe.client.get_list',\r\n//             args: {\r\n//                 doctype: 'Debit Note',\r\n//                 fields: ['dedbit_note_no'],\r\n//                 order_by: 'dedbit_note_no desc',\r\n//                 limit: 1\r\n//             },\r\n//             callback: function(r) {\r\n//                 if (r.message && r.message.length > 0) {\r\n//                     let lastProposalNo = r.message[0].dedbit_note_no;\r\n//                     let lastNumber = parseInt(lastProposalNo.split(\"DDR\").pop());\r\n//                     if (!isNaN(lastNumber)) {\r\n//                         let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n//                         frm.set_value('dedbit_note_no', prefix + newNumber);\r\n//                     }\r\n//                 } else {\r\n//                     frm.set_value('dedbit_note_no', prefix + '0001');\r\n//                 }\r\n//             }\r\n//         });\r\n\r\n// }\r\n// ////---------Invoice Details tab\r\n// function calculateDD_Amount(frm) {\r\n//     var dd_amount = frm.doc.dd_amount;\r\n//     var premium_rate = frm.doc.premium_rate;\r\n\r\n//     dd_amount = parseFloat(dd_amount.replace(/[^\\d.]/g, ''));\r\n//     var premiumrate = (dd_amount * premium_rate) / 100;\r\n\r\n//     var formattedPremiumRate = formatNumberWithoutCurrencySymbol(premiumrate);\r\n//     var formattedDDAmount = formatNumberWithoutCurrencySymbol(dd_amount);\r\n\r\n//     frm.set_value('premiumrate', formattedPremiumRate);\r\n//     frm.set_value('dd_amount', formattedDDAmount);\r\n//     frm.set_value('premiumrate', premiumrate);\r\n// }\r\n\r\n// function formatNumberWithoutCurrencySymbol(number) {\r\n//     return number.toLocaleString('en-US');\r\n// }\r\n\r\n// function calculateno_of_cls(frm) {\r\n//     var no_of_cls = frm.doc.no_of_cls;\r\n//     var cl_fee = frm.doc.cl_fee;\r\n//     var clfee = cl_fee * no_of_cls;\r\n//     frm.set_value('clfee', clfee);\r\n// }\r\n\r\n// function calculateno_of_cl_enq(frm) {\r\n//     var no_of_cl_enq = frm.doc.no_of_cl_enq;\r\n//     var cl_enquiry_fee = frm.doc.cl_enquiry_fee;\r\n//     var clenquiryfee = no_of_cl_enq * cl_enquiry_fee;\r\n//     frm.set_value('clenquiryfee', clenquiryfee);\r\n// }\r\n// }\r\n \r\n//  function generateNumber(frm) {\r\n//     if (!frm.doc.invoice_no || frm.doc.dedbit_note_no) return;\r\n\r\n//     const invoiceNo = frm.doc.invoice_no.trim();\r\n//     const parts = invoiceNo.split('/');\r\n//     if (parts.length !== 3) {\r\n//         frappe.msgprint('Invalid invoice number format. Expected: INV/YYYY/D001 or E001');\r\n//         return;\r\n//     }\r\n\r\n//     const invPrefix = parts[0]; // INV\r\n//     const invYear = parts[1];   // 2025\r\n//     const invSeries = parts[2]; // D001 or E001\r\n\r\n//     let seriesCode = '';\r\n//     if (invSeries.startsWith('D')) {\r\n//         seriesCode = 'DCR';\r\n//     } else if (invSeries.startsWith('E')) {\r\n//         seriesCode = 'ECR';\r\n//     } else {\r\n//         frappe.msgprint('Invoice number must start with D or E.');\r\n//         return;\r\n//     }\r\n\r\n//     const prefix = `${invPrefix}/${invYear}/${seriesCode}`;\r\n\r\n//     frappe.call({\r\n//         method: 'frappe.client.get_list',\r\n//         args: {\r\n//             doctype: 'Debit Note',\r\n//             filters: {\r\n//                 dedbit_note_no: ['like', `${prefix}%`]\r\n//             },\r\n//             fields: ['dedbit_note_no'],\r\n//             order_by: 'dedbit_note_no desc',\r\n//             limit: 1\r\n//         },\r\n//         callback: function(r) {\r\n//             let newNumber = '001';\r\n\r\n//             if (r.message && r.message.length > 0) {\r\n//                 const lastNo = r.message[0].dedbit_note_no;\r\n//                 const match = lastNo.match(/(\\d{3})$/);\r\n//                 if (match && !isNaN(match[1])) {\r\n//                     newNumber = (parseInt(match[1]) + 1).toString().padStart(3, '0');\r\n//                 }\r\n//             }\r\n\r\n//             const finalNumber = `${prefix}${newNumber}`;\r\n//             frm.set_value('dedbit_note_no', finalNumber);\r\n//             frm.refresh_field('dedbit_note_no');\r\n//         }\r\n//     });\r\n// }\r\nfunction generateNumber(frm) {\r\n    if (!frm.doc.invoice_no) {\r\n        //frappe.msgprint('Invoice number is missing.');\r\n        return;\r\n    }\r\n\r\n    const invoiceNo = frm.doc.invoice_no.trim();\r\n    const parts = invoiceNo.split('/');\r\n    if (parts.length !== 3) {\r\n        frappe.msgprint('Invalid invoice number format. Expected: INV/YYYY/D001 or E001');\r\n        return;\r\n    }\r\n\r\n    const invPrefix = parts[0]; // INV\r\n    const invYear = parts[1];   // 2025\r\n    const invSeries = parts[2]; // D001 or E001\r\n\r\n    let seriesCode = '';\r\n    if (invSeries.startsWith('D')) {\r\n        seriesCode = 'DCR';\r\n    } else if (invSeries.startsWith('E')) {\r\n        seriesCode = 'ECR';\r\n    } else {\r\n        frappe.msgprint('Invoice series must start with D or E.');\r\n        return;\r\n    }\r\n\r\n    const prefix = `${invPrefix}/${invYear}/${seriesCode}`;\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Debit Note',\r\n            filters: {\r\n                dedbit_note_no: ['like', `${prefix}%`]\r\n            },\r\n            fields: ['dedbit_note_no'],\r\n            order_by: 'dedbit_note_no desc',\r\n            limit: 1\r\n        },\r\n        callback: function(r) {\r\n            let newNumber = '001';\r\n\r\n            if (r.message && r.message.length > 0) {\r\n                const lastNo = r.message[0].dedbit_note_no;\r\n                const match = lastNo.match(/(\\d{3})$/);\r\n                if (match && !isNaN(match[1])) {\r\n                    newNumber = (parseInt(match[1]) + 1).toString().padStart(3, '0');\r\n                }\r\n            }\r\n\r\n            const finalNumber = `${prefix}${newNumber}`;\r\n            frm.set_value('dedbit_note_no', finalNumber);\r\n            frm.refresh_field('dedbit_note_no');\r\n            console.log(\"enerated Debit Note No:\", finalNumber);\r\n        }\r\n    });\r\n}\r\n\r\n\r\n\r\n////---------Debit note details\r\nfunction calculateDDAmount1(frm) {\r\n    var ddamount = frm.doc.ddamount;\r\n    var premium_rate1 = frm.doc.premium_rate1;\r\n\r\n    ddamount = parseFloat(ddamount.replace(/[^\\d.]/g, ''));\r\n    var premium_rate2 = (premium_rate1 * ddamount) / 100;\r\n\r\n    var formattedpremium_rate2 = formatNumberWithoutCurrencySymbol(premium_rate2);\r\n    var formattedddamount = formatNumberWithoutCurrencySymbol(ddamount);\r\n\r\n    frm.set_value('premium_rate2', formattedpremium_rate2);\r\n    frm.set_value('ddamount', formattedddamount);\r\n    frm.set_value('premium_rate2', premium_rate2);\r\n}\r\n\r\n\r\n\r\n\r\nfunction calculateno_ofcls(frm) {\r\n    var noofcls = frm.doc.noofcls;\r\n    var cl_fee1 = frm.doc.cl_fee1;\r\n    var cl_fee2 = cl_fee1 * noofcls;\r\n    frm.set_value('cl_fee2', cl_fee2);\r\n}\r\n\r\nfunction calculateno_ofclenq(frm) {\r\n    var noofclenq = frm.doc.noofclenq;\r\n    var cl_enquiry_fee1 = frm.doc.cl_enquiry_fee1;\r\n    var cl_enquiry_fee2 = noofclenq * cl_enquiry_fee1;\r\n    frm.set_value('cl_enquiry_fee2', cl_enquiry_fee2);\r\n}\r\n\r\n\r\nfunction calculateno_of_cls(frm) {\r\n    var no_of_cls = frm.doc.no_of_cls;\r\n    var cl_fee = frm.doc.cl_fee;\r\n    var clfee = cl_fee * no_of_cls;\r\n    frm.set_value('clfee', clfee);\r\n}\r\n ",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Submit to Finance",
  "enabled": 1,
  "modified": "2025-12-08 13:55:32.045604",
  "module": null,
  "name": "Submit to Finance script",
  "script": "frappe.ui.form.on('Submit to Finance', {\r\n\r\n    onload(frm) {\r\n      // frm.set_df_property('child_table', 'cannot_add_rows', true);\r\n        generateDDNumber(frm);\r\n        generateClientNumber(frm);\r\n        fetchPremiumAndRate(frm);\r\n\r\n     \r\n        \r\n    },\r\n\r\n    refresh(frm) {\r\n        \r\n            fetchPremiumAndRate(frm);\r\n frm.set_df_property('child_table', 'cannot_add_rows', true);\r\n\r\n        // Right align numeric fields\r\n        ['invoice_amount', 'premium_charges', 'premium_rate', 'a', 'total', 'vat', 'invoice_stamp_duty','invoice_amount_wo_stamp_duty']\r\n            .forEach(f => {\r\n                if (frm.fields_dict[f] && frm.fields_dict[f].$input) {\r\n                    frm.fields_dict[f].$input.css(\"text-align\", \"right\");\r\n                }\r\n            });\r\n\r\n       \r\n    },\r\n    \r\n    grandtotal(frm) {\r\n        fetchPremiumAndRate(frm);\r\n    },\r\n\r\n    premium_charges(frm) {\r\n        calculateTotal(frm);\r\n        autoBuildChildTable(frm);\r\n    },\r\n\r\n\r\n  vat(frm) {\r\n    calculateTotal(frm);\r\n    autoBuildChildTable(frm);\r\n},\r\n\r\n    premium_rate(frm) {\r\n        calculateTotal(frm);\r\n        autoBuildChildTable(frm);\r\n    },\r\n\r\n});\r\n\r\n\r\n// ------------------------- FETCH PREMIUM + RATE ----------------------------\r\n\r\n\r\n\r\n\r\nfunction fetchPremiumAndRate(frm) {\r\n\r\n    // Get values from the two fields\r\n    const grandtotal = frm.doc.grandtotal || 0;\r\n    const grandtotal1 = frm.doc.grandtotal1 || 0;\r\n\r\n    console.log(\"Grandtotal:\", grandtotal);\r\n    console.log(\"Grandtotal1:\", grandtotal1);\r\n\r\n    // Choose the value that is non-zero\r\n    let premium_charges = 0;\r\n    if (grandtotal !== 0) {\r\n        premium_charges = grandtotal;\r\n    } else if (grandtotal1 !== 0) {\r\n        premium_charges = grandtotal1;\r\n    }\r\n\r\n    console.log(\"Premium Charges to set:\", premium_charges);\r\n\r\n    // Set your custom field\r\n    frm.set_value('premium_charges', premium_charges);\r\n    \r\n    //setting decl amt\r\n     frm.set_value('decl_amt', premium_charges);\r\n\r\n    // Optional: set premium_rate if needed\r\n    frm.set_value('premium_rate', frm.doc.premium_rate || 0);\r\n\r\n    // Recalculate totals and rebuild child table\r\n    if (typeof calculateTotal === \"function\") {\r\n        calculateTotal(frm);\r\n    }\r\n    if (typeof autoBuildChildTable === \"function\") {\r\n        autoBuildChildTable(frm);\r\n    }\r\n\r\n    // Refresh the form fields to show updates\r\n    frm.refresh_field('premium_charges');\r\n    frm.refresh_field('premium_rate');\r\n\r\n    console.log(\"fetchPremiumAndRate completed\");\r\n}\r\n\r\n\r\n\r\n// ------------------------- TOTAL CALCULATION ------------------------------\r\n\r\n// function calculateTotal(frm) {\r\n\r\n//      //let a = ((frm.doc.premium_charges || 0) * (frm.doc.premium_rate || 0)) / 100;\r\n//      let a = ((frm.doc.premium_charges || 0) * (frm.doc.premium_rate1 || 0)) / 100;\r\n//     let total = a;\r\n//     let vat = frm.doc.vat || 0;\r\n//     let invoice_amount = total + (total * vat / 100);\r\n    \r\n//     let invoice_vat_amount = (total * vat / 100);\r\n    \r\n//     let invAmt_exclude_vat = (invoice_amount - invoice_vat_amount);\r\n\r\n\r\n//     frm.set_value('a', a);\r\n//     frm.set_value('total', total);\r\n//     frm.set_value('invoice_amount', invoice_amount);\r\n//     frm.set_value('invoice_stamp_duty', invoice_vat_amount);\r\n//      frm.set_value('invoice_amount_wo_stamp_duty', invAmt_exclude_vat);\r\n// }\r\n\r\nfunction calculateTotal(frm) {\r\n\r\n    let premium_charges = Number(frm.doc.premium_charges) || 0;\r\n    let premium_rate = Number(frm.doc.premium_rate1 || frm.doc.premium_rate) || 0;\r\n    let vat = Number(frm.doc.vat) || 0;\r\n\r\n    // Premium amount\r\n    let a = (premium_charges * premium_rate) / 100;\r\n    let total = a;\r\n\r\n    // VAT amount\r\n    let invoice_vat_amount = (total * vat) / 100;\r\n\r\n    // Invoice including VAT\r\n    let invoice_amount = total + invoice_vat_amount;\r\n\r\n    // Invoice excluding VAT\r\n    let invAmt_exclude_vat = invoice_amount - invoice_vat_amount;\r\n\r\n    // Set values\r\n    frm.set_value(\"a\", a);\r\n    frm.set_value(\"total\", total);\r\n    frm.set_value(\"invoice_stamp_duty\", invoice_vat_amount);\r\n    frm.set_value(\"invoice_amount\", invoice_amount);\r\n    frm.set_value(\"invoice_amount_wo_stamp_duty\", invAmt_exclude_vat);\r\n}\r\n\r\n\r\n// ------------------------- CHILD TABLE AUTO BUILD -------------------------\r\n\r\nfunction autoBuildChildTable(frm) {\r\n\r\n    frm.clear_table(\"child_table\");\r\n\r\n    let a = frm.doc.a || 0;\r\n\r\n    let child = frappe.model.add_child(frm.doc, \"Submit to Finance Child\", \"child_table\");\r\n\r\n    child.description = \"Premium Charges\";\r\n    child.quantity = 1;\r\n    child.price = a;\r\n    child.amount = a;\r\n\r\n    frm.refresh_field(\"child_table\");\r\n}\r\n\r\n\r\n// ------------------------- GENERATE INVOICE NO ---------------------------\r\n\r\nfunction generateDDNumber(frm) {\r\n    if (frm.doc.invoice_no) return;\r\n\r\n    let year = new Date().getFullYear();\r\n    let prefix = `INV/${year}/D`;\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Submit to Finance',\r\n            fields: ['invoice_no'],\r\n            filters: { invoice_no: [\"like\", `INV/${year}/D%`] },\r\n            limit: 1,\r\n            order_by: 'creation desc'\r\n        },\r\n        callback(r) {\r\n\r\n            let last = r.message?.[0]?.invoice_no || \"\";\r\n            let lastNum = parseInt(last.split(\"D\").pop()) || 0;\r\n            let next = String(lastNum + 1).padStart(4, '0');\r\n\r\n            frm.set_value('invoice_no', `${prefix}${next}`);\r\n        }\r\n    });\r\n}\r\n\r\n\r\n// ----------------------- GENERATE CLIENT NO -----------------------------\r\n\r\nfunction generateClientNumber(frm) {\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Submit to Finance',\r\n            fields: ['client'],\r\n            limit: 1,\r\n            order_by: 'creation desc'\r\n        },\r\n        callback(r) {\r\n\r\n            let last = r.message?.[0]?.client || '';\r\n            let num = last ? parseInt(last.substring(4)) : 0;\r\n\r\n            let newNum = String(num + 1).padStart(4, '0');\r\n            let prefix = (frm.doc.name1 || '').substring(0, 4).toUpperCase();\r\n\r\n            frm.set_value('client', prefix + newNum);\r\n        }\r\n    });\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Credit Note",
  "enabled": 0,
  "modified": "2025-11-26 02:55:51.381537",
  "module": "Finance",
  "name": "Credit Note Full Script",
  "script": "  frappe.ui.form.on('Credit Note', {\r\n    onload: function(frm) {\r\n        // Fetch CI Invoices to populate the policy holder dropdown\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'CI Invoices',\r\n                fields: ['policy_holder']\r\n            },\r\n            callback: function(response) {\r\n                if (response.message && response.message.length > 0) {\r\n                    var policyHolders = response.message.map(function(invoice) {\r\n                        return invoice.policy_holder;\r\n                    });\r\n                    // Set dropdown options for policy holder field\r\n                    frm.set_df_property('policy_holder', 'options', policyHolders);\r\n                } else {\r\n                    frappe.msgprint('No CI Invoices found.');\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error(err);\r\n                frappe.msgprint('An error occurred while fetching CI Invoices.');\r\n            }\r\n        });\r\n         frm.toggle_display('confirm', false);\r\n          frappe.call({\r\n            method: 'frappe.client.get',\r\n            args: {\r\n                doctype: 'Export Declaration Invoice',\r\n                filters: {\r\n                    no_of_cls: frm.doc.credit_limits\r\n                }\r\n            },\r\n            callback: function(r) {\r\n                if (r.message) {\r\n                    frm.set_value('no_of_cls', r.message.credit_limits);\r\n                    frm.set_value('no_of_cl_enq', r.message.credit_limits1);\r\n                     frm.set_value('no_of_cls1', r.message.credit_limits);\r\n                    frm.set_value('no_of_cl_enq1', r.message.credit_limits1);\r\n                     frm.set_value('cl_fee', r.message.credit_limit_fee);\r\n                                          frm.set_value('cl_enquiry_fee', r.message.credit_limit_enquiry_fee);\r\nfrm.set_value('cl_fee1', r.message.credit_limit_fee);\r\n                    frm.set_value('cl_enquiry_fee1', r.message.credit_limit_enquiry_fee);\r\n                }\r\n            }\r\n        });\r\n\r\n        // frappe.call({\r\n        //     method: 'frappe.client.get',\r\n        //     args: {\r\n        //         doctype: 'ECI Quotations',\r\n        //         filters: {\r\n        //             per_enquiryp: frm.doc.per_enquiryp\r\n        //         }\r\n        //     },\r\n        //     callback: function(r) {\r\n        //         if (r.message) {\r\n        //             frm.set_value('cl_fee', r.message.cl_per_monthp);\r\n        //             frm.set_value('cl_enquiry_fee', r.message.per_enquiryp);\r\n        //             frm.set_value('cl_fee1', r.message.cl_per_monthp);\r\n        //             frm.set_value('cl_enquiry_fee1', r.message.per_enquiryp);\r\n        //         }\r\n        //     }\r\n        // });\r\n      if (!frm.doc.credit_note_no) {\r\n            generateNumber(frm);\r\n        }    \r\n        var workflowState = frm.doc.workflow_state;\r\n        if (workflowState === \"Approved\") {\r\n            frm.toggle_display('policy_holder1', true);\r\n            frm.toggle_display('policy_holder', false);\r\n        }\r\n          \r\n    },\r\n     \r\n\r\n    policy_holder: function(frm) {\r\n        var PH = frm.doc.policy_holder;\r\n \r\n     frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'CI Invoices',\r\n            filters: {\r\n                policy_holder: PH\r\n            },\r\n            fields: ['invoice_date', 'invoice_no', 'vat', 'invoice_amount']\r\n        },\r\n        callback: function(response) {\r\n            console.log(\"response:\", response);\r\n            if (response.message && response.message.length > 0) {\r\n                var cl_data = response.message[0];\r\n                var policyHolder = frm.doc.policy_holder\r\n                // Populate fields if data is found\r\n                frm.set_value('invoice_date', cl_data.invoice_date || '');\r\n                frm.set_value('invoice_no', cl_data.invoice_no || '');\r\n                frm.set_value('vat', cl_data.vat || '');\r\n                frm.set_value('total_amountincl_vat', cl_data.invoice_amount || '');\r\n                frm.set_value('policy_holder1', policyHolder);\r\n                // Fetch child table data based on the selected policy holder\r\n                frappe.call({\r\n                    method: \"frappe.client.get\",\r\n                    args: {\r\n                        doctype: \"CI Invoices\",\r\n                        filters: {\r\n                            policy_holder: PH\r\n                        },\r\n                        fields: [\"export_buyer\"]\r\n                    },\r\n                    callback: function(r) {\r\n                        console.log(r, \"client short name\");\r\n                        if (!r.exc) {\r\n                            if (r.message && r.message.export_buyer && r.message.export_buyer.length > 0) {\r\n                                frm.clear_table('credit_note_child');\r\n                                r.message.export_buyer.forEach(function(buyer) {\r\n                                    var child = frappe.model.add_child(frm.doc, \"credit note child\", \"credit_note_child\");\r\n                                    frappe.model.set_value(child.doctype, child.name, \"country\", buyer.country);\r\n                                    frappe.model.set_value(child.doctype, child.name, \"buyer\", buyer.buyer);\r\n                                    frappe.model.set_value(child.doctype, child.name, \"dcl_amt\", buyer.declamt);\r\n                                    frappe.model.set_value(child.doctype, child.name, \"premium_rate\", buyer.premium_rate);\r\n                                    frappe.model.set_value(child.doctype, child.name, \"amount\", buyer.premamount); \r\n                                    // Add more fields as needed\r\n                                });\r\n                                frm.refresh_fields('credit_note_child');\r\n                            } else {\r\n                                console.error(\"No export buyer found.\");\r\n                            }\r\n                        } else {\r\n                            console.error(\"Error occurred:\", r.exc);\r\n                        }\r\n                    }\r\n                });\r\n            } else {\r\n                // Clear fields and child table if no matching record found\r\n                frm.set_value('invoice_date', '');\r\n                frm.set_value('invoice_no', '');\r\n                frm.set_value('vat', '');\r\n                frm.set_value('total_amountincl_vat', '');\r\n                frm.clear_table('credit_note_child');\r\n                frappe.msgprint('No matching record found.');\r\n            }\r\n        },\r\n        error: function(xhr, textStatus, errorThrown) {\r\n            console.error(textStatus, errorThrown);\r\n            frappe.msgprint('An error occurred while fetching data.');\r\n        }\r\n    });\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: {\r\n                doctype: \"CI Invoices\",\r\n                filters: {\r\n                    policy_holder: PH\r\n                },\r\n                fields: [\"export_buyer\"]\r\n            },\r\n            callback: function(r) {\r\n                console.log(r, \"client short name\");\r\n                if (!r.exc) {\r\n                    if (r.message && r.message.export_buyer.length > 0) {\r\n                        var buyer = r.message.export_buyer[0]; // Assuming you only want the first buyer\r\n                        frm.set_value('dcl_amount1', buyer.declamt);\r\n                        frm.set_value('premium_rate1', buyer.premium_rate);\r\n                        frm.set_value('dcl_amount2', buyer.declamt);\r\n                        frm.set_value('premium_rate2', buyer.premium_rate);\r\n                    } else {\r\n                        console.error(\"No export buyer found.\");\r\n                    }\r\n                } else {\r\n                    console.error(\"Error occurred:\", r.exc);\r\n                }\r\n            }\r\n        });\r\n     var cl_fee = frm.doc.cl_fee; \r\nvar cl_fee1 = frm.doc.cl_fee1; \r\nvar cl_enquiry_fee = frm.doc.cl_enquiry_fee;\r\nvar no_of_cls = frm.doc.no_of_cls;\r\nvar no_of_cls1 = frm.doc.no_of_cls1;\r\nvar no_of_cl_enq = frm.doc.no_of_cl_enq;\r\nvar cl_enquiry_fee1 = frm.doc.cl_enquiry_fee1;\r\nvar no_of_cl_enq1 = frm.doc.no_of_cl_enq1;\r\nvar dcl_amount1 = frm.doc.dcl_amount1;\r\nvar premium_rate1 = frm.doc.premium_rate1;\r\nvar dcl_amount2 = frm.doc.dcl_amount2;\r\nvar premium_rate2 = frm.doc.premium_rate2;\r\n\r\n// Calculate all the values first\r\nvar b = cl_fee * no_of_cls;\r\nvar c = cl_enquiry_fee * no_of_cl_enq;\r\nvar e = cl_fee1 * no_of_cls1;\r\nvar f = cl_enquiry_fee1 * no_of_cl_enq1;\r\nvar a = dcl_amount1 * premium_rate1;\r\nvar d = dcl_amount2 * premium_rate2;\r\n\r\n// Calculate cl_enquiry_fee\r\nvar cl_enquiry_fee_calculated = cl_enquiry_fee * no_of_cl_enq;\r\nvar cl_enquiry_fee_calculated1 = cl_enquiry_fee1 * no_of_cl_enq1;\r\n \r\n// Set the calculated values to the fields you want\r\nfrm.set_value('b', b);\r\nfrm.set_value('c', c);\r\nfrm.set_value('e', e);\r\nfrm.set_value('f', f);\r\nfrm.set_value('a', a);\r\nfrm.set_value('d', d);\r\nfrm.set_value('cl_enquiry_fee', cl_enquiry_fee_calculated);\r\nfrm.set_value('cl_enquiry_fee1', cl_enquiry_fee_calculated1);\r\nfrappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'CI Invoices',\r\n        filters: {\r\n            policy_holder: PH\r\n        },\r\n        fields: ['invoice_date', 'invoice_no', 'vat', 'invoice_amount', 'name']\r\n    },\r\n    callback: function(response) {\r\n        if (response.message && response.message.length > 0) {\r\n            var cl_data = response.message[0];\r\n\r\n            // Set invoice fields\r\n            frm.set_value('invoice_date', cl_data.invoice_date || '');\r\n            frm.set_value('invoice_no', cl_data.invoice_no || '');\r\n            frm.set_value('vat', cl_data.vat || '');\r\n            frm.set_value('total_amountincl_vat', cl_data.invoice_amount || '');\r\n\r\n            // \ud83d\udd11 Extract parts from invoice number: INV/2013/D001\r\n            let invoiceNo = cl_data.invoice_no || '';\r\n            let parts = invoiceNo.split('/');\r\n            if (parts.length !== 3) {\r\n                frappe.msgprint('Invalid invoice number format.');\r\n                return;\r\n            }\r\n\r\n            let invPrefix = parts[0]; // INV\r\n            let invYear = parts[1];   // 2013\r\n            let invSeries = parts[2]; // D001 or E001\r\n\r\n            let seriesType = '';\r\n            if (invSeries.startsWith('D')) {\r\n                seriesType = 'DCR';\r\n            } else if (invSeries.startsWith('E')) {\r\n                seriesType = 'ECR';\r\n            } else {\r\n                frappe.msgprint('Invoice series must start with D or E.');\r\n                return;\r\n            }\r\n\r\n            let creditPrefix = `${invPrefix}/${invYear}/${seriesType}`;\r\n\r\n            // \ud83d\udd04 Fetch last credit note number in same series\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Credit Note',\r\n                    filters: {\r\n                        credit_note_no: ['like', creditPrefix + '%']\r\n                    },\r\n                    fields: ['credit_note_no'],\r\n                    order_by: 'creation desc',\r\n                    limit: 1\r\n                },\r\n                callback: function(r) {\r\n                    let newNumber = '001';\r\n                    if (r.message && r.message.length > 0) {\r\n                        let lastNo = r.message[0].credit_note_no;\r\n                        let lastParts = lastNo.split('/');\r\n                        if (lastParts.length === 3) {\r\n                            let lastSuffix = lastParts[2].replace(seriesType, '');\r\n                            if (!isNaN(lastSuffix)) {\r\n                                let lastNumber = parseInt(lastSuffix);\r\n                                newNumber = (lastNumber + 1).toString().padStart(3, '0');\r\n                            }\r\n                        }\r\n                    }\r\n                    frm.set_value('credit_note_no', `${invPrefix}/${invYear}/${seriesType}${newNumber}`);\r\n                }\r\n            });\r\n\r\n            // \ud83d\udd04 Fetch child table data\r\n            frappe.call({\r\n                method: \"frappe.client.get\",\r\n                args: {\r\n                    doctype: \"CI Invoices\",\r\n                    name: cl_data.name\r\n                },\r\n                callback: function(r) {\r\n                    if (!r.exc && r.message && r.message.export_buyer) {\r\n                        frm.clear_table('credit_note_child2');\r\n                        r.message.export_buyer.forEach(function(buyer) {\r\n                            let child = frappe.model.add_child(frm.doc, \"Credit Note Child2\", \"credit_note_child1\");\r\n                            frappe.model.set_value(child.doctype, child.name, \"country\", buyer.country);\r\n                            frappe.model.set_value(child.doctype, child.name, \"buyer\", buyer.buyer);\r\n                            frappe.model.set_value(child.doctype, child.name, \"dcl_amt\", buyer.declamt);\r\n                            frappe.model.set_value(child.doctype, child.name, \"premium_rate\", buyer.premium_rate);\r\n                            frappe.model.set_value(child.doctype, child.name, \"amount\", buyer.premamount);\r\n                        });\r\n                        frm.refresh_field('credit_note_child1');\r\n                    } else {\r\n                        console.error(\"No export buyer found.\");\r\n                    }\r\n                }\r\n            });\r\n\r\n        } else {\r\n            frm.set_value('invoice_date', '');\r\n            frm.set_value('invoice_no', '');\r\n            frm.set_value('vat', '');\r\n            frm.set_value('total_amountincl_vat', '');\r\n            frm.clear_table('Credit Note Child2');\r\n            frappe.msgprint('No matching CI Invoice found.');\r\n        }\r\n    },\r\n    error: function(xhr, textStatus, errorThrown) {\r\n        console.error(textStatus, errorThrown);\r\n        frappe.msgprint('An error occurred while fetching invoice data.');\r\n    }\r\n});\r\n\r\n    // frappe.call({\r\n    //     method: 'frappe.client.get_list',\r\n    //     args: {\r\n    //         doctype: 'CI Invoices',\r\n    //         filters: {\r\n    //             policy_holder: PH\r\n    //         },\r\n    //         fields: ['invoice_date', 'invoice_no', 'vat', 'invoice_amount']\r\n    //     },\r\n    //     callback: function(response) {\r\n    //         console.log(\"response:\", response);\r\n    //         if (response.message && response.message.length > 0) {\r\n    //             var cl_data = response.message[0];\r\n\r\n    //             // Populate fields if data is found\r\n    //             frm.set_value('invoice_date', cl_data.invoice_date || '');\r\n    //             frm.set_value('invoice_no', cl_data.invoice_no || '');\r\n    //             frm.set_value('vat', cl_data.vat || '');\r\n    //             frm.set_value('total_amountincl_vat', cl_data.invoice_amount || '');\r\n\r\n    //             // Fetch child table data based on the selected policy holder\r\n    //             frappe.call({\r\n    //                 method: \"frappe.client.get\",\r\n    //                 args: {\r\n    //                     doctype: \"CI Invoices\",\r\n    //                     filters: {\r\n    //                         policy_holder: PH\r\n    //                     },\r\n    //                     fields: [\"export_buyer\"]\r\n    //                 },\r\n    //                 callback: function(r) {\r\n    //                     console.log(r, \"client short name\");\r\n    //                     if (!r.exc) {\r\n    //                         if (r.message && r.message.export_buyer && r.message.export_buyer.length > 0) {\r\n    //                             frm.clear_table('credit_note_child2');\r\n    //                             r.message.export_buyer.forEach(function(buyer) {\r\n    //                                 var child = frappe.model.add_child(frm.doc, \"Credit Note Child2\", \"credit_note_child1\");\r\n    //                                 frappe.model.set_value(child.doctype, child.name, \"country\", buyer.country);\r\n    //                                 frappe.model.set_value(child.doctype, child.name, \"buyer\", buyer.buyer);\r\n    //                                  frappe.model.set_value(child.doctype, child.name, \"dcl_amt\", buyer.declamt);\r\n    //                                  frappe.model.set_value(child.doctype, child.name, \"premium_rate\", buyer.premium_rate);\r\n    //                                  frappe.model.set_value(child.doctype, child.name, \"amount\", buyer.premamount); \r\n    //                                 // // Add more fields as needed\r\n    //                             });\r\n    //                             frm.refresh_fields('credit_note_child1');\r\n    //                         } else {\r\n    //                             console.error(\"No export buyer found.\");\r\n    //                         }\r\n    //                     } else {\r\n    //                         console.error(\"Error occurred:\", r.exc);\r\n    //                     }\r\n    //                 }\r\n    //             });\r\n    //         } else {\r\n    //             // Clear fields and child table if no matching record found\r\n    //             frm.set_value('invoice_date', '');\r\n    //             frm.set_value('invoice_no', '');\r\n    //             frm.set_value('vat', '');\r\n    //             frm.set_value('total_amountincl_vat', '');\r\n    //             frm.clear_table('Credit Note Child2');\r\n    //             frappe.msgprint('No matching record found.');\r\n    //         }\r\n    //     },\r\n    //     error: function(xhr, textStatus, errorThrown) {\r\n    //         console.error(textStatus, errorThrown);\r\n    //         frappe.msgprint('An error occurred while fetching data.');\r\n    //     }\r\n    // });\r\n \r\n \r\n     },\r\n    // tax_invoice: function(frm) {\r\n    //      frappe.route_options = {\r\n    //         invoice_to: frm.doc.policy_holder,\r\n    //         crn: frm.doc.invoice_no,\r\n    //         date: frm.doc.invoice_date,\r\n    //         ref_inv: frm.doc.credit_note_no,\r\n    //         amount9: frm.doc.no_of_cls,\r\n    //         amount10: frm.doc.cl_fee,\r\n    //         amount11: frm.doc.b,\r\n    //         amount12: frm.doc.no_of_cl_enq,\r\n    //         amount13: frm.doc.cl_enquiry_fee,\r\n    //         amount14: frm.doc.c,\r\n    //         amount19: frm.doc.vat,\r\n    //      }\r\n    //     frappe.new_doc('Credit Note Tax Invoice');\r\n    // },\r\n    // internal_invoice: function(frm) {\r\n    //     frappe.new_doc('Credit Note Internal Invoice');\r\n    // },\r\n     tax_invoice: function(frm) {\r\n        // Fetch the telephone, fax, and postal address from Company-Details based on the policy_holder\r\n        frappe.call({\r\n            method: 'frappe.client.get_value',\r\n            args: {\r\n                doctype: 'Company-Details',\r\n                fieldname: ['telephone', 'fax', 'postal_address', 'location', 'contact_person', 'vat_reg_no'],\r\n                filters: { name: frm.doc.policy_holder }\r\n            },\r\n            callback: function(r) {\r\n                if (r.message) {\r\n                    // Telephone, fax, and postal address fetched successfully\r\n                    const telephone = r.message.telephone;\r\n                    const fax = r.message.fax;\r\n                    const postal_address = r.message.postal_address;\r\n                    const location = r.message.location;\r\n                    const contact_person = r.message.contact_person;\r\n                    const vat_reg_no = r.message.vat_reg_no;\r\n                    const country = r.message.country;\r\n\r\n                    // Debugging line to check the fetched telephone number, fax, and postal address\r\n                    console.log(\"Telephone fetched: \", telephone);\r\n                    console.log(\"Fax fetched: \", fax);\r\n                    console.log(\"Postal Address fetched: \", postal_address);\r\n                    console.log(\"Location fetched: \", location);\r\n                    console.log(\"Contact Person fetched: \", contact_person);\r\n                    console.log(\"Vat Reg No fetched: \", vat_reg_no);\r\n                  // console.log(\"Country fetched: \", country);\r\n\r\n                    // Setting route options for the new Tax Invoice For CI Invoice document\r\n                    frappe.route_options = {\r\n                        invoice1: frm.doc.policy_holder,\r\n                        date1: frm.doc.invoice_date,\r\n                        invoice2: frm.doc.invoice_no,\r\n                         ref_inv: frm.doc.credit_note_no,\r\n                         crn: frm.doc.invoice_no,\r\n                       amount9  :frm.doc.no_of_cls,\r\n                       amount10:frm.doc.cl_fee,\r\n                       amount11:frm.doc.b,\r\n                       amount12:frm.doc.no_of_cl_enq,\r\n                       amount13:frm.doc.cl_enquiry_fee,\r\n                       amount14:frm.doc.c,\r\n                       amount19:frm.doc.vat,\r\n                      declaration :frm.doc.month,\r\n                        telephone: telephone,\r\n                        fax: fax,\r\n                        address: postal_address,\r\n                        city: location,\r\n                        attn: contact_person,\r\n                        vat: vat_reg_no,\r\n                        country:country,\r\n                    };\r\n\r\n                    // Create a new Tax Invoice For CI Invoice document\r\n                    frappe.new_doc('Credit Note Tax Invoice');\r\n                } else {\r\n                    // If the telephone, fax, and postal address are not found, display a message to the user\r\n                    frappe.msgprint(__('Telephone, Fax, and Postal Address not found for the selected Policy Holder.'));\r\n                }\r\n            }\r\n        });\r\n\r\n        // Fetch the policy number from Policy Approvals based on the policy_holder\r\n        frappe.call({\r\n            method: 'frappe.client.get_value',\r\n            args: {\r\n                doctype: 'Policy Approvals',\r\n                fieldname: ['policy_number'],\r\n                filters: { policy_holder: frm.doc.policy_holder }\r\n            },\r\n            callback: function(r) {\r\n                if (r.message && r.message.policy_number) {\r\n                    // Policy number fetched successfully\r\n                    const policy_number = r.message.policy_number;\r\n\r\n                    // Debugging line to check the fetched policy number\r\n                    console.log(\"Policy Number fetched: \", policy_number);\r\n\r\n                    // Appending to route options for the new Tax Invoice For CI Invoice document\r\n                    frappe.route_options.reference1 = policy_number;\r\n\r\n                    // Create a new Tax Invoice For CI Invoice document\r\n                    frappe.new_doc('Credit Note Tax Invoice');\r\n                } else {\r\n                    // If the policy number is not found, display a message to the user\r\n                    frappe.msgprint(__('Policy Number not found for the selected Policy Holder.'));\r\n                }\r\n            }\r\n        });\r\n          var childtable = frm.doc.credit_note_child;\r\n        for (var i = 0; i < childtable.length; i++) {\r\n            var row = childtable[i];\r\n            \r\n            frappe.model.with_doctype('Credit Note Tax Invoice', function() {\r\n                var newDoc = frappe.model.get_new_doc('Credit Note Tax Invoice');\r\n                                frappe.model.set_value(newDoc.doctype, newDoc.name, 'amount1', row.country);\r\n\r\n                frappe.model.set_value(newDoc.doctype, newDoc.name, 'amount2', row.dcl_amt);\r\n                  frappe.model.set_value(newDoc.doctype, newDoc.name, 'amount3', row.premium_rate);\r\n                frappe.model.set_value(newDoc.doctype, newDoc.name, 'amount4', row.amount);\r\n                frappe.set_route('Form', 'Credit Note Tax Invoice', newDoc.name);\r\n            });\r\n        }\r\n\r\n         \r\n    },\r\n     internal_invoice: function(frm) {\r\n        frappe.call({\r\n            method: 'frappe.client.get_value',\r\n            args: {\r\n                doctype: 'Company-Details',\r\n                fieldname: ['postal_address', 'location', 'vat_reg_no'],\r\n                filters: { name: frm.doc.policy_holder }\r\n            },\r\n            callback: function(r) {\r\n                if (r.message) {\r\n                    const postal_address = r.message.postal_address;\r\n                    const location = r.message.location;\r\n \r\n                    const vat_reg_no = r.message.vat_reg_no;\r\n                    \r\n                    console.log(\"Postal Address fetched: \", postal_address);\r\n                    console.log(\"Location fetched: \", location);\r\n                   \r\n                    console.log(\"Vat Reg No fetched: \", vat_reg_no);\r\n                    \r\n\r\n                    frappe.route_options = {\r\n                        name1: frm.doc.policy_holder,\r\n                        date: frm.doc.invoice_date,\r\n                        address: postal_address,\r\n                        city: location,\r\n                        \r\n                        vat: vat_reg_no,\r\n                        \r\n                    };\r\n\r\n                    frappe.new_doc('Credit Note Internal Invoice');\r\n                } else {\r\n                    frappe.msgprint(__('Telephone, Fax, and Postal Address not found for the selected Policy Holder.'));\r\n                }\r\n            }\r\n        });\r\n        var childtable = frm.doc.credit_note_child;\r\n        for (var i = 0; i < childtable.length; i++) {\r\n            var row = childtable[i];\r\n            \r\n            frappe.model.with_doctype('Credit Note Internal Invoice', function() {\r\n                var newDoc = frappe.model.get_new_doc('Credit Note Internal Invoice');\r\n                                frappe.model.set_value(newDoc.doctype, newDoc.name, 'currency1', row.buyer);\r\n\r\n                frappe.model.set_value(newDoc.doctype, newDoc.name, 'currency2', row.dcl_amt);\r\n                  frappe.model.set_value(newDoc.doctype, newDoc.name, 'currency3', row. country);\r\n              \r\n                frappe.set_route('Form', 'Credit Note Internal Invoice', newDoc.name);\r\n            });\r\n        }\r\n    },\r\n    refresh: function(frm) {\r\n         frm.fields_dict['no_of_cls'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n          frm.fields_dict['no_of_cl_enq'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n          frm.fields_dict['premium_rate1'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n          frm.fields_dict['dcl_amount1'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n          frm.fields_dict['cl_fee'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n          frm.fields_dict['cl_enquiry_fee'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n         frm.fields_dict['a'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n        frm.fields_dict['b'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n       frm.fields_dict['c'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n       frm.fields_dict['dcl_amount2'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n       frm.fields_dict['no_of_cl_enq1'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n       frm.fields_dict['no_of_cls1'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n frm.fields_dict['cl_fee1'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n       frm.fields_dict['cl_enquiry_fee1'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n frm.fields_dict['d'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n       frm.fields_dict['e'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n              frm.fields_dict['f'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n                            frm.fields_dict['total_amountincl_vat'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n                                          frm.fields_dict['vat'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n        \r\n        frm.fields_dict.internal_invoice.$input.addClass('btn-primary');\r\n        frm.fields_dict.tax_invoice.$input.addClass('btn-primary');\r\n        frm.fields_dict.cancel.$input.addClass('btn-primary');\r\n       // frm.fields_dict['credit_note_child'].grid.wrapper.find('.grid-add-row').hide();\r\n       frm.set_df_property('credit_note_child','cannot_add_rows', true); \r\n        frm.set_df_property('credit_note_child1','cannot_add_rows', true);\r\n                if (frm.doc.__islocal) {\r\n            // If the form is new and unsaved, keep the button hidden\r\n            frm.toggle_display('internal_invoice', false);\r\n            frm.toggle_display('tax_invoice', false);\r\n            //frm.toggle_display('dcl_amount1', false);\r\n            //frm.toggle_display('premium_rate1', false);\r\n              //frm.toggle_display('a', false);\r\n                f//rm.toggle_display('dcl_amount2', false);\r\n                 / frm.toggle_display('premium_rate2', false);\r\n                   // frm.toggle_display('d', false);\r\n        } else {\r\n            // If the form is saved, show the button\r\n            frm.toggle_display('internal_invoice', true);\r\n              frm.toggle_display('tax_invoice', true);\r\n              //frm.toggle_display('dcl_amount1', true);\r\n                //  frm.toggle_display('premium_rate1', true);\r\n                  //frm.toggle_display('a', true);\r\n                   // frm.toggle_display('dcl_amount2', true);\r\n                     // frm.toggle_display('premium_rate2', true);\r\n                       // frm.toggle_display('d', true);\r\n                          frm.toggle_display('credit_note_child', false);\r\n                            frm.toggle_display('invoce_details', false);\r\n                                                        frm.toggle_display('credit_note_child1', false);\r\n\r\n        }\r\n       \r\n          frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: \"CI Invoices\",\r\n                filters: {},\r\n                fields: ['policy_holder']\r\n            },\r\n            callback: function(submittedProposalsResponse) {\r\n                if (submittedProposalsResponse.message) {\r\n                    var submittedProposals = submittedProposalsResponse.message.map(function(proposal) {\r\n                        return proposal.policy_holder;\r\n                    });\r\n                    console.log(\"** Submitted Proposals:\", submittedProposals);\r\n                    console.log(\"** Fetching Approved Quotations **\");\r\n                    frappe.call({\r\n                        method: 'frappe.client.get_list',\r\n                        args: {\r\n                            doctype: 'Credit Note',\r\n                            filters: {\r\n                                workflow_state: 'Approved'\r\n                            },\r\n                            fields: ['policy_holder']\r\n                        },\r\n                        callback: function(approvedNotesResponse) {\r\n                            console.log(approvedNotesResponse, \"approvedNotesResponse\");\r\n                            if (approvedNotesResponse.message) {\r\n                                var approvedNotes = approvedNotesResponse.message.map(function(note) {\r\n                                    return note.policy_holder;\r\n                                });\r\n                                console.log(\"** Approved Notes:\", approvedNotes);\r\n                                // Filter client names (include only proposals not in approved quotations)\r\n                                var filteredClientNames = submittedProposals.filter(function(invoice) {\r\n                                    return !approvedNotes.includes(invoice);\r\n                                });\r\n                                console.log(\"** Filtered Client Names:\", filteredClientNames);\r\n                                frm.set_df_property('policy_holder', 'options', filteredClientNames);\r\n                                  \r\n                            }\r\n                        }\r\n                    });  \r\n                }\r\n            }\r\n        });\r\n        \r\n    }\r\n     \r\n     \r\n});\r\n   \r\n// function generateNumber(frm) {\r\n//     // Get the current year\r\n//     let currentYear = new Date().getFullYear();\r\n\r\n//     // Make a call to get the last number asynchronously\r\n//     frappe.call({\r\n//         method: 'frappe.client.get_list',\r\n//         args: {\r\n//             doctype: 'Credit Note',\r\n//             fields: ['credit_note_no'],\r\n//             order_by: 'creation desc',\r\n//             limit: 1\r\n//         },\r\n//         callback: function(r) {\r\n//             if (r.message && r.message.length > 0) {\r\n//                 let lastNumber = parseInt(r.message[0].credit_note_no.split(\"/\")[2]);  \r\n \r\n//                 if (!isNaN(lastNumber)) {\r\n//                     // Increment the last number and pad it with leading zeros\r\n//                     let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n//                     frm.set_value('credit_note_no', `INV/${currentYear}/${newNumber}`);\r\n//                     // frm.set_value('credit_note_no', prefix + newNumber);\r\n//                 } else {\r\n//                     // If the last number is not a valid number, set to default '0001'\r\n//                   // frm.set_value('credit_note_no', `INV/${currentYear}/0001`);\r\n//                   frm.set_value('credit_note_no', prefix + '0001');\r\n//                 }\r\n//             } else {\r\n//                 // If no previous numbers exist, set to default '0001'\r\n//                 frm.set_value('credit_note_no', `INV/${currentYear}/0001`);\r\n                                  \r\n\r\n                \r\n//             }\r\n//         }\r\n      \r\n\r\n//     });\r\n// }\r\n\r\n \r\n\r\n \r\n ",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Next Cancellation",
  "enabled": 1,
  "modified": "2024-05-10 06:29:16.991189",
  "module": null,
  "name": "NextCancellation",
  "script": "function deputyshreiff_bond(frm, callback) {\r\n    var deputyshreiff = frm.doc.deputyshreiff_bond;\r\n    if (deputyshreiff === 1) {\r\n        // Fetch details from deputyshreiff_bond \r\n        frm.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Deputy Sheriff Bond',\r\n                filters: {\r\n                    workflow_state: \"Approved\"\r\n                },\r\n                fields: ['sheriff_name']\r\n            },\r\n            callback: function(response) {\r\n                console.log(response, 'Get the data')\r\n                if (response.message && response.message.length > 0) {\r\n                    let DataArray = response.message || [];\r\n                    let FinalArray = DataArray.map(x => x.sheriff_name);\r\n                    frm.set_df_property('bond_holder', 'options', FinalArray);\r\n\r\n                    // Execute the callback function if provided\r\n                    if (callback) {\r\n                        callback(FinalArray);\r\n                    }\r\n                }\r\n            },\r\n            error: function(xhr, textStatus, errorThrown) {\r\n                console.error(\"Error fetching details from Deputy Shreiff Bond:\", textStatus, errorThrown);\r\n            }\r\n        });\r\n\r\n    } else {\r\n        let FinalArray = [];\r\n        frm.set_df_property('bond_holder', 'options', FinalArray);\r\n        console.log(\"bond_holder\", frm.doc.bond_holder2);\r\n    }\r\n}\r\n\r\nfunction CancelRecords(frm, workflow_state) {\r\n    console.log(\"Inside CancelRecords function\");\r\n    if (workflow_state === \"Cancelled\") {\r\n        console.log(\"Workflow state is Cancelled\");\r\n        frappe.set_route(\"Form\", \"Deputy Sheriff Bond\");\r\n        console.log(\"Routing to Deputy Sheriff Bond\");\r\n\r\n        deputyshreiff_bond(frm, function(sheriff_name) {\r\n            console.log(\"Value of frm:\", frm);\r\n            console.log(\"Value of frm.doc:\", frm.doc);\r\n            console.log(\"Value of frm.doc.bond_holder:\", frm.doc.bond_holder);\r\n            console.log(\"Value of sheriff_name:\", sheriff_name);\r\n\r\n          if (typeof frm !== 'undefined' && typeof frm.doc !== 'undefined' && typeof frm.doc.bond_holder !== 'undefined' && typeof sheriff_name !== 'undefined') {\r\n    console.log(\"Comparing bond_holder and sheriff_name:\", frm.doc.bond_holder, sheriff_name);\r\n    console.log(\"Value of frm.doc.bond_holder:\", frm.doc.bond_holder);\r\n    console.log(\"Value of sheriff_name:\", sheriff_name);\r\n\r\n    if (frm.doc.bond_holder === sheriff_name) {\r\n        console.log(\"The bond holder is the sheriff.\");\r\n    } else {\r\n        console.log(\"The bond holder is not the sheriff.\");\r\n    }\r\n\r\n    // Set the workflow state to \"Cancelled\"\r\n    frm.set_value(\"workflow_state\", \"Cancelled\", function() {\r\n        console.log(\"Workflow state changed to Cancelled\");\r\n    });\r\n} else {\r\n    console.log(\"Either frm, frm.doc, bond_holder, or sheriff_name is undefined\");\r\n}\r\n\r\n        });\r\n    }\r\n}\r\n\r\n\r\nfrappe.ui.form.on('Next Cancellation', {\r\n    refresh(frm) {\r\n        console.log(\"Inside refresh function\");\r\n        if (frm.doc.deputyshreiff_bond === 1) {\r\n            console.log(\"deputysheriff_bond\");\r\n            // Pass workflow_state as an argument\r\n            CancelRecords(frm, frm.doc.workflow_state);\r\n        } else {\r\n            console.log(\"deputyshreiff_bond value is not 1\");\r\n        }\r\n    }\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// function CancelRecords(frm, workflow_state) {\r\n//     console.log(\"Inside CancelRecords function\");\r\n//     if (workflow_state === \"Cancelled\") {\r\n//         console.log(\"Workflow state is Cancelled\");\r\n//         frappe.call({\r\n//             method: 'frappe.client.get_list',\r\n//             args: {\r\n//                 doctype: 'Deputy Sheriff Bond',\r\n//                 filters: {\r\n//                     deputysheriff_bond: 1,\r\n//                     bond_holder: frm.doc.name,\r\n//                     workflow_state: ['!=', 'Rejected'],\r\n//                     workflow_state: ['!=', 'Cancelled']\r\n//                 },\r\n//                 fields: ['name']\r\n//             },\r\n//             callback: function(response) {\r\n//                 if (response.message && response.message.length > 0) {\r\n//                     response.message.forEach(function(bond) {\r\n//                         // Set the workflow state to \"Rejected\"\r\n//                         frappe.call('frappe.client.set_value', {\r\n//                             doctype: 'Deputy Sheriff Bond',\r\n//                             name: bond.name,\r\n//                             fieldname: 'workflow_state',\r\n//                             value: 'Rejected'\r\n//                         });\r\n//                         console.log(\"Workflow state changed to Rejected for bond:\", bond.name);\r\n//                     });\r\n//                 } else {\r\n//                     console.log(\"No related records found for cancellation\");\r\n//                 }\r\n//             },\r\n//             error: function(xhr, textStatus, errorThrown) {\r\n//                 console.error(\"Error fetching related records for cancellation:\", textStatus, errorThrown);\r\n//             }\r\n//         });\r\n//     }\r\n// }\r\n\r\n// frappe.ui.form.on('Next Cancellation', {\r\n//     refresh(frm) {\r\n//         console.log(\"Inside refresh function\");\r\n//         if (frm.doc.deputyshreiff_bond === 1) {\r\n//             console.log(\"deputysheriff_bond\");\r\n//             // Pass workflow_state as an argument\r\n//             CancelRecords(frm, frm.doc.workflow_state);\r\n//         } else {\r\n//             console.log(\"deputyshreiff_bond value is not 1\");\r\n//         }\r\n//     }\r\n// });\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "s1",
  "enabled": 1,
  "modified": "2024-05-14 13:21:49.839819",
  "module": "Marketing",
  "name": "script1",
  "script": " frappe.ui.form.on('s1', {\r\n    refresh(frm) {\r\n        // Check if the bond number field is already populated\r\n        if (!frm.doc.number) {\r\n            // Get the current year\r\n            let currentYear = new Date().getFullYear();\r\n            let prefix = `DCL/${currentYear}/`;\r\n\r\n            // Make a call to get the last bond number asynchronously\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 's1',\r\n                    fields: ['number'],\r\n                    limit: 1,\r\n                    order_by: 'creation desc'\r\n                },\r\n                callback: function(response) {\r\n                    let lastNumber = response.message && response.message.length > 0 ? response.message[0].number : '0';\r\n                    let lastNumberInt = parseInt(lastNumber.split(\"/\").pop()); // Extract last part and parse it as integer\r\n\r\n                    // Make a call to get the last deputy sheriff bond number asynchronously\r\n                    frappe.call({\r\n                        method: 'frappe.client.get_list',\r\n                        args: {\r\n                            doctype: 's2',\r\n                            fields: ['number'],\r\n                            limit: 1,\r\n                            order_by: 'creation desc'\r\n                        },\r\n                        callback: function(response) {\r\n                            let lasts2Number = response.message && response.message.length > 0 ? response.message[0].number : '0';\r\n                            let lasts2NoInt = parseInt(lasts2Number.split(\"/\").pop());\r\n\r\n                            // Get the maximum of the two last bond numbers\r\n                            let maxLastNumber = Math.max(lastNumberInt, lasts2NoInt);\r\n\r\n                            if (!isNaN(maxLastNumber)) {\r\n                                // Increment the last number and pad it with leading zeros\r\n                                let newNumber = (maxLastNumber + 1).toString().padStart(4, '0');\r\n                                frm.set_value('number', prefix + newNumber);\r\n                            } else {\r\n                                // If no previous numbers exist, set to default '0001'\r\n                                frm.set_value('number', prefix + '0001');\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Buyer Exposure",
  "enabled": 1,
  "modified": "2025-11-08 18:59:16.385673",
  "module": null,
  "name": "search",
  "script": "frappe.ui.form.on('Buyer Exposure', {\r\n    refresh: function(frm) {   \r\n        frm.set_df_property('respective_policies_and_credit_limits', 'cannot_add_rows', true); \r\n         frm.set_df_property('respective_bond_details','cannot_add_rows', true); \r\n    $(frm.fields_dict['respective_policies_and_credit_limits'].grid.wrapper).find('.btn-grid-delete-row').prop('disabled', true);\r\n        $(frm.fields_dict['respective_bond_details'].grid.wrapper).find('.btn-grid-delete-row').prop('disabled', true);\r\n\r\n        // Apply CSS to hide the Edit button\r\n        var css = `\r\n            .btn-open-row {\r\n                display: none !important;\r\n            }\r\n        `;\r\n        $('<style>' + css + '</style>').appendTo('head');\r\n    },\r\n \r\n    search(frm) {\r\n        frm.trigger('onload');\r\n    },\r\n     \r\n        onload: function(frm) {\r\n        var buyer = frm.doc.buyer;\r\n        var bondholder = frm.doc.bond_holder;\r\n\r\n        // Clear existing data in Bond Details Child table\r\n        frm.clear_table('respective_bond_details');\r\n\r\n        // Fetch data for Bond Details Child\r\n        frm.call({\r\n            method: \"frappe.client.get_list\",\r\n            args: {\r\n                doctype: \"Bond Application\",\r\n                filters: {\r\n                    facility_name: bondholder\r\n                },\r\n                fields: [\"bond_no\", \"bond_in_favour\", \"facility_name\", \"amount_in_pula\", \"period_from\", \"to\"],\r\n                limit_page_length: 0\r\n            },\r\n            callback: function(r) {\r\n                console.log(r, \"hello\");\r\n                var bondData = r.message;\r\n                for (let x of bondData) {\r\n                    var child = frappe.model.add_child(frm.doc, \"Buyer Exposure Bond Details Child\", \"respective_bond_details\");\r\n\r\n                    frappe.model.set_value(child.doctype, child.name, \"bond_no\", x.bond_no);\r\n                    frappe.model.set_value(child.doctype, child.name, \"principal\", x.bond_in_favour);\r\n                    frappe.model.set_value(child.doctype, child.name, \"bond_holder\", x.facility_name);\r\n                    frappe.model.set_value(child.doctype, child.name, \"bond_value\", x.amount_in_pula);\r\n                    frappe.model.set_value(child.doctype, child.name, \"period_from\", x.period_from);\r\n                    frappe.model.set_value(child.doctype, child.name, \"period_to\", x.to);\r\n                }\r\n\r\n                frm.refresh_field(\"respective_bond_details\");\r\n            }\r\n        });\r\n\r\n        // Clear existing data in Credit Limits Child table\r\n        frm.clear_table('respective_policies_and_credit_limits');\r\n\r\n        // Fetch data for Credit Limits Child\r\n      frm.call({\r\n    method: \"frappe.client.get_list\",\r\n    args: {\r\n        doctype: \"Credit Limit Processing\",\r\n        filters: {\r\n            buyer_name: buyer\r\n        },\r\n        fields: [\"policy_no\", \"policy_holder_name\", \"buyer_name\", \"approved_amount\", \"cl_review_date\", \"workflow_state\"],\r\n         limit_page_length: 0\r\n    },\r\n    callback: function(r) {\r\n        console.log(r, \"hello\");\r\n        var creditData = r.message;\r\n        for (let x of creditData) {\r\n            var child = frappe.model.add_child(frm.doc, \"Buyer Exposure Credit Limits Child\", \"respective_policies_and_credit_limits\");\r\n\r\n            frappe.model.set_value(child.doctype, child.name, \"policy_no\", x.policy_no);\r\n            frappe.model.set_value(child.doctype, child.name, \"policy_holder\", x.policy_holder_name);\r\n            frappe.model.set_value(child.doctype, child.name, \"buyer\", x.buyer_name);\r\n            frappe.model.set_value(child.doctype, child.name, \"credit_limit_approved\", x.approved_amount);\r\n            frappe.model.set_value(child.doctype, child.name, \"cl_approved_date\", x.cl_review_date);\r\n            frappe.model.set_value(child.doctype, child.name, \"status\", x.workflow_state); // Setting the workflow_state here\r\n        }\r\n\r\n        frm.refresh_field(\"respective_policies_and_credit_limits\");\r\n    }\r\n});\r\n\r\n\r\n        frm.refresh();\r\n    }\r\n});\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Tax Invoice For CI Invoice",
  "enabled": 0,
  "modified": "2025-11-28 11:23:59.980838",
  "module": "Finance",
  "name": "tax invoice script",
  "script": "frappe.ui.form.on('Tax Invoice For CI Invoice', {\r\n\r\n    refresh: function(frm) {\r\n\r\n        console.log(\"Quotation Number Value:\", frm.doc.quotation_number);\r\n\r\n        if (!frm.doc.quotation_number) {\r\n            frm.set_df_property(\"taxinvoicechildforciinvoice\", \"hidden\", 1);\r\n            frm.clear_table(\"taxinvoicechildforciinvoice\");\r\n            frm.refresh_field(\"taxinvoicechildforciinvoice\");\r\n\r\n            frm.set_df_property(\"tax_child\", \"hidden\", 0);\r\n            frm.refresh_field(\"tax_child\");\r\n        } \r\n        else {\r\n            frm.set_df_property(\"tax_child\", \"hidden\", 0);\r\n            frm.refresh_field(\"tax_child\");\r\n\r\n            frm.set_df_property(\"taxinvoicechildforciinvoice\", \"hidden\", 0);\r\n            frm.refresh_field(\"taxinvoicechildforciinvoice\");\r\n        }\r\n\r\n        // Align fields\r\n        frm.fields_dict.g.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.currency9.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.sub_total.$input.css(\"text-align\", \"right\");\r\n\r\n        frm.set_df_property('tax_child', 'cannot_add_rows', true);\r\n        frm.set_df_property('taxinvoicechildforciinvoice', 'cannot_add_rows', true);\r\n\r\n       // calculate_total_premium(frm);\r\n        calculateADD(frm);\r\n\r\n        // ----------- FETCH CHILD TABLE 1 -----------\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: {\r\n                doctype: \"CI Invoices\",\r\n                filters: {\r\n                    policy_holder: frm.doc.invoice1,\r\n                    invoice_no: frm.doc.invoice2\r\n                }\r\n            },\r\n            callback: function(r) {\r\n\r\n                if (!r.exc && r.message && r.message.export_buyer && r.message.export_buyer.length > 0) {\r\n                    const data = r.message.export_buyer;\r\n\r\n                    frm.clear_table('taxinvoicechildforciinvoice');\r\n\r\n                    data.forEach(x => {\r\n                        var child = frappe.model.add_child(frm.doc,\r\n                            \"TaxInvoicechildforCIInvoice\",\r\n                            \"taxinvoicechildforciinvoice\");\r\n\r\n                        child.country = x.country;\r\n                        child.declaration_amount = x.declamt;\r\n                        child.rate = x.premium_rate;\r\n                        child.premium = x.premamount;\r\n                    });\r\n\r\n                    frm.refresh_field('taxinvoicechildforciinvoice');\r\n                }\r\n            }\r\n        });\r\n\r\n        // ----------- FETCH CHILD TABLE 2 AND SUM ----------\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: {\r\n                doctype: \"CI Invoices\",\r\n                filters: {\r\n                    policy_holder: frm.doc.invoice1,\r\n                    invoice_no: frm.doc.invoice2\r\n                }\r\n            },\r\n            callback: function(r) {\r\n\r\n                if (!r.exc && r.message && r.message.export_invoice && r.message.export_invoice.length > 0) {\r\n                    const data = r.message.export_invoice;\r\n\r\n                    frm.clear_table('tax_child');\r\n\r\n                    let total_amount = 0;\r\n\r\n                    data.forEach(x => {\r\n                        var child = frappe.model.add_child(frm.doc,\r\n                            \"TaxinvoiceChildTable\",\r\n                            \"tax_child\");\r\n\r\n                        child.description = x.description;\r\n                        child.qty = x.qty;\r\n                        child.price = x.price;\r\n                        child.amount = x.amount;\r\n\r\n                        total_amount += parseFloat(x.amount) || 0;\r\n                    });\r\n\r\n                    frm.set_value('g', total_amount.toFixed(2));\r\n                    frm.refresh_field('tax_child');\r\n                }\r\n            }\r\n        });\r\n\r\n        // ----------- FETCH VAT % ----------\r\n        frappe.call({\r\n            method: \"frappe.client.get_value\",\r\n            args: {\r\n                doctype: \"CI Invoices\",\r\n                filters: { invoice_no: frm.doc.invoice2 },\r\n                fieldname: \"vat\"\r\n            },\r\n            callback: function(r) {\r\n                if (r.message) {\r\n                    frm.set_value(\"vat_percentage\", r.message.vat || 0);\r\n                } else {\r\n                    frm.set_value(\"vat_percentage\", 0);\r\n                }\r\n            }\r\n        });\r\n\r\n    },\r\n\r\n    // // // CHILD TABLE TRIGGERS\r\n    // taxinvoicechildforciinvoice_add: function(frm) {\r\n    //     calculate_total_premium(frm);\r\n    // },\r\n\r\n    // taxinvoicechildforciinvoice_remove: function(frm) {\r\n    //     calculate_total_premium(frm);\r\n    // },\r\n\r\n    g: function(frm) {\r\n        calculateADD(frm);\r\n        calculate_total_premium(frm); \r\n    },\r\n\r\n    sub_total: function(frm) {\r\n        calculateADD(frm);\r\n    },\r\n\r\n    onload: function(frm) {\r\n        frm.fields_dict.declaration_amount.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.rate.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.premium.$input.css(\"text-align\", \"right\");\r\n\r\n        frm.set_df_property('tax_child', 'cannot_add_rows', true);\r\n        frm.set_df_property('taxinvoicechildforciinvoice', 'cannot_add_rows', true);\r\n\r\n        frm.fields_dict['g'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n        frm.fields_dict['sub_total'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n        frm.fields_dict['currency9'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n    }\r\n\r\n});\r\n\r\n\r\n// ----------------------- FUNCTIONS -----------------------\r\n\r\n// function calculate_total_premium(frm) {\r\n\r\n//     let g = 0;\r\n\r\n//     if (frm.doc.taxinvoicechildforciinvoice) {\r\n//         frm.doc.taxinvoicechildforciinvoice.forEach(row => {\r\n//             g += parseFloat(row.premium) || 0;\r\n//         });\r\n//     }\r\n\r\n//     g = parseFloat(g);\r\n\r\n//     let vat = parseFloat(frm.doc.vat_percentage) || 0;\r\n\r\n//     let vat_amount = (g * vat) / 100;\r\n//     let subtotal = g + vat_amount;\r\n\r\n//     frm.set_value(\"g\", g.toFixed(2));\r\n//   // frm.set_value(\"vat_amount\", vat_amount.toFixed(2));\r\n//     frm.set_value(\"sub_total\", subtotal.toFixed(2));\r\n\r\n//     frm.refresh_field(\"g\");\r\n//     //frm.refresh_field(\"vat_amount\");\r\n//     frm.refresh_field(\"sub_total\");\r\n// }\r\n\r\nfunction calculate_total_premium(frm) {\r\n\r\n    let g = parseFloat(frm.doc.g) || 0;\r\n    let vat = parseFloat(frm.doc.vat_percentage) || 0;\r\n\r\n    let subtotal = (g * vat) / 100;\r\n\r\n    frm.set_value(\"sub_total\", subtotal.toFixed(2));\r\n    frm.refresh_field(\"sub_total\");\r\n\r\n    console.log(\"g:\", g, \"vat:\", vat, \"subtotal:\", subtotal);\r\n}\r\n\r\n\r\n\r\nfunction calculateADD(frm) {\r\n\r\n    let g = parseFloat(frm.doc.g) || 0;\r\n    let sub_total = parseFloat(frm.doc.sub_total) || 0;\r\n\r\n    let currency9 = g + sub_total;\r\n\r\n    frm.set_value(\"currency9\", currency9.toFixed(2));\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Single Buyer CL Application",
  "enabled": 0,
  "modified": "2025-11-12 10:46:19.496363",
  "module": null,
  "name": "Single Buyer CL Application script",
  "script": "// frappe.ui.form.on('Single Buyer CL Application', {\n//     refresh: function(frm) {\n     \n       \n//       var workflowState = frm.doc.workflow_state;\n \n//         // Create a custom button for \"Print Proposal\" if the workflow state is \"Submitted\"\n//         if (workflowState === \"Approved\") {\n//             frm.add_custom_button(__('Print Annexure'), function() {\n//                 frappe.new_doc('Credit Limit  Annexure')\n//                     frappe.route_options = {\n//                     capture_date: frm.doc.capture_date,\n//                     client1: frm.doc.policy_holder_name,\n//                     policy_no:frm.doc.policy_no,\n//                     cl_check_no: frm.doc.credit_limit_no,\n//                     buyer:frm.doc.buyer_name,\n//                     trading__style: frm.doc.trading__style,\n//                     location: frm.doc.location,\n//                     credit_limit_required: frm.doc.approved_amount,\n//                     types_of_payments: frm.doc.terms_of_payments,\n//                     days_from:frm.doc.days_from,\n//                     conditions: frm.doc.conditions,\n//                     buyer_id: frm.doc.buyer_id\n//                 }\n//                 console.log(\"Print Proposal clicked!\");\n//             }).addClass(\"btn-primary\");\n//         }\n//         frm.fields_dict.financial_analysis.$input.addClass('btn-primary');\n//         frm.fields_dict.director_share_holder_exposure.$input.addClass('btn-primary');\n \n//         // new code\n//         if (frm.doc.yes) {\n//     if (workflowState === \"Pending\" || workflowState === \"Approved\") {\n//         frm.add_custom_button(__('View CB Report'), function() {\n//             frappe.call({\n//                 method: \"frappe.client.get_list\",\n//                 args: {\n//                     doctype: \"CB Report\",\n//                     filters: {\n//                         buyer: frm.doc.buyer_name,\n//                         refnumber: frm.doc.credit_limit_no\n//                     },\n//                     fields: [\"cb_request_number\", \"reqdate\", \"buyer\", \"refnumber\", \"date\", \"catagory\", \"code\", \"details\", \"description\"],\n//                     limit: 1\n//                 },\n//                 callback: function (r) {\n//                     if (r.message && r.message.length > 0) {\n//                         var cbReportData = r.message[0];\n//                         frappe.prompt([\n//                             {'fieldname': 'credit_bureau_request', 'fieldtype': 'Heading', 'label': 'Credit Bureau Request'},\n//                             {'fieldname': 'section_break_2','fieldtype': 'Section Break','label': ''},\n//                             {'fieldname': 'cb_request_number', 'fieldtype': 'Data', 'label': 'CB Req Number', 'default': cbReportData.cb_request_number},\n//                             {'fieldname': 'reqdate', 'fieldtype': 'Date', 'label': 'Req.Date', 'default': cbReportData.reqdate},\n//                             {'fieldname': 'buyer', 'fieldtype': 'Data', 'label': 'Buyer', 'default': cbReportData.buyer},\n//                             {'fieldname': 'column_break_1','fieldtype': 'Column Break','label': ''},\n//                             {'fieldname': 'refnumber', 'fieldtype': 'Data', 'label': 'Ref.Number','default': cbReportData.refnumber},\n//                             {'fieldname': 'section_break_4','fieldtype': 'Section Break','label': ''},\n//                             {'fieldname': 'credit_bureau_responce', 'fieldtype': 'Heading', 'label': 'Credit Bureau Response'},\n//                             {'fieldname': 'section_break_5','fieldtype': 'Section Break','label': ''},\n//                             {'fieldname': 'date', 'fieldtype': 'Date', 'label': 'Date', 'default': cbReportData.date},\n//                             {'fieldname': 'catagory', 'fieldtype': 'Data', 'label': 'Category', 'default': cbReportData.catagory},\n//                             {'fieldname': 'code', 'fieldtype': 'Data', 'label': 'Code',  'default': cbReportData.code},\n//                             {'fieldname': 'column_break_2','fieldtype': 'Column Break','label': ''},\n//                             {'fieldname': 'details', 'fieldtype': 'Data', 'label': 'Details',  'default': cbReportData.details},\n//                             {'fieldname': 'description', 'fieldtype': 'Small Text', 'label': 'Description', 'default': cbReportData.description},\n//                         ], function(values){}, 'CB Report');\n//                     } else {\n//                         frappe.msgprint(`CB Report not found for Buyer <b>${frm.doc.buyer_name}</b> and Credit Limit Number <b>${frm.doc.credit_limit_no}</b>.`);\n//                     }\n//                 }\n//             });\n//         }).addClass(\"btn-primary\");\n//     }\n// }\n\n\n\n// e\n      \n//         if(frm.doc.yes){\n//         if (workflowState === \"Pending\" || workflowState === \"Approved\") {\n//             frm.toggle_display('cbreport', true);\n//             frm.toggle_display('report', false);\n//             frm.toggle_display('cb_request', false);\n//             // frm.toggle_display('table', false);\n \n//         }\n//         }\n \n//           if (workflowState === \"Approved\") {// || workflowState === \"Pending\" || workflowState === \"Draft\") {\n//              frm.toggle_display('policy_number', true);\n//              frm.toggle_display('policy_no', false);\n            \n//         //     frm.toggle_display('credit_number', true);\n//         //     frm.toggle_display('credit_limit_no', false); \n\n//          }\n        \n        \n        \n//          frm.fields_dict.credit_limit.$input.css(\"text-align\", \"right\");\n//       frm.fields_dict.overdue_amount.$input.css(\"text-align\", \"right\");\n//       frm.fields_dict.outstanding_amount.$input.css(\"text-align\", \"right\");\n//       frm.fields_dict.total_exposure.$input.css(\"text-align\", \"right\");\n//       frm.fields_dict.recommended_exposure.$input.css(\"text-align\", \"right\");\n \n    \n//     }\n    \n// });\n// \n// \n// \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nfrappe.ui.form.on('Single Buyer CL Application', {\n\n  refresh: function(frm) {\n      alignFieldsRight(frm, fieldsToAlignRight);\n  \n    frm.fields_dict.new.$input.addClass('btn-primary');\n    frm.fields_dict['new'].$wrapper.find('button').on('click', function() {\n        frappe.new_doc('Buyer');\n\n        \n    });\n\n    // Call additional functions\n    generateNumber(frm);\n    \n    \n\n    // Fetch options for 'buyer' field (DCI buyers)\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Buyer',\n            filters: {'dci': 1}, // Assuming 'dci' identifies DCI buyers\n            fields: ['buyer_name'],\n             limit_page_length: 0 \n        },\n        callback: function(response) {\n            var dci_buyers = response.message;\n            var options = dci_buyers.map(buyer => buyer.buyer_name);\n            frm.set_df_property('buyer1', 'options', options);\n        }\n    });\n    \n    \n    \n\n\n\n    // Fetch options for 'buyer1' field (ECI buyers)\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Buyer',\n            filters: {'eci': 1}, // Assuming 'eci' identifies ECI buyers\n            fields: ['buyer_name'],\n             limit_page_length: 10000000 \n        },\n        callback: function(response) {\n            var eci_buyers = response.message;\n            var options = eci_buyers.map(buyer => buyer.buyer_name);\n            frm.set_df_property('buyer', 'options', options);\n        }\n    });\n},\n\n\n  onload: function(frm) {\n        frappe.call({\n    method: 'frappe.client.get_list',\n    args: {\n        doctype: 'Follow UP',\n        fields: ['client_name'],\n        limit_page_length: 100000\n    },\n    callback: function(response) {\n     console.log('Buyer selected:', response);\n\n        if (response.message) {\n            let uniqueClients = [...new Set(response.message.map(item => item.client_name))];\n            frm.set_df_property('client1', 'options', uniqueClients.join('\\n'));\n        }\n    }\n});\n          alignFieldsRight(frm, fieldsToAlignRight);\n\n},\n    \n    // buyer1: function(frm) {\n    //     var BuyerName = frm.doc.buyer1;\n    //     console.log('Buyer selected:', BuyerName);\n\n    //     if (BuyerName && BuyerName.trim() !== '') {\n    //         frappe.call({\n    //             method: 'frappe.client.get_list',\n    //             args: {\n    //                 doctype: 'Buyer',\n    //                 filters: {\n    //                     buyer_name: BuyerName\n    //                 },\n    //                 fields: ['buyer_id', 'trading_name', 'registration_no', 'tel_no1', 'bank', 'branch', 'director_1',\n    //                          'director_2', 'director_3', 'director_4', 'physical_address', 'location2', 'fax', 'ac_no']\n    //             },\n    //             callback: function(response) {\n    //                 if (response.message && response.message.length > 0) {\n    //                     var data = response.message[0];\n\n    //                     // Populate fields if data is found\n    //                     frm.set_value('buyer_short_name1', data.buyer_id || '');\n    //                     frm.set_value('trading_style1', data.trading_name || '');\n    //                     frm.set_value('regno__id_no1', data.registration_no || '');\n    //                     frm.set_value('tel_no1', data.tel_no1 || '');\n    //                     frm.set_value('bank1', data.bank || '');\n    //                     frm.set_value('branch1', data.branch || '');\n    //                     frm.set_value('1_director_1', data.director_1 || '');\n    //                     frm.set_value('2_director2', data.director_2 || '');\n    //                     frm.set_value('3_director_3', data.director_3 || '');\n    //                     frm.set_value('4_director4', data.director_4 || '');\n    //                     frm.set_value('1_address1', data.physical_address || '');\n    //                     frm.set_value('fax_no1', data.fax || '');\n    //                     frm.set_value('account_no1', data.ac_no || '');\n    //                     frm.set_value('2_address2', data.location2 || '');\n    //                 } else {\n    //                     // Clear fields if no matching record found\n    //                     frm.set_value('buyer_short_name1', '');\n    //                     frm.set_value('trading_style1', '');\n    //                     frm.set_value('regno__id_no1', '');\n    //                     frm.set_value('tel_no1', '');\n    //                     frm.set_value('bank1', '');\n    //                     frm.set_value('branch1', '');\n    //                     frm.set_value('1_director_1', '');\n    //                     frm.set_value('2_director2', '');\n    //                     frm.set_value('3_director_3', '');\n    //                     frm.set_value('4_director4', '');\n    //                     frm.set_value('1_address1', '');\n    //                     frm.set_value('fax_no1', '');\n    //                     frm.set_value('account_no1', '');\n    //                     frm.set_value('2_address2', '');\n\n    //                     frappe.msgprint('No matching record found.');\n    //                 }\n    //             },\n    //             error: function(err) {\n    //                 console.error(err);\n    //                 frappe.msgprint('An error occurred while fetching data');\n    //             }\n    //         });\n    //     } else {\n    //         // Handle case where 'buyer1' field is empty or not valid\n    //         frappe.msgprint('Error occurred.');\n    //     }\n    // },\n     buyer: function(frm) {\n        var BuyerName = frm.doc.buyer;\n        console.log('Buyer selected:', BuyerName);\n\n        if (BuyerName && BuyerName.trim() !== '') {\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Buyer',\n                    filters: {\n                        buyer_name: BuyerName\n                    },\n                    fields: ['buyer_id', 'trading_name', 'registration_no', 'tel_no1', 'bank', 'branch', 'director_1',\n                             'director_2', 'director_3', 'director_4', 'physical_address', 'location2', 'fax', 'ac_no']\n                },\n                callback: function(response) {\n                    if (response.message && response.message.length > 0) {\n                        var data_from_proposals = response.message[0];\n\n                        // Populate fields if data is found\n                        frm.set_value('buyer_short_name', data_from_proposals.buyer_id || '');\n                        frm.set_value('trading_style', data_from_proposals.trading_name || '');\n                        frm.set_value('regno__id_no', data_from_proposals.registration_no || '');\n//                         frm.set_value('tel_no', data_from_proposals.tel_no1 || '');\n                        frm.set_value('bank', data_from_proposals.bank || '');\n                        frm.set_value('branch', data_from_proposals.branch || '');\n                        frm.set_value('director_1', data_from_proposals.director_1 || '');\n                        frm.set_value('director2', data_from_proposals.director_2 || '');\n                        frm.set_value('director_3', data_from_proposals.director_3 || '');\n                        frm.set_value('director4', data_from_proposals.director_4 || '');\n                        frm.set_value('address1', data_from_proposals.physical_address || '');\n                        frm.set_value('fax_no', data_from_proposals.fax || '');\n                        frm.set_value('account_no', data_from_proposals.ac_no || '');\n                        frm.set_value('address2', data_from_proposals.location2 || '');\n                    } else {\n                        // Clear fields if no matching record found\n                        frm.set_value('buyer_short_name', '');\n                        frm.set_value('trading_style', '');\n                        frm.set_value('regno__id_no', '');\n                        frm.set_value('tel_no', '');\n                        frm.set_value('bank', '');\n                        frm.set_value('branch', '');\n                        frm.set_value('director_1', '');\n                        frm.set_value('director2', '');\n                        frm.set_value('director_3', '');\n                        frm.set_value('director4', '');\n                        frm.set_value('address1', '');\n                        frm.set_value('fax_no', '');\n                        frm.set_value('account_no', '');\n                        frm.set_value('address2', '');\n\n                        frappe.msgprint('No matching record found.');\n                    }\n                },\n                error: function(err) {\n                    console.error(err);\n                    frappe.msgprint('An error occurred while fetching data');\n                }\n            });\n        } else {\n            // Handle case where 'buyer' field is empty or not valid\n            frappe.msgprint('Error occurred.');\n        }\n    }\n\n\n\n});\n\n\n \nfunction generateNumber(frm) {\n    if (!frm.doc.credit_limit_no) {\n        let currentYear = new Date().getFullYear();\n        let prefix = `CLC/${currentYear}/`;\n\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Single Buyer CL Application',\n                fields: ['credit_limit_no', 'creation'],\n                order_by: 'creation desc',\n                limit: 1\n            },\n            callback: function(r) {\n                if (!r.exc) {\n                    if (r.message && r.message.length > 0) {\n                        let lastCreditLimitNo = r.message[0].credit_limit_no;\n                        let lastNumber = parseInt(lastCreditLimitNo.split(\"/\").pop()) || 0;\n                        let newNumber = (lastNumber + 1).toString().padStart(4, '0');\n                        frm.set_value('credit_limit_no', prefix + newNumber);\n                    } else {\n                        frm.set_value('credit_limit_no', prefix + '0001');\n                    }\n                } else {\n                    frappe.msgprint(\"Error occurred while fetching data.\");\n                }\n            }\n        });\n    }\n}\n\n\n// List of fields to align to the right\nlet fieldsToAlignRight = [\n    'credit_limit_required','credit_limit_required1','regno__id_no','regno__id_no1','fax_no','fax_no1','account_no','account_no1'\n];\n\n// Function to align fields to the right\nfunction alignFieldsRight(frm, fields) {\n    fields.forEach(field => {\n        let fieldElement = frm.fields_dict[field];\n        if (fieldElement && fieldElement.input) {\n            fieldElement.input.style.direction = 'rtl'; // Setting direction to right-to-left\n            fieldElement.input.style.textAlign = 'right'; // Aligning text to the right\n        }\n    });\n}\n\n// Bind onload event for each field in fieldsToAlignRight\nfieldsToAlignRight.forEach(field => {\n    frappe.ui.form.on('Single Buyer CL Application', field, function(frm) {\n        alignFieldsRight(frm, [field]); // Call alignFieldsRight function for each field\n    });\n});\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "CI Invoices",
  "enabled": 0,
  "modified": "2025-12-01 19:31:45.843221",
  "module": "Finance",
  "name": "Ci Invoice full script",
  "script": "frappe.ui.form.on('CI Invoices', {\r\n   tax_invoice: function(frm) {\r\n\r\n    // 1\ufe0f\u20e3 First fetch Company Details\r\n    frappe.call({\r\n        method: \"frappe.client.get_value\",\r\n        args: {\r\n            doctype: \"Company-Details\",\r\n            fieldname: [\r\n                \"telephone\",\r\n                \"fax\",\r\n                \"postal_address\",\r\n                \"location\",\r\n                \"contact_person\",\r\n                \"vat_reg_no\",\r\n                \"country\"\r\n            ],\r\n            filters: { name: frm.doc.policy_holder }\r\n        },\r\n\r\n        callback: function(r1) {\r\n            if (!r1.message) {\r\n                frappe.msgprint(\"Company Details not found!\");\r\n                return;\r\n            }\r\n\r\n            // Extract Company Details\r\n            let telephone = r1.message.telephone;\r\n            let fax = r1.message.fax;\r\n            let postal_address = r1.message.postal_address;\r\n            let location = r1.message.location;\r\n            let contact_person = r1.message.contact_person;\r\n            let vat_reg_no = r1.message.vat_reg_no;\r\n            let country = r1.message.country;\r\n\r\n            // 2\ufe0f\u20e3 Fetch Policy Number Next\r\n            frappe.call({\r\n                method: \"frappe.client.get_value\",\r\n                args: {\r\n                    doctype: \"Policy Approvals\",\r\n                    fieldname: [\"policy_number\"],\r\n                    filters: { policy_holder: frm.doc.policy_holder }\r\n                },\r\n\r\n                callback: function(r2) {\r\n                    let policy_number = r2.message?.policy_number || \"\";\r\n\r\n                    // 3\ufe0f\u20e3 Set route options AFTER fetching all data\r\n                    frappe.route_options = {\r\n                        invoice1: frm.doc.policy_holder,\r\n                        date1: frm.doc.invoice_date,\r\n                        invoice2: frm.doc.invoice_no,\r\n                        sub_total: frm.doc.vat,\r\n                        month: frm.doc.month,\r\n                        quotation_number :frm.doc.quotation_number,\r\n\r\n                        // Company Details\r\n                        telephone: telephone,\r\n                        fax: fax,\r\n                        address: postal_address,\r\n                        city: location,\r\n                        attn: contact_person,\r\n                        vat: vat_reg_no,\r\n                        country: country,\r\n\r\n                        // Policy Number\r\n                        reference1: policy_number\r\n                    };\r\n\r\n                    // 4\ufe0f\u20e3 Finally route to new Doc\r\n                    frappe.new_doc(\"Tax Invoice For CI Invoice\");\r\n                }\r\n            });\r\n        }\r\n    });\r\n    \r\n},\r\n\r\n    \r\n   internal_invoice: function (frm) {\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_value',\r\n        args: {\r\n            doctype: 'Company-Details',\r\n            fieldname: ['postal_address', 'location', 'vat_reg_no'],\r\n            filters: { name: frm.doc.policy_holder }\r\n        },\r\n\r\n        callback: function (r) {\r\n\r\n            if (!r.message) {\r\n                frappe.msgprint(__('Company details not found for the selected Policy Holder.'));\r\n                return;\r\n            }\r\n\r\n            // Route options for main fields\r\n            frappe.route_options = {\r\n                name1: frm.doc.policy_holder,\r\n                 invoice_no: frm.doc.invoice_no,\r\n                 quotation_number:frm.doc.quotation_number,\r\n                date: frm.doc.invoice_date,\r\n                address: r.message.postal_address,\r\n                city: r.message.location,\r\n                vat: r.message.vat_reg_no\r\n            };\r\n\r\n            // Create new Internal Invoice\r\n            frappe.new_doc('Internal Invoice for CI Invoice');\r\n\r\n            // No child table rows added for now\r\n        }\r\n    });\r\n\r\n},\r\n    \r\n     with_out_vat: function(frm) {\r\n        // Check if 'With Out Vat' checkbox is selected\r\n        if (frm.doc.with_out_vat) {\r\n            // Get the current invoice amount and VAT amount\r\n            var invoice_amount = frm.doc.invoice_amount;\r\n            var vat = frm.doc.vat;\r\n\r\n            // Calculate the invoice amount without VAT\r\n            var invoice_amount_without_vat = invoice_amount - vat;\r\n\r\n            // Set the calculated value in the 'invoice_amount_without_vat' field\r\n            frm.set_value('invoice_amount_without_vat', invoice_amount_without_vat);\r\n        } else {\r\n            // If 'With Out Vat' is not checked, clear the 'invoice_amount_without_vat' field\r\n            frm.set_value('invoice_amount_without_vat', null);\r\n        }\r\n    },\r\n    \r\n     refresh: function(frm) {\r\n          frm.fields_dict['invoice_amount'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n          frm.fields_dict['invoice_amount_without_vat'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n          frm.fields_dict['vat'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n          frm.set_df_property('export_buyer','cannot_add_rows', true); \r\n          frm.set_df_property('export_invoice','cannot_add_rows', true); \r\n          frm.fields_dict.tax_invoice.$input.addClass('btn-primary');\r\n          frm.fields_dict.internal_invoice.$input.addClass('btn-primary');\r\n\r\n          var exportBuyerRows = frm.doc.export_buyer || [];\r\n        if (exportBuyerRows.length > 0) {\r\n            // Show the export_buyer child table if there are rows\r\n            frm.fields_dict['export_buyer'].grid.wrapper.show();\r\n        } else {\r\n            // Hide the export_buyer child table if there are no rows\r\n            frm.fields_dict['export_buyer'].grid.wrapper.hide();\r\n        }\r\n\r\n        // Check if export_invoice table has any rows\r\n        var exportInvoiceRows = frm.doc.export_invoice || [];\r\n        if (exportInvoiceRows.length > 0) {\r\n            // Show the export_invoice child table if there are rows\r\n            frm.fields_dict['export_invoice'].grid.wrapper.show();\r\n        } else {\r\n            // Hide the export_invoice child table if there are no rows\r\n            frm.fields_dict['export_invoice'].grid.wrapper.hide();\r\n        }\r\n        \r\n          if (frm.is_new()) {\r\n        // New form \u2192 show save button\r\n        frm.page.btn_primary.show();\r\n    } else {\r\n        // Saved form \u2192 hide save button\r\n        frm.page.btn_primary.hide();\r\n    }\r\n     }\r\n     \r\n     \r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Covering letter_CIGIS",
  "enabled": 1,
  "modified": "2025-08-04 08:30:10.885460",
  "module": null,
  "name": "Covering letter_CIGIS script",
  "script": "frappe.ui.form.on('Covering letter_CIGIS', {\r\n    onload_post_render(frm) {\r\n        let name1 = frm.doc.attention_mr;\r\n\r\n        if (!name1) {\r\n            frappe.msgprint(\"Client name is empty.\");\r\n            return;\r\n        }\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Company-Details',\r\n                filters: {\r\n                    'name1': name1\r\n                },\r\n                fields: ['postal_address', 'location'],\r\n                limit: 1\r\n            },\r\n            callback: function(res) {\r\n                if (res.message && res.message.length > 0) {\r\n                    let data = res.message[0];\r\n\r\n                    if (frm.doc.postal_address !== data.postal_address) {\r\n                        frm.set_value('postal_address', data.postal_address);\r\n                    }\r\n\r\n                    if (frm.doc.location !== data.location) {\r\n                        frm.set_value('location', data.location);\r\n                    }\r\n                } else {\r\n                    frappe.msgprint(\"No matching Company Details found for: \" + name1);\r\n                }\r\n            }\r\n        });\r\n    }\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n/*frappe.ui.form.on('Covering letter_CIGIS', {\r\n    refresh(frm) {\r\n        // Get the value of name1 field\r\n        var name1 = frm.doc.name1;\r\n\r\n        // Fetch Company Details document where attention_mr matches name1\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Company-Details',\r\n                filters: {\r\n                    'attention_mr': name1\r\n                },\r\n                fields: ['postal_address'],\r\n                limit: 1 // Limit to fetch only one document\r\n            },\r\n            callback: function(response) {\r\n                if (response.message && response.message.length > 0) {\r\n                    // Set the postal_address field in Covering letter_CIGIS document\r\n                    frm.set_value('postal_address', response.message[0].postal_address);\r\n                } else {\r\n                    // Handle case where no matching Company Details document is found\r\n                    frappe.msgprint(\"No matching Company Details found for attention_mr: \" + name1);\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error(err);\r\n                frappe.msgprint('An error occurred while fetching Company Details.');\r\n            }\r\n        });\r\n    }\r\n});\r\n*/",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "New_Policy_Doc",
  "enabled": 1,
  "modified": "2025-08-04 08:35:05.239980",
  "module": null,
  "name": "New_Policy_Doc script",
  "script": "frappe.ui.form.on('New_Policy_Doc', {\r\n    refresh(frm) {\r\n        // Get the value of name1 field\r\n        var name1 = frm.doc.to;\r\n\r\n        // Fetch Company Details document where the 'to' field matches name1\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Company-Details',\r\n                filters: {\r\n                    'name1': name1\r\n                },\r\n                fields: ['postal_address'],\r\n                limit: 1 // Limit to fetch only one document\r\n            },\r\n            callback: function(response) {\r\n                if (response.message && response.message.length > 0) {\r\n                    frm.set_value('of', response.message[0].postal_address);\r\n                } else {\r\n                    // Handle case where no matching Company Details document is found\r\n                    frappe.msgprint(\"No matching Company Details found for: \" + name1);\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error(err);\r\n                frappe.msgprint('An error occurred while fetching Company Details.');\r\n            }\r\n        });\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Consent Form For ECIS",
  "enabled": 1,
  "modified": "2024-07-03 13:45:03.070597",
  "module": null,
  "name": "Consent Form For ECIS script",
  "script": "frappe.ui.form.on('Consent Form For ECIS', {\n    refresh(frm) {\n        // Get the value of name1 field\n        var name1 = frm.doc.name1;\n\n        // Fetch Company Details document where the 'to' field matches name1\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Company-Details',\n                filters: {\n                    'to': name1\n                },\n                fields: ['postal_address'],\n                limit: 1 // Limit to fetch only one document\n            },\n            callback: function(response) {\n                if (response.message && response.message.length > 0) {\n                    // Set the postal_address field to the of field in New_Policy_Doc document\n                    frm.set_value('of', response.message[0].postal_address);\n                } else {\n                    // Handle case where no matching Company Details document is found\n                    frappe.msgprint(\"No matching Company Details found for: \" + name1);\n                }\n            },\n            error: function(err) {\n                console.error(err);\n                frappe.msgprint('An error occurred while fetching Company Details.');\n            }\n        });\n    },\n    onload:function(frm){\n         frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Company-Details', // corrected doctype name\n                filters: {\n                    name1: frm.doc.company_name // corrected field name\n                },\n                fields: ['bank', 'ac_no', 'branch', 'contact_person']\n            },\n            callback: function(r) {\n                console.log(r, 'hello'); // corrected console.log syntax\n                if (!r.exc) {\n                    if (r.message && r.message.length > 0) {\n                        var data = r.message[0]; \n                        frm.set_value('bank', data.bank);\n                        frm.set_value('account_number', data.ac_no); // corrected field name\n                        frm.set_value('branch', data.branch);\n                       // frm.set_value('to_', data.contact_person);\n                        \n                    } else {\n                        console.error(\"No data found for the selected company.\");\n                    }\n                } else {\n                    console.error(\"Error occurred:\", r.exc);\n                }\n            }\n        });\n        \n         frappe.call({\n    method: 'frappe.client.get_list',\n    args: {\n        doctype: 'ECI Proposal', // corrected doctype name\n        filters: {\n            proposal_no: frm.doc.proposal_no // corrected field name\n        },\n        fields: ['capacity']\n    },\n    callback: function(r) {\n        console.log(r, 'hello'); // corrected console.log syntax\n        if (!r.exc) {\n            if (r.message && r.message.length > 0) {\n                var data = r.message[0]; \n                frm.set_value('designation', data.capacity); // corrected field name\n            } else {\n                console.error(\"No data found for the selected company.\");\n            }\n        } else {\n            console.error(\"Error occurred:\", r.exc);\n        }\n    }\n});\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Covering Letters",
  "enabled": 1,
  "modified": "2024-05-23 09:07:15.424802",
  "module": null,
  "name": "Retrieve Company-details",
  "script": "frappe.ui.form.on('Covering Letters', {\r\n    refresh(frm) {\r\n        // Get the value of name1 field\r\n        var companyname = frm.doc.company;\r\n\r\n        // Fetch Company Details document where the 'name1' field matches companyname\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Company-Details',\r\n                filters: {\r\n                    'name1': companyname\r\n                },\r\n                fields: ['name1', 'postal_address'],\r\n                limit: 1 // Limit to fetch only one document\r\n            },\r\n            callback: function(response) {\r\n                if (response.message && response.message.length > 0) {\r\n                    var companyDetails = response.message[0];\r\n                    // Set the company and companyname fields in covering letters\r\n                  //  frm.set_value('company', companyDetails.name1);\r\n                    frm.set_value('companyname', companyDetails.name1);\r\n                    // Set the address field in covering letters\r\n                    frm.set_value('address', companyDetails.postal_address);\r\n                } else {\r\n                    // Handle case where no matching Company Details document is found\r\n                    frappe.msgprint(\"No matching Company Details found for: \" + company);\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error(err);\r\n                frappe.msgprint('An error occurred while fetching Company Details.');\r\n            }\r\n        });\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "ECI Print Proposals",
  "enabled": 0,
  "modified": "2025-09-29 08:58:32.169595",
  "module": "Marketing",
  "name": "print data",
  "script": "frappe.ui.form.on('ECI Print proposals', {\r\n    onload: function (frm) {\r\n        // frm.fields_dict['principal_buyer_table'].grid.wrapper.find('.grid-row .btn[data-fieldname=\"edit\"]').hide();\r\n        \r\n        frm.set_df_property('print_child_table','cannot_add_rows', true);\r\n        frm.set_df_property('spread_of_turnover_eci','cannot_add_rows', true);\r\n        frm.set_df_property('past_experiences','cannot_add_rows', true);\r\n        frm.set_df_property('principal_buyer_table','cannot_add_rows', true);\r\n        \r\n        // Client details\r\n        frappe.call({\r\n            method: 'frappe.client.get',\r\n            args: {\r\n                doctype: 'Company-Details',\r\n                name: frm.doc.client_name\r\n            },\r\n            callback: function (r) {\r\n                console.log(r, \"client details\");\r\n\r\n                if (r.message) {\r\n                   frm.set_value('postal_address', r.message.postal_address);\r\n                    frm.set_value('physical_address', r.message.physical_address);\r\n                    frm.set_value('fax_number', r.message.fax);\r\n                    frm.set_value('registered_no', r.message.registration_number);\r\n                    frm.set_value('date_established', r.message.establisheddate);\r\n                    frm.set_value('bankers_branch', r.message.bank);\r\n                    frm.set_value('telephone_number', r.message.telephone);\r\n                    frm.set_value('account_number', r.message.ac_no);\r\n                    frm.set_value('email', r.message.email);\r\n                     frm.set_value('name1', r.message.contact_person);\r\n                    \r\n\r\n                    // Refresh the form to reflect the changes\r\n                    frm.refresh();\r\n                } else {\r\n                    console.error(\"Error occurred in client details:\", r.exc);\r\n                }\r\n            }\r\n        });\r\n// Fetch trade style data\r\n      frappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'ECI Proposal',\r\n        filters: {\r\n            client_name: frm.doc.client_name\r\n        },\r\n        fields: ['associated_companies', 'government', 'private_buyers'],\r\n        limit_page_length: 1 // Limit to one result for efficiency\r\n    },\r\n    callback: function(response) {\r\n        console.log(response, \"response\");\r\n\r\n        if (response.message && response.message.length > 0) {\r\n            var data_from_proposals = response.message[0];\r\n            console.log(data_from_proposals, \"data_from_proposals\");\r\n            var trade_style = [];\r\n\r\n            if (data_from_proposals.associated_companies) {\r\n                trade_style.push('Associated Companies');\r\n            }\r\n            if (data_from_proposals.government) {\r\n                trade_style.push('Government');\r\n            }\r\n            if (data_from_proposals.private_buyers) {\r\n                trade_style.push('Private Buyers');\r\n            }\r\n            \r\n            \r\n\r\n            frm.set_value('trade_style', trade_style.join(', '));\r\n        } else {\r\n            frm.set_value('trade_style', ''); // Ensure 'trade_style' is cleared if no data is found\r\n        }\r\n    },\r\n    error: function(error) {\r\n        console.error(\"Error in frappe.call:\", error);\r\n        frm.set_value('trade_style', ''); // Clear the field in case of an error\r\n    }\r\n});\r\n\r\n        // Fetch ECI Proposal data\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: {\r\n                doctype: \"ECI Proposal\",\r\n                filters: {\r\n                    client_name: frm.doc.client_name\r\n                },\r\n                fields: [\"directors_shareholders_table\", \"export_turnover\", \"principal_buyer\", \"baddebts\",\"capacity\",\"captured_on\"]\r\n            },\r\n            callback: function (r) {\r\n                console.log(r, \"ECI Proposals data\");\r\n                if (!r.exc) {\r\n\r\n                    if (r.message) {\r\n\r\n                        frm.set_value('date', r.message.captured_on);\r\n                         frm.set_value('capacity', r.message.capacity);\r\n\r\n                    }\r\n                }\r\n\r\n                if (r.message) {\r\n                    // Directors Shareholders Table\r\n                    if (r.message.directors_shareholders_table) {\r\n                        var data = r.message.directors_shareholders_table;\r\n\r\n                        // Clear the child table before adding new rows\r\n                        frm.clear_table('print_child_table');\r\n\r\n                        for (let x of data) {\r\n                            var child = frappe.model.add_child(frm.doc, \"Print Child\", \"print_child_table\");\r\n                            frappe.model.set_value(child.doctype, child.name, \"designation\", x.designation);\r\n                            frappe.model.set_value(child.doctype, child.name, \"share_holder\", x.directorname);\r\n\r\n                            // Add more fields as needed\r\n                        }\r\n\r\n                        frm.refresh_fields('print_child_table');\r\n                        console.log(data);\r\n                    }\r\n\r\n                    // Export Turnover\r\n                    if (r.message.export_turnover) {\r\n                        var data1 = r.message.export_turnover;\r\n\r\n                        // Clear the child table before adding new rows\r\n                        frm.clear_table('spread_of_turnover_eci');\r\n\r\n                        for (let x of data1) {\r\n                            var child1 = frappe.model.add_child(frm.doc, \"Spread_of_turnover_ECI\", \"spread_of_turnover_eci\");\r\n                            frappe.model.set_value(child1.doctype, child1.name, \"countries_of_destination\", x.country_of_dest);\r\n                            frappe.model.set_value(child1.doctype, child1.name, \"total_turnover_during_last\", x.total_turnoverlast_year);\r\n                            frappe.model.set_value(child1.doctype, child1.name, \"estimated_turnover_next_last_year\", x.estturnovernext_12_months);\r\n                            frappe.model.set_value(child1.doctype, child1.name, \"currency_invoiced_in_egpularandusd\", x.currency_invoiced_eg_pularandsusd);\r\n                            frappe.model.set_value(child1.doctype, child1.name, \"terms_of_payments_normal\", x.terms_of_payment);\r\n                            frappe.model.set_value(child1.doctype, child1.name, \"terms_of_payments_maximum\", x.directorname);\r\n\r\n                            // Add more fields as needed\r\n                        }\r\n\r\n                        frm.refresh_fields('spread_of_turnover_eci');\r\n                        console.log(data1);\r\n                    }\r\n\r\n                    // Principal Buyer\r\n                    if (r.message.principal_buyer) {\r\n                        var data2 = r.message.principal_buyer;\r\n\r\n                        // Clear the child table before adding new rows\r\n                        frm.clear_table('principal_buyer_table');\r\n\r\n                        for (let x of data2) {\r\n                            var child2 = frappe.model.add_child(frm.doc, \"ECI_Principal_buyer_table\", \"principal_buyer_table\");\r\n                            frappe.model.set_value(child2.doctype, child2.name, \"name_of_the_buyer\", x.buyer_name);\r\n                            frappe.model.set_value(child2.doctype, child2.name, \"bank\", x.bank);\r\n                            frappe.model.set_value(child2.doctype, child2.name, \"town_and_country\", x.buyer_country);\r\n                            frappe.model.set_value(child2.doctype, child2.name, \"maximum_amount_outstanding_pula\", x.amount_outstanding);\r\n\r\n                            // Add more fields as needed\r\n                        }\r\n\r\n                        frm.refresh_fields('principal_buyer_table');\r\n                        console.log(data2);\r\n                    }\r\n\r\n                    // Bad Debts\r\n                    if (r.message.baddebts) {\r\n                        var data3 = r.message.baddebts;\r\n\r\n                        // Clear the child table before adding new rows\r\n                        frm.clear_table('past_experiences');\r\n\r\n                        for (let x of data3) {\r\n                            var child3 = frappe.model.add_child(frm.doc, \"ECI_Past_experience\", \"past_experiences\");\r\n                            frappe.model.set_value(child3.doctype, child3.name, \"name_of_the_country\", x.country);\r\n                            frappe.model.set_value(child3.doctype, child3.name, \"noof_cases\", x.noof_cases);\r\n                            frappe.model.set_value(child3.doctype, child3.name, \"year1\", x.year1);\r\n                            frappe.model.set_value(child3.doctype, child3.name, \"year2\", x.year2);\r\n                            frappe.model.set_value(child3.doctype, child3.name, \"year3\", x.year3);\r\n                            frappe.model.set_value(child3.doctype, child3.name, \"estimated\", x.estimated);\r\n\r\n                            // Add more fields as needed\r\n                        }\r\n\r\n                        frm.refresh_fields('past_experiences');\r\n                        console.log(data3);\r\n                    }\r\n                } else {\r\n                    console.error(\"Error occurred in ECI Proposals data:\", r.exc);\r\n                }\r\n            }\r\n        });\r\n    },\r\n   \r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Specimen Policy Documents",
  "enabled": 1,
  "modified": "2024-07-04 06:42:15.283403",
  "module": null,
  "name": "Of Data",
  "script": "frappe.ui.form.on('Specimen Policy Documents', {\n    refresh(frm) {\n        // Get the value of name1 field\n        var name1 = frm.doc.to;\n \n        // Fetch Company Details document where the 'to' field matches name1\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Company-Details',\n                filters: {\n                    'name1': name1\n                },\n                fields: ['postal_address'],\n                limit: 1 // Limit to fetch only one document\n            },\n            callback: function(response) {\n                if (response.message && response.message.length > 0) {\n                    // Set the postal_address field to the of field in New_Policy_Doc document\n                    frm.set_value('of', response.message[0].postal_address);\n                } else {\n                    // Handle case where no matching Company Details document is found\n                    frappe.msgprint(\"No matching Company Details found for: \" + name1);\n                }\n            },\n            error: function(err) {\n                console.error(err);\n                frappe.msgprint('An error occurred while fetching Company Details.');\n            }\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Rejection Letter",
  "enabled": 0,
  "modified": "2025-10-30 12:06:58.356075",
  "module": "Marketing",
  "name": "Reject the letter",
  "script": "frappe.ui.form.on('Rejection_Letter_1', {\n    \n    \n    client: function(frm) {\n        \n        frappe.call({\n    method: 'frappe.client.get_all',\n    args: {\n        doctype: 'DCI Proposals',\n        filters: {\n            client_name: frm.doc.client   // \u2705 use correct field name\n        },\n        fields: ['proposal_no', 'registrationno', 'establishmentdate']\n    },\n    callback: function(r) {\n        console.log(\"sandhya:\", r);\n\n        if (!r.exc && r.message && r.message.length > 0) {\n            // \u2705 Get the first matched record\n            let record = r.message[0];\n\n            // \u2705 Set values safely\n            frm.set_value('registration_no', record.registrationno || '');\n            frm.set_value('date', record.establishmentdate || '');\n            frm.set_value('proposal_no', record.proposal_no || '');\n            \n            frappe.msgprint(__('Existing record found for client \"{0}\". Details have been auto-filled.', [frm.doc.client_name]));\n        } else {\n            console.log(\"No matching client found.\");\n            // Optional: clear fields for new entry\n            frm.set_value('registration_no', '');\n            frm.set_value('date', '');\n            frm.set_value('proposal_no', '');\n        }\n    }\n});\n\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "ECI Rejection Letter",
  "enabled": 0,
  "modified": "2025-10-29 12:20:15.514266",
  "module": "Marketing",
  "name": "ECI_Rejection letter",
  "script": "frappe.ui.form.on('ECI_Rejection_Letter', {\nonload: function(frm) {\n    \n    frappe.call({\n\n            method: 'frappe.client.get',\n\n            args: {\n\n                doctype: 'ECI Proposal',\n\n                filters: {\n\n                    client_name: frm.doc.to\n\n                },\n\n                fields: ['proposal_no', 'establishment_date']\n\n            },\n\n            callback: function (r) {\n\n                console.log(r,\"clent short name\")\n\n                if (!r.exc) {\n\n                    if (r.message) {\n\n                        frm.set_value('date', r.message.captured_on);\n                        frm.set_value('regisration_no', r.message.registration_no);\n                        frm.set_value('proposal_no', r.message.proposal_no);\n                        frm.set_value('information', r.message.remarks);\n\n                    }\n\n                } else {\n\n                    console.error(\"Error occurred:\", r.exc);\n\n                }\n\n            }\n\n        });\n        frappe.call({\n            method: 'frappe.client.get',\n            args: {\n                doctype: 'Company-Details',\n                filters: {\n                    name1: frm.doc.to\n                },\n                fields: ['postal_address', 'location', 'physical_address']\n            },\n            callback: function (r) {\n                console.log(r, \"client details\");\n                if (!r.exc) {\n                    if (r.message) {\n                        // Concatenate the fields line by line\n                        let address = '';\n                        \n                        if (r.message.name1) {\n                            address += r.message.name1 + '\\n';\n                        }\n                        if (r.message.location) {\n                            address += r.message.location + '\\n';\n                        }\n                        if (r.message.physical_address) {\n                            address += r.message.physical_address + '\\n';\n                        }\n                        if (r.message.postal_address) {\n                            address += r.message.postal_address + '\\n';\n                        }\n                         \n                        // Remove the trailing newline character\n                        address = address.trim();\n\n                        // Set the concatenated address in the 'address' field\n                        frm.set_value('address', address);\n                    }\n                } else {\n                    console.error(\"Error occurred:\", r.exc);\n                }\n            }\n        });\n    }\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Credit Note Tax Invoice",
  "enabled": 1,
  "modified": "2024-06-27 12:24:06.008843",
  "module": "Finance",
  "name": "cal",
  "script": " frappe.ui.form.on('Credit Note Tax Invoice', {\r\n    onload: function(frm) {\r\n        // Trigger the calculation on form refresh\r\n        calculateADD(frm);\r\n        \r\n    },\r\n    amount11: function(frm) {\r\n        // Trigger the calculation when amount11 changes\r\n        calculateADD(frm);\r\n    },\r\n    amount14: function(frm) {\r\n        // Trigger the calculation when amount14 changes\r\n        calculateADD(frm);\r\n    },\r\n     amount15: function(frm) {\r\n        // Trigger the calculation when amount14 changes\r\n        calculateADD(frm);\r\n    },\r\n     amount19: function(frm) {\r\n        // Trigger the calculation when amount14 changes\r\n        calculateADD(frm);\r\n    },\r\n    refresh:function(frm){\r\n        frm.fields_dict['amount9'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n            frm.fields_dict['amount10'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n    frm.fields_dict['amount11'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n    frm.fields_dict['amount12'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n   frm.fields_dict['amount13'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n    frm.fields_dict['amount14'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n    frm.fields_dict['amount15'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n     frm.fields_dict['amount19'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n          frm.fields_dict['amount16'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n          frm.fields_dict['amount3'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n          frm.fields_dict['amount4'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n\r\n\r\n\r\n\r\n    }\r\n    \r\n});\r\n\r\nfunction calculateADD(frm) {\r\n    // Get the values of amount11 and amount14, default to 0 if they are not set\r\n    var amount11 = frm.doc.amount11 || 0;\r\n    var amount14 = frm.doc.amount14 || 0;\r\n    var amount15 =frm.doc.amount15|| 0;\r\n    var amount19=frm.doc.amount19|| 0;\r\n\r\n    // Convert to float to ensure numerical calculations\r\n    amount11 = parseFloat(amount11);\r\n    amount14 = parseFloat(amount14);\r\n    amount15 = parseFloat(amount15);\r\namount19= parseFloat(amount19);\r\n    // Calculate the sum\r\n    var amount15 = amount11 + amount14;\r\nvar amount16=amount15+amount19;\r\n    // Log the calculated value for debugging\r\n    console.log(\"amount15: \" + amount15);\r\n\r\n    // Set the calculated value to amount15\r\n    frm.set_value('amount15', amount15);\r\n        frm.set_value('amount16', amount16);\r\n\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Debt Note Tax Invoice",
  "enabled": 1,
  "modified": "2024-05-31 06:04:35.472151",
  "module": "Finance",
  "name": "debit cal culation",
  "script": "frappe.ui.form.on('Debt Note Tax Invoice', {\n \n      onload: function(frm) {\n        // Trigger the calculation on form refresh\n        calculateADD(frm);\n    },\n    amount8: function(frm) {\n        // Trigger the calculation when amount11 changes\n        calculateADD(frm);\n    },\n    amount11: function(frm) {\n        // Trigger the calculation when amount14 changes\n        calculateADD(frm);\n    },\n     amount13: function(frm) {\n        // Trigger the calculation when amount14 changes\n        calculateADD(frm);\n    },\n      amount14: function(frm) {\n    //     // Trigger the calculation when amount14 changes\n          calculateADD(frm);\n      },\n       amount15: function(frm) {\n    //     // Trigger the calculation when amount14 changes\n          calculateADD(frm);\n      }\n});\n\nfunction calculateADD(frm) {\n    // Get the values of amount11 and amount14, default to 0 if they are not set\n    var amount8 = frm.doc.amount8 || 0;\n    var amount11 = frm.doc.amount11 || 0;\n    var amount13 =frm.doc.amount13|| 0;\n    var amount14=frm.doc.amount14|| 0;\n    var amount15=frm.doc.amount15||0;\n    // Convert to float to ensure numerical calculations\n    amount8 = parseFloat(amount8);\n    amount11 = parseFloat(amount11);\n    amount13 = parseFloat(amount13);\namount14= parseFloat(amount14);\namount15=parseFloat(amount15);\n    // Calculate the sum\n    var amount14 = amount8 + amount11+amount13;\nvar amount19=amount14+amount15;\n    // Log the calculated value for debugging\n    console.log(\"amount14: \" + amount14);\n\n    // Set the calculated value to amount15\n    frm.set_value('amount14', amount14);\n        frm.set_value('amount19', amount19);\n\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "sa2",
  "enabled": 1,
  "modified": "2024-05-31 11:58:36.681686",
  "module": "Marketing",
  "name": "buyer",
  "script": "frappe.ui.form.on('sa2', {\n  // Client Script for Dci Proposal\n \n    after_save: function(frm) {\n        if (frm.doc.buyer) {\n            frappe.call({\n                method: 'frappe.client.set_value',\n                args: {\n                    doctype: 'sa1',\n                    name: frm.doc.name, // Assuming both doctypes share the same naming convention\n                    fieldname: 'buyer',\n                    value: frm.doc.buyer\n                },\n                callback: function(response) {\n                    if (response.message) {\n                        frappe.msgprint(__('Buyer field updated in Credit Limit Application'));\n                    }\n                }\n            });\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Buyer",
  "enabled": 0,
  "modified": "2024-09-08 17:16:40.317740",
  "module": "Marketing",
  "name": "Buyer Script",
  "script": "frappe.ui.form.on('Buyer', {\n  \n onload: function(frm) {\n     \n//Manipulate NULL Values     \n     if (frm.doc.registration_no === 'NULL') {\n            frm.set_value('registration_no', ' ');\n        } \n    \n  //Status Dropdown\n    \n        const statusMapping = {\n            'ACT': 'Active',\n            'IACT': 'InActive',\n            \n        \n        };\n\n        if (frm.doc.bank && statusMapping[frm.doc.status]) {\n            frm.set_value('status', statusMapping[frm.doc.status]);\n        }\n        \n  // Country Drodown\n \n\n       if (frm.doc.country === 'BW') {\n\n            frm.set_value('country', 'BOTSWANA');\n\n        }\n\n        if (frm.doc.country === 'NA') {\n\n            frm.set_value('country', 'NAMBIA');\n\n        }\n\n        if (frm.doc.country === 'SA') {\n\n            frm.set_value('country', 'SOUTH AFRICA');\n\n        }\n\n        if (frm.doc.country === 'SZ') {\n\n            frm.set_value('country', 'SWAZILAND');\n\n        }\n\n        if (frm.doc.country === 'US') {\n\n            frm.set_value('country', 'United States of America');\n\n        }\n\n        if (frm.doc.country === 'ZM') {\n\n            frm.set_value('country', 'ZAMBIA');\n\n        }\n\n        if (frm.doc.country === 'AA') {\n\n            frm.set_value('country', 'Andorra');\n\n        }\n\n        if (frm.doc.country === 'AC') {\n\n            frm.set_value('country', 'Ascension Island');\n\n        }\n\n        if (frm.doc.country === 'AD') {\n\n            frm.set_value('country', 'Abu Dhabi');\n\n        }\n\n        if (frm.doc.country === 'AG') {\n\n            frm.set_value('country', 'Antigua&Barbuda');\n\n        }\n\n        if (frm.doc.country === 'AI') {\n\n            frm.set_value('country', 'Anguilla');\n\n        }\n\n        if (frm.doc.country === 'AM') {\n\n            frm.set_value('country', 'Ajman');\n\n        }\n\n        if (frm.doc.country === 'AN') {\n\n            frm.set_value('country', 'NETHERLANDS ANTILLES');\n\n        }\n\n        if (frm.doc.country === 'AO') {\n\n            frm.set_value('country', 'Angola');\n\n        }\n\n        if (frm.doc.country === 'AR') {\n\n            frm.set_value('country', 'Argentina');\n\n        }\n\n        if (frm.doc.country === 'AT') {\n\n            frm.set_value('country', 'Austria');\n\n        }\n\n        if (frm.doc.country === 'AU') {\n\n            frm.set_value('country', 'Australia');\n\n        }\n\n        if (frm.doc.country === 'AW') {\n\n            frm.set_value('country', 'Aruba');\n\n        }\n\n        if (frm.doc.country === 'AZ') {\n\n            frm.set_value('country', 'Azores');\n\n        }\n\n        if (frm.doc.country === 'BB') {\n\n            frm.set_value('country', 'Barbados');\n\n        }\n\n        if (frm.doc.country === 'BE') {\n\n            frm.set_value('country', 'Belgium');\n\n        }\n\n        if (frm.doc.country === 'BH') {\n\n            frm.set_value('country', 'Bahrain');\n\n        }\n\n        if (frm.doc.country === 'BM') {\n\n            frm.set_value('country', 'Bermuda');\n\n        }\n\n        if (frm.doc.country === 'BN') {\n\n            frm.set_value('country', 'Brunei');\n\n        }\n\n        if (frm.doc.country === 'BO') {\n\n            frm.set_value('country', 'Bolivia');\n\n        }\n\n         if (frm.doc.country === 'BR') {\n\n            frm.set_value('country', 'Brazil');\n\n        }\n\n        if (frm.doc.country === 'BS') {\n\n            frm.set_value('country', 'Bahamas');\n\n        }\n\n        if (frm.doc.country === 'BZ') {\n\n            frm.set_value('country', 'BELIZE');\n\n        }\n\n        if (frm.doc.country === 'CA') {\n\n            frm.set_value('country', 'Canada');\n\n        }\n\n        if (frm.doc.country === 'CC') {\n\n            frm.set_value('country', 'COCOS ISLANDS');\n\n        }\n\n        if (frm.doc.country === 'CE') {\n\n            frm.set_value('country', 'CEUTA&MELILLA');\n\n        }\n\n        if (frm.doc.country === 'CH') {\n\n            frm.set_value('country', 'SWITZERLAND');\n\n        }\n\n        if (frm.doc.country === 'CI') {\n\n            frm.set_value('country', 'Canary Islands');\n\n        }\n\n        if (frm.doc.country === 'CK') {\n\n            frm.set_value('country', 'COOK ISLANDS');\n\n        }\n\n         if (frm.doc.country === 'CL') {\n\n            frm.set_value('country', 'CHILE');\n\n        }\n\n         if (frm.doc.country === 'CN') {\n\n            frm.set_value('country', 'CHINA');\n\n        }\n\n        if (frm.doc.country === 'CO') {\n\n            frm.set_value('country', 'COLOMBIA');\n\n        }\n\n        if (frm.doc.country === 'CS') {\n\n            frm.set_value('country', 'CHANNEL ISLAND');\n\n        }\n\n        if (frm.doc.country === 'CX') {\n\n            frm.set_value('country', 'CHRISTMAS ISLANDS');\n\n        }\n\n        if (frm.doc.country === 'CY') {\n\n            frm.set_value('country', 'CYPRUS');\n\n        }\n\n        if (frm.doc.country === 'CZ') {\n\n            frm.set_value('country', 'CZECH REPUBLIC');\n\n        }\n\n        if (frm.doc.country === 'DC') {\n\n            frm.set_value('country', 'CONGO DRC');\n\n        }\n\n        if (frm.doc.country === 'DE') {\n\n            frm.set_value('country', 'GERMANY');\n\n        }\n \n        if (frm.doc.country === 'DK') {\n\n           frm.set_value('country', 'DENMARK');\n\n        }\n\n        if (frm.doc.country === 'DO') {\n \n           frm.set_value('country', 'DOMINICAN REPUBLIC');\n\n        }\n\n        if (frm.doc.country === 'DU') {\n\n          frm.set_value('country', 'DUBAI');\n\n        }\n\n        if (frm.doc.country === 'EC') {\n\n          frm.set_value('country', 'ECUADOR');\n\n        }\n\n        if (frm.doc.country === 'EG') {\n\n           frm.set_value('country', 'EGYPT');\n\n        }\n\n        if (frm.doc.country === 'EI') {\n\n            frm.set_value('country', 'EIRE');\n\n        }\n\n        if (frm.doc.country === 'ES') {\n\n           frm.set_value('country', 'SPAIN');\n\n        }\n\n        if (frm.doc.country === 'FI') {\n \n          frm.set_value('country', 'FINLAND');\n\n        }\n\n        if (frm.doc.country === 'FJ') {\n\n           frm.set_value('country', 'FIJI');\n\n        }\n\n        if (frm.doc.country === 'FK') {\n\n            frm.set_value('country', 'FALKLAND ISLANDS');\n\n        }\n\n        if (frm.doc.country === 'FM') {\n\n           frm.set_value('country', 'MICRONESIA,FEDERATED STATES OF');\n\n        }\n\n        if (frm.doc.country === 'FO') {\n\n          frm.set_value('country', 'FAROE ISLANDS');\n\n        }\n\n        if (frm.doc.country === 'FR') {\n\n           frm.set_value('country', 'FRANCE');\n\n        }\n\n        if (frm.doc.country === 'FU') {\n\n          frm.set_value('country', 'FUJAIRAH');\n\n        }\n\nif (frm.doc.country === 'GB') {\n\n    frm.set_value('country', 'UNITED KINGDOM');\n\n}\n\nif (frm.doc.country === 'GD') {\n\n    frm.set_value('country', 'GRENADA');\n\n}\n\nif (frm.doc.country === 'GF') {\n\n    frm.set_value('country', 'FRENCH GUINEA');\n\n}\n\nif (frm.doc.country === 'GH') {\n\n    frm.set_value('country', 'GHANA');\n\n}\n\nif (frm.doc.country === 'GI') {\n\n    frm.set_value('country', 'GIBRALTAR');\n\n}\n\nif (frm.doc.country === 'GL') {\n\n    frm.set_value('country', 'GREENLAND');\n\n}\n\nif (frm.doc.country === 'GP') {\n\n    frm.set_value('country', 'GUADELOUPE');\n\n}\n\nif (frm.doc.country === 'GR') {\n\n    frm.set_value('country', 'GREECE');\n\n}\n\nif (frm.doc.country === 'GS') {\n\n    frm.set_value('country', 'SOUTH GEORGIA & SOUTH SANDWICH ISLANDS');\n\n}\n\nif (frm.doc.country === 'GT') {\n\n    frm.set_value('country', 'GUATEMALA');\n\n}\n\nif (frm.doc.country === 'GU') {\n\n    frm.set_value('country', 'GUAM');\n\n}\n\nif (frm.doc.country === 'HK') {\n\n    frm.set_value('country', 'HONG KONG');\n\n}\n\nif (frm.doc.country === 'HN') {\n\n    frm.set_value('country', 'HONDURAS');\n\n}\n\nif (frm.doc.country === 'HU') {\n\n    frm.set_value('country', 'HUNGARY');\n\n}\n\nif (frm.doc.country === 'IL') {\n\n    frm.set_value('country', 'ISRAEL');\n\n}\n\nif (frm.doc.country === 'IM') {\n\n    frm.set_value('country', 'Isle of Man');\n\n}\n\nif (frm.doc.country === 'IN') {\n\n    frm.set_value('country', 'INDIA');\n\n}\n\nif (frm.doc.country === 'IS') {\n\n    frm.set_value('country', 'ICELAND');\n\n}\n\nif (frm.doc.country === 'IT') {\n\n    frm.set_value('country', 'ITALY');\n\n}\n\nif (frm.doc.country === 'JM') {\n\n    frm.set_value('country', 'JAMAICA');\n\n}\n\nif (frm.doc.country === 'JO') {\n\n    frm.set_value('country', 'JORDAN');\n\n}\n\nif (frm.doc.country === 'JP') {\n\n    frm.set_value('country', 'JAPAN');\n\n}\n\nif (frm.doc.country === 'KE') {\n\n    frm.set_value('country', 'KENYA');\n\n}\n\nif (frm.doc.country === 'KI') {\n\n    frm.set_value('country', 'KIRIBATI');\n\n}\n\nif (frm.doc.country === 'KN') {\n\n    frm.set_value('country', 'ST.KITTS & NEVIS');\n\n}\n\nif (frm.doc.country === 'KR') {\n\n    frm.set_value('country', 'KOREA(SOUTH)');\n\n}\n\nif (frm.doc.country === 'KW') {\n\n    frm.set_value('country', 'KUWAIT');\n\n}\n\nif (frm.doc.country === 'KY') {\n\n    frm.set_value('country', 'CAYMAN ISLANDS');\n\n}\n\nif (frm.doc.country === 'LA') {\n\n    frm.set_value('country', 'LAOS');\n\n}\n\nif (frm.doc.country === 'LC') {\n\n    frm.set_value('country', 'SAINT LUCIA');\n\n}\n\nif (frm.doc.country === 'LI') {\n\n    frm.set_value('country', 'LIECHTENSTEIN');\n\n}\n\nif (frm.doc.country === 'LK') {\n\n    frm.set_value('country', 'SRILANKA');\n\n}\n\nif (frm.doc.country === 'LU') {\n\n    frm.set_value('country', 'LUXEMBOURG');\n\n}\n\nif (frm.doc.country === 'MA') {\n\n    frm.set_value('country', 'MOROCCO');\n\n}\n\nif (frm.doc.country === 'MC') {\n\n    frm.set_value('country', 'MONACO');\n\n}\n\nif (frm.doc.country === 'MH') {\n\n    frm.set_value('country', 'MARSHALL ISLANDS');\n\n}\n\nif (frm.doc.country === 'MO') {\n\n    frm.set_value('country', 'MACAO');\n\n}\n\nif (frm.doc.country === 'MP') {\n\n    frm.set_value('country', 'NORTHERN MARIANA ISLANDS');\n\n}\n\nif (frm.doc.country === 'MQ') {\n\n    frm.set_value('country', 'MARTINIQUE');\n\n}\n\nif (frm.doc.country === 'MS') {\n\n    frm.set_value('country', 'MONTSERRAT');\n\n}\n\nif (frm.doc.country === 'MT') {\n\n    frm.set_value('country', 'MALTA');\n\n}\n\nif (frm.doc.country === 'MU') {\n\n    frm.set_value('country', 'MAURITIUS');\n\n}\n\nif (frm.doc.country === 'MW') {\n\n    frm.set_value('country', 'MALAWI');\n\n}\n\nif (frm.doc.country === 'MX') {\n\n    frm.set_value('country', 'MEXICO');\n\n}\n\nif (frm.doc.country === 'MZ') {\n\n    frm.set_value('country', 'MOZAMBIQUE');\n\n}\n\nif (frm.doc.country === 'NC') {\n\n    frm.set_value('country', 'NEW CALEDONIA');\n\n}\n\nif (frm.doc.country === 'NF') {\n\n    frm.set_value('country', 'NORFOLK ISLANDS');\n\n}\n\nif (frm.doc.country === 'NI') {\n\n    frm.set_value('country', 'NICARAGUA');\n\n}\n\nif (frm.doc.country === 'NL') {\n\n    frm.set_value('country', 'NETHERLANDS');\n\n}\n\nif (frm.doc.country === 'NO') {\n\n    frm.set_value('country', 'NORWAY');\n\n}\n\nif (frm.doc.country === 'NU') {\n\n    frm.set_value('country', 'NIUE');\n\n}\n\nif (frm.doc.country === 'OM') {\n\n    frm.set_value('country', 'OMAN');\n\n}\n\nif (frm.doc.country === 'PA') {\n\n    frm.set_value('country', 'PANAMA');\n\n}\n\nif (frm.doc.country === 'PF') {\n\n    frm.set_value('country', 'FRENCH POLYNESIA');\n\n}\n\nif (frm.doc.country === 'PH') {\n\n    frm.set_value('country', 'PHILIPPINES');\n\n}\n\nif (frm.doc.country === 'PK') {\n\n    frm.set_value('country', 'PAKISTAN');\n\n}\n\nif (frm.doc.country === 'PL') {\n\n    frm.set_value('country', 'POLAND');\n\n}\n\nif (frm.doc.country === 'PM') {\n\n    frm.set_value('country', 'ST PIERRE & MIGUELON');\n\n}\n\nif (frm.doc.country === 'PN') {\n\n    frm.set_value('country', 'PITCAIRN ISLAND');\n\n}\n\nif (frm.doc.country === 'PR') {\n\n    frm.set_value('country', 'PUERTO RICO');\n\n}\n\nif (frm.doc.country === 'PT') {\n\n    frm.set_value('country', 'PORTUGAL');\n\n}\n\nif (frm.doc.country === 'PW') {\n\n    frm.set_value('country', 'PALAU');\n\n}\n\nif (frm.doc.country === 'PY') {\n\n    frm.set_value('country', 'PARAGUAY');\n\n}\n\nif (frm.doc.country === 'QA') {\n\n    frm.set_value('country', 'QATAR');\n\n}\n\nif (frm.doc.country === 'RE') {\n\n    frm.set_value('country', 'REUNION');\n\n}\n\nif (frm.doc.country === 'RK') {\n\n    frm.set_value('country', 'Ras Al Khaimah');\n\n}\n\nif (frm.doc.country === 'SB') {\n\n    frm.set_value('country', 'SOLOMON ISLANDS');\n\n}\n\nif (frm.doc.country === 'SC') {\n    \n    frm.set_value('country', 'SEYCHELLES');\n}\n\n\nif (frm.doc.country === 'SE') {\n\n    frm.set_value('country', 'SWEDEN');\n\n}\n\nif (frm.doc.country === 'SG') {\n\n    frm.set_value('country', 'SINGAPORE');\n\n}\n\nif (frm.doc.country === 'SL') {\n\n    frm.set_value('country', 'SIERRA LEONE');\n\n}\n\nif (frm.doc.country === 'ST') {\n\n    frm.set_value('country', 'SAO TOME');\n\n}\n\nif (frm.doc.country === 'SV') {\n\n    frm.set_value('country', 'EL SALVADOR');\n\n}\n\nif (frm.doc.country === 'SY') {\n\n    frm.set_value('country', 'SYRIA');\n\n}\n\nif (frm.doc.country === 'TC') {\n\n    frm.set_value('country', 'TURKS & CAICOS');\n\n}\n\nif (frm.doc.country === 'TG') {\n\n    frm.set_value('country', 'TOGO');\n\n}\n\nif (frm.doc.country === 'TH') {\n\n    frm.set_value('country', 'THAILAND');\n\n}\n\nif (frm.doc.country === 'TT') {\n\n    frm.set_value('country', 'TRINIDAD & TOBAGO');\n\n}\n\nif (frm.doc.country === 'TV') {\n\n    frm.set_value('country', 'TUVALU');\n\n}\n\nif (frm.doc.country === 'TZ') {\n\n    frm.set_value('country', 'TANZANIA');\n\n}\n\nif (frm.doc.country === 'UG') {\n\n    frm.set_value('country', 'UGANDA');\n\n}\n\nif (frm.doc.country === 'UK') {\n\n    frm.set_value('country', 'UNITED KINGDOM');\n\n}\n\nif (frm.doc.country === 'UY') {\n\n    frm.set_value('country', 'URUGUAY');\n\n}\n\nif (frm.doc.country === 'VA') {\n\n    frm.set_value('country', 'VATICAN CITY');\n\n}\n\nif (frm.doc.country === 'VG') {\n\n    frm.set_value('country', 'BRITISH VIRGIN ISLANDS');\n\n}\n\nif (frm.doc.country === 'VI') {\n\n    frm.set_value('country', 'VIRGIN ISLANDS(USA)');\n\n}\n\nif (frm.doc.country === 'WF') {\n\n    frm.set_value('country', 'WALLIS & FUTUNA');\n\n}\n\nif (frm.doc.country === 'ZA') {\n\n    frm.set_value('country', 'SOUDI ARABIA');\n\n}\n\nif (frm.doc.country === 'ZM') {\n\n    frm.set_value('country', 'ZAMBIA');\n\n}\n\nif (frm.doc.country === 'ZW') {\n\n    frm.set_value('country', 'Zimbabwe');\n\n}\n\n \n        \n        \n        \n        \n //Industry Dropdown\n        \n        if (frm.doc.industry === 'AGRC') {\n            frm.set_value('industry', 'AGRICULTURE');\n        }\n         if (frm.doc.industry === 'BEF') {\n            frm.set_value('industry', 'BEEF');\n        }\n         if (frm.doc.industry === 'CON') {\n            frm.set_value('industry', 'CONSTRUCTION');\n        }\n         if (frm.doc.industry === 'DST') {\n            frm.set_value('industry', 'DISTRIBUTOR');\n        }\n         if (frm.doc.industry === 'FIN') {\n            frm.set_value('industry', 'FINANCIAL SERVICES');\n        }\n         if (frm.doc.industry === 'HAR') {\n            frm.set_value('industry', 'HARDWARE');\n        }\n         if (frm.doc.industry === 'ITSH') {\n            frm.set_value('industry', 'IT SOFTWARE & HARDWARE');\n        }\n         if (frm.doc.industry === 'MIN') {\n            frm.set_value('industry', 'MINING');\n        }\n         if (frm.doc.industry === 'MPTS') {\n            frm.set_value('industry', 'MOTOR PARTS');\n        }\n        if (frm.doc.industry === 'OPT') {\n            frm.set_value('industry', 'OPTICALS');\n        }\n        if (frm.doc.industry === 'PHA') {\n            frm.set_value('industry', 'PHARMACEUTICALS');\n        }\n        if (frm.doc.industry === 'PIP') {\n            frm.set_value('industry', 'PVC PIPES');\n        }\n        if (frm.doc.industry === 'RET') {\n            frm.set_value('industry', 'RETAILER');\n        }\n        if (frm.doc.industry === 'STA') {\n            frm.set_value('industry', 'STATIONARY');\n        }\n        if (frm.doc.industry === 'STE') {\n            frm.set_value('industry', 'STEEL');\n        }\n        if (frm.doc.industry === 'TEX') {\n            frm.set_value('industry', 'TEXTILES');\n        }\n         if (frm.doc.industry === 'TOUR') {\n            frm.set_value('industry', 'TOURISM');\n        }\n         if (frm.doc.industry === 'WTAN') {\n            frm.set_value('industry', 'WATER TANKS');\n        }\n        if (frm.doc.industry === 'COMM') {\n            frm.set_value('industry', 'Communications');\n        }\n        if (frm.doc.industry === 'COF') {\n            frm.set_value('industry', 'CONFECTIONERY');\n        }\n        if (frm.doc.industry === 'TR') {\n            frm.set_value('industry', 'TRANSPORTATION');\n        }\n        \n        \n        \n        \n        \n // Business Dropdown\n \n        if (frm.doc.business === 'MC') {\n            frm.set_value('business', 'MECHANICAL CONTRACTORS');\n        } if (frm.doc.business === 'MAN') {\n            frm.set_value('business', 'MANUFACTURER');\n        }\n         if (frm.doc.business === 'GE') {\n            frm.set_value('business', 'GOODS RETALING');\n        }\n         if (frm.doc.business === 'GND') {\n            frm.set_value('business', 'GENERAL DEALER');\n        }\n         if (frm.doc.business === 'SRET') {\n            frm.set_value('business', 'SERVICES RETAILING');\n        }\n         if (frm.doc.business === 'SIT') {\n            frm.set_value('business', 'STATIONARY AND IT PRODUCTS');\n        }\n         if (frm.doc.business === 'BM') {\n            frm.set_value('business', 'BUILDING MAINTENANCE');\n        }\n         if (frm.doc.business === 'EC') {\n            frm.set_value('business', 'ENGINEERING CONSULTANCY');\n        }\n         if (frm.doc.business === 'RC') {\n            frm.set_value('business', 'ROAD CONSTRUCTION');\n        }\n         if (frm.doc.business === 'MGRET') {\n            frm.set_value('business', 'MANUFACTURING');\n        }\n         if (frm.doc.business === 'WHO') {\n            frm.set_value('business', 'WHOLESALERS');\n        }\n         if (frm.doc.business === 'ITP') {\n            frm.set_value('business', 'IT PRODUCTS');\n        }\n         if (frm.doc.business === 'CHE') {\n            frm.set_value('business', 'CHEMICALS');\n        }\n         if (frm.doc.business === 'MINE') {\n            frm.set_value('business', 'MINING ENGINEERING');\n        }\n         if (frm.doc.business === 'ELEC') {\n            frm.set_value('business', 'ELECTRICAL ENGINEERING');\n        }\n         if (frm.doc.business === 'STC') {\n            frm.set_value('business', 'STATIONARY AND COMPUTERS');\n        }\n         if (frm.doc.business === 'ME') {\n            frm.set_value('business', 'MECHANICAL ENGINEERING');\n        }\n         if (frm.doc.business === 'BLDCON') {\n            frm.set_value('business', 'BUILDING CONSTRUCTION');\n        }\n        if (frm.doc.business === 'HARD') {\n            frm.set_value('business', 'HARDWARE');\n        }\n         if (frm.doc.business === 'CIVIL') {\n            frm.set_value('business', 'CIVIL ENGINEERING');\n        }\n         if (frm.doc.business === 'STT') {\n            frm.set_value('business', 'STATIONARY');\n        }\n         if (frm.doc.business === 'OTH') {\n            frm.set_value('business', 'OTHERS');\n        }\n         if (frm.doc.business === 'LANC') {\n            frm.set_value('business', 'LANDSCAPE CONTRACTORS');\n        }\n         if (frm.doc.business === 'SIT') {\n            frm.set_value('business', 'STATIONARY AND IT PRODUCTS');\n        }\n         if (frm.doc.business === 'SRET') {\n            frm.set_value('business', 'SERVICES RETAILING');\n        }\n         if (frm.doc.business === 'BUT') {\n            frm.set_value('business', 'BUTCHERY');\n        }\n         if (frm.doc.business === 'CSTA') {\n            frm.set_value('business', 'CHEMICALS AND STATIONARY');\n        }\n         if (frm.doc.business === 'FF') {\n            frm.set_value('business', 'FREIGHT FORWARDING');\n        }\n       if (frm.doc.business === 'FHRD') {\n            frm.set_value('business', 'FURNITURE AND HARDWARE');\n        }\n       if (frm.doc.business === 'INST') {\n            frm.set_value('business', 'INSTRUMENTATION');\n        }\n       if (frm.doc.business === 'RM') {\n            frm.set_value('business', 'ROAD MAINTENANCE');\n        }\n       if (frm.doc.business === 'REST') {\n            frm.set_value('business', 'RESTAURANT');\n        }\n         if (frm.doc.business === 'RET') {\n            frm.set_value('business', 'RESTAURANT');\n        }\n\n\n// Bank Dropdown\n\n\n if (frm.doc.bank === 'FIRST') {\n            frm.set_value('bank', 'FIRST NATIONAL BANK OF BOTSWANA');\n        }\n        if (frm.doc.bank === 'CAPIT') {\n            frm.set_value('bank', 'CAPITAL BANK');\n        }\n        if (frm.doc.bank === 'BOTSW') {\n            frm.set_value('bank', 'BOTSWANA VACCINE INST');\n        }\n        if (frm.doc.bank === 'BOTS1') {\n            frm.set_value('bank', 'BOTSWANA BUILDING SOCIETY(BBS)');\n        }\n        if (frm.doc.bank === 'STAN2') {\n            frm.set_value('bank', 'STANDARD BANK(SA)');\n        }\n        if (frm.doc.bank === 'MIGRA') {\n            frm.set_value('bank', 'MIGRATION BANK');\n        }\n        if (frm.doc.bank === 'RAND') {\n            frm.set_value('bank', 'RAND MERCHANT');\n        }\n        if (frm.doc.bank === 'STANB') {\n            frm.set_value('bank', 'STANBIC BANK');\n        }\n        if (frm.doc.bank === 'BancA') {\n            frm.set_value('bank', 'BANC ABC');\n        }\n        if (frm.doc.bank === 'STAN1') {\n            frm.set_value('bank', 'STANDARD CHARTERED BANK BOTSWANA LTD');\n        }\n        if (frm.doc.bank === 'STAN4') {\n            frm.set_value('bank', 'STANDARD CHARTERED BANK');\n        }\n        if (frm.doc.bank === 'STAN3') {\n            frm.set_value('bank', 'STANDARD BANK NAMIBIA');\n        }\n        if (frm.doc.bank === 'NEDBA') {\n            frm.set_value('bank', 'NED BANK');\n        }\n        if (frm.doc.bank === 'FIRS1') {\n            frm.set_value('bank', 'FIRST NATIONAL BANK(SA)');\n        }\n        if (frm.doc.bank === 'BARCL') {\n            frm.set_value('bank', 'BARCLAYS BANK OF BOTSWANA');\n        }\n         if (frm.doc.bank === 'BANK1') {\n            frm.set_value('bank', 'BANK OF BARODA(BOTSWANA)LTD');\n        }\n        if (frm.doc.bank === 'BANKG') {\n            frm.set_value('bank', 'BANK GABORONE');\n        }\n        if (frm.doc.bank === 'ABS01') {\n            frm.set_value('bank', 'ABSA');\n        }\n        if (frm.doc.bank === 'BANK3') {\n            frm.set_value('bank', 'BANK OF BOTSWANA');\n        }\n         if (frm.doc.bank === 'BANK2') {\n            frm.set_value('bank', 'BANK OF INDIA');\n        }\n        if (frm.doc.bank === 'FIRS4') {\n            frm.set_value('bank', 'FIRST NATIONAL BANK NAMIBIA');\n        }\n        if (frm.doc.bank === 'FIRS2') {\n            frm.set_value('bank', 'FIRST CARE CHEMIST (PTY LTD)');\n        }\n         if (frm.doc.bank === 'BIM') {\n            frm.set_value('bank', 'BIM');\n        }\n         if (frm.doc.bank === 'BOTS2') {\n            frm.set_value('bank', 'BOTSWANA SAVINGS BANK');\n        }\n        \n           if (frm.doc.bank === 'CBZB') {\n            frm.set_value('bank', 'CBZ BANK');\n        }\n        \n        if (frm.doc.bank === 'Banc1') {\n            frm.set_value('bank', 'BANCO COMMERICAL E DE INVESTIMENTOS');\n        }  \n        \n        if (frm.doc.bank === 'ECOB') {\n            frm.set_value('bank', 'ECO BANK');\n        }  \n        \n        if (frm.doc.bank === 'NMBB') {\n            frm.set_value('bank', 'NMB BANK LIMITED');\n        }  \n        \n        if (frm.doc.bank === 'BANC2') {\n            frm.set_value('bank', 'BANCO INTERNATIONAL DE CREDITO');\n        }  \n        \n        if (frm.doc.bank === 'KING') {\n            frm.set_value('bank', 'KINGDOM BANK');\n        }\n        \n         if (frm.doc.bank === 'BANK4') {\n            frm.set_value('bank', 'BANK WINDHOEK');\n        } \n    },\n  \n\n    \n    \n    \n \n    \n  \n\trefresh: function(frm) {\n\n\t    \n\t    // Set both checkboxes as read-only\n        frm.set_df_property('eci', 'read_only', 1);\n        frm.set_df_property('dci', 'read_only', 1);\n// \t\tfrappe.call({\n//             method: 'frappe.client.get_list',\n//             args: {\n//                 doctype: 'Country Details',\n//                 fields: ['country'],\n//                 limit_page_length: 100  // Add this line to retrieve up to 100 records\n//             },\n//             callback: function(response) {\n//                 let DataArray = response.message;\n//                 let FinalArray = [];\n \n//                 for (let x of DataArray) {\n//                     FinalArray.push(x.country);\n//                 }\n \n//                 frm.set_df_property('country', 'options', FinalArray);\n//                 console.log(\"final\", FinalArray);\n//             },\n//             error: function(xhr, textStatus, errorThrown) {\n//                 console.error(\"Error fetching approved bonds:\", textStatus, errorThrown);\n//             }\n//         });\n\t},\n\t\n\t\n\t   // validate: function(frm) {\n    //     // Check if neither checkbox is selected\n    //     if (!frm.doc.eci && !frm.doc.dci) {\n    //         // Display a pop-up message\n    //         frappe.msgprint(__('Please select either ECI or DCI before saving.'));\n    //         // Prevent form from being saved\n    //         frappe.validated = false;\n    //     }\n        \n    //     let fields_to_validate = ['phone', 'tel_no1', 'tel_no2'];\n        \n    //     fields_to_validate.forEach(function(field) {\n    //         let value = frm.doc[field] || '';  // Ensure the value is a string\n            \n    //         // Remove any non-digit characters (like spaces, dashes, etc.)\n    //         let digits_only = value.replace(/\\D/g, '');\n            \n    //         // Check if the number of digits exceeds 11\n    //         if (digits_only.length > 11) {\n    //             frappe.msgprint(__(`${field} should not exceed 11 digits.`));\n    //             frappe.validated = false;  // Prevent form from saving\n    //         }\n    //     });\n    // }\n\t\n\t\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Insure Details",
  "enabled": 1,
  "modified": "2025-11-27 09:05:58.959236",
  "module": "Marketing",
  "name": "Insured Details",
  "script": "// ---- Insure Details Doctype ----\r\nfrappe.ui.form.on('Insure Details', {\r\n    onload: function(frm) {\r\n        // Replace string \"NULL\" with blank space for selected fields\r\n        const fields_to_check = [\r\n            'name1', 'postal_address', 'location', 'physical_address',\r\n            'location1', 'telephone', 'fax', 'taxno', 'status',\r\n            'country', 'vat_registration_no', 'contact_person', 'email'\r\n        ];\r\n\r\n        fields_to_check.forEach(field => {\r\n            if (frm.doc[field] === 'NULL') {\r\n                frm.set_value(field, ' ');\r\n            }\r\n        });\r\n    },\r\nrefresh: function(frm) {\r\n        // Always show the client field\r\n        frm.set_df_property('name1', 'hidden', 0);\r\n\r\n        // Make it read-only if the document is saved\r\n        if (!frm.is_new()) {\r\n            frm.set_df_property('name1', 'read_only', 1);\r\n        } else {\r\n            frm.set_df_property('name1', 'read_only', 0);\r\n        }\r\n    },\r\n    // run when user edits name1\r\n    name1: async function(frm) {\r\n        await generate_insured_shortname(frm);\r\n    },\r\n\r\n    // also run before_save to ensure short_name exists/unique\r\n    before_save: async function(frm) {\r\n        await generate_insured_shortname(frm);\r\n    }\r\n});\r\n\r\n// helper: generate and set unique short_name for Insure Details\r\nasync function generate_insured_shortname(frm) {\r\n    // make sure we have a source value\r\n    let src = (frm.doc.name1 || '').toString().trim();\r\n    if (!src) return;\r\n\r\n    // normalize: remove non-alphanumeric, take first 4 chars, uppercase\r\n    let base = src.replace(/[^A-Za-z0-9]/g, '').substring(0, 4).toUpperCase();\r\n    if (!base) return;\r\n\r\n    // function to check existence excluding current doc\r\n    async function exists(short) {\r\n        // filters as array to allow exclusion of current doc\r\n        let filters = [['short_name', '=', short]];\r\n        if (frm.doc.name) {\r\n            filters.push(['name', '!=', frm.doc.name]);\r\n        }\r\n\r\n        let res = await frappe.db.get_list('Insure Details', {\r\n            fields: ['name'],\r\n            filters: filters,\r\n            limit: 1\r\n        });\r\n        return (res && res.length > 0);\r\n    }\r\n\r\n    // try base, then base1, base2...\r\n    let candidate = base;\r\n    let counter = 0;\r\n    while (await exists(candidate)) {\r\n        counter++;\r\n        candidate = base + counter;\r\n        if (counter > 1000) break; // safety fallback\r\n    }\r\n\r\n    if (frm.doc.short_name !== candidate) {\r\n        frm.set_value('short_name', candidate);\r\n    }\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Insured_Main",
  "enabled": 0,
  "modified": "2024-06-03 11:59:02.679426",
  "module": "Marketing",
  "name": "insure",
  "script": "frappe.ui.form.on('Insured_Main', {\n\n    refresh: function(frm) {\n        // Function to fetch policy holders recursively\n        function fetchPolicyHolders(start, policyNumbers, callback) {\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Policy Approvals',\n                    filters: {\n                        'workflow_state': 'Approved'\n                    },\n                    fields: ['policy_number'],\n                    limit_start: start,\n                    limit_page_length: 100\n                },\n                callback: function(response) {\n                    console.log(response,\"response\")\n                    if (response.message) {\n                        policyNumbers = policyNumbers.concat(response.message.map(x => x.policy_number));\n                        if (response.message.length < 100) {\n                            // All records fetched, call the callback with the final array\n                            callback(policyNumbers);\n                        } else {\n                            // Fetch the next batch\n                            fetchPolicyHolders(start + 100, policyNumbers, callback);\n                        }\n                    } else {\n                        // Call the callback with the final array\n                        callback(policyNumbers);\n                    }\n                },\n                error: function(xhr, textStatus, errorThrown) {\n                    console.error(\"Error fetching policy holders:\", textStatus, errorThrown);\n                    callback(policyNumbers); // Return whatever has been fetched so far\n                }\n            });\n        }\n\n        // Start fetching from the beginning\n        fetchPolicyHolders(0, [], function(finalArray) {\n            frm.set_df_property('name1', 'options', finalArray);\n            console.log(\"final\", finalArray);\n        });\n    }\n});\n\n\n\n\n\n\n// \t    refresh: function(frm) {\n//         // Fetch policy_holder from Policy Approvals\n//         frappe.call({\n//             method: 'frappe.client.get_list',\n//             args: {\n//                 doctype: 'Policy Approvals',\n//                  filters: {\n//           'workflow_state': 'Approved'\n//         },\n//                 fields: ['policy_number']\n//             },\n//             callback: function(response) {\n//                 console.log(\"policy_holder received:\", response);\n                \n//                 if (response.message) {\n//                     let finalArray = response.message.map(x => x.policy_number);\n//                     frm.set_df_property('name1', 'options', finalArray);\n//                     console.log(\"final\", finalArray);\n//                 }\n//             },\n//             error: function(xhr, textStatus, errorThrown) {\n//                 console.error(\"Error fetching policy holders:\", textStatus, errorThrown);\n//             }\n//         });\n    \n// \t}\n// });\n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n    ",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "cred",
  "enabled": 1,
  "modified": "2024-06-03 10:48:12.445392",
  "module": "UnderWriting",
  "name": "script4",
  "script": " frappe.ui.form.on('cred', {\r\n    refresh: function(frm) {\r\n        // Fetch and set approved policy numbers in dropdown\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: { \r\n                'doctype': 'cred',\r\n                'filters': {\r\n                    'workflow_state': 'Approved'\r\n                },\r\n                'fields': ['policy_number']\r\n            },\r\n            callback: function(submittedApplicationsResponse) {\r\n                console.log(submittedApplicationsResponse, \"submittedApplicationsResponse\");\r\n                if (submittedApplicationsResponse.message) {\r\n                    var submittedPolicyNumbers = submittedApplicationsResponse.message.map(function(application) {\r\n                        return application.policy_number;\r\n                    });\r\n\r\n                    // Fetch approved applications\r\n                    frappe.call({\r\n                        method: 'frappe.client.get_list',\r\n                        args: {\r\n                            'doctype': 'Policy Approvals',\r\n                            'filters': {\r\n                                'workflow_state': 'Approved'\r\n                            },\r\n                            'fields': ['policy_number']\r\n                        },\r\n                        callback: function(approvedApplicationsResponse) {\r\n                            console.log(approvedApplicationsResponse, \"approvedApplicationsResponse\");\r\n                            if (approvedApplicationsResponse.message) {\r\n                                var approvedPolicyNumbers = approvedApplicationsResponse.message.map(function(application) {\r\n                                    return application.policy_number;\r\n                                });\r\n\r\n                                var filteredPolicyNumbers = approvedPolicyNumbers.filter(function(policyNumber) {\r\n                                    return !submittedPolicyNumbers.includes(policyNumber);\r\n                                });\r\n\r\n                                // Set dropdown options with approved policy numbers\r\n                                frm.set_df_property('policy_number', 'options', filteredPolicyNumbers);\r\n\r\n                                // Set dropdown query with approved policy numbers\r\n                                frm.set_query('policy_number', function() {\r\n                                    return {\r\n                                        filters: {\r\n                                            'policy_number': ['in', filteredPolicyNumbers]\r\n                                        }\r\n                                    };\r\n                                });\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        });\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Claim Payment",
  "enabled": 1,
  "modified": "2025-12-08 08:13:18.492659",
  "module": null,
  "name": "Claim Payment Script",
  "script": "frappe.ui.form.on('Claim Payment', {\n\trefresh: function(frm) {\n\t    frm.fields_dict.payment_amount.$input.css(\"text-align\", \"right\");\n\t\tfrappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Claim Process',\n                filters: {\n                    workflow_state: \"Approved\"\n                },\n                fields: ['client'],\n                  limit_page_length: 0\n            },\n            callback: function(response) {\n                let DataArray = [];\n                DataArray = response.message;\n                let FinalArray = [];\n                \n                FinalArray.sort();\n                DataArray.sort();\n \n                for (let x of DataArray) {\n                    FinalArray.push(x.client)\n \n                }\n                frm.set_df_property('client', 'options', FinalArray);\n                //  frm.set_df_property('client1', FinalArray);\n                frm.set_df_property('client1', 'options', FinalArray);\n                console.log(\"final\", FinalArray);\n \n            },\n            error: function(xhr, textStatus, errorThrown) {\n                console.error(\"Error fetching approved bonds:\", textStatus, errorThrown);\n            }\n        });\t},\n\t\n// \t  if (workflowState === \"Approved\" || workflowState === \"Pending\") {\n//             frm.toggle_display('client', false);\n//             frm.toggle_display('client1', true);\n//         } else {\n//             frm.toggle_display('client', true);\n//             frm.toggle_display('client1', false);\n//         }\n//     },\n \n client: function(frm) {\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Claim Process',\n                filters: {\n                   client: frm.doc.client\n                },\n                fields: ['paymentrefno', 'insuredamt']\n            },\n            callback: function(r) {\n               \n                if (!r.exc) {\n                    if (r.message && r.message.length > 0) {\n                        var data = r.message[0]; // Get the first record from the fetched data\n\n                        frm.set_value('payment_no', data.paymentrefno);\n                        frm.set_value('payment_amount', data.insuredamt); // Assuming 'client_type' is the correct field name\n                    }\n                } else {\n                    frm.set_value('payment_no', '');\n                     frm.set_value('payment_amount', '');\n                    console.error(\"Error occurred:\", r.exc);\n                }\n            }\n        });\n    },\n\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "LOI Invoice",
  "enabled": 1,
  "modified": "2025-12-05 08:55:26.189794",
  "module": "Finance",
  "name": "LOI Invoices",
  "script": "frappe.ui.form.on('LOI Invoice', {\r\n\r\n\trefresh: function(frm) {\r\n\t   frm.fields_dict.amount.$input.css(\"text-align\", \"right\");\r\n\t   frm.fields_dict.invoice_amount.$input.css(\"text-align\", \"right\");\r\n \r\n       \r\n        if (!frm.doc.invoice_no) {\r\n            generateNumber(frm);\r\n        }\r\n    // Fetch policy_holder from Policy Approvals\r\n   frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Letter Of Intends',\r\n           \r\n            fields: ['bondname'],\r\n            limit_page_length: 0  // Adjust this value as needed\r\n        },\r\n        callback: function(response) {\r\n            console.log(\"policy_holder received:\", response);\r\n \r\n            if (response.message) {\r\n                let finalArray = response.message.map(x => x.bondname);\r\n                finalArray.sort();\r\n                \r\n                \r\n                frm.set_df_property('client_name', 'options', finalArray);\r\n                console.log(\"final\", finalArray);\r\n            }\r\n        },\r\n        error: function(xhr, textStatus, errorThrown) {\r\n            console.error(\"Error fetching policy holders:\", textStatus, errorThrown);\r\n        }\r\n    });\r\n    \r\n\r\n},\r\nclient_name: function(frm) {\r\n frappe.call({\r\n            method: 'frappe.client.get',\r\n            args: {\r\n                doctype: 'Letter Of Intends',\r\n                filters: {\r\n                    bondname: frm.doc.client_name\r\n                },\r\n                fields: ['bond_facility_no', 'facility_date']\r\n            },\r\n            callback: function (r) {\r\n                console.log(r,\"clent short name\")\r\n                if (!r.exc) {\r\n                    if (r.message) {\r\n                        frm.set_value('bnd_facility_no', r.message.bond_facility_no);\r\n                      frm.set_value('facility_date', r.message.facility_date);\r\n\r\n                    }\r\n                } else {\r\n                    console.error(\"Error occurred:\", r.exc);\r\n                }\r\n            }\r\n        });\r\n        frappe.call({\r\n    method: 'frappe.client.get',\r\n    args: {\r\n        doctype: 'Letter Of Intends',\r\n        filters: {\r\n            bondname: frm.doc.client_name\r\n        },\r\n        fields: ['letter_of_intends_no_table']\r\n    },\r\n    callback: function (r) {\r\n        console.log(r, \"client short name\");\r\n\r\n        if (!r.exc) {\r\n            if (r.message && r.message.letter_of_intends_no_table && r.message.letter_of_intends_no_table.length > 0) {\r\n                // Create an array to store all loi_no\r\n                let loi_nos = r.message.letter_of_intends_no_table.map(item => item.loi_no);\r\n\r\n                // Join the array into a single string with newline character to create options\r\n                let options = loi_nos.join(\"\\n\");\r\n\r\n                // Set the options to the dropdown field\r\n                frm.set_df_property('loi_no', 'options', options);\r\n                \r\n                frm.doc.loi_details = r.message.letter_of_intends_no_table;\r\n            }\r\n        } else {\r\n            console.error(\"Error occurred:\", r.exc);\r\n        }\r\n    }\r\n});\r\n\r\n},\r\n// bnd_facility_no: function (frm){\r\n//   frappe.call({\r\n//             method: 'frappe.client.get',\r\n//             args: {\r\n//                 doctype: 'Letter Of Intends',\r\n//                 filters: {\r\n//                     bond_facility_no: frm.doc.bnd_facility_no\r\n//                 },\r\n//                 fields: ['bondname', 'facility_date']\r\n//             },\r\n//             callback: function (r) {\r\n//                 console.log(r,\"clent short name\")\r\n//                 if (!r.exc) {\r\n//                     if (r.message) {\r\n//                         frm.set_value('client_name', r.message.bondname);\r\n//                       frm.set_value('facility_date', r.message.facility_date);\r\n\r\n//                     }\r\n//                 } else {\r\n//                     console.error(\"Error occurred:\", r.exc);\r\n//                 }\r\n//             }\r\n//         });\r\n\r\n// frappe.call({\r\n//     method: 'frappe.client.get',\r\n//     args: {\r\n//         doctype: 'Letter Of Intends',\r\n//         filters: {\r\n//             bond_facility_no: frm.doc.bnd_facility_no\r\n//         },\r\n//         fields: ['letter_of_intends_no_table']\r\n//     },\r\n//     callback: function (r) {\r\n//         console.log(r, \"client short name\");\r\n\r\n//         if (!r.exc) {\r\n//             if (r.message && r.message.letter_of_intends_no_table && r.message.letter_of_intends_no_table.length > 0) {\r\n//                 // Create an array to store all loi_no\r\n//                 let loi_nos = r.message.letter_of_intends_no_table.map(item => item.loi_no);\r\n\r\n//                 // Join the array into a single string with newline character to create options\r\n//                 let options = loi_nos.join(\"\\n\");\r\n\r\n//                 // Set the options to the dropdown field\r\n//                 frm.set_df_property('loi_no', 'options', options);\r\n                \r\n//                 frm.doc.loi_details = r.message.letter_of_intends_no_table;\r\n//             }\r\n//         } else {\r\n//             console.error(\"Error occurred:\", r.exc);\r\n//         }\r\n//     }\r\n// });\r\n\r\n\r\n//  },\r\nloi_no: function(frm) {\r\n        // Get the selected loi_no\r\n        let selected_loi_no = frm.doc.loi_no;\r\n\r\n        // Find the matching record from the stored details\r\n        let selected_record = frm.doc.loi_details.find(item => item.loi_no === selected_loi_no);\r\n\r\n        if (selected_record) {\r\n            // Update the fields with the corresponding values\r\n            frm.set_value('principal', selected_record.principal);\r\n            frm.set_value('tender_no', selected_record.tender_no);\r\n            frm.set_value('invoice_amount', selected_record.bond_value);\r\n            frm.set_value('amount_date', selected_record.letter_of_intent_date);\r\n            frm.set_value('currency', selected_record.currency);\r\n        }\r\n    }\r\n});\r\n\r\n\r\n\r\nfunction generateNumber(frm) {\r\n    if (!frm.doc.bond_no) {\r\n        let currentYear = new Date().getFullYear();\r\n        let prefix = `INV/BND/${currentYear}/`;\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'LOI Invoice',\r\n                fields: ['invoice_no', 'creation'],\r\n                order_by: 'creation desc',\r\n                limit: 1\r\n            },\r\n            callback: function (r) {\r\n                if (r.message && r.message.length > 0) {\r\n                    let lastBondNo = r.message[0].invoice_no;\r\n                    let lastNumber = parseInt(lastBondNo.split(\"/\").pop()) || 0;\r\n                    let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n                    frm.set_value('invoice_no', prefix + newNumber);\r\n                } else {\r\n                    frm.set_value('invoice_no', prefix + '0001');\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Follow UP",
  "enabled": 1,
  "modified": "2024-12-23 10:59:03.660016",
  "module": "Marketing",
  "name": "Follow UP",
  "script": "function generateNumber(frm) {\r\n    if (!frm.doc.followup_id) {\r\n        let currentYear = new Date().getFullYear();\r\n        let prefix = `FUP/${currentYear}/`;\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Follow UP',\r\n                fields: ['followup_id'],\r\n                limit: 1,\r\n                order_by: 'creation desc'\r\n            },\r\n            callback: function(r) {\r\n                if (r.message && r.message.length > 0) {\r\n                    let lastClaimRefNo = r.message[0].followup_id;\r\n                    let lastNumber = lastClaimRefNo ? parseInt(lastClaimRefNo.split(\"/\").pop()) : null;\r\n                    if (!isNaN(lastNumber)) {\r\n                        let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n                        frm.set_value('followup_id', prefix + newNumber);\r\n                    }\r\n                } else {\r\n                    frm.set_value('followup_id', prefix + '0001');\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\nfrappe.ui.form.on('Follow UP', {\r\n    refresh(frm) {\r\n        // Align the \"visited_by\" field to the right\r\n        frm.fields_dict.visited_by.$input.css(\"text-align\", \"right\");\r\n    },\r\n    onload(frm) {\r\n        // Generate a new followup_id if it doesn't exist\r\n        if (!frm.doc.followup_id) {\r\n            generateNumber(frm);\r\n        }\r\n    },\r\n    validate(frm) {\r\n        // Ensure the Scheduled Date is greater than the current date\r\n        var selectedDate = frm.doc.schdate;\r\n        var currentDate = frappe.datetime.get_today();\r\n        if (selectedDate <= currentDate) {\r\n            frappe.msgprint(__(\"Please select a Scheduled Date greater than the current date.\"));\r\n            frappe.validated = false;\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "CB Report",
  "enabled": 1,
  "modified": "2025-12-05 08:10:44.371282",
  "module": null,
  "name": "CB Report script",
  "script": "frappe.ui.form.on('CB Report', {\r\n    \r\n    //alphabetical order\r\n    refresh: function(frm) {\r\n\r\n    frm.fields_dict.veiw_cb_request.$input.addClass('btn-primary');\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: \"CB Request\",\r\n            filters: {},\r\n            fields: ['buyer']\r\n        },\r\n        callback: function(res) {\r\n\r\n            if (res.message) {\r\n\r\n                // Extract list\r\n                let buyers = res.message.map(row => row.buyer);\r\n\r\n                // Remove empty values\r\n                buyers = buyers.filter(x => x && x.trim() !== \"\");\r\n\r\n                // Make values unique\r\n                buyers = [...new Set(buyers)];\r\n\r\n                // Sort alphabetically (case insensitive)\r\n                buyers.sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));\r\n\r\n                console.log(\"Sorted Buyers:\", buyers);\r\n\r\n                // Set dropdown options\r\n                frm.set_df_property('buyer', 'options', buyers);\r\n\r\n                // Optional: If no buyers found\r\n                if (buyers.length === 0) {\r\n                    frappe.msgprint(\"No Buyers found in CB Request.\");\r\n                }\r\n            }\r\n        }\r\n    });\r\n\r\n    console.log(\"Form loaded: \", frm.docname);\r\n\r\n    if (!frm.is_new()) {\r\n        console.log(\"Incrementing open count for existing document\");\r\n        incrementOpenCountAndUpdateField(frm.docname, frm);\r\n    } else {\r\n        console.log(\"This is a new document\");\r\n    }\r\n},\r\n\r\n//     refresh: function(frm) {\r\n        \r\n//         \t\tfrm.fields_dict.veiw_cb_request.$input.addClass('btn-primary');\r\n\t\t\r\n// \t  frappe.call({\r\n//       method: 'frappe.client.get_list',\r\n//       args: {\r\n//          doctype: \"CB Request\",\r\n//         'filters': {\r\n//         },\r\n//         'fields': ['buyer']\r\n//       },\r\n//       callback: function(submittedProposalsResponse) {\r\n//         if (submittedProposalsResponse.message) {\r\n//           var submittedProposals = submittedProposalsResponse.message.map(function(proposal) {\r\n//             return proposal.buyer;\r\n//           });\r\n           \r\n//           console.log(\"** Submitted Proposals:\", submittedProposals);\r\n//           console.log(\"** Fetching Approved Quotations **\");\r\n//           frm.set_df_property('buyer', 'options', submittedProposals);\r\n           \r\n           \r\n//         //   frappe.call({\r\n//         //     method: 'frappe.client.get_list',\r\n//         //     args: {\r\n//         //       'doctype': 'CB Report',\r\n//         //       'filters': {\r\n//         //         status: 'Saved' \r\n//         //       },\r\n//         //       'fields': ['buyer']\r\n//         //     },\r\n//         //     callback: function(approvedQuotationsResponse) {\r\n//         //         console.log(approvedQuotationsResponse,\"approvedQuotationsResponse\")\r\n//         //       if (approvedQuotationsResponse.message) {\r\n//         //         var approvedQuotations = approvedQuotationsResponse.message.map(function(quotation) {\r\n//         //           return quotation.buyer;\r\n//         //         });\r\n//         //         console.log(\"** Approved Quotations:\", approvedQuotations);\r\n//         //         // Filter client names (include only proposals not in approved quotations)\r\n//         //         var filteredClientNames = submittedProposals.filter(function(proposal) {\r\n//         //           return !approvedQuotations.includes(proposal);\r\n//         //         });\r\n//         //         console.log(\"** Filtered Client Names:\", filteredClientNames);\r\n//         //           frm.set_df_property('buyer', 'options', filteredClientNames);\r\n//         //         // Set dropdown query with filtered names\r\n//         //       //  frm.set_query('client_name', function() {\r\n//         //         //  return {\r\n//         //          //   filters: {\r\n//         //           //    'name': ['in', filteredClientNames]\r\n//         //           // }\r\n//         //           //};\r\n//         //       // });\r\n//         //       }\r\n//         //     }\r\n//         //   }); // Close inner frappe.call\r\n//         }\r\n//       }\r\n//      // Close outer frappe.call\r\n// });\r\n\r\n\r\n\t  \r\n//         console.log(\"Form loaded: \", frm.docname);\r\n//         if (!frm.is_new()) {\r\n//             // Document is loaded from the database, increment and update the \"number\" field\r\n//             console.log(\"Incrementing open count for existing document\");\r\n//             incrementOpenCountAndUpdateField(frm.docname, frm);\r\n//         } else {\r\n//             console.log(\"This is a new document\");\r\n//         }\r\n//     },\r\n    \r\n    \t\r\n  buyer: function(frm) {\r\n      \r\n     frm.set_value('cb_request_number', '');\r\n     frm.set_value('reqdate', '');\r\n     frm.set_value('refnumber', '');\r\n     frm.set_value('policy_type', '');\r\n                \r\n    \r\n    //  // Get the selected quotation number\r\n    // let bond_facility_no = frm.doc.bond_facility_no;\r\n    \r\n     // Re-enable the dropdown field after selection\r\n        frm.toggle_enable('buyer', true);\r\n      \r\n      \r\n        var buyer = frm.doc.buyer;\r\n \r\n        // Fetch data from DCI Proposals based on selected client name\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'CB Request',\r\n                filters: {\r\n                    buyer: buyer\r\n                },\r\n                fields: ['cb_request_number', 'reqdate', 'refnumber','policy_type']\r\n            },\r\n            callback: function(response) {\r\n                console.log(\"DCI Proposals response:\", response);\r\n                if (response.message && response.message.length > 0) {\r\n                    var data_from_proposals = response.message[0];\r\n \r\n                    // Populate fields if data is found\r\n                    frm.set_value('cb_request_number', data_from_proposals.cb_request_number || '');\r\n                    frm.set_value('reqdate', data_from_proposals.reqdate || '');\r\n                    frm.set_value('refnumber', data_from_proposals.refnumber || '');\r\n                    frm.set_value('policy_type', data_from_proposals.policy_type || '');\r\n                } else {\r\n                    // Clear fields if no matching record found\r\n                    frm.set_value('cb_request_number', '');\r\n                    frm.set_value('reqdate', '');\r\n                    frm.set_value('refnumber', '');\r\n                    frm.set_value('policy_type', '');\r\n                    frappe.msgprint('No matching record found in DCI Proposals.');\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error(err);\r\n                frappe.msgprint('An error occurred while fetching data from DCI Proposals. Please check the console for details.');\r\n            }\r\n        });\r\n    },\r\n    \r\n  veiw_cb_request:function(frm){\r\n        \r\n         frappe.route_options = {\r\n                \r\n             company_name: frm.doc.buyer,\r\n             \r\n              //credit_limit:frm.doc.credit_limit,\r\n              //status:frm.doc.status,\r\n              //estd_date:frm.doc.captured_on\r\n            }, \r\n          frappe.new_doc('View CB Request  Form'); \r\n          \r\n          \r\n        \r\n          \r\n           \r\n          },\r\n\r\n});\r\n\r\nfunction incrementOpenCountAndUpdateField(docname, frm) {\r\n    // Retrieve open count from localStorage\r\n    var openCount = localStorage.getItem('open_count_' + docname);\r\n    if (openCount === null) {\r\n        console.log(\"Open count not found in localStorage, initializing to 0\");\r\n        openCount = 0;\r\n    } else {\r\n        openCount = parseInt(openCount);\r\n        console.log(\"Current open count retrieved from localStorage: \", openCount);\r\n    }\r\n\r\n    // Increment the open count\r\n    openCount += 1;\r\n    console.log(\"Incremented open count: \", openCount);\r\n\r\n    // Update open count in localStorage\r\n    localStorage.setItem('open_count_' + docname, openCount);\r\n\r\n    // Update the \"number\" field directly without marking form as dirty\r\n    frm.doc.number = openCount;\r\n    frm.refresh_field('number');\r\n    console.log(\"Updated 'number' field with open count: \", openCount);\r\n}\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Secure",
  "enabled": 1,
  "modified": "2024-06-27 10:41:40.749322",
  "module": null,
  "name": "Secure",
  "script": "frappe.ui.form.on('Secure', {\n\trefresh(frm) {\n\t\tfrm.fields_dict.amount.$input.css(\"text-align\", \"right\");\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Credit Note Internal Invoice",
  "enabled": 1,
  "modified": "2024-06-27 12:28:33.169701",
  "module": "Finance",
  "name": "internalinvoice",
  "script": "frappe.ui.form.on('Credit Note Internal Invoice', {\n\trefresh(frm) {\n\t    frm.fields_dict['currency4'].$wrapper.find('input').css(\"text-align\", \"right\");\n        \n\t \n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Internal Invoice for CI Invoice",
  "enabled": 1,
  "modified": "2025-11-28 12:32:30.814341",
  "module": null,
  "name": "Internal Invoice for CI Invoice script",
  "script": "frappe.ui.form.on(\"Internal Invoice for CI Invoice\", {\n    \n    //     reinsurer_commercial_amt(frm) {\n    //     frm.set_value(\"reinsurer_commercial_amt\", frm.doc.reinsurer_commercial_amt || 0);\n    // },\n\n    // reinsurer_political_amt(frm) {\n    //     frm.set_value(\"reinsurer_political_amt\", frm.doc.reinsurer_political_amt || 0);\n    // },\n    refresh(frm) {\n\n        frm.set_df_property('invioce_childtable', 'cannot_add_rows', true);\n        frm.set_value(\"percentage\", 100);\n        frm.refresh_fields();\n\n        // \u2705 If quotation number is empty -> hide child table & stop\n        if (!frm.doc.quotation_number) {\n            frm.clear_table(\"invioce_childtable\");\n            frm.refresh_field(\"invioce_childtable\");\n\n            // Hide child table\n            frm.toggle_display(\"invioce_childtable\", false);\n            return;\n        }\n\n        // If quotation number exists -> show child table and fetch data\n        frm.toggle_display(\"invioce_childtable\", true);\n\n        // Step 1: Check if quotation record exists\n     frappe.call({\n    method: \"frappe.client.get_list\",\n    args: {\n        doctype: \"ECI Quotations\",\n        filters: {\n            client_name: frm.doc.name1,\n            schedule_no: frm.doc.quotation_number\n        },\n        fields: [\"name\"]\n    },\n    callback: function(res) {\n\n        console.log(\"GET LIST Response:\", res);\n\n        if (!res.message || res.message.length === 0) {\n            console.log(\"No matching quotation found\");\n            frm.clear_table(\"invioce_childtable\");\n            frm.refresh_field(\"invioce_childtable\");\n            return;\n        }\n\n        let quotation_name = res.message[0].name;\n        console.log(\"Quotation found:\", quotation_name);\n\n        // Load full document\n        // frappe.call({\n        //     method: \"frappe.client.get\",\n        //     args: {\n        //         doctype: \"ECI Quotations\",\n        //         name: quotation_name\n        //     },\n        //     callback: function(r) {\n\n        //         console.log(\"Full Quotation:\", r);\n\n        //         if (!r.message || !r.message.eci_quo_table) {\n        //             console.log(\"Quotation has no child table\");\n        //             frm.clear_table(\"invioce_childtable\");\n        //             frm.refresh_field(\"invioce_childtable\");\n        //             return;\n        //         }\n\n        //         frm.clear_table(\"invioce_childtable\");\n\n        //         r.message.eci_quo_table.forEach(x => {\n        //             let child = frm.add_child(\"invioce_childtable\");\n        //             child.buyer = x.buyer_type;\n        //             child.country = x.country;\n        //             child.declamt = x.turnover;\n        //             child.commercial_perms = x.commpreamt;\n        //             child.political_perms = x.polpreamt;\n        //             child.commercial_perm1 = x.commprerate;\n        //             child.political_perms1 = x.polprerate;\n        //             child.total_perms = x.total_pre_amt;\n        //         });\n\n        //         frm.refresh_field(\"invioce_childtable\");\n        //         calculate_totals(frm);\n        //     }\n        // });\n        \n        frappe.call({\n    method: \"frappe.client.get\",\n    args: {\n        doctype: \"ECI Quotations\",\n        name: quotation_name\n    },\n    callback: function (r) {\n\n        console.log(\"Full Quotation:\", r);\n\n        if (!r.message || !r.message.eci_quo_table) {\n            console.log(\"Quotation has no child table\");\n            frm.clear_table(\"invioce_childtable\");\n            frm.refresh_field(\"invioce_childtable\");\n\n            // \u2705 HIDE SECTION ALSO IF NO DATA\n            frm.toggle_display(\"premium_income_section\", false);\n            return;\n        }\n\n        // \u2705 HIDE SECTION WHEN CHILD TABLE IS LOADED\n        frm.toggle_display(\"premium_income_section\", false);\n\n        frm.clear_table(\"invioce_childtable\");\n\n        r.message.eci_quo_table.forEach(x => {\n            let child = frm.add_child(\"invioce_childtable\");\n            child.buyer = x.buyer_type;\n            child.country = x.country;\n            child.declamt = x.turnover;\n            child.commercial_perms = x.commpreamt;\n            child.political_perms = x.polpreamt;\n            child.commercial_perm1 = x.commprerate;\n            child.political_perms1 = x.polprerate;\n            child.total_perms = x.total_pre_amt;\n        });\n\n        frm.refresh_field(\"invioce_childtable\");\n        calculate_totals(frm);\n    }\n});\n\n    }\n});\n\n\n frappe.call({\n    method: \"frappe.client.get_value\",\n    args: {\n        doctype: \"ECI Quotations\",\n        filters: {\n            schedule_no: frm.doc.quotation_number\n        },\n        fieldname: [\"com_pre_amt\",\"pol_pre_amt\",\"amt\",\"commercial\",\"political\",\"total\"]\n    },\n    callback: function(r) {\n        if (r.message) {\n            frm.set_value('commercial_perms_total', r.message.com_pre_amt || '');\n            frm.set_value('political_perms_total', r.message.pol_pre_amt || '');\n            frm.set_value('total_perms', r.message.amt || '');\n            frm.set_value('commercialbotswana_insurance_company', r.message.commercial || '');\n            frm.set_value('handlepoliticalamt', r.message.political || '');\n            frm.set_value('c29', r.message.total || '');\n            \n              frm.set_value('reinsurercommercialamt', r.message.com_pre_amt || '');\n            frm.set_value('reinsurerpoliticalamt', r.message.pol_pre_amt || '');\n                 \n        } else {\n            frm.set_value('commercial_perms_total', '');\n            frm.set_value('political_perms_total', '');\n            frm.set_value('total_perms', '');\n            frm.set_value('commercialbotswana_insurance_company', '');\n            frm.set_value('handlepoliticalamt', '');\n            frm.set_value('c29', '');\n        }\n    },\n    error: function(err) {\n        frappe.msgprint('Error while fetching.');\n    }\n});\n\nfrappe.call({\n    method: \"frappe.client.get_list\",\n    args: {\n        doctype: \"DCI Quotation\",\n        filters: {\n            client_name: frm.doc.name1,\n            schedule_no: frm.doc.quotation_number\n        },\n        fields: [\"name\"]\n    },\n    callback: function (res) {\n        if (res.message && res.message.length > 0) {\n            let quotation_name = res.message[0].name;\n\n            frappe.call({\n                method: \"frappe.client.get\",\n                args: { doctype: \"DCI Quotation\", name: quotation_name },\n                callback: function (r) {\n                    // Show only domesticdetails\n                    frm.toggle_display(\"exportdetails\", false);\n                    frm.toggle_display(\"political_reinsurance\", false);\n                    frm.toggle_display(\"domesticdetails\", true);\n\n                    frm.refresh_fields([\"exportdetails\", \"political_reinsurance\", \"domesticdetails\"]);\n                }\n            });\n        } else {\n            // No quotation found, hide all\n            frm.toggle_display(\"exportdetails\", false);\n            frm.toggle_display(\"political_reinsurance\", false);\n            frm.toggle_display(\"domesticdetails\", false);\n        }\n    }\n});\n\n\n\n\n//      frappe.call({\n//     method: \"frappe.client.get_list\",\n//     args: {\n//         doctype: \"DCI Quotation\",\n//         filters: {\n//             client_name: frm.doc.name1,\n//             schedule_no: frm.doc.quotation_number\n//         },\n//         fields: [\"name\"]\n//     },\n//     callback: function(res) {\n\n//         console.log(\"GET LIST Response:\", res);\n\n//         if (!res.message || res.message.length === 0) {\n//             console.log(\"No matching quotation found\");\n//             frm.clear_table(\"premium_income_section\");\n//             frm.refresh_field(\"premium_income_section\");\n//             return;\n//         }\n\n//         let quotation_name = res.message[0].name;\n//         console.log(\"Quotation found:\", quotation_name);\n\n//         // Load full document\n//         frappe.call({\n//             method: \"frappe.client.get\",\n//             args: {\n//                 doctype: \"DCI Quotation\",\n//                 name: quotation_name\n//             },\n//             callback: function(r) {\n\n//                 console.log(\"Full Quotation:\", r);\n\n//                 if (!r.message || !r.message.eci_quo_table) {\n//                     console.log(\"Quotation has no child table\");\n//                     frm.clear_table(\"premium_income_section\");\n//                     frm.refresh_field(\"premium_income_section\");\n//                     return;\n//                 }\n\n//                 // frm.clear_table(\"invioce_childtable\");\n\n//                 // r.message.eci_quo_table.forEach(x => {\n//                 //     let child = frm.add_child(\"invioce_childtable\");\n//                 //     child.buyer = x.buyer_type;\n//                 //     child.country = x.country;\n//                 //     child.declamt = x.turnover;\n//                 //     child.commercial_perms = x.commpreamt;\n//                 //     child.political_perms = x.polpreamt;\n//                 //     child.commercial_perm1 = x.commprerate;\n//                 //     child.political_perms1 = x.polprerate;\n//                 //     child.total_perms = x.total_pre_amt;\n//                 // });\n\n//                 // frm.refresh_field(\"invioce_childtable\");\n//                 // calculate_totals(frm);\n//             }\n//         });\n//     }\n// });\n\n\n//  frappe.call({\n//     method: \"frappe.client.get_value\",\n//     args: {\n//         doctype: \"ECI Quotations\",\n//         filters: {\n//             schedule_no: frm.doc.quotation_number\n//         },\n//         fieldname: [\"com_pre_amt\",\"pol_pre_amt\",\"amt\",\"commercial\",\"political\",\"total\"]\n//     },\n//     callback: function(r) {\n//         if (r.message) {\n//             frm.set_value('commercial_perms_total', r.message.com_pre_amt || '');\n//             frm.set_value('political_perms_total', r.message.pol_pre_amt || '');\n//             frm.set_value('total_perms', r.message.amt || '');\n//             frm.set_value('commercialbotswana_insurance_company', r.message.commercial || '');\n//             frm.set_value('handlepoliticalamt', r.message.political || '');\n//             frm.set_value('c29', r.message.total || '');\n            \n//               frm.set_value('reinsurercommercialamt', r.message.com_pre_amt || '');\n//             frm.set_value('reinsurerpoliticalamt', r.message.pol_pre_amt || '');\n                 \n//         } else {\n//             frm.set_value('commercial_perms_total', '');\n//             frm.set_value('political_perms_total', '');\n//             frm.set_value('total_perms', '');\n//             frm.set_value('commercialbotswana_insurance_company', '');\n//             frm.set_value('handlepoliticalamt', '');\n//             frm.set_value('c29', '');\n//         }\n//     },\n//     error: function(err) {\n//         frappe.msgprint('Error while fetching.');\n//     }\n// });\n\n\n    },\n    \n    \n    \n    \n});\n\n\n\n// function calculate_totals(frm) {\n//     const rows = frm.doc.invioce_childtable || [];\n\n//     const sumField = (field) => rows.reduce((total, row) => total + (parseFloat(row[field]) || 0), 0);\n\n//     // Totals from child table\n//     const totalCommercial = sumField(\"commercial_perm1\");\n//     const totalPolitical = sumField(\"political_perms1\");\n//     const totalPerms = sumField(\"total_perms\");\n\n//     // Update parent fields\n//     frm.set_value(\"commercial_perms_total\", totalCommercial);\n//     frm.set_value(\"political_perms_total\", totalPolitical);\n//     frm.set_value(\"total_perms\", totalPerms);\n\n//     // Copy totals to reinsurance section\n//     frm.set_value(\"reinsurercommercialamt\", totalCommercial);\n//     frm.set_value(\"reinsurerpoliticalamt\", totalPolitical);\n//     frm.set_value(\"handlepoliticalamt\", totalPolitical);\n//     frm.set_value(\"commercialbotswana_insurance_company\", totalCommercial);\n\n//     // Always keep percentage at 100\n//     frm.set_value(\"percentage\", 100);\n\n//     frm.refresh_fields();\n// }\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Print Internal Invoice",
  "enabled": 1,
  "modified": "2024-07-03 09:03:51.369518",
  "module": null,
  "name": "Print Internal Invoice script",
  "script": "frappe.ui.form.on('Print Internal Invoice', {\n\trefresh(frm) {\n\t    \nfrm.fields_dict.guarantee_amount.$input.css(\"text-align\", \"right\");\n\nfrm.fields_dict.rate.$input.css(\"text-align\", \"right\");\n\nfrm.fields_dict.premiumpula.$input.css(\"text-align\", \"right\");\n\nfrm.fields_dict.sub_total.$input.css(\"text-align\", \"right\");\n\nfrm.fields_dict.vat__14_.$input.css(\"text-align\", \"right\");\n\nfrm.fields_dict.total_due.$input.css(\"text-align\", \"right\");\n\n\n\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Print External Invoice",
  "enabled": 1,
  "modified": "2024-07-03 09:07:38.007946",
  "module": null,
  "name": "Print External Invoice script",
  "script": "frappe.ui.form.on('Print External Invoice', {\n\trefresh(frm) {\n\t    \nfrm.fields_dict.amount3.$input.css(\"text-align\", \"right\");\n\nfrm.fields_dict.amount4.$input.css(\"text-align\", \"right\");\n\nfrm.fields_dict.amount5.$input.css(\"text-align\", \"right\");\n\nfrm.fields_dict.amount6.$input.css(\"text-align\", \"right\");\n\nfrm.fields_dict.amount7.$input.css(\"text-align\", \"right\");\n\nfrm.fields_dict.amount9.$input.css(\"text-align\", \"right\");\n\nfrm.fields_dict.amount10.$input.css(\"text-align\", \"right\");\n\nfrm.fields_dict.amount11.$input.css(\"text-align\", \"right\");\n\nfrm.fields_dict.amount12.$input.css(\"text-align\", \"right\");\n\nfrm.fields_dict.amount13.$input.css(\"text-align\", \"right\");\n\nfrm.fields_dict.amount14.$input.css(\"text-align\", \"right\");\n\nfrm.fields_dict.per.$input.css(\"text-align\", \"right\");\n\nfrm.fields_dict.curr.$input.css(\"text-align\", \"right\");\n\nfrm.fields_dict.amount15.$input.css(\"text-align\", \"right\");\n\n\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "DCI Quotation",
  "enabled": 1,
  "modified": "2025-12-05 08:26:46.792556",
  "module": "Marketing",
  "name": "DCI Quotation",
  "script": "frappe.ui.form.on('DCI Quotation', {\nonload: function(frm) {\n        if (!frm.doc.schedule_no) {\n            generateNumber(frm);\n        }\n\n        // Fetch all client names from submitted proposals\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                'doctype': 'DCI Proposals',\n                'filters': {\n                    'workflow_state': 'Submitted'\n                },\n                'fields': ['client_name'],\n                 limit_page_length: 20000  // Adjust this value as needed\n\n            },\n        callback: function(response) {\n            console.log(\"client_name received:\", response);\n            let DataArray = response.message;\n            let uniqueclientnames = new Set();\n \n            // Collect unique facility_no values\n            for (let x of DataArray) {\n                uniqueclientnames.add(x.client_name);\n            }\n \n            // Convert set to array\n            let FinalArray = Array.from(uniqueclientnames);\n            \n            FinalArray.sort();\n \n            frm.set_df_property('client_name', 'options', FinalArray);\n            console.log(\"final\", FinalArray);\n        },\n        error: function(xhr, textStatus, errorThrown) {\n            console.error(\"Error fetching client_name:\", textStatus, errorThrown);\n        }    \n        \n            \n        });\n \t\n \t\n \t//added on 11/11/2025\n         var workflow_state = frm.doc.workflow_state;\n\n        // Check if the workflow state is \"Approved\"\n        if (workflow_state === \"Approved\" || workflow_state === \"Pending\") {\n            // Show policy_holder1 field and hide policy_holder field\n            frm.toggle_display('proposal_no2', true);\n            frm.toggle_display('proposal_no1', false);\n        } else {\n            // If workflow state is not \"Approved\", reverse the display\n            frm.toggle_display('proposal_no2', false);\n            frm.toggle_display('proposal_no1', true);\n        }\n    \n      \n    },\n    \nclient_name: function(frm) {\n\n        //  if (frm.doc.client_name) {\n\n            frappe.call({\n\n                method: 'frappe.client.get_list',\n\n                args: {\n\n                    doctype: 'DCI Proposals', \n\n                    filters: {\n\n                        'client_name': frm.doc.client_name\n\n                    },\n\n                fields:['proposal_no']  \n\n                },\n\n                callback: function(response) {\n                    console.log(\"Response:\", response); // Check response from server\n\n                    if (response.message && response.message.length > 0) {\n                        var proposalNumbers = response.message.map(item => item.proposal_no);\n                        console.log(\"proposal Numbers:\", proposalNumbers); // Check policy numbers fetched\n\n                        // Update dropdown field options\n                        frm.set_df_property('proposal_no1', 'options', proposalNumbers.join('\\n'));\n                        frm.refresh_field('proposal_no1'); // Refresh dropdown field\n                    } else {\n                        // Clear dropdown field options if no data found\n                        frm.set_df_property('proposal_no1', 'options', '');\n                        frm.refresh_field('proposal_no1'); // Refresh dropdown field\n                    }\n                },\n\n            });\n\n},\n\n\n proposal_no1: function(frm) {\n        console.log(\"Fetching details for proposal_no1...\");\n\n        var ProposalNo = frm.doc.proposal_no1;\n        frm.set_value('proposal_no2', ProposalNo);\n\n        // Fetch data from DCI Proposals\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'DCI Proposals',\n                filters: { proposal_no: ProposalNo },\n                fields: ['total_debtors', 'total_bad_debt', 'total_turnover', 'year_count', 'status', 'signed_on']\n            },\n            callback: function(response) {\n                console.log(\"DCI Proposals response:\", response);\n\n                if (response.message && response.message.length > 0) {\n                    var data_from_proposals = response.message[0];\n\n                    // Always display these fields\n                    frm.set_value('total_no_of_debtors', data_from_proposals.total_debtors || '');\n                    frm.set_value('status11', data_from_proposals.status || '');\n                    frm.set_value('captured_on', data_from_proposals.signed_on || '');\n\n                    var totalBadDebt = flt(data_from_proposals.total_bad_debt || 0);\n                    var totalTurnover = flt(data_from_proposals.total_turnover || 0);\n                    var yearCount = flt(data_from_proposals.year_count || 0);\n\n                    console.log('Total Bad Debt:', totalBadDebt);\n                    console.log('Total Turnover:', totalTurnover);\n                    console.log('Year Count:', yearCount);\n\n                    // ---------------- LOSS RATIO ----------------\n                    var lossRatio = 0;\n                    if (totalTurnover !== 0) {\n                        lossRatio = (totalBadDebt / totalTurnover) * 100;\n                    }\n                    frm.set_value('loss_ratio', lossRatio);\n\n                    // ---------------- AVERAGE BAD DEBTS ----------------\n                    let totalBadDebtsPerYear = flt(frm.doc.total_bad_debt || 0);\n                    \n                                        // let totalBadDebtsPerYear = flt(frm.doc.total_bad_debts_per_year || 0);\n\n                    let appActBdtValue = flt(frm.doc.app_act_bdt_value || 0);\n                    \n                    \n                                        // let appActBdtValue = flt(frm.doc.app_act_bdt_value || 0);\n\n                    \n                    let appBdtLossMonths = flt(frm.doc.app_bdt_loss_months || 0);\n                    \n                    \n                                        // let appBdtLossMonths = flt(frm.doc.app_bdt_loss_months || 0);\n\n                    \n\n                    let currentLossAnnualized = 0;\n                    if (appBdtLossMonths > 0) {\n                        currentLossAnnualized = (appActBdtValue / appBdtLossMonths) * 12;\n                    }\n\n                    let avgBadDebts = (totalBadDebtsPerYear + currentLossAnnualized) / (yearCount + 1);\n                    frm.set_value('average_bad_debts', avgBadDebts);\n                    frm.set_value('average_bad_debt_per_year', avgBadDebts);\n\n                    // ---------------- CHECK APPROVAL STATUS ----------------\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'DCI Quotation',\n                            filters: {\n                                proposal_no1: ProposalNo,\n                                workflow_state: 'Approved'\n                            },\n                            fields: ['proposal_no1']\n                        },\n                        callback: function(approvedResponse) {\n                            if (approvedResponse.message && approvedResponse.message.length > 0) {\n                                frappe.msgprint('\u26a0\ufe0f This proposal_no is already approved.');\n                            }\n\n                            // Run all dependent calculations\n                            calculateAll(frm);\n                        }\n                    });\n                } else {\n                    // Clear fields if no matching record\n                    frm.set_value('total_no_of_debtors', '');\n                    frm.set_value('status11', '');\n                    frm.set_value('captured_on', '');\n                    frm.set_value('loss_ratio', '');\n                    frm.set_value('average_bad_debts', '');\n                    frm.set_value('average_bad_debt_per_year', '');\n                }\n\n                // Refresh additional proposal data\n                fetchProposalData(frm);\n            }\n        });\n    },\n\nrefresh: function(frm) {\n    \n// // \u2705 Add this part ONLY (removes tooltip for all fields)\n//         setTimeout(() => {\n//             frm.$wrapper.find('[title]').removeAttr('title');\n//         }, 300);\n\n\nconst observer = new MutationObserver(() => {\n    $('[title]').removeAttr('title');\n});\n\nobserver.observe(cur_frm.$wrapper[0], {\n    attributes: true,\n    childList: true,\n    subtree: true\n});\n\n        \n        \n        // Attach click event handler to the underlined words\n        $('p.underlined a').on('click', function(event) {\n            event.preventDefault();\n            var linkText = $(this).text().trim();\n\n            // Check if the workflow state is 'Approved'\n            if (frm.doc.workflow_state !== 'Approved') {\n                frappe.msgprint('The document must be approved to perform this action.');\n                return;\n            }\n\n            switch (linkText) {\n                case 'Addendum and Endorsements to the policy':\n                    openNewDocument('Addendum and Endorsements to the policy', frm);\n                  // createAddendumDocument(frm);\n                    break;\n                   case 'Covering Letters':\n                    createCoveringLetter(frm);\n                    break;\n                case 'Schedule (Goods/Services)':\n                    openNewDocument('Schedule Goods and Services DCI', frm);\n                    break;\n                case 'Specimen Policy Documents':\n                    openNewDocument('Specimen Policy Documents', frm);\n                    break;\n                 // handle both possible anchor texts just in case\n                case 'Consent Form':\n                case 'Consent Form-DCIQuotation':\n                    createConsentForm(frm);\n                    break;\n                case 'Acceptance Form':\n                    openNewDocument('Acceptance Form DCI Quotation', frm);\n                    break;\n                case 'Guide to the Administration of the policy':\n                    openNewDocument('Guide to the Administration of the Policy', frm);\n                    break;\n                    //---------------------\n                    case 'Policy Quotation':\n                    openNewDocument('Policy Quotation DCI', frm);\n                    break;\n                    case 'Compact Policy':\n                    openNewDocument('Compact Policy DCI Quotation', frm);\n                    break;\n                default:\n                    console.log(\"No action defined for\", linkText);\n            }\n        });\n        \n\n// premium values from dci proposal\n\n\n        // if (!frm.doc.__islocal) {\n        //     // Document is already saved, so fetch data from 'DCI Proposals' and populate fields\n        //     fetchProposalData(frm);\n        // }\n\n\n    frm.fields_dict['possible_declines_as_'].df.onchange = () => {\n    console.log(\"possible_declines_as_ onchange triggered\");\n    var possible = parseFloat(frm.doc.possible_declines_as_);\n    console.log(\"possible:\", possible);\n    frm.doc.possible_declines_by_beci = possible;\n    frm.refresh_field('possible_declines_by_beci');\n            \n                };\n\n\nfrm.fields_dict.expected_turnover.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.estimated_govt_sales_plus_cash_sales.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.total_no_of_debtors.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.limit_of_discretion.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.franchise_loss.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.loss_ratio.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.buyers_excluded.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.of_the_turnover.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.possible_declines_as_.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.insured_turnover.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.expected_insured_turnover.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.admin_cost_per_buyer.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.average_bad_debts.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.break_evenpoint.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.total_credit_sale_cost.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.cost_ratio.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.beci_margin_on_cost_ratio.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.premium_rate.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.min_annual_premium.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.expected_annual_premium.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.premium_deposit.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.maximum_liability.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.fee_per_enquiry.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.fee_for_cl_per_month.$input.css(\"text-align\", \"right\");\n\n// options \nfrm.fields_dict.of_the_turnover_options.$input.css(\"text-align\", \"right\");\n\nfrm.fields_dict.expected_turnover_2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.possible_declines_by_beci.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.expected_insured_turnover_2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.expected_premium_income.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.estimated_govt_sales__plus_cash_sales.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.average_bad_debt_per_year.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.expected_profitloss_on_account.$input.css(\"text-align\", \"right\");\n\nfrm.fields_dict.upfront_discount.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.proposed_prem_rate_after_discount.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.expected_prem_at_std.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.discount_offered.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.resultant_prem_income.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.allowable_claim_value.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.of_premium_received.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.premreceived_net_of_claims.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.retrospective_discount.$input.css(\"text-align\", \"right\");\nfrm.fields_dict._net_premium_received.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.beci_profitloss_on_account.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.total_discount_given.$input.css(\"text-align\", \"right\");\n\nfrm.fields_dict.upfront_discount2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.proposed_prem_rate_after_discount2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.expected_prem_at_std2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.discount_offered2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.resultant_prem_income2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.allowable_claim_value2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.of_premium_received2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.premreceived_net_of_claims2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.retrospective_discount2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict._net_premium_received2.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.beci_profitloss_on_account_.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.total_discount_given2.$input.css(\"text-align\", \"right\");\n\n\n//added on 11/11/2025\n\n// var workflow_state = frm.doc.workflow_state;\n//         if (workflow_state === \"Approved\" || workflow_state === \"Pending\") {\n//             frm.toggle_display('proposal_no2', true);\n//             frm.toggle_display('proposal_no1', false);}\n//             else {\n//             // If workflow state is not \"Approved\", reverse the display\n//             frm.toggle_display('proposal_no1', true);\n//             frm.toggle_display('proposal_no2', false);\n//         }\n\n \n\n        },\n        \n        \n//changed on 11/11/2025        \n//min_annual_premium: function(frm) {\n\nproposal_no2: function(frm) {\n        var proposalNo = frm.doc.proposal_no2;\n\n        // Check if proposal number is provided\n        if (proposalNo) {\n            frappe.call({\n                method: 'frappe.client.get',\n                args: {\n                    doctype: 'DCI Proposals',\n                    filters: {\n                        proposal_no: proposalNo\n                    }\n                },\n                callback: function(response) {\n                    if (response.message) {\n                        var proposal = response.message;\n\n                        // List of fields to synchronize\n                        var fieldsToSync = [\n                            'agriculture',\n                            'airconditioning',\n                            'aluminium_boats',\n                            'animal_vaccines',\n                            'arts_crafts',\n                            'batteries',\n                            'building_materials',\n                            'canning_cans',\n                            'cellular',\n                            'cereals',\n                            'cigarettes',\n                            'computer_electronic',\n                            'concrete_products',\n                            'corporate_clothing',\n                            'cosmetics',\n                            'couriers',\n                            'engraving',\n                            'fmcg',\n                            'frozen_chicken',\n                            'fuel',\n                            'gas',\n                            'hair_products',\n                            'heavy_plant',\n                            'invoice_factoring',\n                            'leather_products',\n                            'logistics',\n                            'lubricants__fuel',\n                            'meat_products',\n                            'media__radio',\n                            'merchandise',\n                            'packaging_materials',\n                            'perishable_goods',\n                            'pharmaceuticals',\n                            'plastic_and_spices',\n                            'road_construction',\n                            'salt',\n                            'security_services',\n                            'soda_ash',\n                            '_diaries',\n                            'steel_doors_window_farmes',\n                            'steel_merchants',\n                            'timber_products',\n                            'travelling_bags',\n                            'water_supplies'\n                        ];\n// Synchronize fields from DCI Proposals to goods_services field in DCI Quotations\nvar goods_services = '';\n\nfieldsToSync.forEach(function(fieldName) {\n    if (proposal[fieldName]) {\n        goods_services += fieldName + ', ';\n    }\n});\n\n// Remove trailing comma and space\ngoods_services = goods_services.slice(0, -2);\n\n// Set the value of goods_services field in DCI Quotations\nfrm.set_value('goods_services', goods_services);\n\n\n                    }\n                }\n            });\n        }\n    },\n    \n    \n    \n\n    \ncalculate2: function(frm) {\n\n        try {\n\n            // Common premium income and premium rate\n            let prem_income = flt(frm.doc.expected_prem_invoice);\n            let prem_rate = flt(frm.doc.premium_rate);\n\n            // ---------------------- OPTION 1 --------------------------\n\n            // Upfront Discount Option1\n            let upfront_discount = flt(frm.doc.upfront_discount);\n            let proposed_prem_rate_after_discount =\n                prem_rate - (prem_rate * upfront_discount / 100);\n\n            frm.set_value(\"proposed_prem_rate_after_discount\",\n                proposed_prem_rate_after_discount.toFixed(2));\n\n            // Discount Offered Option1\n            let expected_prem_at_std = prem_income;\n            frm.set_value(\"expected_prem_at_std\", expected_prem_at_std.toFixed(2));\n\n            let discount_offered =\n                expected_prem_at_std * upfront_discount / 100;\n            frm.set_value(\"discount_offered\", discount_offered.toFixed(2));\n\n            // Resultant Premium Income Option1\n            let resultant_prem_income =\n                expected_prem_at_std - discount_offered;\n            frm.set_value(\"resultant_prem_income\",\n                resultant_prem_income.toFixed(2));\n\n            // Allowable Claim Percentage Option1\n            let allowable_claim_value = flt(frm.doc.allowable_claim_value);\n            let of_premium_received =\n                resultant_prem_income * allowable_claim_value / 100;\n            frm.set_value(\"of_premium_received\", of_premium_received.toFixed(2));\n\n            // Premium Net Claims Option1\n            let premreceived_net_of_claims =\n                resultant_prem_income - of_premium_received;\n            frm.set_value(\"premreceived_net_of_claims\",\n                premreceived_net_of_claims.toFixed(2));\n\n            // Retrospective Discount Option1\n            let retrospective_discount = flt(frm.doc.retrospective_discount);\n            let _net_premium_received =\n                premreceived_net_of_claims * retrospective_discount / 100;\n            frm.set_value(\"_net_premium_received\",\n                _net_premium_received.toFixed(2));\n\n            // BECI Profit Loss Option1\n            let credsure_profitloss_on_account =\n                premreceived_net_of_claims - _net_premium_received;\n            frm.set_value(\"credsure_profitloss_on_account\",\n                credsure_profitloss_on_account.toFixed(2));\n\n            // Total Discount Option1\n            let total_discount_given =\n                discount_offered + of_premium_received + _net_premium_received;\n            frm.set_value(\"total_discount_given\",\n                total_discount_given.toFixed(2));\n\n\n            // ---------------------- OPTION 2 --------------------------\n\n            // Upfront Discount Option2\n            let upfront_discount2 = flt(frm.doc.upfront_discount2);\n            let proposed_prem_rate_after_discount2 =\n                prem_rate - (prem_rate * upfront_discount2 / 100);\n\n            frm.set_value(\"proposed_prem_rate_after_discount2\",\n                proposed_prem_rate_after_discount2.toFixed(2));\n\n            // Discount Offered Option2\n            let expected_prem_at_std2 = prem_income;\n            frm.set_value(\"expected_prem_at_std2\", expected_prem_at_std2.toFixed(2));\n\n            let discount_offered2 =\n                expected_prem_at_std2 * upfront_discount2 / 100;\n            frm.set_value(\"discount_offered2\", discount_offered2.toFixed(2));\n\n            // Resultant Premium Income Option2\n            let resultant_prem_income2 =\n                expected_prem_at_std2 - discount_offered2;\n            frm.set_value(\"resultant_prem_income2\",\n                resultant_prem_income2.toFixed(2));\n\n            // Allowable Claim Percentage Option2\n            let allowable_claim_value2 = flt(frm.doc.allowable_claim_value2);\n            let of_premium_received2 =\n                resultant_prem_income2 * allowable_claim_value2 / 100;\n            frm.set_value(\"of_premium_received2\", of_premium_received2.toFixed(2));\n\n            // Premium Net Claims Option2\n            let premreceived_net_of_claims2 =\n                resultant_prem_income2 - of_premium_received2;\n            frm.set_value(\"premreceived_net_of_claims2\",\n                premreceived_net_of_claims2.toFixed(2));\n\n            // Retrospective Discount Option2\n            let retrospective_discount2 = flt(frm.doc.retrospective_discount2);\n            let _net_premium_received2 =\n                premreceived_net_of_claims2 * retrospective_discount2 / 100;\n            frm.set_value(\"_net_premium_received2\",\n                _net_premium_received2.toFixed(2));\n\n            // BECI Profit Loss Option2\n            let credsure_profitloss_on_account_ =\n                premreceived_net_of_claims2 - _net_premium_received2;\n            frm.set_value(\"credsure_profitloss_on_account_\",\n                credsure_profitloss_on_account_.toFixed(2));\n\n            // Total Discount Option2\n            let total_discount_given2 =\n                discount_offered2 + of_premium_received2 + _net_premium_received2;\n            frm.set_value(\"total_discount_given2\",\n                total_discount_given2.toFixed(2));\n\n        } catch (e) {\n            console.log(\"Calculation Error:\", e);\n        }\n    },\n    \n    \n// calculate3: async function(frm) {\n//         try {\n//             frappe.show_alert({ message: __('\ud83e\uddee Running Premium Calculation...'), indicator: 'blue' });\n\n//             const v = (x) => isNaN(parseFloat(x)) ? 0 : parseFloat(x);\n//             let expectedTurnover = v(frm.doc.expected_turnover);\n//             let estGovtCashSales = v(frm.doc.estimated_govt_sales_plus_cash_sales);\n//             let declinePer = v(frm.doc.possible_declines_as_);\n//             let insuredTvr = v(frm.doc.insured_turnover);\n//             let noOfBuyers = v(frm.doc.total_no_of_debtors);\n//             let buyersExcluded = v(frm.doc.buyers_excluded);\n//             let adminCostPB = v(frm.doc.admin_cost_per_buyer);\n//             let avgBadDebts = v(frm.doc.average_bad_debts);\n//             let beciMargin = v(frm.doc.beci_margin_on_cost_ratio);\n//             let proposalNo = frm.doc.proposal_no1 || frm.doc.proposal_no2;\n\n//             let deduct = 0, expectedInsuredTurnover = 0, breakEvenPoint = 0, totalCreditSalesCost = 0;\n//             let costRatio = 0, premiumRate = 0, maxPremium = 0, actPremiumDep = 0;\n//             let outsValue = 0;\n\n//             // await frappe.call({\n//             //     method: \"frappe.client.get_list\",\n//             //     args: {\n//             //         doctype: \"trn_app_prn_buyer_outs\",\n//             //         filters: { apb_app_num: ['like', proposalNo] },\n//             //         fields: [\"apb_outs_value\"],\n//             //         limit_page_length: 1000\n//             //     },\n//             //     callback: function(r) {\n//             //         if (r.message && r.message.length > 0)\n//             //             outsValue = Math.max(...r.message.map(x => v(x.apb_outs_value)));\n//             //     }\n//             // });\n\n//             deduct = (expectedTurnover - estGovtCashSales) * (declinePer / 100);\n//             frm.set_value('of_the_turnover', deduct.toFixed(2));\n\n//             expectedInsuredTurnover = expectedTurnover - (estGovtCashSales + deduct);\n//             frm.set_value('expected_insured_turnover', expectedInsuredTurnover.toFixed(2));\n\n//             breakEvenPoint = (noOfBuyers - buyersExcluded) * adminCostPB;\n//             frm.set_value('break_evenpoint', breakEvenPoint.toFixed(2));\n\n//             totalCreditSalesCost = breakEvenPoint + avgBadDebts;\n//             frm.set_value('total_credit_sale_cost', totalCreditSalesCost.toFixed(2));\n\n//             costRatio = expectedInsuredTurnover ? (totalCreditSalesCost / expectedInsuredTurnover) * 100 : 0;\n//             frm.set_value('cost_ratio', costRatio.toFixed(2));\n\n//             premiumRate = costRatio + beciMargin;\n//             frm.set_value('premium_rate', premiumRate.toFixed(4));\n\n//             // let minPremiumFromMaster = 0;\n//             // await frappe.call({\n//             //     method: \"frappe.client.get_list\",\n//             //     args: {\n//             //         doctype: \"mst_minimumDepositPremium\",\n//             //         fields: [\"exp_min_Premium\"],\n//             //         limit_page_length: 1\n//             //     },\n//             //     callback: function(r) {\n//             //         if (r.message && r.message.length > 0)\n//             //             minPremiumFromMaster = v(r.message[0].exp_min_Premium);\n//             //     }\n//             // });\n\n//             maxPremium = insuredTvr === 0\n//                 ? (premiumRate * expectedInsuredTurnover) / 100\n//                 : (premiumRate * insuredTvr) / 100;\n\n//             frm.set_value('expected_annual_premium', maxPremium.toFixed(2));\n//             frm.set_value('min_annual_premium', maxPremium.toFixed(2));\n\n//             actPremiumDep = Math.max(maxPremium, minPremiumFromMaster);\n//             frm.set_value('premium_deposit', actPremiumDep.toFixed(2));\n\n//             let maxValue = actPremiumDep * 25;\n//             frm.set_value('maximum_liability', (maxValue >= outsValue ? maxValue : outsValue).toFixed(2));\n\n//             frm.refresh_fields();\n\n//             frappe.show_alert({\n//                 message: __('\u2705 Premium calculation completed successfully.'),\n//                 indicator: 'green'\n//             });\n//         } catch (err) {\n//             frappe.msgprint(__('\u26a0\ufe0f Error during calculation: ') + err.message);\n//             console.error(err);\n//         }\n//     },\n\n    \nstatus11: function(frm) {\n    \n         var ProposalNo = frm.doc.proposal_no1;  \n        // Check if client name is provided\n        if (ProposalNo) {\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'DCI Proposals',\n                    filters: {\n                        proposal_no: ProposalNo\n                    },\n                    fields: [ // Place DCI Proposals fields here\n                        'name',\n                        'agriculture',\n                        'airconditioning',\n                        'aluminium_boats',\n                        'animal_vaccines',\n                        'arts_crafts',\n                        'batteries',\n                        'building_materials',\n                        'canning_cans',\n                        'cellular',\n                        'cereals',\n                        'cigarettes',\n                        'computer_electronic',\n                        'concrete_products',\n                        'corporate_clothing',\n                        'cosmetics',\n                        'couriers',\n                        'engraving',\n                        'fmcg',\n                        'frozen_chicken',\n                        'fuel',\n                        'gas',\n                        'hair_products',\n                        'heavy_plant',\n                        'invoice_factoring',\n                        'leather_products',\n                        'logistics',\n                        'lubricants__fuel',\n                        'meat_products',\n                        'media__radio', // Ensure this field is properly placed\n                        'merchandise',\n                        'packaging_materials',\n                        'perishable_goods',\n                        'pharmaceuticals',\n                        'plastic_and_spices',\n                        'road_construction',\n                        'salt',\n                        'security_services',\n                        'soda_ash',\n                        '_diaries',\n                        'steel_doors_window_farmes',\n                        'steel_merchants',\n                        'timber_products',\n                        'travelling_bags',\n                        'water_supplies'\n                    ]\n                },\n                callback: function(response) {\n                    if (!response.exc) {\n                        var proposals = response.message;\n\n                        if (proposals.length > 0) {\n                            var proposal = proposals[0];\n                            // Synchronize fields from ECI Proposal to ECI Quotations\n                            frm.set_value(\"agriculture\", proposal.agriculture ? 1 : 0);\n                            frm.set_value(\"airconditioning\", proposal.airconditioning ? 1 : 0);\n                            frm.set_value(\"aluminium_boats\", proposal.aluminium_boats ? 1 : 0);\n                            frm.set_value(\"animal_vaccines\", proposal.animal_vaccines ? 1 : 0);\n                            frm.set_value(\"arts_crafts\", proposal.arts_crafts ? 1 : 0);\n                            frm.set_value(\"batteries\", proposal.batteries ? 1 : 0);\n                            frm.set_value(\"building_materials\", proposal.building_materials ? 1 : 0);\n                            frm.set_value(\"canning_cans\", proposal.canning_cans ? 1 : 0);\n                            frm.set_value(\"cellular\", proposal.cellular ? 1 : 0);\n                            frm.set_value(\"cereals\", proposal.cereals ? 1 : 0);\n                            frm.set_value(\"cigarettes\", proposal.cigarettes ? 1 : 0);\n                            frm.set_value(\"computer_electronic\", proposal.computer_electronic ? 1 : 0);\n                            frm.set_value(\"concrete_products\", proposal.concrete_products ? 1 : 0);\n                            frm.set_value(\"corporate_clothing\", proposal.corporate_clothing ? 1 : 0);\n                            frm.set_value(\"cosmetics\", proposal.cosmetics ? 1 : 0);\n                            frm.set_value(\"couriers\", proposal.couriers ? 1 : 0);\n                            frm.set_value(\"engraving\", proposal.engraving ? 1 : 0);\n                            frm.set_value(\"fmcg\", proposal.fmcg ? 1 : 0);\n                            frm.set_value(\"frozen_chicken\", proposal.frozen_chicken ? 1 : 0);\n                            frm.set_value(\"fuel\", proposal.fuel ? 1 : 0);\n                            frm.set_value(\"gas\", proposal.gas ? 1 : 0);\n                            frm.set_value(\"hair_products\", proposal.hair_products ? 1 : 0);\n                            frm.set_value(\"heavy_plant\", proposal.heavy_plant ? 1 : 0);\n                            frm.set_value(\"invoice_factoring\", proposal.invoice_factoring ? 1 : 0);\n                            frm.set_value(\"leather_products\", proposal.leather_products ? 1 : 0);\n                            frm.set_value(\"logistics\", proposal.logistics ? 1 : 0);\n                            frm.set_value(\"lubricants__fuel\", proposal.lubricants__fuel ? 1 : 0);\n                            frm.set_value(\"meat_products\", proposal.meat_products ? 1 : 0);\n                            frm.set_value(\"media__radio\", proposal.media__radio ? 1 : 0); // Corrected field name\n                            frm.set_value(\"merchandise\", proposal.merchandise ? 1 : 0);\n                            frm.set_value(\"packaging_materials\", proposal.packaging_materials ? 1 : 0);\n                            frm.set_value(\"perishable_goods\", proposal.perishable_goods ? 1 : 0);\n                            frm.set_value(\"pharmaceuticals\", proposal.pharmaceuticals ? 1 : 0);\n                            frm.set_value(\"plastic_and_spices\", proposal.plastic_and_spices ? 1 : 0);\n                            frm.set_value(\"road_construction\", proposal.road_construction ? 1 : 0);\n                            frm.set_value(\"salt\", proposal.salt ? 1 : 0);\n                            frm.set_value(\"security_services\", proposal.security_services ? 1 : 0);\n                            frm.set_value(\"soda_ash\", proposal.soda_ash ? 1 : 0);\n                            frm.set_value(\"_diaries\", proposal._diaries ? 1 : 0);\n                            frm.set_value(\"steel_doors_window_farmes\", proposal.steel_doors_window_farmes ? 1 : 0);\n                            frm.set_value(\"steel_merchants\", proposal.steel_merchants ? 1 : 0);\n                            frm.set_value(\"timber_products\", proposal.timber_products ? 1 : 0);\n                            frm.set_value(\"travelling_bags\", proposal.travelling_bags ? 1 : 0);\n                            frm.set_value(\"water_supplies\", proposal.water_supplies ? 1 : 0);\n                            \n                            // Toggle display of fields based on checkbox values\n                            frm.toggle_display(\"agriculture\", proposal.agriculture ? 1 : 0);\n                            frm.toggle_display(\"airconditioning\", proposal.airconditioning ? 1 : 0);\n                            frm.toggle_display(\"aluminium_boats\", proposal.aluminium_boats ? 1 : 0);\n                            frm.toggle_display(\"animal_vaccines\", proposal.animal_vaccines ? 1 : 0);\n                            frm.toggle_display(\"arts_crafts\", proposal.arts_crafts ? 1 : 0);\n                            frm.toggle_display(\"batteries\", proposal.batteries ? 1 : 0);\n                            frm.toggle_display(\"building_materials\", proposal.building_materials ? 1 : 0);\n                            frm.toggle_display(\"canning_cans\", proposal.canning_cans ? 1 : 0);\n                            frm.toggle_display(\"cellular\", proposal.cellular ? 1 : 0);\n                            frm.toggle_display(\"cereals\", proposal.cereals ? 1 : 0);\n                            frm.toggle_display(\"cigarettes\", proposal.cigarettes ? 1 : 0);\n                            frm.toggle_display(\"computer_electronic\", proposal.computer_electronic ? 1 : 0);\n                            frm.toggle_display(\"concrete_products\", proposal.concrete_products ? 1 : 0);\n                            frm.toggle_display(\"corporate_clothing\", proposal.corporate_clothing ? 1 : 0);\n                            frm.toggle_display(\"cosmetics\", proposal.cosmetics ? 1 : 0);\n                            frm.toggle_display(\"couriers\", proposal.couriers ? 1 : 0);\n                            frm.toggle_display(\"engraving\", proposal.engraving ? 1 : 0);\n                            frm.toggle_display(\"fmcg\", proposal.fmcg ? 1 : 0);\n                            frm.toggle_display(\"frozen_chicken\", proposal.frozen_chicken ? 1 : 0);\n                            frm.toggle_display(\"fuel\", proposal.fuel ? 1 : 0);\n                            frm.toggle_display(\"gas\", proposal.gas ? 1 : 0);\n                            frm.toggle_display(\"hair_products\", proposal.hair_products ? 1 : 0);\n                            frm.toggle_display(\"heavy_plant\", proposal.heavy_plant ? 1 : 0);\n                            frm.toggle_display(\"invoice_factoring\", proposal.invoice_factoring ? 1 : 0);\n                            frm.toggle_display(\"leather_products\", proposal.leather_products ? 1 : 0);\n                            frm.toggle_display(\"logistics\", proposal.logistics ? 1 : 0);\n                            frm.toggle_display(\"lubricants__fuel\", proposal.lubricants__fuel ? 1 : 0);\n                            frm.toggle_display(\"meat_products\", proposal.meat_products ? 1 : 0);\n                            frm.toggle_display(\"media__radio\", proposal.media__radio ? 1 : 0); // Corrected field name\n                            frm.toggle_display(\"merchandise\", proposal.merchandise ? 1 : 0);\n                            frm.toggle_display(\"packaging_materials\", proposal.packaging_materials ? 1 : 0);\n                            frm.toggle_display(\"perishable_goods\", proposal.perishable_goods ? 1 : 0);\n                            frm.toggle_display(\"pharmaceuticals\", proposal.pharmaceuticals ? 1 : 0);\n                            frm.toggle_display(\"plastic_and_spices\", proposal.plastic_and_spices ? 1 : 0);\n                            frm.toggle_display(\"road_construction\", proposal.road_construction ? 1 : 0);\n                            frm.toggle_display(\"salt\", proposal.salt ? 1 : 0);\n                            frm.toggle_display(\"security_services\", proposal.security_services ? 1 : 0);\n                            frm.toggle_display(\"soda_ash\", proposal.soda_ash ? 1 : 0);\n                            frm.toggle_display(\"_diaries\", proposal._diaries ? 1 : 0);\n                            frm.toggle_display(\"steel_doors_window_farmes\", proposal.steel_doors_window_farmes ? 1 : 0);\n                            frm.toggle_display(\"steel_merchants\", proposal.steel_merchants ? 1 : 0);\n                            frm.toggle_display(\"timber_products\", proposal.timber_products ? 1 : 0);\n                            frm.toggle_display(\"travelling_bags\", proposal.travelling_bags ? 1 : 0);\n                            frm.toggle_display(\"water_supplies\", proposal.water_supplies ? 1 : 0);\n                        }\n                    } else {\n                        console.error(\"Error occurred in fetching data from ECI Proposal:\", response.exc);\n                    }\n                }\n            });\n        }\n    },\n\n\n      \n    calculate1: function(frm) {\n        // Stop if workflow_state is Approved or Pending\n        if (frm.doc.workflow_state === \"Approved\" || frm.doc.workflow_state === \"Pending\") {\n            frappe.msgprint({\n                title: __('Notice'),\n                message: __('\u26a0\ufe0f Quotation already approved or pending. No further calculation allowed.'),\n                indicator: 'orange'\n            });\n            return;\n        }\n\n        // Otherwise, perform the calculation\n        calculatePremiumDeposit(frm);\n    }\n});      \n    \n    \n\n\nfunction calculateAll(frm) {\n    // Helper to safely parse numbers\n    const v = (x) => isNaN(parseFloat(x)) ? 0 : parseFloat(x);\n\n    // 1\ufe0f\u20e3 Expected Insured Turnover\n    let expectedTurnover = v(frm.doc.expected_turnover);\n    let govtCashSales = v(frm.doc.estimated_govt_sales_plus_cash_sales);\n    let declinePercent = v(frm.doc.possible_declines_as_);\n\n    let ofTheTurnover = (expectedTurnover - govtCashSales) * (declinePercent / 100);\n    frm.set_value('of_the_turnover', ofTheTurnover);\n    frm.set_value('of_the_turnover_options', ofTheTurnover);\n\n    let expectedInsuredTurnover = expectedTurnover - (govtCashSales + ofTheTurnover);\n    frm.set_value('expected_insured_turnover', expectedInsuredTurnover);\n    frm.set_value('expected_insured_turnover_2', expectedInsuredTurnover);\n\n    // 2\ufe0f\u20e3 Break-even Point\n    let debtorsDifference = v(frm.doc.total_no_of_debtors) - v(frm.doc.buyers_excluded);\n    let breakEvenPoint = debtorsDifference * v(frm.doc.admin_cost_per_buyer);\n    frm.set_value('break_evenpoint', breakEvenPoint);\n\n    // 3\ufe0f\u20e3 Total Credit Sale Cost\n    let totalCreditSaleCost = breakEvenPoint + v(frm.doc.average_bad_debts);\n    frm.set_value('total_credit_sale_cost', totalCreditSaleCost);\n\n    // 4\ufe0f\u20e3 Cost Ratio\n    let costRatio = expectedInsuredTurnover ? (totalCreditSaleCost / expectedInsuredTurnover) * 100 : 0;\n    frm.set_value('cost_ratio', costRatio);\n\n    // 5\ufe0f\u20e3 Premium Rate\n    let premiumRate = costRatio + v(frm.doc.assumed_beci_margin);\n    frm.set_value('premium_rate', premiumRate);\n\n  \n           // 6\ufe0f\u20e3 Minimum Annual Premium (calculated)\n    let minAnnualPremium = (expectedInsuredTurnover * premiumRate) / 100;\n    frm.set_value('min_annual_premium', minAnnualPremium);\n\n    // \u2705 Round numeric fields\n    const fieldsToRound = [\n        'of_the_turnover', 'expected_insured_turnover', 'break_evenpoint',\n        'total_credit_sale_cost', 'cost_ratio', 'premium_rate', 'min_annual_premium'\n    ];\n    fieldsToRound.forEach(f => {\n        if (frm.doc[f] !== undefined && !isNaN(frm.doc[f])) {\n            frm.set_value(f, parseFloat(frm.doc[f]).toFixed(2));\n        }\n    });\n\n    frm.refresh_fields();\n    frappe.msgprint(__('Base calculations updated successfully.'));\n}\n\n\nfunction calculatePremiumDeposit(frm) {\n    try {\n        // Initialize variables\n        let PremDeposit = 0.0;\n        let Calc_MinPremimumDeposit = 0.0;\n\n        // Read and parse form fields\n        let ExpectedMinPreDep = flt(frm.doc.min_annual_premium);\n        let Expected_Insured_Turnover = flt(frm.doc.expected_insured_turnover);\n        let InsurTvr = flt(frm.doc.insured_turnover);\n        let PremiumRate = flt(frm.doc.premium_rate);\n\n        // VB.NET equivalent logic\n        if (InsurTvr === 0) {\n            PremDeposit = PremiumRate * Expected_Insured_Turnover / 100;\n        } else {\n            PremDeposit = PremiumRate * InsurTvr;\n        }\n\n        // Round to 2 decimals\n        Calc_MinPremimumDeposit = Math.round(PremDeposit * 100) / 100;\n\n        // Set expected_annual_premium\n        frm.set_value('expected_annual_premium', Calc_MinPremimumDeposit);\n\n        // Set premium_deposit\n        if (Calc_MinPremimumDeposit <= ExpectedMinPreDep) {\n            frm.set_value('premium_deposit', ExpectedMinPreDep);\n        } else {\n            frm.set_value('premium_deposit', Calc_MinPremimumDeposit);\n        }\n\n        frappe.msgprint(__('Premium Deposit calculated successfully.'));\n\n    } catch (e) {\n        frappe.msgprint(__('Error during calculation: {0}', [e.message]));\n    }\n}\n\n\n\nfunction generateNumber(frm) {\n    if (!frm.doc.schedule_no) {\n        let currentYear = new Date().getFullYear();\n        let prefix = `DCQT/${currentYear}/`;\n\n        console.log(\"Fetching all schedule_no entries for current year...\");\n\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'DCI Quotation',\n                filters: {\n                    'schedule_no': ['like', `${prefix}%`]\n                },\n                fields: ['schedule_no'],\n                limit: 1000\n            },\n            callback: function(r) {\n                let lastNumber = 0;\n\n                if (r.message && r.message.length > 0) {\n                    r.message.forEach(doc => {\n                        let parts = doc.schedule_no.split('/');\n                        let numPart = parts[parts.length - 1];\n                        let num = parseInt(numPart);\n                        if (!isNaN(num) && num > lastNumber) {\n                            lastNumber = num;\n                        }\n                    });\n                }\n\n                let newNumber = (lastNumber + 1).toString().padStart(4, '0');\n                let newScheduleNo = prefix + newNumber;\n                frm.set_value('schedule_no', newScheduleNo);\n                console.log(\"Generated Unique Schedule No:\", newScheduleNo);\n            }\n        });\n    }\n}\n\n\n\n// function openNewDocument(doctype, frm) {\n//     var proposal_no = frm.doc.proposal_no1;\n//     var client_name = frm.doc.client_name;\n//     var schedule_no = frm.doc.schedule_no;\n//     var to = frm.doc.client_name;\n//     var policy_name = frm.doc.client_name;\n//     var companyname = frm.doc.client_name;\n//     frappe.new_doc(doctype, {\n//         proposal_no: proposal_no,\n//         client_name: client_name,\n//         schedule_no: schedule_no,\n//         to: client_name,\n//         policy_name: client_name,\n//         company: client_name,\n//         proposal_nos: proposal_no,\n//         policy_names: client_name,\n//         proposal_no1: proposal_no,\n//         company_name: client_name,\n//         tos: client_name,\n\n//     });\n// }\n\n// added on 11/11/2025 \nfunction openNewDocument(doctype, frm) {\n    // Get necessary data from the current form or any other source\n    var data = {\n   \n        quotation_number:frm.doc.schedule_no,\n        name_of_insured:frm.doc.client_name,\n        description_of_goods:frm.doc.goods_services,\n        minimum_annual_premium:frm.doc.min_annual_premium,\n        deposit_premium:frm.doc.premium_deposit,\n        premium_rate:frm.doc.premium_rate,\n        date:frm.doc.captured_on,\n        limit_of_discretion:frm.doc.limit_of_discretion,\n        client_name:frm.doc.client_name,\n        policy_names:frm.doc.client_name,\n        proposal_no1:frm.doc.proposal_no2,\n        from:frm.doc.inception_date,\n        to:frm.doc.client_name,\n    };\n    // Open the new doctype with the required data\n    frappe.new_doc(doctype, data);\n} \n\n\n\n\n\nfunction fetchProposalData(frm) {\n    \n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'DCI Proposals',\n            filters: { proposal_no: frm.doc.proposal_no1},\n            fields: [\"currentyear_turnover\", \"nextyear_turnover\", \"govtsales\", \"govtsales2\", \"total_debtors\"]\n        },\n        callback: function(r) {\n            if (r.message) {\n                var currentYearTurnover = parseFloat(r.message.currentyear_turnover) || 0;\n                var nextYearTurnover = parseFloat(r.message.nextyear_turnover) || 0;\n                var averageTurnover = (currentYearTurnover + nextYearTurnover) / 2;\n\n                // Using frm.doc to set the field value\n                  console.log('expected_turnover',averageTurnover);\n                frm.doc.expected_turnover = averageTurnover;\n                frm.doc.expected_turnover_2 = averageTurnover;\n\n                // Trigger a refresh to reflect the changes in the form UI\n                frm.refresh_field('expected_turnover');\n                                  \n\n                frm.refresh_field('expected_turnover_2');\n\n\n                var govtSales = parseFloat(r.message.govtsales) || 0;\n                var cashSales = parseFloat(r.message.govtsales2) || 0;\n                var averageSales = (govtSales + cashSales) / 2;\n                \n                // Using frm.doc to set the field value\n                frm.doc.estimated_govt_sales_plus_cash_sales = averageSales;\n                frm.doc.estimated_govt_sales__plus_cash_sales = averageSales;\n\n                // Trigger a refresh to reflect the changes in the form UI\n                frm.refresh_field('estimated_govt_sales_plus_cash_sales');\n                frm.refresh_field('estimated_govt_sales__plus_cash_sales');\n\n                // Using jQuery to set the field value\n                // $('input[data-fieldname=\"estimated_govt_sales_plus_cash_sales\"]').val(averageSales).trigger('change');\n\n                // var totalDebtors = parseFloat(r.message.total_debtors) || 0;\n                // // Using frm.doc to set the field value\n                // frm.doc.total_no_of_debtors = totalDebtors;\n                // // Trigger a refresh to reflect the changes in the form UI\n                // frm.refresh_field('total_no_of_debtors');\n            }\n        }\n    });\n}\n\n\n\n\n// function calculateTotalCreditSaleCost(frm) {\n//     var totalCreditSaleCost = frm.doc.break_evenpoint + frm.doc.average_bad_debts;\n//     frm.set_value('total_credit_sale_cost', totalCreditSaleCost);\n//     console.log('total');\n\n//     var expectedInsuredTurnover = frm.doc.expected_insured_turnover;\n//     if (expectedInsuredTurnover !== 0) {\n//         var costRatio = (totalCreditSaleCost / expectedInsuredTurnover) * 100;\n//         frm.set_value('cost_ratio', costRatio);\n//     }\n//     calculateMinAnnualPremium(frm);\n// }\n\n\n// function calculateMinAnnualPremium(frm) {\n//     frappe.call({\n//         method: 'frappe.client.get_list',\n//         args: {\n//             doctype: 'Premium',\n//             fields: ['min_premium']\n//         },\n//         callback: function(response) {\n//             if (response && response.message && response.message.length > 0) {\n//                 var minPremium = response.message[0].min_premium || 0;\n//                 frm.set_value('min_annual_premium', minPremium);\n//             }\n//         },\n//         error: function(err) {\n//             console.log(\"Error in calculating minimum annual premium:\", err);\n//         }\n//     });\n// }\n\n\n\n//added on 11/11/2025\n\n// Covering Letter creation (route_options BEFORE new_doc)\nfunction createCoveringLetter(frm) {\n    const reference_text = `DOMESTIC CREDIT INSURANCE QUOTATION - ${frm.doc.proposal_no2 || ''}`;\n\n    frappe.route_options = {\n        our_ref: frm.doc.proposal_no2,\n        date: frm.doc.captured_on,\n        re: reference_text,\n        client_name: frm.doc.client_name\n    };\n\n    frappe.new_doc('CoveringLetter');\n}\n\n// Consent Form creation (route_options BEFORE new_doc)\nfunction createConsentForm(frm) {\n    // set route_options first so the new form receives values\n    frappe.route_options = {\n        to: frm.doc.client_name,\n        company_name: frm.doc.client_name,\n        date: frm.doc.captured_on,\n        \n    };\n\n    frappe.new_doc('Consent Form DCI Quotation');\n}\n\n\n\n    \n    \n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Potential Claim Payment",
  "enabled": 1,
  "modified": "2025-12-05 09:01:14.084767",
  "module": null,
  "name": "Potential Claim Payment Script",
  "script": "frappe.ui.form.on('Potential Claim Payment', {\n    \n    \n   \n     total_potential_claim_value(frm) {\n        calculateBalance(frm);\n    },\n    total_payment(frm) {\n        calculateBalance(frm);\n    },\n\n\n\trefresh(frm) {\n\t   if (frm.is_new()) {\n            // Show entry fields when creating new\n            frm.toggle_display('policy_no', true);\n            frm.toggle_display('policy_no1', false);\n\n            frm.toggle_display('buyer', true);\n            frm.toggle_display('buyer1', false);\n\n            frm.toggle_display('potential_claim_no', true);\n            frm.toggle_display('potential_claim_no1', false);\n        } else {\n            // Show read-only fields after saving\n            frm.toggle_display('policy_no', false);\n            frm.toggle_display('policy_no1', true);\n\n            frm.toggle_display('buyer', false);\n            frm.toggle_display('buyer1', true);\n\n            frm.toggle_display('potential_claim_no', false);\n            frm.toggle_display('potential_claim_no1', true);\n\n            // Set display field values same as editable fields\n            if (frm.doc.policy_no) frm.set_value('policy_no1', frm.doc.policy_no);\n            if (frm.doc.buyer) frm.set_value('buyer1', frm.doc.buyer);\n            if (frm.doc.potential_claim_no) frm.set_value('potential_claim_no1', frm.doc.potential_claim_no);\n        }\n        \n\tfrm.fields_dict.credit_limit.$input.css(\"text-align\", \"right\");\n    frm.fields_dict.total_payment.$input.css(\"text-align\", \"right\");\n    frm.fields_dict.total_potential_claim_value.$input.css(\"text-align\", \"right\");\n    frm.fields_dict.balance_claim_value.$input.css(\"text-align\", \"right\");\n    frm.fields_dict.amount_paid.$input.css(\"text-align\", \"right\");\n\n        // var workflowState = frm.doc.workflow_state;\n\n\n// if (workflowState === \"save\") {\n//     frm.toggle_display('policy_no', false);\n//     frm.toggle_display('policy_no1', true);\n    \n//     frm.toggle_display('buyer', false);\n//     frm.toggle_display('buyer1', true);\n    \n//     frm.toggle_display('potential_claim_no', false);\n//     frm.toggle_display('potential_claim_no1', true);\n// } else {\n//     // If workflow state is not \"Approved\", reverse the display\n//     frm.toggle_display('policy_no', true);\n//     frm.toggle_display('policy_no1', false);\n    \n//     frm.toggle_display('buyer', true);\n//     frm.toggle_display('buyer1', false);\n    \n//     frm.toggle_display('potential_claim_no', true);\n//     frm.toggle_display('potential_claim_no1', false);\n// }\n\n\t},\n\t before_save(frm) {\n        // Copy dropdown value to display field before saving\n     if (frm.doc.policy_no) frm.set_value('policy_no1', frm.doc.policy_no);\n        if (frm.doc.buyer) frm.set_value('buyer1', frm.doc.buyer);\n        if (frm.doc.potential_claim_no) frm.set_value('potential_claim_no1', frm.doc.potential_claim_no);\n    },\n\t\n\n    \n\tonload(frm){\n\t    \n\n\t    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Potential Claims',\n\t\t\t filters: {\n                   // workflow_state: 'Approved'\n                    \n                    // status: 'Full Payment'\n                    \n                                status: ['in', ['Full Payment', 'Partial Payment']]\n                },\n            fields: ['ph_name'],\n\t\t\tlimit_page_length: 0 \n        },\n        callback: function(response) {\n            console.log(\"ph_name received:\", response);\n            let DataArray = response.message;\n            let uniqueFacilityNos = new Set();\n \n            // Collect unique ph_name values\n            for (let x of DataArray) {\n                uniqueFacilityNos.add(x.ph_name);\n            }\n \n            // Convert set to array\n            let FinalArray = Array.from(uniqueFacilityNos);\n            \n            FinalArray.sort();\n \n            frm.set_df_property('ph_name', 'options', FinalArray);\n            console.log(\"final\", FinalArray);\n        },\n        error: function(xhr, textStatus, errorThrown) {\n            console.error(\"Error fetching ph_name:\", textStatus, errorThrown);\n        }\n    });\n\t   generatePaymentNumber(frm) \n\t},\n\n\nph_name: function(frm) {\n    if (frm.doc.ph_name) {\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Potential Claims',\n                filters: {\n                    'ph_name': frm.doc.ph_name\n                },\n                fields: ['policyno']\n            },\n            callback: function(r) {\n                if (r.message) {\n                    // Extract unique policyno values\n                    let unique_policies = [...new Set(r.message.map(policy => policy.policyno))];\n\n                    // Set the unique options in the field\n                    frm.set_df_property('policy_no', 'options', unique_policies);\n                    frm.refresh_field('policy_no');\n                }\n            }\n        });\n    }\n},\n\n\tpolicy_no: function(frm) {\n\t    \t    var PolicyNo = frm.doc.policy_no;\n    frm.set_value('policy_no1', PolicyNo);\n\n        if (frm.doc.policy_no) {\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Potential Claims',\n                    filters: {\n                        'policyno': frm.doc.policy_no\n                    },\n                fields:['buyer']  \n                },\n                callback: function(r) {\n                    if (r.message) {\n                        let options = r.message.map(policy => policy.buyer);\n                        frm.set_df_property('buyer', 'options', options);\n                        frm.refresh_field('buyer');\n                        \n                    }\n                }\n            });\n        }\n\t},\n\tbuyer: function(frm) {\n\t    \n\t     var Buyers = frm.doc.buyer;\n    frm.set_value('buyer1', Buyers);\n\n        if (frm.doc.buyer) {\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Potential Claims',\n                    filters: {\n                        'buyer': frm.doc.buyer\n                    },\n                fields:['claim_ref_no']  \n                },\n                callback: function(r) {\n                    if (r.message) {\n                        let options = r.message.map(policy => policy.claim_ref_no);\n                        frm.set_df_property('potential_claim_no', 'options', options);\n                        frm.refresh_field('potential_claim_no');\n                    }\n                }\n            });\n        }\n\t},\n\tpotential_claim_no: function(frm) {\n\t    var PotentialClaimNo = frm.doc.potential_claim_no;\n    frm.set_value('potential_claim_no1', PotentialClaimNo);\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Potential Claims',\n            filters: {\n                  claim_ref_no: frm.doc.potential_claim_no,\n               // workflow_state: 'Approved'\n            },\n            fields: ['inception_date', 'terms_of_payment', 'client_type', 'cl_inception_date', 'credit_limit']\n        },\n        callback: function(r) {\n            if (r.message && r.message.length > 0) {\n                var data = r.message[0];\n                frappe.call({\n                    method: 'frappe.client.get_list',\n                    args: {\n                        doctype: 'Potential Claim Payment',\n                        filters: {\n                            policy_no: frm.doc.policy_no,\n                            workflow_state: 'Approved'\n                        },\n                        fields: ['policy_no']\n                    },\n                    callback: function(approvedResponse) {\n                        if (approvedResponse.message && approvedResponse.message.length > 0) {\n                            frappe.msgprint('This policy number is already approved.');\n                        } else {\n                            // Populate fields if data is found\n                          //  frm.set_value('total_potential_claim_value', data.claim_value || '');\n                           // frm.set_value('balance_claim_value', data.claim_value || '');\n                            frm.set_value('inception_date', data.inception_date || '');\n                            frm.set_value('client_type', data.client_type || '');\n                            frm.set_value('cl_inception_date', data.cl_inception_date || '');\n                            frm.set_value('terms_of_payment', data.terms_of_payment || '');\n                            frm.set_value('credit_limit', data.credit_limit || '');\n                        }\n                    },\n                    error: function(err) {\n                        console.error('Error fetching data from Potential Claim Payment:', err);\n                        frappe.msgprint('Failed to fetch data from Potential Claim Payment. Please try again.');\n                    }\n                });\n            } else {\n                frappe.msgprint('No approved potential claims found for this claim reference number.');\n            }\n        },\n        error: function(err) {\n            console.error('Error fetching data from Potential Claims:', err);\n            frappe.msgprint('Failed to fetch data from Potential Claims. Please try again.');\n        }\n    });\n}\n\n});\n\n\n\n// Function to generate unique payment number\nfunction generatePaymentNumber(frm) {\n    // Check if the payment number field is already populated\n    if (!frm.doc.payment_no) {\n        let currentYear = new Date().getFullYear();\n        let prefix = `PCP/${currentYear}/`;\n\n        // Get the last payment number asynchronously\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Potential Claim Payment',\n                fields: ['payment_no'],\n                order_by: 'creation desc',\n                limit: 1\n            },\n            callback: function(r) {\n                if (r.message && r.message.length > 0) {\n                    let lastPaymentNo = r.message[0].payment_no;\n                    let lastNumber = parseInt(lastPaymentNo.split(\"/\").pop()) || 0; // Extract last part and parse it as integer\n                    let newNumber = (lastNumber + 1).toString().padStart(4, '0');\n                    frm.set_value('payment_no', prefix + newNumber);\n                } else {\n                    // If no previous numbers exist, set to default '0001'\n                    frm.set_value('payment_no', prefix + '0001');\n                }\n            },\n            error: function(err) {\n                console.error('Error fetching payment number:', err);\n                frappe.msgprint('Failed to generate payment number. Please try again.');\n            }\n        });\n    }\n}\n\nfunction calculateBalance(frm) {\n    let total_potential_claim_value = frm.doc.total_potential_claim_value || 0;\n    let total_payment = frm.doc.total_payment || 0;\n\n    let balance_claim_value = total_potential_claim_value - total_payment;\n     balance_claim_value = balance_claim_value.toFixed(2);\n    frm.set_value('balance_claim_value', balance_claim_value);\n    console.log(\"Balance Claim Value:\", balance_claim_value);\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Director and Shareholder Exposure",
  "enabled": 1,
  "modified": "2025-11-17 11:56:12.369989",
  "module": null,
  "name": "Director and Shareholder Exposure Script",
  "script": "frappe.ui.form.on('Director and Shareholder Exposure', {\n\n    onload: function(frm) {\n\n        // Disable Add Row and Delete Row\n        frm.set_df_property('directors_table', 'cannot_add_rows', true);\n        $(frm.fields_dict['directors_table'].grid.wrapper)\n            .find('.btn-grid-delete-row')\n            .prop('disabled', true);\n\n        // Hide Edit (Open Row) button\n        const css = `\n            .btn-open-row { \n                display: none !important; \n            }\n        `;\n        $('<style>' + css + '</style>').appendTo('head');\n\n        // Load all records initially\n        frm.trigger('fetch_all_records');\n\n        // If director is cleared \u2192 show all again\n        frm.fields_dict['director_shareholder'].df.onchange = () => {\n            if (!frm.doc.director_shareholder) {\n                frm.trigger('fetch_all_records');\n            }\n        };\n    },\n\n    // \ud83d\udd25 Fetch ALL Buyer Records (Unlimited Records)\n    fetch_all_records: function(frm) {\n\n        frappe.db.get_list('Buyer', {\n            fields: ['buyer_name', 'director_1', 'director_2', 'director_3', 'director_4'],\n            limit: 0 // IMPORTANT: fetch all records\n        }).then(r => {\n\n            frm.clear_table('directors_table');\n\n            (r || []).forEach(x => {\n                let child = frappe.model.add_child(\n                    frm.doc,\n                    \"Director and Shareholder Exposure childtable\",\n                    \"directors_table\"\n                );\n\n                frappe.model.set_value(child.doctype, child.name, \"company\", x.buyer_name);\n                frappe.model.set_value(child.doctype, child.name, \"director_1\", x.director_1);\n                frappe.model.set_value(child.doctype, child.name, \"director_2\", x.director_2);\n                frappe.model.set_value(child.doctype, child.name, \"director_3\", x.director_3);\n                frappe.model.set_value(child.doctype, child.name, \"director_4\", x.director_4);\n            });\n\n            frm.refresh_field('directors_table');\n\n        }).catch(err => {\n            frappe.msgprint(__('Error fetching data: ') + err.message);\n        });\n    },\n\n    // \ud83d\udd25 Search based on director or buyer name\n    search: function(frm) {\n\n        let director = frm.doc.director_shareholder;\n\n        if (!director) {\n            frm.trigger('fetch_all_records');\n            return;\n        }\n\n        frm.clear_table('directors_table');\n        frm.refresh();\n\n        frappe.db.get_list('Buyer', {\n            fields: ['buyer_name', 'director_1', 'director_2', 'director_3', 'director_4'],\n            limit: 0 // fetch ALL records for filtering\n        }).then(r => {\n\n            let filtered = (r || []).filter(x =>\n                x.buyer_name === director ||\n                x.director_1 === director ||\n                x.director_2 === director ||\n                x.director_3 === director ||\n                x.director_4 === director\n            );\n\n            if (filtered.length === 0) {\n                frappe.msgprint(__('No directors found for the given name.'));\n                return;\n            }\n\n            filtered.forEach(x => {\n                let child = frappe.model.add_child(\n                    frm.doc,\n                    \"Director and Shareholder Exposure childtable\",\n                    \"directors_table\"\n                );\n\n                frappe.model.set_value(child.doctype, child.name, \"company\", x.buyer_name);\n                frappe.model.set_value(child.doctype, child.name, \"director_1\", x.director_1);\n                frappe.model.set_value(child.doctype, child.name, \"director_2\", x.director_2);\n                frappe.model.set_value(child.doctype, child.name, \"director_3\", x.director_3);\n                frappe.model.set_value(child.doctype, child.name, \"director_4\", x.director_4);\n            });\n\n            frm.refresh_field('directors_table');\n\n        }).catch(err => {\n            frappe.msgprint(__('Error fetching data: ') + err.message);\n        });\n    }\n});\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n// frappe.ui.form.on('Director and Shareholder Exposure', {\n//     onload: function(frm) {\n//         // Ensure directors_table cannot add rows and delete buttons are disabled\n//         frm.set_df_property('directors_table', 'cannot_add_rows', true);\n//         $(frm.fields_dict['directors_table'].grid.wrapper).find('.btn-grid-delete-row').prop('disabled', true);\n\n//         // Apply CSS to hide the Edit button\n//         var css = `\n//             .btn-open-row {\n//                 display: none !important;\n//             }\n//         `;\n//         $('<style>' + css + '</style>').appendTo('head');\n\n//         // Fetch and display all records initially\n//         frm.trigger('fetch_all_records');\n\n//         // Add event listener for changes in director_shareholder field\n//         frm.fields_dict['director_shareholder'].df.onchange = () => {\n//             if (!frm.doc.director_shareholder) {\n//                 // If the director field is cleared, fetch and display all records\n//                 frm.trigger('fetch_all_records');\n//             }\n//         };\n//     },\n\n//     fetch_all_records: function(frm) {\n//         if (!frm.doc.buyer_name) {\n//             // Fetch all data for Buyer doctype\n//             frappe.db.get_list('Buyer', {\n//                 fields: ['buyer_name', 'director_1', 'director_2', 'director_3', 'director_4'],\n//                  limit_page_length: 1000000\n//             }).then(function(r) {\n//                 if (r && r.length > 0) {\n//                     var buyerData = r;\n\n//                     // Clear existing data in the Directors Table\n//                     frm.clear_table('directors_table');\n\n//                     // Loop through all data and add to the child table\n//                     for (let x of buyerData) {\n//                         var child = frappe.model.add_child(frm.doc, \"Director and Shareholder Exposure childtable\", \"directors_table\");\n\n//                         // Set values for each row in the child table\n//                         frappe.model.set_value(child.doctype, child.name, \"company\", x.buyer_name);\n//                         frappe.model.set_value(child.doctype, child.name, \"director_1\", x.director_1);\n//                         frappe.model.set_value(child.doctype, child.name, \"director_2\", x.director_2);\n//                         frappe.model.set_value(child.doctype, child.name, \"director_3\", x.director_3);\n//                         frappe.model.set_value(child.doctype, child.name, \"director_4\", x.director_4);\n//                     }\n//                     frm.refresh_field(\"directors_table\");\n//                 } else {\n//                     frappe.msgprint(__('No data found.'));\n//                 }\n//             }).catch(function(err) {\n//                 frappe.msgprint(__('Error fetching data: ') + err.message);\n//             });\n//         } else {\n        \n\n//         }\n//     },\n\n//     search: function(frm) {\n//         var director = frm.doc.director_shareholder;\n\n//         if (!director) {\n//             // If the director field is empty, fetch and display all records\n//             frm.trigger('fetch_all_records');\n//             return;\n//         }\n\n//         // Clear existing data in the Directors Table\n//         frm.clear_table('directors_table');\n//         frm.refresh();\n\n//         // Fetch all data for Buyer doctype\n//         frappe.db.get_list('Buyer', {\n//             fields: ['buyer_name', 'director_1', 'director_2', 'director_3', 'director_4'],\n//              limit_page_length: 0\n//         }).then(function(r) {\n//             if (r && r.length > 0) {\n//                 var directorData = r;\n//                 var filteredData = [];\n\n//                 // Loop through all data and filter based on director name in any field\n//                 for (let x of directorData) {\n//                     if (x.buyer_name === director || x.director_1 === director ||\n//                         x.director_2 === director || x.director_3 === director ||\n//                         x.director_4 === director) {\n//                         filteredData.push(x);\n//                     }\n//                 }\n\n//                 if (filteredData.length > 0) {\n//                     for (let x of filteredData) {\n//                         var child = frappe.model.add_child(frm.doc, \"Director and Shareholder Exposure childtable\", \"directors_table\");\n\n//                         // Set values for each row in the child table\n//                         frappe.model.set_value(child.doctype, child.name, \"company\", x.buyer_name);\n//                         frappe.model.set_value(child.doctype, child.name, \"director_1\", x.director_1);\n//                         frappe.model.set_value(child.doctype, child.name, \"director_2\", x.director_2);\n//                         frappe.model.set_value(child.doctype, child.name, \"director_3\", x.director_3);\n//                         frappe.model.set_value(child.doctype, child.name, \"director_4\", x.director_4);\n//                     }\n//                     frm.refresh_field(\"directors_table\");\n//                 } else {\n//                     frappe.msgprint(__('No directors found for the given name.'));\n//                 }\n//             } else {\n//                 frappe.msgprint(__('No data found.'));\n//             }\n//         }).catch(function(err) {\n//             frappe.msgprint(__('Error fetching data: ') + err.message);\n//         });\n//     }\n// });\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Buyer",
  "enabled": 0,
  "modified": "2024-08-24 15:10:09.183785",
  "module": "Marketing",
  "name": "Buyer list",
  "script": "frappe.listview_settings['Buyer'] = {\n    formatters: {\n        country: function(value, row) {\n            if (value === \"BW\") {\n                return \"Botswana\";\n            }\n            else if (value === \"NA\") {\n              return \"NAMBIA\";\n        }\n            else if (value === \"SA\") {\n              return \"SOUTH AFRICA\";\n        }\n            else if (value === \"SZ\") {\n              return \"SWAZILAND\";\n        }\n            else if (value === \"US\") {\n              return \"United States of America\";\n        }\n            else if (value === \"ZM\") {\n              return \"ZAMBIA\";\n        }\n            else if (value === \"AA\") {\n              return \"Andorra\";\n        }\n            else if (value === \"AC\") {\n              return \"Ascension Island\";\n        }\n            else if (value === \"AD\") {\n              return \"Abu Dhabi\";\n        }\n          else if (value === \"AG\") {\n              return \"Antigua&Barbuda\";\n        }\n          else if (value === \"AI\") {\n              return \"Anguilla\";\n        }\n          else if (value === \"AM\") {\n              return \"Ajman\";\n        }\n         else if (value === \"AN\") {\n              return \"NETHERLANDS ANTILLES\";\n        }\n         else if (value === \"AO\") {\n              return \"Angola\";\n        }\n         else if (value === \"AR\") {\n              return \"Argentina\";\n        }\n        else if (value === \"AT\") {\n              return \"Austria\";\n        }\n        else if (value === \"AU\") {\n              return \"Australia\";\n        }\n        else if (value === \"AW\") {\n              return \"Aruba\";\n        }\n        else if (value === \"AZ\") {\n              return \"Azores\";\n        }\n        else if (value === \"BB\") {\n              return \"Barbados\";\n        }\n        else if (value === \"BE\") {\n              return \"Belgium\";\n        }\n        else if (value === \"BH\") {\n              return \"Bahrain\";\n        }\n        else if (value === \"BM\") {\n              return \"Bermuda\";\n        }\n        else if (value === \"BN\") {\n              return \"Brunei\";\n        }\n        else if (value === \"BO\") {\n              return \"Bolivia\";\n        }\n        else if (value === \"BR\") {\n              return \"Brazil\";\n        }\n        else if (value === \"BS\") {\n              return \"Bahamas\";\n        }\n        else if (value === \"BZ\") {\n              return \"BELIZE\";\n        }\n        else if (value === \"CA\") {\n              return \"Canada\";\n        }\n        else if (value === \"CC\") {\n              return \"COCOS ISLANDS\";\n        }\n        else if (value === \"CE\") {\n              return \"CEUTA&MELILLA\";\n        }\n        else if (value === \"CH\") {\n              return \"SWITZERLAND\";\n        }\n        else if (value === \"CI\") {\n              return \"Canary Islands\";\n        }\n        else if (value === \"CK\") {\n              return \"COOK ISLANDS\";\n        }\n        else if (value === \"CL\") {\n              return \"CHILE\";\n        }\n        else if (value === \"CN\") {\n              return \"CHINA\";\n        }\n        else if (value === \"CO\") {\n              return \"COLOMBIA\";\n        }\n        else if (value === \"CS\") {\n              return \"CHANNEL ISLANDS\";\n        }\n        else if (value === \"CX\") {\n              return \"CHRISTMAS ISLANDS\";\n        }\n        else if (value === \"CY\") {\n              return \"CYPRUS\";\n        }\n        else if (value === \"CZ\") {\n              return \"CZECH REPUBLIC\";\n        }\n        else if (value === \"DC\") {\n              return \"CONGO DRC\";\n        }\n        else if (value === \"DE\") {\n              return \"GERMANY\";\n        }\n        else if (value === \"DK\") {\n              return \"DENMARK\";\n        }\n        else if (value === \"DO\") {\n              return \"DOMINICAN REPUBLIC\";\n        }\n        else if (value === \"DU\") {\n              return \"DUBAI\";\n        }\n        else if (value === \"EC\") {\n              return \"ECUADOR\";\n        }\n        else if (value === \"EG\") {\n              return \"EGYPT\";\n        }\n        else if (value === \"EI\") {\n              return \"EIRE\";\n        }\n        else if (value === \"ES\") {\n              return \"SPAIN\";\n        }\n        else if (value === \"FI\") {\n              return \"FINLAND\";\n        }\n        else if (value === \"FJ\") {\n              return \"FIJI\";\n        }\n        else if (value === \"FK\") {\n              return \"FALKLAND ISLANDS\";\n        }else if (value === \"FM\") {\n              return \"MICRONESIA,FEDERATED STATES OF\";\n        }\n        else if (value === \"FO\") {\n              return \"FAROE ISLANDS\";\n        }\n        else if (value === \"FR\") {\n              return \"FRANCE\";\n        }\n        \n        else if (value === \"FU\") {\n              return \"FUJAIRAH\";\n        }else if (value === \"GB\") {\n              return \"UNITED KINGDOM\";\n        }\n        else if (value === \"GD\") {\n              return \"GRENADA\";\n        }\n        else if (value === \"GF\") {\n              return \"FRENCH GUINEA\";\n        }\n        else if (value === \"GH\") {\n              return \"GHANA\";\n        }\n        else if (value === \"GI\") {\n              return \"GIBRALTAR\";\n        }\n        else if (value === \"GL\") {\n              return \"GREENLAND\";\n        }\n        else if (value === \"GP\") {\n              return \"GUADELOUPE\";\n        }\n        else if (value === \"GR\") {\n              return \"GREECE\";\n        }\n        else if (value === \"GS\") {\n              return \"SOUTH GEORGIA &SOUTH SANDWICH ISLANDS\";\n        }\n        else if (value === \"GT\") {\n              return \"GUATEMALA\";\n        }\n        else if (value === \"GU\") {\n              return \"GUAM\";\n        }\n        else if (value === \"HK\") {\n              return \"HONG KONG\";\n        }\n        else if (value === \"HN\") {\n              return \"HONDURUS\";\n        }\n        else if (value === \"HU\") {\n              return \"HUNGARY\";\n        }\n        else if (value === \"IL\") {\n              return \"ISRAEL\";\n        }\n        else if (value === \"IM\") {\n              return \"Isle of Man\";\n        }\n        else if (value === \"IN\") {\n              return \"INDIA\";\n        }\n        else if (value === \"IS\") {\n              return \"ICELAND\";\n        }\n        else if (value === \"IT\") {\n              return \"ITALY\";\n        }\n        else if (value === \"JM\") {\n              return \"JAMAICA\";\n        }\n        else if (value === \"JO\") {\n              return \"JORDAN\";\n        }\n        else if (value === \"JP\") {\n              return \"JAPAN\";\n        }\n        else if (value === \"KE\") {\n              return \"KENYA\";\n        }\n        else if (value === \"KI\") {\n              return \"KIRIBATI\";\n        }\n        else if (value === \"KN\") {\n              return \"ST.KITTS &NEVIS\";\n        }\n        else if (value === \"KR\") {\n              return \"KOREA(SOUTH)\";\n        }\n        else if (value === \"KW\") {\n              return \"KUWAIT\";\n        }\n        else if (value === \"KY\") {\n              return \"CAYMAN ISLANDS\";\n        }\n        else if (value === \"LA\") {\n              return \"LAOS\";\n        }\n        else if (value === \"LC\") {\n              return \"SAINT LUCIA\";\n        }\n        else if (value === \"LI\") {\n              return \"LIECHTENSTEIN\";\n        }else if (value === \"LK\") {\n              return \"SRILANKA\";\n        }\n          \n          else if (value === \"LU\") {\n              return \"LUXEMBOURG\";\n        }  \n        else if (value === \"MA\") {\n              return \"MOROCCO\";\n        }\n        else if (value === \"MC\") {\n              return \"MONACO\";\n        }\n        else if (value === \"MH\") {\n              return \"MARSHALL ISLANDS\";\n        }\n        else if (value === \"MO\") {\n              return \"MACAO\";\n        }\n        else if (value === \"MO\") {\n              return \"KIRIBATI\";\n        }\n        else if (value === \"MP\") {\n              return \"NORTHERN MARIANA ISLANDS\";\n        }\n        else if (value === \"MQ\") {\n              return \"MARTINIQUE\";\n        }\n        else if (value === \"MS\") {\n              return \"MONTSERRAT\";\n        }\n        else if (value === \"MT\") {\n              return \"MALTA\";\n        }\n        else if (value === \"MU\") {\n              return \"MAURITIUS\";\n        }\n        \n        else if (value === \"MW\") {\n              return \"MALAWI\";\n        }\n        else if (value === \"MU\") {\n              return \"MAURITIUS\";\n        }\n        else if (value === \"MX\") {\n              return \"MEXICO\";\n        }\n        else if (value === \"MZ\") {\n              return \"MOZAMBIQUE\";\n        }\n        // else if (value === \"NA\") {\n        //       return \"NAMBIA\";\n        // }\n        else if (value === \"NC\") {\n              return \"NEW CALEDONIA\";\n        }\n        else if (value === \"NF\") {\n              return \"NORFOLK ISLANDS\";\n        }\n        else if (value === \"NI\") {\n              return \"NICARAGUA\";\n        }\n        else if (value === \"NL\") {\n              return \"NETHERLANDS\";\n        }\n        else if (value === \"NO\") {\n              return \"NORWAY\";\n        }\n        else if (value === \"NU\") {\n              return \"NIUE\";\n        }\n        // else if (value === \"NZ\") {\n        //       return \"NEW ZEALAND\";\n        // }\n        else if (value === \"OM\") {\n              return \"OMAN\";\n        }\n        else if (value === \"PA\") {\n              return \"PANAMA\";\n        }\n        else if (value === \"PF\") {\n              return \"FRENCH POLYNESIA\";\n        }\n        else if (value === \"PH\") {\n              return \"PHILIPPINES\";\n        }\n        else if (value === \"PK\") {\n              return \"PAKISTAN\";\n        }\n        else if (value === \"PL\") {\n              return \"POLAND\";\n        }\n        else if (value === \"PM\") {\n              return \"ST PIERRE & MIGUELON\";\n        }\n        else if (value === \"PN\") {\n              return \"PITCAIRN ISLAND\";\n        }\n        else if (value === \"PR\") {\n              return \"PUERTO RICO\";\n        }\n        \n        else if (value === \"PT\") {\n              return \"PORTUGAL\";\n        }\n        else if (value === \"PW\") {\n              return \"PALAU\";\n        }\n        else if (value === \"PY\") {\n              return \"PARAGUAY\";\n        }\n        \n        else if (value === \"QA\") {\n              return \"QATAR\";\n        }\n        else if (value === \"RE\") {\n              return \"REUNION\";\n        }\n        else if (value === \"RK\") {\n              return \"Ras Al Khaimah\";\n        }\n        // else if (value === \"SA\") {\n        //       return \"SOUTH AFRICA\";\n        // }\n        else if (value === \"SB\") {\n              return \"SOLOMON ISLANDS\";\n        }\n        else if (value === \"SC\") {\n              return \"SEYCHELLES\";\n        }\n        else if (value === \"SE\") {\n              return \"SWEDAN\";\n        }\n        else if (value === \"SG\") {\n              return \"SINGAPORE\";\n        }\n        else if (value === \"SH\") {\n              return \"ST.HELENA\";\n        }\n        else if (value === \"SJ\") {\n              return \"SHARJAH\";\n        }\n        else if (value === \"SM\") {\n              return \"SAN MARINO\";\n        }\n        else if (value === \"SN\") {\n              return \"SAMOA,AMERICAN\";\n        }\n        else if (value === \"SV\") {\n              return \"EI SALVADOR\";\n        }\n        else if (value === \"SW\") {\n              return \"SENEGAL\";\n        }\n        // else if (value === \"SZ\") {\n        //       return \"SWAZILAND\";\n        // }\n        else if (value === \"TC\") {\n              return \"TURKS AND CAICOS ISLANDS\";\n        }\n        else if (value === \"TD\") {\n              return \"TRISTAN DA CUNHA\";\n        }\n        else if (value === \"TH\") {\n              return \"THAILAND\";\n        }\n        else if (value === \"TK\") {\n              return \"TOKELAU\";\n        }\n        else if (value === \"TN\") {\n              return \"TUNISIA\";\n        }\n        else if (value === \"TO\") {\n              return \"TONGA\";\n        }\n        else if (value === \"TR\") {\n              return \"TURKEY\";\n        }\n        else if (value === \"TT\") {\n              return \"TRINIDAD AND TOBAGO\";\n        }\n        else if (value === \"TV\") {\n              return \"TUVALU\";\n        }\n        else if (value === \"TW\") {\n              return \"TAIWAN\";\n        }\n        else if (value === \"UQ\") {\n              return \"UMM AL QUWAIN\";\n        }\n        \n        // else if (value === \"US\") {\n        //       return \"United States of America\";\n        // }\n        else if (value === \"UY\") {\n              return \"URUGUAY\";\n        }\n        else if (value === \"VA\") {\n              return \"VATICAN CITY\";\n        }\n        else if (value === \"VC\") {\n              return \"SAINT VINCENT& THE GRENADINES\";\n        }\n        else if (value === \"VG\") {\n              return \"VIRGIN ISLANDS BRITISH\";\n        }\n        else if (value === \"VI\") {\n              return \"VIRGIN ISLANDS,US\";\n        }\n        else if (value === \"VU\") {\n              return \"VANUATTU\";\n        }\n        else if (value === \"WF\") {\n              return \"WALLIS & FORTNA ISLANDS\";\n        }\n        else if (value === \"WS\") {\n              return \"SAMOA,WESTERN\";\n        }\n        else if (value === \"YE\") {\n              return \"YEMEN\";\n        }\n        else if (value === \"YT\") {\n              return \"MAYOTTE\";\n        }\n        \n        else if (value === \"ZA\") {\n              return \"SAUDI ARABIA\";\n        }\n        // else if (value === \"ZM\") {\n        //       return \"ZAMBIA\";\n        // }\n        else if (value === \"ZW\") {\n              return \"Zimbabwe\";\n        }\n       \n            else {\n                return value;\n            }\n        },\n        bank: function(value, row) {\n    if (value === \"FIRST\") {\n        return \"FIRST NATIONAL BANK OF BOTSWANA\";\n    } \n    else if (value === \"ABS01\") {\n        return \"ABSA\";\n    }\n    else if (value === \"BancA\") {\n        return \"BANC ABC\";\n    }\n    else if (value === \"BANK1\") {\n        return \"BANK OF BARODA(BOTSWANA)LTD\";\n    }\n    else if (value === \"BANKG\") {\n        return \"BANK GABORONE\";\n    }\n    else if (value === \"BARCL\") {\n        return \"BARCLAYS BANK OF BOTSWANA\";\n    }\n    else if (value === \"BOTS1\") {\n        return \"BOTSWANA BUILDING SOCIETY(BBS)\";\n    }\n    else if (value === \"BOTSW\") {\n        return \"BOTSWANA VACCINE INST\";\n    }\n    else if (value === \"CAPIT\") {\n        return \"CAPITAL BANK\";\n    }\n    else if (value === \"FIRS1\") {\n        return \"FIRST NATIONAL BANK(SA)\";\n    }\n    else if (value === \"MIGRA\") {\n        return \"MIGRATION BANK\";\n    }\n    else if (value === \"NEDBA\") {\n        return \"NED BANK\";\n    }\n    else if (value === \"RAND\") {\n        return \"RAND MERCHANT\";\n    }\n    else if (value === \"STAN1\") {\n        return \"STANDARD CHARTERED BANK BOTSWANA LTD\";\n    }\n    else if (value === \"STAN2\") {\n        return \"STANDARD BANK(SA)\";\n    }\n    else if (value === \"STAN3\") {\n        return \"STANDARD BANK NAMIBIA\";\n    }\n    else if (value === \"STAN4\") {\n        return \"STANDARD CHARTERED BANK\";\n    }\n    else if (value === \"STANB\") {\n        return \"STANBIC BANK\";\n    }\n     else {\n        return value;\n    }\n    },\n        status: function(value, row) {\n            if (value === \"ACT\") {\n                return \"ACTIVE\";\n            } \n            if (value == \"IACT\"){\n                return \"InActive\";\n            }\n        },\n        industry: function(value, row) {\n            if (value === \"RET\") {\n                return \"RETAILER\";\n            } \n            else if (value === \"AGRC\") {\n              return \"AGRICULTURE\";\n        }\n            else if (value === \"BEF\") {\n              return \"BEEF\";\n        }\n            else if (value === \"CON\") {\n              return \"CONSTRUCTION\";\n        }\n            else if (value === \"DST\") {\n              return \"DISTRIBUTOR\";\n        }\n            else if (value === \"FIN\") {\n              return \"FINANCIAL SERVICES\";\n        }\n            else if (value === \"HAR\") {\n              return \"HARDWARE\";\n         }\n            else if (value === \"ITSH\") {\n              return \"IT PRODUCTS\";\n        }\n            else if (value === \"MIN\") {\n              return \"MINING\";\n        }\n            else if (value === \"MPTS\") {\n              return \"MOTOR PARTS\";\n        }\n            else if (value === \"NULL\") {\n              return \"\";\n        }\n            else if (value === \"OPT\") {\n              return \"OPTICALS\";\n         }\n            else if (value === \"PHA\") {\n              return \"MINING\";\n        }\n            else if (value === \"PIP\") {\n              return \"IT PRODUCTS\";\n        }\n            else if (value === \"STA\") {\n              return \"STATIONARY\";\n        }\n            else if (value === \"STE\") {\n              return \"STEEL\";\n        }\n          else if (value === \"Select\") {\n              return \"\";\n        }\n             \n         },\n        business: function(value, row) {\n            if (value == \"OTH\"){\n                return \"OTHERS\";\n            }\n            else if (value === \"BLDCON\") {\n              return \"BUILDING CONSTRUCTION\";\n         }\n            else if (value === \"BM\") {\n              return \"BUILDING MAINTENANCE\";\n         }\n            else if (value === \"CHE\") {\n              return \"CHEMICALS\";\n         }\n            else if (value === \"CIVIL\") {\n              return \"CIVIL ENGINEERING\";\n         }\n            else if (value === \"EC\") {\n              return \"ENGINEERING CONSULTANCY\";\n         }\n            else if (value === \"ELEC\") {\n              return \"ELECTRICAL ENGINEERING\";\n         }\n            else if (value === \"GE\") {\n              return \"GOODS RETALING\";\n         }\n            else if (value === \"GND\") {\n              return \"GENERAL DEALER\";\n         }\n            else if (value === \"HARD\") {\n              return \"HARDWARE\";\n         }\n            else if (value === \"ITP\") {\n              return \"IT PRODUCTS\";\n         }\n            else if (value === \"MAN\") {\n              return \"MANUFACTURER\";\n         }\n            else if (value === \"MC\") {\n              return \"MECHANICAL CONTRACTORS\";\n         }\n            else if (value === \"ME\") {\n              return \"MECHANICAL ENGINEERING\";\n         }\n            else if (value === \"MGRET\") {\n              return \"MANUFACTURING\";\n         }\n            else if (value === \"MINE\") {\n              return \"MINING ENGINEERING\";\n         }\n            else if (value === \"NULL\") {\n              return \" \";\n         }\n            else if (value === \"RC\") {\n              return \"ROAD CONSTRUCTION\";\n         }\n            else if (value === \"Select\") {\n              return \" \";\n         }\n            else if (value === \"SIT\") {\n              return \"STATIONARY AND IT PRODUCTS\";\n         }\n            else if (value === \"SRET\") {\n              return \"SERVICES RETAILING\";\n         }\n            else if (value === \"STC\") {\n              return \"STATIONARY AND COMPUTERS\";\n         }        \n            else if (value === \"STT\") {\n              return \"STATIONARY\";\n         }           \n         \n         \n        \n    }\n};\n}",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Students",
  "enabled": 1,
  "modified": "2024-08-20 07:18:02.166998",
  "module": "Marketing",
  "name": "Students",
  "script": "frappe.ui.form.on('Students', {\nOnload: function(frm) {\n        const country_map = {\n            \"BW\": \"Botswana\",\n            \"IN\": \"India\",\n            // Add more country codes and names as needed\n        };\n\n        // Get the current value of the country field\n        let country_code = frm.doc.country;\n\n        // Check if the country code exists in the map\n        if (country_map[country_code]) {\n            // Update the display value in the UI\n            frm.set_df_property('country', 'options', [country_map[country_code]]);\n            frm.set_value('country', country_map[country_code]);\n        }\n    }\n\n//   before_save: function(frm) {\n//         let country_map = {\n//             'US': 'United States',\n//             'UK': 'United Kingdom',\n//             // Add more mappings as needed\n//         };\n\n//         if (country_map[frm.doc.country]) {\n//             frm.set_value('country', country_map[frm.doc.country]);\n//         }\n//     }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Company-Details",
  "enabled": 1,
  "modified": "2024-12-20 06:48:27.451924",
  "module": "Administration",
  "name": "Company",
  "script": "frappe.ui.form.on('Company-Details', {\r\n    \r\nonload:function(frm){\r\n    //Manipulate NULL Values     \r\n     if (frm.doc.name1 === 'NULL') {\r\n            frm.set_value('name1', ' ');\r\n        } \r\n        if (frm.doc.postal_address === 'NULL') {\r\n            frm.set_value('postal_address', ' ');\r\n        } \r\n        if (frm.doc.location === 'NULL') {\r\n            frm.set_value('location', ' ');\r\n        } \r\n        if (frm.doc.physical_address === 'NULL') {\r\n            frm.set_value('physical_address', ' ');\r\n        } \r\n        if (frm.doc.location1 === 'NULL') {\r\n            frm.set_value('location1', ' ');\r\n        } \r\n        if (frm.doc.telephone === 'NULL') {\r\n            frm.set_value('telephone', ' ');\r\n        } \r\n        if (frm.doc.fax === 'NULL') {\r\n            frm.set_value('fax', ' ');\r\n        } \r\n        if (frm.doc.taxno === 'NULL') {\r\n            frm.set_value('taxno', ' ');\r\n        } \r\n         if (frm.doc.is_group_company === 'NULL') {\r\n            frm.set_value('is_group_company', ' ');\r\n        } \r\n         if (frm.doc.vat_reg_no === 'NULL') {\r\n            frm.set_value('vat_reg_no', ' ');\r\n        } \r\n         if (frm.doc.status === 'NULL') {\r\n            frm.set_value('status', ' ');\r\n        } \r\n         if (frm.doc.country === 'NULL') {\r\n            frm.set_value('country', ' ');\r\n        } \r\n         if (frm.doc.contact_person === 'NULL') {\r\n            frm.set_value('contact_person', ' ');\r\n        } \r\n         if (frm.doc.email === 'NULL') {\r\n            frm.set_value('email', ' ');\r\n        } \r\n         if (frm.doc.industry === 'NULL') {\r\n            frm.set_value('industry', ' ');\r\n        } \r\n         if (frm.doc.business === 'NULL') {\r\n            frm.set_value('business', ' ');\r\n        } \r\n         if (frm.doc.trading_name === 'NULL') {\r\n            frm.set_value('trading_name', ' ');\r\n        } \r\n         if (frm.doc.parent_company === 'NULL') {\r\n            frm.set_value('parent_company', ' ');\r\n        } \r\n         if (frm.doc.bank === 'NULL') {\r\n            frm.set_value('bank', ' ');\r\n        } \r\n          if (frm.doc.branch === 'NULL') {\r\n            frm.set_value('branch', ' ');\r\n        } \r\n         if (frm.doc.director_1 === 'NULL') {\r\n            frm.set_value('director_1', ' ');\r\n        } \r\n         if (frm.doc.director_2 === 'NULL') {\r\n            frm.set_value('director_2', ' ');\r\n        } \r\n          if (frm.doc.director_3 === 'NULL') {\r\n            frm.set_value('director_3', ' ');\r\n        } \r\n         if (frm.doc.director_4 === 'NULL') {\r\n            frm.set_value('director_4', ' ');\r\n        } \r\n        \r\n    \r\n  //Status Dropdown\r\n    \r\n        const statusMapping = {\r\n            'ACT': 'Active',\r\n            'IACT': 'InActive',\r\n            \r\n        \r\n        };\r\n\r\n        if (frm.doc.bank && statusMapping[frm.doc.status]) {\r\n            frm.set_value('status', statusMapping[frm.doc.status]);\r\n        }\r\n        \r\n  // BANK Drodown\r\n        if (frm.doc.bank === 'FIRST') {\r\n            frm.set_value('bank', 'FIRST NATIONAL BANK OF BOTSWANA');\r\n        }\r\n        if (frm.doc.bank === 'CAPIT') {\r\n            frm.set_value('bank', 'CAPITAL BANK');\r\n        }\r\n        if (frm.doc.bank === 'BOTSW') {\r\n            frm.set_value('bank', 'BOTSWANA VACCINE INST');\r\n        }\r\n        if (frm.doc.bank === 'BOTS1') {\r\n            frm.set_value('bank', 'BOTSWANA BUILDING SOCIETY(BBS)');\r\n        }\r\n        if (frm.doc.bank === 'STAN2') {\r\n            frm.set_value('bank', 'STANDARD BANK(SA)');\r\n        }\r\n        if (frm.doc.bank === 'MIGRA') {\r\n            frm.set_value('bank', 'MIGRATION BANK');\r\n        }\r\n        if (frm.doc.bank === 'RAND') {\r\n            frm.set_value('bank', 'RAND MERCHANT');\r\n        }\r\n        if (frm.doc.bank === 'STANB') {\r\n            frm.set_value('bank', 'STANBIC BANK');\r\n        }\r\n        if (frm.doc.bank === 'BancA') {\r\n            frm.set_value('bank', 'BANC ABC');\r\n        }\r\n        if (frm.doc.bank === 'STAN1') {\r\n            frm.set_value('bank', 'STANDARD CHARTERED BANK BOTSWANA LTD');\r\n        }\r\n        if (frm.doc.bank === 'STAN4') {\r\n            frm.set_value('bank', 'STANDARD CHARTERED BANK');\r\n        }\r\n        if (frm.doc.bank === 'STAN3') {\r\n            frm.set_value('bank', 'STANDARD BANK NAMIBIA');\r\n        }\r\n        if (frm.doc.bank === 'NEDBA') {\r\n            frm.set_value('bank', 'NED BANK');\r\n        }\r\n        if (frm.doc.bank === 'FIRS1') {\r\n            frm.set_value('bank', 'FIRST NATIONAL BANK(SA)');\r\n        }\r\n        if (frm.doc.bank === 'BARCL') {\r\n            frm.set_value('bank', 'BARCLAYS BANK OF BOTSWANA');\r\n        }\r\n         if (frm.doc.bank === 'BANK1') {\r\n            frm.set_value('bank', 'BANK OF BARODA(BOTSWANA)LTD');\r\n        }\r\n        if (frm.doc.bank === 'BANKG') {\r\n            frm.set_value('bank', 'BANK GABORONE');\r\n        }\r\n        if (frm.doc.bank === 'ABS01') {\r\n            frm.set_value('bank', 'ABSA');\r\n        }\r\n        if (frm.doc.bank === 'BANK3') {\r\n            frm.set_value('bank', 'BANK OF BOTSWANA');\r\n        }\r\n         if (frm.doc.bank === 'BANK2') {\r\n            frm.set_value('bank', 'BANK OF INDIA');\r\n        }\r\n        if (frm.doc.bank === 'FIRS4') {\r\n            frm.set_value('bank', 'FIRST NATIONAL BANK NAMIBIA');\r\n        }\r\n        if (frm.doc.bank === 'FIRS2') {\r\n            frm.set_value('bank', 'FIRST CARE CHEMIST (PTY LTD)');\r\n        }\r\n         if (frm.doc.bank === 'BIM') {\r\n            frm.set_value('bank', 'BIM');\r\n        }\r\n         if (frm.doc.bank === 'BOTS2') {\r\n            frm.set_value('bank', 'BOTSWANA SAVINGS BANK');\r\n        }\r\n          if (frm.doc.bank === 'CBZB') {\r\n             frm.set_value('bank', 'CBZ BANK');\r\n             }\r\n        if (frm.doc.bank === 'ECOB') {\r\n             frm.set_value('bank', 'ECO BANK');\r\n             }     \r\n        \r\n//COUNTRY Dropdown\r\n\r\n          \r\n       if (frm.doc.country === 'BW') {\r\n            frm.set_value('country', 'BOTSWANA');\r\n        }\r\n        if (frm.doc.country === 'NA') {\r\n            frm.set_value('country', 'NAMBIA');\r\n        }\r\n        if (frm.doc.country === 'SA') {\r\n            frm.set_value('country', 'SOUTH AFRICA');\r\n        }\r\n        if (frm.doc.country === 'SZ') {\r\n            frm.set_value('country', 'SWAZILAND');\r\n        }\r\n        if (frm.doc.country === 'US') {\r\n            frm.set_value('country', 'United States of America');\r\n        }\r\n        if (frm.doc.country === 'ZM') {\r\n            frm.set_value('country', 'ZAMBIA');\r\n        }\r\n        if (frm.doc.country === 'AA') {\r\n            frm.set_value('country', 'Andorra');\r\n        }\r\n        if (frm.doc.country === 'AC') {\r\n            frm.set_value('country', 'Ascension Island');\r\n        }\r\n        if (frm.doc.country === 'AD') {\r\n            frm.set_value('country', 'Abu Dhabi');\r\n        }\r\n        if (frm.doc.country === 'AG') {\r\n            frm.set_value('country', 'Antigua&Barbuda');\r\n        }\r\n        if (frm.doc.country === 'AI') {\r\n            frm.set_value('country', 'Anguilla');\r\n        }\r\n        if (frm.doc.country === 'AM') {\r\n            frm.set_value('country', 'Ajman');\r\n        }\r\n        if (frm.doc.country === 'AN') {\r\n            frm.set_value('country', 'NETHERLANDS ANTILLES');\r\n        }\r\n        if (frm.doc.country === 'AO') {\r\n            frm.set_value('country', 'Angola');\r\n        }\r\n        if (frm.doc.country === 'AR') {\r\n            frm.set_value('country', 'Argentina');\r\n        }\r\n        if (frm.doc.country === 'AT') {\r\n            frm.set_value('country', 'Austria');\r\n        }\r\n        if (frm.doc.country === 'AU') {\r\n            frm.set_value('country', 'Australia');\r\n        }\r\n        if (frm.doc.country === 'AW') {\r\n            frm.set_value('country', 'Aruba');\r\n        }\r\n        if (frm.doc.country === 'AZ') {\r\n            frm.set_value('country', 'Azores');\r\n        }\r\n        if (frm.doc.country === 'BB') {\r\n            frm.set_value('country', 'Barbados');\r\n        }\r\n        if (frm.doc.country === 'BE') {\r\n            frm.set_value('country', 'Belgium');\r\n        }\r\n        if (frm.doc.country === 'BH') {\r\n            frm.set_value('country', 'Bahrain');\r\n        }\r\n        if (frm.doc.country === 'BM') {\r\n            frm.set_value('country', 'Bermuda');\r\n        }\r\n        if (frm.doc.country === 'BN') {\r\n            frm.set_value('country', 'Brunei');\r\n        }\r\n        if (frm.doc.country === 'BO') {\r\n            frm.set_value('country', 'Bolivia');\r\n        }\r\n         if (frm.doc.country === 'BR') {\r\n            frm.set_value('country', 'Brazil');\r\n        }\r\n        if (frm.doc.country === 'BS') {\r\n            frm.set_value('country', 'Bahamas');\r\n        }\r\n        if (frm.doc.country === 'BZ') {\r\n            frm.set_value('country', 'BELIZE');\r\n        }\r\n        if (frm.doc.country === 'CA') {\r\n            frm.set_value('country', 'Canada');\r\n        }\r\n        if (frm.doc.country === 'CC') {\r\n            frm.set_value('country', 'COCOS ISLANDS');\r\n        }\r\n        if (frm.doc.country === 'CE') {\r\n            frm.set_value('country', 'CEUTA&MELILLA');\r\n        }\r\n        if (frm.doc.country === 'CH') {\r\n            frm.set_value('country', 'SWITZERLAND');\r\n        }\r\n        if (frm.doc.country === 'CI') {\r\n            frm.set_value('country', 'Canary Islands');\r\n        }\r\n        if (frm.doc.country === 'CK') {\r\n            frm.set_value('country', 'COOK ISLANDS');\r\n        }\r\n         if (frm.doc.country === 'CL') {\r\n            frm.set_value('country', 'CHILE');\r\n        }\r\n         if (frm.doc.country === 'CN') {\r\n            frm.set_value('country', 'CHINA');\r\n        }\r\n        if (frm.doc.country === 'CO') {\r\n            frm.set_value('country', 'COLOMBIA');\r\n        }\r\n        if (frm.doc.country === 'CS') {\r\n            frm.set_value('country', 'CHANNEL ISLAND');\r\n        }\r\n        if (frm.doc.country === 'CX') {\r\n            frm.set_value('country', 'CHRISTMAS ISLANDS');\r\n        }\r\n        if (frm.doc.country === 'CY') {\r\n            frm.set_value('country', 'CYPRUS');\r\n        }\r\n        if (frm.doc.country === 'CZ') {\r\n            frm.set_value('country', 'CZECH REPUBLIC');\r\n        }\r\n        if (frm.doc.country === 'DC') {\r\n            frm.set_value('country', 'CONGO DRC');\r\n        }\r\n        if (frm.doc.country === 'DE') {\r\n            frm.set_value('country', 'GERMANY');\r\n        }\r\nif (frm.doc.country === 'DK') {\r\n    frm.set_value('country', 'DENMARK');\r\n}\r\nif (frm.doc.country === 'DO') {\r\n    frm.set_value('country', 'DOMINICAN REPUBLIC');\r\n}\r\nif (frm.doc.country === 'DU') {\r\n    frm.set_value('country', 'DUBAI');\r\n}\r\nif (frm.doc.country === 'EC') {\r\n    frm.set_value('country', 'ECUADOR');\r\n}\r\nif (frm.doc.country === 'EG') {\r\n    frm.set_value('country', 'EGYPT');\r\n}\r\nif (frm.doc.country === 'EI') {\r\n    frm.set_value('country', 'EIRE');\r\n}\r\nif (frm.doc.country === 'ES') {\r\n    frm.set_value('country', 'SPAIN');\r\n}\r\nif (frm.doc.country === 'FI') {\r\n    frm.set_value('country', 'FINLAND');\r\n}\r\nif (frm.doc.country === 'FJ') {\r\n    frm.set_value('country', 'FIJI');\r\n}\r\nif (frm.doc.country === 'FK') {\r\n    frm.set_value('country', 'FALKLAND ISLANDS');\r\n}\r\nif (frm.doc.country === 'FM') {\r\n    frm.set_value('country', 'MICRONESIA,FEDERATED STATES OF');\r\n}\r\nif (frm.doc.country === 'FO') {\r\n    frm.set_value('country', 'FAROE ISLANDS');\r\n}\r\nif (frm.doc.country === 'FR') {\r\n    frm.set_value('country', 'FRANCE');\r\n}\r\nif (frm.doc.country === 'FU') {\r\n    frm.set_value('country', 'FUJAIRAH');\r\n}\r\nif (frm.doc.country === 'GB') {\r\n    frm.set_value('country', 'UNITED KINGDOM');\r\n}\r\nif (frm.doc.country === 'GD') {\r\n    frm.set_value('country', 'GRENADA');\r\n}\r\nif (frm.doc.country === 'GF') {\r\n    frm.set_value('country', 'FRENCH GUINEA');\r\n}\r\nif (frm.doc.country === 'GH') {\r\n    frm.set_value('country', 'GHANA');\r\n}\r\nif (frm.doc.country === 'GI') {\r\n    frm.set_value('country', 'GIBRALTAR');\r\n}\r\nif (frm.doc.country === 'GL') {\r\n    frm.set_value('country', 'GREENLAND');\r\n}\r\nif (frm.doc.country === 'GP') {\r\n    frm.set_value('country', 'GUADELOUPE');\r\n}\r\nif (frm.doc.country === 'GR') {\r\n    frm.set_value('country', 'GREECE');\r\n}\r\nif (frm.doc.country === 'GS') {\r\n    frm.set_value('country', 'SOUTH GEORGIA & SOUTH SANDWICH ISLANDS');\r\n}\r\nif (frm.doc.country === 'GT') {\r\n    frm.set_value('country', 'GUATEMALA');\r\n}\r\nif (frm.doc.country === 'GU') {\r\n    frm.set_value('country', 'GUAM');\r\n}\r\nif (frm.doc.country === 'HK') {\r\n    frm.set_value('country', 'HONG KONG');\r\n}\r\nif (frm.doc.country === 'HN') {\r\n    frm.set_value('country', 'HONDURAS');\r\n}\r\nif (frm.doc.country === 'HU') {\r\n    frm.set_value('country', 'HUNGARY');\r\n}\r\nif (frm.doc.country === 'IL') {\r\n    frm.set_value('country', 'ISRAEL');\r\n}\r\nif (frm.doc.country === 'IM') {\r\n    frm.set_value('country', 'Isle of Man');\r\n}\r\nif (frm.doc.country === 'IN') {\r\n    frm.set_value('country', 'INDIA');\r\n}\r\nif (frm.doc.country === 'IS') {\r\n    frm.set_value('country', 'ICELAND');\r\n}\r\nif (frm.doc.country === 'IT') {\r\n    frm.set_value('country', 'ITALY');\r\n}\r\nif (frm.doc.country === 'JM') {\r\n    frm.set_value('country', 'JAMAICA');\r\n}\r\nif (frm.doc.country === 'JO') {\r\n    frm.set_value('country', 'JORDAN');\r\n}\r\nif (frm.doc.country === 'JP') {\r\n    frm.set_value('country', 'JAPAN');\r\n}\r\nif (frm.doc.country === 'KE') {\r\n    frm.set_value('country', 'KENYA');\r\n}\r\nif (frm.doc.country === 'KI') {\r\n    frm.set_value('country', 'KIRIBATI');\r\n}\r\nif (frm.doc.country === 'KN') {\r\n    frm.set_value('country', 'ST.KITTS & NEVIS');\r\n}\r\nif (frm.doc.country === 'KR') {\r\n    frm.set_value('country', 'KOREA(SOUTH)');\r\n}\r\nif (frm.doc.country === 'KW') {\r\n    frm.set_value('country', 'KUWAIT');\r\n}\r\nif (frm.doc.country === 'KY') {\r\n    frm.set_value('country', 'CAYMAN ISLANDS');\r\n}\r\nif (frm.doc.country === 'LA') {\r\n    frm.set_value('country', 'LAOS');\r\n}\r\nif (frm.doc.country === 'LC') {\r\n    frm.set_value('country', 'SAINT LUCIA');\r\n}\r\nif (frm.doc.country === 'LI') {\r\n    frm.set_value('country', 'LIECHTENSTEIN');\r\n}\r\nif (frm.doc.country === 'LK') {\r\n    frm.set_value('country', 'SRILANKA');\r\n}\r\nif (frm.doc.country === 'LU') {\r\n    frm.set_value('country', 'LUXEMBOURG');\r\n}\r\nif (frm.doc.country === 'MA') {\r\n    frm.set_value('country', 'MOROCCO');\r\n}\r\nif (frm.doc.country === 'MC') {\r\n    frm.set_value('country', 'MONACO');\r\n}\r\nif (frm.doc.country === 'MH') {\r\n    frm.set_value('country', 'MARSHALL ISLANDS');\r\n}\r\nif (frm.doc.country === 'MO') {\r\n    frm.set_value('country', 'MACAO');\r\n}\r\nif (frm.doc.country === 'MP') {\r\n    frm.set_value('country', 'NORTHERN MARIANA ISLANDS');\r\n}\r\nif (frm.doc.country === 'MQ') {\r\n    frm.set_value('country', 'MARTINIQUE');\r\n}\r\nif (frm.doc.country === 'MS') {\r\n    frm.set_value('country', 'MONTSERRAT');\r\n}\r\nif (frm.doc.country === 'MT') {\r\n    frm.set_value('country', 'MALTA');\r\n}\r\nif (frm.doc.country === 'MU') {\r\n    frm.set_value('country', 'MAURITIUS');\r\n}\r\nif (frm.doc.country === 'MW') {\r\n    frm.set_value('country', 'MALAWI');\r\n}\r\nif (frm.doc.country === 'MX') {\r\n    frm.set_value('country', 'MEXICO');\r\n}\r\nif (frm.doc.country === 'MZ') {\r\n    frm.set_value('country', 'MOZAMBIQUE');\r\n}\r\nif (frm.doc.country === 'NC') {\r\n    frm.set_value('country', 'NEW CALEDONIA');\r\n}\r\nif (frm.doc.country === 'NF') {\r\n    frm.set_value('country', 'NORFOLK ISLANDS');\r\n}\r\nif (frm.doc.country === 'NI') {\r\n    frm.set_value('country', 'NICARAGUA');\r\n}\r\nif (frm.doc.country === 'NL') {\r\n    frm.set_value('country', 'NETHERLANDS');\r\n}\r\nif (frm.doc.country === 'NO') {\r\n    frm.set_value('country', 'NORWAY');\r\n}\r\nif (frm.doc.country === 'NU') {\r\n    frm.set_value('country', 'NIUE');\r\n}\r\nif (frm.doc.country === 'OM') {\r\n    frm.set_value('country', 'OMAN');\r\n}\r\nif (frm.doc.country === 'PA') {\r\n    frm.set_value('country', 'PANAMA');\r\n}\r\nif (frm.doc.country === 'PF') {\r\n    frm.set_value('country', 'FRENCH POLYNESIA');\r\n}\r\nif (frm.doc.country === 'PH') {\r\n    frm.set_value('country', 'PHILIPPINES');\r\n}\r\nif (frm.doc.country === 'PK') {\r\n    frm.set_value('country', 'PAKISTAN');\r\n}\r\nif (frm.doc.country === 'PL') {\r\n    frm.set_value('country', 'POLAND');\r\n}\r\nif (frm.doc.country === 'PM') {\r\n    frm.set_value('country', 'ST PIERRE & MIGUELON');\r\n}\r\nif (frm.doc.country === 'PN') {\r\n    frm.set_value('country', 'PITCAIRN ISLAND');\r\n}\r\nif (frm.doc.country === 'PR') {\r\n    frm.set_value('country', 'PUERTO RICO');\r\n}\r\nif (frm.doc.country === 'PT') {\r\n    frm.set_value('country', 'PORTUGAL');\r\n}\r\nif (frm.doc.country === 'PW') {\r\n    frm.set_value('country', 'PALAU');\r\n}\r\nif (frm.doc.country === 'PY') {\r\n    frm.set_value('country', 'PARAGUAY');\r\n}\r\nif (frm.doc.country === 'QA') {\r\n    frm.set_value('country', 'QATAR');\r\n}\r\nif (frm.doc.country === 'RE') {\r\n    frm.set_value('country', 'REUNION');\r\n}\r\nif (frm.doc.country === 'RK') {\r\n    frm.set_value('country', 'Ras Al Khaimah');\r\n}\r\nif (frm.doc.country === 'SB') {\r\n    frm.set_value('country', 'SOLOMON ISLANDS');\r\n}\r\nif (frm.doc.country === 'SC') {\r\n    frm.set_value('country', 'SEYCHELLES');\r\n}\r\nif (frm.doc.country === 'SE') {\r\n    frm.set_value('country', 'SWEDEN');\r\n}\r\nif (frm.doc.country === 'SG') {\r\n    frm.set_value('country', 'SINGAPORE');\r\n}\r\nif (frm.doc.country === 'SL') {\r\n    frm.set_value('country', 'SIERRA LEONE');\r\n}\r\nif (frm.doc.country === 'ST') {\r\n    frm.set_value('country', 'SAO TOME');\r\n}\r\nif (frm.doc.country === 'SV') {\r\n    frm.set_value('country', 'EL SALVADOR');\r\n}\r\nif (frm.doc.country === 'SY') {\r\n    frm.set_value('country', 'SYRIA');\r\n}\r\nif (frm.doc.country === 'TC') {\r\n    frm.set_value('country', 'TURKS & CAICOS');\r\n}\r\nif (frm.doc.country === 'TG') {\r\n    frm.set_value('country', 'TOGO');\r\n}\r\nif (frm.doc.country === 'TH') {\r\n    frm.set_value('country', 'THAILAND');\r\n}\r\nif (frm.doc.country === 'TT') {\r\n    frm.set_value('country', 'TRINIDAD & TOBAGO');\r\n}\r\nif (frm.doc.country === 'TV') {\r\n    frm.set_value('country', 'TUVALU');\r\n}\r\nif (frm.doc.country === 'TZ') {\r\n    frm.set_value('country', 'TANZANIA');\r\n}\r\nif (frm.doc.country === 'UG') {\r\n    frm.set_value('country', 'UGANDA');\r\n}\r\nif (frm.doc.country === 'UK') {\r\n    frm.set_value('country', 'UNITED KINGDOM');\r\n}\r\nif (frm.doc.country === 'UY') {\r\n    frm.set_value('country', 'URUGUAY');\r\n}\r\nif (frm.doc.country === 'VA') {\r\n    frm.set_value('country', 'VATICAN CITY');\r\n}\r\nif (frm.doc.country === 'VG') {\r\n    frm.set_value('country', 'BRITISH VIRGIN ISLANDS');\r\n}\r\nif (frm.doc.country === 'VI') {\r\n    frm.set_value('country', 'VIRGIN ISLANDS(USA)');\r\n}\r\nif (frm.doc.country === 'WF') {\r\n    frm.set_value('country', 'WALLIS & FUTUNA');\r\n}\r\nif (frm.doc.country === 'ZA') {\r\n    frm.set_value('country', 'SOUDI ARABIA');\r\n}\r\nif (frm.doc.country === 'ZM') {\r\n    frm.set_value('country', 'ZAMBIA');\r\n}\r\nif (frm.doc.country === 'ZW') {\r\n    frm.set_value('country', 'Zimbabwe');\r\n}\r\n//  iNDUSTRY DROPDOWN\r\n\r\n\r\n   if (frm.doc.industry === 'AGRC') {\r\n            frm.set_value('industry', 'AGRICULTURE');\r\n        }\r\n         if (frm.doc.industry === 'BEF') {\r\n            frm.set_value('industry', 'BEEF');\r\n        }\r\n         if (frm.doc.industry === 'CON') {\r\n            frm.set_value('industry', 'CONSTRUCTION');\r\n        }\r\n         if (frm.doc.industry === 'DST') {\r\n            frm.set_value('industry', 'DISTRIBUTOR');\r\n        }\r\n         if (frm.doc.industry === 'FIN') {\r\n            frm.set_value('industry', 'FINANCIAL SERVICES');\r\n        }\r\n         if (frm.doc.industry === 'HAR') {\r\n            frm.set_value('industry', 'HARDWARE');\r\n        }\r\n         if (frm.doc.industry === 'ITSH') {\r\n            frm.set_value('industry', 'IT SOFTWARE & HARDWARE');\r\n        }\r\n         if (frm.doc.industry === 'MIN') {\r\n            frm.set_value('industry', 'MINING');\r\n        }\r\n         if (frm.doc.industry === 'MPTS') {\r\n            frm.set_value('industry', 'MOTOR PARTS');\r\n        }\r\n        if (frm.doc.industry === 'OPT') {\r\n            frm.set_value('industry', 'OPTICALS');\r\n        }\r\n        if (frm.doc.industry === 'PHA') {\r\n            frm.set_value('industry', 'PHARMACEUTICALS');\r\n        }\r\n        if (frm.doc.industry === 'PIP') {\r\n            frm.set_value('industry', 'PVC PIPES');\r\n        }\r\n        if (frm.doc.industry === 'RET') {\r\n            frm.set_value('industry', 'RETAILER');\r\n        }\r\n        if (frm.doc.industry === 'STA') {\r\n            frm.set_value('industry', 'STATIONARY');\r\n        }\r\n        if (frm.doc.industry === 'STE') {\r\n            frm.set_value('industry', 'STEEL');\r\n        }\r\n        if (frm.doc.industry === 'TEX') {\r\n            frm.set_value('industry', 'TEXTILES');\r\n        }\r\n         if (frm.doc.industry === 'TOUR') {\r\n            frm.set_value('industry', 'TOURISM');\r\n        }\r\n         if (frm.doc.industry === 'WTAN') {\r\n            frm.set_value('industry', 'WATER TANKS');\r\n        }\r\n        if (frm.doc.industry === 'COMM') {\r\n            frm.set_value('industry', 'Communications');\r\n        }\r\n        if (frm.doc.industry === 'COF') {\r\n            frm.set_value('industry', 'CONFECTIONERY');\r\n        }\r\n        if (frm.doc.industry === 'TR') {\r\n            frm.set_value('industry', 'TRANSPORTATION');\r\n        }\r\n       \r\n        \r\n // Business Dropdown\r\n        \r\n        if (frm.doc.business === 'MC') {\r\n            frm.set_value('business', 'MECHANICAL CONTRACTORS');\r\n        } if (frm.doc.business === 'MAN') {\r\n            frm.set_value('business', 'MANUFACTURER');\r\n        }\r\n         if (frm.doc.business === 'GE') {\r\n            frm.set_value('business', 'GOODS RETALING');\r\n        }\r\n         if (frm.doc.business === 'GND') {\r\n            frm.set_value('business', 'GENERAL DEALER');\r\n        }\r\n         if (frm.doc.business === 'SRET') {\r\n            frm.set_value('business', 'SERVICES RETAILING');\r\n        }\r\n         if (frm.doc.business === 'SIT') {\r\n            frm.set_value('business', 'STATIONARY AND IT PRODUCTS');\r\n        }\r\n         if (frm.doc.business === 'BM') {\r\n            frm.set_value('business', 'BUILDING MAINTENANCE');\r\n        }\r\n         if (frm.doc.business === 'EC') {\r\n            frm.set_value('business', 'ENGINEERING CONSULTANCY');\r\n        }\r\n         if (frm.doc.business === 'RC') {\r\n            frm.set_value('business', 'ROAD CONSTRUCTION');\r\n        }\r\n         if (frm.doc.business === 'MGRET') {\r\n            frm.set_value('business', 'MANUFACTURING');\r\n        }\r\n         if (frm.doc.business === 'WHO') {\r\n            frm.set_value('business', 'WHOLESALERS');\r\n        }\r\n         if (frm.doc.business === 'ITP') {\r\n            frm.set_value('business', 'IT PRODUCTS');\r\n        }\r\n         if (frm.doc.business === 'CHE') {\r\n            frm.set_value('business', 'CHEMICALS');\r\n        }\r\n         if (frm.doc.business === 'MINE') {\r\n            frm.set_value('business', 'MINING ENGINEERING');\r\n        }\r\n         if (frm.doc.business === 'ELEC') {\r\n            frm.set_value('business', 'ELECTRICAL ENGINEERING');\r\n        }\r\n         if (frm.doc.business === 'STC') {\r\n            frm.set_value('business', 'STATIONARY AND COMPUTERS');\r\n        }\r\n         if (frm.doc.business === 'ME') {\r\n            frm.set_value('business', 'MECHANICAL ENGINEERING');\r\n        }\r\n         if (frm.doc.business === 'BLDCON') {\r\n            frm.set_value('business', 'BUILDING CONSTRUCTION');\r\n        }\r\n        if (frm.doc.business === 'HARD') {\r\n            frm.set_value('business', 'HARDWARE');\r\n        }\r\n         if (frm.doc.business === 'CIVIL') {\r\n            frm.set_value('business', 'CIVIL ENGINEERING');\r\n        }\r\n         if (frm.doc.business === 'STT') {\r\n            frm.set_value('business', 'STATIONARY');\r\n        }\r\n         if (frm.doc.business === 'OTH') {\r\n            frm.set_value('business', 'OTHERS');\r\n        }\r\n         if (frm.doc.business === 'LANC') {\r\n            frm.set_value('business', 'LANDSCAPE CONTRACTORS');\r\n        }\r\n         if (frm.doc.business === 'SIT') {\r\n            frm.set_value('business', 'STATIONARY AND IT PRODUCTS');\r\n        }\r\n         if (frm.doc.business === 'SRET') {\r\n            frm.set_value('business', 'SERVICES RETAILING');\r\n        }\r\n         if (frm.doc.business === 'BUT') {\r\n            frm.set_value('business', 'BUTCHERY');\r\n        }\r\n         if (frm.doc.business === 'CSTA') {\r\n            frm.set_value('business', 'CHEMICALS AND STATIONARY');\r\n        }\r\n         if (frm.doc.business === 'FF') {\r\n            frm.set_value('business', 'FREIGHT FORWARDING');\r\n        }\r\n       \r\n       if (frm.doc.business === 'FHRD') {\r\n            frm.set_value('business', 'FURNITURE AND HARDWARE');\r\n        }\r\n        \r\n       if (frm.doc.business === 'INST') {\r\n            frm.set_value('business', 'INSTRUMENTATION');\r\n        }\r\n       if (frm.doc.business === 'RM') {\r\n            frm.set_value('business', 'ROAD MAINTENANCE');\r\n        }\r\n         \r\n       if (frm.doc.business === 'REST') {\r\n            frm.set_value('business', 'RESTAURANT');\r\n        }\r\n       \r\n       if (frm.doc.business === 'RET') {\r\n            frm.set_value('business', 'RESTAURANT');\r\n        }\r\n        \r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "test",
  "enabled": 1,
  "modified": "2024-08-25 11:49:42.969762",
  "module": null,
  "name": "policy Information",
  "script": "frappe.ui.form.on('test', {\n add: function(frm) {\n        // Add a new row to the child table\n        let new_row = frm.add_child('policy_information');\n        \n        // Set values from the form fields to the new row\n        frappe.model.set_value(new_row.doctype, new_row.name, 'name_of_the_company', frm.doc.name_of_the_company);\n        frappe.model.set_value(new_row.doctype, new_row.name, 'sum_assured', frm.doc.sum_assured);\n        frappe.model.set_value(new_row.doctype, new_row.name, 'policy_number', frm.doc.policy_number);\n\n        // Refresh the child table to show the new row\n        frm.refresh_field('policy_information');\n        \n        // Optionally clear the fields after adding the data\n        frm.set_value('name_of_the_company', '');\n        frm.set_value('sum_assured', '');\n        frm.set_value('policy_number', '');\n    }\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Brokers",
  "enabled": 1,
  "modified": "2025-11-27 09:00:48.819302",
  "module": null,
  "name": "brokers_script",
  "script": "// ---- Brokers Doctype ----\nfrappe.ui.form.on('Brokers', {\n    onload: function(frm) {\n        // Replace \"NULL\" string values with blank\n        const fields_to_check = [\n            'name1', 'postal_address', 'location', 'physical_address',\n            'location1', 'status', 'contact_person', 'telephone', 'fax', 'email'\n        ];\n\n        fields_to_check.forEach(field => {\n            if (frm.doc[field] === 'NULL') {\n                frm.set_value(field, ' ');\n            }\n        });\n    }\n});\n\n// ---- Company-Details Doctype ----\nfrappe.ui.form.on('Brokers', {\n    name1: async function(frm) {\n        if (frm.doc.name1) {\n            // Get first 4 letters and convert to uppercase\n            let generated_shortname = frm.doc.name1.substring(0, 4).toUpperCase();\n\n            // Check if this short_name already exists\n            let existing = await frappe.db.get_list('Brokers', {\n                fields: ['name1'],\n                filters: { short_name: generated_shortname },\n                limit: 1\n            });\n\n            if (existing.length > 0) {\n                // If duplicate, append a number until unique\n                let counter = 1;\n                let unique_shortname = generated_shortname + counter;\n\n                while (true) {\n                    let check = await frappe.db.get_list('Company-Details', {\n                        fields: ['name1'],\n                        filters: { short_name: unique_shortname },\n                        limit: 1\n                    });\n\n                    if (check.length === 0) {\n                        frm.set_value('short_name', unique_shortname);\n                        break;\n                    }\n\n                    counter++;\n                    unique_shortname = generated_shortname + counter;\n                }\n            } else {\n                frm.set_value('short_name', generated_shortname);\n            }\n        }\n    },\n    refresh: function(frm) {\n        // Always show the client field\n        frm.set_df_property('name1', 'hidden', 0);\n\n        // Make it read-only if the document is saved\n        if (!frm.is_new()) {\n            frm.set_df_property('name1', 'read_only', 1);\n        } else {\n            frm.set_df_property('name1', 'read_only', 0);\n        }\n    }\n});\n\n\n\n\n\n\n\n// frappe.ui.form.on('Brokers', {\n// onload:function(frm){\n//     //Manipulate NULL Values     \n//      if (frm.doc.name1 === 'NULL') {\n//             frm.set_value('name1', ' ');\n//         } \n//         if (frm.doc.postal_address === 'NULL') {\n//             frm.set_value('postal_address', ' ');\n//         } \n//         if (frm.doc.location === 'NULL') {\n//             frm.set_value('location', ' ');\n//         } \n//         if (frm.doc.physical_address === 'NULL') {\n//             frm.set_value('physical_address', ' ');\n//         } \n//         if (frm.doc.location1 === 'NULL') {\n//             frm.set_value('location1', ' ');\n//         } \n//          if (frm.doc.status === 'NULL') {\n//             frm.set_value('status', ' ');\n//         } \n//          if (frm.doc.contact_person === 'NULL') {\n//             frm.set_value('contact_person', ' ');\n//         } \n//          if (frm.doc.telephone === 'NULL') {\n//             frm.set_value('telephone', ' ');\n//         } \n//          if (frm.doc.fax === 'NULL') {\n//             frm.set_value('fax', ' ');\n//         } \n//          if (frm.doc.email === 'NULL') {\n//             frm.set_value('email', ' ');\n//         } \n// },\n// });",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Weekly Task",
  "enabled": 0,
  "modified": "2024-09-12 13:20:16.478282",
  "module": null,
  "name": "Weekly Task",
  "script": "frappe.ui.form.on('Weekly Task', {\r\n    // department: function(frm) {\r\n    //     if (frm.doc.department) {\r\n    //         // Fetch employees based on the selected department\r\n    //         frappe.call({\r\n    //             method: 'frappe.client.get_list',\r\n    //             args: {\r\n    //                 doctype: 'Employ Details',  // The DocType that holds employee details\r\n    //                 filters: {\r\n    //                     department: frm.doc.department\r\n    //                 },\r\n    //                 fields: ['name', 'employee_name']\r\n    //             },\r\n    //             callback: function(r) {\r\n    //                 if (r.message) {\r\n    //                     frm.clear_table('employees');  // Clear existing rows in the child table\r\n    //                     r.message.forEach(function(employee) {\r\n    //                         let row = frm.add_child('employees');  // Add new row in the child table\r\n    //                         row.employee_name = employee.employee_name;  // Set employee name\r\n    //                     });\r\n    //                     frm.refresh_field('employees');  // Refresh the child table to show new data\r\n    //                 }\r\n    //             }\r\n    //         });\r\n    //     } else {\r\n    //         frm.clear_table('employees');  // Clear table if no department is selected\r\n    //         frm.refresh_field('employees');\r\n    //     }\r\n    // },\r\n        refresh: function(frm) {\r\n        // Hide the \"Add Row\" button in the child table\r\n       frm.set_df_property('employees','cannot_add_rows', true);\r\n    },\r\n\r\n    department: function(frm) {\r\n        if (frm.doc.department) {\r\n            // Fetch employees based on the selected department\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Employ Details',  // The DocType that holds employee details\r\n                    filters: {\r\n                        department: frm.doc.department\r\n                    },\r\n                    fields: ['name', 'employee_name']\r\n                },\r\n                callback: function(r) {\r\n                    if (r.message) {\r\n                        frm.clear_table('employees');  // Clear existing rows in the child table\r\n                        r.message.forEach(function(employee) {\r\n                            let row = frm.add_child('employees');  // Add new row in the child table\r\n                            row.employee_name = employee.employee_name;  // Set employee name\r\n                        });\r\n\r\n                        // If a date is already selected, update the 'day' field in each row\r\n                        if (frm.doc.date) {\r\n                            const selectedDate = new Date(frm.doc.date);\r\n                            const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\r\n                            const dayOfWeek = daysOfWeek[selectedDate.getDay()];  // Get the day of the week\r\n\r\n                            frm.doc.employees.forEach(function(row) {\r\n                                row.day = dayOfWeek;  // Set the day field to the calculated day of the week\r\n                            });\r\n                        }\r\n\r\n                        frm.refresh_field('employees');  // Refresh the child table to show updated data\r\n                    }\r\n                }\r\n            });\r\n        } else {\r\n            frm.clear_table('employees');  // Clear table if no department is selected\r\n            frm.refresh_field('employees');\r\n        }\r\n    },\r\n\r\n    date: function(frm) {\r\n        if (frm.doc.date) {\r\n            // Calculate the day of the week from the selected date\r\n            const selectedDate = new Date(frm.doc.date);\r\n            const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\r\n            const dayOfWeek = daysOfWeek[selectedDate.getDay()];  // Get the day of the week\r\n\r\n            // Update the 'day' field in each row of the child table based on the calculated day\r\n            frm.doc.employees.forEach(function(row) {\r\n                row.day = dayOfWeek;  // Set the day field to the calculated day of the week\r\n            });\r\n\r\n            frm.refresh_field('employees');  // Refresh the child table to show updated data\r\n        }\r\n    }\r\n\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Report Scheduler",
  "enabled": 1,
  "modified": "2024-09-11 06:15:46.201153",
  "module": null,
  "name": "Day generator",
  "script": "frappe.ui.form.on('Report Scheduler', {\n    refresh: function(frm) {\n        // Hide the \"Add Row\" button in the child table\n       frm.set_df_property('review','cannot_add_rows', true);\n       \n       frm.fields_dict.add.$input.addClass('btn-primary');\n       \n    //   frappe.msgprint('Select your Employee ID');\n      \n    },\n    \n    add: function(frm){\n       \n        \n        addToChildTable(frm);\n        \n    },\n    \n    date: function(frm) {\n        if (frm.doc.date) {\n            // Get the date from the field\n            var selected_date = frm.doc.date;\n            \n            // Convert the date to a JavaScript Date object\n            var date = new Date(selected_date);\n            \n            // Array of days of the week\n            var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\n            \n            // Get the day of the week (0 for Sunday, 1 for Monday, etc.)\n            var day = days[date.getDay()];\n            \n            // Set the day in the day field\n            frm.set_value('day', day);\n        }\n    }\n});\n\nfunction addToChildTable(frm) {\n    // Add a new row to the child table\n    var row = frappe.model.add_child(frm.doc, \"Weekly Report\", \"review\");\n    \n    // Set the values in the new row\n    row[\"from\"] = frm.doc['from'];\n    row[\"to\"] = frm.doc['to'];\n    row[\"date\"] = frm.doc['date'];\n    row[\"employee_name\"] = frm.doc['employee_name'];\n    row[\"department_name\"] = frm.doc['department_name'];\n    row[\"task\"] = frm.doc['task'];\n    row[\"description\"] = frm.doc['description'];\n    row[\"day\"] = frm.doc['day'];\n    row[\"id\"] = frm.doc['id'];\n    \n    // Refresh the child table field to display the new row\n    frm.refresh_field(\"review\");\n\n    // Clear the form fields after adding to the child table\n    frm.set_value(\"from\", \"\");\n    frm.set_value(\"to\", \"\");\n    frm.set_value(\"date\", \"\");\n    frm.set_value(\"employee_name\", \"\");\n    frm.set_value(\"department_name\", \"\");\n    frm.set_value(\"task\", \"\");\n    frm.set_value(\"description\", \"\");\n    frm.set_value(\"day\", \"\");\n    frm.set_value(\"id\", \"\");\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Weekly Reports",
  "enabled": 1,
  "modified": "2024-09-10 12:22:49.613363",
  "module": "Weekly Plan",
  "name": "Weekly report Script",
  "script": "frappe.ui.form.on('Weekly Reports', {\n\nrefresh:function(frm) {\n    frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Departments', // replace 'Policy Doctype' with the actual doctype name where policies are stored\n            \n                fields: ['department']\n            },\n            callback: function(r) {\n                if (r.message) {\n                    let options = r.message.map(policy => policy.department);\n                    frm.set_df_property('department', 'options', options);\n                   // frm.set_value('department', '');\n                    frm.refresh_field('department');\n                }\n            }\n    });\n},\n department: function(frm) {\n        if (frm.doc.department) {\n            // Fetch employee names based on the selected department\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Employ Details',\n                    filters: {\n                        'department': frm.doc.department\n                    },\n                    fields: ['employee_name']\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        var employee_options = [];\n                        r.message.forEach(function(d) {\n                            employee_options.push(d.name);\n                        });\n                        // Set the options in the Employee Names field\n                        frm.set_df_property('employee_name', 'options', employee_options);\n                        frm.refresh_field('employee_name');\n                    }\n                }\n            });\n        } else {\n            // Clear the Employee Names options if no department is selected\n            frm.set_df_property('employee_name', 'options', []);\n            frm.refresh_field('employee_name');\n        }\n    }\n\n\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Country Risk Table",
  "enabled": 1,
  "modified": "2025-10-30 12:21:28.389920",
  "module": "UnderWriting",
  "name": "Coutryrisktable",
  "script": "frappe.ui.form.on('Country Risk Table', {\n    refresh(frm) {\n    \nfrm.fields_dict.commercial_premimum_rate.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.political_premimum_rate.$input.css(\"text-align\", \"right\");\nfrm.fields_dict.premimum_rate.$input.css(\"text-align\", \"right\");\n\n},\n\tvalidate: function (frm) {\n    if (!frm.doc.country_group && !frm.doc.buyer_type && !frm.doc.political_premimum_rate && !frm.doc.premimum_rate && !frm.doc.payment_team && !frm.doc.commercial_premimum_rate) { // Replace 'field_name' with your field\n      frappe.msgprint(__('Country Risk Table Fields cannot be empty'));\n      frappe.validated = false; // Prevent saving\n    }\n  },\n  \n  \n  \n  \n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Premium Discount",
  "enabled": 1,
  "modified": "2025-10-30 12:26:11.900494",
  "module": "UnderWriting",
  "name": "Premium Discount",
  "script": "frappe.ui.form.on('Premium Discount', {\r\n  validate: function (frm) {\r\n    if (!frm.doc.minturnover && !frm.doc.maxturnover && !frm.doc.mindiscount && !frm.doc.maxdiscount && !frm.doc.status) {\r\n      frappe.msgprint(__('All Premium Discount fields must be filled'));\r\n      frappe.validated = false; \r\n    }\r\n  },\r\n  \r\n  \r\n  \r\n    refresh(frm) {\r\n    \r\nfrm.fields_dict.minturnover.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.maxturnover.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.mindiscount.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.maxdiscount.$input.css(\"text-align\", \"right\");\r\n\r\n},\r\n});\r\n\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Country Group",
  "enabled": 0,
  "modified": "2025-10-17 07:41:49.210985",
  "module": "UnderWriting",
  "name": "CountryGroup",
  "script": "frappe.ui.form.on('Country Group', {\n validate: function (frm) {\n    if (!frm.doc.country && !frm.doc.country_group ) { \n      frappe.msgprint(__(' Country Group Fields are required'));\n      frappe.validated = false; \n    }\n  },\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Banks",
  "enabled": 1,
  "modified": "2025-01-13 09:26:17.319388",
  "module": null,
  "name": "Banks",
  "script": "frappe.ui.form.on('Banks', {\n\tvalidate: function (frm) {\n    if (!frm.doc.bank_name && !frm.doc.short_name && !frm.doc.physical_address && !frm.doc.city && !frm.doc.contact_person && !frm.doc.telephone &&!frm.doc.email && !frm.doc.status && !frm.doc.postal_address && !frm.doc.country && !frm.doc.fax) { \n      frappe.msgprint(__(' All Fields cannot be empty'));\n      frappe.validated = false; // Prevent saving\n    }\n  },\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Buyer",
  "enabled": 1,
  "modified": "2025-12-05 09:22:47.510906",
  "module": "Administration",
  "name": "Buyers client side script",
  "script": "frappe.ui.form.on('Buyer', {\r\n    buyer_name: async function(frm) {\r\n        // Check if DCI or ECI is selected before proceeding\r\n        if (!frm.doc.dci && !frm.doc.eci) {\r\n            if (!frm._buyer_name_alert_shown) {  // Prevent multiple alerts\r\n                frappe.msgprint(__('Please select either DCI or ECI before choosing Buyer Name'));\r\n                frm._buyer_name_alert_shown = true;\r\n            }\r\n            frm.set_value('buyer_name', '');\r\n            frm.set_value('buyer_id', '');\r\n            return;\r\n        } else {\r\n            frm._buyer_name_alert_shown = false; // Reset alert flag when checkbox is selected\r\n        }\r\n\r\n        // Generate unique Buyer ID\r\n        if (frm.doc.buyer_name) {\r\n            let generated_buyer_id = frm.doc.buyer_name.substring(0, 4).toUpperCase();\r\n\r\n            // Check if this buyer_id already exists\r\n            let existing = await frappe.db.get_list('Buyer', {\r\n                fields: ['name'],\r\n                filters: { buyer_id: generated_buyer_id },\r\n                limit: 1\r\n            });\r\n\r\n            if (existing.length > 0) {\r\n                // If duplicate, append number until unique\r\n                let counter = 1;\r\n                let unique_buyer_id = generated_buyer_id + counter;\r\n\r\n                while (true) {\r\n                    let check = await frappe.db.get_list('Buyer', {\r\n                        fields: ['name'],\r\n                        filters: { buyer_id: unique_buyer_id },\r\n                        limit: 1\r\n                    });\r\n\r\n                    if (check.length === 0) {\r\n                        frm.set_value('buyer_id', unique_buyer_id);\r\n                        break;\r\n                    }\r\n\r\n                    counter++;\r\n                    unique_buyer_id = generated_buyer_id + counter;\r\n                }\r\n            } else {\r\n                frm.set_value('buyer_id', generated_buyer_id);\r\n            }\r\n        }\r\n    },\r\n    refresh: function(frm){\r\n        // Always show the client field\r\n        frm.set_df_property('buyer_id', 'hidden', 0);\r\n\r\n        // Make it read-only if the document is saved\r\n        if (!frm.is_new()) {\r\n            frm.set_df_property('buyer_id', 'read_only', 1);\r\n        } else {\r\n            frm.set_df_property('buyer_id', 'read_only', 0);\r\n        }\r\n    }\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// frappe.ui.form.on('Buyer', {\r\n//     buyer_name: function(frm) {\r\n//         if (!frm.doc.dci && !frm.doc.eci) {\r\n//             if (!frm._buyer_name_alert_shown) {  // Prevent multiple alerts\r\n//                 frappe.msgprint(__('Please select either DCI or ECI before choosing Buyer Name'));\r\n//                 frm._buyer_name_alert_shown = true;\r\n//             }\r\n//             frm.set_value('buyer_name', '');\r\n//         } else {\r\n//             frm._buyer_name_alert_shown = false; // Reset when a checkbox is selected\r\n//         }\r\n//     }\r\n// });\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Credit Limits Processing",
  "enabled": 1,
  "modified": "2025-07-29 10:19:54.031164",
  "module": null,
  "name": "processing",
  "script": "frappe.ui.form.on('Credit Limits Processing', {\n\trefresh(frm) {\n\t\tfrappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Credit Limits Application',\n                'filters': {\n          'workflow_state': 'Approved'\n        },\n                fields: ['policy_number'],\n               \n                limit_page_length: 100000\n            },\n            callback: function(response) {\n                if (response.message) {\n                    // Extract policy_number and remove duplicates\n                    let uniquePolicyNumbers = [...new Set(response.message.map(item => item.policy_number))];\n\n                    // Set these unique policy numbers as options in the 'policy_no' dropdown\n                    frm.set_df_property('policy_no', 'options', uniquePolicyNumbers.join('\\n'));\n                }\n            }\n        });\n\t},\n\t\n\t\n\t\n\t\tpolicy_no: function(frm) {\n        if (frm.doc.policy_no) {\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Credit Limits Application',\n                    filters: {\n                        policy_number: frm.doc.policy_no\n                    },\n                    fields: ['credit_limit_no'],\n                    limit_page_length: 1000\n                },\n                 callback: function(response) {\n                    if (response.message) {\n                        // Get all credit_limit_no values (including duplicates)\n                        let creditLimitList = response.message.map(item => item.credit_limit_no);\n                        frm.set_df_property('credit_limit_no', 'options', creditLimitList.join('\\n'));\n                    }\n                }\n            });\n        } else {\n            // Clear credit_limit_no options if policy_no is cleared\n            frm.set_df_property('credit_limit_no', 'options', '');\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Bond Facility",
  "enabled": 0,
  "modified": "2025-11-27 07:43:00.492300",
  "module": "Marketing",
  "name": "Bond Facilities New Script",
  "script": "// frappe.ui.form.on('Bond Facility', {\n\n\t\n// refresh: function(frm) {\n    \n//      if (!frm.doc.facility_no) {\n//             generateNumber(frm);\n//         }\n        \n//           clear_attachment(frm);\n           \n//                   // frm.set_df_property('personel_child', 'cannot_add_new', true);\n\n//         frm.fields_dict.required_facility.$input.css(\"text-align\", \"right\");\n//         // Ensure that the rejection_letter1 field exists before binding the event\n//         // if (frm.fields_dict['rejection_letter1']) {\n//         //     frm.fields_dict['rejection_letter1'].$input.on('click', function() {\n//         //         frappe.new_doc('Rejection Letter Bond Facility');\n//         //     });\n//         // }\n\n//         // Add the btn-primary class to the add_new button\n        \n//         if (frm.fields_dict.add_new) {\n//             frm.fields_dict.add_new.$input.addClass('btn-primary');\n//             frm.fields_dict.add_new1.$input.addClass('btn-primary');\n//             frm.fields_dict.add_new2.$input.addClass('btn-primary');\n//             frm.fields_dict.add_new3.$input.addClass('btn-primary');\n//             frm.fields_dict.add_new4.$input.addClass('btn-primary');\n\n\n\n//         }\n        \n//  let workflow = frm.doc.workflow_state;\n\n//     // \u2705 Show both buttons for every state EXCEPT Draft\n//     if (workflow === \"Submitted\" || workflow === \"Accepted\") {\n\n//         // \u2705 PRINT PROPOSAL BUTTON\n//         frm.add_custom_button(__('Print Proposal'), function() {\n\n//             frappe.route_options = {\n//                 registered_name: frm.doc.client_name,\n//                 nature_of_business: frm.doc.nature_of_business,\n//                 registration_no : frm.doc.reg_no,\n//                  name5 : frm.doc.signed_by,\n//                   date : frm.doc.signed_on,\n//                   designation : frm.doc.capacity,\n//                     facility_required : frm.doc.required_facility,\n//                     data3 : frm.doc.demo_1,\n//                     data4 : frm.doc.demo_2,\n//                     data6 : frm.doc.demo_3,\n//                     data5 : frm.doc.demo_4,\n//                     other_specify : frm.doc.others_specify,\n//                     remarksother_information : frm.doc.remarksother_information,\n//                     addition_to_existing_facility : frm.doc.details,\n//                     to_replace_existing_facility : frm.doc.application_remarks,\n//                     bankers : frm.doc.name1,\n//                     accno : frm.doc.ac_no,\n//                     period_with_bank : frm.doc.period_with_bankyears,\n//                     cash_balance_p : frm.doc.cash_balance,\n//                     investments_p : frm.doc.investment,\n//                     overdraft_facility_usd : frm.doc.overdraft_facility,\n//                     overdraft_used_usd : frm.doc.overdraft_used,\n//                     how_secured : frm.doc.how_secured,\n//                     bank_guarantee_facility_usd : frm.doc.bank_guarentee__facility,\n//                     guarantee_outstanding_usd : frm.doc.guarentee__outstanding,\n//                      other_bankers : frm.doc.other_bankers\n                \n//             };\n\n//             frappe.new_doc('Print Proposal BondFacility');\n//             console.log(\"Print Proposal clicked!\");\n            \n            \n//                 frappe.ui.form.on('Print Proposal BondFacility', {\n//                 refresh: function(frm) {\n//         frm.set_df_property('group_company','cannot_add_rows', true);\n//         frm.set_df_property('director_table','cannot_add_rows', true);\n//         frm.set_df_property('company_table','cannot_add_rows', true);\n//         frm.set_df_property('personel_table','cannot_add_rows', true);\n//         frm.set_df_property('current_table','cannot_add_rows', true);\n\n        \n//         frappe.call({\n//                         method: 'frappe.client.get',\n//                         args: {\n//                             doctype: 'Company-Details',\n//                             filters: {\n//                                 name1: frm.doc.registered_name\n//                             },\n//                             fields: ['postal_address', 'location','telephone','fax', 'physical_address']\n//                         },\n                \n//                 callback: function(r) {\n//                 console.log(\"Company Details Response:\", r);\n\n//                 if (!r.exc && r.message) {\n//                     frm.set_value('telephone', r.message.telephone || '');\n//                       frm.set_value('postal_adress', r.message.postal_address || '');\n//                         frm.set_value('fax', r.message.fax || '');\n//                           frm.set_value('telephone', r.message.telephone || '');\n                          \n                          \n                          \n//                           // \u2705 Combine physical_address + location and set it to physical_address field\n//              let combined_address = '';\n\n//              if (r.message.physical_address) {\n//               combined_address += r.message.physical_address;\n//               }\n\n//             if (r.message.location) {\n//                 combined_address += (combined_address ? ' , ' : '') + r.message.location;\n//               }\n\n//              frm.set_value('physical_address', combined_address);\n//              frm.refresh_fields(['telephone', 'postal_address', 'fax', 'physical_address']);\n         \n//                 }\n//                 }\n//                     });\n                    \n//              //Group Company       \n//           frappe.call({\n//             method: \"frappe.client.get\",\n//             args: {\n//                 doctype: \"Bond Facility\",\n//                 filters: { client_name: frm.doc.registered_name }\n//             },\n//             callback: function(r) {\n//                 console.log(\"Bond Facility Response:\", r);\n\n//                 if (!r.exc && r.message && r.message.group_company && r.message.group_company.length > 0) {\n//                     const data = r.message.group_company;\n\n//                     // Clear the existing rows before adding new ones\n//                     frm.clear_table('group_company');\n\n//                     data.forEach(x => {\n//                         const child = frappe.model.add_child(frm.doc, \"Group Company\", \"group_company\");\n//                         frappe.model.set_value(child.doctype, child.name, \"compid\", x.company);\n//                         frappe.model.set_value(child.doctype, child.name, \"compname\", x.address);\n//                         frappe.model.set_value(child.doctype, child.name, \"comptype\", x.type);\n//                     });\n\n//                     frm.refresh_field('group_company');\n               \n//                 } else {\n//                     console.warn(\"No Buyer Experience data found in DCI Proposals for this client.\");\n//                 }\n//             }\n//         });\n        \n//         //Director and Shareholder Child Table\n//           frappe.call({\n//             method: \"frappe.client.get\",\n//             args: {\n//                 doctype: \"Bond Facility\",\n//                 filters: { client_name: frm.doc.registered_name }\n//             },\n//             callback: function(r) {\n//                 console.log(\"Bond Facility Response:\", r);\n\n//                 if (!r.exc && r.message && r.message.directors && r.message.directors.length > 0) {\n//                     const data = r.message.directors;\n\n//                     // Clear the existing rows before adding new ones\n//                     frm.clear_table('director_table');\n\n//                     data.forEach(x => {\n//                         const child = frappe.model.add_child(frm.doc, \"Director and Shareholder Child Table\", \"director_table\");\n//                         frappe.model.set_value(child.doctype, child.name, \"shares_held\", x.share_held);\n//                         frappe.model.set_value(child.doctype, child.name, \"d_number_coregnumber\", x.id_number);\n//                          frappe.model.set_value(child.doctype, child.name, \"full_names\", x.full_name);\n//                         frappe.model.set_value(child.doctype, child.name, \"married_anc_cop\", x.married_anccop);\n//                     });\n\n//                     frm.refresh_field('director_table');\n               \n//                 } else {\n//                     console.warn(\"No Buyer Experience data found in DCI Proposals for this client.\");\n//                 }\n//             }\n//         });\n        \n//       //Company child bond facility  \n//           frappe.call({\n//             method: \"frappe.client.get\",\n//             args: {\n//                 doctype: \"Bond Facility\",\n//                 filters: { client_name: frm.doc.registered_name }\n//             },\n//             callback: function(r) {\n//                 console.log(\"Bond Facility Response:\", r);\n\n//                 if (!r.exc && r.message && r.message.company_child && r.message.company_child.length > 0) {\n//                     const data = r.message.company_child;\n\n//                     // Clear the existing rows before adding new ones\n//                     frm.clear_table('company_table');\n\n//                     data.forEach(x => {\n//                         const child = frappe.model.add_child(frm.doc, \"Company child bond facility\", \"company_table\");\n//                         frappe.model.set_value(child.doctype, child.name, \"name1\", x.name1);\n//                         frappe.model.set_value(child.doctype, child.name, \"co_reg_number\", x.registration_number);\n//                         frappe.model.set_value(child.doctype, child.name, \"_shares_held\", x.share_held);\n//                          frappe.model.set_value(child.doctype, child.name, \"nature_of_bussiness\", x.nature_of_business);\n//                         frappe.model.set_value(child.doctype, child.name, \"bond_required\", x.bond_required);\n//                     });\n\n//                     frm.refresh_field('company_table');\n               \n//                 } else {\n//                     console.warn(\"No Buyer Experience data found in DCI Proposals for this client.\");\n//                 }\n//             }\n//         });\n        \n//     //personel Child Table    \n//           frappe.call({\n//             method: \"frappe.client.get\",\n//             args: {\n//                 doctype: \"Bond Facility\",\n//                 filters: { client_name: frm.doc.registered_name }\n//             },\n//             callback: function(r) {\n//                 console.log(\"Bond Facility Response:\", r);\n\n//                 if (!r.exc && r.message && r.message.personel_child && r.message.personel_child.length > 0) {\n//                     const data = r.message.personel_child;\n\n//                     // Clear the existing rows before adding new ones\n//                     frm.clear_table('personel_table');\n\n//                     data.forEach(x => {\n//                         const child = frappe.model.add_child(frm.doc, \"personel Child Table\", \"personel_table\");\n//                         frappe.model.set_value(child.doctype, child.name, \"name1\", x.name1);\n//                         frappe.model.set_value(child.doctype, child.name, \"period_with_company\", x.period_with_companyyears);\n//                         frappe.model.set_value(child.doctype, child.name, \"position\", x.position);\n//                     });\n\n//                     frm.refresh_field('personel_table');\n               \n//                 } else {\n//                     console.warn(\"No Buyer Experience data found in DCI Proposals for this client.\");\n//                 }\n//             }\n//         });\n        \n//      //Current Bonds Child Table   \n//          frappe.call({\n//             method: \"frappe.client.get\",\n//             args: {\n//                 doctype: \"Bond Facility\",\n//                 filters: { client_name: frm.doc.registered_name }\n//             },\n//             callback: function(r) {\n//                 console.log(\"Bond Facility Response:\", r);\n\n//                 if (!r.exc && r.message && r.message.current_bond && r.message.current_bond.length > 0) {\n//                     const data = r.message.current_bond;\n\n//                     // Clear the existing rows before adding new ones\n//                     frm.clear_table('current_table');\n\n//                     data.forEach(x => {\n//                         const child = frappe.model.add_child(frm.doc, \"Current Bonds Child Table\", \"current_table\");\n//                         frappe.model.set_value(child.doctype, child.name, \"name1\", x.name_of_bankinsurance_company);\n//                         frappe.model.set_value(child.doctype, child.name, \"facility\", x.facility);\n//                         frappe.model.set_value(child.doctype, child.name, \"bondsoutstanding\", x.bonds_out_standing);\n//                         frappe.model.set_value(child.doctype, child.name, \"rate\", x.rate_charged);\n                        \n//                     });\n\n//                     frm.refresh_field('current_table');\n               \n//                 } else {\n//                     console.warn(\"No Buyer Experience data found in DCI Proposals for this client.\");\n//                 }\n//             }\n//         });\n        \n//                 }\n//             });\n\n//         }).addClass(\"btn-primary\");\n\n//     //     // REJECTION / DECLINED LETTER BUTTON\n//     //     if (frm.doc.workflow_state === \"Declined\") {\n//     //         frm.add_custom_button(\"Declined Letter\", function () {\n       \n//     // console.log(\"Sending Remarks:\", frm.doc.application_remarks);\n//     //         frappe.route_options = {\n//     //           facility_no: frm.doc.facility_no,\n//     //             to: frm.doc.signed_by,\n//     //             client: frm.doc.client_name,\n//     //             registration_no: frm.doc.reg_no,\n//     //             rejection_letter_bond_facility : frm.doc.application_remarks \n            \n//     //         };\n        \n        \n\n//     //         frappe.new_doc('Rejection Letter Bond Facility');\n//     //         frappe.model.set_value(frm.doctype, frm.docname, 'created_date', frappe.datetime.now_datetime());\n        \n        \n      \n            \n\n//     //         // Auto Fetch Address\n//     //         frappe.ui.form.on('Rejection Letter Bond Facility', {\n//     //             refresh: function(frm) {\n\n//     //                 frappe.call({\n//     //                     method: 'frappe.client.get',\n//     //                     args: {\n//     //                         doctype: 'Company-Details',\n//     //                         filters: {\n//     //                             name1: frm.doc.client\n//     //                         },\n//     //                         fields: ['postal_address', 'location', 'physical_address']\n//     //                     },\n//     //                     callback: function(r) {\n//     //                         if (!r.exc && r.message) {\n\n//     //                             let address = '';\n\n//     //                             if (r.message.name1) address += r.message.name1 + '\\n';\n//     //                             if (r.message.location) address += r.message.location + '\\n';\n//     //                             if (r.message.physical_address) address += r.message.physical_address + '\\n';\n//     //                             if (r.message.postal_address) address += r.message.postal_address + '\\n';\n\n//     //                             frm.set_value('address', address.trim());\n//     //                         }\n//     //                     }\n//     //                 });\n//     //             }\n//     //         });\n\n//     //         console.log(\"Rejection Letter clicked!\");\n\n//     //     }).addClass(\"btn-primary\");\n//     //     }\n//     }\n   \n//     }\n\n\n//         frm.set_df_property('shareholders_table', 'cannot_add_rows', true); \n//         frm.set_df_property('company_child', 'cannot_add_rows', true); \n//         frm.set_df_property('current_bond', 'cannot_add_rows', true); \n//         frm.set_df_property('personel_child', 'cannot_add_rows', true); \n//          frm.set_df_property('company_child', 'cannot_add_rows', true); \n//          frm.set_df_property('directors', 'cannot_add_rows', true); \n//          frm.set_df_property('group_company', 'cannot_add_rows', true); \n             \n//         frm.fields_dict.ac_no.$input.css(\"text-align\", \"right\");\n//         frm.fields_dict.overdraft_facility.$input.css(\"text-align\", \"right\");\n//                 frm.fields_dict.overdraft_used.$input.css(\"text-align\", \"right\");\n//                                 frm.fields_dict.required_facility.$input.css(\"text-align\", \"right\");\n\n \n\n//     },\n\n\t\n// // //Group Company Tab\n// //  add_new4: function(frm) {\n// //         frappe.prompt([\n// //             {'fieldname': 'company', 'fieldtype': 'Data', 'label': 'Company', 'reqd': 1},\n// //             {'fieldname': 'address', 'fieldtype': 'Data', 'label': 'Address'},\n// //             {'fieldname': 'type', 'fieldtype': 'Select', 'label': 'Type', 'options': ['ASSOCIATED', 'AFFILIATED', 'GROUP'] ,'reqd': 1}\n// //         ],\n// //         function(values) {\n// //             var data = {\n// //                 company: values.company,\n// //                 address: values.address,\n// //                 type: values.type\n// //             };\n// //             localStorage.setItem('group_company', JSON.stringify(data));\n// //             var group_company = JSON.parse(localStorage.getItem('group_company'));\n// //             addDataToGroupCompanyChild(frm, group_company);\n// //         }, 'Group Company', 'Submit');\n// //     },\n\n\n\n\n// // Group Company Tab\n// add_new4: function(frm) {\n//     frappe.prompt([\n//         {\n//             fieldname: 'company',\n//             fieldtype: 'Link',\n//             label: 'Company',\n//             options: 'Company-Details',   // Link to your doctype\n//             reqd: 1,\n//             onchange: function() {\n//                 let company_name = this.value;\n//                 if (company_name) {\n//                     // Fetch postal_address from Company-Details doctype\n//                     frappe.db.get_value('Company-Details', company_name, 'postal_address')\n//                         .then(r => {\n//                             if (r && r.message && r.message.postal_address) {\n//                                 // \u2705 Auto-set address in prompt dialog\n//                                 cur_dialog.set_value('address', r.message.postal_address);\n//                             } else {\n//                                 // If no address found, clear the field\n//                                 cur_dialog.set_value('address', '');\n//                             }\n//                         });\n//                 } else {\n//                     // If no company selected, clear the address\n//                     cur_dialog.set_value('address', '');\n//                 }\n//             }\n//         },\n//         {\n//             fieldname: 'address',\n//             fieldtype: 'Data',\n//             label: 'Address',\n//             read_only: 1   // \u2705 auto-filled, user cannot edit\n//         },\n//         {\n//             fieldname: 'type',\n//             fieldtype: 'Select',\n//             label: 'Type',\n//             options: ['ASSOCIATED', 'AFFILIATED', 'GROUP'],\n//             reqd: 1\n//         }\n//     ],\n//     function(values) {\n//         // \u2705 Save the prompt values into localStorage\n//         var data = {\n//             company: values.company,\n//             address: values.address,\n//             type: values.type\n//         };\n//         localStorage.setItem('group_company', JSON.stringify(data));\n\n//         var group_company = JSON.parse(localStorage.getItem('group_company'));\n//         addDataToGroupCompanyChild(frm, group_company);\n//     },\n//     'Group Company',\n//     'Submit');\n// },\n    \n// //Personnel Tab\n//  add_new3: function(frm) {\n//         frappe.prompt([\n//             {'fieldname': 'name1', 'fieldtype': 'Data', 'label': 'Name', 'reqd': 1},\n//             {'fieldname': 'position', 'fieldtype': 'Data', 'label': 'Position', 'reqd': 1},\n//             {'fieldname': 'period_with_companyyears', 'fieldtype': 'Data', 'label': 'Period With Company(Years)', 'reqd': 1}\n//         ],\n//         function(values) {\n//             var data1 = {\n//                 name1: values.name1,\n//                 position: values.position,\n//                 period_with_companyyears: values.period_with_companyyears\n//             };\n//             localStorage.setItem('personel_child', JSON.stringify(data1));\n//             var personel_child = JSON.parse(localStorage.getItem('personel_child'));\n//             addDataTopersonnelchildbondfacility(frm, personel_child);\n//         }, 'Personnel');\n//     },\n    \n// //Current Bonds Tab\n//  add_new2: function(frm) {\n//         frappe.prompt([\n//             {'fieldname': 'name_of_bankinsurance_company', 'fieldtype': 'Data', 'label': 'Name Of Bank/Insurance Company', 'reqd': 1},\n//             {'fieldname': 'facility', 'fieldtype': 'Data', 'label': 'Facility', 'reqd': 1},\n//             {'fieldname': 'bonds_out_standing', 'fieldtype': 'Data', 'label': 'Bond(s) OutStanding', 'reqd': 1},\n//             {'fieldname': 'rate_charged', 'fieldtype': 'Data', 'label': 'Rate Charged', 'reqd': 1},\n//         ],\n//         function(values) {\n//             var data1 = {\n//                 name_of_bankinsurance_company: values.name_of_bankinsurance_company,\n//                 facility: values.facility,\n//                 bonds_out_standing: values.bonds_out_standing,\n//                 rate_charged: values.rate_charged,\n//             };\n//             localStorage.setItem('current_bond', JSON.stringify(data1));\n//             var current_bond = JSON.parse(localStorage.getItem('current_bond'));\n//             addDataToCurrentBondChildBondFacility(frm, current_bond);\n//         }, 'Current Bond');\n//     },\n    \n    \n// // //Company tab\n// //  add_new1: function(frm) {\n// //     frappe.prompt([\n// //         {\n// //             'fieldname': 'name1',\n// //             'fieldtype': 'Link',\n// //             'label': 'Name',\n// //             'options': 'Company-Details',\n// //             'reqd': 1\n// //         },\n// //         {'fieldname': 'registration_number', 'fieldtype': 'Data', 'label': 'Registration Number'},\n// //         {'fieldname': 'share_held', 'fieldtype': 'Data', 'label': '% Shares Held', 'reqd': 1},\n// //         {'fieldname': '', 'fieldtype': 'Column Break'},\n// //         {\n// //           //  'fieldname': 'nature_of_business',\n// //          // 'fieldtype': 'Select', \n// //           //'label': 'Nature Of Business',\n// //          // 'default': '' // Set default empty value initially\n         \n         \n// //     'fieldname': 'nature_of_business',\n// //     'fieldtype': 'Select',\n// //     'label': 'Nature Of Business',\n// //     'options': '\\nBUILDING CONSTRUCTION\\nBUILDING MAINTENANCE\\nCHEMICALS\\nCHEMICALS AND STATIONARY\\nCIVIL ENGINEERING\\nELECTRICAL ENGINEERING\\nENGINEERING CONSULTANCY\\nFREIGHT FORWARDING\\nFURNITURE AND HARDWARE\\nGENERAL DEALER\\nGOODS RETAILING\\nGOODS RETALING\\nHARDWARE\\nINSTRUMENTATION\\nIT PRODUCTS\\nLANDSCAPE CONTRACTORS\\nMANUFACTURER\\nMANUFACTURING\\nMECHANICAL CONTRACTORS\\nMECHANICAL ENGINEERING\\nMINING ENGINEERING\\nOTHERS\\nRESTAURANT\\nROAD CONSTRUCTION\\nROAD MAINTENANCE\\nSERVICES RETAILING\\nSTATIONARY\\nSTATIONARY AND COMPUTERS\\nSTATIONARY AND IT PRODUCTS\\nWHOLESALERS',\n// //     'default': ''  // Set default empty value initially\n\n\n// //         },\n// //         {\n// //             'fieldname': 'bond_required',\n// //             'fieldtype': 'Check',\n// //             'label': 'Bond Required'\n// //         },\n// //     ],\n// //     function(values) {\n// //         // This will automatically fetch the `nature_of_business` field\n// //         frm.fields_dict['nature_of_business'].get_query = function(doc, cdt, cdn) {\n// //             return {\n// //                 filters: {\n// //                     'name': values.name1\n// //                 }\n// //             };\n// //         };\n\n// //         // Fetch the business value from the selected Company-Details and auto-populate nature_of_business\n// //         frm.add_fetch('name1', 'business', 'nature_of_business');\n        \n// //         var data1 = {\n// //             name1: values.name1,\n// //             registration_number: values.registration_number,\n// //             share_held: values.share_held,\n// //             nature_of_business: values.nature_of_business,  // This will auto-populate based on the `add_fetch` line\n// //             bond_required: values.bond_required,\n// //         };\n\n// //         addDataToCompanyChildBondFacility(frm, data1);\n// //     }, 'Company');\n// // },\n\n// // Company Tab\n// add_new1: function(frm) {\n//     frappe.prompt([\n//         {\n//             fieldname: 'name1',\n//             fieldtype: 'Link',\n//             label: 'Name',\n//             options: 'Company-Details',\n//             reqd: 1,\n//             onchange: function() {\n//                 let company_name = this.value;\n\n//                 if (company_name) {\n//                     // Fetch 'business' field from Company-Details\n//                     frappe.db.get_value('Company-Details', company_name, 'business')\n//                         .then(r => {\n//                             if (r && r.message && r.message.business) {\n//                                 cur_dialog.set_value('nature_of_business', r.message.business);\n//                             } else {\n//                                 cur_dialog.set_value('nature_of_business', '');\n//                             }\n//                         });\n\n//                     // \u2705 Compare name1 (prompt) with client_name (form)\n//                     if (frm.doc.client_name && frm.doc.client_name === company_name) {\n//                         frappe.db.get_value('DCI Proposals', { client_name: company_name }, 'registrationno')\n//                             .then(r => {\n//                                 if (r && r.message && r.message.registrationno) {\n//                                     cur_dialog.set_value('registration_number', r.message.registrationno);\n//                                 } else {\n//                                     cur_dialog.set_value('registration_number', '');\n//                                 }\n//                             });\n//                     } else {\n//                         // Clear registration number if not matched\n//                         cur_dialog.set_value('registration_number', '');\n//                     }\n//                 } else {\n//                     cur_dialog.set_value('nature_of_business', '');\n//                     cur_dialog.set_value('registration_number', '');\n//                 }\n//             }\n//         },\n//         {\n//             fieldname: 'registration_number',\n//             fieldtype: 'Data',\n//             label: 'Registration Number'\n//         },\n//         {\n//             fieldname: 'share_held',\n//             fieldtype: 'Data',\n//             label: '% Shares Held',\n//             reqd: 1\n//         },\n//         { fieldname: '', fieldtype: 'Column Break' },\n//         {\n//             fieldname: 'nature_of_business',\n//             fieldtype: 'Data',\n//             label: 'Nature Of Business'\n//         },\n//         {\n//             fieldname: 'bond_required',\n//             fieldtype: 'Check',\n//             label: 'Bond Required'\n//         }\n//     ],\n//     function(values) {\n//         var data1 = {\n//             name1: values.name1,\n//             registration_number: values.registration_number,\n//             share_held: values.share_held,\n//             nature_of_business: values.nature_of_business,\n//             bond_required: values.bond_required\n//         };\n//         addDataToCompanyChildBondFacility(frm, data1);\n//     },\n//     'Company',\n//     'Submit');\n// },\n\n\n\n// //Directors and Shareholders\n//   add_new: function(frm) {\n//     const style = document.createElement('style');\n//     style.innerHTML = `\n//         .frappe-control[data-fieldname=\"contact_no\"] .form-control {\n//             padding-top: 1px; /* Adjust the padding to shift the text */\n//             box-sizing: border-box; /* Ensure padding does not affect the field's overall size */\n//         }\n//     `;\n//     document.head.appendChild(style);\n\n//     frappe.prompt([\n//         {'fieldname': 'id_type', 'fieldtype': 'Select', 'options': '\\nDRIVING LICENSE\\nREAD ID NUMBER\\nPASSPORT', 'label': 'ID Type',  reqd: 1 },\n//         {'fieldname': 'surname', 'fieldtype': 'Data', 'label': 'Surname', reqd: 1},\n//         {'fieldname': 'first_name', 'fieldtype': 'Data', 'label': 'First Name', reqd: 1},\n//         {'fieldname': 'middle_name', 'fieldtype': 'Data', 'label': 'Middle Name'},\n//         {'fieldname': 'fax_no', 'fieldtype': 'Data', 'label': 'Fax No'},\n//         {'fieldname': '', 'fieldtype': 'Column Break'},\n//         {'fieldname': 'id_number', 'fieldtype': 'Data', 'label': 'ID Number',  reqd: 1 },\n//         {'fieldname': 'e_mail_id', 'fieldtype': 'Data', 'label': 'Email ID'},\n//         {'fieldname': 'contact_no', 'fieldtype': 'Phone', 'label': 'Contact No', reqd: 1},\n//         {'fieldname': 'share_held', 'fieldtype': 'Data', 'label': '% Share Held', reqd: 1},\n//         {'fieldname': 'married_anccop', 'fieldtype': 'Select', 'options': '\\nANC\\nCOP', 'label': 'Married ANC/COP'},\n//         {'fieldname': 'designation', 'fieldtype': 'Select', 'options': '\\nDIRECTOR\\nMEMBER\\nMANAGER\\nOTHERS\\nPARTNER\\nPROPRIETOR', 'label': 'Designation'}\n//     ], function(values) {\n//         // Combine the names to create full_name\n//         var full_name = [values.surname, values.first_name, values.middle_name].filter(Boolean).join(' ');\n\n//         var data = {\n//             id_type: values.id_type,\n//             id_number: values.id_number,\n//             first_name: values.first_name,\n//             middle_name: values.middle_name,\n//           //  surname: values.surname,\n//             surname: values.surname,\n//             contact_no: values.contact_no,\n//             married_anccop: values.married_anccop,\n//             share_held: values.share_held,\n//             full_name: full_name, // Add the full_name field\n//             fax_no: values.fax_no, // Capture the fax_no as well\n//             e_mail_id: values.e_mail_id, // Capture email id\n//             designation: values.designation // Capture designation\n//         };\n\n//         // Call the function to add data to the child table  \n//         addDataToChildTable(frm, data);\n\n//         // Set the full_name back to the parent form if needed\n//       // frm.set_value('full_name', full_name); // This sets the full_name in the parent doctype if you have a field for it\n//     }, 'Directors/ShareHolders', 'Add New Director');\n// },\n\n\n//     // validate(frm) {\n//     //      var acNo = frm.doc.ac_no;\n\n//     //     console.log(acNo); // Check the value of ac_no\n\n//     //     // Validate the ac_no to ensure it is exactly 10 digits\n//     //     var acNoRegex = /^\\d{1,15}$/;\n//     //     if (!acNoRegex.test(acNo)) {\n//     //         frappe.msgprint(__(\"It allows only 11-digit for account number field.\"));\n//     //         frappe.validated = false; // Prevent form submission\n//     //     }\n\n//     // },\n//      validate: function(frm) {\n//         if (frm.doc.ac_no && frm.doc.ac_no.length !== 11) {\n//             frappe.throw(\"Account Number must be exactly 11 digits.\");\n//         }\n//     },\n    \n//     setup: function(frm) {\n//         frm.fields_dict['client_name'].get_query = function(doc) {\n//             return {\n//                 doctype: 'Company-Details',\n//                 filters: {\n//                     'status': 'Active'\n//                 }\n//             };\n//         };\n//     },\n     \n//  client_name: function(frm) {\n//     if (frm.doc.client_name) {\n//         frappe.call({\n//             method: \"frappe.client.get_list\",\n//             args: {\n//                 doctype: \"Bond Facility\",\n//                 filters: {\n//                     client_name: frm.doc.client_name\n//                 },\n//                 fields: [\"name\"],\n//                 limit_page_length: 0\n//             },\n//             callback: function(r) {\n//                 if (r.message && r.message.length > 0) {\n//                     frappe.msgprint(__('Client already exists!'));\n//                 } else {\n//                     // Check if the client name is 'approved'\n//                     if (frm.doc.client_name.toLowerCase() === 'approved') {\n//                         if (!frm.doc.msg_displayed) {\n//                             frappe.msgprint(__('Client Name is approved!'));\n//                             frm.set_value('msg_displayed', 1);\n//                         } else {\n//                             frappe.msgprint(__('The client name is already approved.'));\n//                         }\n//                     } else {\n//                         // frm.set_value('msg_displayed', 0);\n//                     }\n//                 }\n//             }\n//         });\n//     }\n\n// frappe.call({\n//                 method: 'frappe.client.get_list',\n//                 args: {\n//                     doctype: 'DCI Proposals',\n//                     filters: {\n//                         client_name: frm.doc.client_name\n//                     },\n//                     fields: ['registrationno', 'establishmentdate'],  // \ud83d\udd39 replace with your actual fieldnames\n//                     limit: 1\n//                 },\n//                 callback: function(r) {\n//                     if (r.message && r.message.length > 0) {\n//                         let dci = r.message[0];\n//                         frm.set_value('reg_no', dci.registrationno);\n//                         frm.set_value('estd_date', dci.establishmentdate);\n//                     } else {\n//                         frappe.msgprint(__('No DCI Proposal found for this client'));\n//                     }\n//                 }\n//             });\n// }\n// });\nfrappe.ui.form.on('Bond Facility', {\n\n    // ===========================================================\n    // REFRESH\n    // ===========================================================\n    refresh: function(frm) {\n\n        if (!frm.doc.facility_no) {\n            generateNumber(frm);\n        }\n\n        clear_attachment(frm);\n\n        // Right alignment\n        frm.fields_dict.required_facility.$input.css(\"text-align\", \"right\");\n\n        // Make Add New buttons primary\n        if (frm.fields_dict.add_new) {\n            frm.fields_dict.add_new.$input.addClass('btn-primary');\n            frm.fields_dict.add_new1.$input.addClass('btn-primary');\n            frm.fields_dict.add_new2.$input.addClass('btn-primary');\n            frm.fields_dict.add_new3.$input.addClass('btn-primary');\n            frm.fields_dict.add_new4.$input.addClass('btn-primary');\n        }\n\n        let workflow = frm.doc.workflow_state;\n\n        // ===========================================================\n        // SHOW BUTTON LOGIC (IMPORTANT)\n        // ===========================================================\n\n        // -------- PRINT PROPOSAL (Submitted + Accepted) --------\n        if (workflow === \"Submitted\" || workflow === \"Accepted\") {\n\n            frm.add_custom_button(\"Print Proposal\", function() {\n\n                frappe.route_options = {\n                    registered_name: frm.doc.client_name,\n                    nature_of_business: frm.doc.nature_of_business,\n                    registration_no: frm.doc.reg_no,\n                    name5: frm.doc.signed_by,\n                    date: frm.doc.signed_on,\n                    designation: frm.doc.capacity,\n                    facility_required: frm.doc.required_facility,\n                    data3: frm.doc.demo_1,\n                    data4: frm.doc.demo_2,\n                    data6: frm.doc.demo_3,\n                    data5: frm.doc.demo_4,\n                    other_specify: frm.doc.others_specify,\n                    remarksother_information: frm.doc.remarksother_information,\n                    addition_to_existing_facility: frm.doc.details,\n                    to_replace_existing_facility: frm.doc.application_remarks,\n                    bankers: frm.doc.name1,\n                    accno: frm.doc.ac_no,\n                    period_with_bank: frm.doc.period_with_bankyears,\n                    cash_balance_p: frm.doc.cash_balance,\n                    investments_p: frm.doc.investment,\n                    overdraft_facility_usd: frm.doc.overdraft_facility,\n                    overdraft_used_usd: frm.doc.overdraft_used,\n                    how_secured: frm.doc.how_secured,\n                    bank_guarantee_facility_usd: frm.doc.bank_guarentee__facility,\n                    guarantee_outstanding_usd: frm.doc.guarentee__outstanding,\n                    other_bankers: frm.doc.other_bankers\n                };\n\n                frappe.new_doc(\"Print Proposal BondFacility\");\n\n            }).addClass(\"btn-primary\");\n        }\n\n        // -------- DECLINED LETTER (ONLY Declined) --------\n        if (workflow === \"Declined\") {\n            frm.add_custom_button(\"Declined Letter\", function() {\n\n                frappe.route_options = {\n                    facility_no: frm.doc.facility_no,\n                    to: frm.doc.signed_by,\n                    client: frm.doc.client_name,\n                    registration_no: frm.doc.reg_no,\n                    rejection_letter_bond_facility: frm.doc.application_remarks\n                };\n\n                frappe.new_doc(\"Rejection Letter Bond Facility\");\n\n            }).addClass(\"btn-primary\");\n        }\n\n        // Disable all child tables\n        frm.set_df_property('shareholders_table', 'cannot_add_rows', true);\n        frm.set_df_property('company_child', 'cannot_add_rows', true);\n        frm.set_df_property('current_bond', 'cannot_add_rows', true);\n        frm.set_df_property('personel_child', 'cannot_add_rows', true);\n        frm.set_df_property('directors', 'cannot_add_rows', true);\n        frm.set_df_property('group_company', 'cannot_add_rows', true);\n\n        // Right alignment\n        frm.fields_dict.ac_no.$input.css(\"text-align\", \"right\");\n        frm.fields_dict.overdraft_facility.$input.css(\"text-align\", \"right\");\n        frm.fields_dict.overdraft_used.$input.css(\"text-align\", \"right\");\n        frm.fields_dict.required_facility.$input.css(\"text-align\", \"right\");\n    },\n\n    // ===========================================================\n    // ONLOAD \u2192 Declined button (safety)\n    // ===========================================================\n    // onload(frm) {\n    //     if (frm.doc.workflow_state === \"Declined\") {\n    //         frm.add_custom_button(\"Declined Letter\", function () {\n    //             frappe.route_options = {\n    //                 facility_no: frm.doc.facility_no,\n    //                 to: frm.doc.signed_by,\n    //                 client: frm.doc.client_name,\n    //                 registration_no: frm.doc.reg_no,\n    //                 rejection_letter_bond_facility: frm.doc.application_remarks\n    //             };\n    //             frappe.new_doc('Rejection Letter Bond Facility');\n    //         }).addClass(\"btn-primary\");\n    //     }\n    // },\n\n    // ===========================================================\n    // CHILD TABLE BUTTONS (unchanged)\n    // ===========================================================\n\n    // Directors\n    add_new: function(frm) {\n        frappe.prompt([\n            { fieldname: 'id_type', fieldtype: 'Select', options: '\\nDRIVING LICENSE\\nREAD ID NUMBER\\nPASSPORT', reqd: 1, label: 'ID Type' },\n            { fieldname: 'surname', fieldtype: 'Data', reqd: 1, label: 'Surname' },\n            { fieldname: 'first_name', fieldtype: 'Data', reqd: 1, label: 'First Name' },\n            { fieldname: 'middle_name', fieldtype: 'Data', label: 'Middle Name' },\n            { fieldname: 'fax_no', fieldtype: 'Data', label: 'Fax No' },\n            { fieldname: '', fieldtype: 'Column Break' },\n            { fieldname: 'id_number', fieldtype: 'Data', reqd: 1, label: 'ID Number' },\n            { fieldname: 'e_mail_id', fieldtype: 'Data', label: 'Email ID' },\n            { fieldname: 'contact_no', fieldtype: 'Phone', label: 'Contact No', reqd: 1 },\n            { fieldname: 'share_held', fieldtype: 'Data', label: '% Share Held', reqd: 1 },\n            { fieldname: 'married_anccop', fieldtype: 'Select', label: 'Married ANC/COP', options: '\\nANC\\nCOP' },\n            { fieldname: 'designation', fieldtype: 'Select', label: 'Designation', options: '\\nDIRECTOR\\nMEMBER\\nMANAGER\\nOTHERS\\nPARTNER\\nPROPRIETOR' }\n        ],\n        function(values) {\n\n            let full_name = [values.surname, values.first_name, values.middle_name]\n                .filter(Boolean)\n                .join(\" \");\n\n            let data = {\n                id_type: values.id_type,\n                surname: values.surname,\n                first_name: values.first_name,\n                middle_name: values.middle_name,\n                id_number: values.id_number,\n                share_held: values.share_held,\n                married_anccop: values.married_anccop,\n                fax_no: values.fax_no,\n                e_mail_id: values.e_mail_id,\n                contact_no: values.contact_no,\n                full_name: full_name,\n                designation: values.designation\n            };\n\n            addDataToChildTable(frm, data);\n        },\n        \"Directors & Shareholders\",\n        \"Submit\");\n    },\n\n    // Personnel\n    add_new3: function(frm) {\n        frappe.prompt([\n            { fieldname: 'name1', fieldtype: 'Data', reqd: 1, label: 'Name' },\n            { fieldname: 'position', fieldtype: 'Data', reqd: 1, label: 'Position' },\n            { fieldname: 'period_with_companyyears', fieldtype: 'Data', reqd: 1, label: 'Period With Company (Years)' }\n        ],\n        function(values) {\n            addDataTopersonnelchildbondfacility(frm, values);\n        });\n    },\n\n    // Current Bonds\n    add_new2: function(frm) {\n        frappe.prompt([\n            { fieldname: 'name_of_bankinsurance_company', fieldtype: 'Data', reqd: 1, label: 'Name Of Bank/Insurance Company' },\n            { fieldname: 'facility', fieldtype: 'Data', reqd: 1, label: 'Facility' },\n            { fieldname: 'bonds_out_standing', fieldtype: 'Data', reqd: 1, label: 'Bond(s) Outstanding' },\n            { fieldname: 'rate_charged', fieldtype: 'Data', reqd: 1, label: 'Rate Charged' }\n        ],\n        function(values) {\n            addDataToCurrentBondChildBondFacility(frm, values);\n        });\n    },\n\n    // Company\n    add_new1: function(frm) {\n        frappe.prompt([\n            {\n                fieldname: 'name1',\n                fieldtype: 'Link',\n                label: 'Name',\n                options: 'Company-Details',\n                reqd: 1,\n                onchange: function () {\n                    let c = this.value;\n                    if (!c) return;\n\n                    frappe.db.get_value('Company-Details', c, 'business')\n                        .then(r => cur_dialog.set_value('nature_of_business', r.message.business || \"\"));\n\n                    if (frm.doc.client_name === c) {\n                        frappe.db.get_value('DCI Proposals', { client_name: c }, 'registrationno')\n                            .then(r => cur_dialog.set_value('registration_number', r.message.registrationno || \"\"));\n                    }\n                }\n            },\n            { fieldname: 'registration_number', fieldtype: 'Data', label: 'Registration Number' },\n            { fieldname: 'share_held', fieldtype: 'Data', reqd: 1, label: '% Shares Held' },\n            { fieldname: '', fieldtype: 'Column Break' },\n            { fieldname: 'nature_of_business', fieldtype: 'Data', label: 'Nature Of Business' },\n            { fieldname: 'bond_required', fieldtype: 'Check', label: 'Bond Required' }\n        ],\n        function(values) {\n            addDataToCompanyChildBondFacility(frm, values);\n        });\n    },\n\n    // Group Company\n    add_new4: function(frm) {\n        frappe.prompt([\n            {\n                fieldname: 'company',\n                fieldtype: 'Link',\n                label: 'Company',\n                options: 'Company-Details',\n                reqd: 1,\n                onchange: function () {\n                    let c = this.value;\n                    if (!c) return;\n                    frappe.db.get_value('Company-Details', c, 'postal_address')\n                        .then(r => cur_dialog.set_value('address', r.message.postal_address || \"\"));\n                }\n            },\n            { fieldname: 'address', fieldtype: 'Data', label: 'Address', read_only: 1 },\n            { fieldname: 'type', fieldtype: 'Select', label: 'Type', options: ['ASSOCIATED', 'AFFILIATED', 'GROUP'], reqd: 1 }\n        ],\n        function(values) {\n            addDataToGroupCompanyChild(frm, values);\n        });\n    }\n\n});\n\n// Auto generation of Proposal No\nfunction generateNumber(frm) {\n    if (!frm.doc.facility_no) {\n        let currentYear = new Date().getFullYear();\n        let prefix = `BFC/${currentYear}/`;\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Bond Facility',\n                fields: ['facility_no', 'creation'],\n                order_by: 'creation desc',\n                limit: 1\n            },\n            callback: function(r) {\n                if (r.message && r.message.length > 0) {\n                    let lastFacilityNo = r.message[0].facility_no;\n                    let lastNumber = parseInt(lastFacilityNo.split(\"/\").pop());\n                    if (!isNaN(lastNumber)) {\n                        let newNumber = (lastNumber + 1).toString().padStart(4, '0');\n                        frm.set_value('facility_no', prefix + newNumber);\n                    }\n                } else {\n                    frm.set_value('facility_no', prefix + '0001');\n                }\n            }\n        });\n    }\n}\n\n\t//Group Company Tab\nfunction addDataToGroupCompanyChild(frm, data) {\n    var childTable = frm.fields_dict['group_company'].grid;\n    var newRow = frappe.model.add_child(frm.doc, 'Group Company Child Doctype', 'group_company');\n    frappe.model.set_value(newRow.doctype, newRow.name, 'company', data.company);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'address', data.address);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'type', data.type);\n\n    frm.refresh_field('group_company');\n}\n\n//personnel\nfunction addDataTopersonnelchildbondfacility(frm, data) {\n    var childTable = frm.fields_dict['personel_child'].grid;\n    var newRow = frappe.model.add_child(frm.doc, childTable.doctype, 'personel_child');\n    frappe.model.set_value(newRow.doctype, newRow.name, 'name1', data.name1);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'position', data.position);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'period_with_companyyears', data.period_with_companyyears);\n    \n    frm.refresh_field('personel_child');\n}\n\n//Current Bonds tAb\n\nfunction addDataToCurrentBondChildBondFacility(frm, data) {\n    var childTable = frm.fields_dict['current_bond'].grid;\n    var newRow = frappe.model.add_child(frm.doc, childTable.doctype, 'current_bond');\n    frappe.model.set_value(newRow.doctype, newRow.name, 'name_of_bankinsurance_company', data.name_of_bankinsurance_company);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'facility', data.facility);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'bonds_out_standing', data.bonds_out_standing);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'rate_charged', data.rate_charged);\n    frm.refresh_field('current_bond');\n}\n\n\n//Company tab\n\nfunction addDataToCompanyChildBondFacility(frm, data1) {\n    var childTable = frm.fields_dict['company_child'].grid;\n    var newRow = frappe.model.add_child(frm.doc, childTable.doctype, 'company_child');\n    frappe.model.set_value(newRow.doctype, newRow.name, 'name1', data1.name1);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'registration_number', data1.registration_number);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'share_held', data1.share_held);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'nature_of_business', data1. nature_of_business);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'bond_required', data1.bond_required);\n    frm.refresh_field('company_child');\n}\n\n\n//directors and shareholders\nfunction addDataToChildTable(frm, data) {\n    // Add a new row to the child table\n    var newRow = frappe.model.add_child(frm.doc, 'Directors', 'directors');\n\n    // Directly set the values to the new row\n    newRow.id_type = data.id_type;\n    newRow.id_number = data.id_number;\n    newRow.first_name = data.first_name;\n    newRow.middle_name = data.middle_name;\n    newRow.surname = data.surname;\n    newRow.contact_no = data.contact_no;\n    newRow.married_anccop = data.married_anccop;\n    newRow.share_held = data.share_held;\n    newRow.fax_no = data.fax_no;\n    newRow.e_mail_id = data.e_mail_id;\n    newRow.designation = data.designation;\n\n    // Set the 'name' field in the child doctype to the full_name\n    newRow.full_name = data.full_name;\n\n    // Refresh the child table to reflect the new row\n    frm.refresh_field('directors');\n}\n\n\n\nfunction clear_attachment(frm) {\n    if (frm.doc.status === \"Submitted\" || frm.doc.workflow_state === \"Submitted\") {\n        // Disable the file attachment field\n        frm.set_df_property(\"file_attach_fieldname\", \"read_only\", 1);\n\n        // Disable the \"Clear\" button immediately\n        $(\".btn[data-action='clear_attachment']\").prop(\"disabled\", true).addClass(\"disabled\");\n    } else {\n        // Enable the file attachment field\n        frm.set_df_property(\"file_attach_fieldname\", \"read_only\", 0);\n\n        // Enable the \"Clear\" button immediately\n        $(\".btn[data-action='clear_attachment']\").prop(\"disabled\", false).removeClass(\"disabled\");\n    }\n}\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "DCI Proposals",
  "enabled": 0,
  "modified": "2025-09-26 13:54:29.418624",
  "module": "Marketing",
  "name": "Delete",
  "script": "frappe.listview_settings[\"DCI Proposals\"] = {\n    onload(listview) {\n        listview.page.add_actions_menu_item(__('Delete'), () => {\n            listview.delete_selected();\n        }, false);\n    }\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Claim Process",
  "enabled": 1,
  "modified": "2025-12-08 08:10:35.633135",
  "module": null,
  "name": "claim process latest script",
  "script": "frappe.ui.form.on('Claim Process', {\r\n   \r\n        \r\nonload: function(frm) {\r\n           \r\nhide_all_claim_fields(frm);\r\n\r\n        if (frm.doc.client) {\r\n            process_client_selection(frm, frm.doc.client);\r\n        }\r\n        // Fetch clients from CI Claim\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: { \r\n                doctype: 'CI Claim', \r\n                filters: {}, \r\n                fields: ['ph_name', 'client_type'],   // fetch client_type also\r\n                limit_page_length: 0\r\n            },\r\n            callback: function(ciResponse) {\r\n                let clientOptions = [];\r\n                \r\n                clientOptions.sort();\r\n                if (ciResponse.message) {\r\n                    ciResponse.message.forEach(r => {\r\n                        if (r.client_type === \"DCI\") {\r\n                            clientOptions.push(`DCI[${r.ph_name}]`);\r\n                        } else if (r.client_type === \"ECI\") {\r\n                            clientOptions.push(`ECI[${r.ph_name}]`);\r\n                        } else {\r\n                            clientOptions.push(`${r.ph_name}`);\r\n                        }\r\n                    });\r\n                }\r\n\r\n                // Fetch clients from Bond Claims\r\n                frappe.call({\r\n                    method: 'frappe.client.get_list',\r\n                    args: { \r\n                        doctype: 'Bond Claims', \r\n                        filters: {}, \r\n                        fields: ['client'],\r\n                        limit_page_length: 0\r\n                    },\r\n                    callback: function(bondResponse) {\r\n                        if (bondResponse.message) {\r\n                            bondResponse.message.forEach(r => {\r\n                                clientOptions.push(`BND[${r.client}]`);\r\n                            });\r\n                        }\r\n\r\n                        // Deduplicate\r\n                        const uniqueOptions = [...new Set(clientOptions)];\r\n                         uniqueOptions.sort();\r\n                            clientOptions.sort();\r\n                        // Set dropdown options\r\n                        frm.set_df_property('client', 'options', uniqueOptions.join('\\n'));\r\n                        frm.refresh_field('client');\r\n\r\n                        console.log(\"Client dropdown options set:\", uniqueOptions);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    },\r\n    refresh: function(frm){\r\n        \r\n    hide_all_claim_fields(frm);\r\n\r\n        if (frm.doc.client) {\r\n            process_client_selection(frm, frm.doc.client);\r\n        }\r\n        \r\n    // Always calculate workflow_state safely\r\nvar workflow_state = frm.doc.workflow_state || '';\r\n\r\n// List of fields to apply the condition to\r\nlet fields_to_lock = [\r\n    'buyer',\r\n    'policy_number',\r\n    'claim_ref_no'\r\n    // add more if needed\r\n];\r\n\r\n// ALWAYS SHOW these fields when Approved or Pending\r\nif (workflow_state === \"Approved\" || workflow_state === \"Pending\") {\r\n    fields_to_lock.forEach(f => frm.toggle_display(f, true));\r\n}\r\n\r\n// FINAL universal read-only condition for all fields\r\nfields_to_lock.forEach(f => {\r\n    if (workflow_state === \"Approved\" || !frm.is_new() || workflow_state === \"\") {\r\n        frm.set_df_property(f, 'read_only', 1);\r\n    } else {\r\n        frm.set_df_property(f, 'read_only', 0);\r\n    }\r\n});\r\n\r\n        \r\n        \r\n        \r\n        frm.fields_dict['insuredamt'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n        frm.fields_dict['beci'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n        frm.fields_dict['claimamount'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n        \r\n    \r\n    },\r\n \r\n\r\n    client: function(frm) {\r\n        \r\n        frm.set_value('client1', frm.doc.client);\r\n    if (frm.doc.client) {\r\n            // Remove prefixes like DCI[ ], ECI[ ], BND[ ] and keep only inside text\r\n            let plainName = frm.doc.client.replace(/^[A-Z]+\\[|\\]$/g, '');\r\n            //frm.set_value('pname', plainName);\r\n        }\r\n    \r\n        if (!frm.doc.paymentrefno) {\r\n            generateNumber(frm);\r\n        }\r\n        var selectedClient = frm.doc.client;\r\n        console.log(\"Selected client:\", selectedClient);\r\n\r\n        if (!selectedClient) {\r\n            // reset field if no client is selected\r\n            frm.set_df_property('policy_number', 'options', []);\r\n            return;\r\n        }\r\n\r\n        // // \u2705 Remove prefix DCI[...] or BND[...] to get plain name\r\n        // let cleanClient = selectedClient.replace(/^(DCI|BND)\\[|\\]$/g, '');\r\n        // console.log(\"Clean client name:\", cleanClient);\r\n        // Remove prefixes like DCI[ ], ECI[ ], BND[ ]\r\n        let cleanClient = selectedClient.replace(/^(DCI|ECI|BND)\\[|\\]$/g, '').trim();\r\n        console.log(\"Clean client name:\", cleanClient);\r\n\r\n\r\n        // // \u2705 Decide doctype and fields dynamically\r\n        // let doctypeName = selectedClient.startsWith(\"DCI[\") ? 'CI Claim' : 'Bond Claims';\r\n        // let policyField = selectedClient.startsWith(\"DCI[\") ? 'policyno' : 'bond_no';\r\n        // let clientField = selectedClient.startsWith(\"DCI[\") ? 'ph_name' : 'client';\r\n        \r\n        // Determine doctype for DCI, ECI, BND\r\nlet doctypeName = '';\r\nlet clientField = '';\r\nlet policyField = '';\r\n\r\nif (\r\n    selectedClient.startsWith(\"DCI[\") || selectedClient.startsWith(\"DCI [\") ||\r\n    selectedClient.startsWith(\"ECI[\") || selectedClient.startsWith(\"ECI [\")\r\n    ){\r\n    doctypeName = 'CI Claim';\r\n    clientField = 'ph_name';\r\n    policyField = 'policyno';\r\n    \r\n    // set policy_type correctly\r\n    if (selectedClient.includes(\"DCI\")) {\r\n        frm.set_value(\"policy_type\", \"DCI\");\r\n    } else if (selectedClient.includes(\"ECI\")) {\r\n        frm.set_value(\"policy_type\", \"ECI\");\r\n    }\r\n\r\n} \r\n\r\nelse if (\r\n    selectedClient.startsWith(\"BND[\") || selectedClient.startsWith(\"BND [\")\r\n) {\r\n    doctypeName = \"Bond Claims\";\r\n    clientField = \"client\";\r\n    policyField = \"bond_no\";\r\n    frm.set_value(\"policy_type\", \"BND\");\r\n}\r\n// else if (selectedClient.startsWith(\"BND[\")) {\r\n//     doctypeName = 'Bond Claims';\r\n//     clientField = 'client';\r\n//     policyField = 'bond_no';\r\n// }\r\nhide_all_claim_fields(frm);\r\n        if (frm.doc.client) {\r\n            process_client_selection(frm, frm.doc.client);\r\n        }\r\nconsole.log(\"Doctype:\", doctypeName, \"Client Field:\", clientField, \"Policy Field:\", policyField);\r\n\r\n\r\n        // \u2705 Fetch policy numbers\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: doctypeName,\r\n                filters: { [clientField]: cleanClient },\r\n                fields: [policyField],\r\n                limit_page_length: 0  // fetch all policies\r\n            },\r\n            callback: function(response) {\r\n                console.log(\"Policy API response:\", response);\r\n\r\n                if (response.message && response.message.length > 0) {\r\n                    let policyNumbers = response.message.map(r => r[policyField]);\r\n                    let uniquePolicies = [...new Set(policyNumbers)];\r\n                    console.log(\"Policy numbers:\", uniquePolicies);\r\n\r\n                    // Populate dropdown with policy numbers\r\n                    frm.set_df_property('policy_number', 'options', uniquePolicies.join('\\n'));\r\n\r\n                    // Auto select if only one policy exists\r\n                    if (uniquePolicies.length === 1) {\r\n                        frm.set_value('policy_number', uniquePolicies[0]);\r\n                        console.log(\"Single policy number set:\", uniquePolicies[0]);\r\n                    }\r\n                } else {\r\n                    console.log(\"No policy numbers found for client:\", cleanClient);\r\n                    frm.set_df_property('policy_number', 'options', []);\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error(\"Error fetching policy numbers:\", err);\r\n            }\r\n        });\r\n        \r\n  \r\n    \r\n    },\r\npolicy_number: function(frm) {\r\n        var policyNumber = frm.doc.policy_number;\r\n\r\n\r\n        // First search in CI Claim\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'CI Claim',\r\n                filters: { policyno: policyNumber },\r\n                fields: ['client_type', 'workflow_state', 'buyer', 'claim_refno'],\r\n                limit_page_length: 0\r\n            },\r\n            callback: function(cIClaimResponse) {\r\n                if (cIClaimResponse.message && cIClaimResponse.message.length > 0) {\r\n                    let record = cIClaimResponse.message[0];\r\n\r\n                    // Set fields from CI Claim\r\n                    frm.set_value('policy_type', record.client_type || '');\r\n                    frm.set_value('status', record.workflow_state || '');\r\n\r\n                  // Populate claim_ref_no dropdown\r\n                    let claimRefs = cIClaimResponse.message.map(r => r.claim_refno).filter(Boolean);\r\n                    frm.set_df_property('claim_ref_no', 'options', [...new Set(claimRefs)].join('\\n'));\r\n                    if (claimRefs.length === 1) {\r\n                        frm.set_value('claim_ref_no', claimRefs[0]);\r\n                    }\r\n\r\n                    // Populate buyer dropdown\r\n                    let buyers = cIClaimResponse.message.map(r => r.buyer).filter(Boolean);\r\n                    frm.set_df_property('buyer', 'options', [...new Set(buyers)].join('\\n'));\r\n                    if (buyers.length === 1) {\r\n                        frm.set_value('buyer', buyers[0]);\r\n                    }\r\n\r\n                } else {\r\n                    // If not found, search in Bond Claims\r\n                    frappe.call({\r\n                        method: 'frappe.client.get_list',\r\n                        args: {\r\n                            doctype: 'Bond Claims',\r\n                            filters: { bond_no: policyNumber },\r\n                            fields: ['policy_type', 'workflow_state', 'claim_ref_no'],\r\n                            limit_page_length: 0\r\n                        },\r\n                        callback: function(bondClaimResponse) {\r\n        if (bondClaimResponse.message && bondClaimResponse.message.length > 0) {\r\n            // Set policy_type to BND\r\n            frm.set_value('policy_type', 'BND');\r\n\r\n            // Set status from first record\r\n            frm.set_value('status', bondClaimResponse.message[0].workflow_state || '');\r\n\r\n            // Populate claim_ref_no dropdown\r\n            let claimRefs = bondClaimResponse.message.map(r => r.claim_ref_no).filter(Boolean);\r\n            frm.set_df_property('claim_ref_no', 'options', [...new Set(claimRefs)].join('\\n'));\r\n            if (claimRefs.length === 1) {\r\n                frm.set_value('claim_ref_no', claimRefs[0]);\r\n            }\r\n\r\n            // Populate buyer dropdown\r\n            let buyers = bondClaimResponse.message.map(r => r.buyer).filter(Boolean);\r\n            frm.set_df_property('buyer', 'options', [...new Set(buyers)].join('\\n'));\r\n            if (buyers.length === 1) {\r\n                frm.set_value('buyer', buyers[0]);\r\n            }\r\n\r\n        } else {\r\n            frappe.msgprint(__('No Bond Claim found for Policy Number: ' + policyNumber));\r\n            frm.set_df_property('buyer', 'options', []);\r\n            frm.set_df_property('claim_ref_no', 'options', []);\r\n        }\r\n    }\r\n                    });\r\n                }\r\n            }\r\n        });\r\n    },\r\n    \r\n     bond: function(frm) {\r\n        // If Bond is checked, hide DCI and ECI\r\n        if (frm.doc.bond) {\r\n            frm.toggle_display(['dci', 'eci'], false);\r\n        } else {\r\n            frm.toggle_display(['dci', 'eci'], true);\r\n        }\r\n    },\r\n\r\n    dci: function(frm) {\r\n        // If DCI is checked, hide Bond and ECI\r\n        if (frm.doc.dci) {\r\n            frm.toggle_display(['bond', 'eci'], false);\r\n        } else {\r\n            frm.toggle_display(['bond', 'eci'], true);\r\n        }\r\n    },\r\n\r\n    eci: function(frm) {\r\n        // If ECI is checked, hide Bond and DCI\r\n        if (frm.doc.eci) {\r\n            frm.toggle_display(['bond', 'dci'], false);\r\n        } else {\r\n            frm.toggle_display(['bond', 'dci'], true);\r\n        }\r\n    },\r\n\r\n    next: function(frm) {\r\n        var selectedFields = [];\r\n\r\n        // Checking if 'Bond' is selected\r\n        if (frm.doc.bond) {\r\n            selectedFields.push('Bond');\r\n        }\r\n\r\n        // Checking if 'DCI' is selected\r\n        if (frm.doc.dci) {\r\n            selectedFields.push('DCI');\r\n        }\r\n\r\n        // Checking if 'ECI' is selected\r\n        if (frm.doc.eci) {\r\n            selectedFields.push('ECI');\r\n        }\r\n\r\n        // If no field is selected, show a message\r\n        if (selectedFields.length === 0) {\r\n            frappe.msgprint(__('Please select at least one field.'));\r\n        }\r\n        // If more than one field is selected, show a message\r\n        else if (selectedFields.length > 1) {\r\n            frappe.msgprint(__('Please select only one field at a time.'));\r\n        } else {\r\n            // Set route options based on selected field\r\n            frappe.route_options = {\r\n                client: frm.doc.client,\r\n                policy_no: frm.doc.policy_number,\r\n                type: frm.doc.policy_type,\r\n                payment_ref_no: frm.doc.paymentrefno,\r\n                buyer: frm.doc.buyer,\r\n                claim_ref_no: frm.doc.claim_ref_no,\r\n                claim_ammount: frm.doc.claimamount,\r\n                reinsure: frm.doc.reinsure,\r\n                status: frm.doc.status,\r\n               // process_date: frm.doc.processdate,\r\n                cause_of_loss: frm.doc.causeofloss,\r\n                insured_amt: frm.doc.insuredamt,\r\n                beci: frm.doc.beci\r\n            };\r\n\r\n            // Open new document based on selected field\r\n            if (selectedFields[0] === 'Bond') {\r\n                frappe.new_doc('Claim Processing Bond Claim');\r\n            } else if (selectedFields[0] === 'DCI') {\r\n                frappe.new_doc('Claim Processing Dci');\r\n            } else if (selectedFields[0] === 'ECI') {\r\n                frappe.new_doc('Claim Processing ECI');\r\n            }\r\n        }\r\n    },\r\n     \r\n    \r\n    buyer: function(frm){\r\n        let buyer = frm.doc.buyer;\r\n         frm.set_value('buyer', buyer);\r\n\r\n    },\r\n    \r\nclaim_ref_no: function(frm) {\r\n        let claimRef = frm.doc.claim_ref_no;\r\n        let policyNumber = frm.doc.policy_number;\r\n        //frm.set_value('claim_refno', claimRef);\r\n        // Search in CI Claim first\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'CI Claim',\r\n                filters: {\r\n                    policyno: policyNumber,\r\n                    claim_refno: claimRef\r\n                },\r\n                fields: ['cl_claim_date', 'claim_value__p', 'cause_of_loss', 'credit_limit'],\r\n                limit_page_length: 1\r\n            },\r\n            callback: function(ciResponse) {\r\n                if (ciResponse.message && ciResponse.message.length > 0) {\r\n                    let record = ciResponse.message[0];\r\n                    frm.set_value('processdate', record.cl_claim_date);\r\n                    frm.set_value('claimamount', record.claim_value__p);\r\n                    frm.set_value('causeofloss', record.cause_of_loss);\r\n                    frm.set_value('insuredamt', record.credit_limit);\r\n                } else {\r\n                    // Check Bond Claims\r\n                    frappe.call({\r\n                        method: 'frappe.client.get_list',\r\n                        args: {\r\n                            doctype: 'Bond Claims',\r\n                            filters: {\r\n                                bond_no: policyNumber,   // <-- corrected field\r\n                                claim_ref_no: claimRef\r\n                            },\r\n                            fields: ['reason', 'value', 'bond_value'],\r\n                            limit_page_length: 1\r\n                        },\r\n                        callback: function(bondResponse) {\r\n                            if (bondResponse.message && bondResponse.message.length > 0) {\r\n                                let record = bondResponse.message[0];\r\n                                frm.set_value('causeofloss', record.reason);\r\n                                frm.set_value('claimamount', record.value);\r\n                                frm.set_value('insuredamt', record.bond_value);\r\n                                //frm.set_value('processdate', record.process_date);\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        });\r\n\r\n    //   if (claimRef) {\r\n    //         hide_claim_fields(frm, false);\r\n    //     }\r\n    \r\n    if (frm.doc.policy_number) {\r\n    hide_claim_fields(frm, false);\r\n}\r\n\r\n}\r\n\r\n});\r\n\r\n\r\nfunction generateNumber(frm) {\r\n    if (!frm.doc.paymentrefno) {\r\n        let currentYear = new Date().getFullYear();\r\n        let prefix = `PMT/${currentYear}/`;\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Claim Process',\r\n                fields: ['paymentrefno', 'creation'],\r\n                order_by: 'creation desc',\r\n                limit: 1\r\n            },\r\n            callback: function(r) {\r\n                if (r.message && r.message.length > 0) {\r\n                    let lastPMTNumber = r.message[0].paymentrefno;\r\n                    let lastNumber = parseInt(lastPMTNumber.split(\"/\").pop());\r\n                    if (!isNaN(lastNumber)) {\r\n                        let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n                        frm.set_value('paymentrefno', prefix + newNumber);\r\n                    }\r\n                } else {\r\n                    frm.set_value('paymentrefno', prefix + '0001');\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\nfunction hide_all_claim_fields(frm) {\r\n    [\r\n        \"invoice_attached\",\r\n        \"delivery_notes\",\r\n        \"sureties\",\r\n        \"cl_approval_form__annexure\",\r\n        \"order_attached\",\r\n        \"statement\",\r\n        \"claims_application_form\",\r\n        \"copies_of_correspondence_with_the_buyer\",\r\n        \"claim_application\",\r\n        \"statement_to_show\",\r\n        \"demand_letter\",\r\n        \"contractor_final_account_report\"\r\n    ].forEach(f => {\r\n        frm.set_df_property(f, \"hidden\", 1);\r\n        frm.doc[f] = 0;        // instead of set_value\r\n        frm.refresh_field(f);\r\n    });\r\n}\r\n\r\n\r\n/* ---------------------------------------------\r\n   Decide which doctype to load\r\n---------------------------------------------- */\r\nfunction process_client_selection(frm, selected_value) {\r\n\r\n    let pure_name = extract_name(selected_value);\r\n\r\n    if (selected_value.startsWith(\"ECI\") || selected_value.startsWith(\"DCI\")) {\r\n        load_potential_claims(frm, pure_name);\r\n    }\r\n    else if (selected_value.startsWith(\"BND\")) {\r\n        load_bond_claims(frm, pure_name);\r\n    }\r\n}\r\n\r\n\r\n/* ---------------------------------------------\r\n   Extract actual name \u2192 ECI[rana] \u2192 rana\r\n---------------------------------------------- */\r\nfunction extract_name(text) {\r\n    if (text.includes(\"[\")) {\r\n        return text.split(\"[\")[1].replace(\"]\", \"\").trim();\r\n    }\r\n    return text;\r\n}\r\n\r\n\r\n/* ---------------------------------------------\r\n   LOAD Potential Claims\r\n---------------------------------------------- */\r\nfunction load_potential_claims(frm, client_name) {\r\n\r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: \"Potential Claims\",\r\n            filters: { ph_name: client_name },\r\n            fields: [\r\n                \"invoice_attached\",\r\n                \"delivery_notes\",\r\n                \"sureties\",\r\n                \"cl_approval_form__annexure\",\r\n                \"order_attached\",\r\n                \"statement\",\r\n                \"claims_application_form\",\r\n                \"copies_of_correspondence_with_the_buyer\"\r\n            ]\r\n        },\r\n        callback(r) {\r\n            if (!r.message || r.message.length === 0) {\r\n                frappe.msgprint(\"No Potential Claim found for \" + client_name);\r\n                return;\r\n            }\r\n\r\n            let doc = r.message[0];\r\n\r\n            // SHOW ONLY CHECKED FIELDS\r\n            [\r\n                \"invoice_attached\",\r\n                \"delivery_notes\",\r\n                \"sureties\",\r\n                \"cl_approval_form__annexure\",\r\n                \"order_attached\",\r\n                \"statement\",\r\n                \"claims_application_form\",\r\n                \"copies_of_correspondence_with_the_buyer\"\r\n            ].forEach(f => {\r\n                if (doc[f] === 1) {\r\n                    frm.set_df_property(f, \"hidden\", 0);\r\n                    frm.doc[f] = 1;     // NO set_value\r\n                    frm.refresh_field(f);\r\n                }\r\n            });\r\n\r\n            // SHOW these 2 only in ECI/DCI (unchecked)\r\n            frm.set_df_property(\"claim_application\", \"hidden\", 0);\r\n            frm.refresh_field(\"claim_application\");\r\n\r\n            frm.set_df_property(\"statement_to_show\", \"hidden\", 0);\r\n            frm.refresh_field(\"statement_to_show\");\r\n        }\r\n    });\r\n}\r\n\r\n\r\n/* ---------------------------------------------\r\n   LOAD Bond Claims\r\n---------------------------------------------- */\r\nfunction load_bond_claims(frm, client_name) {\r\n\r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: \"Bond Claims\",\r\n            filters: { client: client_name },\r\n            fields: [\"demand_letter\", \"contractor_final_account_report\"]\r\n        },\r\n        callback(r) {\r\n            if (!r.message || r.message.length === 0) {\r\n                frappe.msgprint(\"No Bond Claim found for \" + client_name);\r\n                return;\r\n            }\r\n\r\n            let doc = r.message[0];\r\n\r\n            [\"demand_letter\", \"contractor_final_account_report\"].forEach(f => {\r\n                if (doc[f] === 1) {\r\n                    frm.set_df_property(f, \"hidden\", 0);\r\n                    frm.doc[f] = 1;     // NO set_value\r\n                    frm.refresh_field(f);\r\n                }\r\n            });\r\n        }\r\n    });\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Credit Limits Application",
  "enabled": 0,
  "modified": "2025-10-17 07:22:30.682458",
  "module": null,
  "name": "credit limit Application new",
  "script": "frappe.ui.form.on('Credit Limits Application', {\n    onload: function(frm) {\n        if (!frm.doc.credit_limit_no) {\n            generateNumber(frm);\n        }\n    },\n    refresh: function(frm) {\n        \n         \n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Policy Approvals',\n                filters: { \"workflow_state\": \"Accepted\" },\n                fields: ['policy_number'],\n                limit_page_length: 0\n            },\n            callback: function(response) {\n                if (response.message && response.message.length > 0) {\n                    let policy_numbers = response.message.map(p => p.policy_number);\n                    frm.set_df_property('policy_number', 'options', [''].concat(policy_numbers));\n                } else {\n                    frm.set_df_property('policy_number', 'options', ['No Accepted Policy Found']);\n                }\n                frm.refresh_field('policy_number');  // Refresh UI to apply changes\n            }\n        });\n        \n        frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Buyer',\n            fields: ['buyer_name'],\n             limit_page_length: 0\n        },\n        callback: function(response) {\n            var buyers = response.message;\n            var options = buyers.map(buyer => buyer.buyer_name);\n            frm.set_df_property('buyer', 'options', options);\n            \n       \n\n        }\n    });\n\n\n        \n\n\n\n    },\n    buyer: function(frm) {\n            frm.set_value('buyer_name', frm.doc.buyer);\n            frm.set_value('buyer', frm.doc.buyer_name);\n        \n     },\n});\nfunction generateNumber(frm) {\n    if (!frm.doc.credit_limit_no) {\n        let currentYear = new Date().getFullYear();\n        let prefix = `CRL/${currentYear}/`;\n\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Credit Limits Application',\n                fields: ['credit_limit_no'],\n                order_by: 'creation desc',\n                limit: 1\n            },\n            callback: function(r) {\n                let newNumber = '0001';\n                if (r.message && r.message.length > 0) {\n                    let last_credit_limit_no = r.message[0].credit_limit_no;\n                    let match = last_credit_limit_no.match(/CRL\\/\\d{4}\\/(\\d+)/);\n                    if (match) {\n                        newNumber = (parseInt(match[1]) + 1).toString().padStart(4, '0');\n                    }\n                }\n                frm.set_value('credit_limit_no', prefix + newNumber);\n            }\n        });\n        \n    }\n}\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Security Calculation",
  "enabled": 1,
  "modified": "2025-10-24 09:27:26.255438",
  "module": "UnderWriting",
  "name": "Security_Calculations",
  "script": "frappe.ui.form.on('Security Calculation', {\r\n    onload: function(frm) {\r\n        // Trigger fetch when facility_no already exists (e.g., opened from Bond Application)\r\n        if (frm.doc.facility_no) {\r\n            fetch_facility_and_populate(frm, frm.doc.facility_no);\r\n        }\r\n\r\n        // Calculate total exposure if data already exists\r\n        calculate_total_exposure(frm);\r\n         update_limit2(frm);\r\n          update_limit3(frm);\r\n           update_limit4(frm);\r\n            update_limit5(frm);\r\n            \r\n    },\r\n\r\n    refresh: function(frm) {\r\n        // Always ensure total is correct on refresh\r\n        calculate_total(frm);\r\n        calculate_total_exposure(frm);\r\n         update_splitups(frm);\r\n        \r\n          frm.fields_dict.limit1data.$input.css(\"text-align\", \"right\");\r\n         frm.fields_dict.limit2data.$input.css(\"text-align\", \"right\");\r\n          frm.fields_dict.limit3data.$input.css(\"text-align\", \"right\");\r\n           frm.fields_dict.limit4data.$input.css(\"text-align\", \"right\");\r\n            frm.fields_dict.limit5data.$input.css(\"text-align\", \"right\");\r\n             frm.fields_dict.security_per_limit1.$input.css(\"text-align\", \"right\");\r\n              frm.fields_dict.security_per_limit2.$input.css(\"text-align\", \"right\");\r\n               frm.fields_dict.security_per_limit3.$input.css(\"text-align\", \"right\");\r\n                frm.fields_dict.security_per_limit4.$input.css(\"text-align\", \"right\");\r\n                 frm.fields_dict.security_per_limit5.$input.css(\"text-align\", \"right\");\r\n                  frm.fields_dict.limit1.$input.css(\"text-align\", \"right\");\r\n                   frm.fields_dict.limit2.$input.css(\"text-align\", \"right\");\r\n                    frm.fields_dict.limit3.$input.css(\"text-align\", \"right\");\r\n                     frm.fields_dict.limit4.$input.css(\"text-align\", \"right\");\r\n                      frm.fields_dict.limit5.$input.css(\"text-align\", \"right\"); \r\n                      frm.fields_dict.security_limit1.$input.css(\"text-align\", \"right\");\r\n                       frm.fields_dict.security_limit2.$input.css(\"text-align\", \"right\");\r\n                        frm.fields_dict.security_limit3.$input.css(\"text-align\", \"right\");\r\n                         frm.fields_dict.security_limit4.$input.css(\"text-align\", \"right\");\r\n                          frm.fields_dict.security_limit5.$input.css(\"text-align\", \"right\");\r\n                          \r\n                              frm.fields_dict.split_ups_limit1.$input.css(\"text-align\", \"right\");\r\n                       frm.fields_dict.split_ups_limit2.$input.css(\"text-align\", \"right\");\r\n                        frm.fields_dict.split_ups_limit3.$input.css(\"text-align\", \"right\");\r\n                         frm.fields_dict.split_ups_limit4.$input.css(\"text-align\", \"right\");\r\n                          frm.fields_dict.split_ups_limit5.$input.css(\"text-align\", \"right\");\r\n                          \r\n                          \r\n                          frm.fields_dict.bf_exposure.$input.css(\"text-align\", \"right\");\r\n                        frm.fields_dict.currency_code.$input.css(\"text-align\", \"right\");\r\n                         frm.fields_dict.total_exposure.$input.css(\"text-align\", \"right\");\r\n                          frm.fields_dict.total_required.$input.css(\"text-align\", \"right\");\r\n        \r\n    },\r\n\r\n    // When facility_no changes (either typed or received from another form)\r\n    facility_no: function(frm) {\r\n        if (frm.doc.facility_no) {\r\n            fetch_facility_and_populate(frm, frm.doc.facility_no);\r\n        } else {\r\n            clear_facility_fields(frm);\r\n            calculate_total(frm);\r\n        }\r\n    },\r\n    \r\n    \r\n\r\n     limit1data: function(frm) {\r\n        update_limit2(frm);\r\n          update_limit3(frm);\r\n           update_limit4(frm);\r\n            update_limit5(frm);\r\n            \r\n            update_splitups(frm);\r\n    },\r\n\r\n    // Recalculate whenever any security_limit field is edited\r\n    security_limit1: function(frm) { calculate_total(frm); },\r\n    security_limit2: function(frm) { calculate_total(frm); },\r\n    security_limit3: function(frm) { calculate_total(frm); },\r\n    security_limit4: function(frm) { calculate_total(frm); },\r\n    security_limit5: function(frm) { calculate_total(frm); },\r\n\r\n    // Recalculate total exposure when these fields change\r\n    currency_code: function(frm) { calculate_total_exposure(frm); },\r\n    bf_exposure: function(frm) { calculate_total_exposure(frm); },\r\n});\r\n\r\n// Fetch data from Bond Facility Quotation and populate limits\r\nfunction fetch_facility_and_populate(frm, facility_no) {\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Bond Facility Quotation',\r\n            filters: { bond_facility_no: facility_no },\r\n            fields: [\r\n                'bond_facility_limit1', \r\n                'bond_facility_limit2',\r\n                'bond_facility_limit3',\r\n                'bond_facility_limit4',\r\n                'net_bond_facility',\r\n                'security_percentage_for_limit_1',\r\n                'security_percentage_for_limit_2',\r\n                'security_percentage_for_limit_3',\r\n                'security_percentage_for_limit_4',\r\n                'security_percentage_for_limit_5'\r\n            ],\r\n            limit_page_length: 1\r\n        },\r\n        callback: function(response) {\r\n            if (response.message && response.message.length > 0) {\r\n                var data = response.message[0];\r\n\r\n                // Populate limit and percentage fields\r\n                frm.set_value('limit1data', data.bond_facility_limit1 || '');\r\n                frm.set_value('limit2data', data.bond_facility_limit2 || '');\r\n                frm.set_value('limit3data', data.bond_facility_limit3 || '');\r\n                frm.set_value('limit4data', data.bond_facility_limit4 || '');\r\n                frm.set_value('limit5data', data.net_bond_facility || '');\r\n\r\n                frm.set_value('security_per_limit1', data.security_percentage_for_limit_1 || '');\r\n                frm.set_value('security_per_limit2', data.security_percentage_for_limit_2 || '');\r\n                frm.set_value('security_per_limit3', data.security_percentage_for_limit_3 || '');\r\n                frm.set_value('security_per_limit4', data.security_percentage_for_limit_4 || '');\r\n                frm.set_value('security_per_limit5', data.security_percentage_for_limit_5 || '');\r\n\r\n                // Recalculate totals after fetch\r\n                calculate_total(frm);\r\n                calculate_total_exposure(frm);\r\n            } else {\r\n                frappe.msgprint('No matching facility found for: ' + facility_no);\r\n                clear_facility_fields(frm);\r\n                calculate_total(frm);\r\n                calculate_total_exposure(frm);\r\n            }\r\n        },\r\n        error: function(err) {\r\n            console.error(err);\r\n            frappe.msgprint('An error occurred while fetching data from Bond Facility. Please check the console for details.');\r\n        }\r\n    });\r\n}\r\n\r\nfunction clear_facility_fields(frm) {\r\n    // Clear display & numeric fields\r\n    frm.set_value('limit1data', '');\r\n    frm.set_value('limit2data', '');\r\n    frm.set_value('limit3data', '');\r\n    frm.set_value('limit4data', '');\r\n    frm.set_value('limit5data', '');\r\n\r\n    frm.set_value('security_per_limit1', '');\r\n    frm.set_value('security_per_limit2', '');\r\n    frm.set_value('security_per_limit3', '');\r\n    frm.set_value('security_per_limit4', '');\r\n    frm.set_value('security_per_limit5', '');\r\n\r\n    frm.set_value('security_limit1', 0);\r\n    frm.set_value('security_limit2', 0);\r\n    frm.set_value('security_limit3', 0);\r\n    frm.set_value('security_limit4', 0);\r\n    frm.set_value('security_limit5', 0);\r\n}\r\n\r\n// --- Calculate Total Required (Sum of all Security Limits) ---\r\nfunction calculate_total(frm) {\r\n    let limit1 = parseFloat(frm.doc.security_limit1) || 0;\r\n    let limit2 = parseFloat(frm.doc.security_limit2) || 0;\r\n    let limit3 = parseFloat(frm.doc.security_limit3) || 0;\r\n    let limit4 = parseFloat(frm.doc.security_limit4) || 0;\r\n    let limit5 = parseFloat(frm.doc.security_limit5) || 0;\r\n\r\n    let total = limit1 + limit2 + limit3 + limit4 + limit5;\r\n\r\n    console.log(\"Security Limits:\", { limit1, limit2, limit3, limit4, limit5, total });\r\n\r\n    frm.set_value('total_required', total);\r\n}\r\n\r\n// --- Calculate Total Exposure = Currency Code + BF Exposure ---\r\nfunction calculate_total_exposure(frm) {\r\n    let currency = parseFloat(frm.doc.currency_code) || 0;\r\n    let exposure = parseFloat(frm.doc.bf_exposure) || 0;\r\n\r\n    let total = currency + exposure;\r\n\r\n    console.log(\"Total Exposure:\", { currency, exposure, total });\r\n\r\n    frm.set_value('total_exposure', total);\r\n}\r\n\r\nfunction update_limit2(frm) {\r\n    let val = parseFloat(frm.doc.limit1data) || 0;  // convert to number\r\n    if (val > 0) {\r\n        let integerPart = Math.floor(val);           // get integer part\r\n        let decimalPart = val - integerPart;         // get decimal part\r\n        frm.set_value('limit2', integerPart + 1 + decimalPart);\r\n    } else {\r\n        frm.set_value('limit2', 0);\r\n    }\r\n}\r\n\r\n\r\n\r\n\r\nfunction update_limit3(frm) {\r\n    let val = parseFloat(frm.doc.limit2data) || 0;  \r\n    if (val > 0) {\r\n        let integerPart = Math.floor(val);           \r\n        let decimalPart = val - integerPart;         \r\n        frm.set_value('limit3', integerPart + 1 + decimalPart);\r\n    } else {\r\n        frm.set_value('limit3', 0);\r\n    }\r\n}\r\n\r\n\r\n\r\nfunction update_limit4(frm) {\r\n    let val = parseFloat(frm.doc.limit3data) || 0;  // convert to number\r\n    if (val > 0) {\r\n        let integerPart = Math.floor(val);           // get integer part\r\n        let decimalPart = val - integerPart;         // get decimal part\r\n        frm.set_value('limit4', integerPart + 1 + decimalPart);\r\n    } else {\r\n        frm.set_value('limit4', 0);\r\n    }\r\n}\r\n\r\nfunction update_limit5(frm) {\r\n    let val = parseFloat(frm.doc.limit4data) || 0;  // convert to number\r\n    if (val > 0) {\r\n        let integerPart = Math.floor(val);           // get integer part\r\n        let decimalPart = val - integerPart;         // get decimal part\r\n        frm.set_value('limit5', integerPart + 1 + decimalPart);\r\n    } else {\r\n        frm.set_value('limit5', 0);\r\n    }\r\n}\r\n\r\n\r\n\r\n\r\n\r\nfunction update_splitups(frm) {\r\n    let currencyVal = parseFloat(frm.doc.currency_code) || 0;\r\n    let limitVal = parseFloat(frm.doc.limit1data) || 0;\r\n\r\n    if (currencyVal > 10000) {\r\n        frm.set_value('split_ups_limit1', currencyVal);\r\n        frm.set_value('split_ups_limit2', 0);\r\n         frm.set_value('split_ups_limit3', 0);\r\n          frm.set_value('split_ups_limit4', 0);\r\n           frm.set_value('split_ups_limit5', 0);\r\n           \r\n           \r\n           \r\n           \r\n           frm.set_value('security_limit1',0);\r\n        frm.set_value('security_limit2', 0);\r\n         frm.set_value('security_limit3', 0);\r\n          frm.set_value('security_limit4', 0);\r\n           frm.set_value('security_limit5', 0);\r\n           \r\n    } else {\r\n        frm.set_value('split_ups_limit1', limitVal);\r\n        frm.set_value('split_ups_limit2', 0);\r\n         frm.set_value('split_ups_limit3', 0);\r\n          frm.set_value('split_ups_limit4', 0);\r\n           frm.set_value('split_ups_limit5', 0);\r\n           \r\n           \r\n           frm.set_value('security_limit1',0);\r\n        frm.set_value('security_limit2', 0);\r\n         frm.set_value('security_limit3', 0);\r\n          frm.set_value('security_limit4', 0);\r\n           frm.set_value('security_limit5', 0);\r\n    }\r\n    \r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Credit Limit Reviews",
  "enabled": 0,
  "modified": "2025-11-17 06:23:02.917095",
  "module": null,
  "name": "new script",
  "script": "frappe.ui.form.on('Credit Limit Reviews', {\n    refresh: function(frm) {\n        \nvar workflow_state = frm.doc.workflow_state || '';\n \n// Always keep original fields visible\nfrm.toggle_display('ph_name', true);\nfrm.toggle_display('buyer', true);\n \n// Make them read-only when approved\nif (workflow_state === \"Approved\") {\n    frm.set_df_property('ph_name', 'read_only', 1);\n    frm.set_df_property('buyer', 'read_only', 1);\n    frm.set_df_property('policy_number', 'read_only', 1);\n} else {\n    frm.set_df_property('ph_name', 'read_only', 0);\n    frm.set_df_property('buyer', 'read_only', 0);\n    frm.set_df_property('policy_number', 'read_only',0);\n\n}\n\n        frm.set_df_property('review_history', 'cannot_add_rows', true);\n        if (!frm.doc.clreview_no) {\n            generateNumber(frm);\n        }\n\n\n        if (workflow_state === \"Approved\") {\n            frm.add_custom_button(__('Print Annexure'), function() {\n                frappe.new_doc('Credit Limit  Annexure');\n                    frappe.route_options = {\n                    inception_date: frm.doc.inception_date,\n                    policy_holder_name: frm.doc.ph_name,\n                    policy_no:frm.doc.policy_number,\n                    credit_limit_no: frm.doc.credit_limit_no,\n                    buyer_name:frm.doc.buyer,\n                    trading__style: frm.doc.trading_style,\n                  // reinsurer: frm.doc.reinsurer,\n                    location: frm.doc.location,\n                  credit_limit: frm.doc.current_limit,\n                    terms_of_payments: frm.doc.terms_of_payments,\n                    conditions: frm.doc.conditions,\n                    buyer_id: frm.doc.buyer_id,\n                    days_from:frm.doc.days_from\n                };\n                console.log(\"Print Annexur clicked!\");\n            }).addClass(\"btn-primary\");\n        }\n        \n        if (frm.doc.yes) {\n        \n        if (workflow_state === \"Pending\" || workflow_state === \"Approved\") {\n            frm.add_custom_button(__('View CB Report'), function() {\n                \n        frappe.call({\n        method: \"frappe.client.get\",\n        args: {\n            doctype: \"CB Report\",\n            filters: {\n                buyer: frm.doc.buyer,\n                refnumber: frm.doc.credit_limit_no,\n            },\n            fields: [\"cb_request_number\", \"reqdate\", \"buyer\", \"refnumber\", \"date\", \"catagory\", \"code\", \"details\", \"description\"]\n        },\n        callback: function (r) {\n            if (!r.exc) {\n                var cbReportData = r.message;\n                if (cbReportData) {\n                    // Open prompt dialog only if data is found\n                    frappe.prompt([\n                        {'fieldname': 'credit_bureau_request', 'fieldtype': 'Heading', 'label': 'Credit Bureau Request'},\n                        {'fieldname': 'section_break_2','fieldtype': 'Section Break','label': ''},\n                        \n                        {'fieldname': 'cb_request_number', 'fieldtype': 'Data', 'label': 'CB Req Number', 'default': cbReportData.cb_request_number},\n                        {'fieldname': 'reqdate', 'fieldtype': 'Date', 'label': 'Req.Date', 'default': cbReportData.reqdate},\n                        {'fieldname': 'column_break_1','fieldtype': 'Column Break','label': ''},\n                        {'fieldname': 'buyer', 'fieldtype': 'Data', 'label': 'Buyer', 'default': cbReportData.buyer},\n                        \n                       \n                        \n                        {'fieldname': 'refnumber', 'fieldtype': 'Data', 'label': 'Ref.Number','default': cbReportData.refnumber},\n                        \n                        {'fieldname': 'section_break_3','fieldtype': 'Section Break','label': ''},\n                        {'fieldname': 'section_break_4','fieldtype': 'Section Break','label': ''},\n                        {'fieldname': 'credit_bureau_responce', 'fieldtype': 'Heading', 'label': 'Credit Bureau Response'},\n                        {'fieldname': 'section_break_5','fieldtype': 'Section Break','label': ''},\n                        \n                        {'fieldname': 'date', 'fieldtype': 'Date', 'label': 'Date', 'default': cbReportData.date},\n                        {'fieldname': 'catagory', 'fieldtype': 'Data', 'label': 'Category', 'default': cbReportData.catagory},\n                        {'fieldname': 'code', 'fieldtype': 'Data', 'label': 'Code',  'default': cbReportData.code},\n                        \n                         {'fieldname': 'column_break_2','fieldtype': 'Column Break','label': ''},\n                        \n                        {'fieldname': 'details', 'fieldtype': 'Data', 'label': 'Details',  'default': cbReportData.details},\n                        {'fieldname': 'description', 'fieldtype': 'Small Text', 'label': 'Description', 'default': cbReportData.description},\n                    ], function(values){\n                        // Handle user input if needed\n                    }, 'CB Report');\n                } else {\n                    frappe.msgprint(\"No CB Report data found for the selected buyer.\");\n                    \n                }\n            } else {\n                console.error(\"Error occurred while fetching CB Report data:\", r.exc);\n                frappe.msgprint(\"Error occurred while fetching CB Report data. Please try again.\");\n            }\n        }\n    });\n                \n                \n                \n            }).addClass(\"btn-primary\");\n        }\n         }\n         \n        if(frm.doc.yes){\n          if (workflow_state === \"Pending\" || workflow_state === \"Approved\") {\n            frm.toggle_display('cbreport', true);\n            frm.toggle_display('report', false);\n            frm.toggle_display('cb_request', false);\n            // frm.toggle_display('table', false);\n\n        }\n        \n        \n        }\n        frm.fields_dict.director_share_holder_exposure.$input.addClass('btn-primary');\n\n        //  frm.fields_dict.cb_request.$input.addClass('btn-primary');\n        frm.fields_dict.go_to_financial_analysis.$input.addClass('btn-primary');\n        \n        \n        \n        alignFields(frm);\n        \n\n        \n\n        \n         \n    },\n   cb_request: function(frm) {\n    frappe.call({\n    method: 'frappe.client.get_list',\n    args: {\n        doctype: 'CB Request',\n        filters: {\n            buyer: frm.doc.buyer,\n            policy_type: frm.doc.policy_type\n        },\n        fields: ['toaddress', 'attention', 'from', 'attention1', 'subject']\n    },\n    callback: function (response) {\n        console.log(\"Bond Facility response:\", response);\n        \n        if (response.message && response.message.length > 0) {\n            // If records found, display a message\n            frappe.msgprint(\"CB Request already exists for this Buyer.\");\n        } else {\n            // If no records found, open a new CB Request document\n            frappe.new_doc('CB Request');\n            frappe.route_options = {\n                buyer: frm.doc.buyer,\n                refnumber: frm.doc.credit_limit_no,\n                policy_type: frm.doc.policy_type\n            };\n        }\n    },\n    error: function (err) {\n        console.error(err);\n        frappe.msgprint('An error occurred while fetching data from CB Request. Please check the console for details.');\n    }\n});\n\n},\n\n    \n   \n\n    go_to_financial_analysis: function(frm) {\n        frappe.new_doc('Financial Analysis');\n        frappe.route_options = {\n            buyer: frm.doc.buyer\n        };\n    },\n\n    director_share_holder_exposure: function(frm) {\n        openDirectorShareholderExposure(frm);\n    },\n\n    onload: function(frm) {\n       \n        \n\n            \n    //  frappe.call({\n    //   method: 'frappe.client.get_list',\n    //   args: {\n    //     'doctype': 'Credit Limit Processing',\n    //     'filters': {\n    //       'workflow_state': 'Approved'\n    //     },\n    //     'fields': ['policy_holder_name'],\n    //      limit_page_length: 100  // Adjust this value as needed\n\n    //   },\n    //   callback: function(submittedProposalsResponse) {\n    //     if (submittedProposalsResponse.message) {\n    //       var submittedProposals = submittedProposalsResponse.message.map(function(proposal) {\n    //         return proposal.policy_holder_name;\n    //       });\n    //       console.log(\"** Submitted Proposals:\", submittedProposals);\n \n    //       console.log(\"** Fetching Approved Quotations **\");\n    //       frm.set_df_property('ph_name', 'options', submittedProposals);\n    //     }\n    //   }\n    // }); // Close outer frappe.call\n  \n  \n  frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Credit Limit Processing',\n            'filters': {\n          'workflow_state': 'Approved'\n        },\n            fields: ['policy_holder_name'],\n            limit_page_length: 0  // Adjust this value as needed\n\n        },\n        callback: function(response) {\n            console.log(\"policy_holder_name received:\", response);\n            let DataArray = response.message;\n            let uniquepolicy_holder_names = new Set();\n \n            // Collect unique policy_holder_name values\n            for (let x of DataArray) {\n                uniquepolicy_holder_names.add(x.policy_holder_name);\n            }\n \n            // Convert set to array\n            let FinalArray = Array.from(uniquepolicy_holder_names);\n \n            frm.set_df_property('ph_name', 'options', FinalArray);\n            console.log(\"final\", FinalArray);\n        },\n        error: function(xhr, textStatus, errorThrown) {\n            console.error(\"Error fetching policy_holder_name:\", textStatus, errorThrown);\n        }\n    });  \n    \n    \n// frappe.call({\n//             method: 'frappe.client.get_list',\n//             args: {\n//                 doctype: 'Buyer',\n//                 fields: ['buyer_name'],\n//                 limit_page_length: 100000  // Add this line to retrieve up to 100 records\n//             },\n//             callback: function(response) {\n//                 let DataArray = response.message;\n//                 let FinalArray = [];\n//                 for (let x of DataArray) {\n//                     FinalArray.push(x.buyer_name);\n//                 }\n//                 frm.set_df_property('buyer', 'options', FinalArray);\n//                 console.log(\"final\", FinalArray);\n//             },\n//             error: function(xhr, textStatus, errorThrown) {\n//                 console.error(\"Error fetching approved bonds:\", textStatus, errorThrown);\n//             }\n//         });\n    \n//     if (frm.doc.policy_number && frm.doc.ph_name) {\n//     frappe.call({\n//         method: 'frappe.client.get_list',\n//         args: {\n//             doctype: 'Credit Limit Processing',\n//             filters: {\n//                 policy_no: frm.doc.policy_number,\n//                 policy_holder_name: frm.doc.ph_name\n//             },\n//             fields: ['buyer_name'],\n//             limit_page_length: 100000\n//         },\n//         callback: function(response) {\n//             if (response.message && response.message.length > 0) {\n//                 // Extract unique buyer names\n//                 let buyerList = [...new Set(response.message.map(x => x.buyer_name))];\n//                 frm.set_df_property('buyer', 'options', buyerList.join('\\n'));\n//                 frm.refresh_field('buyer');\n//                 console.log(\"\u2705 Final Buyer List:\", buyerList);\n//             } else {\n//                 frm.set_df_property('buyer', 'options', '');\n//                 frm.refresh_field('buyer');\n//                 console.log(\"\u26a0\ufe0f No buyers found for given filters.\");\n//             }\n//         },\n//         error: function(xhr, textStatus, errorThrown) {\n//             console.error(\"\u274c Error fetching buyer list:\", textStatus, errorThrown);\n//         }\n//     });\n// }\n\n    \n    //   frappe.call({\n    //         method: 'frappe.client.get_list',\n    //         args: {\n    //             doctype: 'Credit Limit Reviews', // Replace with the actual doctype name\n    //             filters: {\n    //                 // Define your filters here\n    //                 ph_name: frm.doc.ph_name,\n    //                 buyer: frm.doc.buyer,\n    //                 // Add more filters if needed\n    //             },\n    //             fields: ['clreview_no', 'date', 'cl_review_date', 'current_limit', 'reasons']\n    //         },\n    //         callback: function(response) {\n    //             if (response.message && response.message.length > 0) {\n    //                 response.message.forEach(function(row) {\n    //                     // Add row to review_history child table\n    //                     let new_row = frm.add_child('review_history');\n    //                     new_row.cl_review_no = row.clreview_no;\n    //                     new_row.review_date = row.date;\n    //                     new_row.expiry_date = row.cl_review_date;\n    //                     new_row.credit_limit = row.current_limit;\n    //                     new_row.reason = row.reasons;\n    //                 });\n    //                 frm.refresh_field('review_history');\n    //             }\n            \n    //     }\n    \n    // });\n    \n    \n\n    \n\n},\n\n\nbuyer: function(frm){\nfrappe.call({\n    method: 'frappe.client.get_list',\n    args: {\n        doctype: 'Buyer',\n        filters: {\n            buyer_name: frm.doc.buyer\n        },\n        fields: ['estddate', 'no_of_employees']\n    },\n    callback: function(response) {\n        // Check if response is valid\n                if (response.message && response.message.length > 0) {\n\n                var buyerdata = response.message[0];\n\n\n                // Example: Set values to fields in the form\n                frm.set_value('estd_date', buyerdata.estddate || '');\n                frm.set_value('no_of_employees', buyerdata.no_of_employees || '');\n   \n                }\n                else{\n                    frm.set_value('estd_date', '');\n                    frm.set_value('no_of_employees', '');\n                }\n                }\n});\n\n\n\n                         fetchAndPopulateReviewHistory(frm);\n                         \n                         \n                         \n\n\n\n\n},\n\nph_name: function(frm) {\n//  calculate_exposure(frm);\n        //  if (frm.doc.ph_name) {\n\n        //     frappe.call({\n\n        //         method: 'frappe.client.get_list',\n\n        //         args: {\n\n        //             doctype: 'Credit Limit Processing', // replace 'Policy Doctype' with the actual doctype name where policies are stored\n\n        //             filters: {\n\n        //                 'policy_holder_name': frm.doc.ph_name\n\n        //             },\n\n        //         fields:['policy_number']  \n                \n\n        //         },\n\n        //         callback: function(response) {\n        //             console.log(\"Response:\", response); // Check response from server\n\n        //             if (response.message && response.message.length > 0) {\n        //                 var policyNumbers = response.message.map(item => item.policy_number);\n        //                 console.log(\"Policy Numbers:\", policyNumbers); // Check policy numbers fetched\n\n        //                 // Update dropdown field options\n        //                 frm.set_df_property('policy_number', 'options', policyNumbers.join('\\n'));\n        //                 frm.refresh_field('policy_number'); // Refresh dropdown field\n        //             } else {\n        //                 // Clear dropdown field options if no data found\n        //                 frm.set_df_property('policy_number', 'options', '');\n        //                 frm.refresh_field('policy_number'); // Refresh dropdown field\n        //             }\n        //         },\n\n        //     });\n\n        // }\n        \n        if (frm.doc.ph_name) {\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Credit Limit Processing',\n            filters: {\n                policy_holder_name: frm.doc.ph_name\n            },\n            fields: ['policy_number'],\n            limit_page_length: 0\n        },\n        callback: function(response) {\n            console.log(\"Response:\", response); // Debug: full response\n\n            if (response.message && response.message.length > 0) {\n                // Extract and deduplicate policy numbers\n                let policyNumbers = [...new Set(response.message.map(item => item.policy_number))];\n                console.log(\"Unique Policy Numbers:\", policyNumbers); // Debug: unique list\n\n                // Set dropdown options\n                frm.set_df_property('policy_number', 'options', policyNumbers.join('\\n'));\n                frm.refresh_field('policy_number');\n            } else {\n                // Clear dropdown if nothing found\n                frm.set_df_property('policy_number', 'options', '');\n                frm.refresh_field('policy_number');\n            }\n        }\n    });\n}\n\n},\n \n\n\n\n// ph_name: function(frm) {\n//         var phName = frm.doc.ph_name;\n\n//         // Fetch data from Credit Limit Processing based on policy_holder_name\n//         frappe.call({\n//             method: 'frappe.client.get_list',\n//             args: {\n//                 doctype: 'Credit Limit Processing',\n//                 filters: {\n//                     policy_holder_name: phName\n//                 },\n//                 fields: ['days_from','policy_number','credit_limit_no', 'use_of_the_credit_limit', 'capture_date', 'policy_holder_name', 'trading__style', 'credit_limit', 'business_organisation', 'type_of_business', 'customers', 'location', 'present_mgt_in_control_since', 'management_experience', 'bank_risk_category', 'itc_clearence', 'main_productservice', 'total_expouse', 'level_of_competition', 'management_consists_of', 'credit_bureau_opinion', 'financials', 'trading_experience', 'overdue_amount', 'balance_sheet_analysis', 'annual_sales_for_the_last_23_years', 'terms_of_payments', 'outstanding_amount', 'repayment_ability', 'comments', 'policy_type']\n//             },\n//             callback: function(response) {\n//                 console.log(\"Credit Limit Processing response:\", response);\n\n//                 if (response.message && response.message.length > 0) {\n//                     var data = response.message[0];\n\n//                     // Populate fields if data is found\n//                     frm.set_value('policy_number', data.policy_number || '');\n//                     frm.set_value('credit_limit_no', data.credit_limit_no || '');\n//                     frm.set_value('use_of_the_credit_limit', data.use_of_the_credit_limit || '');\n//                     frm.set_value('inception_date', data.capture_date || '');\n//                     frm.set_value('ph_name', data.policy_holder_name || '');\n//                     frm.set_value('trading_style', data.trading__style || '');\n//                     frm.set_value('current_limit', data.credit_limit || '');\n//                     frm.set_value('business_organisation', data.business_organisation || '');\n//                     frm.set_value('type__of_business', data.type_of_business || '');\n//                     frm.set_value('customers', data.customers || '');\n//                     frm.set_value('location', data.location || '');\n//                     frm.set_value('present_mgt_in_control_since', data.present_mgt_in_control_since || '');\n//                     frm.set_value('management_experience', data.management_experience || '');\n//                     frm.set_value('bank_risk_category', data.bank_risk_category || '');\n//                     frm.set_value('itc_clearence', data.itc_clearence || '');\n//                     frm.set_value('main_product_service', data.main_productservice || '');\n//                     frm.set_value('total_exposure', data.total_exposure || '');\n//                     frm.set_value('level_of_competition', data.level_of_competition || '');\n//                     frm.set_value('management_consists_of', data.management_consists_of || '');\n//                     frm.set_value('credit_bureau_opinion', data.credit_bureau_opinion || '');\n//                     frm.set_value('financials', data.financials || '');\n//                     frm.set_value('trading_experience', data.trading_experience || '');\n//                     frm.set_value('overdue_amount', data.overdue_amount || '');\n//                     frm.set_value('balance_sheet_analysis', data.balance_sheet_analysis || '');\n//                     frm.set_value('annual_sales_for_the_last_23years', data.annual_sales_for_the_last_23_years || '');\n//                     frm.set_value('terms_of_payments', data.terms_of_payments || '');\n//                     frm.set_value('outstanding_amount', data.outstanding_amount || '');\n//                     frm.set_value('repayment_ability', data.repayment_ability || '');\n//                     frm.set_value('comments1', data.comments || '');\n//                     frm.set_value('policy_type', data.policy_type || '');\n//                     frm.set_value('days_from', data.days_from || '');\n//                 } else {\n//                     // Clear fields if no matching record found\n//                     frm.set_value('policy_number', '');\n//                     frm.set_value('days_from', '');\n//                     frm.set_value('credit_limit_no', '');\n//                     frm.set_value('use_of_the_credit_limit', '');\n//                     frm.set_value('inception_date', '');\n//                     frm.set_value('ph_name', '');\n//                     frm.set_value('trading__style', '');\n//                     frm.set_value('current_limit', '');\n//                     frm.set_value('business_organisation', '');\n//                     frm.set_value('type_of_business', '');\n//                     frm.set_value('customers', '');\n//                     frm.set_value('location', '');\n//                     frm.set_value('present_mgt_in_control_since', '');\n//                     frm.set_value('management_experience', '');\n//                     frm.set_value('bank_risk_category', '');\n//                     frm.set_value('itc_clearence', '');\n//                     frm.set_value('main_productservice', '');\n//                     frm.set_value('total_exposure', '');\n//                     frm.set_value('level_of_competition', '');\n//                     frm.set_value('management_consists_of', '');\n//                     frm.set_value('credit_burea_report', '');\n//                     frm.set_value('financials', '');\n//                     frm.set_value('trading_experience', '');\n//                     frm.set_value('overdue_amount', '');\n//                     frm.set_value('balance_sheet_analysis', '');\n//                     frm.set_value('annual_sales_for_the_last_23years', '');\n//                     frm.set_value('terms_of_payments', '');\n//                     frm.set_value('outstanding_amount', '');\n//                     frm.set_value('repayment_ability', '');\n//                     frm.set_value('comments1', '');\n//                     frm.set_value('policy_type', '');\n//                     frappe.msgprint('No matching record found in Credit Limit Processing.');\n//                 }\n\n//                 // Fetch and populate review_history child table\n//                 fetchReviewHistory(frm, phName);\n//             },\n            \n//         });\n        \n        \n       \n\n\n//     },\n    \n    \n    \n    \n    \n// policy_number: function(frm) {\n    //     var PolicyNumber = frm.doc.policy_number;\n\n\n    //     // Fetch data from Credit Limit Processing based on policy_holder_name\n    //     frappe.call({\n    //         method: 'frappe.client.get_list',\n    //         args: {\n    //             doctype: 'Credit Limit Processing',\n    //             filters: {\n    //                 policy_number: PolicyNumber\n    //             },\n    //             fields: ['days_from','credit_limit_no', 'use_of_the_credit_limit', 'capture_date', 'trading__style', 'credit_limit', 'business_organisation', 'type_of_business', 'customers', 'location', 'present_mgt_in_control_since', 'management_experience', 'bank_risk_category', 'itc_clearence', 'main_productservice', 'total_exposure', 'level_of_competition', 'management_consists_of', 'credit_bureau_opinion', 'financials', 'trading_experience', 'overdue_amount', 'balance_sheet_analysis', 'annual_sales_for_the_last_23_years', 'terms_of_payments', 'outstanding_amount', 'repayment_ability', 'comments', 'policy_type']\n    //         },\n    //         callback: function(response) {\n    //             console.log(\"Credit Limit Processing response:\", response);\n\n    //             if (response.message && response.message.length > 0) {\n    //                 var data = response.message[0];\n\n    //                 // Populate fields if data is found\n    //                 // frm.set_value('policy_number', data.policy_number || '');\n    //                 frm.set_value('credit_limit_no', data.credit_limit_no || '');\n    //                 frm.set_value('use_of_the_credit_limit', data.use_of_the_credit_limit || '');\n    //                 frm.set_value('inception_date', data.capture_date || '');\n    //                 // frm.set_value('ph_name', data.policy_holder_name || '');\n    //                 frm.set_value('trading_style', data.trading__style || '');\n    //                 frm.set_value('current_limit', data.credit_limit || '');\n    //                 frm.set_value('business_organisation', data.business_organisation || '');\n    //                 frm.set_value('type__of_business', data.type_of_business || '');\n    //                 frm.set_value('customers', data.customers || '');\n    //                 frm.set_value('location', data.location || '');\n    //                 frm.set_value('present_mgt_in_control_since', data.present_mgt_in_control_since || '');\n    //                 frm.set_value('management_experience', data.management_experience || '');\n    //                 frm.set_value('bank_risk_category', data.bank_risk_category || '');\n    //                 frm.set_value('itc_clearence', data.itc_clearence || '');\n    //                 frm.set_value('main_product_service', data.main_productservice || '');\n    //                 frm.set_value('total_exposure', data.total_exposure || '');\n    //                 frm.set_value('level_of_competition', data.level_of_competition || '');\n    //                 frm.set_value('management_consists_of', data.management_consists_of || '');\n    //                 frm.set_value('credit_bureau_opinion', data.credit_bureau_opinion || '');\n    //                 frm.set_value('financials', data.financials || '');\n    //                 frm.set_value('trading_experience', data.trading_experience || '');\n    //                 frm.set_value('overdue_amount', data.overdue_amount || '');\n    //                 frm.set_value('balance_sheet_analysis', data.balance_sheet_analysis || '');\n    //                 frm.set_value('annual_sales_for_the_last_23years', data.annual_sales_for_the_last_23_years || '');\n    //                 frm.set_value('terms_of_payments', data.terms_of_payments || '');\n    //                 frm.set_value('outstanding_amount', data.outstanding_amount || '');\n    //                 frm.set_value('repayment_ability', data.repayment_ability || '');\n    //                 frm.set_value('comments1', data.comments || '');\n    //                 frm.set_value('policy_type', data.policy_type || '');\n    //                 frm.set_value('days_from', data.days_from || '');\n    //             } else {\n    //                 // Clear fields if no matching record found\n    //                 // frm.set_value('policy_number', '');\n    //                 frm.set_value('days_from', '');\n    //                 frm.set_value('credit_limit_no', '');\n    //                 frm.set_value('use_of_the_credit_limit', '');\n    //                 frm.set_value('inception_date', '');\n    //                 // frm.set_value('ph_name', '');\n    //                 frm.set_value('trading_style', '');\n    //                 frm.set_value('current_limit', '');\n    //                 frm.set_value('business_organisation', '');\n    //                 frm.set_value('type__of_business', '');\n    //                 frm.set_value('customers', '');\n    //                 frm.set_value('location', '');\n    //                 frm.set_value('present_mgt_in_control_since', '');\n    //                 frm.set_value('management_experience', '');\n    //                 frm.set_value('bank_risk_category', '');\n    //                 frm.set_value('itc_clearence', '');\n    //                 frm.set_value('main_product_service', '');\n    //                 frm.set_value('total_exposure', '');\n    //                 frm.set_value('level_of_competition', '');\n    //                 frm.set_value('management_consists_of', '');\n    //                 frm.set_value('credit_burea_report', '');\n    //                 frm.set_value('financials', '');\n    //                 frm.set_value('trading_experience', '');\n    //                 frm.set_value('overdue_amount', '');\n    //                 frm.set_value('balance_sheet_analysis', '');\n    //                 frm.set_value('annual_sales_for_the_last_23years', '');\n    //                 frm.set_value('terms_of_payments', '');\n    //                 frm.set_value('outstanding_amount', '');\n    //                 frm.set_value('repayment_ability', '');\n    //                 frm.set_value('comments1', '');\n    //                 frm.set_value('policy_type', '');\n    //             }\n\n    //             // Fetch and populate review_history child table\n    //             fetchReviewHistory(frm, phName);\n    //         },\n            \n    //     });\n        \n        \n       \n\n\n    // },///main\n\n\n\npolicy_number: function(frm) {\n    var PolicyNumber = frm.doc.policy_number;\n    if (!PolicyNumber) return;\n\n    // -----------------------\n    // 1) Fetch Credit Limit Processing\n    // -----------------------\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Credit Limit Processing',\n            filters: { policy_number: PolicyNumber },\n            fields: [\n                'buyer_id','days_from','credit_limit_no','use_of_the_credit_limit',\n                'capture_date','trading__style','business_organisation','type_of_business',\n                'customers','location','present_mgt_in_control_since','management_experience',\n                'bank_risk_category','itc_clearence','main_productservice','total_expouse',\n                'level_of_competition','management_consists_of','credit_bureau_opinion',\n                'financials','trading_experience','overdue_amount','balance_sheet_analysis',\n                'annual_sales_for_the_last_23_years','terms_of_payments','outstanding_amount',\n                'approved_amount','repayment_ability','comment1','policy_type'\n            ]\n        },\n        callback: function(response) {\n            console.log(\"Credit Limit Processing response:\", response);\n\n            if (!response.message || response.message.length === 0) {\n                console.warn(\"\u26a0 No Credit Limit Processing found for this Policy Number.\");\n                return; // Do not clear fields here\n            }\n\n            var data = response.message[0];\n\n            // -----------------------\n            // 2) Check if already Approved\n            // -----------------------\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Credit Limit Reviews',\n                    filters: {\n                        policy_number: PolicyNumber,\n                        workflow_state: 'Approved'\n                    },\n                    fields: ['policy_number']\n                },\n                callback: function(approvedResponse) {\n                    if (approvedResponse.message && approvedResponse.message.length > 0) {\n                        frappe.msgprint('This policy number is already approved.');\n                        return;\n                    }\n\n                    // -----------------------\n                    // 3) Populate fields (SAFE)\n                    // -----------------------\n                    frm.set_value('credit_limit_no', data.credit_limit_no || '');\n                    frm.set_value('buyer_id', data.buyer_id || '');\n                    frm.set_value('use_of_the_credit_limit', data.use_of_the_credit_limit || '');\n\n                // \ud83d\udd25 IMPORTANT \u2013 ADD THIS or the field will never work\nfrm.__inception_locked = true;\nfrm.set_value(\"inception_date\", data.capture_date);\nfrm.refresh_field(\"inception_date\");\n\n\n                    \n                      if (data.capture_date) {\n                        let expiry = new Date(data.capture_date);\n                        expiry.setFullYear(expiry.getFullYear() + 1);\n                        frm.set_value('policy_expiry_date',\n                            frappe.datetime.str_to_user(expiry)\n                        );\n                    }\n                    \n                    \n\n                    frm.set_value('trading_style', data.trading__style || '');\n                    frm.set_value('current_limit', data.approved_amount || '');\n                    frm.set_value('business_organisation', data.business_organisation || '');\n                    frm.set_value('type__of_business', data.type_of_business || '');\n                    frm.set_value('customers', data.customers || '');\n                    frm.set_value('location', data.location || '');\n                    frm.set_value('present_mgt_in_control_since', data.present_mgt_in_control_since || '');\n                    frm.set_value('management_experience', data.management_experience || '');\n                    frm.set_value('bank_risk_category', data.bank_risk_category || '');\n                    frm.set_value('itc_clearence', data.itc_clearence || '');\n                    frm.set_value('main_product_service', data.main_productservice || '');\n                    frm.set_value('total_exposure', data.total_expouse || '');\n                    frm.set_value('level_of_competition', data.level_of_competition || '');\n                    frm.set_value('management_consists_of', data.management_consists_of || '');\n                    frm.set_value('credit_bureau_opinion', data.credit_bureau_opinion || '');\n                    frm.set_value('financials', data.financials || '');\n                    frm.set_value('trading_experience', data.trading_experience || '');\n                    frm.set_value('overdue_amount', data.overdue_amount || '');\n                    frm.set_value('balance_sheet_analysis', data.balance_sheet_analysis || '');\n                    frm.set_value('annual_sales_for_the_last_23years', data.annual_sales_for_the_last_23_years || '');\n                    frm.set_value('terms_of_payments', data.terms_of_payments || '');\n                    frm.set_value('outstanding_amount', data.outstanding_amount || '');\n                    frm.set_value('repayment_ability', data.repayment_ability || '');\n                    frm.set_value('comments1', data.comment1 || '');\n                    frm.set_value('policy_type', data.policy_type || '');\n                    frm.set_value('days_from', data.days_from || '');\n                },\n                error: function(err) {\n                    console.error(\"Error fetching approved policy numbers:\", err);\n                    frappe.msgprint('An error occurred while checking approved policy numbers. See console.');\n                }\n            }); // end inner call (approved check)\n        },\n        error: function(err) {\n            console.error(\"Error fetching Credit Limit Processing data:\", err);\n            frappe.msgprint('An error occurred while fetching Credit Limit Processing data. See console.');\n        }\n    }); // end outer call (Credit Limit Processing)\n\n    // -----------------------\n    // 4) Fetch Buyer List (separate & safe)\n    // -----------------------\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Credit Limit Processing',\n            filters: {\n                policy_no: frm.doc.policy_number,\n                policy_holder_name: frm.doc.ph_name\n            },\n            fields: ['buyer_name']\n        },\n        callback: function(response) {\n            if (response.message && response.message.length > 0) {\n                var buyerList = [...new Set(response.message.map(x => x.buyer_name))];\n                frm.set_df_property('buyer', 'options', buyerList.join('\\n'));\n                frm.refresh_field('buyer');\n                console.log(\"\u2705 Final Buyer List:\", buyerList);\n            } else {\n                frm.set_df_property('buyer', 'options', '');\n                frm.refresh_field('buyer');\n                console.log(\"\u26a0\ufe0f No buyers found for given filters.\");\n            }\n        },\n        error: function(xhr, textStatus, errorThrown) {\n            console.error(\"\u274c Error fetching buyer list:\", textStatus, errorThrown);\n        }\n    }); // end buyer list call\n\n}, // end policy_number\n\n\n\n\n// inception_date: function(frm){\n    \n    \n//       // \u2757 Prevent overwriting when value is coming from script\n//     if (frm.__setting_inception) {\n//         frm.__setting_inception = false;\n//         return;\n//     }\n        \n//       frappe.call({\n//             method: 'frappe.client.get_list',\n//             args: {\n//                 doctype: 'Policy Approvals',\n//                 filters: {\n//                     policy_holder: frm.doc.ph_name\n//                 },\n//                 fields: ['inception_date']\n//             },\n//             callback: function(response) {\n//                 console.log('capture');\n//                 if (response.message && response.message.length > 0) {\n//                     var policyApproval = response.message[0];\n//                     var inceptionDate = policyApproval.inception_date;\n\n//                     console.log(\"Inception Date:\", inceptionDate);\n\n//                     var expiryDate = new Date(inceptionDate);\n//                     expiryDate.setFullYear(expiryDate.getFullYear() + 1);\n\n//                     frm.set_value('policy_expiry_date', frappe.datetime.str_to_user(expiryDate));\n//                     console.log(\"Policy Expiry Date:\", frm.doc.policy_expiry_date);\n//                 } \n//             }\n//         }); \n//     },\n    \n    \n  \n   });\n\n\n\nfunction generateNumber(frm) {\n    if (!frm.doc.clreview_no) {\n        var currentYear = new Date().getFullYear();\n        var prefix = `CLRV/${currentYear}/`;\n\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Credit Limit Reviews',\n                fields: ['clreview_no', 'creation'],\n                order_by: 'creation desc',\n                limit: 1\n            },\n            callback: function(r) {\n                if (r.message && r.message.length > 0) {\n                    var lastClreviewNo = r.message[0].clreview_no;\n                    var lastNumber = parseInt(lastClreviewNo.split(\"/\").pop());\n                    if (!isNaN(lastNumber)) {\n                        var newNumber = (lastNumber + 1).toString().padStart(4, '0');\n                        frm.set_value('clreview_no', prefix + newNumber);\n                    }\n                } else {\n                    frm.set_value('clreview_no', prefix + '0001');\n                }\n            },\n            error: function(err) {\n                console.error('Error fetching credit limit reviews:', err);\n            }\n        });\n    }\n}\n\nfunction openDirectorShareholderExposure(frm) {\n    frappe.new_doc('Director and Shareholder Exposure');\n    frappe.route_options = {\n        buyer_name: frm.doc.buyer\n    };\n        frappe.ui.form.on('Director and Shareholder Exposure', {\n        onload: function(frm) {\n            // Hide the specific fields and search button\n            frm.toggle_display('director_shareholder', false);\n            frm.toggle_display('search',false);\n            // Replace 'director_shareholder_field' with the actual field name you want to hide\n            frm.page.btn_primary.hide(); // Hides the primary button, typically the save button\n \n           \n            $('.search-btn-class').hide();\n        }\n    });\n\n}\n\nfunction fetchAndPopulateReviewHistory(frm) {\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Credit Limit Reviews',\n            filters: {\n                ph_name: frm.doc.ph_name,\n                buyer: frm.doc.buyer\n            },\n            fields: ['clreview_no', 'date', 'cl_review_date', 'current_limit', 'reasons']\n        },\n        callback: function(response) {\n            if (response.message) {\n                console.log('Fetched records:', response.message); // Log fetched records for debugging\n\n                // Clear existing child table rows\n                frm.clear_table('review_history');\n\n                // Iterate through fetched records and add to child table\n                response.message.forEach(function(row) {\n                    let new_row = frm.add_child('review_history');\n                    new_row.cl_review_no = row.clreview_no;\n                    new_row.review_date = row.date;\n                    new_row.expiry_date = row.cl_review_date;\n                    new_row.credit_limit = row.current_limit;\n                    new_row.reason = row.reasons;\n                });\n\n                // Refresh the child table field\n                frm.refresh_field('review_history');\n            } else {\n                console.log('No records found or error fetching data.'); // Log error message if no records found\n            }\n        },\n        error: function(err) {\n            console.log('Error fetching data:', err.responseText); // Log error response if fetch fails\n        }\n    });\n}\n\n// function calculate_exposure(frm) {\n//     if (!frm.doc.ph_name) {\n//         return;\n//     }\n\n//     frappe.call({\n//         method: 'frappe.client.get_list',\n//         args: {\n//             doctype: 'Credit Limit Processing',\n//             filters: {\n//                 policy_holder_name: frm.doc.ph_name\n//             },\n//             fields: ['approved_amount', 'total_expouse'],\n//             limit_page_length: 1\n//         },\n//         callback: function(r) {\n//             if (r.message && r.message.length > 0) {\n//                 let rec = r.message[0];\n\n//                 // Keep existing decimals\n//                 let approved = Number(rec.approved_amount);\n//                 let exposure = Number(rec.total_expouse);\n\n//                 let diff = exposure - approved;\n\n//                 // Always show 2 decimal places\n//                 let formatted = (isNaN(diff) ? 0 : diff).toFixed(2);\n\n//                 frm.set_value('total_exposure', formatted);\n//             }\n//         }\n//     });\n// }\n\n\n\nfunction alignFields(frm) {\n    const rightAlignedFields = [\n        'total_exposure',\n        'outstanding_amount',\n        'overdue_amount',\n        'no_of_employees',\n        'current_limit',\n        'required_limit',\n        'approved_limit',\n        'recomended_exposure'\n    ];\n    const centerAlignedFields = [\n        'terms_of_payments'\n    ];\n    \n    rightAlignedFields.forEach(field => {\n        frm.fields_dict[field].$input.css(\"text-align\", \"right\");\n    });\n\n    centerAlignedFields.forEach(field => {\n        frm.fields_dict[field].$input.css(\"text-align\", \"center\");\n    });\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Advance Premium",
  "enabled": 0,
  "modified": "2025-11-17 06:08:54.379445",
  "module": null,
  "name": "Advance New Script",
  "script": "frappe.ui.form.on('Advance Premium', {\r\n    onload: function(frm) {\r\n                console.log(\"Script Loaded: onload triggered\");\r\n\r\n        // Auto-generate credit limit number if not already populated\r\n        if (!frm.doc.adv_premium_no) {\r\n          generateNumber(frm);\r\n        }\r\n\r\n    },\r\n});\r\n\r\n// Function to generate credit limit number\r\nfunction generateNumber(frm) {\r\n    if (!frm.doc.adv_premium_no) {\r\n        let currentYear = new Date().getFullYear();\r\n        let prefix = `ADV/${currentYear}/`;\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Advance Premium',\r\n                fields: ['adv_premium_no'],\r\n                order_by: 'creation desc',\r\n                limit: 1\r\n            },\r\n            callback: function(r) {\r\n                let newNumber = '0001';\r\n                if (r.message && r.message.length > 0) {\r\n                    let adv_premium_no = r.message[0].adv_premium_no;\r\n                    let match = adv_premium_no.match(/CRL\\/\\d{4}\\/(\\d+)/);\r\n                    if (match) {\r\n                        newNumber = (parseInt(match[1]) + 1).toString().padStart(4, '0');\r\n                    }\r\n                }\r\n                frm.set_value('adv_premium_no', prefix + newNumber);\r\n            }\r\n        });\r\n    }\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Company-Details",
  "enabled": 1,
  "modified": "2025-11-27 08:24:53.273690",
  "module": null,
  "name": "Company-shortname",
  "script": "frappe.ui.form.on('Company-Details', {\r\n    name1: async function(frm) {\r\n        if (frm.doc.name1) {\r\n            // Take first 4 letters and convert to uppercase\r\n            let generated_shortname = frm.doc.name1.substring(0, 4).toUpperCase();\r\n\r\n            // Check if this short_name already exists\r\n            let existing = await frappe.db.get_list('Company-Details', {\r\n                fields: ['name'],\r\n                filters: { short_name: generated_shortname },\r\n                limit: 1\r\n            });\r\n\r\n            if (existing.length > 0) {\r\n                // If duplicate, append number until unique\r\n                let counter = 1;\r\n                let unique_shortname = generated_shortname + counter;\r\n\r\n                while (true) {\r\n                    let check = await frappe.db.get_list('Company-Details', {\r\n                        fields: ['name'],\r\n                        filters: { short_name: unique_shortname },\r\n                        limit: 1\r\n                    });\r\n\r\n                    if (check.length === 0) {\r\n                        frm.set_value('short_name', unique_shortname);\r\n                        break;\r\n                    }\r\n\r\n                    counter++;\r\n                    unique_shortname = generated_shortname + counter;\r\n                }\r\n            } else {\r\n                frm.set_value('short_name', generated_shortname);\r\n            }\r\n        }\r\n    },\r\n    refresh: function(frm) {\r\n        // Always show the client field\r\n        frm.set_df_property('name1', 'hidden', 0);\r\n\r\n        // Make it read-only if the document is saved\r\n        if (!frm.is_new()) {\r\n            frm.set_df_property('name1', 'read_only', 1);\r\n        } else {\r\n            frm.set_df_property('name1', 'read_only', 0);\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Debit Note",
  "enabled": 0,
  "modified": "2025-10-30 12:37:03.814940",
  "module": null,
  "name": "dummy",
  "script": "   \r\nfrappe.ui.form.on('Debit Note', {\r\n     invoice_no: function(frm) {\r\n        generateNumber(frm);\r\n    },\r\n    \r\n    refresh(frm) {\r\n        frm.fields_dict.vat.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.total_amountincl_vat.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.dd_amount.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.premium_rate.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.cl_fee.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.cl_enquiry_fee.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.premiumrate.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.clfee.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.clenquiryfee.$input.css(\"text-align\", \"right\");\r\n         frm.fields_dict.no_of_cls.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.no_of_cl_enq.$input.css(\"text-align\", \"right\");\r\n        \r\n \r\n        \r\n        frm.fields_dict.ddamount.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.noofcls.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.noofclenq.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.premium_rate1.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.cl_fee1.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.cl_enquiry_fee1.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.premium_rate2.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.cl_fee2.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.cl_enquiry_fee2.$input.css(\"text-align\", \"right\");\r\n        \r\n        if (!frm.doc.dedbit_note_no) {\r\n            generateNumber(frm);\r\n        }\r\n        \r\n          var workflowState = frm.doc.workflow_state;\r\n        if (workflowState === \"Approved\") {\r\n            frm.toggle_display('ph_name', true);\r\n            frm.toggle_display('policy_holder', false);\r\n        }\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: \"Export Declarations\",\r\n                filters: {},\r\n                fields: ['policy_holder']\r\n            },\r\n            callback: function(submittedProposalsResponse) {\r\n                if (submittedProposalsResponse.message) {\r\n                    var submittedProposals = submittedProposalsResponse.message.map(function(proposal) {\r\n                        return proposal.policy_holder;\r\n                    });\r\n                    console.log(\"** Submitted Proposals:\", submittedProposals);\r\n                    console.log(\"** Fetching Approved Quotations **\");\r\n\r\n                    frappe.call({\r\n                        method: 'frappe.client.get_list',\r\n                        args: {\r\n                            doctype: 'Debit Note',\r\n                            filters: {\r\n                                workflow_state: 'Approved'\r\n                            },\r\n                            fields: ['policy_holder']\r\n                        },\r\n                        callback: function(approvedQuotationsResponse) {\r\n                            console.log(approvedQuotationsResponse, \"approvedQuotationsResponse\");\r\n                            if (approvedQuotationsResponse.message) {\r\n                                var approvedQuotations = approvedQuotationsResponse.message.map(function(quotation) {\r\n                                    return quotation.policy_holder;\r\n                                });\r\n                                console.log(\"** Approved Quotations:\", approvedQuotations);\r\n\r\n                                var filteredClientNames = submittedProposals.filter(function(proposal) {\r\n                                    return !approvedQuotations.includes(proposal);\r\n                                });\r\n                                console.log(\"** Filtered Client Names:\", filteredClientNames);\r\n\r\n                                frm.set_df_property('policy_holder', 'options', filteredClientNames);\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        });\r\n\r\n        frm.add_custom_button(__('Tax Invoice'), function() {\r\n            frappe.call({\r\n                method: 'frappe.client.get_value',\r\n                args: {\r\n                    doctype: 'Company-Details',\r\n                    fieldname: ['telephone', 'fax', 'postal_address', 'location', 'contact_person', 'vat_reg_no', 'country'],\r\n                    filters: {\r\n                        name: frm.doc.policy_holder\r\n                    }\r\n                },\r\n                callback: function(r) {\r\n                    if (r.message) {\r\n                        const { telephone, fax, postal_address, location, contact_person, vat_reg_no, country } = r.message;\r\n                        frappe.route_options = {\r\n                            invoice_to: frm.doc.policy_holder,\r\n                            date: frm.doc.invoice_date,\r\n                            invoice_no: frm.doc.invoice_no,\r\n                            reference: frm.doc.debit_note_no,\r\n                            crn: frm.doc.invoice_no,\r\n                            amount6: frm.doc.dd_amount,\r\n                            amount7: frm.doc.premium_rate,\r\n                            amount8: frm.doc.premiumrate,\r\n                            amount9: frm.doc.no_of_cls,\r\n                            amount10: frm.doc.cl_fee,\r\n                            amount11: frm.doc.clfee,\r\n                            amount17: frm.doc.no_of_cl_enq,\r\n                            amount12: frm.doc.cl_enquiry_fee,\r\n                            amount13: frm.doc.clenquiryfee,\r\n                            amount15: frm.doc.vat,\r\n                            telephone: telephone,\r\n                            fax: fax,\r\n                            address: postal_address,\r\n                            city: location,\r\n                            attn: contact_person,\r\n                            vat: vat_reg_no,\r\n                            country: country,\r\n                        };\r\n\r\n                        frappe.call({\r\n                            method: 'frappe.client.get_value',\r\n                            args: {\r\n                                doctype: 'Policy Approvals',\r\n                                fieldname: ['policy_number'],\r\n                                filters: {\r\n                                    policy_holder: frm.doc.policy_holder\r\n                                }\r\n                            },\r\n                            callback: function(r) {\r\n                                if (r.message && r.message.policy_number) {\r\n                                    frappe.route_options.reference = r.message.policy_number;\r\n                                    frappe.new_doc('Debt Note Tax Invoice', frm, frappe.route_options);\r\n                                } else {\r\n                                    frappe.msgprint(__('Policy Number not found for the selected Policy Holder.'));\r\n                                }\r\n                            }\r\n                        });\r\n                    } else {\r\n                        frappe.msgprint(__('Company details not found for the selected Policy Holder.'));\r\n                    }\r\n                }\r\n            });\r\n        }).addClass('btn-primary');\r\n\r\n        frm.add_custom_button(__('Internal Invoice'), function() {\r\n            frappe.call({\r\n                method: 'frappe.client.get_value',\r\n                args: {\r\n                    doctype: 'Company-Details',\r\n                    fieldname: ['postal_address', 'location', 'vat_reg_no'],\r\n                    filters: {\r\n                        name: frm.doc.policy_holder\r\n                    }\r\n                },\r\n                callback: function(r) {\r\n                    if (r.message) {\r\n                        const postal_address = r.message.postal_address;\r\n                        const location = r.message.location;\r\n                        const vat_reg_no = r.message.vat_reg_no;\r\n                        frappe.route_options = {\r\n                            name1: frm.doc.policy_holder,\r\n                            date: frm.doc.invoice_date,\r\n                            address: postal_address,\r\n                            city: location,\r\n                            vat_registration_no: vat_reg_no,\r\n                        };\r\n                        frappe.new_doc('Debit Note Internal Invoice', frm, frappe.route_options);\r\n                    } else {\r\n                        frappe.msgprint(__('Telephone, Fax, and Postal Address not found for the selected Policy Holder.'));\r\n                    }\r\n                }\r\n            });\r\n        }).addClass('btn-primary');\r\n    },\r\n    \r\n    \r\n     \r\n    \r\n\r\n    policy_holder: function(frm) {\r\n        var clientName = frm.doc.policy_holder;\r\n        \r\n         frm.set_value('ph_name', clientName);\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'CI Invoices',\r\n                filters: { policy_holder: clientName },\r\n                fields: ['invoice_no', 'invoice_date']\r\n            },\r\n            callback: function(response) {\r\n                console.log(\"DCI Proposals response:\", response);\r\n                if (response.message && response.message.length > 0) {\r\n                    var data_from_proposals = response.message[0];\r\n                    frm.set_value('invoice_no', data_from_proposals.invoice_no || '');\r\n                    frm.set_value('invoice_date', data_from_proposals.invoice_date || '');\r\n                    frm.set_value('invoice_no', invoice.invoice_no || '');\r\ngenerateNumber(frm);\r\n\r\n                } else {\r\n                    frm.set_value('invoice_no', '');\r\n                    frm.set_value('invoice_date', '');\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error(err);\r\n                frappe.msgprint('An error occurred while fetching data from DCI Proposals. Please check the console for details.');\r\n            }\r\n        });\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Export Declaration Invoice',\r\n                filters: { policy_holder: clientName },\r\n                fields: ['credit_limit_fee', 'credit_limits', 'credit_limit_enquiry_fee', 'credit_limits1', 'total']\r\n            },\r\n            callback: function(response) {\r\n                console.log(\"DCI Proposals response:\", response);\r\n                if (response.message && response.message.length > 0) {\r\n                    var data_from_proposals = response.message[0];\r\n                    frm.set_value('cl_fee', data_from_proposals.credit_limit_fee || '');\r\n                    frm.set_value('cl_enquiry_fee', data_from_proposals.credit_limit_enquiry_fee || '');\r\n                    frm.set_value('no_of_cls', data_from_proposals.credit_limits || '');\r\n                    frm.set_value('no_of_cl_enq', data_from_proposals.credit_limits1 || '');\r\n                    frm.set_value('cl_fee1', data_from_proposals.credit_limit_fee || '');\r\n                    frm.set_value('cl_enquiry_fee1', data_from_proposals.credit_limit_enquiry_fee || '');\r\n                    frm.set_value('noofcls', data_from_proposals.credit_limits || '');\r\n                    frm.set_value('noofclenq', data_from_proposals.credit_limits1 || '');\r\n                } else {\r\n                    frm.set_value('premium_rate', '');\r\n                    frm.set_value('cl_fee', '');\r\n                    frm.set_value('cl_enquiry_fee', '');\r\n                    frm.set_value('no_of_cls', '');\r\n                    frm.set_value('no_of_cl_enq', '');\r\n                    frm.set_value('cl_fee1', '');\r\n                    frm.set_value('cl_enquiry_fee1', '');\r\n                    frm.set_value('noofcls', '');\r\n                    frm.set_value('noofclenq', '');\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error(err);\r\n                frappe.msgprint('An error occurred while fetching data from DCI Proposals. Please check the console for details.');\r\n            }\r\n        });\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get',\r\n            args: {\r\n                doctype: 'Export Declarations',\r\n                filters: { policy_holder: clientName },\r\n                fields: ['premium_rate']\r\n            },\r\n            callback: function(r) {\r\n                if (r.message) {\r\n                    frm.set_value('premium_rate', r.message.premium_rate);\r\n                    frm.set_value('premium_rate1', r.message.premium_rate);\r\n                }\r\n            }\r\n        });\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get',\r\n            args: {\r\n                doctype: 'VAT',\r\n                filters: {}\r\n            },\r\n            callback: function(r) {\r\n                if (r.message) {\r\n                    frm.set_value('vat', r.message.vat);\r\n                }\r\n            }\r\n        });\r\n    },\r\n\r\n    ////---------Invoice Details tab\r\n    dd_amount: function(frm) {\r\n        calculateDD_Amount(frm);\r\n    },\r\n    premium_rate: function(frm) {\r\n        calculateDD_Amount(frm);\r\n    },\r\n    no_of_cls: function(frm) {\r\n        calculateno_of_cls(frm);\r\n    },\r\n    cl_fee: function(frm) {\r\n        calculateno_of_cls(frm);\r\n    },\r\n    no_of_cl_enq: function(frm) {\r\n        calculateno_of_cl_enq(frm);\r\n    },\r\n    cl_enquiry_fee: function(frm) {\r\n        calculateno_of_cl_enq(frm);\r\n    },\r\n\r\n    ////---------Debit note details\r\n    ddamount: function(frm) {\r\n        calculateDDAmount1(frm);\r\n    },\r\n    premium_rate1: function(frm) {\r\n        calculateDDAmount1(frm);\r\n    },\r\n    noofcls: function(frm) {\r\n        calculateno_ofcls(frm);\r\n    },\r\n    cl_fee1: function(frm) {\r\n        calculateno_ofcls(frm);\r\n    },\r\n    noofclenq: function(frm) {\r\n        calculateno_ofclenq(frm);\r\n    },\r\n    cl_enquiry_fee1: function(frm) {\r\n        calculateno_ofclenq(frm);\r\n    },\r\n    \r\n\r\n   \r\n    \r\n});\r\n\r\n\r\n// function generateNumber(frm) {\r\n//     if (!frm.doc.dedbit_note_no) {\r\n//         let currentYear = new Date().getFullYear();\r\n//         let prefix = `INV/${currentYear}/DDR`;\r\n\r\n//         frappe.call({\r\n//             method: 'frappe.client.get_list',\r\n//             args: {\r\n//                 doctype: 'Debit Note',\r\n//                 fields: ['dedbit_note_no'],\r\n//                 order_by: 'dedbit_note_no desc',\r\n//                 limit: 1\r\n//             },\r\n//             callback: function(r) {\r\n//                 if (r.message && r.message.length > 0) {\r\n//                     let lastProposalNo = r.message[0].dedbit_note_no;\r\n//                     let lastNumber = parseInt(lastProposalNo.split(\"DDR\").pop());\r\n//                     if (!isNaN(lastNumber)) {\r\n//                         let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n//                         frm.set_value('dedbit_note_no', prefix + newNumber);\r\n//                     }\r\n//                 } else {\r\n//                     frm.set_value('dedbit_note_no', prefix + '0001');\r\n//                 }\r\n//             }\r\n//         });\r\n\r\n// }\r\n// ////---------Invoice Details tab\r\n// function calculateDD_Amount(frm) {\r\n//     var dd_amount = frm.doc.dd_amount;\r\n//     var premium_rate = frm.doc.premium_rate;\r\n\r\n//     dd_amount = parseFloat(dd_amount.replace(/[^\\d.]/g, ''));\r\n//     var premiumrate = (dd_amount * premium_rate) / 100;\r\n\r\n//     var formattedPremiumRate = formatNumberWithoutCurrencySymbol(premiumrate);\r\n//     var formattedDDAmount = formatNumberWithoutCurrencySymbol(dd_amount);\r\n\r\n//     frm.set_value('premiumrate', formattedPremiumRate);\r\n//     frm.set_value('dd_amount', formattedDDAmount);\r\n//     frm.set_value('premiumrate', premiumrate);\r\n// }\r\n\r\n// function formatNumberWithoutCurrencySymbol(number) {\r\n//     return number.toLocaleString('en-US');\r\n// }\r\n\r\n// function calculateno_of_cls(frm) {\r\n//     var no_of_cls = frm.doc.no_of_cls;\r\n//     var cl_fee = frm.doc.cl_fee;\r\n//     var clfee = cl_fee * no_of_cls;\r\n//     frm.set_value('clfee', clfee);\r\n// }\r\n\r\n// function calculateno_of_cl_enq(frm) {\r\n//     var no_of_cl_enq = frm.doc.no_of_cl_enq;\r\n//     var cl_enquiry_fee = frm.doc.cl_enquiry_fee;\r\n//     var clenquiryfee = no_of_cl_enq * cl_enquiry_fee;\r\n//     frm.set_value('clenquiryfee', clenquiryfee);\r\n// }\r\n// }\r\n \r\n//  function generateNumber(frm) {\r\n//     if (!frm.doc.invoice_no || frm.doc.dedbit_note_no) return;\r\n\r\n//     const invoiceNo = frm.doc.invoice_no.trim();\r\n//     const parts = invoiceNo.split('/');\r\n//     if (parts.length !== 3) {\r\n//         frappe.msgprint('Invalid invoice number format. Expected: INV/YYYY/D001 or E001');\r\n//         return;\r\n//     }\r\n\r\n//     const invPrefix = parts[0]; // INV\r\n//     const invYear = parts[1];   // 2025\r\n//     const invSeries = parts[2]; // D001 or E001\r\n\r\n//     let seriesCode = '';\r\n//     if (invSeries.startsWith('D')) {\r\n//         seriesCode = 'DCR';\r\n//     } else if (invSeries.startsWith('E')) {\r\n//         seriesCode = 'ECR';\r\n//     } else {\r\n//         frappe.msgprint('Invoice number must start with D or E.');\r\n//         return;\r\n//     }\r\n\r\n//     const prefix = `${invPrefix}/${invYear}/${seriesCode}`;\r\n\r\n//     frappe.call({\r\n//         method: 'frappe.client.get_list',\r\n//         args: {\r\n//             doctype: 'Debit Note',\r\n//             filters: {\r\n//                 dedbit_note_no: ['like', `${prefix}%`]\r\n//             },\r\n//             fields: ['dedbit_note_no'],\r\n//             order_by: 'dedbit_note_no desc',\r\n//             limit: 1\r\n//         },\r\n//         callback: function(r) {\r\n//             let newNumber = '001';\r\n\r\n//             if (r.message && r.message.length > 0) {\r\n//                 const lastNo = r.message[0].dedbit_note_no;\r\n//                 const match = lastNo.match(/(\\d{3})$/);\r\n//                 if (match && !isNaN(match[1])) {\r\n//                     newNumber = (parseInt(match[1]) + 1).toString().padStart(3, '0');\r\n//                 }\r\n//             }\r\n\r\n//             const finalNumber = `${prefix}${newNumber}`;\r\n//             frm.set_value('dedbit_note_no', finalNumber);\r\n//             frm.refresh_field('dedbit_note_no');\r\n//         }\r\n//     });\r\n// }\r\nfunction generateNumber(frm) {\r\n    if (!frm.doc.invoice_no) {\r\n        frappe.msgprint('Invoice number is missing.');\r\n        return;\r\n    }\r\n\r\n    const invoiceNo = frm.doc.invoice_no.trim();\r\n    const parts = invoiceNo.split('/');\r\n    if (parts.length !== 3) {\r\n        frappe.msgprint('Invalid invoice number format. Expected: INV/YYYY/D001 or E001');\r\n        return;\r\n    }\r\n\r\n    const invPrefix = parts[0]; // INV\r\n    const invYear = parts[1];   // 2025\r\n    const invSeries = parts[2]; // D001 or E001\r\n\r\n    let seriesCode = '';\r\n    if (invSeries.startsWith('D')) {\r\n        seriesCode = 'DCR';\r\n    } else if (invSeries.startsWith('E')) {\r\n        seriesCode = 'ECR';\r\n    } else {\r\n        frappe.msgprint('Invoice series must start with D or E.');\r\n        return;\r\n    }\r\n\r\n    const prefix = `${invPrefix}/${invYear}/${seriesCode}`;\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Debit Note',\r\n            filters: {\r\n                dedbit_note_no: ['like', `${prefix}%`]\r\n            },\r\n            fields: ['dedbit_note_no'],\r\n            order_by: 'dedbit_note_no desc',\r\n            limit: 1\r\n        },\r\n        callback: function(r) {\r\n            let newNumber = '001';\r\n\r\n            if (r.message && r.message.length > 0) {\r\n                const lastNo = r.message[0].dedbit_note_no;\r\n                const match = lastNo.match(/(\\d{3})$/);\r\n                if (match && !isNaN(match[1])) {\r\n                    newNumber = (parseInt(match[1]) + 1).toString().padStart(3, '0');\r\n                }\r\n            }\r\n\r\n            const finalNumber = `${prefix}${newNumber}`;\r\n            frm.set_value('dedbit_note_no', finalNumber);\r\n            frm.refresh_field('dedbit_note_no');\r\n            console.log(\"\u2705 Generated Debit Note No:\", finalNumber);\r\n        }\r\n    });\r\n}\r\n\r\n\r\n\r\n////---------Debit note details\r\nfunction calculateDDAmount1(frm) {\r\n    var ddamount = frm.doc.ddamount;\r\n    var premium_rate1 = frm.doc.premium_rate1;\r\n\r\n    ddamount = parseFloat(ddamount.replace(/[^\\d.]/g, ''));\r\n    var premium_rate2 = (premium_rate1 * ddamount) / 100;\r\n\r\n    var formattedpremium_rate2 = formatNumberWithoutCurrencySymbol(premium_rate2);\r\n    var formattedddamount = formatNumberWithoutCurrencySymbol(ddamount);\r\n\r\n    frm.set_value('premium_rate2', formattedpremium_rate2);\r\n    frm.set_value('ddamount', formattedddamount);\r\n    frm.set_value('premium_rate2', premium_rate2);\r\n}\r\n\r\nfunction calculateno_ofcls(frm) {\r\n    var noofcls = frm.doc.noofcls;\r\n    var cl_fee1 = frm.doc.cl_fee1;\r\n    var cl_fee2 = cl_fee1 * noofcls;\r\n    frm.set_value('cl_fee2', cl_fee2);\r\n}\r\n\r\nfunction calculateno_ofclenq(frm) {\r\n    var noofclenq = frm.doc.noofclenq;\r\n    var cl_enquiry_fee1 = frm.doc.cl_enquiry_fee1;\r\n    var cl_enquiry_fee2 = noofclenq * cl_enquiry_fee1;\r\n    frm.set_value('cl_enquiry_fee2', cl_enquiry_fee2);\r\n}\r\n\r\n\r\n ",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Rejection Letter",
  "enabled": 0,
  "modified": "2025-10-30 12:15:13.020955",
  "module": null,
  "name": "rejectionForm",
  "script": "frappe.ui.form.on('Rejection Letter1', {\n\t\n    \n  onload: function(frm) {\n        // If the client is passed from route options (from DCI Proposals)\n        if (frappe.route_options && frappe.route_options.client) {\n            frm.set_value('client', frappe.route_options.client);\n\n            // Fetch details from DCI Proposals\n            frappe.call({\n                method: 'frappe.client.get_all',\n                args: {\n                    doctype: 'DCI Proposals',\n                    filters: {\n                        client_name: frappe.route_options.client\n                    },\n                    fields: ['proposal_no', 'registrationno', 'establishmentdate']\n                },\n                callback: function(r) {\n                    if (!r.exc && r.message && r.message.length > 0) {\n                        let record = r.message[0];\n                        frm.set_value('proposal_no', record.proposal_no || '');\n                        frm.set_value('registration_no', record.registrationno || '');\n                        frm.set_value('date', record.establishmentdate || '');\n\n                        frappe.msgprint(__('Existing record found for client \"{0}\". Details have been auto-filled.', [frm.doc.client]));\n                    } else {\n                        frappe.msgprint(__('No matching client found in DCI Proposals.'));\n                    }\n                }\n            });\n\n            // clear route options after use\n            frappe.route_options = null;\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "ReInsurers Details",
  "enabled": 1,
  "modified": "2025-10-30 13:17:33.286076",
  "module": null,
  "name": "Reinsurer ShortName",
  "script": "frappe.ui.form.on('ReInsurers Details', {\r\n    reinsurename: async function(frm) {\r\n        if (frm.doc.reinsurename) {\r\n            // Take first 5 letters and convert to uppercase\r\n            let generated_shortname = frm.doc.reinsurename.substring(0, 5).toUpperCase();\r\n\r\n            // Check if this shortname already exists\r\n            let existing = await frappe.db.get_list('ReInsurers Details', {\r\n                fields: ['name'],\r\n                filters: { shortname: generated_shortname },\r\n                limit: 1\r\n            });\r\n\r\n            if (existing.length > 0) {\r\n                // If duplicate, append number until unique\r\n                let counter = 1;\r\n                let unique_shortname = generated_shortname + counter;\r\n\r\n                while (true) {\r\n                    let check = await frappe.db.get_list('ReInsurers Details', {\r\n                        fields: ['name'],\r\n                        filters: { shortname: unique_shortname },\r\n                        limit: 1\r\n                    });\r\n\r\n                    if (check.length === 0) {\r\n                        frm.set_value('shortname', unique_shortname);\r\n                        break;\r\n                    }\r\n\r\n                    counter++;\r\n                    unique_shortname = generated_shortname + counter;\r\n                }\r\n            } else {\r\n                frm.set_value('shortname', generated_shortname);\r\n            }\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Print proposal",
  "enabled": 1,
  "modified": "2025-11-14 09:05:51.649712",
  "module": "Marketing",
  "name": "PrintFormat",
  "script": "frappe.ui.form.on('Print proposal', {\r\n\r\n    refresh: function(frm) {\r\n\r\n        if (!frm.doc.client) {\r\n            console.log(\"Client not selected.\");\r\n            return;\r\n        }\r\n\r\n        //  Get details from Company-Details\r\n        frappe.call({\r\n            method: 'frappe.client.get_value',\r\n            args: {\r\n                doctype: 'Company-Details',\r\n                filters: { name1: frm.doc.client },\r\n                fieldname: ['telephone']\r\n            },\r\n            callback: function(r) {\r\n                console.log(\"Company Details Response:\", r);\r\n\r\n                if (!r.exc && r.message) {\r\n                    frm.set_value('telephone', r.message.telephone || '');\r\n                    frm.refresh_fields(['telephone']);\r\n                } else {\r\n                    console.warn(\"No record found in Company-Details for client:\", frm.doc.client);\r\n                }\r\n            }\r\n        });\r\n\r\n        // Get Buyer Experience data from DCI Proposals\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: {\r\n                doctype: \"DCI Proposals\",\r\n                filters: { client_name: frm.doc.client }\r\n            },\r\n            callback: function(r) {\r\n                console.log(\"DCI Proposals Response:\", r);\r\n\r\n                if (!r.exc && r.message && r.message.buyer_experience_child_table && r.message.buyer_experience_child_table.length > 0) {\r\n                    const data = r.message.buyer_experience_child_table;\r\n\r\n                    // Clear the existing rows before adding new ones\r\n                    frm.clear_table('print_proposal_child');\r\n\r\n                    data.forEach(x => {\r\n                        const child = frappe.model.add_child(frm.doc, \"Print Child\", \"print_proposal_child\");\r\n                        frappe.model.set_value(child.doctype, child.name, \"financial_year_ending\", x.financial_year);\r\n                        frappe.model.set_value(child.doctype, child.name, \"turnover\", x.turnover);\r\n                        frappe.model.set_value(child.doctype, child.name, \"bad_debt_losses_total\", x.relative_bad_debt_loss);\r\n                        frappe.model.set_value(child.doctype, child.name, \"largest_individual_loss\", x.largest_loss);\r\n                        frappe.model.set_value(child.doctype, child.name, \"name_of_largest_individual_loss\", x.largest_lost_client_name);\r\n                    });\r\n\r\n                    frm.refresh_field('print_proposal_child');\r\n               \r\n                } else {\r\n                    console.warn(\"No Buyer Experience data found in DCI Proposals for this client.\");\r\n                }\r\n            }\r\n        });\r\n        \r\n        //Get Debt History Child data from DCI Proposals\r\n        \r\n             frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: {\r\n                doctype: \"DCI Proposals\",\r\n                filters: { client_name: frm.doc.client }\r\n            },\r\n            callback: function(r) {\r\n                console.log(\"DCI Proposals Response:\", r);\r\n\r\n                if (!r.exc && r.message && r.message.debt_history_child_table && r.message.debt_history_child_table.length > 0) {\r\n                    const data = r.message.debt_history_child_table;\r\n\r\n                    // Clear the existing rows before adding new ones\r\n                    frm.clear_table('proposal_child');\r\n\r\n                    data.forEach(x => {\r\n                        const child = frappe.model.add_child(frm.doc, \"Proposal Child\", \"proposal_child\");\r\n                        frappe.model.set_value(child.doctype, child.name, \"month_of\", x.month);\r\n                        frappe.model.set_value(child.doctype, child.name, \"last_financial_year_in_000s_usd\", x.last_year_debt);\r\n                        frappe.model.set_value(child.doctype, child.name, \"this_financial_year_in_000s_usd\", x.this_year_debt);\r\n                  \r\n                    });\r\n\r\n                    frm.refresh_field('proposal_child');\r\n               \r\n                } else {\r\n                    console.warn(\"No Buyer Experience data found in DCI Proposals for this client.\");\r\n                }\r\n            }\r\n        });\r\n        \r\n       //Get Principal Buyer  Child data from DCI Proposals     \r\n        \r\n//              frappe.call({\r\n//                   method: \"frappe.client.get\",\r\n//                       args: {\r\n//                               doctype: \"DCI Proposals\",\r\n//                               filters: { client_name: frm.doc.client }\r\n//                         },\r\n//          callback: function (r) {\r\n//         console.log(\"DCI Proposals Response:\", r);\r\n\r\n//         if (!r.exc && r.message && r.message.principal_buyer_child_table && r.message.principal_buyer_child_table.length > 0) {\r\n//             const data = r.message.principal_buyer_child_table;\r\n//             const proposalNo = r.message.proposal_no || \"\";  // \u2705 Get proposal_no from parent\r\n\r\n//             // Clear existing rows before adding new ones\r\n//             frm.clear_table('proposals_child');\r\n\r\n//             data.forEach(x => {\r\n//                 const child = frappe.model.add_child(frm.doc, \"Proposals Child\", \"proposals_child\");\r\n//                 frappe.model.set_value(child.doctype, child.name, \"name_of_buyers_fax__phone_nos\", x.buyer_name);\r\n//                 frappe.model.set_value(child.doctype, child.name, \"addresses\", x.address);\r\n//                 frappe.model.set_value(child.doctype, child.name, \"number\", x.amount_outstanding);\r\n\r\n//                 // \u2705 Set proposal number into each child row\r\n//                 frappe.model.set_value(child.doctype, child.name, \"buyer_ref_no\", proposalNo);\r\n//             });\r\n\r\n//             frm.refresh_field('proposals_child');\r\n//         } else {\r\n//             console.warn(\"No Principal Buyer data found in DCI Proposals for this client.\");\r\n//         }\r\n//     }\r\n// });\r\nfrappe.call({\r\n    method: \"frappe.client.get\",\r\n    args: {\r\n        doctype: \"DCI Proposals\",\r\n        filters: { client_name: frm.doc.client }\r\n    },\r\n    callback: function (r) {\r\n        console.log(\"DCI Proposals Response:\", r);\r\n\r\n        if (!r.exc && r.message && r.message.principal_buyer_child_table && r.message.principal_buyer_child_table.length > 0) {\r\n\r\n            const data = r.message.principal_buyer_child_table;\r\n            const proposalNo = r.message.proposal_no || \"\";\r\n\r\n            // Clear existing table\r\n            frm.clear_table('proposals_child');\r\n\r\n            // Loop principal buyer table\r\n            data.forEach(row => {\r\n\r\n                // Add new child row\r\n                const child = frappe.model.add_child(frm.doc, \"Proposals Child\", \"proposals_child\");\r\n\r\n                frappe.model.set_value(child.doctype, child.name, \"name_of_buyers_fax__phone_nos\", row.buyer_name);\r\n                frappe.model.set_value(child.doctype, child.name, \"addresses\", row.address);\r\n                frappe.model.set_value(child.doctype, child.name, \"number\", row.amount_outstanding);\r\n\r\n                // Proposal number\r\n                frappe.model.set_value(child.doctype, child.name, \"buyer_ref_no\", proposalNo);\r\n\r\n                // \ud83d\udd25 Fetch bank + branch + ac_no for THIS buyer\r\n                frappe.call({\r\n                    method: \"frappe.client.get_list\",\r\n                    args: {\r\n                        doctype: \"Buyer\",\r\n                        filters: {\r\n                            buyer_name: row.buyer_name      // match exact buyer in child table\r\n                        },\r\n                        fields: [\"bank\", \"branch\", \"ac_no\"]\r\n                    },\r\n                    callback: function (res) {\r\n                        if (!res.exc && res.message && res.message.length > 0) {\r\n\r\n                            let buyer = res.message[0];\r\n\r\n                            let bank   = buyer.bank   || \"\";\r\n                            let branch = buyer.branch || \"\";\r\n                            let ac_no  = buyer.ac_no  || \"\";\r\n\r\n                            // Final display format\r\n                            let combined = `${bank}/${branch}, ${ac_no}`;\r\n\r\n                            frappe.model.set_value(\r\n                                child.doctype,\r\n                                child.name,\r\n                                \"bankersbranch__account_number\",\r\n                                combined\r\n                            );\r\n\r\n                            frm.refresh_field('proposals_child');\r\n                        }\r\n                    }\r\n                });\r\n\r\n            });\r\n\r\n            frm.refresh_field('proposals_child');\r\n        } \r\n        else {\r\n            console.warn(\"No data found in DCI Proposals\");\r\n        }\r\n    }\r\n});\r\n\r\n\r\n\r\n\r\n        // \u2705 3. Make child tables read-only\r\n        frm.set_df_property('proposal_child', 'cannot_add_rows', true);\r\n        frm.set_df_property('proposals_child', 'cannot_add_rows', true);\r\n        frm.set_df_property('print_proposal_child', 'cannot_add_rows', true);\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "DCI Quotation",
  "enabled": 0,
  "modified": "2025-11-11 07:23:41.470965",
  "module": "Marketing",
  "name": "ForCoveringLetters",
  "script": "frappe.ui.form.on('DCI Quotation', {\r\n    refresh: function(frm) {\r\n\r\n        // detach previous handlers to avoid duplicates\r\n        $('p.underlined a').off('click');\r\n\r\n        // Attach click event handler to the underlined words\r\n        $('p.underlined a').on('click', function(event) {\r\n            event.preventDefault();\r\n            var linkText = $(this).text().trim();\r\n\r\n            // Check if workflow state is Approved\r\n            if (frm.doc.workflow_state !== 'Approved') {\r\n                frappe.msgprint('The document must be approved to perform this action.');\r\n                return;\r\n            }\r\n\r\n            switch (linkText) {\r\n                case 'Addendum and Endorsements to the policy':\r\n                    openNewDocument('Addendum and Endorsements to the policy', frm);\r\n                    break;\r\n                case 'Covering Letters':\r\n                    createCoveringLetter(frm);\r\n                    break;\r\n                case 'Schedule (Goods/Services)':\r\n                    openNewDocument('Schedule Goods and Services DCI', frm);\r\n                    break;\r\n                case 'Specimen Policy Documents':\r\n                    openNewDocument('Specimen Policy Documents', frm);\r\n                    break;\r\n                // handle both possible anchor texts just in case\r\n                case 'Consent Form':\r\n                case 'Consent Form-DCIQuotation':\r\n                    createConsentForm(frm);\r\n                    break;\r\n                case 'Acceptance Form':\r\n                    openNewDocument('Acceptance Form DCI Quotation', frm);\r\n                    break;\r\n                case 'Guide to the Administration of the policy':\r\n                    openNewDocument('Guide to the Administration of the Policy', frm);\r\n                    break;\r\n                case 'Policy Quotation':\r\n                    openNewDocument('Policy Quotation DCI', frm);\r\n                    break; \r\n                case 'Compact Policy':\r\n                    openNewDocument('Compact Policy DCI Quotation', frm);\r\n                    break;     \r\n                default:\r\n                    console.log(\"No action defined for\", linkText);\r\n            }\r\n        });\r\n    }\r\n});\r\n\r\n\r\n\r\n// Covering Letter creation (route_options BEFORE new_doc)\r\nfunction createCoveringLetter(frm) {\r\n    const reference_text = `DOMESTIC CREDIT INSURANCE QUOTATION - ${frm.doc.proposal_no2 || ''}`;\r\n\r\n    frappe.route_options = {\r\n        our_ref: frm.doc.proposal_no2,\r\n        date: frm.doc.captured_on,\r\n        re: reference_text,\r\n        client_name: frm.doc.client_name1\r\n    };\r\n\r\n    frappe.new_doc('CoveringLetter');\r\n}\r\n\r\n// Consent Form creation (route_options BEFORE new_doc)\r\nfunction createConsentForm(frm) {\r\n    // set route_options first so the new form receives values\r\n    frappe.route_options = {\r\n        of: frm.doc.client_name,\r\n        company_name: frm.doc.client_name,\r\n    };\r\n\r\n    frappe.new_doc('Consent Form DCI Quotation');\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "CoveringLetter",
  "enabled": 1,
  "modified": "2025-11-11 07:34:23.268056",
  "module": "Marketing",
  "name": "CoverLetterDCI",
  "script": "frappe.ui.form.on('CoveringLetter', {\r\n    onload: function(frm) {\r\n\r\n        if (!frm.doc.our_ref) {\r\n            frappe.msgprint(\"Our Ref is missing. Cannot fetch data.\");\r\n            return;\r\n        }\r\n\r\n        // \u2705 Fetch data from DCI Proposals\r\n        frappe.call({\r\n            method: \"frappe.client.get_value\",\r\n            args: {\r\n                doctype: \"DCI Proposals\",\r\n                filters: { proposal_no: frm.doc.our_ref },\r\n                fieldname: [\"signed_by\"]\r\n            },\r\n            callback: function(r) {\r\n                console.log(\"DCI Proposals Response:\", r);\r\n\r\n                if (!r.exc && r.message) {\r\n                    if (r.message.postal_address) {\r\n                        frm.set_value(\"address\", r.message.postal_address);\r\n                    }\r\n                    if (r.message.signed_by) {\r\n                        frm.set_value(\"attention\", r.message.signed_by);\r\n                    }\r\n                    frm.refresh_fields([\"address\", \"attention\"]);\r\n                } else {\r\n                    frappe.msgprint(\"No matching record found for Proposal No: \" + frm.doc.our_ref);\r\n                }\r\n            }\r\n        });\r\n    },\r\n     refresh: function(frm) {\r\n        // Fetch postal address from Company-Details based on `to` field\r\n        var Name = frm.doc.client_name;\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Company-Details',\r\n                filters: {\r\n                    name1: Name\r\n                },\r\n                fields: ['postal_address'],\r\n                limit_page_length: 1\r\n            },\r\n            callback: function(response) {\r\n                console.log(\"API Response Company-Details:\", response); // Log the response for debugging\r\n\r\n                if (response && response.message && response.message.length > 0) {\r\n                    var companyDetailsData = response.message[0];\r\n                    frm.set_value('address', companyDetailsData.postal_address);\r\n                } else {\r\n                    frappe.msgprint('No matching record found in Company-Details for ' + Name);\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error('Error fetching data from Company-Details:', err);\r\n                frappe.msgprint('An error occurred while fetching data from Company-Details.');\r\n            }\r\n        });\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Consent Form DCI Quotation",
  "enabled": 1,
  "modified": "2025-11-11 09:38:10.416234",
  "module": "Marketing",
  "name": "Consent Form-DCIQuotation",
  "script": "// frappe.ui.form.on('Consent Form-DCIQuotation', {\n// //     onload: function(frm) {\n\n// //         if (!frm.doc.of) {\n// //             return;\n// //         }\n\n// //         //Fetch data from DCI Proposals\n// //         frappe.call({\n// //             method: \"frappe.client.get_value\",\n// //             args: {\n// //                 doctype: \"DCI Proposals\",\n// //                 filters: { client_name: frm.doc.of },\n// //                 fieldname: [\"signed_by\",\"capacity\"]\n// //             },\n// //             callback: function(r) {\n// //                 console.log(\"DCI Proposals Response:\", r);\n\n// //                 if (!r.exc && r.message) {\n// //                     if (r.message.capacity) {\n// //                         frm.set_value(\"designation\", r.message.capacity);\n// //                     }\n// //                     if (r.message.signed_by) {\n// //                         frm.set_value(\"signature\", r.message.signed_by);\n// //                           frm.set_value(\"to\", r.message.signed_by);\n// //                     }\n// //                     frm.refresh_fields([\"signature\",\"to\", \"designation\"]);\n// //                 } \n// //             }\n// //         });\n        \n        \n        \n        \n// //      // Fetch data from Company Details\n// // frappe.call({\n// //     method: \"frappe.client.get_value\",\n// //     args: {\n// //         doctype: \"Company-Details\",\n// //         filters: { name1: frm.doc.of },\n// //         fieldname: [\"bank\", \"ac_no\", \"branch\"]\n// //     },\n// //     callback: function(r) {\n// //         console.log(\"Company Details Response:\", r);\n\n// //         if (!r.exc && r.message) {\n// //             let bank = r.message.bank || \"\";\n// //             let branch = r.message.branch || \"\";\n// //             let ac_no = r.message.ac_no || \"\";\n\n// //             // \u2705 Combine bank and branch with a comma (if both exist)\n// //             let bankBranch = bank && branch ? `${bank}, ${branch}` : bank || branch;\n\n// //             // Set values in fields\n// //             frm.set_value(\"bankbranch\", bankBranch);\n// //             frm.set_value(\"account_number\", ac_no);\n\n// //             frm.refresh_fields([\"bankbranch\", \"account_number\"]);\n// //         }\n// //     }\n// // });\n// // },\n\n// //  refresh: function(frm) {\n// //         // Fetch postal address from Company-Details based on `to` field\n// //         var Name = frm.doc.to;\n\n// //         frappe.call({\n// //             method: 'frappe.client.get_list',\n// //             args: {\n// //                 doctype: 'Company-Details',\n// //                 filters: {\n// //                     name1: Name\n// //                 },\n// //                 fields: ['postal_address'],\n// //                 limit_page_length: 1\n// //             },\n// //             callback: function(response) {\n// //                 console.log(\"API Response Company-Details:\", response); // Log the response for debugging\n\n// //                 if (response && response.message && response.message.length > 0) {\n// //                     var companyDetailsData = response.message[0];\n// //                     frm.set_value('of', companyDetailsData.postal_address);\n// //                 } else {\n// //                     frappe.msgprint('No matching record found in Company-Details for ' + Name);\n// //                 }\n// //             },\n// //             error: function(err) {\n// //                 console.error('Error fetching data from Company-Details:', err);\n// //                 frappe.msgprint('An error occurred while fetching data from Company-Details.');\n// //             }\n// //         });\n// //     }\n\t\n// })\n\nfrappe.ui.form.on('Consent Form DCI Quotation', {\n    onload: function (frm) {\n        // Ensure 'to' (company name) exists before proceeding\n        if (!frm.doc.to) {\n            return;\n        }\n\n        // ----------------------------\n        // Fetch data from DCI Proposals\n        // ----------------------------\n        frappe.call({\n            method: \"frappe.client.get_value\",\n            args: {\n                doctype: \"DCI Proposals\",\n                filters: { client_name: frm.doc.to }, // use company name\n                fieldname: [\"signed_by\", \"capacity\"]\n            },\n            callback: function (r) {\n                console.log(\"DCI Proposals Response:\", r);\n\n                if (!r.exc && r.message) {\n                    const { signed_by, capacity } = r.message;\n\n                    if (capacity) frm.set_value(\"designation\", capacity);\n                    if (signed_by) {\n                        frm.set_value(\"signature\", signed_by);\n                    }\n\n                    frm.refresh_fields([\"signature\", \"designation\"]);\n                }\n            }\n        });\n\n        // ----------------------------\n        // Fetch data from Company Details\n        // ----------------------------\n        frappe.call({\n            method: \"frappe.client.get_value\",\n            args: {\n                doctype: \"Company-Details\",\n                filters: { name1: frm.doc.to }, // company name\n                fieldname: [\"bank\", \"ac_no\", \"branch\", \"postal_address\"]\n            },\n            callback: function (r) {\n                console.log(\"Company Details Response:\", r);\n\n                if (!r.exc && r.message) {\n                    const { bank = \"\", ac_no = \"\", branch = \"\", postal_address = \"\" } = r.message;\n\n                    // Combine bank and branch name\n                    const bankBranch = bank && branch ? `${bank}, ${branch}` : bank || branch;\n\n                    // Set values in fields\n                    frm.set_value(\"bankbranch\", bankBranch);\n                    frm.set_value(\"account_number\", ac_no);\n                    frm.set_value(\"of\", postal_address); // set postal address in 'of'\n\n                    frm.refresh_fields([\"bankbranch\", \"account_number\", \"of\"]);\n                }\n            }\n        });\n    },\n\n    refresh: function (frm) {\n        // Optional: re-fetch address on refresh if 'to' exists\n        if (!frm.doc.to) return;\n\n        frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Company-Details',\n                filters: { name1: frm.doc.to },\n                fieldname: ['postal_address']\n            },\n            callback: function (r) {\n                console.log(\"Company-Details Postal Address Response:\", r);\n\n                if (!r.exc && r.message && r.message.postal_address) {\n                    frm.set_value('of', r.message.postal_address);\n                }\n            },\n            error: function (err) {\n                console.error('Error fetching Company-Details postal address:', err);\n                frappe.msgprint('An error occurred while fetching postal address from Company-Details.');\n            }\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Acceptance Form DCI Quotation",
  "enabled": 1,
  "modified": "2025-11-11 09:18:59.679810",
  "module": "Marketing",
  "name": "AcceptanceForm_DCIQuotation",
  "script": "frappe.ui.form.on('Acceptance Form DCI Quotation', {\n refresh: function(frm) {\n        // Fetch postal address from Company-Details based on `to` field\n        var Name = frm.doc.client_name;\n\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Company-Details',\n                filters: {\n                    name1: Name\n                },\n                fields: ['postal_address'],\n                limit_page_length: 1\n            },\n            callback: function(response) {\n                console.log(\"API Response Company-Details:\", response); // Log the response for debugging\n\n                if (response && response.message && response.message.length > 0) {\n                    var companyDetailsData = response.message[0];\n                    frm.set_value('address', companyDetailsData.postal_address);\n                } else {\n                    frappe.msgprint('No matching record found in Company-Details for ' + Name);\n                }\n            },\n            error: function(err) {\n                console.error('Error fetching data from Company-Details:', err);\n                frappe.msgprint('An error occurred while fetching data from Company-Details.');\n            }\n        });\n    }\n\t\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Financial Analysis",
  "enabled": 0,
  "modified": "2025-12-04 10:53:26.394040",
  "module": null,
  "name": "Example Financial Analysis",
  "script": "frappe.ui.form.on('Financial Analysis', {\r\n    refresh(frm) {\r\n        // --- Populate Buyer Dropdown ---\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Buyer',\r\n                fields: ['buyer_name'],\r\n                limit_page_length: 0\r\n            },\r\n            callback(response) {\r\n                const buyers = response.message || [];\r\n                const options = buyers.map(b => b.buyer_name);\r\n                frm.set_df_property('buyer', 'options', options);\r\n            }\r\n        });\r\n    },\r\n\r\n    calculate(frm) {\r\n        calculateAll(frm);\r\n    }\r\n});\r\n\r\n\r\n// --- Helper Function ---\r\nfunction num(v) {\r\n    return parseFloat(v) || 0;\r\n}\r\n\r\n\r\n// --- Master Calculation Handler ---\r\nfunction calculateAll(frm) {\r\n\r\n    // Step 1: Totals\r\n    frm.set_value(\"tcaly\",  (num(frm.doc.cashlatestyear) + num(frm.doc.arly) + num(frm.doc.mily) + num(frm.doc.pely)).toFixed(2));\r\n    frm.set_value(\"tcaly2\", (num(frm.doc.cashlatestyear1) + num(frm.doc.arly1) + num(frm.doc.mily2) + num(frm.doc.pely2)).toFixed(2));\r\n    frm.set_value(\"tcaly3\", (num(frm.doc.cashlatestyear2) + num(frm.doc.arly3) + num(frm.doc.mily3) + num(frm.doc.pely3)).toFixed(2));\r\n\r\n    frm.set_value(\"taly\",  (num(frm.doc.tcaly) + num(frm.doc.faely)).toFixed(2));\r\n    frm.set_value(\"taly2\", (num(frm.doc.tcaly2) + num(frm.doc.faely2)).toFixed(2));\r\n    frm.set_value(\"taly3\", (num(frm.doc.tcaly3) + num(frm.doc.faely3)).toFixed(2));\r\n\r\n    // --- GM & Nifty Calculations ---\r\n    calculateGM(frm, \"latest_year\", \"cogsly\", \"gmly\");\r\n    calculateGM(frm, \"latest_year_1\", \"cogsly1\", \"gmly1\");\r\n    calculateGM(frm, \"latest_year_3\", \"cogsly2\", \"gmly2\");\r\n\r\n    calculateNifty(frm, \"gmly\",  \"ely\",  \"niftyly\");\r\n    calculateNifty(frm, \"gmly1\", \"ely1\", \"niftyly1\");\r\n    calculateNifty(frm, \"gmly2\", \"ely2\", \"niftyly2\");\r\n\r\n    // --- Current Liabilities Totals ---\r\n    frm.set_value('tclly',  (num(frm.doc.acply) + num(frm.doc.nply) + num(frm.doc.aely)).toFixed(2));\r\n    frm.set_value('tclly2', (num(frm.doc.acply2) + num(frm.doc.nply2) + num(frm.doc.aely2)).toFixed(2));\r\n    frm.set_value('tclly3', (num(frm.doc.acply3) + num(frm.doc.nply3) + num(frm.doc.aely3)).toFixed(2));\r\n\r\n    frm.set_value('tlly',  (num(frm.doc.tclly) + num(frm.doc.ltlly)).toFixed(2));\r\n    frm.set_value('tlly2', (num(frm.doc.tclly2) + num(frm.doc.ltlly2)).toFixed(2));\r\n    frm.set_value('tlly3', (num(frm.doc.tclly3) + num(frm.doc.ltlly3)).toFixed(2));\r\n\r\n    // --- Incremental Totals ---\r\n    calculateIncremental(frm, 1);\r\n    calculateIncremental(frm, 2);\r\n    calculateIncremental(frm, 3);\r\n\r\n    // --- Ratios ---\r\n    calculateRatios(frm);\r\n    calculateAllRatios(frm);\r\n    \r\n         // --- Return on Assets (ROA) ---\r\n    calculateniftylyRatio11(frm);\r\n    calculateniftylyRatio22(frm);\r\n    calculateniftylyRatio33(frm);\r\n   \r\n\r\n    // --- Accounts Receivable Turnover ---\r\n    calculateARLYRatio10(frm);\r\n    calculateARLYRatio20(frm);\r\n    calculateARLYRatio30(frm);\r\n\r\n    // --- Debt to Equity Ratio ---\r\n    calculateCOELYRatio10(frm);\r\n    calculateCOELYRatio20(frm);\r\n    calculateCOELYRatio30(frm);\r\n    \r\n     \r\n    // --- Return on Capital Employed (ROCE) ---\r\n    calculateWCRatio1(frm);\r\n    calculateWCRatio2(frm);\r\n    calculateWCRatio3(frm);\r\n     \r\n     \r\n      // --- Ratio Field Comparisons (NEW) ---\r\n    const ratioFields = [\r\n        [\"cashlatestyear\", \"cashlatestyear1\", \"cashlatestyear3\"],\r\n        [\"cashlatestyear1\", \"cashlatestyear2\", \"cashlatestyear4\"],\r\n        [\"arly\", \"arly1\", \"arly4\"],\r\n        [\"arly1\", \"arly3\", \"arly5\"],\r\n        [\"mily\", \"mily2\", \"mily4\"],\r\n        [\"mily2\", \"mily3\", \"mily5\"],\r\n        [\"pely\", \"pely2\", \"pely4\"],\r\n        [\"pely2\", \"pely3\", \"pely5\"],\r\n        [\"tcaly\", \"tcaly2\", \"tcaly4\"],\r\n        [\"tcaly2\", \"tcaly3\", \"tcaly5\"],\r\n        [\"faely\", \"faely2\", \"faely4\"],\r\n        [\"faely2\", \"faely3\", \"faely5\"],\r\n        [\"taly\", \"taly2\", \"taly4\"],\r\n        [\"taly2\", \"taly3\", \"taly5\"]\r\n    ];\r\n    ratioFields.forEach(f => calculateRatio(frm, f[0], f[1], f[2]));\r\n\r\n    // --- \"3\" Ratio Functions ---\r\n    calculateRatioSet3(frm);\r\n    \r\n    // --- NEW ADDITIONS (from your requirement) ---\r\n    calculateACPLYRatio1(frm);\r\n    calculateACPLYRatio2(frm);\r\n    calculateNPLYRatio1(frm);\r\n    calculateNPLYRatio2(frm);\r\n    calculateAELYRatio1(frm);\r\n    calculateAELYRatio2(frm);\r\n    calculateTCLLYRatio1(frm);\r\n    calculateTCLLYRatio2(frm);\r\n    calculateLTLLYRatio1(frm);\r\n    calculateLTLLYRatio2(frm);\r\n    calculateTLLYRatio1(frm);\r\n    calculateTLLYRatio2(frm);\r\n    calculateCOELYRatio1(frm);\r\n    calculateCOELYRatio2(frm);\r\n    calculateTLACOELYRatio1(frm);\r\n    calculateTLACOELYRatio2(frm);\r\n    \r\n    \r\n    \t// --- \u2705 NEW FUNCTIONS YOU REQUESTED ---\r\n     calculateNetRatioh11(frm);\r\n     calculateNetRatioh22(frm);\r\n     calculateNetRatioh33(frm);\r\n     \r\n     calculatecogslyRatioh1(frm);\r\n     calculatecogslyRatioh2(frm);\r\n     calculatecogslyRatioh3(frm);\r\n\r\n     calculateNetRatioh1(frm);\r\n     calculateNetRatioh2(frm);\r\n     calculateNetRatioh3(frm);\r\n\r\n     calculateelyRatio11(frm);\r\n     calculateelyRatio22(frm);\r\n     calculateelyRatio33(frm);\r\n\r\n     calculateniftylyRatioh1(frm);\r\n     calculateniftylyRatioh2(frm);\r\n     calculateniftylyRatioh3(frm);\r\n     \r\n     calculateTCALYRatio10;\r\n     calculateTCALYRatio20;\r\n     calculateTCALYRatio30;\r\n     \r\n    \r\n   \r\n\t\r\n\t\r\n\r\n\r\n    frappe.show_alert({ message: \"\u2705 All totals and ratios calculated!\", indicator: \"green\" });\r\n    frm.refresh_fields();\r\n}\r\n\r\n\r\n\r\n\r\n\r\n// --- Gross Margin & Nifty ---\r\nfunction calculateGM(frm, salesField, cogsField, targetField) {\r\n    frm.set_value(targetField, (num(frm.doc[salesField]) - num(frm.doc[cogsField])).toFixed(2));\r\n}\r\nfunction calculateNifty(frm, gmField, expField, targetField) {\r\n    frm.set_value(targetField, (num(frm.doc[gmField]) - num(frm.doc[expField])).toFixed(2));\r\n}\r\n\r\n\r\n// --- Incremental ---\r\nfunction calculateIncremental(frm, version) {\r\n    const tcllyField = version === 1 ? 'tclly' : `tclly${version}`;\r\n    const ltllyField = version === 1 ? 'ltlly' : `ltlly${version}`;\r\n    const targetField = version === 1 ? 'tlacoely' : `tlacoely${version}`;\r\n    frm.set_value(targetField, (num(frm.doc[tcllyField]) + num(frm.doc[ltllyField])).toFixed(2));\r\n}\r\n\r\n\r\n\r\n\r\n// --- Ratio Calculations ---\r\nfunction calculateRatios(frm) {\r\n\r\n    // --- Current Ratio ---\r\n    // \u2705 Correct formula\r\nfrm.set_value('currentratio',  ratio(num(frm.doc.tcaly),  num(frm.doc.tclly)));\r\nfrm.set_value('currentratio1', ratio(num(frm.doc.tcaly2), num(frm.doc.tclly2)));\r\nfrm.set_value('currentratio2', ratio(num(frm.doc.tcaly3), num(frm.doc.tclly3)));\r\n\r\n\r\nfrm.set_value('quickratio',  ratio(num(frm.doc.taly),  num(frm.doc.tclly)));\r\nfrm.set_value('quickratio1', ratio(num(frm.doc.taly2), num(frm.doc.tclly2)));\r\nfrm.set_value('quickratio2', ratio(num(frm.doc.taly3), num(frm.doc.tclly3)));\r\n\r\n\r\n\r\n\r\n\r\n    // --- Days Sales Outstanding ---\r\n    frm.set_value('dayssalesoutstanding',  dsor(num(frm.doc.mily)));\r\n    frm.set_value('dayssalesoutstanding1', dsor(num(frm.doc.mily2)));\r\n    frm.set_value('dayssalesoutstanding2', dsor(num(frm.doc.mily3)));\r\n\r\n    // --- Inventory Turnover ---\r\n    frm.set_value('inventoryturnover',  ratio(num(frm.doc.cogsly),  num(frm.doc.mily)));\r\n    frm.set_value('inventoryturnover1', ratio(num(frm.doc.cogsly1), num(frm.doc.mily2)));\r\n    frm.set_value('inventoryturnover2', ratio(num(frm.doc.cogsly2), num(frm.doc.mily3)));\r\n\r\n    // --- Account Payable to Sales ---\r\n    frm.set_value('accountpayabletosales',  ratio(num(frm.doc.cogsly),  num(frm.doc.acply)));\r\n    frm.set_value('accountpayabletosales1', ratio(num(frm.doc.cogsly1), num(frm.doc.acply2)));\r\n    frm.set_value('accountpayabletosales2', ratio(num(frm.doc.cogsly2), num(frm.doc.acply3)));\r\n\r\n    // --- Return on Sales ---\r\n    frm.set_value('returnonsales',  percent(num(frm.doc.niftyly),  num(frm.doc.latest_year)));\r\n    frm.set_value('returnonsales1', percent(num(frm.doc.niftyly1), num(frm.doc.latest_year_1)));\r\n    frm.set_value('returnonsales2', percent(num(frm.doc.niftyly2), num(frm.doc.latest_year_3)));\r\n\r\n    // --- Working Capital ---\r\n    frm.set_value('workingcaptial',  (num(frm.doc.tcaly)  - num(frm.doc.tclly)).toFixed(2));\r\n    frm.set_value('workingcaptial1', (num(frm.doc.tcaly2) - num(frm.doc.tclly2)).toFixed(2));\r\n    frm.set_value('workingcaptial2', (num(frm.doc.tcaly3) - num(frm.doc.tclly3)).toFixed(2));\r\n\r\n    // --- Net Worth ---\r\n    frm.set_value('networth',  (num(frm.doc.taly)  - num(frm.doc.tlly)).toFixed(2));\r\n    frm.set_value('networth1', (num(frm.doc.taly2) - num(frm.doc.tlly2)).toFixed(2));\r\n    frm.set_value('networth2', (num(frm.doc.taly3) - num(frm.doc.tlly3)).toFixed(2));\r\n\r\n    // --- Gross Profit Margin ---\r\n    frm.set_value('grossprofitmargin',  percent(num(frm.doc.latest_year),  num(frm.doc.niftyly)));\r\n    frm.set_value('grossprofitmargin1', percent(num(frm.doc.latest_year_1), num(frm.doc.niftyly1)));\r\n    frm.set_value('grossprofitmargin2', percent(num(frm.doc.latest_year_3), num(frm.doc.niftyly2)));\r\n}\r\n\r\n// --- Ratio Calculator for Ratio Fields ---\r\nfunction calculateRatio(frm, field1, field2, target) {\r\n    const v1 = num(frm.doc[field1]);\r\n    const v2 = num(frm.doc[field2]);\r\n    frm.set_value(target, v2 === 0 ? '' : ((v1 / v2) * 100).toFixed(2));\r\n}\r\n\r\n// --- All Ratios (Percentage view of main line items) ---\r\nfunction calculateAllRatios(frm) {\r\n    const n = v => parseFloat(v) || 0;\r\n\r\n    // Net Ratios\r\n    frm.set_value(\r\n        'latest_year_4', \r\n        n(frm.doc.latest_year) && n(frm.doc.latest_year_1) !== 0\r\n        ? ((n(frm.doc.latest_year)/n(frm.doc.latest_year_1))*100).toFixed(2)\r\n        : 0\r\n        );\r\n    frm.set_value(\r\n        'latest_year_5', \r\n        n(frm.doc.latest_year_1) && n(frm.doc.latest_year_3) !== 0\r\n        ? ((n(frm.doc.latest_year_1)/n(frm.doc.latest_year_3))*100).toFixed(2) \r\n        : 0\r\n        );\r\n    frm.set_value(\r\n        'latest_year_6', \r\n        n(frm.doc.latest_year_3) && n(frm.doc.latest_year_3) !== 0\r\n        ? ((n(frm.doc.latest_year_3)/n(frm.doc.latest_year_3))*100).toFixed(2) \r\n        : 0 \r\n        );\r\n\r\n    // COGS Ratios\r\n    \r\n    frm.set_value(\r\n        'cogsly3', \r\n        n(frm.doc.cogsly) && n(frm.doc.cogsly1) !== 0\r\n        ? ((n(frm.doc.cogsly)/n(frm.doc.cogsly1))*100).toFixed(2)  \r\n        : 0\r\n        );\r\n    frm.set_value(\r\n        'cogsly4', \r\n        n(frm.doc.cogsly1) && n(frm.doc.cogsly2) !== 0\r\n        ? ((n(frm.doc.cogsly1)/n(frm.doc.cogsly2))*100).toFixed(2)\r\n        : 0\r\n        );\r\n    frm.set_value(\r\n        'cogsly5', \r\n        n(frm.doc.cogsly2) && n(frm.doc.cogsly2) !== 0\r\n        ? ((n(frm.doc.cogsly2)/n(frm.doc.cogsly2))*100).toFixed(2)\r\n        : 0\r\n        );\r\n\r\n    // GM Ratios\r\nfrm.set_value(\r\n    'gmly3',\r\n    n(frm.doc.latest_year) && n(frm.doc.gmly1) !== 0\r\n        ? ((n(frm.doc.gmly) / n(frm.doc.gmly1)) * 100).toFixed(2)\r\n        : 0\r\n);\r\n\r\nfrm.set_value(\r\n    'gmly4',\r\n    n(frm.doc.latest_year_1) && n(frm.doc.gmly2) !== 0\r\n        ? ((n(frm.doc.gmly1) / n(frm.doc.gmly2)) * 100).toFixed(2)\r\n        : 0\r\n);\r\n\r\nfrm.set_value(\r\n    'gmly5',\r\n    n(frm.doc.latest_year_3) && n(frm.doc.gmly2) !== 0\r\n        ? ((n(frm.doc.gmly2) / n(frm.doc.gmly2)) * 100).toFixed(2)\r\n        : 0\r\n);\r\n\r\n\r\n    // Ely Ratios\r\n    frm.set_value(\r\n        'ely3',  \r\n       n(frm.doc.ely) && n(frm.doc.ely1) !== 0 \r\n        ? ((n(frm.doc.ely)/n(frm.doc.ely1))*100).toFixed(2) \r\n        : 0\r\n        );\r\n    frm.set_value(\r\n        'ely4', \r\n        n(frm.doc.ely1) && n(frm.doc.ely2) !== 0\r\n        ? ((n(frm.doc.ely1)/n(frm.doc.ely2))*100).toFixed(2)\r\n        : 0\r\n        );\r\n    frm.set_value(\r\n        'ely5',\r\n       n(frm.doc.ely2) && n(frm.doc.ely2) !== 0\r\n        ? ((n(frm.doc.ely2)/n(frm.doc.ely2))*100).toFixed(2)\r\n        : 0\r\n        );\r\n\r\n    // Nifty Ratios\r\n    frm.set_value(\r\n        'niftyly3', \r\n        n(frm.doc.niftyly) && n(frm.doc.niftyly1) !== 0 \r\n        ? ((n(frm.doc.niftyly)/n(frm.doc.niftyly1))*100).toFixed(2) \r\n        : 0\r\n        );\r\n    frm.set_value(\r\n        'niftyly4', \r\n         n(frm.doc.niftyly1) && n(frm.doc.niftyly2) !== 0 \r\n        ? ((n(frm.doc.niftyly1)/n(frm.doc.niftyly2))*100).toFixed(2)\r\n        : 0\r\n        );\r\n    frm.set_value(\r\n        'niftyly5', \r\n        n(frm.doc.niftyly2) && n(frm.doc.niftyly2) !== 0 \r\n        ? ((n(frm.doc.niftyly2)/n(frm.doc.niftyly2))*100).toFixed(2)\r\n        : 0\r\n        );\r\n}\r\n\r\nfunction calculateACPLYRatio1(frm){calcRatio(frm,'acply','acply2','acply4');}\r\nfunction calculateACPLYRatio2(frm){calcRatio(frm,'acply2','acply3','acply5');}\r\nfunction calculateNPLYRatio1(frm){calcRatio(frm,'nply','nply2','nply4');}\r\nfunction calculateNPLYRatio2(frm){calcRatio(frm,'nply2','nply3','nply5');}\r\nfunction calculateAELYRatio1(frm){calcRatio(frm,'aely','aely2','aely4');}\r\nfunction calculateAELYRatio2(frm){calcRatio(frm,'aely2','aely3','aely5');}\r\nfunction calculateTCLLYRatio1(frm){calcRatio(frm,'tclly','tclly2','tclly4');}\r\nfunction calculateTCLLYRatio2(frm){calcRatio(frm,'tclly2','tclly3','tclly5');}\r\nfunction calculateLTLLYRatio1(frm){calcRatio(frm,'ltlly','ltlly2','ltlly4');}\r\nfunction calculateLTLLYRatio2(frm){calcRatio(frm,'ltlly2','ltlly3','ltlly5');}\r\nfunction calculateTLLYRatio1(frm){calcRatio(frm,'tlly','tlly2','tlly4');}\r\nfunction calculateTLLYRatio2(frm){calcRatio(frm,'tlly2','tlly3','tlly5');}\r\nfunction calculateCOELYRatio1(frm){calcRatio(frm,'coely','coely2','coely4');}\r\nfunction calculateCOELYRatio2(frm){calcRatio(frm,'coely2','coely3','coely5');}\r\nfunction calculateTLACOELYRatio1(frm){calcRatio(frm,'tlacoely','tlacoely2','tlacoely4');}\r\nfunction calculateTLACOELYRatio2(frm){calcRatio(frm,'tlacoely2','tlacoely3','tlacoely5');}\r\n\r\nfunction calcRatio(frm, f1, f2, target){\r\n    var v1 = parseFloat(frm.doc[f1]) || 0;\r\n    var v2 = parseFloat(frm.doc[f2]) || 0;\r\n    if (v2 === 0) frm.set_value(target, '');\r\n    else frm.set_value(target, ((v1 / v2) * 100).toFixed(2));\r\n}\r\n\r\n\r\n// --- Helper Ratio Functions ---\r\nfunction ratio(a, b) { return b === 0 ? '' : (a / b).toFixed(2); }\r\nfunction percent(a, b) { return b === 0 ? '' : ((a / b) * 100).toFixed(2); }\r\nfunction dsor(a) { return a === 0 ? '' : (365 / a).toFixed(2); }\r\n\r\n\r\n\r\n\r\n// Return on Assets\r\nfunction calculateniftylyRatio11(frm) {\r\n    var niftyly = parseFloat(frm.doc.niftyly) || 0;\r\n    var taly = parseFloat(frm.doc.taly) || 0;\r\n\r\n    if (taly === 0 || niftyly === 0) {\r\n        frm.set_value('returnonassets', 0);\r\n    } else {\r\n        var ratio = niftyly / taly;\r\n        frm.set_value('returnonassets', ratio.toFixed(2));\r\n        frm.set_df_property('returnonassets', 'read_only', 1);\r\n    }\r\n}\r\n\r\n// Return on Assets\r\nfunction calculateniftylyRatio22(frm) {\r\n    var niftyly1 = parseFloat(frm.doc.niftyly1) || 0;\r\n    var taly2 = parseFloat(frm.doc.taly2) || 0;\r\n\r\n    if (taly2 === 0 || niftyly1 === 0) {\r\n        frm.set_value('returnonassets1', 0);\r\n    } else {\r\n        var ratio = niftyly1 / taly2;\r\n        frm.set_value('returnonassets1', ratio.toFixed(2));\r\n        frm.set_df_property('returnonassets1', 'read_only', 1);\r\n    }\r\n}\r\n\r\nfunction calculateniftylyRatio33(frm) {\r\n    var niftyly2 = parseFloat(frm.doc.niftyly2) || 0;\r\n    var taly3 = parseFloat(frm.doc.taly3) || 0;\r\n\r\n    if (taly3 === 0 || niftyly2 === 0) {\r\n        frm.set_value('returnonassets2', 0);\r\n    } else {\r\n        var ratio = niftyly2 / taly3;\r\n        frm.set_value('returnonassets2', ratio.toFixed(2));\r\n        frm.set_df_property('returnonassets2', 'read_only', 1);\r\n    }\r\n}\r\n\r\n\r\n// --- ACCOUNTS RECEIVABLE TURNOVER RATIO ---\r\nfunction calculateARLYRatio10(frm) {\r\n    var arly = parseFloat(frm.doc.arly) || 0;\r\n    var latest_year = parseFloat(frm.doc.latest_year) || 0;\r\n\r\n    if (arly === 0 || latest_year === 0) {\r\n        frm.set_value('accountreceivaleturnover', 0);\r\n    } else {\r\n        var ratio = (latest_year / arly);\r\n        frm.set_value('accountreceivaleturnover', ratio.toFixed(2));\r\n    frm.set_df_property('accountreceivaleturnover', 'read_only', 1);\r\n  }\r\n}\r\n\r\nfunction calculateARLYRatio20(frm) {\r\n    var arly1 = parseFloat(frm.doc.arly1) || 0;\r\n    var latest_year = parseFloat(frm.doc.latest_year) || 0;\r\n\r\n    if (arly1 === 0 || latest_year === 0) {\r\n        frm.set_value('accountreceivaleturnover1', 0);\r\n    } else {\r\n        var ratio = (latest_year / arly1);\r\n        frm.set_value('accountreceivaleturnover1', ratio.toFixed(2));\r\n    }\r\n    frm.set_df_property('accountreceivaleturnover1', 'read_only', 1);\r\n}\r\n\r\nfunction calculateARLYRatio30(frm) {\r\n    var arly3 = parseFloat(frm.doc.arly3) || 0;\r\n    var latest_year = parseFloat(frm.doc.latest_year) || 0;\r\n\r\n    if (arly3 === 0 || latest_year === 0) {\r\n        frm.set_value('accountreceivaleturnover2', 0);\r\n    } else {\r\n        var ratio = (latest_year / arly3);\r\n        frm.set_value('accountreceivaleturnover2', ratio.toFixed(2));\r\n    }\r\n    frm.set_df_property('accountreceivaleturnover2', 'read_only', 1);\r\n}\r\n\r\n// ============================================================\r\n// --- DEBT-TO-EQUITY RATIO ---\r\nfunction calculateCOELYRatio10(frm) {\r\n    var tclly = parseFloat(frm.doc.tclly) || 0;\r\n    var coely = parseFloat(frm.doc.coely) || 0;\r\n\r\n    if (coely === 0 || tclly === 0) {\r\n        frm.set_value('debttoquityratio', 0);\r\n    } else {\r\n        var ratio = tclly / coely;\r\n        frm.set_value('debttoquityratio', ratio.toFixed(2));\r\n        frm.set_df_property('debttoquityratio', 'read_only', 1);\r\n    }\r\n}\r\n\r\nfunction calculateCOELYRatio20(frm) {\r\n    var tclly2 = parseFloat(frm.doc.tclly2) || 0;\r\n    var coely2 = parseFloat(frm.doc.coely2) || 0;\r\n\r\n    if (coely2 === 0 || tclly2 === 0) {\r\n        frm.set_value('debttoequityratio1', 0);\r\n    } else {\r\n        var ratio = tclly2 / coely2;\r\n        frm.set_value('debttoequityratio1', ratio.toFixed(2));\r\n        frm.set_df_property('debttoequityratio1', 'read_only', 1);\r\n    }\r\n}\r\n\r\nfunction calculateCOELYRatio30(frm) {\r\n    var tclly3 = parseFloat(frm.doc.tclly3) || 0;\r\n    var coely3 = parseFloat(frm.doc.coely3) || 0;\r\n\r\n    if (coely3 === 0 || tclly3 === 0) {\r\n        frm.set_value('debttoequityratio2', 0);\r\n    } else {\r\n        var ratio = tclly3 / coely3;\r\n        frm.set_value('debttoequityratio2', ratio.toFixed(2));\r\n        frm.set_df_property('debttoequityratio2', 'read_only', 1);\r\n    }\r\n}\r\n\r\n// ============================================================\r\n// --- WORKING CAPITAL (RETURN ON CAPITAL EMPLOYED) ---\r\nfunction calculateWCRatio1(frm) {\r\n    var niftyly = parseFloat(frm.doc.niftyly) || 0;\r\n    var workingcaptial = parseFloat(frm.doc.workingcaptial) || 0;\r\n\r\n    if (workingcaptial === 0 || niftyly === 0) {\r\n        frm.set_value('returnoncaptialequity', 0);\r\n    } else {\r\n        var ratio = niftyly / workingcaptial;\r\n        frm.set_value('returnoncaptialequity', ratio.toFixed(2));\r\n    }\r\n    frm.set_df_property('returnoncaptialequity', 'read_only', 1);\r\n}\r\n\r\nfunction calculateWCRatio2(frm) {\r\n    var niftyly1 = parseFloat(frm.doc.niftyly1) || 0;\r\n    var workingcaptial1 = parseFloat(frm.doc.workingcaptial1) || 0;\r\n\r\n    if (workingcaptial1 === 0 || niftyly1 === 0) {\r\n        frm.set_value('returnoncaptialequity1', 0);\r\n    } else {\r\n        var ratio = niftyly1 / workingcaptial1;\r\n        frm.set_value('returnoncaptialequity1', ratio.toFixed(2));\r\n    }\r\n    frm.set_df_property('returnoncaptialequity1', 'read_only', 1);\r\n}\r\n\r\nfunction calculateWCRatio3(frm) {\r\n    var niftyly2 = parseFloat(frm.doc.niftyly2) || 0;\r\n    var workingcaptial2 = parseFloat(frm.doc.workingcaptial2) || 0;\r\n\r\n    if (workingcaptial2 === 0 || niftyly2 === 0) {\r\n        frm.set_value('returnoncaptialequity2', 0);\r\n    } else {\r\n        var ratio = niftyly2 / workingcaptial2;\r\n        frm.set_value('returnoncaptialequity2', ratio.toFixed(2));\r\n    }\r\n    frm.set_df_property('returnoncaptialequity2', 'read_only', 1);\r\n}\r\n/* ---------------- SALES RATIO FUNCTIONS ---------------- */\r\nfunction calculateNetRatioh11(frm) {\r\n    let current = parseFloat(frm.doc.latest_year) || 0;\r\n    let prev = parseFloat(frm.doc.latest_year_1) || 0;\r\n\r\n    if (current === 0 || prev === 0) {\r\n        frm.set_value('sales', 0);\r\n    } else {\r\n        frm.set_value('sales', (current / prev) .toFixed(2));\r\n    }\r\n    frm.set_df_property('sales', 'read_only', 1);\r\n}\r\n\r\nfunction calculateNetRatioh22(frm) {\r\n    let current = parseFloat(frm.doc.latest_year_1) || 0;\r\n    let prev = parseFloat(frm.doc.latest_year_1) || 0;\r\n\r\n    if (current === 0 || prev === 0) {\r\n        frm.set_value('salesly', 0);\r\n    } else {\r\n        frm.set_value('salesly', ((current / prev) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('salesly', 'read_only', 1);\r\n}\r\n\r\nfunction calculateNetRatioh33(frm) {\r\n    let current = parseFloat(frm.doc.latest_year_3) || 0;\r\n    let base = parseFloat(frm.doc.latest_year_3) || 0;\r\n\r\n    if (current === 0 || base === 0) {\r\n        frm.set_value('salesly2', 0);\r\n    } else {\r\n        frm.set_value('salesly2', ((current / base) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('salesly2', 'read_only', 1);\r\n}\r\n\r\n/* ---------------- COGS RATIO FUNCTIONS ---------------- */\r\nfunction calculatecogslyRatioh1(frm) {\r\n    let cogs = parseFloat(frm.doc.cogsly) || 0;\r\n    let current = parseFloat(frm.doc.latest_year) || 0;\r\n\r\n    if (cogs === 0 || current === 0) {\r\n        frm.set_value('costofgoodssold', 0);\r\n    } else {\r\n        frm.set_value('costofgoodssold', ((cogs / current) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('costofgoodssold', 'read_only', 1);\r\n}\r\n\r\nfunction calculatecogslyRatioh2(frm) {\r\n    let cogs = parseFloat(frm.doc.cogsly1) || 0;\r\n    let current = parseFloat(frm.doc.latest_year_1) || 0;\r\n\r\n    if (cogs === 0 || current === 0) {\r\n        frm.set_value('costofgoodssoldly1', 0);\r\n    } else {\r\n        frm.set_value('costofgoodssoldly1', ((cogs / current) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('costofgoodssoldly1', 'read_only', 1);\r\n}\r\n\r\nfunction calculatecogslyRatioh3(frm) {\r\n    let cogs = parseFloat(frm.doc.cogsly2) || 0;\r\n    let current = parseFloat(frm.doc.latest_year_3) || 0;\r\n\r\n    if (cogs === 0 || current === 0) {\r\n        frm.set_value('costofgoodssoldly2', 0);\r\n    } else {\r\n        frm.set_value('costofgoodssoldly2', ((cogs / current) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('costofgoodssoldly2', 'read_only', 1);\r\n}\r\n\r\n/* ---------------- GROSS MARGIN RATIO FUNCTIONS ---------------- */\r\nfunction calculateNetRatioh1(frm) {\r\n    let gm = parseFloat(frm.doc.gmly) || 0;\r\n    let current = parseFloat(frm.doc.latest_year) || 0;\r\n\r\n    if (gm === 0 || current === 0) {\r\n        frm.set_value('grossmargin', 0);\r\n    } else {\r\n        frm.set_value('grossmargin', ((gm / current) * 100).toFixed(2));\r\n    }\r\n    frm.set_df_property('grossmargin', 'read_only', 1);\r\n}\r\n\r\nfunction calculateNetRatioh2(frm) {\r\n    let gm = parseFloat(frm.doc.gmly1) || 0;\r\n    let current = parseFloat(frm.doc.latest_year_1) || 0;\r\n\r\n   \r\n        frm.set_value(\r\n            'grossmarginly1',\r\n            n(frm.doc.gmly1) && n(frm.doc.latest_year_1) !== 0\r\n            ? ((n(frm.doc.gmly1) / n(frm.doc.latest_year_1)) * 100).toFixed(2)\r\n        : 0 \r\n        );\r\n    \r\n    frm.set_df_property('grossmarginly1', 'read_only', 1);\r\n}\r\n\r\nfunction calculateNetRatioh3(frm) {\r\n    let gm = parseFloat(frm.doc.gmly2) || 0;\r\n    let current = parseFloat(frm.doc.latest_year_3) || 0;\r\n\r\n    \r\n        frm.set_value(\r\n            'grossmarginly2',\r\n            n(frm.doc.gmly2) && n(frm.doc.latest_year_3) !== 0\r\n            ? ((n(frm.doc.gmly2) / n(frm.doc.latest_year_3)) * 100).toFixed(2)\r\n        : 0\r\n        );\r\n    \r\n    frm.set_df_property('grossmarginly2', 'read_only', 1);\r\n}\r\n\r\n/* ---------------- EXPENSES RATIO FUNCTIONS ---------------- */\r\nfunction calculateelyRatio11(frm) {\r\n    let exp = parseFloat(frm.doc.ely) || 0;\r\n    let current = parseFloat(frm.doc.latest_year) || 0;\r\n\r\n    if (exp === 0 || current === 0) {\r\n        frm.set_value('expenses', 0);\r\n    } else {\r\n        frm.set_value('expenses', ((exp / current) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('expenses', 'read_only', 1);\r\n}\r\n\r\nfunction calculateelyRatio22(frm) {\r\n    let exp = parseFloat(frm.doc.ely1) || 0;\r\n    let current = parseFloat(frm.doc.latest_year_1) || 0;\r\n\r\n    if (exp === 0 || current === 0) {\r\n        frm.set_value('expensesly', 0);\r\n    } else {\r\n        frm.set_value('expensesly', ((exp / current) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('expensesly', 'read_only', 1);\r\n}\r\n\r\nfunction calculateelyRatio33(frm) {\r\n    let exp = parseFloat(frm.doc.ely2) || 0;\r\n    let current = parseFloat(frm.doc.latest_year_3) || 0;\r\n\r\n    if (exp === 0 || current === 0) {\r\n        frm.set_value('expensesly2', 0);\r\n    } else {\r\n        frm.set_value('expensesly2', ((exp / current) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('expensesly2', 'read_only', 1);\r\n}\r\n\r\n/* ---------------- NET INCOME RATIO FUNCTIONS ---------------- */\r\nfunction calculateniftylyRatioh1(frm) {\r\n    let ni = parseFloat(frm.doc.niftyly) || 0;\r\n    let current = parseFloat(frm.doc.latest_year) || 0;\r\n\r\n    if (ni === 0 || current === 0) {\r\n        frm.set_value('netincome', 0);\r\n    } else {\r\n        frm.set_value('netincome', ((ni / current) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('netincome', 'read_only', 1);\r\n}\r\n\r\nfunction calculateniftylyRatioh2(frm) {\r\n    let ni = parseFloat(frm.doc.niftyly1) || 0;\r\n    let current = parseFloat(frm.doc.latest_year_1) || 0;\r\n\r\n    if (ni === 0 || current === 0) {\r\n        frm.set_value('netincomely', 0);\r\n    } else {\r\n        frm.set_value('netincomely', ((ni / current) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('netincomely', 'read_only', 1);\r\n}\r\n\r\nfunction calculateniftylyRatioh3(frm) {\r\n    let ni = parseFloat(frm.doc.niftyly2) || 0;\r\n    let current = parseFloat(frm.doc.latest_year_3) || 0;\r\n\r\n    if (ni === 0 || current === 0) {\r\n        frm.set_value('netincomely2', 0);\r\n    } else {\r\n        frm.set_value('netincomely2', ((ni / current) ).toFixed(2));\r\n    }\r\n    frm.set_df_property('netincomely2', 'read_only', 1);\r\n}\r\n\r\n\r\n\r\n\r\n\r\n// --- Ratio Set 3 ---\r\nfunction calculateRatioSet3(frm) {\r\n    const set = [\r\n        ['cashlatestyear5', 'cashlatestyear2'],\r\n        ['arly6', 'arly3'],\r\n        ['mily6', 'mily3'],\r\n        ['pely6', 'pely3'],\r\n        ['tcaly6', 'tcaly3'],\r\n        ['faely6', 'faely3'],\r\n        ['taly6', 'taly3'],\r\n        ['acply6', 'acply3'],\r\n        ['nply6', 'nply3'],\r\n        ['aely6', 'aely3'],\r\n        ['tclly6', 'tclly3'],\r\n        ['ltlly6', 'ltlly3'],\r\n        ['tlly6', 'tlly3'],\r\n        ['coely6', 'coely3'],\r\n        ['tlacoely6', 'tlacoely3']\r\n    ];\r\n\r\n    set.forEach(([target, source]) => {\r\n        frm.set_value(target, num(frm.doc[source]) ? 100 : 0);\r\n    });\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "cover letter ECI",
  "enabled": 1,
  "modified": "2025-11-05 09:25:49.444060",
  "module": null,
  "name": "cover letter ECI script",
  "script": "frappe.ui.form.on('cover letter ECI', {\n    refresh(frm) {\n        // Get the value of 'to' field from current form\n        var to_value = frm.doc.to;\n\n        // Fetch matching Company Details record where name1 == to_value\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Company-Details',\n                filters: {\n                    'name1': to_value\n                },\n                fields: ['postal_address'],\n                limit: 1\n            },\n            callback: function(response) {\n                if (response.message && response.message.length > 0) {\n                    frm.set_value('address', response.message[0].postal_address);\n                } else {\n                    frappe.msgprint(\"No matching Company Details found for: \" + to_value);\n                }\n            },\n            error: function(err) {\n                console.error(err);\n                frappe.msgprint('An error occurred while fetching Company Details.');\n            }\n        });\n    }\n});\n\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Policy Schedule ECI Quotation",
  "enabled": 1,
  "modified": "2025-11-10 12:45:51.915545",
  "module": null,
  "name": "policy Schedule script",
  "script": "frappe.ui.form.on('Policy Schedule ECI Quotation', {\r\n    refresh: function(frm) {\r\n        // Disable adding rows in the table\r\n        frm.set_df_property('table', 'cannot_add_rows', true);\r\n        \r\n\r\n        //from eci quotation child table\r\n        fetchPolicyTableData(frm);\r\n        \r\n        fetchInsuredPercentageFromQuotation(frm);\r\n   \r\n\r\n        // --- Fetch Company Details ---\r\n        var insuredName = frm.doc.name_of_insured;\r\n        if (insuredName) {\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Company-Details',\r\n                    filters: { name1: insuredName },\r\n                    fields: ['postal_address', 'telephone', 'fax'],\r\n                    limit_page_length: 1\r\n                },\r\n                callback: function(response) {\r\n                    if (response.message && response.message.length > 0) {\r\n                        var company = response.message[0];\r\n                        frm.set_value('address', company.postal_address || '');\r\n                        frm.set_value('telephone', company.telephone || '');\r\n                        frm.set_value('fax', company.fax || '');\r\n                    } else {\r\n                        frappe.msgprint('No matching record found in Company-Details for ' + insuredName);\r\n                    }\r\n                },\r\n                error: function(err) {\r\n                    console.error('Error fetching Company-Details:', err);\r\n                    frappe.msgprint('Error fetching Company-Details. Check console.');\r\n                }\r\n            });\r\n        }\r\n\r\n        // --- Fetch Policy Number ---\r\n        var Num = frm.doc.quotation_number;\r\n        if (Num) {\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Policy Approvals',\r\n                    filters: { quotation_numbers: Num }, \r\n                    fields: ['policy_number'],\r\n                    limit: 1\r\n                },\r\n                callback: function(response) {\r\n                    if (response.message && response.message.length > 0) {\r\n                        frm.set_value('policy_number', response.message[0].policy_number || '');\r\n                    } else {\r\n                        frappe.msgprint('No matching record found for quotation No: ' + Num);\r\n                    }\r\n                },\r\n                error: function(err) {\r\n                    console.error('Error fetching Policy Approvals:', err);\r\n                    frappe.msgprint('Error fetching Policy Approvals. Check console.');\r\n                }\r\n            });\r\n        }\r\n    },\r\n\r\n});\r\n\r\n\r\nfunction fetchInsuredPercentageFromQuotation(frm) {\r\n    // Clear existing rows in policy_table\r\n    frm.clear_table(\"policy_table\");\r\n\r\n    // Fetch ECI Quotations main table where schedule_no matches quotation_number\r\n    frappe.call({\r\n        method: 'frappe.client.get',\r\n        args: {\r\n            doctype: 'ECI Quotations',\r\n            filters: { schedule_no: frm.doc.quotation_number },\r\n            fields: ['insured_commercial_risks_for_all_insured_companies']  // main table field\r\n        },\r\n        callback: function(response) {\r\n            if (response.message) {\r\n                let insuredValue = response.message.insured_commercial_risks_for_all_insured_companies || '';\r\n\r\n                // Add a new row in policy_table\r\n                let newRow = frm.add_child(\"policy_table\");\r\n                newRow.insured_percentage = insuredValue;\r\n\r\n                // Refresh child table\r\n                frm.refresh_field(\"policy_table\");\r\n            } else {\r\n                frappe.msgprint(\"No matching Quotation found for Schedule No: \" + frm.doc.quotation_number);\r\n            }\r\n        },\r\n        error: function(err) {\r\n            console.error(\"Error fetching ECI Quotation main table:\", err);\r\n            frappe.msgprint(\"Error fetching Quotation data. Check console.\");\r\n        }\r\n    });\r\n}\r\n\r\n\r\nfunction fetchPolicyTableData(frm) {\r\n    frm.clear_table(\"policy_table\");\r\n\r\n    // Step 1: fetch Proposal for currency lookup\r\n    frappe.call({\r\n        method: 'frappe.client.get',\r\n        args: {\r\n            doctype: 'ECI Proposal',\r\n            name: frm.doc.proposal_no\r\n        },\r\n        callback: function(proposalResp) {\r\n            let proposalRows = (proposalResp.message && proposalResp.message.export_turnover) || [];\r\n\r\n            // Build currency lookup by country\r\n            let currencyLookup = {};\r\n            proposalRows.forEach(pRow => {\r\n                let country = pRow.country_of_dest || pRow.country;\r\n                if (country && pRow.currency_invoiced_eg_pularandsusd) {\r\n                    currencyLookup[country] = pRow.currency_invoiced_eg_pularandsusd;\r\n                }\r\n            });\r\n\r\n            // Step 2: fetch Quotation child table\r\n            frappe.call({\r\n                method: 'frappe.client.get',\r\n                args: {\r\n                    doctype: 'ECI Quotations',\r\n                    filters: { schedule_no: frm.doc.quotation_number },\r\n                    fields: ['eci_quo_table']\r\n                },\r\n                callback: function(quotationResp) {\r\n                    let quotationRows = (quotationResp.message && quotationResp.message.eci_quo_table) || [];\r\n\r\n                    quotationRows.forEach(qRow => {\r\n                        let newRow = frm.add_child(\"policy_table\");\r\n\r\n                        // Explicit mapping\r\n                        newRow.country = qRow.country || '';\r\n                        newRow.terms_of_payment = qRow.payment_terms || '';\r\n                        newRow.premium_rate_code = qRow.premium_rate || '';\r\n            \r\n\r\n                        // Currency comes from Proposal if missing in Quotation\r\n                        let country = qRow.country || '';\r\n                        newRow.currency = qRow.currency_invoiced_eg_pularandsusd \r\n                                           || currencyLookup[country] \r\n                                           || '';\r\n                    });\r\n\r\n                    frm.refresh_field(\"policy_table\");\r\n                }\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\n\r\n\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "DCI Proposals",
  "enabled": 0,
  "modified": "2025-11-05 11:19:18.782629",
  "module": null,
  "name": "Grand total calculation",
  "script": "frappe.ui.form.on('DCI Proposals', {\r\n    // -------------------------------\r\n    // 1\ufe0f\u20e3 File Validation\r\n    // -------------------------------\r\n    validate: function(frm) {\r\n        var fieldsToValidate = [\r\n            'proposal_application',\r\n            'financial_statements__age_analysis',\r\n            'current_debtor_schedule'\r\n        ];\r\n        var allowedExtensions = ['xlsx', 'xls', 'pdf'];\r\n\r\n        fieldsToValidate.forEach(function(fieldname) {\r\n            var file = frm.doc[fieldname];\r\n            if (file) {\r\n                var fileExtension = file.split('.').pop().toLowerCase();\r\n                if (!allowedExtensions.includes(fileExtension)) {\r\n                    frappe.msgprint(__(\"Please upload a file with extension .xlsx, .xls, or .pdf\"));\r\n                    frm.set_value(fieldname, '');\r\n                }\r\n            }\r\n        });\r\n    },\r\n\r\n    // -------------------------------\r\n    // 2\ufe0f\u20e3 File Upload + Data Extraction\r\n    // -------------------------------\r\n    upload: function(frm) {\r\n        var file = frm.doc.upload;\r\n\r\n        if (!file) {\r\n            clearTableAndTotal(frm);\r\n            return;\r\n        }\r\n\r\n        var fileExtension = file.split('.').pop().toLowerCase();\r\n        var allowedExtensions = ['xlsx', 'xls'];\r\n\r\n        if (!allowedExtensions.includes(fileExtension)) {\r\n            frappe.msgprint(__(\"Only Excel (.xlsx, .xls) files are allowed\"));\r\n            frm.set_value('upload', '');\r\n            clearTableAndTotal(frm);\r\n            return;\r\n        }\r\n\r\n        // Call the server-side method to extract Excel data\r\n        frm.call({\r\n            doc: frm.doc,\r\n            method: 'extractData',\r\n            freeze: true,\r\n            freeze_message: __(\"Extracting data, please wait...\"),\r\n            callback: function(response) {\r\n                if (response.exc || !response.message) {\r\n                    frappe.msgprint(\"\u26a0\ufe0f Could not extract data from the uploaded file.\");\r\n                    return;\r\n                }\r\n\r\n                var data = response.message;\r\n                var grandTotal = 0;\r\n\r\n                frm.clear_table('debtorsheduletable');\r\n\r\n                data.forEach(x => {\r\n                    var child = frappe.model.add_child(frm.doc, \"Debtor Schedule Child\", \"debtorsheduletable\");\r\n\r\n                    frappe.model.set_value(child.doctype, child.name, \"buyer\", x.Buyer);\r\n                    frappe.model.set_value(child.doctype, child.name, \"current\", x.Current);\r\n                    frappe.model.set_value(child.doctype, child.name, \"tdays\", x['30Days']);\r\n                    frappe.model.set_value(child.doctype, child.name, \"sdays\", x['60Days']);\r\n                    frappe.model.set_value(child.doctype, child.name, \"ndays\", x['90Days']);\r\n                    frappe.model.set_value(child.doctype, child.name, \"odays\", x['120Days']);\r\n\r\n                    // \u2705 Calculate per-row total safely\r\n                    var total =\r\n                        (Number(x.Current) || 0) +\r\n                        (Number(x['30Days']) || 0) +\r\n                        (Number(x['60Days']) || 0) +\r\n                        (Number(x['90Days']) || 0) +\r\n                        (Number(x['120Days']) || 0);\r\n\r\n                    frappe.model.set_value(child.doctype, child.name, \"total\", total);\r\n\r\n                    grandTotal += total;\r\n                });\r\n\r\n                // \u2705 Update Grand Total field\r\n                frm.set_value('grand_total', grandTotal);\r\n\r\n                frm.refresh_field('debtorsheduletable');\r\n                frm.refresh_field('grand_total');\r\n\r\n                frappe.msgprint(\"\u2705 Data loaded and Grand Total calculated successfully!\");\r\n            }\r\n        });\r\n    },\r\n\r\n    // -------------------------------\r\n    // 3\ufe0f\u20e3 Manual Grand Total Calculation (Button or Event)\r\n    // -------------------------------\r\n    calculate_grand_total: function(frm) {\r\n        let total_sum = 0;\r\n        let any_checked = false;\r\n\r\n        if (frm.doc.debtorsheduletable && frm.doc.debtorsheduletable.length > 0) {\r\n            frm.doc.debtorsheduletable.forEach(row => {\r\n                if (row.select_buyer === 1) {\r\n                    any_checked = true;\r\n                    total_sum += Number(row.total) || 0;\r\n                }\r\n            });\r\n\r\n            // If no buyer selected, sum all\r\n            if (!any_checked) {\r\n                frm.doc.debtorsheduletable.forEach(row => {\r\n                    total_sum += Number(row.total) || 0;\r\n                });\r\n                frm.set_value(\"all_buyers\", 1);\r\n                frm.set_value(\"select_buyers\", 0);\r\n            } else {\r\n                frm.set_value(\"select_buyers\", 1);\r\n                frm.set_value(\"all_buyers\", 0);\r\n            }\r\n\r\n            frm.set_value(\"grand_total\", total_sum);\r\n            frm.refresh_field(\"grand_total\");\r\n        } else {\r\n            frappe.msgprint(\"\u26a0\ufe0f No buyers found in the debtor schedule table.\");\r\n        }\r\n    }\r\n});\r\n\r\n// -------------------------------\r\n// 4\ufe0f\u20e3 Auto Recalculate When Buyer Selected\r\n// -------------------------------\r\nfrappe.ui.form.on('Debtor Schedule Child', {\r\n    select_buyer: function(frm, cdt, cdn) {\r\n        frm.events.calculate_grand_total(frm);\r\n    },\r\n    total: function(frm, cdt, cdn) {\r\n        frm.events.calculate_grand_total(frm);\r\n    }\r\n});\r\n\r\n// -------------------------------\r\n// 5\ufe0f\u20e3 Helper Function to Clear Table & Total\r\n// -------------------------------\r\nfunction clearTableAndTotal(frm) {\r\n    frm.clear_table('debtorsheduletable');\r\n    frm.set_value('grand_total', 0);\r\n    frm.refresh_fields(['debtorsheduletable', 'grand_total']);\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Acceptance Form ECI Quotation",
  "enabled": 1,
  "modified": "2025-11-05 13:59:03.765613",
  "module": null,
  "name": "Acceptance Form ECI Quotation script",
  "script": "frappe.ui.form.on('Acceptance Form ECI Quotation', {\n//  refresh: function(frm) {\n//         console.log(\"Acceptance letter\");\n\n      \n//         var proposalnumber = sessionStorage.getItem('proposalnumber');\n//         var Schedulenumber = sessionStorage.getItem('Schedulenumber');\n\n//         console.log(proposalnumber, \"retrieved from sessionStorage\");\n\n//         if (proposalnumber && Schedulenumber) {\n            \n//             frm.set_value('proposal_no', proposalnumber);\n//             frm.set_value('policy_no', Schedulenumber);\n//             console.log(proposalnumber, \"set to the to field\");\n            \n//               frm.toggle_enable('proposal_no', false);\n//               frm.toggle_enable('policy_no', false);\n//         } else {\n//             console.log(\"Not found in sessionStorage\");\n//         }\n//     }\n\n refresh: function(frm) {\n        // Fetch postal address from Company-Details based on `to` field\n        var Name = frm.doc.client;\n\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Company-Details',\n                filters: {\n                    name1: Name\n                },\n                fields: ['postal_address'],\n                limit_page_length: 1\n            },\n            callback: function(response) {\n                console.log(\"API Response Company-Details:\", response); // Log the response for debugging\n\n                if (response && response.message && response.message.length > 0) {\n                    var companyDetailsData = response.message[0];\n                    frm.set_value('address', companyDetailsData.postal_address);\n                } else {\n                    frappe.msgprint('No matching record found in Company-Details for ' + Name);\n                }\n            },\n            error: function(err) {\n                console.error('Error fetching data from Company-Details:', err);\n                frappe.msgprint('An error occurred while fetching data from Company-Details.');\n            }\n        });\n    }\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Covering Letter Policy Approvals",
  "enabled": 0,
  "modified": "2025-11-06 10:23:22.404657",
  "module": null,
  "name": "Covering Letter Policy Approvals script",
  "script": "frappe.ui.form.on('Covering Letter Policy Approvals', {\r\n    onload_post_render(frm) {\r\n        let name1 = frm.doc.client_name;\r\n\r\n        // if (!name1) {\r\n        //     frappe.msgprint(\"Client name is empty.\");\r\n        //     return;\r\n        // }\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Company-Details',\r\n                filters: {\r\n                    'name1': name1\r\n                },\r\n                fields: ['postal_address', 'location'],\r\n                limit: 1\r\n            },\r\n            callback: function(res) {\r\n                if (res.message && res.message.length > 0) {\r\n                    let data = res.message[0];\r\n\r\n                    if (frm.doc.postal_address !== data.postal_address) {\r\n                        frm.set_value('data2', data.postal_address);\r\n                    }\r\n\r\n                    if (frm.doc.location !== data.location) {\r\n                        frm.set_value('data3', data.location);\r\n                    }\r\n                } else {\r\n                    frappe.msgprint(\"No matching Company Details found for: \" + name1);\r\n                }\r\n            }\r\n        });\r\n    }\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n/*frappe.ui.form.on('Covering letter_CIGIS', {\r\n    refresh(frm) {\r\n        // Get the value of name1 field\r\n        var name1 = frm.doc.name1;\r\n\r\n        // Fetch Company Details document where attention_mr matches name1\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Company-Details',\r\n                filters: {\r\n                    'attention_mr': name1\r\n                },\r\n                fields: ['postal_address'],\r\n                limit: 1 // Limit to fetch only one document\r\n            },\r\n            callback: function(response) {\r\n                if (response.message && response.message.length > 0) {\r\n                    // Set the postal_address field in Covering letter_CIGIS document\r\n                    frm.set_value('postal_address', response.message[0].postal_address);\r\n                } else {\r\n                    // Handle case where no matching Company Details document is found\r\n                    frappe.msgprint(\"No matching Company Details found for attention_mr: \" + name1);\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error(err);\r\n                frappe.msgprint('An error occurred while fetching Company Details.');\r\n            }\r\n        });\r\n    }\r\n});\r\n*/",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Policy Document Policy Approvals",
  "enabled": 1,
  "modified": "2025-11-06 10:27:23.943935",
  "module": null,
  "name": "Policy Document Policy Approvals script",
  "script": "frappe.ui.form.on('Policy Document Policy Approvals', {\r\n    onload_post_render(frm) {\r\n        let name1 = frm.doc.client_name;\r\n\r\n        // if (!name1) {\r\n        //     frappe.msgprint(\"Client name is empty.\");\r\n        //     return;\r\n        // }\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Company-Details',\r\n                filters: {\r\n                    'name1': name1\r\n                },\r\n                fields: ['postal_address'],//, 'location'],\r\n                limit: 1\r\n            },\r\n            callback: function(res) {\r\n                if (res.message && res.message.length > 0) {\r\n                    let data = res.message[0];\r\n\r\n                    if (frm.doc.postal_address !== data.postal_address) {\r\n                        frm.set_value('of', data.postal_address);\r\n                    }\r\n\r\n                    // if (frm.doc.location !== data.location) {\r\n                    //     frm.set_value('data3', data.location);\r\n                    // }\r\n                } else {\r\n                    frappe.msgprint(\"No matching Company Details found for: \" + name1);\r\n                }\r\n            }\r\n        });\r\n    }\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n/*frappe.ui.form.on('Covering letter_CIGIS', {\r\n    refresh(frm) {\r\n        // Get the value of name1 field\r\n        var name1 = frm.doc.name1;\r\n\r\n        // Fetch Company Details document where attention_mr matches name1\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Company-Details',\r\n                filters: {\r\n                    'attention_mr': name1\r\n                },\r\n                fields: ['postal_address'],\r\n                limit: 1 // Limit to fetch only one document\r\n            },\r\n            callback: function(response) {\r\n                if (response.message && response.message.length > 0) {\r\n                    // Set the postal_address field in Covering letter_CIGIS document\r\n                    frm.set_value('postal_address', response.message[0].postal_address);\r\n                } else {\r\n                    // Handle case where no matching Company Details document is found\r\n                    frappe.msgprint(\"No matching Company Details found for attention_mr: \" + name1);\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error(err);\r\n                frappe.msgprint('An error occurred while fetching Company Details.');\r\n            }\r\n        });\r\n    }\r\n});\r\n*/",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Cover Letter DCI",
  "enabled": 0,
  "modified": "2025-11-06 10:58:44.461951",
  "module": null,
  "name": "Cover Letter DCI",
  "script": "frappe.ui.form.on('Cover Letter DCI', {\n\t    onload: function(frm) {\n\n        if (!frm.doc.our_ref) {\n            frappe.msgprint(\"Our Ref is missing. Cannot fetch data.\");\n            return;\n        }\n\n        // \u2705 Fetch data from DCI Proposals\n        frappe.call({\n            method: \"frappe.client.get_value\",\n            args: {\n                doctype: \"DCI Proposals\",\n                filters: { proposal_no: frm.doc.our_ref },\n                fieldname: [\"signed_by\"]\n            },\n            callback: function(r) {\n                console.log(\"DCI Proposals Response:\", r);\n\n                if (!r.exc && r.message) {\n                    if (r.message.postal_address) {\n                        frm.set_value(\"address\", r.message.postal_address);\n                    }\n                    if (r.message.signed_by) {\n                        frm.set_value(\"attention\", r.message.signed_by);\n                    }\n                    frm.refresh_fields([\"address\", \"attention\"]);\n                } else {\n                    frappe.msgprint(\"No matching record found for Proposal No: \" + frm.doc.our_ref);\n                }\n            }\n        });\n    }\n\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Credit Limit Processing",
  "enabled": 0,
  "modified": "2025-11-06 12:33:03.207038",
  "module": null,
  "name": "Credit Limit Processing New Script",
  "script": "frappe.ui.form.on('Credit Limit Processing', {\r\n    refresh: function(frm) {\r\n        \r\n    \r\n       frm.fields_dict.credit_limit.$input.css(\"text-align\", \"right\");\r\n       frm.fields_dict.overdue_amount.$input.css(\"text-align\", \"right\");\r\n       frm.fields_dict.outstanding_amount.$input.css(\"text-align\", \"right\");\r\n       frm.fields_dict.total_exposure.$input.css(\"text-align\", \"right\");\r\n       frm.fields_dict.recommended_exposure.$input.css(\"text-align\", \"right\");\r\n       frm.fields_dict.approved_amount.$input.css(\"text-align\", \"right\");\r\n      \r\n      \r\n       \r\n      var workflowState = frm.doc.workflow_state;\r\n \r\n        // Create a custom button for \"Print Proposal\" if the workflow state is \"Submitted\"\r\n        if (workflowState === \"Approved\") {\r\n            frm.add_custom_button(__('Print Annexure'), function() {\r\n                frappe.new_doc('Credit Limit  Annexure')\r\n                    frappe.route_options = {\r\n                    capture_date: frm.doc.capture_date,\r\n                    policy_holder_name: frm.doc.policy_holder_name,\r\n                    policy_no:frm.doc.policy_no,\r\n                    credit_limit_no: frm.doc.credit_limit_no,\r\n                    buyer_name:frm.doc.buyer_name,\r\n                    trading__style: frm.doc.trading__style,\r\n                    location: frm.doc.location,\r\n                    credit_limit: frm.doc.approved_amount,\r\n                    terms_of_payments: frm.doc.terms_of_payments,\r\n                    days_from:frm.doc.days_from,\r\n                    conditions: frm.doc.conditions,\r\n                    buyer_id: frm.doc.buyer_id\r\n                }\r\n                console.log(\"Print Proposal clicked!\");\r\n            }).addClass(\"btn-primary\");\r\n        }\r\n        frm.fields_dict.financial_analysis.$input.addClass('btn-primary');\r\n        frm.fields_dict.director_share_holder_exposure.$input.addClass('btn-primary');\r\n        if (frm.doc.yes) {\r\n        if (workflowState === \"Pending\" || workflowState === \"Approved\") {\r\n            frm.add_custom_button(__('View CB Report'), function() {\r\n            frappe.call({\r\n             method: \"frappe.client.get\",\r\n            args: {\r\n            doctype: \"CB Report\",\r\n            filters: {\r\n                buyer: frm.doc.buyer_name,\r\n                refnumber: frm.doc.credit_limit_no,\r\n            },\r\n            fields: [\"cb_request_number\", \"reqdate\", \"buyer\", \"refnumber\", \"date\", \"catagory\", \"code\", \"details\", \"description\"]\r\n        },\r\n        callback: function (r) {\r\n            if (!r.exc) {\r\n                var cbReportData = r.message;\r\n                if (cbReportData) {\r\n                    // Open prompt dialog only if data is found\r\n                    frappe.prompt([\r\n                        {'fieldname': 'credit_bureau_request', 'fieldtype': 'Heading', 'label': 'Credit Bureau Request'},\r\n                        {'fieldname': 'section_break_2','fieldtype': 'Section Break','label': ''},\r\n                        {'fieldname': 'cb_request_number', 'fieldtype': 'Data', 'label': 'CB Req Number', 'default': cbReportData.cb_request_number},\r\n                        {'fieldname': 'reqdate', 'fieldtype': 'Date', 'label': 'Req.Date', 'default': cbReportData.reqdate},\r\n                        {'fieldname': 'buyer', 'fieldtype': 'Data', 'label': 'Buyer', 'default': cbReportData.buyer},\r\n                        {'fieldname': 'column_break_1','fieldtype': 'Column Break','label': ''},\r\n                        {'fieldname': 'refnumber', 'fieldtype': 'Data', 'label': 'Ref.Number','default': cbReportData.refnumber},\r\n                        {'fieldname': 'section_break_3','fieldtype': 'Section Break','label': ''},\r\n                        {'fieldname': 'section_break_4','fieldtype': 'Section Break','label': ''},\r\n                        {'fieldname': 'credit_bureau_responce', 'fieldtype': 'Heading', 'label': 'Credit Bureau Response'},\r\n                        {'fieldname': 'section_break_5','fieldtype': 'Section Break','label': ''},\r\n                        {'fieldname': 'date', 'fieldtype': 'Date', 'label': 'Date', 'default': cbReportData.date},\r\n                        {'fieldname': 'catagory', 'fieldtype': 'Data', 'label': 'Category', 'default': cbReportData.catagory},\r\n                        {'fieldname': 'code', 'fieldtype': 'Data', 'label': 'Code',  'default': cbReportData.code},\r\n                        {'fieldname': 'column_break_2','fieldtype': 'Column Break','label': ''},\r\n                        {'fieldname': 'details', 'fieldtype': 'Data', 'label': 'Details',  'default': cbReportData.details},\r\n                        {'fieldname': 'description', 'fieldtype': 'Small Text', 'label': 'Description', 'default': cbReportData.description},\r\n                    ], function(values){\r\n                        // Handle user input if needed\r\n                    }, 'CB Report');\r\n                } else {\r\n                     frappe.msgprint(\"No CB Report data found for the selected buyer and credit limit number.\");\r\n                     //frappe.msgprint(\"CB Report is not Available for this Buyer\");\r\n \r\n                }\r\n            } else {\r\n                console.error(\"Error occurred while fetching CB Report data:\", r.exc);\r\n                 frappe.msgprint(\"Error occurred while fetching CB Report data. Please try again.\");\r\n            }\r\n        }\r\n    });   \r\n \r\n \r\n            }).addClass(\"btn-primary\");\r\n        }\r\n         }\r\n \r\n              \r\n        if(frm.doc.yes){\r\n        if (workflowState === \"Pending\" || workflowState === \"Approved\") {\r\n            frm.toggle_display('cbreport', true);\r\n            frm.toggle_display('report', false);\r\n            frm.toggle_display('cb_request', false);\r\n            // frm.toggle_display('table', false);\r\n \r\n        }\r\n        }\r\n \r\n         if (workflowState === \"Approved\") {\r\n            frm.toggle_display('policy_number', true);\r\n            frm.toggle_display('policy_no', false);\r\n            \r\n            frm.toggle_display('credit_number', true);\r\n            frm.toggle_display('credit_limit_no', false); \r\n\r\n        }\r\n \r\n    \r\n    },\r\nonload: function(frm){\r\n\r\n  frappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Credit Limits Application',\r\n        filters: {\r\n            workflow_state: 'Approved'\r\n        },\r\n        fields: ['policy_number'],\r\n        limit_page_length: 10000000\r\n    },\r\n    callback: function(applicationRes) {\r\n        let applicationPolicies = [];\r\n\r\n        if (applicationRes.message) {\r\n            applicationPolicies = applicationRes.message.map(item => item.policy_number);\r\n            console.log(\"\u2705 Approved Policies from Application:\", applicationPolicies);\r\n        }\r\n\r\n        // Now get approved policies from Credit Limit Processing\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Credit Limit Processing',\r\n                filters: {\r\n                    workflow_state: 'Approved'\r\n                },\r\n                fields: ['policy_no'],\r\n                limit_page_length: 0\r\n            },\r\n            callback: function(processingRes) {\r\n                let processingPolicies = [];\r\n\r\n                if (processingRes.message) {\r\n                    processingPolicies = processingRes.message.map(item => item.policy_no);\r\n                    console.log(\"\u2705 Approved Policies from Processing:\", processingPolicies);\r\n                }\r\n\r\n                // Combine and remove duplicates using Set\r\n                let combinedPolicies = [...new Set([...applicationPolicies, ...processingPolicies])];\r\n                console.log(\"\u2705 Final Unique Policy Numbers:\", combinedPolicies);\r\n\r\n                // Set to dropdown\r\n                frm.set_df_property('policy_no', 'options', combinedPolicies.join('\\n'));\r\n                frm.refresh_field('policy_no');\r\n            }\r\n        });\r\n    }\r\n});\r\n\r\n\r\n\r\n \r\n \r\n\r\n    },\r\n\r\n \tpolicy_no: function(frm) {\r\n \t    var policyNo = frm.doc.policy_no;\r\n \r\n    // Set the value of policy_number field\r\n    frm.set_value('policy_number', policyNo);\r\n        if (frm.doc.policy_no) {\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Credit Limits Application',\r\n                    filters: {\r\n                        policy_number: policyNo\r\n                    },\r\n                    fields: ['credit_limit_no'],\r\n                    limit_page_length: 0\r\n                },\r\n                 callback: function(response) {\r\n                    if (response.message) {\r\n                        // Get all credit_limit_no values (including duplicates)\r\n                        let creditLimitList = response.message.map(item => item.credit_limit_no);\r\n                        frm.set_df_property('credit_limit_no', 'options', creditLimitList.join('\\n'));\r\n                    }\r\n                }\r\n            });\r\n        } else {\r\n            // Clear credit_limit_no options if policy_no is cleared\r\n            frm.set_df_property('credit_limit_no', 'options', '');\r\n        }\r\n    },\r\n    \r\n  credit_limit_no: function(frm) {\r\n    var creditlimitNo = frm.doc.credit_limit_no;\r\n \r\n    // Set the value of policy_number field\r\n    frm.set_value('credit_number', creditlimitNo);\r\n if (frm.doc.credit_limit_no) {\r\n    // Fetch data from DCI Proposals based on selected policy_no\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Credit Limits Application',\r\n            filters: {\r\n                credit_limit_no: creditlimitNo\r\n            },\r\n            fields: ['policy_holder_name', 'inception_date', 'buyer', 'estd_date', 'no_of_employees', 'policy_type', 'trading_style', 'limit_required']\r\n        },\r\n        callback: function(response) {\r\n            if (response.message && response.message.length > 0) {\r\n                var data_from_proposals = response.message[0];\r\n                // Populate fields if data is found\r\n                frm.set_value('policy_holder_name', data_from_proposals.policy_holder_name || '');\r\n                frm.set_value('capture_date', data_from_proposals.inception_date || '');\r\n               // frm.set_value('credit_limit_no', data_from_proposals.credit_limit_no || '');\r\n                frm.set_value('buyer_name', data_from_proposals.buyer || '');\r\n                frm.set_value('estd_date', data_from_proposals.estd_date || '');\r\n                frm.set_value('noof_employees', data_from_proposals.no_of_employees || '');\r\n                frm.set_value('policy_type', data_from_proposals.policy_type || '');\r\n                frm.set_value('trading__style', data_from_proposals.trading_style || '');\r\n                 frm.set_value('credit_limit', data_from_proposals.limit_required || '');\r\n \r\n            } else {\r\n                // Clear fields if no matching record found\r\n                frm.set_value('policy_holder_name', '');\r\n                frm.set_value('capture_date', '');\r\n               // frm.set_value('credit_limit_no', '');\r\n                frm.set_value('buyer_name', '');\r\n                frm.set_value('estd_date', '');\r\n                frm.set_value('noof_employees', '');\r\n                frm.set_value('policy_type', '');\r\n                frm.set_value('trading__style', '');\r\n                frm.set_value('credit_limit', '');\r\n                frappe.msgprint('No matching record found in DCI Proposals.');\r\n            }\r\n        },\r\n        error: function(err) {\r\n            console.error(err);\r\n            frappe.msgprint('An error occurred while fetching data from DCI Proposals. Please check the console for details.');\r\n        }\r\n    });\r\n }\r\n \r\n},\r\ncb_request: function(frm) {\r\n        frappe.new_doc('CB Request'); \r\n          frappe.route_options = {\r\n             buyer: frm.doc.buyer_name,\r\n             refnumber: frm.doc.credit_limit_no,\r\n             policy_type: frm.doc.policy_type,\r\n            }; \r\n},\r\n\t buyer_name: function(frm) {\r\n    var buyer_name = frm.doc.buyer_name; // Get the value of buyer_name from the form\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Buyer',\r\n            filters: {\r\n                buyer_name: buyer_name // Use the buyer_name variable here\r\n            },\r\n            fields: ['buyer_name', 'buyer_id']\r\n        },\r\n        callback: function(r) {\r\n            console.log(r, 'finance');\r\n            if (r.message && r.message.length > 0) {\r\n                // Assuming only one buyer is expected in the response\r\n                frm.set_value('buyer_id', r.message[0].buyer_id);\r\n            } else {\r\n                // Handle case when no buyer is found with the given name\r\n                frm.set_value('buyer_id', '');\r\n            }\r\n        }\r\n    });\r\n},\r\ndirector_share_holder_exposure: function(frm) {\r\n\r\n    // Open Director and Shareholder Exposure directly\r\n    frappe.new_doc('Director and Shareholder Exposure');\r\n    frappe.route_options = {\r\n        buyer_name: frm.doc.buyer_name\r\n    };\r\n \r\n    // Add a hook to hide fields after the document is created\r\n    frappe.ui.form.on('Director and Shareholder Exposure', {\r\n        onload: function(frm) {\r\n            // Hide the specific fields and search button\r\n            frm.toggle_display('director_shareholder', false);\r\n            frm.toggle_display('search',false);\r\n            // Replace 'director_shareholder_field' with the actual field name you want to hide\r\n            frm.page.btn_primary.hide(); // Hides the primary button, typically the save button\r\n \r\n            // To hide the search button specifically, you might need to use jQuery or direct DOM manipulation\r\n            // Assuming the search button has a class or ID you can select\r\n            $('.search-btn-class').hide();// Replace with the actual class or ID selector for the search button\r\n        }\r\n    });\r\n},\r\n\r\n\r\n \r\n    \r\n    financial_analysis: async function(frm) {\r\n      \r\n\r\n        // Check if a Financial Analysis record exists for this buyer\r\n        const existing = await frappe.db.exists('Financial Analysis', { buyer: frm.doc.buyer });\r\n\r\n        if (existing) {\r\n            // If exists, open that record\r\n            frappe.set_route('Form', 'Financial Analysis', existing);\r\n        } else {\r\n            // If not, create a new Financial Analysis record with the same buyer\r\n            frappe.new_doc('Financial Analysis', {\r\n                buyer: frm.doc.buyer\r\n            });\r\n        }\r\n    }\r\n});\r\n\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Policy Quotation ECI Quotation",
  "enabled": 1,
  "modified": "2025-11-07 08:32:01.022032",
  "module": null,
  "name": "Policy Quotation ECI Quotation script",
  "script": "frappe.ui.form.on('Policy Quotation ECI Quotation', {\n\n refresh: function(frm) {\n        // Fetch postal address from Company-Details based on `to` field\n        var Name = frm.doc.to;\n\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Company-Details',\n                filters: {\n                    name1: Name\n                },\n                fields: ['postal_address'],\n                limit_page_length: 1\n            },\n            callback: function(response) {\n                console.log(\"API Response Company-Details:\", response); // Log the response for debugging\n\n                if (response && response.message && response.message.length > 0) {\n                    var companyDetailsData = response.message[0];\n                    frm.set_value('of', companyDetailsData.postal_address);\n                } else {\n                    frappe.msgprint('No matching record found in Company-Details for ' + Name);\n                }\n            },\n            error: function(err) {\n                console.error('Error fetching data from Company-Details:', err);\n                frappe.msgprint('An error occurred while fetching data from Company-Details.');\n            }\n        });\n    }\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Single Buyer CL Processing",
  "enabled": 1,
  "modified": "2025-12-05 08:24:08.851294",
  "module": "UnderWriting1",
  "name": "single buyer cl proceesing",
  "script": "frappe.ui.form.on('Single Buyer CL Processing', {\r\n     refresh: function (frm) {\r\n\r\n        // \u2705 Always use correct case-sensitive variable\r\n        const workflowState = frm.doc.workflow_state;\r\n\r\n        // \u2705 Populate dropdown (Approved CL Applications)\r\n        frappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Single Buyer CL Application',\r\n        filters: { workflow_state: 'Approved' },\r\n        fields: ['client1'],\r\n        limit_page_length: 0\r\n    },\r\n    callback: function (response) {\r\n        if (response.message && response.message.length > 0) {\r\n\r\n            // Extract all values\r\n            let options = response.message.map(row => row.client1);\r\n\r\n            // \u2705 Remove duplicates\r\n            let unique_options = [...new Set(options)];\r\n            \r\n            unique_options.sort();\r\n\r\n            // Set unique dropdown values\r\n            frm.set_df_property('name1', 'options', unique_options);\r\n\r\n        } else {\r\n            frm.set_df_property('name1', 'options', []);\r\n        }\r\n    }\r\n});\r\n\r\n\r\n        // \u2705 Clear existing custom buttons to avoid duplicates\r\n        frm.clear_custom_buttons();\r\n\r\n        // \u2705 Print Annexure Button \u2014 only visible when Approved\r\n        if (workflowState === \"Approved\") {\r\n            frm.add_custom_button(__('Print Annexure'), function () {\r\n                frappe.route_options = {\r\n                    date: frm.doc.capture_date,\r\n                    name1: frm.doc.policy_holder_name,\r\n                    cl_check_no: frm.doc.policy_no,\r\n                    buyer_name: frm.doc.buyer_name,\r\n                    location: frm.doc.location,\r\n                    credit_limit_required: frm.doc.approved_amount,\r\n                    terms_of_payments: frm.doc.terms_of_payments,\r\n                    days_from: frm.doc.days_from,\r\n                    conditions: frm.doc.conditions,\r\n                    buyer: frm.doc.buyer_id\r\n                };\r\n                frappe.new_doc('Credit Limit  Annexure');\r\n                console.log(\"\u2705 Print Annexure clicked!\");\r\n            }).addClass(\"btn-primary\");\r\n        }\r\n\r\n        // \u2705 View CB Report \u2014 when \u201cyes\u201d is checked and workflow is Pending or Approved\r\n if (frm.doc.yes == 1 && (workflowState === \"Pending\" || workflowState === \"Approved\")) {\r\n        frm.add_custom_button(__('View CB Report'), function () {\r\n            frappe.call({\r\n                method: \"frappe.client.get_list\",\r\n                args: {\r\n                    doctype: \"CB Report\",\r\n                    filters: {\r\n                        buyer: frm.doc.buyer_name,\r\n                        refnumber: frm.doc.credit_limit_no\r\n                    },\r\n                    fields: [\r\n                        \"cb_request_number\", \"reqdate\", \"buyer\", \"refnumber\",\r\n                        \"date\", \"catagory\", \"code\", \"details\", \"description\"\r\n                    ],\r\n                    limit: 1\r\n                },\r\n                callback: function (r) {\r\n                    if (r.message && r.message.length > 0) {\r\n                        var cbReportData = r.message[0];\r\n                        frappe.prompt([\r\n                            { fieldname: 'credit_bureau_request', fieldtype: 'Heading', label: 'Credit Bureau Request' },\r\n                            { fieldname: 'cb_request_number', fieldtype: 'Data', label: 'CB Req Number', default: cbReportData.cb_request_number },\r\n                            { fieldname: 'reqdate', fieldtype: 'Date', label: 'Req. Date', default: cbReportData.reqdate },\r\n                            { fieldname: 'buyer', fieldtype: 'Data', label: 'Buyer', default: cbReportData.buyer },\r\n                            { fieldname: 'refnumber', fieldtype: 'Data', label: 'Ref. Number', default: cbReportData.refnumber },\r\n                            { fieldname: 'credit_bureau_response', fieldtype: 'Heading', label: 'Credit Bureau Response' },\r\n                            { fieldname: 'date', fieldtype: 'Date', label: 'Date', default: cbReportData.date },\r\n                            { fieldname: 'catagory', fieldtype: 'Data', label: 'Category', default: cbReportData.catagory },\r\n                            { fieldname: 'code', fieldtype: 'Data', label: 'Code', default: cbReportData.code },\r\n                            { fieldname: 'details', fieldtype: 'Data', label: 'Details', default: cbReportData.details },\r\n                            { fieldname: 'description', fieldtype: 'Small Text', label: 'Description', default: cbReportData.description }\r\n                        ], null, 'CB Report');\r\n                    } else {\r\n                        frappe.msgprint(`CB Report not found for Buyer <b>${frm.doc.buyer_name}</b> and cl_check_no <b>${frm.doc.cl_check_no}</b>.`);\r\n                    }\r\n                }\r\n            });\r\n        }).addClass(\"btn-primary\");\r\n    }\r\n\r\n        // \u2705 Control field visibility\r\n        frm.set_df_property('cb_report', 'hidden', !frm.doc.yes);\r\n        frm.set_df_property('requesting', 'hidden', !frm.doc.yes);\r\n        frm.set_df_property('cb_request', 'hidden', !frm.doc.yes);\r\n        frm.set_df_property('notrequired', 'hidden', !frm.doc.no);\r\n        frm.set_df_property('cbreport', 'hidden', !frm.doc.no);\r\n\r\n        // \u2705 Optional styling if you use button fields\r\n        if (frm.fields_dict && frm.fields_dict.financial_analysis)\r\n            frm.fields_dict.financial_analysis.$input.addClass('btn-primary');\r\n        if (frm.fields_dict && frm.fields_dict.director_share_holder_exposure)\r\n            frm.fields_dict.director_share_holder_exposure.$input.addClass('btn-primary');\r\n    },\r\n    \r\n    // name1: function(frm) {\r\n    //     frappe.call({\r\n    //             method: 'frappe.client.get_list',\r\n    //             args: {\r\n    //                 doctype: 'Single Buyer CL Application',\r\n    //                 filters: {\r\n    //                     client1: name1     \r\n    //                     },\r\n    //                 fields: ['credit_limit_number'],\r\n    //                 limit_page_length: 0\r\n    //             },\r\n    //              callback: function(response) {\r\n    //                 if (response.message) {\r\n    //                     // Get all credit_limit_no values (including duplicates)\r\n    //                     let creditLimitList = response.message.map(item => item.credit_limit_number);\r\n    //                     frm.set_df_property('cl_check_no', 'options', creditLimitList.join('\\n'));\r\n    //                 }\r\n    //             }\r\n    //         });\r\n\r\n    // },\r\n\r\nname1: function(frm) {\r\n\r\n    let selected_name = frm.doc.name1;   // \u2705 get selected value\r\n\r\n    if (!selected_name) return;          // avoid empty calls\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Single Buyer CL Application',\r\n            filters: {\r\n                client1: selected_name    // \u2705 use selected value\r\n            },\r\n            fields: ['credit_limit_number'],\r\n            limit_page_length: 0\r\n        },\r\n        callback: function(response) {\r\n            if (response.message && response.message.length > 0) {\r\n\r\n                // Extract credit limit numbers\r\n                let creditLimitList = response.message.map(row => row.credit_limit_number);\r\n\r\n                // Remove duplicates (optional but recommended)\r\n                let uniqueList = [...new Set(creditLimitList)];\r\n\r\n                // Set dropdown options properly\r\n                frm.set_df_property('cl_check_no', 'options', uniqueList.join('\\n'));\r\n\r\n            } else {\r\n                frm.set_df_property('cl_check_no', 'options', '');\r\n            }\r\n        }\r\n    });\r\n\r\n},\r\n\r\n    // \u2705 When user selects CL Check No, auto-fetch data from CL Application\r\n    cl_check_no: function (frm) {\r\n        if (frm.doc.cl_check_no) {\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Single Buyer CL Application',\r\n                    filters: { credit_limit_number: frm.doc.cl_check_no },\r\n                    fields: ['client1', 'buyer', 'credit_limit_required', 'comment', 'cl_application_date'],\r\n                    limit_page_length: 1\r\n                },\r\n                callback: function (response) {\r\n                    if (response.message && response.message.length > 0) {\r\n                        let data = response.message[0];\r\n                        frm.set_value('name1', data.client1);\r\n                        frm.set_value('buyer_name', data.buyer);\r\n                        frm.set_value('credit_limit_required', data.credit_limit_required);\r\n                        frm.set_value('comment', data.comment);\r\n                        frm.set_value('date', data.cl_application_date);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    },\r\n\r\n    // \u2705 Yes Checkbox logic\r\n    yes: function (frm) {\r\n        if (frm.doc.yes) {\r\n            frm.set_value('no', 0);\r\n            frm.set_df_property('cb_report', 'hidden', 0);\r\n            frm.set_df_property('requesting', 'hidden', 0);\r\n            frm.set_df_property('cb_request', 'hidden', 0);\r\n            frm.set_df_property('notrequired', 'hidden', 1);\r\n            frm.set_df_property('cbreport', 'hidden', 1);\r\n        } else {\r\n            frm.set_df_property('cb_report', 'hidden', 1);\r\n            frm.set_df_property('requesting', 'hidden', 1);\r\n            frm.set_df_property('cb_request', 'hidden', 1);\r\n            frm.set_df_property('notrequired', 'hidden', 1);\r\n            frm.set_df_property('cbreport', 'hidden', 1);\r\n        }\r\n    },\r\n\r\n    // \u2705 No Checkbox logic\r\n    no: function (frm) {\r\n        if (frm.doc.no) {\r\n            frm.set_value('yes', 0);\r\n            frm.set_df_property('cb_report', 'hidden', 1);\r\n            frm.set_df_property('requesting', 'hidden', 1);\r\n            frm.set_df_property('cb_request', 'hidden', 1);\r\n            frm.set_df_property('notrequired', 'hidden', 0);\r\n            frm.set_df_property('cbreport', 'hidden', 0);\r\n        } else {\r\n            frm.set_df_property('notrequired', 'hidden', 1);\r\n            frm.set_df_property('cbreport', 'hidden', 1);\r\n        }\r\n    },\r\n\r\n    // \u2705 CB Request button\r\n    cb_request: function (frm) {\r\n        frappe.route_options = {\r\n            buyer: frm.doc.buyer_name,\r\n            refnumber: frm.doc.credit_limit_no,\r\n            policy_type: frm.doc.policy_type\r\n        };\r\n        frappe.new_doc('CB Request');\r\n    },\r\n\r\n    // \u2705 Go To Financial Analysis field/button\r\n    go_to_financial_analysis_: function (frm) {\r\n        frappe.db.get_value('Financial Analysis', { buyer_name: frm.doc.buyer_name }, 'name')\r\n            .then(r => {\r\n                if (r && r.message && r.message.name) {\r\n                    frappe.set_route('Form', 'Financial Analysis', r.message.name);\r\n                } else {\r\n                    frappe.new_doc('Financial Analysis', {\r\n                        buyer_name: frm.doc.buyer_name\r\n                    });\r\n                }\r\n            });\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Bond Facility Quotation",
  "enabled": 1,
  "modified": "2025-12-05 08:29:46.556484",
  "module": "",
  "name": "bondfacility new script",
  "script": "frappe.ui.form.on('Bond Facility Quotation', {\r\n    onload: function(frm) {\r\n        // Make created_date read-only for new documents\r\n        if (frm.doc.__islocal) {\r\n            frm.set_df_property('created_date', 'read_only', true);\r\n        }\r\n\r\n        // Fetch Bond Facility client names dynamically\r\n        frappe.call({\r\n            method: \"frappe.client.get_list\",\r\n            args: {\r\n                doctype: \"Bond Facility\",\r\n                fields: [\"client_name\"],\r\n                limit_page_length: 10000\r\n            },\r\n            callback: function(response) {\r\n                if (response.message) {\r\n                    const clientNames = response.message.map(row => row.client_name);\r\n                    \r\n                    clientNames.sort();\r\n                    frm.set_df_property('name1', 'options', [''].concat(clientNames));\r\n                }\r\n            }\r\n        });\r\n    },\r\n\r\n    name1: function(frm) {\r\n        if (frm.doc.name1) {\r\n            frappe.call({\r\n                method: 'frappe.client.get_value',\r\n                args: {\r\n                    doctype: 'Bond Facility',\r\n                    filters: { client_name: frm.doc.name1 },\r\n                    fieldname: ['facility_no', 'signed_on']\r\n                },\r\n                callback: function(r) {\r\n                    if (r.message) {\r\n                        frm.set_value('bond_facility_no', r.message.facility_no);\r\n                        // frm.set_value('quotation_date', r.message.signed_on);\r\n                    } else {\r\n                        frappe.msgprint('No Bond Facility found for this client.');\r\n                        frm.set_value('bond_facility_no', '');\r\n                        // frm.set_value('quotation_date', '');\r\n                    }\r\n                }\r\n            });\r\n        } else {\r\n            frm.set_value('bond_facility_no', '');\r\n            // frm.set_value('quotation_date', '');\r\n        }\r\n    },\r\n\r\n    refresh: function(frm) {\r\n        // Apply visibility logic\r\n        toggleFieldsBasedOnWorkflow(frm);\r\n\r\n        // Listen for workflow state change dynamically\r\n        if (frm.fields_dict.workflow_state && frm.fields_dict.workflow_state.$input) {\r\n            frm.fields_dict.workflow_state.$input.on('change', function() {\r\n                toggleFieldsBasedOnWorkflow(frm);\r\n            });\r\n        }\r\n\r\n        // Auto-generate quotation_no for new documents\r\n        if (frm.is_new() && !frm.doc.quotation_no) {\r\n            frappe.call({\r\n                method: \"frappe.client.get_list\",\r\n                args: {\r\n                    doctype: \"Bond Facility Quotation\",\r\n                    fields: [\"quotation_no\"],\r\n                    filters: { quotation_no: [\"like\", \"BQT/\" + new Date().getFullYear() + \"/%\"] },\r\n                    order_by: \"quotation_no desc\",\r\n                    limit_page_length: 1\r\n                },\r\n                callback: function(r) {\r\n                    const year = new Date().getFullYear();\r\n                    const prefix = \"BQT/\" + year + \"/\";\r\n                    let next_number = 1;\r\n\r\n                    if (r.message && r.message.length > 0) {\r\n                        const last_no = r.message[0].quotation_no;\r\n                        const last_num = parseInt(last_no.split(\"/\")[2]) || 0;\r\n                        next_number = last_num + 1;\r\n                    }\r\n\r\n                    frm.set_value(\"quotation_no\", prefix + String(next_number).padStart(4, \"0\"));\r\n                }\r\n            });\r\n        }\r\n        frm.fields_dict.bond_facility_limit1.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.bond_facility_limit2.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.bond_facility_limit3.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.bond_facility_limit4.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.net_bond_facility.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.c1.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.c2.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.c3.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.c4.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.c5.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.security_percentage_for_limit_1.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.security_percentage_for_limit_2.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.security_percentage_for_limit_3.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.security_percentage_for_limit_4.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.security_percentage_for_limit_5.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.guarantee_fee_percentage.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.min_fee_guarantee.$input.css(\"text-align\", \"right\");\r\n    },\r\n    c1: function(frm) {\r\n        var c1_value = frm.doc.c1;\r\n\r\n        if (c1_value > 0) {\r\n            // Add 1 to the c1 value and store in bond_facility_limit2\r\n            var bondFacilityLimit = c1_value + 1;\r\n            frm.set_value('bond_facility_limit2', bondFacilityLimit);\r\n        } else {\r\n            // If c1 is 0 or less, store 0 in bond_facility_limit2\r\n            frm.set_value('bond_facility_limit2', 0);\r\n        }\r\n    },\r\n   c2: function(frm) {\r\n        var c2_value = frm.doc.c2;  // Correctly fetch the value of c2\r\n\r\n        if (c2_value > 0) {\r\n            // Add 1 to the c2 value and store in bond_facility_limit3\r\n            var bondFacilityLimit1 = c2_value + 1;\r\n            frm.set_value('bond_facility_limit3', bondFacilityLimit1);\r\n        } else {\r\n            // If c2 is 0 or less, store 0 in bond_facility_limit3\r\n            frm.set_value('bond_facility_limit3', 0);\r\n        }\r\n    },\r\n    c3: function(frm) {\r\n        var c3_value = frm.doc.c3;  // Correctly fetch the value of c3\r\n\r\n        if (c3_value > 0) {\r\n            // Add 1 to the c3 value and store in bond_facility_limit4\r\n            var bondFacilityLimit2 = c3_value + 1;\r\n            frm.set_value('bond_facility_limit4', bondFacilityLimit2);\r\n        } else {\r\n            // If c3 is 0 or less, store 0 in bond_facility_limit4\r\n            frm.set_value('bond_facility_limit4', 0);\r\n        }\r\n    },\r\n    c4: function(frm) {\r\n        var c4_value = frm.doc.c4;  // Correctly fetch the value of c4\r\n\r\n        if (c4_value > 0) {\r\n            // Add 1 to the c4 value and store in net_bond_facility\r\n            var bondFacilityLimit3 = c4_value + 1;\r\n            frm.set_value('net_bond_facility', bondFacilityLimit3);\r\n        } else {\r\n            // If c4 is 0 or less, store 0 in net_bond_facility\r\n            frm.set_value('net_bond_facility', 0);\r\n        }\r\n    },\r\n});\r\n\r\n\r\n// \u2705 Field visibility logic\r\nfunction toggleFieldsBasedOnWorkflow(frm) {\r\n    const pendingOnlyFields = [\r\n        \"gmapprover_remark\",\r\n        \"quotation_authorized_by\",\r\n        \"send_to\",\r\n        \"send_to_recommendation\",\r\n        \"send_to_recomendation\",\r\n        \"include_marketing_as_mail_recipient\"\r\n    ];\r\n\r\n    // Get current workflow state safely\r\n    const state = (frm.doc.workflow_state || \"\").trim().toLowerCase();\r\n    console.log(\"Current workflow state:\", state);\r\n\r\n    // Hide all these fields first\r\n    pendingOnlyFields.forEach(f => {\r\n        frm.set_df_property(f, 'hidden', 1);\r\n    });\r\n\r\n    // Show them only when state is exactly \"pending\"\r\n    if (state === \"pending\") {\r\n        pendingOnlyFields.forEach(f => {\r\n            frm.set_df_property(f, 'hidden', 0);\r\n        });\r\n    }\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Policy Schedule Policy Approvals",
  "enabled": 1,
  "modified": "2025-11-19 09:24:24.996297",
  "module": null,
  "name": "Policy Schedule Policy Approvals script",
  "script": "frappe.ui.form.on('Policy Schedule Policy Approvals', {\n    refresh: function(frm) {\n\n fetchQuotationDetails(frm);\n\n        // --- Fetch Company Details ---\n        var insuredName = frm.doc.name_of_insured;\n        if (insuredName) {\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Company-Details',\n                    filters: { name1: insuredName },\n                    fields: ['postal_address'],\n                    limit_page_length: 1\n                },\n                callback: function(response) {\n                    if (response.message && response.message.length > 0) {\n                        var company = response.message[0];\n                        frm.set_value('address', company.postal_address || '');\n               \n                    } else {\n                        frappe.msgprint('No matching record found in Company-Details for ' + insuredName);\n                    }\n                },\n                error: function(err) {\n                    console.error('Error fetching Company-Details:', err);\n                    frappe.msgprint('Error fetching Company-Details. Check console.');\n                }\n            });\n        }\n\n    },\n\n})\n\nfunction fetchQuotationDetails(frm) {\n\n    if (!frm.doc.policy_type || !frm.doc.qno) {\n        return; // do nothing until both fields are filled\n    }\n\n    // Choose doctype dynamically\n    let doctype_name = frm.doc.policy_type === \"ECI\" \n        ? \"ECI Quotations\" \n        : \"DCI Quotation\";\n\n    frappe.call({\n        method: \"frappe.client.get\",\n        args: {\n            doctype: doctype_name,\n            filters: {\n                schedule_no: frm.doc.qno    // MATCH qno \u2192 schedule_no\n            }\n        },\n        callback: function(r) {\n\n            if (!r.message) {\n                frappe.msgprint(\"No quotation found for this Schedule No.\");\n                return;\n            }\n\n            let data = r.message;\n\n            // ------------------ ECI ------------------\n            if (frm.doc.policy_type === \"ECI\") {\n\n                frm.set_value(\"minimum_annual_premium\", data.min_premium_depositp);\n                frm.set_value(\"insured_percentage\", data.insured_commercial_risks_for_all_insured_companies);\n                frm.set_value(\"premium_rate\", data.premium_rate);\n            }\n\n            // ------------------ DCI ------------------\n            else if (frm.doc.policy_type === \"DCI\") {\n\n                frm.set_value(\"limit_of_discretion\", data.limit_of_discretion);\n                frm.set_value(\"deposit_premium\", data.premium_deposit);\n                frm.set_value(\"minimum_annual_premium\", data.min_annual_premium);\n                frm.set_value(\"premium_rate\", data.premium_rate);\n            }\n\n            frm.refresh_fields();\n        }\n    });\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "DeputySheriffBond",
  "enabled": 1,
  "modified": "2025-11-10 13:25:08.908619",
  "module": null,
  "name": "DeputySheriffBond Short Name Generation",
  "script": "frappe.ui.form.on('DeputySheriffBond', {\r\n    sheriffname: async function(frm) {\r\n        if (frm.doc.sheriffname) {\r\n            // Take first 4 letters of sheriffname and convert to uppercase\r\n            let prefix = frm.doc.sheriffname.substring(0, 4).toUpperCase();\r\n\r\n            // Fetch all existing shortnames starting with that prefix\r\n            let existing = await frappe.db.get_list('DeputySheriffBond', {\r\n                fields: ['shortname'],\r\n                filters: [['shortname', 'like', prefix + '%']],\r\n                limit: 1000\r\n            });\r\n\r\n            let maxNum = 0;\r\n\r\n            // Find the highest numeric suffix among existing shortnames\r\n            existing.forEach(e => {\r\n                let match = e.shortname.match(new RegExp(`^${prefix}(\\\\d+)$`));\r\n                if (match && match[1]) {\r\n                    let num = parseInt(match[1]);\r\n                    if (num > maxNum) maxNum = num;\r\n                }\r\n            });\r\n\r\n            // Generate next shortname (e.g., JHON1, JHON2...)\r\n            let newShortName = maxNum > 0 ? prefix + (maxNum + 1) : (existing.length > 0 ? prefix + \"1\" : prefix);\r\n\r\n            // Set the generated value in the shortname field\r\n            frm.set_value('shortname', newShortName);\r\n        } else {\r\n            // Clear shortname if sheriffname is empty\r\n            frm.set_value('shortname', '');\r\n        }\r\n    }\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n// frappe.ui.form.on('DeputySheriffBond', {\r\n//     sheriffname: async function(frm) {\r\n//         if (frm.doc.sheriffname) {\r\n//             // Take first 4 letters of sheriffname and convert to uppercase\r\n//             let generated_shortname = frm.doc.sheriffname.substring(0, 4).toUpperCase();\r\n\r\n//             // Check if this shortname already exists in the system\r\n//             let existing = await frappe.db.get_list('DeputySheriffBond', {\r\n//                 fields: ['shortname'],\r\n//                 filters: { shortname: generated_shortname },\r\n//                 limit: 1\r\n//             });\r\n\r\n//             // If a duplicate exists, add a random number to make it unique\r\n//             if (existing.length > 0) {\r\n//                 generated_shortname += Math.floor(Math.random() * 10);\r\n//             }\r\n\r\n//             // Set the generated value in the shortname field\r\n//             frm.set_value('shortname', generated_shortname);\r\n//         } else {\r\n//             // Clear shortname if sheriffname is empty\r\n//             frm.set_value('shortname', '');\r\n//         }\r\n//     }\r\n// });\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Schedule Goods and Services DCI",
  "enabled": 1,
  "modified": "2025-11-11 08:58:33.469273",
  "module": null,
  "name": "Schedule Goods and Services DCI script",
  "script": "frappe.ui.form.on('Schedule Goods and Services DCI', {\n refresh: function(frm) {\n        // Fetch postal address from Company-Details based on `to` field\n        var Name = frm.doc.name_of_insured;\n\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Company-Details',\n                filters: {\n                    name1: Name\n                },\n                fields: ['postal_address'],\n                limit_page_length: 1\n            },\n            callback: function(response) {\n                console.log(\"API Response Company-Details:\", response); // Log the response for debugging\n\n                if (response && response.message && response.message.length > 0) {\n                    var companyDetailsData = response.message[0];\n                    frm.set_value('address', companyDetailsData.postal_address);\n                } else {\n                    frappe.msgprint('No matching record found in Company-Details for ' + Name);\n                }\n            },\n            error: function(err) {\n                console.error('Error fetching data from Company-Details:', err);\n                frappe.msgprint('An error occurred while fetching data from Company-Details.');\n            }\n        });\n    },\n    \n       onload: function(frm) {\n        // Fetch data from Policy Approvals based on proposal number\n        var qNo = frm.doc.quotation_number;\n\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Policy Approvals',\n                filters: {\n                    quotation_numbers: qNo\n                },\n                fields: ['policy_number','payment_terms'],\n                limit_page_length: 1\n            },\n            callback: function(response) {\n                if (response && response.message && response.message.length > 0) {\n                    var policyApprovalData = response.message[0];\n                    \n                    frm.set_value('policy_no', policyApprovalData.policy_number);\n                    frm.set_value('maximum_terms_of_payment', policyApprovalData.payment_terms);\n                    \n                } else {\n                    frappe.msgprint('No matching record found in Policy Approvals.');\n                }\n            },\n            error: function(err) {\n                console.error('Error fetching data from Policy Approvals:', err);\n                frappe.msgprint('An error occurred while fetching data from Policy Approvals.');\n            }\n        });\n},\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Policy Reviews",
  "enabled": 1,
  "modified": "2025-12-05 08:19:11.889160",
  "module": null,
  "name": "PolRev",
  "script": "frappe.ui.form.on('Policy Reviews', {\r\n\r\n    refresh: function(frm) {\r\n        if (!frm.doc.pr_number) {\r\n            generateProposalNumber(frm);\r\n        }\r\n\r\n        if (frm.doc.__islocal) {\r\n            fetchAndFilterPolicyNumbers(frm);\r\n        }\r\n\r\n        frm.set_df_property('child_table', 'cannot_add_rows', true);\r\n        frm.fields_dict.add.$input.addClass('btn-primary');\r\n        frm.fields_dict.get_info.$input.addClass('btn-primary');\r\n\r\n        // Fetch country list\r\n//         frappe.call({\r\n//             method: 'frappe.client.get_list',\r\n//             args: {\r\n//                 doctype: 'Country Details',\r\n//                 fields: ['country'],\r\n//                 limit_page_length: 100\r\n//             },\r\n// callback: function(response) {\r\n//                 let DataArray = response.message;\r\n//                 let FinalArray = [];\r\n//                 for (let x of DataArray) {\r\n//                     FinalArray.push(x.country);\r\n//                 }\r\n//                 frm.set_df_property('country', 'options', FinalArray);\r\n//                 console.log(\"final\", FinalArray);\r\n//             },\r\n//             error: function(xhr, textStatus, errorThrown) {\r\n//                 console.error(\"Error fetching approved bonds:\", textStatus, errorThrown);\r\n//             }        });\r\n\r\n      // \u2705 Align all numeric fields to the right\r\nconst alignFields = [\r\n    'expected_insured_turnover1','actual_insured_turnover1','excess_shortfall1',\r\n    'claims_as_of_actual_premium1','total_cl_fee1','maximum_liability','commercial_liability',\r\n    'premium_rate','political_liability','cl_enquiry_fee','cl_per_month','no_of_cls','no_of_enquiry',\r\n    'insured','maximum_liability1','commercial_liability1','premium_rate1','political_liability1',\r\n    'cl_enquiry_fee1','cl_per_month1','no_of_cls1','no_of_enquiry1','insured1','maximum_liability2',\r\n    'commercial_liability2','premium_rate2','political_liability2','cl_enquiry_fee2','cl_per_month2',\r\n    'no_of_cls2','no_of_enquiry2','insured2','expected_insured_turnover','actual_insured_turnover',\r\n    'excess_shortfall','claims_as_of_actual_premium','total_cl_fee','expected_premium',\r\n    'actual_premium_charged','claims_provision','actual_claims','total_cl_enq_fee',\r\n    'expected_insured_turnover2','actual_insured_turnover2','excess_shortfall2',\r\n    'claims_as_of_actual_premium2','total_cl_fee2','expected_premium2','actual_premium_charged2',\r\n    'claims_provision2','actual_claims2','total_cl_enq_fee2','total_receipts','total_amount_of_claims',\r\n    'cost_of_credit_information','actual_profit_loss_on_policy','total_receipts1',\r\n    'total_amount_claims1','cost_of_credit_information1','actual_profit_loss_on_policy1',\r\n    'total_receipts2','total_amount_claims2','cost_of_credit_information2',\r\n    'actual_profit_loss_on_policy2','to_estimate_for_next_12_months','maximum_liabilityrev',\r\n    'commercial_liabilityrev','premium_raterev','political_liabilityrev','limit_of_discretion',\r\n    'first_limit_loss','cl_enquiry_fee3','cl_per_month3','insured3','franchise_loss',\r\n    'commercial_pre_rate','political_pre_rate','turnover','political_premium_amt','premium_rate_eci',\r\n    'commercial_premium_amt','total_pre_amtadd','expected_premium1','actual_premium_charged1',\r\n    'claims_provision1','actual_claims1','total_cl_enq_fee1'\r\n];\r\n\r\n// Loop and align right safely\r\nalignFields.forEach(f => {\r\n    if (frm.fields_dict[f] && frm.fields_dict[f].$input) {\r\n        frm.fields_dict[f].$input.css(\"text-align\", \"right\");\r\n    }\r\n});\r\n\r\n\r\n\r\nvar workflow_state = frm.doc.workflow_state || '';\r\n\r\n// Always keep original fields visible\r\nfrm.toggle_display('policy_no', true);\r\nfrm.toggle_display('policy_holder', true);\r\n\r\n// Make them read-only when approved\r\nif (workflow_state === \"Approved\") {\r\n    frm.set_df_property('policy_no', 'read_only', 1);\r\n    frm.set_df_property('policy_holder', 'read_only', 1);\r\n} else {\r\n    frm.set_df_property('policy_no', 'read_only', 0);\r\n    frm.set_df_property('policy_holder', 'read_only', 0);\r\n}\r\n\r\n \r\n    },\r\n\r\n    onload: function(frm) {\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Policy Approvals',\r\n                filters: { workflow_state: 'Accepted' },\r\n                fields: ['policy_holder', 'policy_number'],\r\n                limit_page_length: 200\r\n            },\r\n            callback: function(res) {\r\n                if (res.message) {\r\n                    let approved = res.message;\r\n                    console.log(\"Approved Policies:\", approved);\r\n\r\n                    // Get unique policy holders\r\n                    let uniqueHolders = [...new Set(approved.map(p => p.policy_holder))];\r\n                    uniqueHolders.sort();\r\n                    frm.set_df_property('policy_holder', 'options', uniqueHolders);\r\n\r\n\r\n                }\r\n            }\r\n        });\r\n    },\r\n\r\n    policy_holder: function(frm) {\r\n        if (!frm.doc.policy_holder) return;\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Policy Approvals',\r\n                filters: {\r\n                    policy_holder: frm.doc.policy_holder,\r\n                    workflow_state: 'Accepted'\r\n                },\r\n                fields: ['policy_number']\r\n            },\r\n            callback: function(res) {\r\n                if (res.message  && res.message.length > 0) {\r\n                   let policyNos = res.message.map(p => p.policy_number);\r\n                   frm.set_df_property('policy_no', 'options', policyNos);\r\n                }\r\n            }\r\n        });\r\n    },\r\n\r\n    policy_no: function(frm) {\r\n        // Clear previous values\r\n        frm.set_value('policy_type', '');\r\n        frm.set_value('inception_date', '');\r\n        frm.set_value('policy_expiry_date', '');\r\n\r\n        let selectedPolicyNo = frm.doc.policy_no;\r\n        let selectedHolder = frm.doc.policy_holder;\r\n\r\n        if (selectedPolicyNo && selectedHolder) {\r\n            console.log(\"Checking approval status for:\", selectedPolicyNo);\r\n\r\n            // Check if this policy is already approved for this holder\r\n            frappe.call({\r\n                method: 'frappe.client.get_value',\r\n                args: {\r\n                    doctype: 'Policy Approvals',\r\n                    filters: {\r\n                        policy_number: selectedPolicyNo,\r\n                        policy_holder: selectedHolder,\r\n                        workflow_state: 'Accepted'\r\n                    },\r\n                    fieldname: ['policy_type', 'inception_date']\r\n                },\r\n                callback: function(r) {\r\n                    console.log(\"Response from Policy Approvals:\", r);\r\n                    if (!r.exc && r.message) {\r\n                        //frappe.msgprint(__('Policy No already approved for this holder.'));\r\n                        frm.set_value('policy_type', r.message.policy_type || '');\r\n                        frm.set_value('inception_date', r.message.inception_date || '');\r\n\r\n                        // Calculate expiry date (1 year after inception)\r\n                        if (r.message.inception_date) {\r\n                            let inceptionDate = new Date(r.message.inception_date);\r\n                            let expiryDate = new Date(inceptionDate);\r\n                            expiryDate.setFullYear(expiryDate.getFullYear() + 1);\r\n                            frm.set_value('policy_expiry_date', frappe.datetime.str_to_user(expiryDate));\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n        }\r\n\r\n        \r\n    },\r\n    \r\n    \r\n    \r\n    \r\n        add_new: function(frm) {\r\n    // // List of country names\r\n    // var country_names = [\r\n    //     'Afghanistan', 'Albania', 'Algeria', 'Andorra', 'Angola', 'Antigua and Barbuda', 'Argentina', 'Armenia', 'Australia', 'Austria',\r\n    //     'Azerbaijan', 'Bahamas', 'Bahrain', 'Bangladesh', 'Barbados', 'Belarus', 'Belgium', 'Belize', 'Benin', 'Bhutan', 'Bolivia',\r\n    //     'Bosnia and Herzegovina', 'Botswana', 'Brazil', 'Brunei', 'Bulgaria', 'Burkina Faso', 'Burundi', 'Cabo Verde', 'Cambodia',\r\n    //     'Cameroon', 'Canada', 'Central African Republic', 'Chad', 'Chile', 'China', 'Colombia', 'Comoros', 'Congo (Congo-Brazzaville)',\r\n    //     'Costa Rica', 'Croatia', 'Cuba', 'Cyprus', 'Czechia (Czech Republic)', 'Democratic Republic of the Congo', 'Denmark', 'Djibouti',\r\n    //     'Dominica', 'Dominican Republic', 'Ecuador', 'Egypt', 'El Salvador', 'Equatorial Guinea', 'Eritrea', 'Estonia', 'Eswatini (fmr. \"Swaziland\")',\r\n    //     'Ethiopia', 'Fiji', 'Finland', 'France', 'Gabon', 'Gambia', 'Georgia', 'Germany', 'Ghana', 'Greece', 'Grenada', 'Guatemala', 'Guinea',\r\n    //     'Guinea-Bissau', 'Guyana', 'Haiti', 'Holy See', 'Honduras', 'Hungary', 'Iceland', 'India', 'Indonesia', 'Iran', 'Iraq', 'Ireland',\r\n    //     'Israel', 'Italy', 'Jamaica', 'Japan', 'Jordan', 'Kazakhstan', 'Kenya', 'Kiribati', 'Kuwait', 'Kyrgyzstan', 'Laos', 'Latvia', 'Lebanon',\r\n    //     'Lesotho', 'Liberia', 'Libya', 'Liechtenstein', 'Lithuania', 'Luxembourg', 'Madagascar', 'Malawi', 'Malaysia', 'Maldives', 'Mali', 'Malta',\r\n    //     'Marshall Islands', 'Mauritania', 'Mauritius', 'Mexico', 'Micronesia', 'Moldova', 'Monaco', 'Mongolia', 'Montenegro', 'Morocco', 'Mozambique',\r\n    //     'Myanmar (formerly Burma)', 'Namibia', 'Nauru', 'Nepal', 'Netherlands', 'New Zealand', 'Nicaragua', 'Niger', 'Nigeria', 'North Korea', 'North Macedonia (formerly Macedonia)',\r\n    //     'Norway', 'Oman', 'Pakistan', 'Palau', 'Palestine State', 'Panama', 'Papua New Guinea', 'Paraguay', 'Peru', 'Philippines', 'Poland', 'Portugal',\r\n    //     'Qatar', 'Romania', 'Russia', 'Rwanda', 'Saint Kitts and Nevis', 'Saint Lucia', 'Saint Vincent and the Grenadines', 'Samoa', 'San Marino',\r\n    //     'Sao Tome and Principe', 'Saudi Arabia', 'Senegal', 'Serbia', 'Seychelles', 'Sierra Leone', 'Singapore', 'Slovakia', 'Slovenia', 'Solomon Islands',\r\n    //     'Somalia', 'South Africa', 'South Korea', 'South Sudan', 'Spain', 'Sri Lanka', 'Sudan', 'Suriname', 'Sweden', 'Switzerland', 'Syria', 'Tajikistan',\r\n    //     'Tanzania', 'Thailand', 'Timor-Leste', 'Togo', 'Tonga', 'Trinidad and Tobago', 'Tunisia', 'Turkey', 'Turkmenistan', 'Tuvalu', 'Uganda', 'Ukraine',\r\n    //     'United Arab Emirates', 'United Kingdom', 'United States of America', 'Uruguay', 'Uzbekistan', 'Vanuatu', 'Venezuela', 'Vietnam', 'Yemen', 'Zambia', 'Zimbabwe'\r\n    // ];\r\n\r\n    // Display a prompt to enter field values with country options\r\n    frappe.prompt([\r\n        { \r\n    label: 'Country', \r\n    fieldname: 'country', \r\n    fieldtype: 'Link', \r\n    options: 'Country Details', \r\n    reqd: 1 \r\n},\r\n        { label: 'Terms Of Payment', fieldname: 'terms_of_paymentan', fieldtype: 'Select', options: '1-3m\\n1-mLC\\n4-6m\\n4-6mLC\\ncad\\ncadLC\\nTT7d', reqd: 1 },\r\n        { label: 'Commercial Pre Rate (%)', fieldname: 'commercial_pre_ratean', fieldtype: 'Currency', reqd: 1 },\r\n        { label: 'Political Pre Rate (%)', fieldname: 'political_pre_ratean', fieldtype: 'Currency', reqd: 1 },\r\n        { label: 'Premium Rate (%)', fieldname: 'premium_ratean', fieldtype: 'Currency', default: 0 }, // Include premium_ratean field\r\n\r\n        { label: '', fieldname: '', fieldtype: 'Column Break' },\r\n\r\n        { label: 'Commercial Premium Amount', fieldname: 'commercial_premium_amountan', fieldtype: 'Currency' },\r\n        { label: 'Political Premium Amount', fieldname: 'political_premium_amountan', fieldtype: 'Currency' },\r\n        { label: 'Total Premium Amount', fieldname: 'total_pre_amountan', fieldtype: 'Currency' },\r\n\r\n        { label: 'Buyer type', fieldname: 'buyer_type', fieldtype: 'Select', options: 'ASSOCIATED COMPANIES\\nGOVERNMENT BUYERS\\nPRIVATE BUYERS', reqd: 1 },\r\n        { label: 'Turnover', fieldname: 'turnover', fieldtype: 'Currency', reqd: 1 }\r\n    ], function(values) {\r\n        // Calculate premium_ratean based on commercial_pre_ratean and political_pre_ratean\r\n        const premium_ratean = parseFloat(values.commercial_pre_ratean) + parseFloat(values.political_pre_ratean);\r\n        \r\n        // Set premium_ratean value in the prompt\r\n        values.premium_ratean = premium_ratean;\r\n\r\n        // Validate all required fields\r\n        const requiredFields = ['country', 'terms_of_paymentan', 'commercial_pre_ratean', 'political_pre_ratean', 'buyer_type', 'turnover'];\r\n        const missingFields = requiredFields.filter(field => !values[field]);\r\n\r\n        if (missingFields.length > 0) {\r\n            const errorMessage = `Please fill out all required fields: ${missingFields.join(', ')}`;\r\n            frappe.msgprint(errorMessage); // Show error message\r\n            return;\r\n        }\r\n\r\n        // Calculate commercial_premium_amountan and political_premium_amountan\r\n        const commercial_premium_amountan = parseFloat(values.turnover) * (parseFloat(values.commercial_pre_ratean) / 100);\r\n        const political_premium_amountan = parseFloat(values.turnover) * (parseFloat(values.political_pre_ratean) / 100);\r\n\r\n        // Calculate total_pre_amountan based on turnover and premium_ratean\r\n        const total_pre_amountan = parseFloat(values.turnover) * (premium_ratean / 100);\r\n\r\n        // Proceed with adding a new row to the child table\r\n        var new_row = frappe.model.add_child(frm.doc, 'Policy Reviews Child', 'child_table');\r\n        new_row.country = values.country;\r\n        new_row.terms_of_payment = values.terms_of_paymentan;\r\n        new_row.comm_pre_rate = values.commercial_pre_ratean;\r\n        new_row.political_pre_rate = values.political_pre_ratean;\r\n        new_row.pre_rate = premium_ratean;\r\n       \r\n\r\n        // Refresh the child table\r\n        frm.refresh_field('child_table');\r\n    }, 'Enter Policy Details');\r\n},\r\n\r\n    \r\n    \r\n    \r\n    \r\n\r\n    // ----------------------\r\n    // \ud83d\udd39 Get Info Button\r\n    // ----------------------\r\nget_info: function(frm) {\r\n    // \ud83e\udde9 Validation: Ensure period_from and period_to are filled\r\n    if (!frm.doc.period_from || !frm.doc.period_to) {\r\n        frappe.msgprint({\r\n            title: __('Missing Dates'),\r\n            indicator: 'red',\r\n            message: __('\u26a0\ufe0f Please enter both <b>Period From</b> and <b>Period To</b> before clicking <b>Get Info</b>.')\r\n        });\r\n        return; // stop execution if missing\r\n    }\r\n\r\n    const type = frm.doc.policy_type, holder = frm.doc.policy_holder;\r\n\r\n    // Display logic\r\n    if (type === 'DCI') {\r\n        frm.toggle_display(['commercial_liability','child_table','add','add_new','premium_rate_eci','commercial_premium_amt','country','terms_of_payment','commercial_pre_rate','buyer_type','political_pre_rate','turnover','political_premium_amt','total_pre_amt','political_liabilityrev','commercial_liabilityrev','political_liability','commercial_liability1','political_liability1','commercial_liability2','political_liability2']);\r\n    } else if (type === 'ECI') {\r\n        frm.toggle_display(['maximum_liability','premium_raterev','maximum_liabilityrev','premium_rate','maximum_liability1','premium_rate1','maximum_liability2','premium_rate2']);\r\n    }\r\n\r\n    // Fetch data\r\n    if (type === 'DCI') {\r\n        frappe.call({\r\n            method: 'frappe.client.get',\r\n            args: {\r\n                doctype: 'DCI Quotation',\r\n                filters: { 'name': frm.doc.dci_quotation, 'client_name': holder },\r\n                fieldname: ['maximum_liability','insured_turnover','expected_premium_income','expected_insured_turnover','limit_of_discretion','franchise_loss','premium_rate','fee_per_enquiry','fee_for_cl_per_month']\r\n            },\r\n            callback: function(r) {\r\n                const q = r.message;\r\n                if (q) {\r\n                    frm.set_value('maximum_liability', q.maximum_liability);\r\n                    frm.set_value('premium_rate', q.premium_rate);\r\n                    frm.set_value('insured', q.insured_turnover);\r\n                    frm.set_value('cl_enquiry_fee', q.fee_per_enquiry);\r\n                    frm.set_value('cl_per_month', q.fee_for_cl_per_month);\r\n                    // frm.set_value('expected_premium', q.expected_premium_income);\r\n                    // frm.set_value('expected_insured_turnover', q.expected_insured_turnover);\r\n                    frm.set_value('premium_raterev', q.premium_rate);\r\n                    frm.set_value('maximum_liabilityrev', q.maximum_liability);\r\n                    calculate_eci_values(frm);\r\n                }\r\n            }\r\n        });\r\n    } else if (type === 'ECI') {\r\n        frappe.call({\r\n            method: 'frappe.client.get',\r\n            args: {\r\n                doctype: 'ECI Quotations',\r\n                filters: { 'name': frm.doc.eci_quotation, 'client_name': holder },\r\n                fieldname: ['premium_rate','insured_commercial_risks_for_all_insured_companies','individual_first_lossp','limit_of_descrition','franchise_lossp','commercial','political','cl_per_monthp','per_enquiryp']\r\n            },\r\n            callback: function(r) {\r\n                const q = r.message;\r\n                if (q) {\r\n                    frm.set_value('commercial_liability', q.commercial);\r\n                    frm.set_value('political_liability', q.political);\r\n                    frm.set_value('cl_enquiry_fee', q.per_enquiryp);\r\n                    frm.set_value('cl_per_month', q.cl_per_monthp);\r\n                    frm.set_value('franchise_loss', q.franchise_lossp);\r\n                    frm.set_value('first_limit_loss', q.individual_first_lossp);\r\n                    frm.set_value('limit_of_discretion', q.limit_of_descrition);\r\n                    frm.set_value('insured3', q.insured_commercial_risks_for_all_insured_companies);\r\n                    calculate_eci_values(frm);\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    // \u2705 Set Period Under Review\r\n    if (frm.doc.period_from && frm.doc.period_to) {\r\n        frm.set_value('period_under_review', `${frappe.datetime.str_to_user(frm.doc.period_from)} to ${frappe.datetime.str_to_user(frm.doc.period_to)}`);\r\n    }\r\n},\r\n\r\n    add: function(frm) {\r\n        policychild(frm);\r\n    }\r\n});\r\n\r\n// --------------------------------\r\n// \ud83d\udd39 Helper Functions\r\n// --------------------------------\r\n\r\n// --- ECI Calculation Logic ---\r\nfunction calculate_eci_values(frm) {\r\n    try {\r\n        const val = v => flt(v || 0);\r\n\r\n        let e_no_of_cl = val(frm.doc.no_of_cls);\r\n        let e_no_of_enquiry = val(frm.doc.no_of_enquiry);\r\n        let e_cl_per_month = val(frm.doc.cl_per_month);\r\n        let e_cl_enq_fee = val(frm.doc.cl_enquiry_fee);\r\n        let e_prem_dep = val(frm.doc.expected_premium);\r\n        let e_actual_turnover = val(frm.doc.actual_insured_turnover);\r\n        let e_expected_turnover = val(frm.doc.expected_insured_turnover);\r\n        let e_claims = val(frm.doc.actual_claims);\r\n        let e_claims_prov = val(frm.doc.claims_provision);\r\n        let e_claims_recovery = val(frm.doc.claims_recovery);\r\n\r\n        // ---- Calculations ----\r\n        let e_no_of_cl_fee = e_no_of_cl * e_cl_per_month;\r\n        let e_no_of_enq_fee = e_no_of_enquiry * e_cl_enq_fee;\r\n        let e_shortfall = e_expected_turnover - e_actual_turnover;\r\n        let e_claim_per = e_prem_dep > 0 ? ((e_claims / e_prem_dep) * 100).toFixed(2) : 0;\r\n        let e_total_reci = e_prem_dep + e_no_of_enq_fee + e_no_of_cl_fee;\r\n        let e_total_clms = e_claims + e_claims_prov + e_claims_recovery;\r\n        let e_profit = e_total_reci - e_total_clms - e_no_of_enq_fee;\r\n\r\n        // ---- Set values ----\r\n        // frm.set_value('total_cl_fee', e_no_of_cl_fee);\r\n        // frm.set_value('total_cl_enq_fee', e_no_of_enq_fee);\r\n        // frm.set_value('excess_shortfall', e_shortfall);\r\n        // frm.set_value('claims_as_of_actual_premium', e_claim_per);\r\n        // frm.set_value('total_receipts', e_total_reci);\r\n        // frm.set_value('total_amount_of_claims', e_total_clms);\r\n        // frm.set_value('actual_profit_loss_on_policy', e_profit);\r\n\r\n        // \u2705 Show correct message based on policy type\r\n        const policyType = frm.doc.policy_type || '';\r\n        if (policyType === 'DCI') {\r\n            frappe.msgprint('\u2705 DCI calculations completed successfully.');\r\n        } else if (policyType === 'ECI') {\r\n            frappe.msgprint('\u2705 ECI calculations completed successfully.');\r\n        } else {\r\n            frappe.msgprint('\u2705 Calculations completed successfully.');\r\n        }\r\n\r\n    } catch (err) {\r\n        frappe.msgprint('\u26a0\ufe0f Error in calculation: ' + err.message);\r\n    }\r\n}\r\n\r\n// --- PR Number ---\r\nfunction generateProposalNumber(frm) {\r\n    const year = new Date().getFullYear();\r\n    const prefix = `PRV/${year}/`;\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Policy Reviews',\r\n            fields: ['pr_number'],\r\n            order_by: 'creation desc',\r\n            limit: 1\r\n        },\r\n        callback: function(r) {\r\n            if (r.message && r.message.length > 0) {\r\n                let lastNum = parseInt(r.message[0].pr_number.split(\"/\").pop());\r\n                frm.set_value('pr_number', prefix + (isNaN(lastNum) ? '0001' : (lastNum + 1).toString().padStart(4, '0')));\r\n            } else frm.set_value('pr_number', prefix + '0001');\r\n        }\r\n    });\r\n}\r\n\r\n// --- Policy Number Filter ---\r\nfunction fetchAndFilterPolicyNumbers(frm) {\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Policy Reviews',\r\n            filters: { workflow_state: 'Approved' },\r\n            fields: ['policy_no']\r\n        },\r\n        callback: function(res) {\r\n            const approved = (res.message || []).map(r => r.policy_no);\r\n            const field = frm.fields_dict['policy_no'];\r\n            if (field && field.df.options)\r\n                field.df.options = field.df.options.filter(opt => !approved.includes(opt));\r\n        }\r\n    });\r\n}\r\n\r\n// --- Add Child Row ---\r\nfunction policychild(frm) {\r\n    const cr = flt(frm.doc.commercial_pre_rate);\r\n    const pr = flt(frm.doc.political_pre_rate);\r\n    const to = flt(frm.doc.turnover);\r\n\r\n    if (cr && pr && to) {\r\n        const rate = cr + pr;\r\n        const comm_amt = to * (cr / 100);\r\n        const pol_amt = to * (pr / 100);\r\n        const total = to * (rate / 100);\r\n\r\n        frm.set_value('premium_rate_eci', rate);\r\n        frm.set_value('commercial_premium_amt', comm_amt);\r\n        frm.set_value('political_premium_amt', pol_amt);\r\n        frm.set_value('total_pre_amtadd', total);\r\n\r\n        let row = frappe.model.add_child(frm.doc, 'Policy Reviews Child', 'child_table');\r\n        row.country = frm.doc.country;\r\n        row.terms_of_payment = frm.doc.terms_of_payment;\r\n        row.comm_pre_rate = cr;\r\n        row.political_pre_rate = pr;\r\n        row.pre_rate = rate;\r\n        row.total_pre_amt = total;\r\n        row.political_premium_amt = pol_amt;\r\n        row.commercial_premium_amt = comm_amt;\r\n\r\n        frm.refresh_field('child_table');\r\n    }\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Policy Quotation DCI",
  "enabled": 1,
  "modified": "2025-11-11 09:29:09.779844",
  "module": null,
  "name": "Policy Quotation DCI script",
  "script": "frappe.ui.form.on('Policy Quotation DCI', {\n refresh: function(frm) {\n        // Fetch postal address from Company-Details based on `to` field\n        var Name = frm.doc.to;\n\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Company-Details',\n                filters: {\n                    name1: Name\n                },\n                fields: ['postal_address'],\n                limit_page_length: 1\n            },\n            callback: function(response) {\n                console.log(\"API Response Company-Details:\", response); // Log the response for debugging\n\n                if (response && response.message && response.message.length > 0) {\n                    var companyDetailsData = response.message[0];\n                    frm.set_value('of', companyDetailsData.postal_address);\n                } else {\n                    frappe.msgprint('No matching record found in Company-Details for ' + Name);\n                }\n            },\n            error: function(err) {\n                console.error('Error fetching data from Company-Details:', err);\n                frappe.msgprint('An error occurred while fetching data from Company-Details.');\n            }\n        });\n    }\n\t\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Prepare Invoice",
  "enabled": 1,
  "modified": "2025-12-08 11:40:12.652755",
  "module": null,
  "name": "Prepare Invoice New Script",
  "script": "frappe.ui.form.on('Prepare Invoice', {\n//   refresh: function(frm) {\n\n//         // -----------------------------------------------------------\n//         // 1\ufe0f\u20e3 SUBMIT TO FINANCE BUTTON (Open existing OR create new)\n//         // -----------------------------------------------------------\n//         if (!frm.is_new()) {\n\n//             frm.add_custom_button(__('Submit to Finance'), function () {\n\n//                 let ref_no = frm.doc.credsure_refno;\n\n//                 // First check if Bond Invoice already exists\n//                 frappe.call({\n//                     method: \"frappe.client.get_list\",\n//                     args: {\n//                         doctype: \"Bond Invoice\",\n//                         filters: {\n//                             bond_no: ref_no\n//                         },\n//                         fields: [\"name\"],\n//                         limit_page_length: 1\n//                     },\n//                     callback: function(res) {\n\n//                         if (res.message && res.message.length > 0) {\n\n//                             // \u2714 Existing Bond Invoice found \u2192 open it\n//                             frappe.set_route(\"Form\", \"Bond Invoice\", res.message[0].name);\n\n//                         } else {\n\n//                             // \u2714 Create NEW Bond Invoice\n//                             frappe.route_options = {\n//                                 bond_no: frm.doc.credsure_refno,\n//                                 guarantee_amount: frm.doc.guarantee_amount,\n//                                 period_from: frm.doc.bond_period_from,\n//                                 month: frm.doc.month,\n//                                 reinsurer: frm.doc.reinsure,\n//                                 reinsurer_refnumber: frm.doc.reinsurer_refnumber,\n//                                 reinsurer1: frm.doc.reinsurer,\n//                                 broker1: frm.doc.broker, \n//                                 broker: frm.doc.brokers,\n//                                 total_due_without_vat: frm.doc.total_duewith_out_vat,\n//                                 to: frm.doc.bond_period_to,\n//                                 beci: frm.doc.credsure,\n//                                 premium_rate: frm.doc.guarantee_fee_rate,\n//                                 vat: frm.doc.vat,\n//                                 bond_invoice_no: frm.doc.reinsurer_refnumber,\n//                                 credsure_refno: frm.doc.portion_of_guarantee_amount_to_reinsurer,\n//                                 portion_of_guarantee_guarantee_vat_p: frm.doc.portion_of_guatrantee_fee_to_reinsurer,\n//                                 beci_portion_of_gurantee_amount_p: frm.doc.portion_of_guarantee_fee_to_credsure,\n//                                 total_due: frm.doc.total_due,\n//                                 vat_p: frm.doc.v_at,\n//                                 demand_date: frm.doc.bond_period_from,\n//                                 facility_name: frm.doc.client,\n//                                 bond_type: frm.doc.principal,\n//                                 bond_in_favour: frm.doc.bond_type,\n//                                 broker_commission__p: frm.doc.broker_commission,\n//                             };\n\n//                             frappe.new_doc(\"Bond Invoice\");\n//                         }\n//                     }\n//                 });\n\n//             }).addClass(\"btn-primary\");\n//         }\n\n//         // -----------------------------------------------------------\n//         // 2\ufe0f\u20e3 ALIGN FIELDS RIGHT\n//         // -----------------------------------------------------------\n//         let rightAlignFields = [\n//             \"guarantee_fee\",\n//             \"brokers\",\n//             \"reinsurer\",\n//             \"credsurecommission\",\n//             \"v_at\",\n//             \"guarantee_amount\",\n//             \"guarantee_fee_rate\",\n//             \"portion_of_guarantee_amount_to_reinsurer\",\n//             \"portion_of_guatrantee_fee_to_reinsurer\",\n//             \"credsure_commission\",\n//             \"total_due\",\n//             \"vat\",\n//             \"total_duewith_out_vat\",\n//             \"credsure\",\n//             \"portion_of_guarantee_amount_to_credsure\",\n//             \"portion_of_guarantee_fee_to_credsure\",\n//             \"broker_commission\"\n//         ];\n\n//         rightAlignFields.forEach(field => {\n//             if (frm.fields_dict[field]) {\n//                 frm.fields_dict[field].$input.css(\"text-align\", \"right\");\n//             }\n//         });\n\n\n//         // -----------------------------------------------------------\n//         // 3\ufe0f\u20e3 SHOW / HIDE SAVE BUTTON\n//         // -----------------------------------------------------------\n\n//         // NEW document \u2192 allow Save\n//         if (frm.is_new()) {\n//             frm.enable_save();\n//             setTimeout(() => {\n//                 frm.page.btn_primary.show();\n//             }, 50);\n//         }\n//         // EXISTING document \u2192 hide Save\n//         else {\n//             frm.disable_save();\n//             setTimeout(() => {\n//                 frm.page.btn_primary.hide();\n//                 $('button[data-label=\"Save\"]').hide();\n//             }, 50);\n//         }\n\n//     },\n\n    refresh: function (frm) {\n\n        // -----------------------------------------------------------\n        // 1\ufe0f\u20e3 SUBMIT TO FINANCE BUTTON\n        // -----------------------------------------------------------\n        if (!frm.is_new()) {\n\n            frm.add_custom_button(__('Submit to Finance'), function () {\n\n                let ref_no = frm.doc.credsure_refno;\n\n                // Step 1: Check if Bond Invoice already exists\n                frappe.call({\n                    method: \"frappe.client.get_list\",\n                    args: {\n                        doctype: \"Bond Invoice\",\n                        filters: { bond_no: ref_no },\n                        fields: [\"name\"],\n                        limit_page_length: 1\n                    },\n\n                    callback: function (res) {\n\n                        // \u2714 Case 1: Open existing Bond Invoice\n                        if (res.message && res.message.length > 0) {\n                            frappe.set_route(\"Form\", \"Bond Invoice\", res.message[0].name);\n                            return;\n                        }\n\n                        // \u2714 Case 2: Create NEW Bond Invoice using your route_options mapping\n                        frappe.route_options = {\n                            bond_no: frm.doc.credsure_refno,\n                            guarantee_amount: frm.doc.guarantee_amount,\n                            period_from: frm.doc.bond_period_from,\n                            month: frm.doc.month,\n                            reinsurer: frm.doc.reinsure,\n                            reinsurer_refnumber: frm.doc.reinsurer_refnumber,\n                            reinsurer1: frm.doc.reinsurer,\n                            broker1: frm.doc.broker,\n                            broker: frm.doc.brokers,\n                            total_due_without_vat: frm.doc.total_duewith_out_vat,\n                            to: frm.doc.bond_period_to,\n                            beci: frm.doc.credsure,\n                            premium_rate: frm.doc.guarantee_fee_rate,\n                            vat: frm.doc.vat,\n                            bond_invoice_no: frm.doc.reinsurer_refnumber,\n                            credsure_refno: frm.doc.portion_of_guarantee_amount_to_reinsurer,\n                            portion_of_guarantee_guarantee_vat_p: frm.doc.portion_of_guatrantee_fee_to_reinsurer,\n                            beci_portion_of_gurantee_amount_p: frm.doc.portion_of_guarantee_fee_to_credsure,\n                            total_due: frm.doc.total_due,\n                            vat_p: frm.doc.v_at,\n                            demand_date: frm.doc.bond_period_from,\n                            facility_name: frm.doc.client,\n                            bond_type: frm.doc.principal,\n                            bond_in_favour: frm.doc.bond_type,\n                            broker_commission__p: frm.doc.broker_commission,\n                        };\n\n                        frappe.new_doc(\"Bond Invoice\");\n                    }\n                });\n\n            }).addClass(\"btn-primary\");\n        }\n\n\n        // -----------------------------------------------------------\n        // 2\ufe0f\u20e3 ALIGN RIGHT FIELDS (unchanged logic)\n        // -----------------------------------------------------------\n        let rightAlignFields = [\n            \"guarantee_fee\",\n            \"brokers\",\n            \"reinsurer\",\n            \"credsurecommission\",\n            \"v_at\",\n            \"guarantee_amount\",\n            \"guarantee_fee_rate\",\n            \"portion_of_guarantee_amount_to_reinsurer\",\n            \"portion_of_guatrantee_fee_to_reinsurer\",\n            \"credsure_commission\",\n            \"total_due\",\n            \"vat\",\n            \"total_duewith_out_vat\",\n            \"credsure\",\n            \"portion_of_guarantee_amount_to_credsure\",\n            \"portion_of_guarantee_fee_to_credsure\",\n            \"broker_commission\"\n        ];\n\n        rightAlignFields.forEach(f => {\n            if (frm.fields_dict[f]) {\n                frm.fields_dict[f].$input.css(\"text-align\", \"right\");\n            }\n        });\n\n\n        // -----------------------------------------------------------\n        // 3\ufe0f\u20e3 SHOW / HIDE SAVE BUTTON (your logic preserved)\n        // -----------------------------------------------------------\n        if (frm.is_new()) {\n            frm.enable_save();\n            setTimeout(() => frm.page.btn_primary.show(), 60);\n        } else {\n            frm.disable_save();\n            setTimeout(() => {\n                frm.page.btn_primary.hide();\n                $('button[data-label=\"Save\"]').hide();\n            }, 60);\n        }\n    },\n\n\n    guarantee_fee: function(frm) {\n        calculate_broker_commission(frm);\n        calculate_portion_of_guarantee_fee_to_credsure(frm);\n        calculate_portion_of_guarantee_fee_to_reinsurer(frm);\n        calculateTotal_due(frm);\n       // calculate_vat(frm);\n    },\n    brokers: function(frm) {\n        calculate_broker_commission(frm);\n    },\n    credsurecommission: function(frm) {\n        calculate_portion_of_guarantee_fee_to_credsure(frm);\n    },\n    reinsurer: function(frm) {\n        calculate_portion_of_guarantee_fee_to_reinsurer(frm);\n        calculateECGpercentage(frm);\n        calculatePortionofGuaranteeamounttoreinsurer(frm);\n    },\n    guarantee_amount: function(frm) {\n        calculateportionofguaranteeamounttoECGC(frm);\n    },\n    credsure: function(frm) {\n        calculateportionofguaranteeamounttoECGC(frm); \n    },\n    total_duewith_out_vat: function(frm){\n       // calculateVat_p(frm);\n       // calculateTotal_due(frm);\n      //  calculate_vat(frm);\n    },\n    guarantee_fee_rate:function(frm){\n        calculate_vat(frm);\n    },\n    vat: function(frm){\n        calculateVat_p(frm);\n       // calculateTotal_due(frm);\n        calculate_vat(frm);\n        calculateTotal_due(frm);\n    },\n    v_at: function(frm) {\n       // calculateVat_p(frm);\n        //calculateTotal_due(frm); \n    },\n   back(frm) {   // Normal button\n\n        let brq_no = frm.doc.credsure_refno || frm.doc.bond_no;   // BRQ or bond_no\n\n        if (!brq_no) {\n            frappe.msgprint(\"BRQ/Bond Number not found.\");\n            return;\n        }\n\n        // 1\ufe0f\u20e3 Check in Renewals\n        frappe.call({\n            method: \"frappe.client.get_list\",\n            args: {\n                doctype: \"Renewals\",\n                filters: { extension_req_no: brq_no },\n                fields: [\"name\"],\n                limit: 1\n            },\n            callback(r1) {\n                if (r1.message && r1.message.length > 0) {\n                    frappe.set_route(\"Form\", \"Renewals\", r1.message[0].name);\n                    return;\n                }\n\n                // 2\ufe0f\u20e3 Check in Bond Extensions\n                frappe.call({\n                    method: \"frappe.client.get_list\",\n                    args: {\n                        doctype: \"Bond Extensions\",\n                        filters: { extension_req_no: brq_no },\n                        fields: [\"name\"],\n                        limit: 1\n                    },\n                    callback(r2) {\n                        if (r2.message && r2.message.length > 0) {\n                            frappe.set_route(\"Form\", \"Bond Extensions\", r2.message[0].name);\n                            return;\n                        }\n\n                        // 3\ufe0f\u20e3 Check in Deputy Sheriff Bond\n                        frappe.call({\n                            method: \"frappe.client.get_list\",\n                            args: {\n                                doctype: \"Deputy Sheriff Bond\",\n                                filters: { bond_no: brq_no },\n                                fields: [\"name\"],\n                                limit: 1\n                            },\n                            callback(r3) {\n                                if (r3.message && r3.message.length > 0) {\n                                    frappe.set_route(\"Form\", \"Deputy Sheriff Bond\", r3.message[0].name);\n                                } else {\n                                    frappe.msgprint(\"No matching Renewal, Bond Extension or Deputy Sheriff Bond record found.\");\n                                }\n                            }\n                        });\n\n                    }\n                });\n\n            }\n        });\n    }\n});\n \n// \ud83d\udd39 Helper for formatting to always show 2 decimals\nfunction formatTwoDecimals(value) {\n    return (parseFloat(value || 0)).toFixed(2);\n}\n \n// \u2705 Calculate Broker Commission\nfunction calculate_broker_commission(frm) {\n    let guaranteefee = frm.doc.guarantee_fee || 0;\n    let brokerrate = frm.doc.brokers || 0;\n    let brokercommission = guaranteefee * (brokerrate / 100);\n    frm.set_value('broker_commission', formatTwoDecimals(brokercommission));\n}\n \n// \u2705 Calculate Portion of Guarantee Fee to Credsure\nfunction calculate_portion_of_guarantee_fee_to_credsure(frm) {\n    let guaranteefee = frm.doc.guarantee_fee || 0;\n    let becipercent = frm.doc.credsure || 0;\n    let guaranteefeetoCredsure = (guaranteefee * becipercent / 100);\n    frm.set_value('portion_of_guarantee_fee_to_credsure', formatTwoDecimals(guaranteefeetoCredsure));\n}\n \n// \u2705 Calculate Portion of Guarantee Fee to Reinsurer\nfunction calculate_portion_of_guarantee_fee_to_reinsurer(frm) {\n    let guaranteefee = frm.doc.guarantee_fee || 0;\n    let reinsurerrate = frm.doc.reinsurer || 0;\n \n    let guaranteefeetoReinsurer = (guaranteefee * reinsurerrate / 100);\n    let ecgccommission = guaranteefeetoReinsurer * ((100 - reinsurerrate) / 100);\n \n    frm.set_value('portion_of_guatrantee_fee_to_reinsurer', formatTwoDecimals(guaranteefeetoReinsurer));\n    frm.set_value('credsurecommission', formatTwoDecimals(ecgccommission));\n}\n\n\nfunction calculateportionofguaranteeamounttoECGC(frm){\n    let portion_of_guarantee_amount = Number(frm.doc.guarantee_amount) || 0;\n    let ecgpercent = Number(frm.doc.credsure) || 0;\n\n    let portion_value = portion_of_guarantee_amount * (ecgpercent / 100);\n\n    // \ud83d\udc49 Format with commas directly here (Indian format)\n    let formatted_value = portion_value.toLocaleString('en-IN', {\n        minimumFractionDigits: 2,\n        maximumFractionDigits: 2\n    });\n\n    frm.set_value('portion_of_guarantee_amount_to_credsure', formatted_value);\n}\n\n \n// \u2705 Calculate Portion of Guarantee Amount to Reinsurer\nfunction calculatePortionofGuaranteeamounttoreinsurer(frm){\n    var guaranteeamount = frm.doc.guarantee_amount || 0;\n    var reinsurerrate = frm.doc.reinsurer || 0;\n    var portionofguaranteeamounttoreinsurer = (guaranteeamount * reinsurerrate / 100);\n    frm.set_value('portion_of_guarantee_amount_to_reinsurer', formatTwoDecimals(portionofguaranteeamounttoreinsurer));\n}\n \n// \u2705 Calculate ECG%\nfunction calculateECGpercentage(frm){\n    var reinsurerrate = frm.doc.reinsurer || 0;\n    var ecgpercentage = 100 - reinsurerrate;\n    frm.set_value('credsure', formatTwoDecimals(ecgpercentage));\n}\n \n// // \u2705 Calculate VAT\n// function calculateVat_p(frm) {\n//     var total_vat = frm.doc.total_duewith_out_vat || 0;\n//     var vat_rate = frm.doc.v_at || 0;\n//     var vat_total = total_vat * (vat_rate / 100);\n//     frm.set_value('vat', formatTwoDecimals(vat_total));\n// }\n \n// \u2705 Calculate Total Due\nfunction calculateTotal_due(frm) {\n    let guarantee_fee = Number(frm.doc.guarantee_fee) || 0;\n    let vat_p = Number(frm.doc.vat) || 0;\n\n    // Correct VAT calculation\n    let vat_amount = (guarantee_fee * vat_p) / 100;\n\n    // Total = guarantee fee + vat\n    let total = guarantee_fee + vat_amount;\n\n    // Set value with 2 decimals\n    frm.set_value('total_due', total.toFixed(2));\n}\n\n \n// function calculate_vat(frm) {\n//     let guarantee_fee_rate = Number(frm.doc.guarantee_fee_rate) || 0;\n//     let vat = Number(frm.doc.vat) || 0;\n\n//     let vat_amount = Math.round((guarantee_fee_rate * vat) / 100);\n\n//     // Ensure the field always shows at least 0\n//     frm.set_value('v_at', vat_amount || 0);\n// }\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Policy Approvals",
  "enabled": 1,
  "modified": "2025-12-09 07:31:21.793555",
  "module": "Marketing",
  "name": "Policy Approval Client Script",
  "script": "frappe.ui.form.on('Policy Approvals', {\nonload: function(frm) {\n        \n    \n\n    if (!frm.doc.policy_number) {\n            generateNumber(frm, 'policy_number');\n        }\n       \n    console.log(\"starting\");\n//old code\n//     frappe.call({\n//     method: 'frappe.client.get_list',\n//     args: {\n//         doctype: 'DCI Quotation',\n//         filters: {\n//             'workflow_state': 'Approved'\n//         },\n//         fields: ['schedule_no'],\n//         limit_page_length: 0  // Adjust this value as needed\n//     },\n//     callback: function(dci_response) {\n//         console.log(\"DCI schedule_no received:\", dci_response);\n\n//         if (dci_response.message) {\n//             let dciArray = dci_response.message.map(x => x.schedule_no);\n\n//             // Fetch ECI Quotations after getting DCI Quotation \n//             frappe.call({\n//                 method: 'frappe.client.get_list',\n//                 args: {\n//                     doctype: 'ECI Quotations',\n//                     filters: {\n//                         'workflow_state': 'Approved'\n//                     },\n//                     fields: ['schedule_no'],\n//                     limit_page_length: 0  // Adjust this value as needed\n//                 },\n//                 callback: function(eci_response) {\n//                     console.log(\"ECI schedule_no received:\", eci_response);\n\n//                     if (eci_response.message) {\n//                         let eciArray = eci_response.message.map(x => x.schedule_no);\n//                         let finalArray = dciArray.concat(eciArray);  // Combine both arrays\n//                         frm.set_df_property('quotation_numbers', 'options', finalArray);\n//                         console.log(\"final\", finalArray);\n//                     }\n//                 },\n//                 error: function(xhr, textStatus, errorThrown) {\n//                     console.error(\"Error fetching ECI Quotations:\", textStatus, errorThrown);\n//                 }\n//             });\n//         }\n//     },\n//     error: function(xhr, textStatus, errorThrown) {\n//         console.error(\"Error fetching DCI Quotation :\", textStatus, errorThrown);\n//     }\n// });\n\n//new code\n// frappe.call({\n//     method: 'frappe.client.get_list',\n//     args: {\n//         doctype: 'DCI Quotation',\n//         filters: {\n//             'workflow_state': 'Approved'\n//         },\n//         fields: ['schedule_no'],\n//         order_by: 'schedule_no desc',\n//         limit_page_length: 0\n//     },\n//     callback: function(dci_response) {\n//         console.log(\"DCI schedule_no received:\", dci_response);\n\n//         if (dci_response.message) {\n//             let dciArray = dci_response.message.map(x => x.schedule_no);\n\n//             frappe.call({\n//                 method: 'frappe.client.get_list',\n//                 args: {\n//                     doctype: 'ECI Quotations',\n//                     filters: {\n//                         'workflow_state': 'Approved'\n//                     },\n//                     fields: ['schedule_no'],\n//                     order_by: 'schedule_no desc',\n//                     limit_page_length: 0\n//                 },\n//                 callback: function(eci_response) {\n//                     console.log(\"ECI schedule_no received:\", eci_response);\n\n//                     if (eci_response.message) {\n//                         let eciArray = eci_response.message.map(x => x.schedule_no);\n\n//                         // Combine both\n//                         let finalArray = dciArray.concat(eciArray);\n\n//                         // Sort latest first\n//                         finalArray.sort((a, b) => {\n//                             // Descending order\n//                             return b.localeCompare(a);\n//                         });\n\n//                         frm.set_df_property('quotation_numbers', 'options', finalArray);\n//                         console.log(\"Sorted Final Array:\", finalArray);\n//                     }\n//                 },\n//                 error: function(xhr, textStatus, errorThrown) {\n//                     console.error(\"Error fetching DCI Quotation :\", textStatus, errorThrown);\n//                 }\n//             });\n//         }\n//     },\n//     error: function(xhr, textStatus, errorThrown) {\n//         console.error(\"Error fetching ECI Quotations :\", textStatus, errorThrown);\n//     }\n// });\n\n//both mixed numbers\nfrappe.call({\n    method: 'frappe.client.get_list',\n    args: {\n        doctype: 'DCI Quotation',\n        filters: {\n            'workflow_state': 'Approved'\n        },\n        fields: ['schedule_no'],\n        order_by: 'schedule_no desc',\n        limit_page_length: 0\n    },\n    callback: function(dci_response) {\n        console.log(\"DCI schedule_no received:\", dci_response);\n\n        if (dci_response.message) {\n            let dciArray = dci_response.message.map(x => x.schedule_no);\n\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'ECI Quotations',\n                    filters: {\n                        'workflow_state': 'Approved'\n                    },\n                    fields: ['schedule_no'],\n                    order_by: 'schedule_no desc',\n                    limit_page_length: 0\n                },\n                callback: function(eci_response) {\n                    console.log(\"ECI schedule_no received:\", eci_response);\n\n                    if (eci_response.message) {\n                        let eciArray = eci_response.message.map(x => x.schedule_no);\n\n                        // Combine DCI + ECI\n                        let finalArray = dciArray.concat(eciArray);\n\n                        // Perfect sorting: newest year + newest sequence\n                        finalArray.sort((a, b) => {\n                            // Extract YEAR \u2192 DCQT/2025/0015\n                            let yearA = parseInt(a.split('/')[1]);\n                            let yearB = parseInt(b.split('/')[1]);\n\n                            if (yearA !== yearB) {\n                                return yearB - yearA; // newest year first\n                            }\n\n                            // Extract SEQUENCE number\n                            let seqA = parseInt(a.split('/')[2]);\n                            let seqB = parseInt(b.split('/')[2]);\n\n                            return seqB - seqA; // newest sequence first\n                        });\n\n                        frm.set_df_property('quotation_numbers', 'options', finalArray);\n                        console.log(\"Final Sorted Array:\", finalArray);\n                    }\n                },\n                error: function(xhr, textStatus, errorThrown) {\n                    console.error(\"Error fetching ECI Quotations:\", textStatus, errorThrown);\n                }\n            });\n        }\n    },\n    error: function(xhr, textStatus, errorThrown) {\n        console.error(\"Error fetching DCI Quotations:\", textStatus, errorThrown);\n    }\n});\n\n\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n        doctype: 'Policy Approvals',\n        filters: {\n           //workflow_state: 'Approved',\n           workflow_state: 'Accpeted',\n           \n           \n            quotation_numbers: ['in', submittedDCIQuotations.concat(submittedECIQuotations)]\n          },\n        fields: ['quotation_numbers']\n        \n      \n       },\n       \n       callback: function(approvedPolicyApprovalsResponse) {\n        if (approvedPolicyApprovalsResponse.message) {\n            var approvedPolicyApprovals = approvedPolicyApprovalsResponse.message.map(function(policyApproval) {\n                return policyApproval.quotation_numbers;\n            });\n\n            console.log(\"** Approved Policy Approvals:\", approvedPolicyApprovals);\n\n            var filteredQuotations = submittedDCIQuotations.concat(submittedECIQuotations).filter(function(quotation) {\n                return !approvedPolicyApprovals.includes(quotation);\n            });\n\n            console.log(\"** Filtered Quotations:\", filteredQuotations);\n\n            frm.set_df_property('quotation_numbers', 'options', filteredQuotations);\n        }\n    }\n});\n\n    \n\n\n        \n        \n        // frappe.call({\n        //     method: 'frappe.client.get_list',\n        //     args: {\n        //         doctype: 'DCI Quotation',\n        //         filters: {\n        //             workflow_state: 'Approved'\n        //         },\n        //         fields: ['schedule_no'],\n        //         limit_page_length: 100\n        //     },\n        //     callback: function(submittedDCIQuotationsResponse) {\n        //         if (submittedDCIQuotationsResponse.message) {\n        //             var submittedDCIQuotations = submittedDCIQuotationsResponse.message.map(function(quotation) {\n        //                 return quotation.schedule_no;\n        //             });\n\n        //             console.log(\"** Submitted DCI Quotation:\", submittedDCIQuotations);\n\n        //             console.log(\"** Fetching Submitted ECI Quotations **\");\n\n        //             frappe.call({\n        //                 method: 'frappe.client.get_list',\n        //                 args: {\n        //                     doctype: 'ECI Quotations',\n        //                     filters: {\n        //                         workflow_state: 'Approved'\n        //                     },\n        //                     fields: ['schedule_no'],\n        //                     limit_page_length: 100\n        //                 },\n        //                 callback: function(submittedECIQuotationsResponse) {\n        //                     if (submittedECIQuotationsResponse.message) {\n        //                         var submittedECIQuotations = submittedECIQuotationsResponse.message.map(function(quotation) {\n        //                             return quotation.schedule_no;\n        //                         });\n\n        //                         console.log(\"** Submitted ECI Quotations:\", submittedECIQuotations);\n\n        //                         console.log(\"** Fetching Approved Policy Approvals **\");\n\n        //                         frappe.call({\n        //                             method: 'frappe.client.get_list',\n        //                             args: {\n        //                                 doctype: 'Policy Approvals',\n        //                                 filters: {\n        //                                     workflow_state: 'Approved',\n        //                                     quotation_numbers: ['in', submittedDCIQuotations.concat(submittedECIQuotations)]\n        //                                 },\n        //                                 fields: ['quotation_numbers']\n        //                             },\n        //                             callback: function(approvedPolicyApprovalsResponse) {\n        //                                 if (approvedPolicyApprovalsResponse.message) {\n        //                                     var approvedPolicyApprovals = approvedPolicyApprovalsResponse.message.map(function(policyApproval) {\n        //                                         return policyApproval.quotation_numbers;\n        //                                     });\n\n        //                                     console.log(\"** Approved Policy Approvals:\", approvedPolicyApprovals);\n\n        //                                     var filteredQuotations = submittedDCIQuotations.concat(submittedECIQuotations).filter(function(quotation) {\n        //                                         return !approvedPolicyApprovals.includes(quotation);\n        //                                     });\n\n        //                                     console.log(\"** Filtered Quotations:\", filteredQuotations);\n\n        //                                     frm.set_df_property('quotation_numbers', 'options', filteredQuotations);\n        //                                 }\n        //                             }\n        //                         });\n        //                     }\n        //                 }\n        //             });\n        //         }\n        //     }\n        // });\n\n    },\n\n    quotation_numbers: function(frm) {\n        frm.set_value('policy_holder', '');\n        frm.set_value('proposal_no', '');\n        frm.set_value('inception_date', '');\n        frm.set_value('premium_rate', '');\n        frm.set_value('status', '');\n        frm.set_value('premium', '');\n        frm.set_value('policy_type', '');\n        frm.set_value('goods_services', '');\n        frm.set_value('quotation_date', '');\n\n        let quotationNumber = frm.doc.quotation_numbers;\n\n        frm.toggle_enable('quotation_numbers', true);\n\n        if (quotationNumber.startsWith(\"DCQT\")) {\n            console.log(\"Fetching data from DCI Quotation...\");\n            frappe.call({\n                method: 'frappe.client.get_value',\n                args: {\n                    doctype: 'DCI Quotation',\n                    filters: {\n                        schedule_no: quotationNumber\n                    },\n                    fieldname: ['client_name', 'proposal_no2', 'inception_date', 'premium_rate', 'status11', 'expected_annual_premium','goods_services','captured_on']\n                },\n                callback: function(r) {\n                    if (!r.exc && r.message) {\n                        frm.set_value('policy_holder', r.message.client_name);\n                       // frm.set_value('proposal_no', r.message.proposal_no);\n                        frm.set_value('proposal_no', r.message.proposal_no2);\n                        frm.set_value('inception_date', r.message.inception_date);\n                        frm.set_value('premium_rate', r.message.premium_rate);\n                        frm.set_value('status', r.message.status11);\n                        frm.set_value('premium', r.message.expected_annual_premium);\n                        frm.set_value('goods_services', r.message.goods_services);\n                        frm.set_value('quotation_date', r.message.captured_on);\n                        frm.fields_dict.policy_type.set_value('DCI');\n\n                        // Generate policy number after setting policy holder\n                       generateNumber(frm, 'policy_number');\n                    } else {\n                        console.error(\"Error occurred while fetching data from DCI Quotation:\", r.exc);\n                    }\n                },\n            });\n        } else if (quotationNumber.startsWith(\"ECQT\")) {\n            console.log(\"Fetching data from ECI Quotations...\");\n            frappe.call({\n                method: 'frappe.client.get_value',\n                args: {\n                    doctype: 'ECI Quotations',\n                    filters: {\n                        schedule_no: quotationNumber\n                    },\n                    fieldname: ['client_name', 'proposal_no', 'inception_date','status1', 'amt','goods_services','captured_on']//,'premium_rate1']\n                },\n                callback: function(r) {\n                    if (!r.exc && r.message) {\n                        frm.set_value('policy_holder', r.message.client_name);\n                       // frm.set_value('proposal_no', r.message.proposal_no);\n                        frm.set_value('proposal_no', r.message.proposal_no);\n                        frm.set_value('inception_date', r.message.inception_date);\n                        frm.set_value('status', r.message.status1);\n                       // frm.set_value('premium_rate1', r.message.premium_rate1);\n                        frm.set_value('premium', r.message.amt);\n                        frm.set_value('goods_services', r.message.goods_services);\n                         frm.set_value('quotation_date', r.message.captured_on);\n                        frm.fields_dict.policy_type.set_value('ECI');\n\n                        // Generate policy number after setting policy holder\n                        generateNumber(frm, 'policy_number');\n                    } else {\n                        console.error(\"Error occurred while fetching data from ECI Quotations:\", r.exc);\n                    }\n                },\n            });\n        } else {\n            console.log(\"Unknown prefix:\", quotationNumber);\n        }\n    },\n\n    refresh: function(frm) {\n        \n        toggle_fields(frm);\n        frm.set_df_property('reinsurers','cannot_add_rows', true);\n      frm.fields_dict.add_reinsurers.$input.addClass('btn-primary');\n      frm.fields_dict.premium.$input.css(\"text-align\", \"right\");\n      frm.fields_dict.premium_rate.$input.css(\"text-align\", \"right\");\n       \n      \n\n       \n        $('.underlined').on('click', function(event) {\n            event.preventDefault();\n            var linkText = $(this).text().trim();\n            var workflowState = frm.doc.workflow_state;  // Assuming workflow_state is the field name in your form\n\n            // switch (linkText) {\n            //     case 'Covering Letter':\n            //         if (workflowState === 'Accepted' || workflowState === 'Rejected') {\n            //              createCoveringLetter(frm)\n            //             openDocument(frm, 'Covering Letter Policy Approvals');\n                       \n            //         } else {\n            //             frappe.msgprint(\"Acceptance is required to access the document.\");\n            //          }\n            //         break;\n                switch (linkText) {\n    case 'Covering Letter':\n        if (workflowState === 'Accepted' || workflowState === 'Rejected') {\n            createCoveringLetter(frm);\n        } else {\n            frappe.msgprint(\"Acceptance is required to access the document.\");\n        }\n        break;\n\n                case 'Policy Document':\n                    if (workflowState === 'Accepted' || workflowState === 'Rejected') {\n                        openDocument(frm, 'Policy Document Policy Approvals');\n                    } else {\n                        frappe.msgprint(\"Acceptance is required to access the document.\");\n                     }\n                    break;\n                    \n                case 'Policy Schedule':\n                    if (workflowState === 'Accepted' || workflowState === 'Rejected') {\n                        openDocument(frm, 'Policy Schedule Policy Approvals');\n                    } else {\n                        frappe.msgprint(\"Acceptance is required to access the document.\");\n                     }\n                    break;\n                    \n                case 'Policy Administration Guidelines':\n                    if (workflowState === 'Accepted' || workflowState === 'Rejected') {\n                        openDocument(frm, 'Policy Administration guidelines');\n                    } else {\n                        frappe.msgprint(\"Acceptance is required to access the document.\");\n                      }\n                    break;\n                    \n                case 'Credit Limit Application Forms':\n                    if (workflowState === 'Accepted' || workflowState === 'Rejected') {\n                        openDocument(frm, 'Credit Limit Application  Forms');\n                    } else {\n                      frappe.msgprint(\"Acceptance is required to access the document.\");\n                      }\n                    break;\n                    \n                default:\n                    console.log(\"No action defined for\", linkText);\n            }\n        });\n\n\n//  if (frm.doc.workflow_state === \"Approved\") {\nif (frm.doc.workflow_state === \"Accepted\") {\n            // Add the custom button\n            frm.add_custom_button(__('Proforma Invoice'), function() {\n                // Calculate the values needed\n                var percent14 = (14 / 100) * frm.doc.premium;\n                percent14 = Number(percent14.toFixed(2));\n                var data4 = (parseFloat(frm.doc.premium) + percent14).toFixed(2);\n\n                // Set route options for the new document\n                frappe.route_options = {\n                    invoice_to: frm.doc.policy_holder,\n                    policy_number: frm.doc.policy_number,\n                    quotation_numbers: frm.doc.quotation_numbers,\n                    data1: frm.doc.premium,\n                    data2: frm.doc.premium,\n                    data3: percent14,\n                    data4: data4\n                };\n\n                // Create a new Proforma Invoice document\n                 frappe.new_doc('Proforma Invoice');\n\n                console.log(\"Proforma Invoice button clicked!\");\n            }).addClass(\"btn-primary\");\n        } else {\n            // Optionally clear the button if needed\n            frm.page.clear_inner_btn_group();\n        }\n        \n        \n        \n    },\n    \n     policy_type: function(frm) {\n       toggle_fields(frm);\n    },\n    policy_holder: function(frm) {\n    frappe.call({\n    method: 'frappe.client.get_value',\n    args: {\n        doctype: 'Company-Details',\n        filters: { name1: frm.doc.policy_holder },\n        fieldname: 'bank'\n    },\n    callback: function(r) {\n        if (r && r.message) {\n            console.log(\"Fetched Bank:\", r.message.bank);\n            frm.set_value('bank', r.message.bank); // set to your target field\n        } else {\n          //  frappe.msgprint(\"No matching Company Details found for this Policy Holder.\");\n        }\n    }\n});\n    \n    },\n  add_reinsurers: function(frm) {\n    var reinsurer = frm.doc.reinsurer;\n    var reinsurer_per = Number(frm.doc.reinsurer_per1) || 0;\n\n    // \u274c Prevent empty entries\n    if (!reinsurer || reinsurer_per === 0) {\n        frappe.msgprint(\"Please enter reinsurer and percentage.\");\n        return;\n    }\n\n    // \u274c Prevent duplicate reinsurer\n    let exists = (frm.doc.reinsurers || []).some(row => row.reinsurers === reinsurer);\n\n    if (exists) {\n        frappe.msgprint(\"Reinsurer already exists. Please choose a different one.\");\n        frm.set_value('reinsurer', '');\n        frm.set_value('reinsurer_per1', '');\n        return;\n    }\n\n    // \u2705 Calculate existing total percentage\n    let total_percent = (frm.doc.reinsurers || [])\n        .reduce((sum, row) => sum + (Number(row.reinsurer_per) || 0), 0);\n\n    // Add new % to total\n    let new_total = total_percent + reinsurer_per;\n\n    // \u274c Check if total > 100\n    if (new_total > 100) {\n        frappe.msgprint(`Total reinsurer percentage cannot exceed 100%. Current total would be ${new_total}%.`);\n        return;\n    }\n\n    // \u2705 Add row if valid\n    var child = frappe.model.add_child(frm.doc, \"Multiple ReInsurers\", \"reinsurers\");\n\n    frappe.model.set_value(child.doctype, child.name, \"reinsurers\", reinsurer);\n    frappe.model.set_value(child.doctype, child.name, \"reinsurer_per\", reinsurer_per);\n\n    frm.refresh_field('reinsurers');\n\n    // Clear inputs\n    frm.set_value('reinsurer', '');\n    frm.set_value('reinsurer_per1', '');\n}\n\n\n    \n  \n    \n});\n\n//   function openDocument(frm, doctype) {\n//     var parameters = {\n//         policy_number: frm.doc.policy_number,\n//         policy_holder: frm.doc.policy_holder,\n//         proposal_no: frm.doc.proposal_no,\n//         quotation_numbers: frm.doc.quotation_numbers,\n//         attention_mr: frm.doc.policy_holder,\n//         to: frm.doc.policy_holder\n//     };\n\n//     frappe.new_doc(doctype, parameters);\n// }\n\n  function openDocument(frm, doctype) {\n    var parameters = {\n        policy_no: frm.doc.policy_number,\n        policy_holder: frm.doc.policy_holder,\n        proposal_no: frm.doc.proposal_no,\n        to:frm.doc.policy_holder,\n        policy_number:frm.doc.policy_number,\n        quotation_numbers:frm.doc.policy_number,\n        qno:frm.doc.quotation_numbers,\n        \n        quotation1: frm.doc.quotation_numbers,\n        date: frm.doc.acceptance_date,\n        client_name: frm.doc.policy_holder,\n        signed_by: frm.doc.autharoized_signatory,\n        quotation2: frm.doc.quotation_numbers,\n        maximum_terms_of_payment: frm.doc.payment_terms,\n        name_of_insured: frm.doc.policy_holder,\n        premium_rate: frm.doc.premium_rate,\n        description_of_goods:frm.doc.goods_services,\n        policy_type:frm.doc.policy_type,\n\n        \n    };\n\n    frappe.new_doc(doctype, parameters);\n}\n\n\n  function generateNumber(frm, field_name) {\n    let currentYear = new Date().getFullYear();\n    let prefix = `PLY/${currentYear}/`;\n\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Policy Approvals',\n            fields: [field_name, 'creation'],\n            order_by: 'creation desc',\n            limit: 1\n        },\n        callback: function(r) {\n            if (r.message && r.message.length > 0) {\n                let lastPolicyNo = r.message[0][field_name];\n                let lastNumber = parseInt(lastPolicyNo.split(\"/\").pop());\n                if (!isNaN(lastNumber)) {\n                    let newNumber = (lastNumber + 1).toString().padStart(4, '0');\n                    frm.set_value(field_name, prefix + newNumber);\n                }\n            } else {\n                frm.set_value(field_name, prefix + '0001');\n            }\n        }\n    });\n}\n\n\n//   function toggle_fields(frm) {\n//     if (frm.doc.policy_type === 'DCI') {\n//         frm.set_df_property('premium_rate', 'hidden', 0);\n//         frm.set_df_property('premium', 'hidden', 0);\n//     } else {\n//         frm.set_df_property('premium_rate', 'hidden', 1);\n//          frm.set_df_property('premium', 'hidden', 0);\n       \n//     }\n// }\n\nfunction toggle_fields(frm) {\n    if (frm.doc.policy_type === 'DCI') {\n        // Show both when DCI\n        frm.set_df_property('premium_rate', 'hidden', 0);\n        frm.set_df_property('premium', 'hidden', 0);\n    } else {\n        // Hide only premium_rate for non-DCI\n        frm.set_df_property('premium_rate', 'hidden', 1);\n        frm.set_df_property('premium', 'hidden', 0);\n    }\n}\n// Covering Letter creation (route_options BEFORE new_doc)\nfunction createCoveringLetter(frm) {\n    const reference_text = `DOMESTIC CREDIT INSURANCE QUOTATION - ${frm.doc.quotation_numbers || ''}`;\n\n    frappe.route_options = {\n        quotation1: frm.doc.quotation_numbers,\n        date: frm.doc.quotation_date,\n        re: reference_text,\n        client_name: frm.doc.policy_holder,\n        signed_by: frm.doc.autharoized_signatory\n    };\n\n    frappe.new_doc('Covering Letter Policy Approvals');\n}\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Bond Invoice",
  "enabled": 1,
  "modified": "2025-12-10 09:16:11.478167",
  "module": "Marketing",
  "name": "Bond_invoice_CoverLetters",
  "script": "// Bond Invoice client script (refactored)\r\nfrappe.ui.form.on('Bond Invoice', {\r\n    refresh: function(frm) {\r\n        // // Save button visibility logic\r\n        // if (frm.is_new()) {\r\n        //     frm.enable_save();\r\n        //     setTimeout(() => {\r\n        //         if (frm.page && frm.page.btn_primary) frm.page.btn_primary.show();\r\n        //     }, 50);\r\n        // } else {\r\n        //     frm.disable_save();\r\n        //     setTimeout(() => {\r\n        //         if (frm.page && frm.page.btn_primary) frm.page.btn_primary.hide();\r\n        //         $('button[data-label=\"Save\"]').hide();\r\n        //     }, 50);\r\n        // }\r\n\r\n        // Populate Bond Application values (if any)\r\n        if (frm.doc.bond_no) {\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Bond Application',\r\n                    filters: {\r\n                        bond_no: frm.doc.bond_invoice_no,\r\n                        facility_name: frm.doc.facility_name,\r\n                    },\r\n                    fields: [\r\n                        'beci_commission_p',\r\n                        'reinsurer_commissions',\r\n                        'other_insurer_commissions',\r\n                        'beci_commission',\r\n                        'reinsurer_commission',\r\n                        'other_insurer_commission',\r\n                        'guarantee_amount'\r\n                    ],\r\n                    limit_page_length: 1\r\n                },\r\n                callback: function(r) {\r\n                    if (!r.exc && r.message && r.message.length > 0) {\r\n                        var bondApp = r.message[0];\r\n\r\n                        frm.set_value('beci_commission_p', bondApp.beci_commission_p || 0);\r\n                        frm.set_value('reinsurer_commissions', bondApp.reinsurer_commissions || 0);\r\n                        frm.set_value('other_insurer_commissions', bondApp.other_insurer_commissions || 0);\r\n                        frm.set_value('beci_commission', bondApp.beci_commission || 0);\r\n                        frm.set_value('reinsurer_commission', bondApp.reinsurer_commission || 0);\r\n                        frm.set_value('other_insurer_commission', bondApp.other_insurer_commission || 0);\r\n                        frm.set_value('premium_p', bondApp.guarantee_amount || 0);\r\n\r\n                        if (typeof calculate_vat === \"function\") {\r\n                            calculate_vat(frm);\r\n                        }\r\n                    } else {\r\n                        // Set defaults\r\n                        frm.set_value('beci_commission_p', 0);\r\n                        frm.set_value('reinsurer_commissions', 0);\r\n                        frm.set_value('other_insurer_commissions', 0);\r\n                        frm.set_value('beci_commission', 0);\r\n                        frm.set_value('reinsurer_commission', 0);\r\n                        frm.set_value('other_insurer_commission', 0);\r\n                        frm.set_value('premium_p', 0);\r\n\r\n                        if (typeof calculate_vat === \"function\") {\r\n                            calculate_vat(frm);\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n        }\r\n\r\n      // Add Print External Invoice button (only for existing records)\r\nif (!frm.is_new()) {\r\n    frm.add_custom_button(__('Print External Invoice'), async function () {\r\n\r\n        // 1\ufe0f\u20e3 Check if record already exists\r\n        let existing = await frappe.call({\r\n            method: \"frappe.client.get_list\",\r\n            args: {\r\n                doctype: \"Print External Invoice deputy sherrif\",\r\n                filters: { invoice_no: frm.doc.bond_no },\r\n                fields: [\"name\"]\r\n            }\r\n        });\r\n\r\n        if (existing.message && existing.message.length > 0) {\r\n            // \ud83d\udc49 Open the saved record\r\n            frappe.set_route(\"Form\", \"Print External Invoice deputy sherrif\", existing.message[0].name);\r\n            return;\r\n        }\r\n\r\n        // 2\ufe0f\u20e3 No record found \u2192 create new and pass invoice number\r\n        frappe.route_options = {\r\n            invoice_no: frm.doc.bond_no\r\n        };\r\n\r\n        frappe.new_doc(\"Print External Invoice deputy sherrif\");\r\n    }).addClass(\"btn-primary\");\r\n}\r\n\r\n\r\n// Add Print Internal Invoice button (only for existing records)\r\nif (!frm.is_new()) {\r\n    frm.add_custom_button(__('Print Internal Invoice'), async function () {\r\n\r\n        // 1\ufe0f\u20e3 Check if record already exists\r\n        let existing = await frappe.call({\r\n            method: \"frappe.client.get_list\",\r\n            args: {\r\n                doctype: \"Print internal invoice deputy sheriff\",\r\n                filters: { invoice_no: frm.doc.bond_no },\r\n                fields: [\"name\"]\r\n            }\r\n        });\r\n\r\n        if (existing.message && existing.message.length > 0) {\r\n            // \ud83d\udc49 Open the saved record\r\n            frappe.set_route(\"Form\", \"Print internal invoice deputy sheriff\", existing.message[0].name);\r\n            return;\r\n        }\r\n\r\n        // 2\ufe0f\u20e3 No record found \u2192 create new\r\n        frappe.route_options = {\r\n            invoice_no: frm.doc.bond_no\r\n        };\r\n\r\n        frappe.new_doc(\"Print internal invoice deputy sheriff\");\r\n    }).addClass(\"btn-primary\");\r\n}\r\n\r\n\r\n        // Back button style\r\n        if (frm.fields_dict && frm.fields_dict.back && frm.fields_dict.back.$input) {\r\n            frm.fields_dict.back.$input.addClass('btn-primary');\r\n        }\r\n    },\r\n\r\n    // Your \"back\" logic (keeps original behavior)\r\n    back: function(frm) {\r\n        let bond_no = frm.doc.bond_no;\r\n        if (!bond_no) {\r\n            return;\r\n        }\r\n\r\n        // 1) Look for Bond Application\r\n        frappe.call({\r\n            method: \"frappe.client.get_list\",\r\n            args: {\r\n                doctype: \"Bond Application\",\r\n                filters: { bond_no: bond_no },\r\n                fields: [\"name\"],\r\n                limit_page_length: 1\r\n            },\r\n            callback: function (r1) {\r\n                if (r1.message && r1.message.length > 0) {\r\n                    frappe.set_route(\"Form\", \"Bond Application\", r1.message[0].name);\r\n                    return;\r\n                }\r\n\r\n                // 2) Look for Prepare Invoice\r\n                frappe.call({\r\n                    method: \"frappe.client.get_list\",\r\n                    args: {\r\n                        doctype: \"Prepare Invoice\",\r\n                        filters: { credsure_refno: bond_no },\r\n                        fields: [\"name\"],\r\n                        limit_page_length: 1\r\n                    },\r\n                    callback: function (r2) {\r\n                        if (r2.message && r2.message.length > 0) {\r\n                            frappe.set_route(\"Form\", \"Prepare Invoice\", r2.message[0].name);\r\n                            return;\r\n                        }\r\n\r\n                        frappe.msgprint(\"No related record found for Bond Number: \" + bond_no);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n});\r\n\r\n\r\n// // ------------------------------\r\n// // Print External Invoice handler\r\n// // (Registered once \u2014 outside Bond Invoice's refresh)\r\n// // ------------------------------\r\nfrappe.ui.form.on('Print External Invoice deputy sherrif', {\r\n    refresh: function(frm) {\r\n        // Ensure form is fully rendered\r\n        frappe.after_ajax(() => {\r\n            if (!frm.doc.invoice_no) return;\r\n\r\n            frappe.call({\r\n                method: \"frappe.client.get_value\",\r\n                args: {\r\n                    doctype: \"Bond Invoice\",\r\n                    filters: { bond_no: frm.doc.invoice_no },\r\n                    fieldname: [\r\n                        \"bond_no\",\"total_due\",\"invoice_date\",\r\n                        \"facility_name\",\"bond_in_favour\",\r\n                        \"period_from\",\"to\",\"month\",\r\n                        \"guarantee_amount\",\"premium_rate\",\r\n                        \"bond_type\",\"total_due_without_vat\"\r\n                    ]\r\n                },\r\n                callback: function(r) {\r\n                    if (r && r.message) {\r\n                        // Map values to the print form\r\n                        frm.set_value(\"reference\", r.message.bond_no);\r\n                        frm.set_value(\"re_insurer_ref_no\", r.message.bond_no);\r\n\r\n                        // Invoice To / Client\r\n                        frm.set_value(\"invoice_to\", r.message.facility_name || \"\");\r\n                        frm.set_value(\"client\", r.message.facility_name || \"\");\r\n                        frm.set_value(\"principal\", r.message.bond_type || \"\");\r\n\r\n                        // Numeric fields (formatted)\r\n                        frm.set_value(\"data3\", r.message.guarantee_amount ? Number(r.message.guarantee_amount).toFixed(2) : 0);\r\n                        frm.set_value(\"data4\", r.message.premium_rate ? Number(r.message.premium_rate).toFixed(2) : 0);\r\n                        frm.set_value(\"data7\", r.message.premium_rate ? Number(r.message.premium_rate).toFixed(2) : 0);\r\n                        frm.set_value(\"data6\", r.message.total_due_without_vat ? Number(r.message.total_due_without_vat).toFixed(2) : 0);\r\n                        frm.set_value(\"data5\", r.message.total_due_without_vat ? Number(r.message.total_due_without_vat).toFixed(2) : 0);\r\n                        frm.set_value(\"data8\", r.message.total_due ? Number(r.message.total_due).toFixed(2) : 0);\r\n\r\n                        // Dates / Descriptions\r\n                        frm.set_value(\"date\", r.message.invoice_date || \"\");\r\n                        frm.set_value(\"description1\", r.message.bond_in_favour || \"\");\r\n                        frm.set_value(\"period\", r.message.period_from || \"\");\r\n                        frm.set_value(\"to\", r.message.to || \"\");\r\n                        frm.set_value(\"month\", r.message.month || \"\");\r\n                    } else {\r\n                        frappe.msgprint(\"No matching Bond Invoice found for invoice_no: \" + frm.doc.invoice_no);\r\n                    }\r\n                }\r\n            });\r\n        });\r\n    },\r\n\r\n    // When invoice_to changes, fetch company details (defensive)\r\n    invoice_to: function(frm) {\r\n        if (!frm.doc.invoice_to) return;\r\n\r\n        // use get_value for a single record\r\n        frappe.call({\r\n            method: 'frappe.client.get_value',\r\n            args: {\r\n                doctype: 'Company-Details',\r\n                filters: { name1: frm.doc.invoice_to },\r\n                fieldname: ['postal_address', 'location1', 'telephone', 'fax', 'vat_reg_no']\r\n            },\r\n            callback: function(r) {\r\n                if (!r.exc && r.message) {\r\n                    frm.set_value('city', r.message.location1 || '');\r\n                    frm.set_value('vat_registration_no', r.message.vat_reg_no || '');\r\n                    frm.set_value('address', r.message.postal_address || '');\r\n                    frm.set_value('fax', r.message.fax || '');\r\n                    frm.set_value('telephone', r.message.telephone || '');\r\n\r\n                    // refresh fields if required\r\n                    frm.refresh_fields(['telephone', 'address', 'fax', 'city', 'vat_registration_no']);\r\n                }\r\n            }\r\n        });\r\n    }\r\n});\r\n\r\n\r\n// // ------------------------------\r\n// // Print Internal Invoice handler\r\n// // ------------------------------\r\nfrappe.ui.form.on('Print internal invoice deputy sheriff', {\r\n    refresh: function(frm) {\r\n        frappe.after_ajax(() => {\r\n            if (!frm.doc.invoice_no) return;\r\n\r\n            frappe.call({\r\n                method: \"frappe.client.get_value\",\r\n                args: {\r\n                    doctype: \"Bond Invoice\",\r\n                    filters: { bond_no: frm.doc.invoice_no },\r\n                    fieldname: [\r\n                        \"bond_no\",\"total_due\",\"broker\",\"invoice_date\",\r\n                        \"facility_name\",\"bond_in_favour\",\"period_from\",\"to\",\"month\",\r\n                        \"guarantee_amount\",\"premium_rate\",\"total_due_without_vat\",\r\n                        \"vat\",\"beci_commission_p\",\"beci_commission\",\r\n                        \"reinsurer_commission\",\"reinsurer_commissions\"\r\n                    ]\r\n                },\r\n                callback: function(r) {\r\n                    if (r && r.message) {\r\n                        frm.set_value(\"account\", r.message.facility_name || \"\");\r\n                        frm.set_value(\"invoice_date\", r.message.invoice_date || \"\");\r\n                        frm.set_value(\"data8\", r.message.broker || \"\");\r\n                        frm.set_value(\"data9\", r.message.broker || \"\");\r\n                        frm.set_value(\"data3\", r.message.vat ? Number(r.message.vat).toFixed(2) : 0);\r\n                        frm.set_value(\"data1\", r.message.premium_rate ? Number(r.message.premium_rate).toFixed(2) : 0);\r\n                        frm.set_value(\"data4\", r.message.premium_rate ? Number(r.message.premium_rate).toFixed(2) : 0);\r\n                        frm.set_value(\"data2\", r.message.total_due_without_vat ? Number(r.message.total_due_without_vat).toFixed(2) : 0);\r\n                        frm.set_value(\"data8\", r.message.total_due ? Number(r.message.total_due).toFixed(2) : 0);\r\n                        frm.set_value(\"data10\", r.message.beci_commission_p ? Number(r.message.beci_commission_p).toFixed(2) : 0);\r\n                        frm.set_value(\"data11\", r.message.beci_commission ? Number(r.message.beci_commission).toFixed(2) : 0);\r\n                        frm.set_value(\"data6\", r.message.reinsurer_commission ? Number(r.message.reinsurer_commission).toFixed(2) : 0);\r\n                        frm.set_value(\"data7\", r.message.reinsurer_commissions ? Number(r.message.reinsurer_commissions).toFixed(2) : 0);\r\n\r\n                        // update totals if needed\r\n                        let data2 = parseFloat(frm.doc.data2) || 0;\r\n                        let data4 = parseFloat(frm.doc.data4) || 0;\r\n                        let total = data2 + data4;\r\n                        frm.set_value('data5', total.toFixed(2));\r\n                    } else {\r\n                        frappe.msgprint(\"No matching Bond Invoice found for invoice_no: \" + frm.doc.invoice_no);\r\n                    }\r\n                }\r\n            });\r\n        });\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Single Buyer CL Application",
  "enabled": 1,
  "modified": "2025-12-05 08:23:05.491642",
  "module": null,
  "name": "New Script Cl Application",
  "script": "frappe.ui.form.on('Single Buyer CL Application', {\r\n \r\n    onload: function(frm) {\r\n    if (!frm.doc.credit_limit_number) {\r\n            generateNumber(frm);\r\n        }\r\n},\r\nrefresh: function(frm) {\r\n    \r\n     if (frm.fields_dict.new) {\r\n            frm.fields_dict.new.$wrapper.find('button').off('click').on('click', function() {\r\n                frappe.new_doc('Buyer');\r\n            }).addClass('btn-primary');\r\n        }\r\n        \r\n        \r\n        var workflow_state = frm.doc.workflow_state || '';\r\n \r\nfrm.toggle_display('buyer', true);\r\n\r\nif (workflow_state === \"Approved\") {\r\n    frm.set_df_property('buyer', 'read_only', 1);\r\n} else {\r\n    frm.set_df_property('buyer', 'read_only', 0);\r\n}\r\n    frappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Follow UP', // Make sure this is the exact Doctype name\r\n        fields: ['client_name'],\r\n        limit_page_length: 0\r\n    },\r\n    callback: function(response) {\r\n        if (response.message && response.message.length > 0) {\r\n\r\n            // Extract all client names\r\n            let all_clients = response.message.map(r => r.client_name);\r\n\r\n            // \u2757 Remove duplicates using Set\r\n            let unique_clients = [...new Set(all_clients)];\r\n            \r\n            unique_clients.sort();\r\n\r\n            // Set options to field\r\n            frm.set_df_property('client1', 'options', unique_clients);\r\n\r\n            // Refresh field\r\n            frm.refresh_field('client1');\r\n\r\n        } else {\r\n            frappe.msgprint(\"No clients found in Follow UP Doctype.\");\r\n        }\r\n    }\r\n});\r\n\r\n\r\n    \r\n\r\n},\r\n\r\neci_buyer: function(frm){\r\n // Fetch options for 'buyer' field (DCI buyers)\r\n   frappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Buyer',\r\n        filters: { eci: 1 },\r\n        fields: ['buyer_name'],\r\n        limit_page_length: 0\r\n    },\r\n    callback: function(response) {\r\n        if (response.message) {\r\n\r\n            // Extract buyer names\r\n            let all_buyers = response.message.map(b => b.buyer_name);\r\n\r\n            // Remove duplicates using Set\r\n            let unique_buyers = [...new Set(all_buyers)];\r\n\r\n            // Set to dropdown\r\n            frm.set_df_property('buyer', 'options', unique_buyers);\r\n\r\n            // Refresh field\r\n            frm.refresh_field('buyer');\r\n        }\r\n    }\r\n});\r\n\r\n    \r\n},\r\n\r\n\r\ndci_buyer: function(frm){\r\n\r\n    // Fetch options for 'buyer1' field (ECI buyers)\r\nfrappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Buyer',\r\n        filters: { dci: 1 },\r\n        fields: ['buyer_name'],\r\n        limit_page_length: 0\r\n    },\r\n    callback: function(response) {\r\n        if (response.message) {\r\n\r\n            // Extract buyer names\r\n            let all_buyers = response.message.map(b => b.buyer_name);\r\n\r\n            // Remove duplicates\r\n            let unique_buyers = [...new Set(all_buyers)];\r\n\r\n            // Set to dropdown\r\n            frm.set_df_property('buyer', 'options', unique_buyers);\r\n\r\n            frm.refresh_field('buyer');\r\n        }\r\n    }\r\n});\r\n},\r\n\r\n\r\nbuyer: function(frm) {\r\n        // \u2705 Get the selected buyer from the field\r\n        let buyer = frm.doc.buyer;\r\n\r\n        if (!buyer) {\r\n            frappe.msgprint('Please select a Buyer first.');\r\n            return;\r\n        }\r\n\r\n        // \u2705 Fetch data from the Buyer doctype\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Buyer',\r\n                filters: {\r\n                    buyer_name: buyer\r\n                },\r\n                fields: [\r\n                    'trading_name', 'registration_no', 'phone', 'bank', 'branch',\r\n                    'director_1', 'director_2', 'director_3', 'director_4',\r\n                    'physical_address', 'postal_address', 'fax', 'ac_no'\r\n                ],\r\n                limit_page_length: 1\r\n            },\r\n            callback: function(response) {\r\n                if (response.message && response.message.length > 0) {\r\n                    let buyer_data = response.message[0];\r\n\r\n                    // \u2705 Populate fields\r\n                    frm.set_value('trading_style', buyer_data.trading_name || '');\r\n                    frm.set_value('credit_limit', buyer_data.registration_no || '');\r\n                    frm.set_value('telephone_number', buyer_data.phone || '');\r\n                    frm.set_value('date', buyer_data.bank || '');\r\n                    frm.set_value('branch', buyer_data.branch || '');\r\n                    frm.set_value('credit_bureau_report', buyer_data.director_1 || '');\r\n                    frm.set_value('cb_report_required', buyer_data.director_3 || '');\r\n                    frm.set_value('address1', buyer_data.physical_address || '');\r\n                    frm.set_value('address2', buyer_data.postal_address || '');\r\n                    frm.set_value('fax_number', buyer_data.fax || '');\r\n                    frm.set_value('account_number', buyer_data.ac_no || '');\r\n                    frm.set_value('director2', buyer_data.director_2 || '');\r\n                    frm.set_value('director4', buyer_data.director_4 || '');\r\n                } \r\n                else {\r\n                    // \u2705 Clear fields if no record found\r\n                    let fields_to_clear = [\r\n                        'trading_style', 'credit_limit', 'telephone_number', 'date',\r\n                        'branch', 'credit_bureau_report', 'cb_report_required', 'address1',\r\n                        'address2', 'fax_number', 'account_number', 'director2', 'director4'\r\n                    ];\r\n                    fields_to_clear.forEach(field => frm.set_value(field, ''));\r\n                    frappe.msgprint('No matching Buyer record found.');\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error(err);\r\n                frappe.msgprint('\u26a0\ufe0f Error while fetching data from Buyer. Please check the console.');\r\n            }\r\n        });\r\n    }\r\n});\r\n\r\n\r\nfunction generateNumber(frm) {\r\n    // Check if the proposal number field is already populated\r\n    if (!frm.doc.credit_limit_number) {\r\n        // Get the current year\r\n        let currentYear = new Date().getFullYear();\r\n        let prefix = `CLC/${currentYear}/`;\r\n\r\n        // Make a call to get the last number asynchronously\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Single Buyer CL Application',\r\n                fields: ['credit_limit_number', 'creation'],\r\n                order_by: 'creation desc',\r\n                limit: 1\r\n            },\r\n            callback: function(r) {\r\n                console.log(r,\"proposal no\");\r\n                if (r.message && r.message.length > 0) {\r\n                    let lastProposalNo = r.message[0].credit_limit_number;\r\n                    let lastNumber = parseInt(lastProposalNo.split(\"/\").pop()); // Extract last part and parse it as integer\r\n                    if (!isNaN(lastNumber)) {\r\n                        // Increment the last number and pad it with leading zeros\r\n                        let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n                        frm.set_value('credit_limit_number', prefix + newNumber);\r\n                    }\r\n                } else {\r\n                    // If no previous numbers exist, set to default '0001'\r\n                    frm.set_value('credit_limit_number', prefix + '0001');\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Single Buyer CL Processing",
  "enabled": 0,
  "modified": "2025-11-12 11:05:38.083309",
  "module": null,
  "name": "new script Single buyer CL Processing",
  "script": "frappe.ui.form.on('Single Buyer CL Processing', {\n    refresh: function(frm) {\n     \n       \n      var workflowState = frm.doc.workflow_state;\n \n        // Create a custom button for \"Print Proposal\" if the workflow state is \"Submitted\"\n        if (workflowState === \"Approved\") {\n            frm.add_custom_button(__('Print Annexure'), function() {\n                frappe.new_doc('Credit Limit  Annexure')\n                    frappe.route_options = {\n                    date: frm.doc.capture_date,\n                    client1: frm.doc.policy_holder_name,\n                    policy_no:frm.doc.policy_no,\n                    cl_check_no: frm.doc.credit_limit_no,\n                    buyer:frm.doc.buyer_name,\n                    trading__style: frm.doc.trading__style,\n                    location: frm.doc.location,\n                    credit_limit_required: frm.doc.approved_amount,\n                    types_of_payments: frm.doc.terms_of_payments,\n                    days_from:frm.doc.days_from,\n                    conditions: frm.doc.conditions,\n                    buyer_id: frm.doc.buyer_id\n                }\n                console.log(\"Print Proposal clicked!\");\n            }).addClass(\"btn-primary\");\n        }\n        frm.fields_dict.financial_analysis.$input.addClass('btn-primary');\n        frm.fields_dict.director_share_holder_exposure.$input.addClass('btn-primary');\n \n        // new code\n        if (frm.doc.yes) {\n    if (workflowState === \"Pending\" || workflowState === \"Approved\") {\n        frm.add_custom_button(__('View CB Report'), function() {\n            frappe.call({\n                method: \"frappe.client.get_list\",\n                args: {\n                    doctype: \"CB Report\",\n                    filters: {\n                        buyer: frm.doc.buyer_name,\n                        refnumber: frm.doc.credit_limit_no\n                    },\n                    fields: [\"cb_request_number\", \"reqdate\", \"buyer\", \"refnumber\", \"date\", \"catagory\", \"code\", \"details\", \"description\"],\n                    limit: 1\n                },\n                callback: function (r) {\n                    if (r.message && r.message.length > 0) {\n                        var cbReportData = r.message[0];\n                        frappe.prompt([\n                            {'fieldname': 'credit_bureau_request', 'fieldtype': 'Heading', 'label': 'Credit Bureau Request'},\n                            {'fieldname': 'section_break_2','fieldtype': 'Section Break','label': ''},\n                            {'fieldname': 'cb_request_number', 'fieldtype': 'Data', 'label': 'CB Req Number', 'default': cbReportData.cb_request_number},\n                            {'fieldname': 'reqdate', 'fieldtype': 'Date', 'label': 'Req.Date', 'default': cbReportData.reqdate},\n                            {'fieldname': 'buyer', 'fieldtype': 'Data', 'label': 'Buyer', 'default': cbReportData.buyer},\n                            {'fieldname': 'column_break_1','fieldtype': 'Column Break','label': ''},\n                            {'fieldname': 'refnumber', 'fieldtype': 'Data', 'label': 'Ref.Number','default': cbReportData.refnumber},\n                            {'fieldname': 'section_break_4','fieldtype': 'Section Break','label': ''},\n                            {'fieldname': 'credit_bureau_responce', 'fieldtype': 'Heading', 'label': 'Credit Bureau Response'},\n                            {'fieldname': 'section_break_5','fieldtype': 'Section Break','label': ''},\n                            {'fieldname': 'date', 'fieldtype': 'Date', 'label': 'Date', 'default': cbReportData.date},\n                            {'fieldname': 'catagory', 'fieldtype': 'Data', 'label': 'Category', 'default': cbReportData.catagory},\n                            {'fieldname': 'code', 'fieldtype': 'Data', 'label': 'Code',  'default': cbReportData.code},\n                            {'fieldname': 'column_break_2','fieldtype': 'Column Break','label': ''},\n                            {'fieldname': 'details', 'fieldtype': 'Data', 'label': 'Details',  'default': cbReportData.details},\n                            {'fieldname': 'description', 'fieldtype': 'Small Text', 'label': 'Description', 'default': cbReportData.description},\n                        ], function(values){}, 'CB Report');\n                    } else {\n                        frappe.msgprint(`CB Report not found for Buyer <b>${frm.doc.buyer_name}</b> and Credit Limit Number <b>${frm.doc.credit_limit_no}</b>.`);\n                    }\n                }\n            });\n        }).addClass(\"btn-primary\");\n    }\n}\n\n\n\ne\n      \n        if(frm.doc.yes){\n        if (workflowState === \"Pending\" || workflowState === \"Approved\") {\n            frm.toggle_display('cbreport', true);\n            frm.toggle_display('report', false);\n            frm.toggle_display('cb_request', false);\n            // frm.toggle_display('table', false);\n \n        }\n        }\n \n          if (workflowState === \"Approved\") {// || workflowState === \"Pending\" || workflowState === \"Draft\") {\n             frm.toggle_display('policy_number', true);\n             frm.toggle_display('policy_no', false);\n            \n        //     frm.toggle_display('credit_number', true);\n        //     frm.toggle_display('credit_limit_no', false); \n\n         }\n        \n        \n        \n         frm.fields_dict.credit_limit.$input.css(\"text-align\", \"right\");\n      frm.fields_dict.overdue_amount.$input.css(\"text-align\", \"right\");\n      frm.fields_dict.outstanding_amount.$input.css(\"text-align\", \"right\");\n      frm.fields_dict.total_exposure.$input.css(\"text-align\", \"right\");\n      frm.fields_dict.recommended_exposure.$input.css(\"text-align\", \"right\");\n \n    \n    }\n    \n\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Renewals",
  "enabled": 0,
  "modified": "2025-11-13 07:37:54.795924",
  "module": null,
  "name": "Renewals New Script",
  "script": "frappe.ui.form.on('Renewals', {\r\n    onload: function(frm) {\r\n        generateNumber(frm);\r\n    },\r\n  bond_no2(frm) {\r\n\r\n        var bondno = frm.doc.bond_no2;\r\n        frm.set_value('bond_no', bondno);\r\n\r\n        if (frm.doc.other_bonds == 1) {\r\n\r\n            frm.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Bond Application',\r\n                    filters: { bond_no: frm.doc.bond_no2 },\r\n                    fields: [\r\n                        'facility_name', 'bond_no', 'reg_date', 'bond_in_favour', 'project', 'description_contract',\r\n                        'period_from', 'to', 'amount_in_pula', 'reg_no', 'bond_type'\r\n                    ],\r\n                },\r\n                callback: function (response) {\r\n                    if (response.message && response.message.length > 0) {\r\n                        let bondDetails = response.message[0];\r\n                        frm.set_value('bond_extnreq_date', bondDetails.reg_date);\r\n                        frm.set_value('client', bondDetails.facility_name);\r\n                        frm.set_value('principal', bondDetails.bond_in_favour);\r\n                        frm.set_value('project', bondDetails.project);\r\n                        frm.set_value('description', bondDetails.description_contract);\r\n                        frm.set_value('bond_period_from', bondDetails.period_from);\r\n                        frm.set_value('bond_period_to', bondDetails.to);\r\n                        frm.set_value('bond_value', bondDetails.amount_in_pula);\r\n                        frm.set_value('bond_type_1', bondDetails.bond_type);\r\n                        frm.set_value('new_bond_value', bondDetails.amount_in_pula);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n\r\n        if (frm.doc.deputyshreiff_bond == 1) {\r\n            frm.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Deputy Sheriff Bond',\r\n                    filters: { sheriff_name: frm.doc.bond_holder2 },\r\n                    fields: ['sheriff_name', 'bond_no', 'period_from', 'bond_value', 'description_of_contract', 'period_to']\r\n                },\r\n                callback: function (r) {\r\n                    if (r.message && r.message.length > 0) {\r\n                        var message = r.message[0];\r\n                        frm.set_value('bond_period_from', message.period_from);\r\n                        frm.set_value('description', message.description_of_contract);\r\n                        frm.set_value('bond_period_to', message.period_to);\r\n                        frm.set_value('bond_value', message.bond_value);\r\n                        frm.set_value('new_bond_value', message.bond_value);\r\n                        frm.set_value('client', message.sheriff_name);\r\n                        frm.set_value('principal', 'High Court');\r\n                        frm.set_value('bond_extnreq_date', message.period_from);\r\n                        frm.set_value('bond_type_1', 'DEPUTY SHERIFF BOND');\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    },\r\n\r\n    other_bonds(frm) {\r\n\r\n\r\n        var other_bonds = frm.doc.other_bonds;\r\n\r\n        if (other_bonds == 1) {\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Bond Application',\r\n                    filters: { workflow_state: \"Approved\" },\r\n                    fields: ['facility_name'],\r\n                    limit_page_length: 100000000\r\n                },\r\n                callback: function (response) {\r\n                    let DataArray = response.message;\r\n                    let FinalArray = [];\r\n                    for (let x of DataArray) {\r\n                        FinalArray.push(x.facility_name)\r\n                    }\r\n                    frm.set_df_property('bond_holder', 'options', FinalArray);\r\n                },\r\n                error: function (xhr, textStatus, errorThrown) {\r\n                    console.error(\"Error fetching approved bonds:\", textStatus, errorThrown);\r\n                }\r\n            });\r\n\r\n        } else {\r\n            let FinalArray = []\r\n            frm.set_df_property('bond_holder', 'options', FinalArray);\r\n        }\r\n\r\n        if (other_bonds === 0) {\r\n            frm.set_value('bond_holder', '');\r\n            frm.set_value('bond_no2', '');\r\n            frm.set_value('bond_extnreq_date', '');\r\n            frm.set_value('client', '');\r\n            frm.set_value('principal', '');\r\n            frm.set_value('project', '');\r\n            frm.set_value('description', '');\r\n            frm.set_value('bond_period_from', '');\r\n            frm.set_value('bond_period_to', '');\r\n            frm.set_value('bond_value', '');\r\n            frm.set_value('bond_type_1', '');\r\n            frm.set_value('new_bond_value', '');\r\n        }\r\n    },\r\n\r\n    deputyshreiff_bond(frm) {\r\n\r\n\r\n        var deputyshreiff = frm.doc.deputyshreiff_bond;\r\n\r\n        if (deputyshreiff === 1) {\r\n\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Deputy Sheriff Bond',\r\n                    filters: {},\r\n                    fields: ['sheriff_name'],\r\n                },\r\n                callback: function (response) {\r\n                    let uniquedata = new Set(response.message.map(item => item.sheriff_name));\r\n                    let FinalArray = Array.from(uniquedata);\r\n                    frm.set_df_property('bond_holder', 'options', FinalArray);\r\n                },\r\n                error: function (xhr, textStatus, errorThrown) {\r\n                    console.error(\"Error fetching policy_holder:\", textStatus, errorThrown);\r\n                }\r\n            });\r\n\r\n        } else {\r\n            let FinalArray = []\r\n            frm.set_df_property('bond_holder', 'options', FinalArray);\r\n\r\n            // frm.set_value('bond_holder2', '');\r\n            // frm.set_value('bond_no2', '');\r\n            // frm.set_value('bond_period_from', '');\r\n            // frm.set_value('description', '');\r\n            // frm.set_value('bond_period_to', '');\r\n            // frm.set_value('bond_value', '');\r\n            // frm.set_value('client', '');\r\n            // frm.set_value('principal', '');\r\n        }\r\n    },\r\n});\r\n\r\n\r\n function generateNumber(frm) {\r\n\r\n    let currentYear = new Date().getFullYear();\r\n    let prefix = `BRQ/${currentYear}/`;\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Renewals',\r\n            fields: ['renewal_req_no1'],\r\n            filters: { renewal_req_no1: ['like', `${prefix}%`] },\r\n            limit_page_length: 1000,\r\n            order_by: 'renewal_req_no1 desc'\r\n        },\r\n        callback: function (r) {\r\n            if (r.message && r.message.length > 0) {\r\n                let lastReviewNo = r.message[0].renewal_req_no1;\r\n                let parts = lastReviewNo.split(\"/\");\r\n                let lastNumber = parseInt(parts[2]) || 0;\r\n                let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n                frm.set_value('renewal_req_no1', prefix + newNumber);\r\n            } else {\r\n                frm.set_value('renewal_req_no1', prefix + '0001');\r\n            }\r\n        }\r\n    });\r\n}   \r\n              ",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "FundProviderDetail",
  "enabled": 1,
  "modified": "2025-11-13 12:20:05.616831",
  "module": null,
  "name": "Fund Provider Detail Sript",
  "script": "frappe.ui.form.on('FundProviderDetail', {\r\n    fname: async function(frm) {\r\n        if (!frm.doc.fname) return;\r\n\r\n        // Take first 4 letters of fname and convert to uppercase\r\n        let base_shortname = frm.doc.fname.substring(0, 4).toUpperCase();\r\n        let unique_shortname = base_shortname;\r\n        let counter = 1;\r\n\r\n        // Check for duplicates and append counter until unique\r\n        while (true) {\r\n            let existing = await frappe.db.get_list('FundProviderDetail', {\r\n                fields: ['name'],\r\n                filters: { shortname: unique_shortname },\r\n                limit: 1\r\n            });\r\n\r\n            if (existing.length === 0) {\r\n                frm.set_value('shortname', unique_shortname);\r\n                break;\r\n            }\r\n\r\n            counter++;\r\n            unique_shortname = base_shortname + counter;\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Lawyer Debt Collector Details",
  "enabled": 1,
  "modified": "2025-11-13 12:26:32.547795",
  "module": null,
  "name": "Lawyer Debt Collector Details Script",
  "script": "frappe.ui.form.on('Lawyer Debt Collector Details', {\r\n    name1: async function(frm) {\r\n        if (!frm.doc.name1) return;\r\n\r\n        // Step 1: Take first 4 letters and convert to uppercase\r\n        let base_shortname = frm.doc.name1.substring(0, 4).toUpperCase();\r\n        let unique_shortname = base_shortname;\r\n        let counter = 1;\r\n\r\n        // Step 2: Check if short_name already exists, loop until unique\r\n        while (true) {\r\n            // Use frappe.db.get_value (works even for custom fields)\r\n            let existing = await frappe.db.get_value(\r\n                'Lawyer Debt Collector Details',\r\n                { short_name: unique_shortname },\r\n                'name'\r\n            );\r\n\r\n            // If no duplicate found, set short_name and break\r\n            if (!existing || !existing.message || Object.keys(existing.message).length === 0) {\r\n                frm.set_value('short_name', unique_shortname);\r\n                break;\r\n            }\r\n\r\n            // Else append counter and retry\r\n            counter++;\r\n            unique_shortname = base_shortname + counter;\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Outstanding_Turnover_table",
  "enabled": 0,
  "modified": "2025-11-14 13:20:58.996376",
  "module": null,
  "name": "Outstanding_Turnover_table script",
  "script": "frappe.ui.form.on('Outstanding_Turnover_table', {\r\n    // This fires for every row\r\n    form_render: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n\r\n        if (row.is_total_row == 1) {\r\n            // Delay DOM changes to ensure row is rendered\r\n            setTimeout(() => {\r\n                const table_map = {\r\n                    \"outstanding1\": \"TOTAL (Outstanding)\",\r\n                    \"turnover1\": \"TOTAL (Turnover)\"\r\n                };\r\n\r\n                let grid_row = null;\r\n                let label = \"\";\r\n\r\n                for (let table_field in table_map) {\r\n                    let grid = frm.fields_dict[table_field]?.grid;\r\n                    if (grid && grid.get_row(cdn)) {\r\n                        grid_row = grid.get_row(cdn);\r\n                        label = `<b>${table_map[table_field]}</b>`;\r\n                        break;\r\n                    }\r\n                }\r\n\r\n                if (!grid_row) return;\r\n\r\n                // Hide checkbox and index\r\n                grid_row.row.find(\".grid-row-check, .row-index\").hide();\r\n\r\n                // Replace buyer column text\r\n                grid_row.row.find('[data-fieldname=\"buyer\"]').html(label);\r\n\r\n                // Make row read-only\r\n                grid_row.toggle_editable(false);\r\n\r\n                // Gray background\r\n                grid_row.row.css(\"background-color\", \"#f2f2f2\");\r\n            }, 50); // small delay to let row render\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Bond Claims",
  "enabled": 1,
  "modified": "2025-12-01 10:37:27.167392",
  "module": null,
  "name": "Bond Claims New Script",
  "script": "frappe.ui.form.on('Bond Claims', {\n\trefresh: function(frm) {\n\t\t frm.fields_dict. value.$input.css(\"text-align\", \"right\");\n\t\t var workflow_state = frm.doc.workflow_state || '';\n \n// Always keep original fields visible\nfrm.toggle_display('bond_no', true);\n\n// Make them read-only when approved\nif (workflow_state === \"Approved\") {\n    frm.set_df_property('bond_no', 'read_only', 1);\n} else {\n    frm.set_df_property('bond_no', 'read_only', 0);\n}\n\t},\n\n\tonload: function(frm) {\n\t    if (!frm.doc.claim_ref_no) {\n            generateNumber(frm);\n        }\n       frappe.call({\n    method: 'frappe.client.get_list',\n    args: {\n        doctype: 'Bond Application',\n        filters: { workflow_state: 'Approved' },\n        fields: ['facility_name'],\n        limit_page_length: 0\n    },\n    callback: function(response) {\n        if (response.message && response.message.length) {\n\n            // Get unique facility_names\n            let phOptions = [...new Set(response.message.map(r => r.facility_name))].sort();\n\n            frm.set_df_property('client', 'options', phOptions.join('\\n'));\n            frm.refresh_field('client');\n        }\n    }\n});\n\n\t},\n\tclient: function(frm) {\n\t    frappe.call({\n    method: 'frappe.client.get_list',\n    args: {\n        doctype: 'Bond Application',\n        filters: { facility_name: frm.doc.client }, \n        fields: ['bond_no'],\n        limit_page_length: 0\n    },\n    callback: function(response) {\n\n        if (response.message && response.message.length) {\n\n            let policyNumbers = Array.from(new Set(response.message.map(r => r.bond_no)));\n\n            frm.set_df_property('bond_no', 'options', policyNumbers.join('\\n'));\n\n            // Reset if current bond_no is not valid\n            if (!policyNumbers.includes(frm.doc.bond_no)) {\n                frm.set_value('bond_no', '');\n            }\n\n        } else {\n\n            // No records found \u2192 clear options & reset value\n            frm.set_df_property('bond_no', 'options', '');\n            frm.set_value('bond_no', '');\n\n        }\n\n        frm.refresh_field('bond_no');\n    }\n});\n\n\t},\n\nbond_no: function(frm) {\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Bond Application',\n            filters: { bond_no: frm.doc.bond_no },\n            fields: [\n                'dates', 'facility_name', 'project',\n                'period_from', 'bond_type', 'to', 'refer_to_reinsurer',\n                'reg_date', 'amount_in_pula', 'bond_in_favour', 'description_contract'\n            ],\n            \n        },\n        callback: function(response) {\n            if (response.message && response.message.length > 0) {\n                let data = response.message[0];\n                frm.set_value('date', data.dates);\n                frm.set_value('client', data.facility_name);\n                frm.set_value('project', data.project);\n                frm.set_value('bond_period_from', data.period_from);\n                frm.set_value('policy_type', data.bond_type);\n                frm.set_value('bond_period_to', data.to);\n                frm.set_value('reinsurer', data.refer_to_reinsurer);\n                frm.set_value('bond_value', data.amount_in_pula);\n                frm.set_value('principal', data.bond_in_favour);\n                frm.set_value('description', data.description_contract);\n\n                \n            }\n        }\n    }); \n}\n})\nfunction generateNumber(frm) {\n    if (!frm.doc.claim_ref_no) {\n        let currentYear = new Date().getFullYear();\n        let prefix = `CLM/${currentYear}/`;\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Bond Claims',\n                fields: ['claim_ref_no', 'creation'],\n                order_by: 'creation desc',\n                limit: 1\n            },\n            callback: function(r) {\n                if (r.message && r.message.length > 0) {\n                    let lastCRNumber = r.message[0].claim_ref_no;\n                    let lastNumber = parseInt(lastCRNumber.split(\"/\").pop());\n                    if (!isNaN(lastNumber)) {\n                        let newNumber = (lastNumber + 1).toString().padStart(4, '0');\n                        frm.set_value('claim_ref_no', prefix + newNumber);\n                    }\n                } else {\n                    frm.set_value('claim_ref_no', prefix + '0001');\n                }\n            }\n        });\n    }\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "DCI Quotation",
  "enabled": 0,
  "modified": "2025-11-20 08:30:22.205867",
  "module": null,
  "name": "Colour setter",
  "script": "frappe.ui.form.on('DCI Quotation', {\n\trefresh(frm) {\n\t    \n\t    \n        $('[data-fieldname=\"limit_of_discretion\"] input').css(\"background-color\", \" #ffffe6\");\n        $('[data-fieldname=\"insured_turnover\"] input').css(\"background-color\", \" #ffffe6\");\n        $('[data-fieldname=\"buyers_excluded\"] input').css(\"background-color\", \" #ffffe6\");\n        $('[data-fieldname=\"premium_deposit\"] input').css(\"background-color\", \" #ffffe6\");\t\n        $('[data-fieldname=\"premium_rate\"] input').css(\"background-color\", \" #ffffe6\");\n        $('[data-fieldname=\"maximum_liability\"] input').css(\"background-color\", \" #ffffe6\");\n\n   \t\n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Export Declarations",
  "enabled": 1,
  "modified": "2025-12-08 13:40:44.470208",
  "module": null,
  "name": "New Export declaration script",
  "script": "frappe.ui.form.on('Export Declarations', {\r\n    \r\n//     validate: function(frm) {\r\n\r\n\r\n//     frm.call({\r\n//     method: 'extractData',\r\n//     doc: frm.doc,\r\n//     callback: function(response) {\r\n//         if (!response.exc && response.message) {\r\n//             var data = response.message;\r\n\r\n//             // \u2705 Clear the child table using the correct fieldname\r\n//           // frm.clear_table('export_declaration');\r\n\r\n//             data.forEach(x => {\r\n//                 let child = frm.add_child('export_declaration');\r\n//                 frappe.model.set_value(child.doctype, child.name, 'buyer', x[\"Buyer\"]);\r\n//                 frappe.model.set_value(child.doctype, child.name, 'terms_of_payment', x[\"Terms of Payment\"]);\r\n//                 frappe.model.set_value(child.doctype, child.name, 'exchange_rate', x[\"Exchange Rate\"]);\r\n//                 frappe.model.set_value(child.doctype, child.name, 'fx_value', x[\"FX Value\"]);\r\n//                 frappe.model.set_value(child.doctype, child.name, 'pula', x[\"Pula\"]);\r\n                \r\n\r\n\r\n//             });\r\n\r\n//             frm.refresh_field('export_declaration');\r\n           \r\n//         } else {\r\n//             frappe.msgprint('No data received from server.');\r\n//             console.error(response.exc);\r\n//         }\r\n//     }\r\n// });\r\n\r\n\r\n// },\r\n\r\nvalidate: function(frm) {\r\n\r\n\r\nfrm.call({\r\n    method: \"extractData\",\r\n    doc: frm.doc,\r\n    callback: function(response) {\r\n\r\n        if (!response.exc && response.message) {\r\n            let data = response.message;\r\n\r\n            // Clear existing rows\r\n            frm.clear_table(\"export_declaration\");\r\n\r\n            data.forEach(row => {\r\n                let child = frm.add_child(\"export_declaration\");\r\n\r\n                // Map Excel \u2192 Child Table Fields\r\n                child.country = row[\"Country\"];\r\n                child.buyer = row[\"Buyer\"];\r\n                child.terms_of_payment = row[\"Terms of Payment\"];\r\n                child.exchange_rate = row[\"Exchange Rate\"] || row[\"Exchange Rate(1 USD =.)\"];\r\n                child.fx_value = row[\"FX Value\"];\r\n                child.pula = row[\"USD\"];\r\n                child.premium_rate = row[\"premium rate\"];\r\n                child.amount1 = row[\"amount1\"];\r\n                child.amount2 = row[\"Amount\"];  \r\n            });\r\n\r\n            frm.refresh_field(\"export_declaration\");\r\n\r\n        } else {\r\n            frappe.msgprint(\"No data received from server.\");\r\n            console.error(response.exc);\r\n        }\r\n    }\r\n});\r\n\r\n},\r\n\r\n    refresh :function(frm) {\r\n        \r\n                frm.fields_dict.add.$input.addClass('btn-primary');\r\n                frm.set_df_property('export_declaration', 'cannot_add_rows', true);\r\n\r\n\r\n        frappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Currency_Finance',\r\n        fields: ['short_name'],\r\n        limit_page_length:10000\r\n    },\r\n    callback(response) {\r\n        const currency = response.message || [];\r\n        const unique = [...new Set(currency.map(b => b.short_name))];\r\n        unique.sort();\r\n        frm.set_df_property('currency', 'options', unique);\r\n    }\r\n});\r\n        \r\n        \r\n                    //    toggle_policy_readonly(frm);\r\n\r\n\r\n        let workflow = frm.doc.workflow_state || \"\";\r\n        \r\n            \r\n\r\n\r\n       // if ([\"Pending\", \"Approved\"].includes(workflow)) {\r\n        if ([\"Approved\"].includes(workflow)) {\r\n\r\n            frm.add_custom_button(\"Prepare Invoice\", () => {\r\n\r\n                if (!frm.doc.export_declaration || frm.doc.export_declaration.length === 0) {\r\n                    frappe.msgprint(\"No export declaration found.\");\r\n                    return;\r\n                }\r\n                if (!frm.doc.policy_holder || !frm.doc.quotation_number) {\r\n                    frappe.msgprint(\"Please fill Policy Holder and Quotation Number.\");\r\n                    return;\r\n                }\r\n\r\n                // FORCE get ed_number from field OR doc\r\n                let ed_number =\r\n                    frm.get_field(\"ed_number\")?.value ||\r\n                    frm.doc.ed_number ||\r\n                    \"\";\r\n\r\n                console.log(\"FOUND ED NUMBER:\", ed_number);\r\n\r\n                const { policy_holder, quotation_number } = frm.doc;\r\n\r\n                frappe.db.get_list(\"Export Declaration Invoice\", {\r\n                    filters: { policy_holder, quotation_number },\r\n                    fields: [\"name\"],\r\n                    limit: 1\r\n                }).then(existing => {\r\n\r\n                    if (existing && existing.length > 0) {\r\n                        frappe.set_route(\"Form\", \"Export Declaration Invoice\", existing[0].name);\r\n                        return;\r\n                    }\r\n\r\n                    // CREATE NEW INVOICE\r\n                    frappe.model.with_doctype(\"Export Declaration Invoice\", () => {\r\n\r\n                        let doc = frappe.model.get_new_doc(\"Export Declaration Invoice\");\r\n\r\n                        // Copy main fields\r\n                        doc.policy_holder = policy_holder;\r\n                        doc.quotation_number = quotation_number;\r\n                        doc.month = frm.doc.month;\r\n                        doc.year = frm.doc.year;\r\n                          doc.currency = frm.doc.currency;\r\n\r\n                        //  Force assign ed_number with fallback\r\n                        doc.ed_number = ed_number;\r\n                        console.log(\"ASSIGNED TO NEW DOC:\", doc.ed_number);\r\n\r\n                        // Copy child table rows\r\n                        (frm.doc.export_declaration || []).forEach(row => {\r\n                            let child = frappe.model.add_child(\r\n                                doc,\r\n                                \"ExportDeclarationInvoiceChild\",\r\n                                \"export_buyer\"\r\n                            );\r\n                            child.buyer = row.buyer;\r\n                            child.turn_over_amt = row.fx_value;\r\n                            child.premium_rate = row.premium_rate;\r\n                            child.amount1 = row.amount1;\r\n                            child.country = row.country;\r\n                        });\r\n\r\n                        frappe.set_route(\"Form\", \"Export Declaration Invoice\", doc.name);\r\n                    });\r\n\r\n                });\r\n\r\n            }).addClass(\"btn-primary\");\r\n        }\r\n        \r\n        \r\n        // Always keep original fields visible\r\nfrm.toggle_display('policy_number', true);\r\n// Make them read-only when approved\r\nif (workflow === \"Approved\") {\r\n    frm.set_df_property('policy_number', 'read_only', 1);\r\n} else {\r\n    frm.set_df_property('policy_number', 'read_only', 0);\r\n}\r\n        \r\n\r\n    }, \r\n    \r\n    \r\n    buyer: function(frm) {\r\n        const selectedBuyer = frm.doc.buyer;\r\n        if (!selectedBuyer) {\r\n            frm.set_value('country', '');\r\n            return;\r\n        }\r\n\r\n        // Fetch the country for the selected buyer\r\n        frappe.call({\r\n            method: 'frappe.client.get_value',\r\n            args: {\r\n                doctype: 'Buyer',\r\n                filters: { buyer_name: selectedBuyer },\r\n                fieldname: 'country'\r\n            },\r\n            callback: function(response) {\r\n                if (response.message) {\r\n                    frm.set_value('country', response.message.country || '');\r\n                } else {\r\n                    frm.set_value('country', '');\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error(\"Error fetching buyer country:\", err);\r\n                frappe.msgprint('Error fetching country for the selected buyer.');\r\n            }\r\n        });\r\n    },\r\n    \r\n            \r\n    onload: function(frm) {\r\n                  //  toggle_policy_readonly(frm);\r\n                             frm.enable_save();\r\n\r\n\r\n    if(!frm.doc.ed_number){\r\n\t        generateDDNumber(frm);\r\n        \r\n            }\r\n      //policy holder\r\n//       frappe.call({\r\n//     method: 'frappe.client.get_list',\r\n//     args: {\r\n//         doctype: 'Policy Approvals',\r\n//         filters: {\r\n//             workflow_state: 'Accepted',\r\n//             policy_type: 'ECI'\r\n//         },\r\n//         fields: ['policy_holder'],\r\n//         limit_page_length: 100000\r\n//     },\r\n//     callback: function(response) {\r\n//         if (response.message && response.message.length > 0) {\r\n//             // Extract policy holders from response\r\n//             var approvedHolders = response.message.map(function(row) {\r\n//                 return row.policy_holder;\r\n//             });\r\n\r\n//             console.log(\"Approved Policy Holders in Domestic Declarations:\", approvedHolders);\r\n\r\n//             // Get currently set options from the form field\r\n//             var currentOptions = frm.get_field('policy_holder').df.options || '';\r\n//             var currentOptionsArray = currentOptions.split('\\n').filter(Boolean); // remove empty strings\r\n//             currentOptionsArray.sort();\r\n//             // Combine options and remove duplicates\r\n//             var combinedOptions = currentOptionsArray.concat(approvedHolders).filter(function(item, index, self) {\r\n//                 return self.indexOf(item) === index;\r\n               \r\n//             });\r\n\r\n//             // Set dropdown options\r\n//             frm.set_df_property('policy_holder', 'options', combinedOptions.join('\\n'));\r\n//             frm.refresh_field('policy_holder');\r\n\r\n//         } else {\r\n//             console.log(\"No approved policy holders found in Domestic Declarations.\");\r\n   \r\n//         }\r\n//     },\r\n//     error: function(error) {\r\n//         console.error(\"API call failed:\", error);\r\n//         frappe.msgprint('An error occurred while fetching policy holders from Domestic Declarations. Check console for details.');\r\n//     }\r\n// });\r\n\r\n//Alphabetical order\r\n\r\nfrappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Policy Approvals',\r\n        filters: {\r\n            workflow_state: 'Accepted',\r\n            policy_type: 'ECI'\r\n        },\r\n        fields: ['policy_holder'],\r\n        limit_page_length: 100000\r\n    },\r\n    callback: function(response) {\r\n\r\n        if (response.message && response.message.length > 0) {\r\n\r\n            // Extract list\r\n            let approvedHolders = response.message.map(r => r.policy_holder);\r\n\r\n            // Remove blanks\r\n            approvedHolders = approvedHolders.filter(x => x && x.trim() !== \"\");\r\n\r\n            console.log(\"Approved Policy Holders:\", approvedHolders);\r\n\r\n            // Get existing field options\r\n            let currentOptions = frm.get_field('policy_holder').df.options || \"\";\r\n            let existing = currentOptions\r\n                .split(\"\\n\")\r\n                .filter(x => x && x.trim() !== \"\");\r\n\r\n            // Merge lists\r\n            let combined = [...existing, ...approvedHolders];\r\n\r\n            // Keep unique values only\r\n            combined = [...new Set(combined)];\r\n\r\n            // Sort alphabetically (case-insensitive)\r\n            combined.sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));\r\n\r\n            // Apply back to dropdown\r\n            frm.set_df_property('policy_holder', 'options', combined.join(\"\\n\"));\r\n            frm.refresh_field('policy_holder');\r\n\r\n            // Optional: message when empty\r\n            if (combined.length === 0) {\r\n                frappe.msgprint(\"No policy holders available.\");\r\n            }\r\n\r\n        } else {\r\n\r\n            console.log(\"No approved policy holders found.\");\r\n            frappe.msgprint(\"No approved policy holders found.\");\r\n        }\r\n    },\r\n    error: function(err) {\r\n        console.error(\"API call failed:\", err);\r\n        frappe.msgprint('Error fetching policy holders. Check console.');\r\n    }\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n      //fetch buyer\r\n//       frappe.call({\r\n//         method: 'frappe.client.get_list',\r\n//          args: {\r\n//         doctype: 'Buyer',\r\n//         filters: {'eci': 1},\r\n//         fields: ['buyer_name', 'country'],   // \u2705 Include country field\r\n//         limit_page_length: 10000\r\n//     },\r\n//     callback: function(response) {\r\n//         const buyersData = response.message;\r\n//         frm.buyersData = {};\r\n//         buyersData.forEach(buyer => {\r\n//             frm.buyersData[buyer.buyer_name] = buyer.country;\r\n//         });\r\n\r\n//         frm.set_df_property('buyer', 'options', buyersData.map(b => b.buyer_name));\r\n//     }\r\n// });\r\n\r\nfrappe.call({\r\n    method: \"frappe.client.get_list\",\r\n    args: {\r\n        doctype: \"Buyer\",\r\n        filters: { eci: 1 },\r\n        fields: [\"buyer_name\", \"country\"], // \u2714 country included\r\n        limit_page_length: 10000\r\n    },\r\n    callback: function (response) {\r\n\r\n        const buyers = response.message || [];\r\n\r\n        // \u2714 Prepare a lookup table: buyer_name \u2192 country\r\n        frm.buyersData = {};\r\n        buyers.forEach(b => {\r\n            frm.buyersData[b.buyer_name] = b.country;\r\n        });\r\n\r\n        // \u2714 Set dropdown options ONLY if field exists\r\n        if (frm.fields_dict.buyer) {\r\n            frm.set_df_property(\r\n                \"buyer\",\r\n                \"options\",\r\n                buyers.map(b => b.buyer_name)\r\n            );\r\n        }\r\n    }\r\n});\r\n\r\n\r\n},\r\n      \r\n    policy_holder: function(frm) {\r\n        const policyHolder = frm.doc.policy_holder;\r\n        console.log(\"Selected Policy Holder:\", policyHolder);\r\n\r\n        // Clear policy_number if no holder selected\r\n        if (!policyHolder) {\r\n            frm.set_df_property('policy_number', 'options', '');\r\n            frm.refresh_field('policy_number');\r\n            return;\r\n        }\r\n\r\n        // Fetch policy numbers for this policy holder\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Policy Approvals',\r\n                filters: {\r\n                    policy_holder: policyHolder,\r\n                    policy_type: 'ECI'\r\n                },\r\n                fields: ['policy_number'],\r\n                limit_page_length: 100000\r\n            },\r\n            callback: function(response) {\r\n                if (response.message && response.message.length > 0) {\r\n                    const policyNumbers = response.message.map(row => row.policy_number);\r\n                    console.log(\"Fetched Policy Numbers:\", policyNumbers);\r\n\r\n                    frm.set_df_property('policy_number', 'options', policyNumbers.join('\\n'));\r\n                } else {\r\n                    console.warn(\"No Policy Approvals found for:\", policyHolder);\r\n                    frm.set_df_property('policy_number', 'options', '');\r\n                }\r\n                frm.refresh_field('policy_number');\r\n            },\r\n            error: function(err) {\r\n                console.error(\"Error fetching Policy Approvals:\", err);\r\n                frappe.msgprint('Error fetching policy numbers. Check console for details.');\r\n            }\r\n        });\r\n    },\r\n    \r\n    policy_number: function(frm) {\r\n    const policyNumber = frm.doc.policy_number;\r\n    if (!policyNumber) return;\r\n\r\n    console.log(\"Selected Policy Number:\", policyNumber);\r\n\r\n\r\n    // Fetch policy details\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Policy Approvals',\r\n            filters: {\r\n                policy_number: policyNumber,\r\n                policy_type: 'ECI'\r\n            },\r\n            fields: ['status', 'inception_date', 'expiry_date', 'premium_rate','quotation_numbers'],\r\n            limit_page_length: 1\r\n        },\r\n        callback: function(response) {\r\n            const policyData = response?.message?.[0];\r\n\r\n            if (!policyData) {\r\n                frappe.msgprint('No matching Policy Approval found for this policy number.');\r\n                clearFields();\r\n                return;\r\n            }\r\n\r\n            // Populate fields\r\n            frm.set_value('status', policyData.status || '');\r\n              frm.set_value('quotation_number', policyData.quotation_numbers || '');\r\n            frm.set_value('inception_date', policyData.inception_date || '');\r\n            frm.set_value('policy_expire_date', policyData.expiry_date || '');\r\n            frm.set_value('premium_rate', policyData.premium_rate || '');\r\n        },\r\n        error: function(err) {\r\n            console.error(\"Error fetching Policy Approvals:\", err);\r\n            frappe.msgprint('Error fetching Policy Approvals. Check console.');\r\n        }\r\n    });\r\n},\r\n\r\n    fx_value: function(frm) {\r\n        calculateAmountPula(frm);\r\n    },\r\n    \r\n    exchange_rate: function(frm) {\r\n        calculateAmountPula(frm);\r\n    },\r\n    \r\n    premium_rate: function(frm) {\r\n        calculateAmountPula(frm);\r\n    },\r\n    \r\n    add: function(frm) {\r\n    \r\n\r\n        // Add a new child row\r\n        const child = frappe.model.add_child(frm.doc, \"ExportDeclarationChid\", \"export_declaration\");\r\n\r\n        // Populate the child row\r\n        child.buyer = frm.doc.buyer;\r\n        child.terms_of_payment = frm.doc.terms_of_payment;\r\n        child.exchange_rate = frm.doc.exchange_rate;\r\n        child.fx_value = frm.doc.fx_value;\r\n        child.pula = frm.doc.amount_pula;\r\n        child.premium_rate = frm.doc.premium_rate;\r\n        child.country = frm.doc.country;\r\n        child.amount1 = frm.doc.amount1;\r\n\r\n        // Refresh the table\r\n        frm.refresh_field('export_declaration');\r\n\r\n        // Clear main form fields\r\n        clearFormFields(frm);\r\n    },\r\n    \r\n    prepare_invoice: function(frm) {\r\n\r\n        if (!frm.doc.export_declaration || frm.doc.export_declaration.length === 0) {\r\n            frappe.msgprint(\"No export declaration found.\");\r\n            return;\r\n        }\r\n\r\n        // Create new Export Declaration Invoice\r\n        frappe.model.with_doctype(\"Export Declaration Invoice\", () => {\r\n            let doc = frappe.model.get_new_doc(\"Export Declaration Invoice\");\r\n\r\n            // Set main fields\r\n            doc.policy_holder = frm.doc.policy_holder;\r\n             doc.quotation_number = frm.doc.quotation_number;\r\n             doc.month = frm.doc.month;\r\n              doc.year = frm.doc.year;\r\n\r\n            // Loop through child table rows and insert into new doc\r\n            frm.doc.export_declaration.forEach(row => {\r\n                \r\n                let child = frappe.model.add_child(\r\n                    doc,\r\n                    \"ExportDeclarationInvoiceChild\",   // child doctype\r\n                    \"export_buyer\"                     // child table fieldname\r\n                );\r\n\r\n                // Assign values\r\n                child.buyer = row.buyer;\r\n                // child.turn_over_amt = row.pula;fx_value\r\n                child.turn_over_amt = row.fx_value;\r\n\r\n                child.premium_rate = row.premium_rate;\r\n                child.amount1 = row.amount1;\r\n                child.country = row.country;\r\n            });\r\n\r\n            // Open the new document\r\n            frappe.set_route(\"Form\", \"Export Declaration Invoice\", doc.name);\r\n        });\r\n    }\r\n\r\n});\r\n\r\n\r\nfunction generateDDNumber(frm) {\r\n    // Check if the ed_number field is already populated\r\n    if (!frm.doc.ed_number) {\r\n        // Get the current year\r\n        let currentYear = new Date().getFullYear();\r\n        let prefix = `DCL/${currentYear}/`;\r\n\r\n        // Make a call to get the last Export Declarations number asynchronously\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Export Declarations',\r\n                fields: ['ed_number'],\r\n                limit: 1,\r\n                order_by: 'creation desc'\r\n            },\r\n            callback: function(response) {\r\n                let lastEDNumber = response.message && response.message.length > 0 ? response.message[0].ed_number : '0';\r\n                let lastNumber = parseInt(lastEDNumber.split(\"/\").pop()) || 0; // Extract last part and parse it as integer\r\n\r\n                // Make a call to get the last Domestic Declarations number asynchronously\r\n                frappe.call({\r\n                    method: 'frappe.client.get_list',\r\n                    args: {\r\n                        doctype: 'Domestic Declarations',\r\n                        fields: ['ed_number'],\r\n                        limit: 1,\r\n                        order_by: 'creation desc'\r\n                    },\r\n                    callback: function(response) {\r\n                        let lastDomesticDeclarationsDDNumber = response.message && response.message.length > 0 ? response.message[0].ed_number : '0';\r\n                        let lastDomesticDeclarationsDDNo = parseInt(lastDomesticDeclarationsDDNumber.split(\"/\").pop()) || 0;\r\n\r\n                        // Get the maximum of the last two numbers\r\n                        let maxLastNumber = Math.max(lastNumber, lastDomesticDeclarationsDDNo);\r\n\r\n                        // Increment the last number and pad it with leading zeros\r\n                        let newNumber = (maxLastNumber + 1).toString().padStart(4, '0');\r\n                        frm.set_value('ed_number', prefix + newNumber);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\nfunction calculateAmountPula(frm) {\r\n\r\n    var fx_value = parseFloat(frm.doc.fx_value) || 0;\r\n\r\n    var premium_rate = parseFloat(frm.doc.premium_rate) || 0;\r\n\r\n    var exchange_rate = parseFloat(frm.doc.exchange_rate) || 0;\r\n\r\n    if (exchange_rate === 0) {\r\n\r\n       \r\n\r\n        return;\r\n\r\n    }\r\n\r\n    var amount_pula = fx_value / exchange_rate;\r\n\r\n    var amount1 = premium_rate * amount_pula / 100;\r\n\r\n    frm.set_value('amount_pula', amount_pula.toFixed(2));\r\n\r\n    frm.set_value('amount1', amount1.toFixed(2));\r\n\r\n} \r\n\r\nfunction clearFormFields(frm) {\r\n    ['buyer','terms_of_payment','exchange_rate','fx_value','amount_pula','country','amount1','premium_rate']\r\n    .forEach(f => frm.set_value(f, ''));\r\n}\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Export Declarations",
  "enabled": 1,
  "modified": "2025-12-04 07:21:13.439362",
  "module": null,
  "name": "fetch premium",
  "script": "frappe.ui.form.on('Export Declarations', {\r\n    \r\n\r\n\r\n    policy_number: frm => fetch_premium_rate(frm),\r\n    country: frm => fetch_premium_rate(frm),\r\n    terms_of_payment: frm => fetch_premium_rate(frm),\r\n    policy_holder: frm => {\r\n        if (!frm.policy_review_applied) {\r\n            fetch_premium_rate_from_eci_quotation(frm);\r\n        }\r\n    }\r\n});\r\n\r\n// ---------------------------\r\n// GLOBAL FLAG\r\n// ---------------------------\r\nlet __latest_fetch_request_id = 0;\r\n\r\n// ---------------------------\r\n// HELPER FUNCTIONS\r\n// ---------------------------\r\nfunction parseDateDDMMYYYYorYYYYMMDD(dateStr) {\r\n    if (!dateStr) return null;\r\n\r\n    // Check if it\u2019s DD-MM-YYYY\r\n    if (dateStr.includes('-')) {\r\n        const parts = dateStr.split('-');\r\n        if (parts[0].length === 4) {\r\n            // YYYY-MM-DD\r\n            const year = parseInt(parts[0], 10);\r\n            const month = parseInt(parts[1], 10) - 1;\r\n            const day = parseInt(parts[2], 10);\r\n            return new Date(year, month, day);\r\n        } else {\r\n            // DD-MM-YYYY\r\n            const day = parseInt(parts[0], 10);\r\n            const month = parseInt(parts[1], 10) - 1;\r\n            const year = parseInt(parts[2], 10);\r\n            return new Date(year, month, day);\r\n        }\r\n    }\r\n\r\n    return new Date(dateStr);\r\n}\r\n\r\n\r\n// ---------------------------\r\n// MAIN FETCH LOGIC\r\n// ---------------------------\r\nfunction fetch_premium_rate(frm) {\r\n    if (!frm.doc.policy_number) {\r\n        console.log(\"[Premium Rate] No policy number set, skipping fetch\");\r\n        return;\r\n    }\r\n\r\n    __latest_fetch_request_id += 1;\r\n    const requestId = __latest_fetch_request_id;\r\n\r\n    const month_map = {\r\n        'JANUARY':1,'FEBRUARY':2,'MARCH':3,'APRIL':4,\r\n        'MAY':5,'JUNE':6,'JULY':7,'AUGUST':8,\r\n        'SEPTEMBER':9,'OCTOBER':10,'NOVEMBER':11,'DECEMBER':12\r\n    };\r\n\r\n    const form_month_num = month_map[frm.doc.month?.toUpperCase()];\r\n    const form_year = parseInt(frm.doc.year, 10);\r\n\r\n    console.log(\"[Premium Rate] Form month/year:\", frm.doc.month, form_month_num, form_year);\r\n    console.log(\"[Premium Rate] Policy number:\", frm.doc.policy_number);\r\n\r\n    if (!form_month_num || !form_year) {\r\n        console.log(\"[Premium Rate] Month or year not selected, falling back to ECI quotation\");\r\n        frm.policy_review_applied = false;\r\n        fetch_premium_rate_from_eci_quotation(frm);\r\n        return;\r\n    }\r\n\r\n    // Fetch Policy Reviews\r\n    frappe.call({\r\n        method:\"frappe.client.get_list\",\r\n        args:{\r\n            doctype:\"Policy Reviews\",\r\n            filters:{ policy_no: frm.doc.policy_number.trim() },\r\n            fields:[\"name\",\"period_to\",\"policy_type\"],\r\n            limit_page_length:100\r\n        },\r\n        callback(res){\r\n            if(requestId !== __latest_fetch_request_id) {\r\n                console.log(\"[Premium Rate] Outdated request, skipping response\");\r\n                return;\r\n            }\r\n\r\n            console.log(\"[Premium Rate] Fetched Policy Reviews:\", res.message);\r\n\r\n            // Find Policy Review matching period_to\r\n            const valid_review = (res.message || []).find(r => {\r\n                console.log(\"[Premium Rate] Checking review:\", r);\r\n                if(r.policy_type !== \"ECI\") {\r\n                    console.log(\"[Premium Rate] Skipping review, policy_type not ECI:\", r.policy_type);\r\n                    return false;\r\n                }\r\n\r\n                const period_to = parseDateDDMMYYYYorYYYYMMDD(r.period_to);\r\n\r\n                console.log(\"[Premium Rate] Parsed period_to:\", period_to);\r\n\r\n                if(!period_to) return false;\r\n\r\n                const monthMatch = period_to.getMonth() + 1 === form_month_num;\r\n                const yearMatch = period_to.getFullYear() === form_year;\r\n                console.log(\"[Premium Rate] Month match:\", monthMatch, \"Year match:\", yearMatch);\r\n\r\n                return monthMatch && yearMatch;\r\n            });\r\n\r\n            if(!valid_review){\r\n                console.log(\"[Premium Rate] No matching Policy Review found, falling back to ECI quotation\");\r\n                frm.policy_review_applied = false;\r\n                fetch_premium_rate_from_eci_quotation(frm);\r\n                return;\r\n            }\r\n\r\n            console.log(\"[Premium Rate] Valid Policy Review found:\", valid_review);\r\n\r\n            // Fetch full Policy Review to check child table\r\n            frappe.call({\r\n                method: \"frappe.client.get\",\r\n                args: { doctype: \"Policy Reviews\", name: valid_review.name },\r\n                callback(res2){\r\n                    const rows = res2.message.child_table || [];\r\n                    console.log(\"[Premium Rate] Child table rows:\", rows);\r\n\r\n                    const match = rows.find(row => {\r\n                        const termsMatch = row.terms_of_payment?.trim() === frm.doc.terms_of_payment?.trim();\r\n                        const countryMatch = row.country?.trim() === frm.doc.country?.trim();\r\n                        console.log(\"[Premium Rate] Checking child row:\", row, \"Terms match:\", termsMatch, \"Country match:\", countryMatch);\r\n                        return termsMatch && countryMatch;\r\n                    });\r\n\r\n                    if(match){\r\n                        frm.policy_review_applied = true;\r\n                        frm.set_value(\"premium_rate\", match.pre_rate);\r\n                        console.log(\"[Premium Rate] Matched child row, pre_rate:\", match.pre_rate);\r\n                        frappe.msgprint(`Premium rate ${match.pre_rate} fetched from Policy Reviews`);\r\n                    } else {\r\n                        console.log(\"[Premium Rate] No matching child row, falling back to ECI quotation\");\r\n                        frm.policy_review_applied = false;\r\n                        fetch_premium_rate_from_eci_quotation(frm);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\n\r\n\r\n// ---------------------------\r\n// FALLBACK TO ECI QUOTATION\r\n// ---------------------------\r\nfunction fetch_premium_rate_from_eci_quotation(frm) {\r\n    if (frm.policy_review_applied) return;\r\n\r\n    const { policy_holder, quotation_number, terms_of_payment: terms, country } = frm.doc;\r\n\r\n    if (!policy_holder || !quotation_number || !terms || !country) {\r\n        frm.set_value(\"premium_rate\", 0);\r\n        return;\r\n    }\r\n\r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: \"ECI Quotations\",\r\n            filters: { client_name: policy_holder, schedule_no: quotation_number },\r\n            fields: [\"name\"],\r\n            limit_page_length: 1\r\n        },\r\n        callback(r) {\r\n            if (!r.message || !r.message.length) {\r\n                frm.set_value(\"premium_rate\", 0);\r\n                return;\r\n            }\r\n\r\n            const quotation_name = r.message[0].name;\r\n\r\n            frappe.call({\r\n                method: \"frappe.client.get\",\r\n                args: { doctype: \"ECI Quotations\", name: quotation_name },\r\n                callback(res) {\r\n                    const rows = res.message.eci_quo_table || []; // replace with actual child table fieldname\r\n\r\n                    const match = rows.find(row =>\r\n                        row.payment_terms?.trim() === terms.trim() &&\r\n                        row.country?.trim() === country.trim()\r\n                    );\r\n\r\n                    if (match) {\r\n                        frm.set_value(\"premium_rate\", match.premium_rate);\r\n                        frappe.msgprint(`Premium rate ${match.premium_rate} fetched from ECI Quotations`);\r\n                    } else {\r\n                       // frm.set_value(\"premium_rate\", 0);\r\n                       frappe.msgprint(\"No matching premium rate found. Please enter it manually.\");\r\n\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Credit Note",
  "enabled": 0,
  "modified": "2025-11-27 17:42:01.170328",
  "module": "Finance",
  "name": "new_credit note_script",
  "script": "frappe.ui.form.on('Credit Note', {\r\n    refresh(frm) {\r\n        \r\n          // First time (new form, not saved)\r\n        if (frm.is_new() || frm.doc.__islocal) {\r\n            // Show this only before save\r\n            frm.toggle_display(\"invoice_number\", true);\r\n            frm.toggle_display(\"invoice_no\", false);\r\n        }\r\n\r\n        // After saving document\r\n        else {\r\n            // Show this only after save\r\n            frm.toggle_display(\"invoice_number\", false);\r\n            frm.toggle_display(\"invoice_no\", true);\r\n        }\r\n        frm.fields_dict['total_amountincl_vat'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n       frm.set_df_property('credit_note_child','cannot_add_rows', true); \r\n       frm.fields_dict.internal_invoice.$input.addClass('btn-primary');\r\n        frm.fields_dict.tax_invoice.$input.addClass('btn-primary');\r\n\r\n        set_policy_holder_options(frm);\r\n           toggle_sections_based_on_invoice(frm, frm.doc.invoice_number);\r\n    },\r\n    policy_holder(frm) {\r\n        if (frm.doc.policy_holder) {\r\n            set_invoice_numbers(frm, frm.doc.policy_holder);\r\n        }\r\n    },\r\n     invoice_number(frm) {\r\n        if (frm.doc.invoice_number) {\r\n                    toggle_sections_based_on_invoice(frm, frm.doc.invoice_number);\r\n frm.set_value(\"invoice_no\", frm.doc.invoice_number);\r\n            fetch_invoice_details(frm, frm.doc.invoice_number);\r\n             load_ci_invoice_child(frm, frm.doc.invoice_number);\r\n             generate_credit_note_no(frm, frm.doc.invoice_number);\r\n        }\r\n    },\r\n    \r\n    tax_invoice: function(frm) {\r\n\r\n    // 1\ufe0f\u20e3 First fetch Company Details\r\n    frappe.call({\r\n        method: \"frappe.client.get_value\",\r\n        args: {\r\n            doctype: \"Company-Details\",\r\n            fieldname: [\r\n                \"telephone\",\r\n                \"fax\",\r\n                \"postal_address\",\r\n                \"location\",\r\n                \"contact_person\",\r\n                \"vat_reg_no\",\r\n                \"country\"\r\n            ],\r\n            filters: { name: frm.doc.policy_holder }\r\n        },\r\n\r\n        callback: function(r1) {\r\n            if (!r1.message) {\r\n                frappe.msgprint(\"Company Details not found!\");\r\n                return;\r\n            }\r\n\r\n            // Extract Company Details\r\n            let telephone = r1.message.telephone;\r\n            let fax = r1.message.fax;\r\n            let postal_address = r1.message.postal_address;\r\n            let location = r1.message.location;\r\n            let contact_person = r1.message.contact_person;\r\n            let vat_reg_no = r1.message.vat_reg_no;\r\n            let country = r1.message.country;\r\n\r\n            // 2\ufe0f\u20e3 Fetch Policy Number Next\r\n            frappe.call({\r\n                method: \"frappe.client.get_value\",\r\n                args: {\r\n                    doctype: \"Policy Approvals\",\r\n                    fieldname: [\"policy_number\"],\r\n                    filters: { policy_holder: frm.doc.policy_holder }\r\n                },\r\n\r\n                callback: function(r2) {\r\n                    let policy_number = r2.message?.policy_number || \"\";\r\n\r\n                    // 3\ufe0f\u20e3 Set route options AFTER fetching all data\r\n                    frappe.route_options = {\r\n                        invoice1: frm.doc.policy_holder,\r\n                        date1: frm.doc.invoice_date,\r\n                        invoice2: frm.doc.invoice_no,\r\n                        sub_total: frm.doc.vat,\r\n                        month: frm.doc.month,\r\n                        quotation_number :frm.doc.quotation_number,\r\n\r\n                        // Company Details\r\n                        telephone: telephone,\r\n                        fax: fax,\r\n                        address: postal_address,\r\n                        city: location,\r\n                        attn: contact_person,\r\n                        vat: vat_reg_no,\r\n                        country: country,\r\n\r\n                        // Policy Number\r\n                        reference1: policy_number\r\n                    };\r\n\r\n                    // 4\ufe0f\u20e3 Finally route to new Doc\r\n                    frappe.new_doc(\"Tax Invoice For CI Invoice\");\r\n                }\r\n            });\r\n        }\r\n    });\r\n    \r\n},\r\n\r\n   internal_invoice: function (frm) {\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_value',\r\n        args: {\r\n            doctype: 'Company-Details',\r\n            fieldname: ['postal_address', 'location', 'vat_reg_no'],\r\n            filters: { name: frm.doc.policy_holder }\r\n        },\r\n\r\n        callback: function (r) {\r\n\r\n            if (!r.message) {\r\n                frappe.msgprint(__('Company details not found for the selected Policy Holder.'));\r\n                return;\r\n            }\r\n\r\n            // Route options for main fields\r\n            frappe.route_options = {\r\n                name1: frm.doc.policy_holder,\r\n                 invoice_no: frm.doc.invoice_no,\r\n                 quotation_number:frm.doc.quotation_number,\r\n                date: frm.doc.invoice_date,\r\n                address: r.message.postal_address,\r\n                city: r.message.location,\r\n                vat: r.message.vat_reg_no\r\n            };\r\n\r\n            // Create new Internal Invoice\r\n            frappe.new_doc('Internal Invoice for CI Invoice');\r\n\r\n            // No child table rows added for now\r\n        }\r\n    });\r\n\r\n},\r\n\r\n  \r\n   \r\n});\r\n\r\nfunction set_policy_holder_options(frm) {\r\n\r\n    let holders = new Set();   // To avoid duplicates\r\n\r\n    // 1. Fetch from Bond Invoice (facility_name)\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Bond Invoice',\r\n            fields: ['facility_name'],\r\n            limit_page_length: 0\r\n        },\r\n        callback: function(r1) {\r\n\r\n            (r1.message || []).forEach(row => {\r\n                if (row.facility_name) holders.add(row.facility_name);\r\n            });\r\n\r\n            // 2. Fetch from CI Invoices (policy_holder)\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'CI Invoices',\r\n                    fields: ['policy_holder'],\r\n                    limit_page_length: 0\r\n                },\r\n                callback: function(r2) {\r\n\r\n                    (r2.message || []).forEach(row => {\r\n                        if (row.policy_holder) holders.add(row.policy_holder);\r\n                    });\r\n\r\n                    // 3. Fetch from LOI Invoice (client_name)\r\n                    frappe.call({\r\n                        method: 'frappe.client.get_list',\r\n                        args: {\r\n                            doctype: 'LOI Invoice',\r\n                            fields: ['client_name'],\r\n                            limit_page_length: 0\r\n                        },\r\n                        callback: function(r3) {\r\n\r\n                            (r3.message || []).forEach(row => {\r\n                                if (row.client_name) holders.add(row.client_name);\r\n                            });\r\n\r\n                            // Convert Set to Array\r\n                            let holder_list = Array.from(holders);\r\n\r\n                            // Update dropdown options\r\n                            frm.set_df_property('policy_holder', 'options', holder_list);\r\n\r\n                            frm.refresh_field('policy_holder');\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\n\r\nfunction set_invoice_numbers(frm, holder) {\r\n\r\n    let invoices = new Set();\r\n\r\n    // 1. Bond Invoice \u2192 bond_no (match facility_name)\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Bond Invoice',\r\n            filters: { facility_name: holder },\r\n            fields: ['bond_no'],\r\n            limit_page_length: 1000\r\n        },\r\n        callback: function(r1) {\r\n\r\n            (r1.message || []).forEach(row => {\r\n                if (row.bond_no) invoices.add(row.bond_no);\r\n            });\r\n\r\n            // 2. CI Invoices \u2192 invoice_no (match policy_holder)\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'CI Invoices',\r\n                    filters: { policy_holder: holder },\r\n                    fields: ['invoice_no'],\r\n                    limit_page_length: 1000\r\n                },\r\n                callback: function(r2) {\r\n\r\n                    (r2.message || []).forEach(row => {\r\n                        if (row.invoice_no) invoices.add(row.invoice_no);\r\n                    });\r\n\r\n                    // 3. LOI Invoice \u2192 invoice_no (match client_name)\r\n                    frappe.call({\r\n                        method: 'frappe.client.get_list',\r\n                        args: {\r\n                            doctype: 'LOI Invoice',\r\n                            filters: { client_name: holder },\r\n                            fields: ['invoice_no'],\r\n                            limit_page_length: 1000\r\n                        },\r\n                        callback: function(r3) {\r\n\r\n                            (r3.message || []).forEach(row => {\r\n                                if (row.invoice_no) invoices.add(row.invoice_no);\r\n                            });\r\n\r\n                            // Convert set to array\r\n                            let options = Array.from(invoices);\r\n\r\n                            // Set dropdown field options\r\n                            frm.set_df_property('invoice_number', 'options', options);\r\n\r\n                            frm.refresh_field('invoice_number');\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\nfunction fetch_invoice_details(frm, invoice_number) {\r\n\r\n    // Utility function to format amount\r\n    function format_amount(value) {\r\n        let num = parseFloat(value);\r\n        if (isNaN(num)) num = 0;\r\n        return num.toFixed(2);\r\n    }\r\n\r\n    // 1\ufe0f\u20e3 Bond Invoice\r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: \"Bond Invoice\",\r\n            filters: { bond_no: invoice_number },\r\n            fields: [\"invoice_date\", \"vat\", \"total_due\"]\r\n        },\r\n        callback(r1) {\r\n\r\n            if (r1.message?.length) {\r\n\r\n                let d = r1.message[0];\r\n\r\n                frm.set_value(\"invoice_date\", d.invoice_date || \"\");\r\n                frm.set_value(\"vat\", d.vat || \"\");\r\n\r\n                frm.set_value(\"total_amountincl_vat\", format_amount(d.total_due));\r\n\r\n                return;\r\n            }\r\n\r\n            // 2\ufe0f\u20e3 CI / Prepare Invoice\r\n            frappe.call({\r\n                method: \"frappe.client.get_list\",\r\n                args: {\r\n                    doctype: \"CI Invoices\",\r\n                    filters: { invoice_no: invoice_number },\r\n                    fields: [\"invoice_date\", \"vat\", \"invoice_amount_without_vat\"]\r\n                },\r\n                callback(r2) {\r\n\r\n                    if (r2.message?.length) {\r\n\r\n                        let d = r2.message[0];\r\n\r\n                        frm.set_value(\"invoice_date\", d.invoice_date || \"\");\r\n                        frm.set_value(\"vat\", d.vat || \"\");\r\n\r\n                        frm.set_value(\"total_amountincl_vat\", format_amount(d.invoice_amount_without_vat));\r\n\r\n                        return;\r\n                    }\r\n\r\n                    // 3\ufe0f\u20e3 LOI Invoice\r\n                    frappe.call({\r\n                        method: \"frappe.client.get_list\",\r\n                        args: {\r\n                            doctype: \"LOI Invoice\",\r\n                            filters: { invoice_no: invoice_number },\r\n                            fields: [\"invoice_date\", \"vat\", \"invoice_amount\"]\r\n                        },\r\n                        callback(r3) {\r\n\r\n                            if (r3.message?.length) {\r\n\r\n                                let d = r3.message[0];\r\n\r\n                                frm.set_value(\"invoice_date\", d.invoice_date || \"\");\r\n                                frm.set_value(\"vat\", d.vat || \"\");\r\n\r\n                                frm.set_value(\"total_amountincl_vat\", format_amount(d.invoice_amount));\r\n\r\n                                return;\r\n                            }\r\n\r\n                            // \u274c No match anywhere \u2192 set defaults\r\n                            frm.set_value(\"invoice_date\", \"\");\r\n                            frm.set_value(\"vat\", \"\");\r\n                            frm.set_value(\"total_amountincl_vat\", \"0.00\");\r\n\r\n                            frappe.msgprint(\"No invoice details found for this invoice number.\");\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\n\r\n\r\nfunction load_ci_invoice_child(frm, invoice_number) {\r\n\r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: \"CI Invoices\",\r\n            filters: { invoice_no: invoice_number },\r\n            fields: [\"name\"]\r\n        },\r\n        callback(res) {\r\n\r\n            if (!res.message?.length) return;\r\n\r\n            let docname = res.message[0].name;\r\n\r\n            // Load full document\r\n          frappe.call({\r\n                method: \"frappe.client.get\",\r\n                args: {\r\n                    doctype: \"CI Invoices\",\r\n                    name: docname\r\n                },\r\n                callback: function(r) {\r\n                    console.log(\"Loaded CI Invoice \u2192\", r);\r\n\r\n                    if (r.message && r.message.export_buyer) {\r\n\r\n                        frm.clear_table('credit_note_child');\r\n\r\n                        r.message.export_buyer.forEach(function(buyer) {\r\n                            \r\n                            let child = frm.add_child(\"credit_note_child\");\r\n\r\n                            child.country = buyer.country;\r\n                            child.buyer = buyer.buyer;\r\n                           child.dcl_amt = Number(buyer.declamt || 0).toFixed(2);\r\n                            child.premium_rate = Number(buyer.premium_rate || 0).toFixed(2);\r\n                            child.amount = Number(buyer.premamount || 0).toFixed(2);\r\n                        });\r\n\r\n                        frm.refresh_field(\"credit_note_child\");\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\n\r\n\r\n// function generate_credit_note_no(frm, invoice_number) {\r\n//     if (!invoice_number) return;\r\n\r\n//     let prefix = \"\";\r\n//     let year = \"\";\r\n//     let seriesType = \"\";\r\n\r\n//     let s = invoice_number.split(\"/\");\r\n\r\n//     // ===============================================\r\n//     // CASE 1 \u2192 CI INVOICE NEW (INV/2025/0051)\r\n//     // ===============================================\r\n//     if (invoice_number.startsWith(\"INV/\") && !invoice_number.includes(\"BND\")) {\r\n\r\n//         prefix = \"INV\";\r\n//         year = s[1];\r\n//         seriesType = \"DCR\";   // Same as your requirement\r\n//     }\r\n\r\n//     // ===============================================\r\n//     // CASE 2 \u2192 BOND INVOICE (BND/2025/0018)\r\n//     // ===============================================\r\n//     else if (invoice_number.startsWith(\"BND/\")) {\r\n\r\n//         prefix = \"INV\";       // You need INV always\r\n//         year = s[1];\r\n//         seriesType = \"ECR\";\r\n//     }\r\n\r\n//     // ===============================================\r\n//     // CASE 3 \u2192 LOI INVOICE (INV/BND/2025/0002)\r\n//     // ===============================================\r\n//     else if (invoice_number.startsWith(\"INV/BND/\")) {\r\n\r\n//         prefix = \"INV/BND\";\r\n//         year = s[2];\r\n//         seriesType = \"LCR\";\r\n//     }\r\n\r\n//     // UNKNOWN FORMAT\r\n//     else {\r\n//         frappe.msgprint(\"Unknown invoice number format: \" + invoice_number);\r\n//         return;\r\n//     }\r\n\r\n//     // Build credit note prefix\r\n//     let creditPrefix = `${prefix}/${year}/${seriesType}`;\r\n\r\n//     // =======================================================\r\n//     // FETCH LAST CREDIT NOTE HAVING SAME PREFIX\r\n//     // =======================================================\r\n//     frappe.call({\r\n//         method: \"frappe.client.get_list\",\r\n//         args: {\r\n//             doctype: \"Credit Note\",\r\n//             filters: {\r\n//                 credit_note_no: [\"like\", creditPrefix + \"%\"]\r\n//             },\r\n//             fields: [\"credit_note_no\"],\r\n//             order_by: \"creation desc\",\r\n//             limit: 1\r\n//         },\r\n//         callback: function (r) {\r\n//             let newNumber = \"001\";\r\n\r\n//             if (r.message && r.message.length > 0) {\r\n//                 let last = r.message[0].invoice_number;\r\n\r\n//                 let lastNum = last.replace(creditPrefix, \"\").trim();\r\n\r\n//                 if (!isNaN(lastNum)) {\r\n//                     newNumber = (parseInt(lastNum) + 1)\r\n//                         .toString()\r\n//                         .padStart(3, \"0\");\r\n//                 }\r\n//             }\r\n\r\n//             // FINAL OUTPUT\r\n//             frm.set_value(\"credit_note_no\", `${creditPrefix}${newNumber}`);\r\n//         }\r\n//     });\r\n// }\r\n\r\n\r\nfunction generate_credit_note_no(frm, invoice_number) {\r\n    if (!invoice_number) return;\r\n\r\n    let prefix = \"\";\r\n    let year = \"\";\r\n    let seriesType = \"\";\r\n\r\n    let s = invoice_number.split(\"/\");\r\n\r\n    // ===============================================\r\n    // CASE 1 \u2192 CI INVOICE NEW (INV/2025/0051)\r\n    // ===============================================\r\n    if (invoice_number.startsWith(\"INV/\") && !invoice_number.includes(\"BND\")) {\r\n        prefix = \"INV\";\r\n        year = s[1];\r\n        seriesType = \"DCR\";\r\n    }\r\n\r\n    // ===============================================\r\n    // CASE 2 \u2192 BOND INVOICE (BND/2025/0018)\r\n    // ===============================================\r\n    else if (invoice_number.startsWith(\"BND/\")) {\r\n        prefix = \"INV\";\r\n        year = s[1];\r\n        seriesType = \"ECR\";\r\n    }\r\n\r\n    // ===============================================\r\n    // CASE 3 \u2192 LOI (INV/BND/2025/0002)\r\n    // ===============================================\r\n    else if (invoice_number.startsWith(\"INV/BND/\")) {\r\n        prefix = \"INV/BND\";\r\n        year = s[2];\r\n        seriesType = \"LCR\";\r\n    }\r\n\r\n    else {\r\n        frappe.msgprint(\"Unknown invoice number format: \" + invoice_number);\r\n        return;\r\n    }\r\n\r\n    let creditPrefix = `${prefix}/${year}/${seriesType}`;\r\n\r\n    // =======================================================\r\n    //  FETCH LAST CREDIT NOTE FOR SAME PREFIX\r\n    // =======================================================\r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: \"Credit Note\",\r\n            filters: {\r\n                credit_note_no: [\"like\", creditPrefix + \"%\"]\r\n            },\r\n            fields: [\"credit_note_no\"],\r\n            order_by: \"creation desc\",\r\n            limit: 1\r\n        },\r\n        callback: function (r) {\r\n\r\n            let newNumber = \"001\";\r\n\r\n            if (r.message && r.message.length > 0) {\r\n\r\n                // FIXED \u2192 Correct field name\r\n                let last = r.message[0].credit_note_no;\r\n\r\n                // Remove prefix to get only the number\r\n                let lastNum = last.replace(creditPrefix, \"\").trim();\r\n\r\n                if (!isNaN(lastNum)) {\r\n                    newNumber = (parseInt(lastNum) + 1)\r\n                        .toString()\r\n                        .padStart(3, \"0\");\r\n                }\r\n            }\r\n\r\n            // SET FINAL AUTO GENERATED NUMBER\r\n            frm.set_value(\"credit_note_no\", `${creditPrefix}${newNumber}`);\r\n        }\r\n    });\r\n}\r\n\r\n\r\n\r\nfunction toggle_sections_based_on_invoice(frm, invoice_number) {\r\n\r\n    let is_ci_invoice = false;\r\n\r\n    // CI Invoice format \u2192 INV/2025/0051 (NOT INV/BND/2025/0002)\r\n    if (invoice_number.startsWith(\"INV/\") && !invoice_number.includes(\"/BND/\")) {\r\n        is_ci_invoice = true;\r\n    }\r\n\r\n    // Show only for CI Invoice\r\n    frm.toggle_display(\"credit_note_child\", is_ci_invoice);\r\n    frm.toggle_display(\"invoce_details\", is_ci_invoice);   // <-- HTML Heading\r\n}\r\n\r\n\r\n\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Debit Note",
  "enabled": 0,
  "modified": "2025-11-27 20:40:34.355488",
  "module": "Finance",
  "name": "New_Debit Note",
  "script": "frappe.ui.form.on('Debit Note', {\n refresh(frm) {\n     \n      if (frm.is_new() || frm.doc.__islocal) {\n            // Show this only before save\n            frm.toggle_display(\"invoice_number\", true);\n            frm.toggle_display(\"invoice_no\", false);\n        }\n\n        // After saving document\n        else {\n            // Show this only after save\n            frm.toggle_display(\"invoice_number\", false);\n            frm.toggle_display(\"invoice_no\", true);\n        }\nfrm.fields_dict.internal_invoice.$input.addClass('btn-primary');\n        frm.fields_dict.tax_invoice.$input.addClass('btn-primary');\n        frm.fields_dict['total_amountincl_vat'].$wrapper.find('input')\n            .css(\"text-align\", \"right\");\n\n        frm.set_df_property('debit_note_child_table','cannot_add_rows', true);\n\n        set_policy_holder_options(frm);\n          toggle_sections_based_on_invoice(frm, frm.doc.invoice_number);\n    },\n\n    policy_holder(frm) {\n        if (frm.doc.policy_holder) {\n            set_invoice_numbers(frm, frm.doc.policy_holder);\n        }\n    },\n\n    invoice_number(frm) {\n        if (frm.doc.invoice_number) {\n             toggle_sections_based_on_invoice(frm, frm.doc.invoice_number);\n\n            fetch_invoice_details(frm, frm.doc.invoice_number);\n            load_ci_invoice_child(frm, frm.doc.invoice_number);\n            generate_debit_note_no(frm, frm.doc.invoice_number);\n        }\n         frm.set_value(\"invoice_no\", frm.doc.invoice_number);\n        \n    },\n    \n     tax_invoice: function(frm) {\n\n    // 1\ufe0f\u20e3 First fetch Company Details\n    frappe.call({\n        method: \"frappe.client.get_value\",\n        args: {\n            doctype: \"Company-Details\",\n            fieldname: [\n                \"telephone\",\n                \"fax\",\n                \"postal_address\",\n                \"location\",\n                \"contact_person\",\n                \"vat_reg_no\",\n                \"country\"\n            ],\n            filters: { name: frm.doc.policy_holder }\n        },\n\n        callback: function(r1) {\n            if (!r1.message) {\n                frappe.msgprint(\"Company Details not found!\");\n                return;\n            }\n\n            // Extract Company Details\n            let telephone = r1.message.telephone;\n            let fax = r1.message.fax;\n            let postal_address = r1.message.postal_address;\n            let location = r1.message.location;\n            let contact_person = r1.message.contact_person;\n            let vat_reg_no = r1.message.vat_reg_no;\n            let country = r1.message.country;\n\n            // 2\ufe0f\u20e3 Fetch Policy Number Next\n            frappe.call({\n                method: \"frappe.client.get_value\",\n                args: {\n                    doctype: \"Policy Approvals\",\n                    fieldname: [\"policy_number\"],\n                    filters: { policy_holder: frm.doc.policy_holder }\n                },\n\n                callback: function(r2) {\n                    let policy_number = r2.message?.policy_number || \"\";\n\n                    // 3\ufe0f\u20e3 Set route options AFTER fetching all data\n                    frappe.route_options = {\n                        invoice1: frm.doc.policy_holder,\n                        date1: frm.doc.invoice_date,\n                        invoice2: frm.doc.invoice_number,\n                        sub_total: frm.doc.vat,\n                      // month: frm.doc.month,\n                      // quotation_number :frm.doc.quotation_number,\n\n                        // Company Details\n                        telephone: telephone,\n                        fax: fax,\n                        address: postal_address,\n                        city: location,\n                        attn: contact_person,\n                        vat: vat_reg_no,\n                        country: country,\n\n                        // Policy Number\n                        reference1: policy_number\n                    };\n\n                    // 4\ufe0f\u20e3 Finally route to new Doc\n                    frappe.new_doc(\"Tax Invoice For CI Invoice\");\n                }\n            });\n        }\n    });\n    \n},\n\n\n\n\n\n    internal_invoice: function (frm) {\n\n    frappe.call({\n        method: 'frappe.client.get_value',\n        args: {\n            doctype: 'Company-Details',\n            fieldname: ['postal_address', 'location', 'vat_reg_no'],\n            filters: { name: frm.doc.policy_holder }\n        },\n\n        callback: function (r) {\n\n            if (!r.message) {\n                frappe.msgprint(__('Company details not found for the selected Policy Holder.'));\n                return;\n            }\n\n            // Route options for main fields\n            frappe.route_options = {\n                name1: frm.doc.policy_holder,\n                 invoice_no: frm.doc.invoice_no,\n                 quotation_number:frm.doc.quotation_number,\n                date: frm.doc.invoice_date,\n                address: r.message.postal_address,\n                city: r.message.location,\n                vat: r.message.vat_reg_no\n            };\n\n            // Create new Internal Invoice\n            frappe.new_doc('Internal Invoice for CI Invoice');\n\n            // No child table rows added for now\n        }\n    });\n\n},\n\n   \n});\n\nfunction set_policy_holder_options(frm) {\n\n    let holders = new Set();   // To avoid duplicates\n\n    // 1. Fetch from Bond Invoice (facility_name)\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Bond Invoice',\n            fields: ['facility_name'],\n            limit_page_length: 0\n        },\n        callback: function(r1) {\n\n            (r1.message || []).forEach(row => {\n                if (row.facility_name) holders.add(row.facility_name);\n            });\n\n            // 2. Fetch from CI Invoices (policy_holder)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'CI Invoices',\n                    fields: ['policy_holder'],\n                    limit_page_length: 0\n                },\n                callback: function(r2) {\n\n                    (r2.message || []).forEach(row => {\n                        if (row.policy_holder) holders.add(row.policy_holder);\n                    });\n\n                    // 3. Fetch from LOI Invoice (client_name)\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'LOI Invoice',\n                            fields: ['client_name'],\n                            limit_page_length: 0\n                        },\n                        callback: function(r3) {\n\n                            (r3.message || []).forEach(row => {\n                                if (row.client_name) holders.add(row.client_name);\n                            });\n\n                            // Convert Set to Array\n                            let holder_list = Array.from(holders);\n\n                            // Update dropdown options\n                            frm.set_df_property('policy_holder', 'options', holder_list);\n\n                            frm.refresh_field('policy_holder');\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction set_invoice_numbers(frm, holder) {\n\n    let invoices = new Set();\n\n    // 1. Bond Invoice\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Bond Invoice',\n            filters: { facility_name: holder },\n            fields: ['bond_no']\n        },\n        callback(r1) {\n\n            (r1.message || []).forEach(row => {\n                if (row.bond_no) invoices.add(row.bond_no);\n            });\n\n            // 2. CI Invoice\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'CI Invoices',\n                    filters: { policy_holder: holder },\n                    fields: ['invoice_no']\n                },\n                callback(r2) {\n\n                    (r2.message || []).forEach(row => {\n                        if (row.invoice_no) invoices.add(row.invoice_no);\n                    });\n\n                    // 3. LOI Invoice\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'LOI Invoice',\n                            filters: { client_name: holder },\n                            fields: ['invoice_no']\n                        },\n                        callback(r3) {\n\n                            (r3.message || []).forEach(row => {\n                                if (row.invoice_no) invoices.add(row.invoice_no);\n                            });\n\n                            frm.set_df_property(\n                                'invoice_number',\n                                'options',\n                                Array.from(invoices)\n                            );\n\n                            frm.refresh_field('invoice_number');\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\nfunction fetch_invoice_details(frm, invoice_number) {\n\n    // Utility function to format amount\n    function format_amount(value) {\n        let num = parseFloat(value);\n        if (isNaN(num)) num = 0;\n        return num.toFixed(2);\n    }\n\n    // 1\ufe0f\u20e3 Bond Invoice\n    frappe.call({\n        method: \"frappe.client.get_list\",\n        args: {\n            doctype: \"Bond Invoice\",\n            filters: { bond_no: invoice_number },\n            fields: [\"invoice_date\", \"vat\", \"total_due\"]\n        },\n        callback(r1) {\n\n            if (r1.message?.length) {\n\n                let d = r1.message[0];\n\n                frm.set_value(\"invoice_date\", d.invoice_date || \"\");\n                frm.set_value(\"vat\", d.vat || \"\");\n\n                frm.set_value(\"total_amountincl_vat\", format_amount(d.total_due));\n\n                return;\n            }\n\n            // 2\ufe0f\u20e3 CI / Prepare Invoice\n            frappe.call({\n                method: \"frappe.client.get_list\",\n                args: {\n                    doctype: \"CI Invoices\",\n                    filters: { invoice_no: invoice_number },\n                    fields: [\"invoice_date\", \"vat\", \"invoice_amount_without_vat\"]\n                },\n                callback(r2) {\n\n                    if (r2.message?.length) {\n\n                        let d = r2.message[0];\n\n                        frm.set_value(\"invoice_date\", d.invoice_date || \"\");\n                        frm.set_value(\"vat\", d.vat || \"\");\n\n                        frm.set_value(\"total_amountincl_vat\", format_amount(d.invoice_amount_without_vat));\n\n                        return;\n                    }\n\n                    // 3\ufe0f\u20e3 LOI Invoice\n                    frappe.call({\n                        method: \"frappe.client.get_list\",\n                        args: {\n                            doctype: \"LOI Invoice\",\n                            filters: { invoice_no: invoice_number },\n                            fields: [\"invoice_date\", \"vat\", \"invoice_amount\"]\n                        },\n                        callback(r3) {\n\n                            if (r3.message?.length) {\n\n                                let d = r3.message[0];\n\n                                frm.set_value(\"invoice_date\", d.invoice_date || \"\");\n                                frm.set_value(\"vat\", d.vat || \"\");\n\n                                frm.set_value(\"total_amountincl_vat\", format_amount(d.invoice_amount));\n\n                                return;\n                            }\n\n                            // \u274c No match anywhere \u2192 set defaults\n                            frm.set_value(\"invoice_date\", \"\");\n                            frm.set_value(\"vat\", \"\");\n                            frm.set_value(\"total_amountincl_vat\", \"0.00\");\n\n                            frappe.msgprint(\"No invoice details found for this invoice number.\");\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction load_ci_invoice_child(frm, invoice_number) {\n\n    frappe.call({\n        method: \"frappe.client.get_list\",\n        args: {\n            doctype: \"CI Invoices\",\n            filters: { invoice_no: invoice_number },\n            fields: [\"name\"]\n        },\n        callback(res) {\n\n            if (!res.message?.length) return;\n\n            let docname = res.message[0].name;\n\n            // Load full document\n            frappe.call({\n                method: \"frappe.client.get\",\n                args: { doctype: \"CI Invoices\", name: docname },\n                callback(r) {\n\n                    if (r.message?.export_buyer) {\n\n                        frm.clear_table('debit_note_child_table');\n\n                        r.message.export_buyer.forEach(buyer => {\n\n                            let child = frm.add_child(\"debit_note_child_table\");\n\n                            child.country = buyer.country;\n                            child.buyer = buyer.buyer;\n                         child.dclamt = Number(buyer.declamt || 0).toFixed(2); \n                         child.premium_rate = Number(buyer.premium_rate || 0).toFixed(2); \n                         child.amount = Number(buyer.premamount || 0).toFixed(2);\n                        });\n\n                        frm.refresh_field(\"debit_note_child_table\");\n                    }\n                }\n            });\n        }\n    });\n}\n\n\n\nfunction generate_debit_note_no(frm, invoice_number) {\n    if (!invoice_number) return;\n\n    let prefix = \"\";\n    let year = \"\";\n    let seriesType = \"\";\n\n    let s = invoice_number.split(\"/\");\n\n    // ===============================================\n    // CASE 1 \u2192 CI INVOICE NEW (INV/2025/0051)\n    // ===============================================\n    if (invoice_number.startsWith(\"INV/\") && !invoice_number.includes(\"BND\")) {\n\n        prefix = \"INV\";\n        year = s[1];\n        seriesType = \"DCR\";   // Your required format for CI\n    }\n\n    // ===============================================\n    // CASE 2 \u2192 BOND INVOICE (BND/2025/0018)\n    // ===============================================\n    else if (invoice_number.startsWith(\"BND/\")) {\n\n        prefix = \"INV\";       // You requested INV always\n        year = s[1];\n        seriesType = \"ECR\";\n    }\n\n    // ===============================================\n    // CASE 3 \u2192 LOI INVOICE (INV/BND/2025/0002)\n    // ===============================================\n    else if (invoice_number.startsWith(\"INV/BND/\")) {\n\n        prefix = \"INV/BND\";\n        year = s[2];\n        seriesType = \"LCR\";\n    }\n\n    // UNKNOWN FORMAT\n    else {\n        frappe.msgprint(\"Unknown invoice number format: \" + invoice_number);\n        return;\n    }\n\n    // Build prefix for searching existing notes\n    let debitPrefix = `${prefix}/${year}/${seriesType}`;\n\n    // =======================================================\n    // FETCH LAST DEBIT NOTE HAVING SAME PREFIX\n    // =======================================================\n    frappe.call({\n        method: \"frappe.client.get_list\",\n        args: {\n            doctype: \"Debit Note\",\n            filters: {\n                dedbit_note_no: [\"like\", debitPrefix + \"%\"]\n            },\n            fields: [\"dedbit_note_no\"],\n            order_by: \"creation desc\",\n            limit: 1\n        },\n        callback: function (r) {\n\n            let newNumber = \"001\";\n\n            if (r.message && r.message.length > 0) {\n                let last = r.message[0].dedbit_note_no;\n\n                let lastNum = last.replace(debitPrefix, \"\").trim();\n\n                if (!isNaN(lastNum)) {\n                    newNumber = (parseInt(lastNum) + 1)\n                        .toString()\n                        .padStart(3, \"0\");\n                }\n            }\n\n            // FINAL OUTPUT\n            frm.set_value(\"dedbit_note_no\", `${debitPrefix}${newNumber}`);\n        }\n    });\n}\n\n\nfunction toggle_sections_based_on_invoice(frm, invoice_number) {\n\n    let is_ci_invoice = false;\n\n    // CI Invoice format \u2192 INV/2025/0051 (NOT INV/BND/2025/0002)\n    if (invoice_number.startsWith(\"INV/\") && !invoice_number.includes(\"/BND/\")) {\n        is_ci_invoice = true;\n    }\n\n    // Show only for CI Invoice\n    frm.toggle_display(\"debit_note_child_table\", is_ci_invoice);\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Advance Premium Invoice",
  "enabled": 1,
  "modified": "2025-12-02 19:54:39.318446",
  "module": null,
  "name": "Advance Premium Invoice",
  "script": "frappe.ui.form.on(\"Advance Premium Invoice\", {\r\n    onload: function(frm) {\r\n        if (frappe.flags._ap_data) {\r\n            Object.keys(frappe.flags._ap_data).forEach(key => {\r\n                frm.set_value(key, frappe.flags._ap_data[key]);\r\n            });\r\n        }\r\n    },\r\n    \r\n      refresh(frm) {\r\n  frm.fields_dict.back.$input.addClass('btn-primary');\r\n        // CASE 1: New document \u2192 show Save button\r\n        if (frm.is_new()) {\r\n            frm.enable_save();\r\n \r\n            setTimeout(() => {\r\n                frm.page.btn_primary.show();   // Show Save button\r\n            }, 50);\r\n        }\r\n \r\n        // CASE 2: Existing document \u2192 hide Save button\r\n        else {\r\n            frm.disable_save();\r\n \r\n            setTimeout(() => {\r\n                frm.page.btn_primary.hide();   // Hide Save\r\n                $('button[data-label=\"Save\"]').hide(); // Hide in menu\r\n            }, 50);\r\n        }\r\n    },\r\n    \r\n  back: function(frm) {\r\n    if (!frm.doc.policy_holder) {\r\n        frappe.msgprint(\"Policy Holder not found.\");\r\n        return;\r\n    }\r\n\r\n    // Find the matching Advance Premium record\r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: \"Advance Premium\",\r\n            filters: {\r\n                policy_holder: frm.doc.policy_holder\r\n            },\r\n            fields: [\"name\"],\r\n            limit_page_length: 1\r\n        },\r\n        callback(res) {\r\n            if (res.message && res.message.length > 0) {\r\n                // Open the SAME document\r\n                frappe.set_route(\"Form\", \"Advance Premium\", res.message[0].name);\r\n            } else {\r\n                frappe.msgprint(\"No Advance Premium record found for this Policy Holder.\");\r\n                frappe.set_route(\"List\", \"Advance Premium\");\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Bond Application",
  "enabled": 0,
  "modified": "2025-12-01 08:50:45.924272",
  "module": null,
  "name": "BA",
  "script": "frappe.ui.form.on('Bond Application', {\r\n    refresh: function (frm) {\r\n          frm.fields_dict.add_new.$input.addClass('btn-primary');\r\n            frm.fields_dict.calculate_security.$input.addClass('btn-primary');\r\n              frm.fields_dict.new_insurer.$input.addClass('btn-primary');\r\n               frm.fields_dict.new.$input.addClass('btn-primary');\r\n        frm.set_df_property('table','cannot_add_rows', true);\r\nfrm.fields_dict.exchange_rate.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.amount_in_pula.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.foreign_currency_amount.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.risk_percentage.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.beci_ref_number.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.guarantee_amount.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.total_beci_exposure_onincl_this_gurantee.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.total_in_excess_of_beci_exposure_limit_per_insured.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.excess_insurable_by_reisurer.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.guarantee_fee.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.guarantee_fee_p.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.portion_of_guarantee_guarantee_vat_p.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.reinsurer_portion_of_guarantee_fee_p.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.total_amount_payable_to_beci.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.reinsurer_portion_of_guarantee_amount.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.beci_commission_p.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.reinsurer_commissions.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.other_insurer_commissions.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.total_amount_payable_to_reinsurer.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.reinsurer_refnumber.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.less_beci_exposure_limit_per_insured.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.amount_insurable_by_reinsurer_beci.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.month.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.portion_of_guarantee_to_beci.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.beci_portion_of_gurantee_fee.$input.css(\"text-align\", \"right\");\r\n\r\nfrm.fields_dict.beci_portion_of_gurantee_amount_p.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.beci_commission.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.reinsurer_commission.$input.css(\"text-align\", \"right\");\r\nfrm.fields_dict.other_insurer_commission.$input.css(\"text-align\", \"right\");\r\n\r\n\r\n        var workflowState = frm.doc.workflow_state;\r\n\r\n        // Create a custom button for \"Bond Invoice\" if the workflow state is \"Submitted\"\r\n        if (workflowState === \"Approved\") {\r\n            frm.add_custom_button(__('Prepare Invoice'), function() {\r\n                \r\n                frappe.new_doc('BondIN')\r\n                    frappe.route_options = {\r\n                    bond_no: frm.doc.bn,\r\n                }\r\n                \r\n                // Enable fields in the Bond Invoice form\r\n          frappe.ui.form.on('BondIN', {\r\n            refresh: function(frm) {\r\n               \r\n            frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Bond Application',\r\n                filters: {\r\n                    bond_no: frm.doc.bond_no\r\n                },\r\n                fields: ['bond_no','broker','facility_name','bond_type','period_from','bond_subtype','month','reinsurer','beci_commission_p','reinsurer_commission','reinsurer_commissions','other_insurer_commission','other_insurer_commissions','beci_commission','to','bond_in_favour','demand_date','guarantee_amount','beci_portion_of_gurantee_fee','reinsurer_refnumber','reinsurer_portion_of_guarantee_fee_p','portion_of_guarantee_guarantee_vat_p','portion_of_guarantee_to_beci','guarantee_fee','vat']\r\n            },\r\n            callback: function(r) {\r\n                if (!r.exc && r.message && r.message.length > 0) {\r\n                    var bondApp = r.message[0];\r\n                    frm.set_value('facility_name', bondApp.facility_name); \r\n                    frm.set_value('bond_invoice_no', bondApp.bond_no); \r\n                    frm.set_value('bond_type', bondApp.bond_type);\r\n                    frm.set_value('period_from', bondApp.period_from);\r\n                    frm.set_value('bond_subtype', bondApp.bond_subtype);\r\n                    frm.set_value('month', bondApp.month);\r\n                    frm.set_value('reinsurer', bondApp.reinsurer); \r\n                    frm.set_value('beci_commission_p', bondApp.beci_commission_p);\r\n                    frm.set_value('reinsurer_commissions', bondApp.reinsurer_commissions);\r\n                    frm.set_value('other_insurer_commissions', bondApp.other_insurer_commissions);\r\n                    frm.set_value('beci_commission', bondApp.beci_commission);\r\n                    frm.set_value('to', bondApp.to); \r\n                    frm.set_value('bond_in_favour', bondApp.bond_in_favour);\r\n                    frm.set_value('demand_date', bondApp.demand_date);\r\n                    frm.set_value('guarantee_amount', bondApp.guarantee_amount);\r\n                    frm.set_value('beci_portion_of_gurantee_amount_p', bondApp.beci_portion_of_gurantee_fee);\r\n                    frm.set_value('reinsurer_refnumber', bondApp.bond_no);\r\n                    frm.set_value('reinsurer1', bondApp.portion_of_guarantee_guarantee_vat_p);\r\n                    frm.set_value('premium_p', bondApp.beci_portion_of_gurantee_fee); \r\n                    frm.set_value('beci', bondApp.portion_of_guarantee_to_beci);\r\n                    frm.set_value('premium_rate', bondApp.guarantee_fee);\r\n                    frm.set_value('vat', bondApp.vat);\r\n                    frm.set_value('reinsurer_commission', bondApp.reinsurer_commission);\r\n                    frm.set_value('portion_of_guarantee_guarantee_vat_p', bondApp.reinsurer_portion_of_guarantee_fee_p);\r\n                    frm.set_value('other_insurer_commission', bondApp.other_insurer_commission);\r\n                    frm.set_value('total_due_without_vat', bondApp.beci_portion_of_gurantee_fee);\r\n                    frm.set_value('broker1', bondApp.broker);\r\n                     var total_vat = bondApp.beci_portion_of_gurantee_fee || 0;\r\n                      var vat = bondApp.vat || 0;\r\n\r\n                      var total = total_vat * (vat / 100);\r\n\r\n                     frm.set_value('vat_p', Number(total).toFixed(2));\r\n\r\n                   \r\n                } else {\r\n                    console.error(\"Error occurred:\", r.exc);\r\n                }\r\n            }\r\n        });   \r\n        \r\n        \r\n     \r\n    \r\n               \r\n            },\r\n                total_due_without_vat: function(frm){\r\n        calculateTotal_due(frm);\r\n    },\r\n    \r\n    vat_p:function(frm){\r\n        calculateTotal_due(frm);\r\n    },\r\n    \r\n    guarantee_amount: function(frm){\r\n        calculateBroker(frm);\r\n    },\r\n    broker: function(frm){\r\n        calculateBroker(frm);\r\n    },\r\n        });\r\n                                \r\n               \r\n                                \r\n                                \r\n                                \r\n                console.log(\"Bond Invoice clicked!\");\r\n            }).addClass(\"btn-primary\");\r\n        }\r\n        \r\n            frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Bond Facility',\r\n                filters: {\r\n                    workflow_state: \"Submitted\"\r\n                },\r\n                fields: ['client_name'],\r\n                limit_page_length: 0\r\n            },\r\n            callback: function(response) {\r\n                console.log(\"client_name received:\", response);\r\n                let DataArray = []\r\n                DataArray = response.message;\r\n                let FinalArray = [];\r\n\r\n                for (let x of DataArray) {\r\n                    console.log(x.client_name)\r\n                    FinalArray.push(x.client_name)\r\n\r\n                }\r\n                frm.set_df_property('facility_name', 'options', FinalArray);\r\n                console.log(\"final\", FinalArray)\r\n\r\n            },\r\n            error: function(xhr, textStatus, errorThrown) {\r\n                console.error(\"Error fetching approved bonds:\", textStatus, errorThrown);\r\n            }\r\n        });\r\n        \r\n        \r\n},\r\n\r\n\r\n    onload: function (frm) {\r\n        \r\n        \r\n        // frappe.call({\r\n        //     method: 'frappe.client.get_list',\r\n        //     args: {\r\n        //         doctype: 'Bond Facility',\r\n        //         filters: {\r\n        //             workflow_state: \"Submitted\"\r\n        //         },\r\n        //         fields: ['client_name'],\r\n        //         limit_page_length: 1000\r\n        //     },\r\n        //     callback: function(response) {\r\n        //         console.log(\"client_name received:\", response);\r\n        //         let DataArray = []\r\n        //         DataArray = response.message;\r\n        //         let FinalArray = [];\r\n\r\n        //         for (let x of DataArray) {\r\n        //             console.log(x.client_name)\r\n        //             FinalArray.push(x.client_name)\r\n\r\n        //         }\r\n        //         frm.set_df_property('facility_name', 'options', FinalArray);\r\n        //         console.log(\"final\", FinalArray)\r\n\r\n        //     },\r\n        //     error: function(xhr, textStatus, errorThrown) {\r\n        //         console.error(\"Error fetching approved bonds:\", textStatus, errorThrown);\r\n        //     }\r\n        // });\r\n       \r\n        if (!frm.doc.bond_no) {\r\n            generateNumber(frm);\r\n        }\r\n        \r\n   \r\n        \r\n    frappe.call({\r\n      method: 'frappe.client.get_list',\r\n      args: {\r\n          doctype: 'VAT',\r\n          fields: ['vat'],\r\n      },\r\n    callback: function (response) {\r\n        console.log(response, \"client short name\");\r\n        if (!response.exc) {\r\n            var data = response.message;\r\n            if (data && data.length > 0) {\r\n                frm.set_value('vat', data[0].vat);\r\n            } else {\r\n                console.error(\"VAT document not found for the given filter.\");\r\n            }\r\n        } else {\r\n            console.error(\"Error occurred:\", response.exc);\r\n        }\r\n    }\r\n});\r\n\r\n\r\n\r\n        \r\n\r\n    },\r\n    \r\n\r\n\r\n    facility_name: function(frm) {\r\n        \r\n//         frappe.call({\r\n//          method: 'frappe.client.get',\r\n//          args: {\r\n//             doctype: 'Bond Facility Quotation Acceptance',\r\n//             filters: {\r\n//                 name1: frm.doc.facility_name\r\n            \r\n//              },\r\n//           fields: ['net_facility_amount','name1']\r\n//         },\r\n//       callback: function (r) {\r\n//                 console.log(r, \"client details_Bomd\");\r\n\r\n//                 if (!r.exc) {\r\n//                     if (r.message) {\r\n//                         frm.set_value('total_facility_amt', r.message.net_facility_amount);\r\n//                 // frm.refresh();\r\n//             }\r\n//         } else {\r\n//             console.error(\"Error occurred:\", r.exc);\r\n//         }\r\n//     }\r\n// });\r\n// old code\r\n//         frappe.call({\r\n//         method: 'frappe.client.get',\r\n//          args: {\r\n//             doctype: 'Security',\r\n//             filters: {\r\n//                 name1: frm.doc.facility_name,\r\n//              },\r\n//           fields: ['net_security','facilityamount','client']\r\n//         },\r\n//       callback: function (r) {\r\n//                 console.log(r, \"client details\");\r\n \r\n//                 if (!r.exc) {\r\n//                     if (r.message) {\r\n//                         frm.set_value('total_security_amt', r.message.net_security);\r\n//                         frm.set_value('total_facility_amt', r.message.facilityamount);\r\n//                 // frm.refresh();\r\n//             }\r\n//         } else {\r\n//           // console.error(\"Error occurred:\", r.exc);\r\n//           frappe.msgprint(\"No Security records have facility_name\");\r\n//         }\r\n//     }\r\n// });\r\n\r\n// New code\r\n\r\nfrappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n        doctype: 'Security',\r\n        filters: {\r\n            name1: frm.doc.facility_name\r\n        },\r\n        fields: ['name', 'net_security', 'facilityamount'],\r\n        limit: 1\r\n    },\r\n    callback: function(r) {\r\n        console.log(\"\ud83d\udd0d Security record response:\", r);\r\n\r\n        if (r.message && r.message.length > 0) {\r\n            const record = r.message[0];\r\n            frm.set_value('total_security_amt', record.net_security);\r\n            frm.set_value('total_facility_amt', record.facilityamount);\r\n        } else {\r\n            // \u2705 Show a popup dialog (modal)\r\n            frappe.msgprint({\r\n               \r\n                message: __(`No Security record found for Facility Name <b>${frm.doc.facility_name}</b>.`),\r\n                \r\n              \r\n            });\r\n\r\n            // Optionally clear values if nothing found\r\n            frm.set_value('total_security_amt', '');\r\n            frm.set_value('total_facility_amt', '');\r\n        }\r\n    }\r\n});\r\n\r\n\r\n\r\n //-----------facility names filtering\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Bond Facility',\r\n                filters: {\r\n                    client_name: frm.doc.facility_name\r\n                },\r\n                fields: ['facility_no', 'status1','reg_no','estd_date','broker']\r\n            },\r\n            callback: function(response) {\r\n                console.log(\"Bond Facility response:\", response);\r\n                if (response.message && response.message.length > 0) {\r\n                    var data_from_proposals = response.message[0];\r\n \r\n                    // Populate fields if data is found\r\n                    frm.set_value('status', data_from_proposals.status1 || '');\r\n                    frm.set_value('facility_no', data_from_proposals.facility_no || '');\r\n                    frm.set_value('reg_no', data_from_proposals.reg_no || '');\r\n                    frm.set_value('reg_date', data_from_proposals.estd_date || '');\r\n                     frm.set_value('broker', data_from_proposals.broker || '');\r\n                } else {\r\n                    // Clear fields if no matching record found\r\n                    frm.set_value('status', '');\r\n                    frm.set_value('facility_no', '');\r\n                    frm.set_value('reg_no', '');\r\n                    frm.set_value('reg_date', '');\r\n                    frm.set_value('broker', '');\r\n                    \r\n                    frappe.msgprint('No matching record found in Bond Facility.');\r\n                }\r\n            },\r\n            error: function(err) {\r\n                console.error(err);\r\n                //frappe.msgprint('An error occurred while fetching data from DCI Proposals. Please check the console for details.');\r\n            }\r\n        });\r\n        \r\n        \r\n        var facilityName = frm.doc.facility_name;\r\n\r\n        // Check if facility name is empty\r\n        if (facilityName) {\r\n            // Make API call to fetch data only if facility name is entered\r\n            fetchBondInFavourData(frm, facilityName);\r\n        } else {\r\n            // Clear table if facility name is empty\r\n            frm.clear_table('table');\r\n        }\r\n    \r\n \r\n\r\n   \r\n\r\n\r\n    },\r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    vat: function(frm){\r\n        calculatetotalbeci_Amount(frm);\r\n    },\r\n    \r\n    \r\n//     exchange_rate: function(frm){\r\n//         calculatetotal_Amount(frm);\r\n    \r\n// },\r\n\r\n//     foreign_currency_amount: function(frm){\r\n//     calculatetotal_Amount(frm);\r\n// },\r\n\r\n\r\n //Calculate balanced facility Amount\r\n \r\n    // balanced_facilty_amt: function(frm){\r\n        \r\n    //     calculatefacilityamt(frm);\r\n    // },\r\n    \r\n    // balanced_security_amt:function(frm){\r\n    \r\n    //     calculatesecurityamt(frm);\r\n    // },\r\n    \r\n//     utilized_facilty_amt:function(frm){\r\n//         // calculatetotal_bond_value(frm);\r\n//         calculatefacilityamt(frm);\r\n        \r\n//         // calculateUtilizedfacilityAmount(frm);\r\n        \r\n    \r\n// },\r\n     \r\n    // utilized_security_amt:function(frm){\r\n    //     calculatetotal_security_value(frm);\r\n    //     calculatesecurityamt(frm);\r\n    // },\r\n    \r\n    // amount_in_pula: function(frm){\r\n    //     // calculatetotal_bond_value(frm);\r\n    // },\r\n    \r\n    period_from:function(frm){\r\n        var periodfrom = frm.doc.period_from;\r\n        frm.set_value('premium_charged_for_period_of',periodfrom);\r\n        \r\n    },\r\n    \r\n    to:function(frm){\r\n        var to = frm.doc.to;\r\n        frm.set_value('to_',to);\r\n        \r\n    },\r\n    \r\n      amount_in_pula:function(frm){\r\n        var amount_in_pula = frm.doc.amount_in_pula;\r\n        frm.set_value('guarantee_amount',amount_in_pula);\r\n        \r\n    },\r\n\r\n    add_new: function (frm) {\r\n        frappe.new_doc('Company-Details');\r\n    },\r\n    \r\n    new_insurer:function(frm){\r\n       frappe.new_doc('Company-Details'); \r\n    },\r\n    \r\n    new:function(frm){\r\n         frappe.new_doc('Company-Details');\r\n    },\r\n    \r\n    calculate_security:function(frm){\r\n        frappe.new_doc('Security Calculation');\r\n          frappe.route_options = {\r\n               currency_code: frm.doc.amount_in_pula,\r\n                    facility_no: frm.doc.facility_no,\r\n                    bond_no: frm.doc.bond_no,\r\n                   \r\n                }\r\n    },\r\n\r\n \r\n    bond_type: function(frm) {\r\n    var bondType = frm.doc.bond_type;\r\n\r\n    frm.set_df_property('bond_subtype', 'options', ['Select']);\r\n\r\n    if (bondType === 'CONSTRUCTION BOND') {\r\n        frm.set_df_property('bond_subtype', 'options', [\r\n            'Performance Bond',\r\n            'Advance Payment Bond',\r\n            'Tender Bond',\r\n            'Retention Bond',\r\n            'Payment Guarantee',\r\n            'Payment Bond'\r\n        ]);\r\n        msgprint(\"Please select Bond sub type.\");\r\n    } else if (bondType === 'CUSTOMS BONDS') {\r\n        frm.set_df_property('bond_subtype', 'options', [\r\n            'Vat Deferral',\r\n            'Temporary Importation',\r\n            'Bonded Warehouse',\r\n            'Clearing Agent'\r\n        ]);\r\n        msgprint(\"Please select Bond sub type.\");\r\n    }\r\n},\r\n  \r\n    bond_no: function(frm) {\r\n        frm.set_value('beci_ref_number', frm.doc.bond_no);\r\n    },\r\n    currency_code: function(frm) {\r\n    var currencyCode = frm.doc.currency_code;\r\n\r\n    // Regular expression to match any string of alphabets\r\n    var currencyRegex = /^[A-Za-z]+$/;\r\n\r\n    if (!currencyRegex.test(currencyCode)) {\r\n        frappe.msgprint(__(\"Please enter a valid currency code (Pula,USD).\"));\r\n        frm.set_value('currency_code', '');\r\n    }\r\n    \r\n    \r\n    \r\n    \r\n    \r\n},\r\nrefer_to_reinsurer:  function(frm) {\r\n        frm.set_value('reinsurer', frm.doc.refer_to_reinsurer);\r\n    },\r\n\r\n    //Calculation of Months\r\n    premium_charged_for_period_of: function(frm) {\r\n        calculateMonths(frm);\r\n    },\r\n    \r\n    to_: function(frm) {\r\n        calculateMonths(frm);\r\n    },\r\n    \r\n    \r\n  //Calculation of Gaurantee fee and ReinsurePortion og Gurantee amount\r\n   month: function(frm) {\r\n        calculateTotal(frm);\r\n    },\r\n    guarantee_fee: function(frm) {\r\n        calculateTotal(frm);\r\n    },\r\n    \r\n    guarantee_amount: function(frm) {\r\n        calculateTotal(frm);\r\n        calculateReinsurePortionofguaranteeamount(frm);\r\n        calculateBCIPortionofGuranteeAmount(frm);\r\n        // calculatetotalbeci_Amount(frm);\r\n        \r\n    },\r\n     \r\n \r\n //Calculation of Portion of Gurantee to BECI % and Reinsure Portion of Guarantee Fee and ReinsurePortion og Gurantee amount\r\n  portion_of_guarantee_guarantee_vat_p: function(frm) {\r\n        calculatePortionOfGurantee(frm);\r\n        calculateReinsureportionofGurantee(frm);\r\n        calculateReinsurePortionofguaranteeamount(frm);\r\n        \r\n    },\r\n \r\n //Calculation of BECI Portion of Guarantee Fee and Reinsure Portion of Guarantee Fee\r\n guarantee_fee_p: function(frm) {\r\n        calculateBECIportionofGurantee(frm);\r\n        calculateReinsureportionofGurantee(frm);\r\n        calculateOtherInsureCommission(frm);\r\n         calculatetotalbeci_Amount(frm);\r\n    },\r\n portion_of_guarantee_to_beci: function(frm) {\r\n        calculateBECIportionofGurantee(frm);\r\n        calculateBCIPortionofGuranteeAmount(frm);\r\n    },\r\n\r\n//Calculation of Reinsure Commission\r\n beci_portion_of_gurantee_fee: function(frm) {\r\n        calculateReinsureCommission(frm);\r\n    },\r\n reinsurer_commissions: function(frm) {\r\n        calculateReinsureCommission(frm);\r\n    },\r\n\r\n//Calculation of BECI Commission\r\nreinsurer_portion_of_guarantee_fee_p: function(frm) {\r\n        calculateBCICommission(frm);\r\n        calculateTotalAmountPayableToReinsure(frm) ;\r\n    },\r\n    \r\n beci_commission_p: function(frm) {\r\n        calculateBCICommission(frm);\r\n        calculateTotalAmountPayableToReinsure(frm) \r\n    },\r\n    \r\n//Calculate Other insure Commission\r\nother_insurer_commissions: function(frm) {\r\n        calculateOtherInsureCommission(frm);\r\n       \r\n    },\r\n    \r\n\r\n  \r\n});\r\n\r\n\r\n\r\n\r\n        \r\n// // Function to calculate  Utilized facility Amount\r\nfunction calculatetotalutilizedfacilityamount(frm) {\r\n var childTableData = frm.doc.table || [];\r\n    var totalBondValueApproved = 0;\r\n\r\n    // Calculate Total Bond Value for Approved records\r\n    for (var i = 0; i < childTableData.length; i++) {\r\n        if (childTableData[i].status === 'Approved') {\r\n            totalBondValueApproved += parseFloat(childTableData[i].amount_in_pula) || 0;\r\n        }\r\n    }\r\n    \r\n    // Update Utilized Facility Amount field in the form\r\n     frm.set_value('utilized_facilty_amt', totalBondValueApproved);\r\n    \r\n}\r\n\r\nfunction calculateBalancedFacilityAmount(frm) {\r\n    var childTableData = frm.doc.table || [];\r\n    var totalBondValueApproved = 0;\r\n\r\n    // Calculate Total Bond Value for Approved records\r\n    for (var i = 0; i < childTableData.length; i++) {\r\n        if (childTableData[i].status === 'Approved') {\r\n            totalBondValueApproved += parseFloat(childTableData[i].amount_in_pula) || 0;\r\n        }\r\n    }\r\n\r\n    var totalFacilityAmt = frm.doc.total_facility_amt || 0;\r\n\r\n    // Calculate the balanced facility amount\r\n    var balancedFacilityAmt = totalFacilityAmt - totalBondValueApproved;\r\n\r\n    // Update the balanced_facilty_amt field in the form\r\n    frm.set_value('balanced_facilty_amt', balancedFacilityAmt);\r\n}\r\n\r\n\r\n\r\n// // Function to calculate Utilized Security Amount\r\nfunction calculatetotalutilizedsecurityamount(frm) {\r\n    var childTableData = frm.doc.table || [];\r\n    var totalBondValueApproved = 0;\r\n\r\n    // Calculate Total Bond Value for Approved records\r\n    for (var i = 0; i < childTableData.length; i++) {\r\n        if (childTableData[i].status === 'Approved') {\r\n            totalBondValueApproved += parseFloat(childTableData[i].security_required) || 0;\r\n        }\r\n    }\r\n\r\n     console.log(totalBondValueApproved,\"toooooooo\")\r\n    // Update Utilized Security Amount field in the form\r\n    frm.set_value('utilized_security_amt', totalBondValueApproved);\r\n}\r\n\r\nfunction calculatebalancedsecurityamt(frm) {\r\n    var childTableData = frm.doc.table || [];\r\n    var totalBondValueApproved = 0;\r\n\r\n    // Calculate Total Security Amount for Approved records\r\n    for (var i = 0; i < childTableData.length; i++) {\r\n        if (childTableData[i].status === 'Approved') {\r\n            totalBondValueApproved += parseFloat(childTableData[i].security_required) || 0;\r\n        }\r\n    }\r\n    \r\n    var totalSecurityAmount = frm.doc.total_security_amt || 0;\r\n    \r\n    // Perform Calculation here\r\n    var balancedSecurityAmt = totalSecurityAmount - totalBondValueApproved;\r\n\r\n    console.log(balancedSecurityAmt, 'balanced_security_amt');\r\n    \r\n    // Update the balanced_security_amt field in the form\r\n    frm.set_value('balanced_security_amt', balancedSecurityAmt);\r\n}\r\n\r\n\r\n\r\n\r\nfunction calculateOtherInsureCommission(frm) {\r\n    var field1_value = frm.doc.guarantee_fee_p;\r\n    var field2_value = frm.doc.other_insurer_commissions;\r\n  \r\n      // Perform your calculation here\r\n    var total =field1_value *(field2_value/100)\r\n\r\n    frm.set_value('other_insurer_commission', total);\r\n      \r\n }\r\n\r\nfunction calculateTotalAmountPayableToReinsure(frm) {\r\n    var field1_value = frm.doc.reinsurer_portion_of_guarantee_fee_p;\r\n    var field2_value = frm.doc.beci_commission_p;\r\n  \r\n      // Perform your calculation here\r\n    var total = field1_value - field2_value\r\n\r\n    frm.set_value('total_amount_payable_to_reinsurer', total);\r\n      \r\n }\r\n\r\nfunction calculateBCICommission(frm) {\r\n    var field1_value = frm.doc.reinsurer_portion_of_guarantee_fee_p;\r\n    var field2_value = frm.doc.beci_commission_p;\r\n  \r\n      // Perform your calculation here\r\n    var total = field1_value * (field2_value/100)\r\n\r\n    frm.set_value('beci_commission', total);\r\n      \r\n }\r\n\r\nfunction calculateBCIPortionofGuranteeAmount(frm) {\r\n    var field1_value = frm.doc.guarantee_amount;\r\n    var field2_value = frm.doc.portion_of_guarantee_to_beci;\r\n  \r\n      // Perform your calculation here\r\n    var total = field1_value * (field2_value/100)\r\n\r\n    frm.set_value('beci_portion_of_gurantee_amount_p', total);\r\n      \r\n }\r\n\r\n\r\nfunction calculateReinsurePortionofguaranteeamount(frm) {\r\n    var field1_value = frm.doc.guarantee_amount;\r\n    console.log(field1_value); // Access the value from frm.doc\r\n\r\n    var field2_value = frm.doc.portion_of_guarantee_guarantee_vat_p;\r\n    console.log(field2_value); // Access the value from frm.doc\r\n\r\n    // Perform your calculation here\r\n    var total = field1_value * (field2_value / 100);\r\n    console.log(total, \"insurecommission\");\r\n\r\n    frm.set_value('reinsurer_portion_of_guarantee_amount', total);\r\n}\r\n\r\n\r\nfunction calculateReinsureCommission(frm) {\r\n    var field1_value = frm.doc.beci_portion_of_gurantee_fee;\r\n    var field2_value = frm.doc.reinsurer_commissions;\r\n  \r\n      // Perform your calculation here\r\n    var total = field1_value * (field2_value/100)\r\n\r\n    frm.set_value('reinsurer_commission', total);\r\n      \r\n }\r\n\r\n\r\nfunction calculateReinsureportionofGurantee(frm) {\r\n    var field1_value = frm.doc.guarantee_fee_p;\r\n    var field2_value = frm.doc.portion_of_guarantee_guarantee_vat_p;\r\n  \r\n      // Perform your calculation here\r\n    var total = field1_value*(field2_value/100)\r\n\r\n    frm.set_value('reinsurer_portion_of_guarantee_fee_p', total);\r\n      \r\n }\r\n\r\n\r\nfunction calculateBECIportionofGurantee(frm) {\r\n    var field1_value = frm.doc.guarantee_fee_p;\r\n    var field2_value = frm.doc.portion_of_guarantee_to_beci;\r\n  \r\n      // Perform your calculation here\r\n    var total = field1_value * (field2_value/100)\r\n\r\n    frm.set_value('beci_portion_of_gurantee_fee', total);\r\n      \r\n }\r\n\r\n\r\nfunction calculatePortionOfGurantee(frm) {\r\n    var field1_value = frm.doc.portion_of_guarantee_guarantee_vat_p;\r\n  \r\n      // Perform your calculation here\r\n    var total = 100-field1_value;\r\n\r\n    frm.set_value('portion_of_guarantee_to_beci', total);\r\n      \r\n }\r\n\r\n\r\nfunction calculateMonths(frm) {\r\n    console.log('calculateMonths function called');\r\n    var from_date = frm.doc.premium_charged_for_period_of;\r\n    var to_date = frm.doc.to_;\r\n\r\n    console.log('from_date:', from_date);\r\n    console.log('to_date:', to_date);\r\n\r\n    if (from_date && to_date) {\r\n        var from_date_obj = frappe.datetime.str_to_obj(from_date);\r\n        var to_date_obj = frappe.datetime.str_to_obj(to_date);\r\n\r\n        var monthsDiff = (to_date_obj.getFullYear() - from_date_obj.getFullYear()) * 12;\r\n        monthsDiff -= from_date_obj.getMonth();\r\n        monthsDiff += to_date_obj.getMonth();\r\n        \r\n        console.log('Months difference:', monthsDiff);\r\n        frm.set_value('month', monthsDiff);\r\n    } else {\r\n        console.log('One or both dates are empty');\r\n        frm.set_value('month', '');\r\n    }\r\n}\r\n\r\n\r\n function calculateTotal(frm) {\r\n    var field1_value = frm.doc.month;\r\n    var field2_value = frm.doc.guarantee_fee;\r\n    var field3_value = frm.doc.guarantee_amount;\r\n    \r\n    // Perform your calculation here\r\n    var total = (field1_value / 12) * (field2_value / 100) * field3_value;\r\n\r\n    frm.set_value('guarantee_fee_p', total);\r\n      \r\n }\r\n\r\n\r\n// Function to update fields\r\nfunction updateFields(frm) {\r\n    var periodFromField = frm.fields_dict['period_from'];\r\n    var toField = frm.fields_dict['to'];\r\n    var amountInPulaField = frm.fields_dict['amount_in_pula'];\r\n    \r\n\r\n    var periodFromValue = periodFromField.get_value();\r\n    var toValue = toField.get_value();\r\n    var amountInPulaValue = amountInPulaField.get_value();\r\n    \r\n\r\n    frm.set_value('premium_charged_for_period_of', periodFromValue);\r\n    frm.set_value('to_', toValue);\r\n    frm.set_value('guarantee_amount', amountInPulaValue);\r\n}\r\n\r\n\r\n\r\n// //Generate bond number\r\n// function generateNumber(frm) {\r\n//     if (!frm.doc.bond_no) {\r\n//         let currentYear = new Date().getFullYear();\r\n//         let prefix = `BND/${currentYear}/`;\r\n\r\n//         frappe.call({\r\n//             method: 'frappe.client.get_list',\r\n//             args: {\r\n//                 doctype: 'Bond Application',\r\n//                 fields: ['bond_no', 'creation'],\r\n//                 order_by: 'creation desc',\r\n//                 limit: 1\r\n//             },\r\n//             callback: function (r) {\r\n//                 if (r.message && r.message.length > 0) {\r\n//                     let lastBondNo = r.message[0].bond_no;\r\n//                     let lastNumber = parseInt(lastBondNo.split(\"/\").pop()) || 0;\r\n//                     let newNumber = (lastNumber + 1).toString().padStart(4, '0');\r\n//                     frm.set_value('bond_no', prefix + newNumber);\r\n//                 } else {\r\n//                     frm.set_value('bond_no', prefix + '0001');\r\n//                 }\r\n//             }\r\n//         });\r\n//     }\r\n// }\r\n\r\nfunction generateNumber(frm) {\r\n    // Check if the bond number field is already populated\r\n    if (!frm.doc.bond_no) {\r\n        // Get the current year\r\n        let currentYear = new Date().getFullYear();\r\n        let prefix = `BND/${currentYear}/`;\r\n\r\n        // Make a call to get the last bond number asynchronously\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Bond Application',\r\n                fields: ['bond_no'],\r\n                limit: 1,\r\n                order_by: 'creation desc'\r\n            },\r\n            callback: function(response) {\r\n                console.log(response, \"bond no\");\r\n                let lastBondNo = response.message && response.message.length > 0 ? response.message[0].bond_no : '0';\r\n                let lastNumber = parseInt(lastBondNo.split(\"/\").pop()); // Extract last part and parse it as integer\r\n\r\n                // Make a call to get the last deputy sheriff bond number asynchronously\r\n                frappe.call({\r\n                    method: 'frappe.client.get_list',\r\n                    args: {\r\n                        doctype: 'Deputy Sheriff Bond',\r\n                        fields: ['bond_no'],\r\n                        limit: 1,\r\n                        order_by: 'creation desc'\r\n                    },\r\n                    callback: function(response) {\r\n                        console.log(response, \"deputy sheriff bond no\");\r\n                        let lastDeputySheriffBondNo = response.message && response.message.length > 0 ? response.message[0].bond_no : '0';\r\n                        let lastDeputySheriffBondNumber = parseInt(lastDeputySheriffBondNo.split(\"/\").pop());\r\n\r\n                        // Get the maximum of the two last bond numbers\r\n                        let maxLastNumber = Math.max(lastNumber, lastDeputySheriffBondNumber);\r\n\r\n                        if (!isNaN(maxLastNumber)) {\r\n                            // Increment the last number and pad it with leading zeros\r\n                            let newNumber = (maxLastNumber + 1).toString().padStart(4, '0');\r\n                            frm.set_value('bond_no', prefix + newNumber);\r\n                        } else {\r\n                            // If no previous numbers exist, set to default '0001'\r\n                            frm.set_value('bond_no', prefix + '0001');\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\n\r\n\r\n\r\n// function calculatefacilityamt(frm){\r\n//     var field_value1 = frm.doc.total_facility_amt;\r\n//     var field_value2 = frm.doc.utilized_facilty_amt;\r\n//     console.log(field_value1,'field_value1')\r\n//     //Perform Calculation here\r\n//     var total = field_value1 - field_value2;\r\n//     console.log(total,'total_facility_amt')\r\n//     frm.set_value('balanced_facilty_amt', total);\r\n// }\r\n\r\n\r\n\r\n// function calculatesecurityamt(frm){\r\n//     var field_value3 = frm.doc.total_security_amt;\r\n//     var field_value4 = frm.doc.utilized_security_amt;\r\n//     console.log(field_value3,'field_value3')\r\n//     //Perform Calculation here\r\n//     var total = field_value3 - field_value4;\r\n//     console.log(total,'total_facility_amt')\r\n//     frm.set_value('balanced_security_amt', total);\r\n// }\r\n\r\n\r\n// function calculatetotal_bond_value(frm){\r\n//     var childTableData = frm.doc.table || [];\r\n\r\n//     // Calculate Total Bond Value\r\n//     var totalBondValue = childTableData.reduce(function(amount_in_pula, row) {\r\n//         // Convert row.amount_in_pula to a number using parseFloat or parseInt\r\n//         var rowBondValue = parseFloat(row.amount_in_pula) || 0; // Convert to float; default to 0 if NaN\r\n\r\n//         // Accumulate bond values for each row\r\n//         return amount_in_pula + rowBondValue;\r\n//     }, 0);\r\n\r\n//     // Update Total Bond Value field in the form\r\n//     frm.set_value('utilized_facilty_amt', totalBondValue);\r\n// }\r\n\r\n\r\n\r\n// function calculatetotal_security_value(frm){\r\n// var childTableData = frm.doc.table || [];\r\n\r\n//     // Calculate Total Bond Value\r\n//     var totalSecurityValue = childTableData.reduce(function(security_required, row) {\r\n//         // Convert row.amount_in_pula to a number using parseFloat or parseInt\r\n//         var rowSecurityValue = parseFloat(row.security_required) || 0; // Convert to float; default to 0 if NaN\r\n\r\n//         // Accumulate bond values for each row\r\n//         return security_required + rowSecurityValue;\r\n//     }, 0);\r\n\r\n//     // Update Total Bond Value field in the form\r\n//     frm.set_value('utilized_security_amt', totalSecurityValue);\r\n    \r\n// }\r\n\r\n\r\n\r\n// function calculatetotal_Amount(frm){\r\n//     var field1_value = frm.doc.exchange_rate;\r\n//     var field2_value = frm.doc.foreign_currency_amount;\r\n    \r\n    \r\n//     // Perform your calculation here\r\n//     var total = (field1_value * field2_value);\r\n\r\n//     frm.set_value('amount_in_pula', total);\r\n//     frm.set_value('guarantee_amount', total);\r\n      \r\n// }\r\n \r\n \r\n function calculatetotalbeci_Amount(frm){\r\n    var vat_value = frm.doc.vat;\r\n    var guarantee_fee_p = frm.doc.guarantee_fee_p;\r\n    \r\n    \r\n    // Perform your calculation here\r\n    var total = guarantee_fee_p + (guarantee_fee_p * (vat_value / 100));\r\n\r\n    frm.set_value('total_amount_payable_to_beci', total);\r\n      \r\n }\r\n\r\n\r\n//Fetch the data in to child table\r\nfunction fetchBondInFavourData(frm, facilityName) {\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Bond Application',\r\n            filters: {\r\n                facility_name: facilityName\r\n            },\r\n            fields: ['name', 'workflow_state', 'bond_no', 'bond_in_favour', 'period_from', 'to', 'amount_in_pula', 'security_required','workflow_state'],\r\n            limit: 2,\r\n        },\r\n        callback: function(r) {\r\n            if (!r.exc) {\r\n                var data = r.message;\r\n\r\n                frm.clear_table('table');\r\n\r\n                for (let x of data) {\r\n                    var child = frappe.model.add_child(frm.doc, \"Previous Bond Details\", \"table\");\r\n\r\n                    frappe.model.set_value(child.doctype, child.name, \"bond_no\", x.bond_no);\r\n                    frappe.model.set_value(child.doctype, child.name, \"bond_in_favour\", x.bond_in_favour);\r\n                    frappe.model.set_value(child.doctype, child.name, \"period_from\", x.period_from);\r\n                    frappe.model.set_value(child.doctype, child.name, \"to\", x.to);\r\n                    frappe.model.set_value(child.doctype, child.name, \"amount_in_pula\", x.amount_in_pula);\r\n                    frappe.model.set_value(child.doctype, child.name, \"security_required\", x.security_required);\r\n                    frappe.model.set_value(child.doctype, child.name, \"status\", x.workflow_state); // Set workflow state\r\n                }\r\n                frm.refresh_fields('table');\r\n                // calculatetotal_security_value(frm)\r\n                \r\n                 calculatetotalutilizedfacilityamount(frm);\r\n    \r\n     calculatetotalutilizedsecurityamount(frm);\r\n     \r\n     calculateBalancedFacilityAmount(frm);\r\n       \r\n     calculatebalancedsecurityamt(frm);\r\n        \r\n                \r\n            } else {\r\n                console.error(r.exc);\r\n            }\r\n        }\r\n    });\r\n    \r\n  \r\n    \r\n}\r\n\r\n\r\nfunction calculateTotal_due(frm) {\r\n    var total_vat = Number(frm.doc.total_due_without_vat) || 0;\r\n    var vat_p = Number(frm.doc.vat_p) || 0;\r\n\r\n    var total = total_vat + vat_p;\r\n\r\n    frm.set_value('total_due', total);\r\n}\r\n\r\nfunction calculateBroker(frm) {\r\n    var guarantee_amount = frm.doc.guarantee_amount || 0;\r\n    var brokerPercent = frm.doc.broker || 0;\r\n\r\n    // Calculate broker commission\r\n    var brokerCommission = (guarantee_amount * brokerPercent / 100);\r\n\r\n    // Set the value of broker_commission__p field\r\n    frm.set_value('broker_commission__p', brokerCommission);\r\n}\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Bond Facility",
  "enabled": 1,
  "modified": "2025-12-08 13:49:44.928264",
  "module": null,
  "name": "new Script bond",
  "script": "frappe.ui.form.on('Bond Facility', {\n// \trefresh: function(frm) {\n    \n//      if (!frm.doc.facility_no) {\n//             generateNumber(frm);\n//         }\n        \n//           clear_attachment(frm);\n           \n//                   // frm.set_df_property('personel_child', 'cannot_add_new', true);\n\n//         frm.fields_dict.required_facility.$input.css(\"text-align\", \"right\");\n\n//         // Add the btn-primary class to the add_new button\n        \n//         if (frm.fields_dict.add_new) {\n//             frm.fields_dict.add_new.$input.addClass('btn-primary');\n//             frm.fields_dict.add_new1.$input.addClass('btn-primary');\n//             frm.fields_dict.add_new2.$input.addClass('btn-primary');\n//             frm.fields_dict.add_new3.$input.addClass('btn-primary');\n//             frm.fields_dict.add_new4.$input.addClass('btn-primary');\n\n\n\n//         }\n        \n//  let workflow = frm.doc.workflow_state;\n\n//     // \u2705 Show both buttons for every state EXCEPT Draft\n//     if (workflow === \"Submitted\" || workflow === \"Accepted\") {\n\n//         // \u2705 PRINT PROPOSAL BUTTON\n//         frm.add_custom_button(__('Print Proposal'), function() {\n\n//             frappe.route_options = {\n//                 registered_name: frm.doc.client_name,\n//                 nature_of_business: frm.doc.nature_of_business,\n//                 registration_no : frm.doc.reg_no,\n//                  name5 : frm.doc.signed_by,\n//                   date : frm.doc.signed_on,\n//                   designation : frm.doc.capacity,\n//                     facility_required : frm.doc.required_facility,\n//                     data3 : frm.doc.demo_1,\n//                     data4 : frm.doc.demo_2,\n//                     data6 : frm.doc.demo_3,\n//                     data5 : frm.doc.demo_4,\n//                     other_specify : frm.doc.others_specify,\n//                     remarksother_information : frm.doc.remarksother_information,\n//                     addition_to_existing_facility : frm.doc.details,\n//                     to_replace_existing_facility : frm.doc.application_remarks,\n//                     bankers : frm.doc.name1,\n//                     accno : frm.doc.ac_no,\n//                     period_with_bank : frm.doc.period_with_bankyears,\n//                     cash_balance_p : frm.doc.cash_balance,\n//                     investments_p : frm.doc.investment,\n//                     overdraft_facility_usd : frm.doc.overdraft_facility,\n//                     overdraft_used_usd : frm.doc.overdraft_used,\n//                     how_secured : frm.doc.how_secured,\n//                     bank_guarantee_facility_usd : frm.doc.bank_guarentee__facility,\n//                     guarantee_outstanding_usd : frm.doc.guarentee__outstanding,\n//                      other_bankers : frm.doc.other_bankers\n                \n//             };\n\n//             frappe.new_doc('Print Proposal BondFacility');\n//             console.log(\"Print Proposal clicked!\");\n            \n            \n//                 frappe.ui.form.on('Print Proposal BondFacility', {\n//                 refresh: function(frm) {\n//         frm.set_df_property('group_company','cannot_add_rows', true);\n//         frm.set_df_property('director_table','cannot_add_rows', true);\n//         frm.set_df_property('company_table','cannot_add_rows', true);\n//         frm.set_df_property('personel_table','cannot_add_rows', true);\n//         frm.set_df_property('current_table','cannot_add_rows', true);\n\n        \n//         frappe.call({\n//                         method: 'frappe.client.get',\n//                         args: {\n//                             doctype: 'Company-Details',\n//                             filters: {\n//                                 name1: frm.doc.registered_name\n//                             },\n//                             fields: ['postal_address', 'location','telephone','fax', 'physical_address']\n//                         },\n                \n//                 callback: function(r) {\n//                 console.log(\"Company Details Response:\", r);\n\n//                 if (!r.exc && r.message) {\n//                     frm.set_value('telephone', r.message.telephone || '');\n//                       frm.set_value('postal_adress', r.message.postal_address || '');\n//                         frm.set_value('fax', r.message.fax || '');\n//                           frm.set_value('telephone', r.message.telephone || '');\n                          \n                          \n                          \n//                           // \u2705 Combine physical_address + location and set it to physical_address field\n//              let combined_address = '';\n\n//              if (r.message.physical_address) {\n//               combined_address += r.message.physical_address;\n//               }\n\n//             if (r.message.location) {\n//                 combined_address += (combined_address ? ' , ' : '') + r.message.location;\n//               }\n\n//              frm.set_value('physical_address', combined_address);\n//              frm.refresh_fields(['telephone', 'postal_address', 'fax', 'physical_address']);\n         \n//                 }\n//                 }\n//                     });\n                    \n//              //Group Company       \n//           frappe.call({\n//             method: \"frappe.client.get\",\n//             args: {\n//                 doctype: \"Bond Facility\",\n//                 filters: { client_name: frm.doc.registered_name }\n//             },\n//             callback: function(r) {\n//                 console.log(\"Bond Facility Response:\", r);\n\n//                 if (!r.exc && r.message && r.message.group_company && r.message.group_company.length > 0) {\n//                     const data = r.message.group_company;\n\n//                     // Clear the existing rows before adding new ones\n//                     frm.clear_table('group_company');\n\n//                     data.forEach(x => {\n//                         const child = frappe.model.add_child(frm.doc, \"Group Company\", \"group_company\");\n//                         frappe.model.set_value(child.doctype, child.name, \"compid\", x.company);\n//                         frappe.model.set_value(child.doctype, child.name, \"compname\", x.address);\n//                         frappe.model.set_value(child.doctype, child.name, \"comptype\", x.type);\n//                     });\n\n//                     frm.refresh_field('group_company');\n               \n//                 } else {\n//                     console.warn(\"No Buyer Experience data found in DCI Proposals for this client.\");\n//                 }\n//             }\n//         });\n        \n//         //Director and Shareholder Child Table\n//           frappe.call({\n//             method: \"frappe.client.get\",\n//             args: {\n//                 doctype: \"Bond Facility\",\n//                 filters: { client_name: frm.doc.registered_name }\n//             },\n//             callback: function(r) {\n//                 console.log(\"Bond Facility Response:\", r);\n\n//                 if (!r.exc && r.message && r.message.directors && r.message.directors.length > 0) {\n//                     const data = r.message.directors;\n\n//                     // Clear the existing rows before adding new ones\n//                     frm.clear_table('director_table');\n\n//                     data.forEach(x => {\n//                         const child = frappe.model.add_child(frm.doc, \"Director and Shareholder Child Table\", \"director_table\");\n//                         frappe.model.set_value(child.doctype, child.name, \"shares_held\", x.share_held);\n//                         frappe.model.set_value(child.doctype, child.name, \"d_number_coregnumber\", x.id_number);\n//                          frappe.model.set_value(child.doctype, child.name, \"full_names\", x.full_name);\n//                         frappe.model.set_value(child.doctype, child.name, \"married_anc_cop\", x.married_anccop);\n//                     });\n\n//                     frm.refresh_field('director_table');\n               \n//                 } else {\n//                     console.warn(\"No Buyer Experience data found in DCI Proposals for this client.\");\n//                 }\n//             }\n//         });\n        \n//       //Company child bond facility  \n//           frappe.call({\n//             method: \"frappe.client.get\",\n//             args: {\n//                 doctype: \"Bond Facility\",\n//                 filters: { client_name: frm.doc.registered_name }\n//             },\n//             callback: function(r) {\n//                 console.log(\"Bond Facility Response:\", r);\n\n//                 if (!r.exc && r.message && r.message.company_child && r.message.company_child.length > 0) {\n//                     const data = r.message.company_child;\n\n//                     // Clear the existing rows before adding new ones\n//                     frm.clear_table('company_table');\n\n//                     data.forEach(x => {\n//                         const child = frappe.model.add_child(frm.doc, \"Company child bond facility\", \"company_table\");\n//                         frappe.model.set_value(child.doctype, child.name, \"name1\", x.name1);\n//                         frappe.model.set_value(child.doctype, child.name, \"co_reg_number\", x.registration_number);\n//                         frappe.model.set_value(child.doctype, child.name, \"_shares_held\", x.share_held);\n//                          frappe.model.set_value(child.doctype, child.name, \"nature_of_bussiness\", x.nature_of_business);\n//                         frappe.model.set_value(child.doctype, child.name, \"bond_required\", x.bond_required);\n//                     });\n\n//                     frm.refresh_field('company_table');\n               \n//                 } else {\n//                     console.warn(\"No Buyer Experience data found in DCI Proposals for this client.\");\n//                 }\n//             }\n//         });\n        \n//     //personel Child Table    \n//           frappe.call({\n//             method: \"frappe.client.get\",\n//             args: {\n//                 doctype: \"Bond Facility\",\n//                 filters: { client_name: frm.doc.registered_name }\n//             },\n//             callback: function(r) {\n//                 console.log(\"Bond Facility Response:\", r);\n\n//                 if (!r.exc && r.message && r.message.personel_child && r.message.personel_child.length > 0) {\n//                     const data = r.message.personel_child;\n\n//                     // Clear the existing rows before adding new ones\n//                     frm.clear_table('personel_table');\n\n//                     data.forEach(x => {\n//                         const child = frappe.model.add_child(frm.doc, \"personel Child Table\", \"personel_table\");\n//                         frappe.model.set_value(child.doctype, child.name, \"name1\", x.name1);\n//                         frappe.model.set_value(child.doctype, child.name, \"period_with_company\", x.period_with_companyyears);\n//                         frappe.model.set_value(child.doctype, child.name, \"position\", x.position);\n//                     });\n\n//                     frm.refresh_field('personel_table');\n               \n//                 } else {\n//                     console.warn(\"No Buyer Experience data found in DCI Proposals for this client.\");\n//                 }\n//             }\n//         });\n        \n//      //Current Bonds Child Table   \n//          frappe.call({\n//             method: \"frappe.client.get\",\n//             args: {\n//                 doctype: \"Bond Facility\",\n//                 filters: { client_name: frm.doc.registered_name }\n//             },\n//             callback: function(r) {\n//                 console.log(\"Bond Facility Response:\", r);\n\n//                 if (!r.exc && r.message && r.message.current_bond && r.message.current_bond.length > 0) {\n//                     const data = r.message.current_bond;\n\n//                     // Clear the existing rows before adding new ones\n//                     frm.clear_table('current_table');\n\n//                     data.forEach(x => {\n//                         const child = frappe.model.add_child(frm.doc, \"Current Bonds Child Table\", \"current_table\");\n//                         frappe.model.set_value(child.doctype, child.name, \"name1\", x.name_of_bankinsurance_company);\n//                         frappe.model.set_value(child.doctype, child.name, \"facility\", x.facility);\n//                         frappe.model.set_value(child.doctype, child.name, \"bondsoutstanding\", x.bonds_out_standing);\n//                         frappe.model.set_value(child.doctype, child.name, \"rate\", x.rate_charged);\n                        \n//                     });\n\n//                     frm.refresh_field('current_table');\n               \n//                 } else {\n//                     console.warn(\"No Buyer Experience data found in DCI Proposals for this client.\");\n//                 }\n//             }\n//         });\n        \n//                 }\n//             });\n\n//         }).addClass(\"btn-primary\");\n\n\n\n\n//         // REJECTION / DECLINED LETTER BUTTON\n//         if (frm.doc.workflow_state === \"Declined\") {\n//             frm.add_custom_button(\"Declined Letter\", function () {\n       \n//     console.log(\"Sending Remarks:\", frm.doc.application_remarks);\n//             frappe.route_options = {\n//               facility_no: frm.doc.facility_no,\n//                 to: frm.doc.signed_by,\n//                 client: frm.doc.client_name,\n//                 registration_no: frm.doc.reg_no,\n//                 rejection_letter_bond_facility : frm.doc.application_remarks \n            \n//             };\n        \n        \n\n//             frappe.new_doc('Rejection Letter Bond Facility');\n//             frappe.model.set_value(frm.doctype, frm.docname, 'created_date', frappe.datetime.now_datetime());\n        \n        \n      \n            \n\n//             // Auto Fetch Address\n//             frappe.ui.form.on('Rejection Letter Bond Facility', {\n//                 refresh: function(frm) {\n\n//                     frappe.call({\n//                         method: 'frappe.client.get',\n//                         args: {\n//                             doctype: 'Company-Details',\n//                             filters: {\n//                                 name1: frm.doc.client\n//                             },\n//                             fields: ['postal_address', 'location', 'physical_address']\n//                         },\n//                         callback: function(r) {\n//                             if (!r.exc && r.message) {\n\n//                                 let address = '';\n\n//                                 if (r.message.name1) address += r.message.name1 + '\\n';\n//                                 if (r.message.location) address += r.message.location + '\\n';\n//                                 if (r.message.physical_address) address += r.message.physical_address + '\\n';\n//                                 if (r.message.postal_address) address += r.message.postal_address + '\\n';\n\n//                                 frm.set_value('address', address.trim());\n//                             }\n//                         }\n//                     });\n//                 }\n//             });\n\n//             console.log(\"Rejection Letter clicked!\");\n\n//         }).addClass(\"btn-primary\");\n//         }\n//     }\n   \n//     },\nrefresh: function (frm) {\n     frm.set_df_property('group_company', 'cannot_add_rows', true);\n      frm.set_df_property('directors', 'cannot_add_rows', true);\n       frm.set_df_property('company_child', 'cannot_add_rows', true);\n        frm.set_df_property('personel_child', 'cannot_add_rows', true);\n         frm.set_df_property('current_bond', 'cannot_add_rows', true);\n\n        if (!frm.doc.facility_no) {\n            generateNumber(frm);\n        }\n\n        clear_attachment(frm);\n\n        if (frm.fields_dict.required_facility) {\n            frm.fields_dict.required_facility.$input.css(\"text-align\", \"right\");\n        }\n\n        // Style add_new buttons\n        if (frm.fields_dict.add_new) {\n            frm.fields_dict.add_new.$input.addClass('btn-primary');\n            frm.fields_dict.add_new1.$input.addClass('btn-primary');\n            frm.fields_dict.add_new2.$input.addClass('btn-primary');\n            frm.fields_dict.add_new3.$input.addClass('btn-primary');\n            frm.fields_dict.add_new4.$input.addClass('btn-primary');\n        }\n\n        // -----------------------------------------------------------------------------------------\n        // \u2b50 PRINT PROPOSAL BUTTON (Only visible when Workflow = Submitted)\n        // -----------------------------------------------------------------------------------------\n        if (frm.doc.workflow_state === \"Submitted\") {\n\n            frm.add_custom_button(__('Print Proposal'), function () {\n\n                // STEP 1: Check if Proposal already exists\n                frappe.call({\n                    method: \"frappe.client.get_list\",\n                    args: {\n                        doctype: \"Print Proposal BondFacility\",\n                        filters: {\n                            registered_name: frm.doc.client_name\n                        },\n                        limit: 1\n                    },\n                    callback: function (res) {\n\n                        if (res.message && res.message.length > 0) {\n                            // \u2b50 Already exists \u2192 OPEN EXISTING\n                            frappe.set_route(\"Form\", \"Print Proposal BondFacility\", res.message[0].name);\n                        } else {\n\n                            // \u2757 NOT exists \u2192 Create NEW\n                            frappe.route_options = {\n                                registered_name: frm.doc.client_name,\n                                nature_of_business: frm.doc.nature_of_business,\n                                registration_no: frm.doc.reg_no,\n                                name5: frm.doc.signed_by,\n                                date: frm.doc.signed_on,\n                                designation: frm.doc.capacity,\n                                facility_required: frm.doc.required_facility,\n                                data3: frm.doc.demo_1,\n                                data4: frm.doc.demo_2,\n                                data6: frm.doc.demo_3,\n                                data5: frm.doc.demo_4,\n                                other_specify: frm.doc.others_specify,\n                                remarksother_information: frm.doc.remarksother_information,\n                                addition_to_existing_facility: frm.doc.details,\n                                to_replace_existing_facility: frm.doc.application_remarks,\n                                bankers: frm.doc.name1,\n                                accno: frm.doc.ac_no,\n                                period_with_bank: frm.doc.period_with_bankyears,\n                                cash_balance_p: frm.doc.cash_balance,\n                                investments_p: frm.doc.investment,\n                                overdraft_facility_usd: frm.doc.overdraft_facility,\n                                overdraft_used_usd: frm.doc.overdraft_used,\n                                how_secured: frm.doc.how_secured,\n                                bank_guarantee_facility_usd: frm.doc.bank_guarentee__facility,\n                                guarantee_outstanding_usd: frm.doc.guarentee__outstanding,\n                                other_bankers: frm.doc.other_bankers\n                            };\n\n                            frappe.new_doc(\"Print Proposal BondFacility\");\n                        }\n                    }\n                });\n\n            }).addClass(\"btn-primary\");\n        }\n\n        // -----------------------------------------------------------------------------------------\n        // \u2b50 DECLINED LETTER BUTTON (Only visible when Workflow = Declined)\n        // -----------------------------------------------------------------------------------------\n        if (frm.doc.workflow_state === \"Declined\") {\n\n            frm.add_custom_button(\"Declined Letter\", function () {\n\n                // STEP 1: Check if declined letter already exists\n                frappe.call({\n                    method: \"frappe.client.get_list\",\n                    args: {\n                        doctype: \"Rejection Letter Bond Facility\",\n                        filters: {\n                            facility_no: frm.doc.facility_no\n                        },\n                        limit: 1\n                    },\n                    callback: function (res) {\n\n                        if (res.message && res.message.length > 0) {\n\n                            // \u2b50 Already exists \u2192 OPEN EXISTING\n                            frappe.set_route(\"Form\", \"Rejection Letter Bond Facility\", res.message[0].name);\n\n                        } else {\n\n                            // \u2757 NOT exists \u2192 Create NEW\n                            frappe.route_options = {\n                                facility_no: frm.doc.facility_no,\n                                to: frm.doc.signed_by,\n                                client: frm.doc.client_name,\n                                registration_no: frm.doc.reg_no,\n                                rejection_letter_bond_facility: frm.doc.application_remarks\n                            };\n\n                            frappe.new_doc(\"Rejection Letter Bond Facility\");\n                        }\n                    }\n                });\n\n            }).addClass(\"btn-primary\");\n        }\n    },\n\n    // Group Company Tab\nadd_new4: function(frm) {\n    frappe.prompt([\n        {\n            fieldname: 'company',\n            fieldtype: 'Link',\n            label: 'Company',\n            options: 'Company-Details',   // Link to your doctype\n            reqd: 1,\n            onchange: function() {\n                let company_name = this.value;\n                if (company_name) {\n                    // Fetch postal_address from Company-Details doctype\n                    frappe.db.get_value('Company-Details', company_name, 'postal_address')\n                        .then(r => {\n                            if (r && r.message && r.message.postal_address) {\n                                // \u2705 Auto-set address in prompt dialog\n                                cur_dialog.set_value('address', r.message.postal_address);\n                            } else {\n                                // If no address found, clear the field\n                                cur_dialog.set_value('address', '');\n                            }\n                        });\n                } else {\n                    // If no company selected, clear the address\n                    cur_dialog.set_value('address', '');\n                }\n            }\n        },\n        {\n            fieldname: 'address',\n            fieldtype: 'Data',\n            label: 'Address',\n            read_only: 1   // \u2705 auto-filled, user cannot edit\n        },\n        {\n            fieldname: 'type',\n            fieldtype: 'Select',\n            label: 'Type',\n            options: ['ASSOCIATED', 'AFFILIATED', 'GROUP'],\n            reqd: 1\n        }\n    ],\n    function(values) {\n        // \u2705 Save the prompt values into localStorage\n        var data = {\n            company: values.company,\n            address: values.address,\n            type: values.type\n        };\n        localStorage.setItem('group_company', JSON.stringify(data));\n\n        var group_company = JSON.parse(localStorage.getItem('group_company'));\n        addDataToGroupCompanyChild(frm, group_company);\n    },\n    'Group Company',\n    'Submit');\n},\n    \n//Personnel Tab\n add_new3: function(frm) {\n        frappe.prompt([\n            {'fieldname': 'name1', 'fieldtype': 'Data', 'label': 'Name', 'reqd': 1},\n            {'fieldname': 'position', 'fieldtype': 'Data', 'label': 'Position', 'reqd': 1},\n            {'fieldname': 'period_with_companyyears', 'fieldtype': 'Data', 'label': 'Period With Company(Years)', 'reqd': 1}\n        ],\n        function(values) {\n            var data1 = {\n                name1: values.name1,\n                position: values.position,\n                period_with_companyyears: values.period_with_companyyears\n            };\n            localStorage.setItem('personel_child', JSON.stringify(data1));\n            var personel_child = JSON.parse(localStorage.getItem('personel_child'));\n            addDataTopersonnelchildbondfacility(frm, personel_child);\n        }, 'Personnel');\n    },\n    \n//Current Bonds Tab\n add_new2: function(frm) {\n        frappe.prompt([\n            {'fieldname': 'name_of_bankinsurance_company', 'fieldtype': 'Data', 'label': 'Name Of Bank/Insurance Company', 'reqd': 1},\n            {'fieldname': 'facility', 'fieldtype': 'Data', 'label': 'Facility', 'reqd': 1},\n            {'fieldname': 'bonds_out_standing', 'fieldtype': 'Data', 'label': 'Bond(s) OutStanding', 'reqd': 1},\n            {'fieldname': 'rate_charged', 'fieldtype': 'Data', 'label': 'Rate Charged', 'reqd': 1},\n        ],\n        function(values) {\n            var data1 = {\n                name_of_bankinsurance_company: values.name_of_bankinsurance_company,\n                facility: values.facility,\n                bonds_out_standing: values.bonds_out_standing,\n                rate_charged: values.rate_charged,\n            };\n            localStorage.setItem('current_bond', JSON.stringify(data1));\n            var current_bond = JSON.parse(localStorage.getItem('current_bond'));\n            addDataToCurrentBondChildBondFacility(frm, current_bond);\n        }, 'Current Bond');\n    },\n    // Company Tab\nadd_new1: function(frm) {\n    frappe.prompt([\n        {\n            fieldname: 'name1',\n            fieldtype: 'Link',\n            label: 'Name',\n            options: 'Company-Details',\n            reqd: 1,\n            onchange: function() {\n                let company_name = this.value;\n\n                if (company_name) {\n                    // Fetch 'business' field from Company-Details\n                    frappe.db.get_value('Company-Details', company_name, 'business')\n                        .then(r => {\n                            if (r && r.message && r.message.business) {\n                                cur_dialog.set_value('nature_of_business', r.message.business);\n                            } else {\n                                cur_dialog.set_value('nature_of_business', '');\n                            }\n                        });\n\n                    // \u2705 Compare name1 (prompt) with client_name (form)\n                    if (frm.doc.client_name && frm.doc.client_name === company_name) {\n                        frappe.db.get_value('DCI Proposals', { client_name: company_name }, 'registrationno')\n                            .then(r => {\n                                if (r && r.message && r.message.registrationno) {\n                                    cur_dialog.set_value('registration_number', r.message.registrationno);\n                                } else {\n                                    cur_dialog.set_value('registration_number', '');\n                                }\n                            });\n                    } else {\n                        // Clear registration number if not matched\n                        cur_dialog.set_value('registration_number', '');\n                    }\n                } else {\n                    cur_dialog.set_value('nature_of_business', '');\n                    cur_dialog.set_value('registration_number', '');\n                }\n            }\n        },\n        {\n            fieldname: 'registration_number',\n            fieldtype: 'Data',\n            label: 'Registration Number'\n        },\n        {\n            fieldname: 'share_held',\n            fieldtype: 'Data',\n            label: '% Shares Held',\n            reqd: 1\n        },\n        { fieldname: '', fieldtype: 'Column Break' },\n        {\n            fieldname: 'nature_of_business',\n            fieldtype: 'Data',\n            label: 'Nature Of Business'\n        },\n        {\n            fieldname: 'bond_required',\n            fieldtype: 'Check',\n            label: 'Bond Required'\n        }\n    ],\n    function(values) {\n        var data1 = {\n            name1: values.name1,\n            registration_number: values.registration_number,\n            share_held: values.share_held,\n            nature_of_business: values.nature_of_business,\n            bond_required: values.bond_required\n        };\n        addDataToCompanyChildBondFacility(frm, data1);\n    },\n    'Company',\n    'Submit');\n},\n    \n  //Directors and Shareholders\n  add_new: function(frm) {\n    const style = document.createElement('style');\n    style.innerHTML = `\n        .frappe-control[data-fieldname=\"contact_no\"] .form-control {\n            padding-top: 1px; /* Adjust the padding to shift the text */\n            box-sizing: border-box; /* Ensure padding does not affect the field's overall size */\n        }\n    `;\n    document.head.appendChild(style);\n\n    frappe.prompt([\n        {'fieldname': 'id_type', 'fieldtype': 'Select', 'options': '\\nDRIVING LICENSE\\nREAD ID NUMBER\\nPASSPORT', 'label': 'ID Type',  reqd: 1 },\n        {'fieldname': 'id_number', 'fieldtype': 'Data', 'label': 'ID Number',  reqd: 1 },\n        {'fieldname': 'surname', 'fieldtype': 'Data', 'label': 'Surname', reqd: 1},\n        {'fieldname': 'first_name', 'fieldtype': 'Data', 'label': 'First Name', reqd: 1},\n        {'fieldname': 'middle_name', 'fieldtype': 'Data', 'label': 'Middle Name'},\n        {'fieldname': 'e_mail_id', 'fieldtype': 'Data', 'label': 'Email ID'},\n        {'fieldname': '', 'fieldtype': 'Column Break'},\n        {'fieldname': 'fax_no', 'fieldtype': 'Data', 'label': 'Fax No'},\n        {'fieldname': 'contact_no', 'fieldtype': 'Phone', 'label': 'Contact No', reqd: 1},\n        {'fieldname': 'designation', 'fieldtype': 'Select', 'options': '\\nDIRECTOR\\nMEMBER\\nMANAGER\\nOTHERS\\nPARTNER\\nPROPRIETOR', 'label': 'Designation'},\n        {'fieldname': 'share_held', 'fieldtype': 'Data', 'label': '% Share Held', reqd: 1},\n        {'fieldname': 'married_anccop', 'fieldtype': 'Select', 'options': '\\nANC\\nCOP', 'label': 'Married ANC/COP'},\n    ], function(values) {\n        // Combine the names to create full_name\n        var full_name = [values.surname, values.first_name, values.middle_name].filter(Boolean).join(' ');\n\n        var data = {\n            id_type: values.id_type,\n            id_number: values.id_number,\n            first_name: values.first_name,\n            middle_name: values.middle_name,\n          //  surname: values.surname,\n            surname: values.surname,\n            contact_no: values.contact_no,\n            married_anccop: values.married_anccop,\n            share_held: values.share_held,\n            full_name: full_name, // Add the full_name field\n            fax_no: values.fax_no, // Capture the fax_no as well\n            e_mail_id: values.e_mail_id, // Capture email id\n            designation: values.designation // Capture designation\n        };\n\n        // Call the function to add data to the child table  \n        addDataToChildTable(frm, data);\n\n        // Set the full_name back to the parent form if needed\n      // frm.set_value('full_name', full_name); // This sets the full_name in the parent doctype if you have a field for it\n    }, 'Directors/ShareHolders', 'Add New Director');\n}, \n  validate: function(frm) {\n        if (frm.doc.ac_no && frm.doc.ac_no.length !== 11) {\n            frappe.throw(\"Account Number must be exactly 11 digits.\");\n        }\n    },\n   setup: function(frm) {\n        frm.fields_dict['client_name'].get_query = function(doc) {\n            return {\n                doctype: 'Company-Details',\n                filters: {\n                    'status': 'Active'\n                }\n            };\n        };\n    },\n     \n client_name: function(frm) {\n    if (frm.doc.client_name) {\n        frappe.call({\n            method: \"frappe.client.get_list\",\n            args: {\n                doctype: \"Bond Facility\",\n                filters: {\n                    client_name: frm.doc.client_name\n                },\n                fields: [\"name\"],\n                limit_page_length: 0\n            },\n            callback: function(r) {\n                if (r.message && r.message.length > 0) {\n                    frappe.msgprint(__('Client already exists!'));\n                } else {\n                    // Check if the client name is 'approved'\n                    if (frm.doc.client_name.toLowerCase() === 'approved') {\n                        if (!frm.doc.msg_displayed) {\n                            frappe.msgprint(__('Client Name is approved!'));\n                            frm.set_value('msg_displayed', 1);\n                        } else {\n                            frappe.msgprint(__('The client name is already approved.'));\n                        }\n                    } else {\n                        // frm.set_value('msg_displayed', 0);\n                    }\n                }\n            }\n        });\n    }\n\nfrappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'DCI Proposals',\n                    filters: {\n                        client_name: frm.doc.client_name\n                    },\n                    fields: ['registrationno', 'establishmentdate'],  // \ud83d\udd39 replace with your actual fieldnames\n                    limit: 1\n                },\n                callback: function(r) {\n                    if (r.message && r.message.length > 0) {\n                        let dci = r.message[0];\n                        frm.set_value('reg_no', dci.registrationno);\n                        frm.set_value('estd_date', dci.establishmentdate);\n                    } else {\n                        frappe.msgprint(__('No DCI Proposal found for this client'));\n                    }\n                }\n            });\n}\n});\n\n frappe.ui.form.on('Rejection Letter Bond Facility', {\n                refresh: function(frm) {\n                    frappe.call({\n                        method: 'frappe.client.get',\n                        args: {\n                            doctype: 'Company-Details',\n                            filters: { name1: frm.doc.client },\n                            fields: ['postal_address', 'location', 'physical_address']\n                        },\n                        callback: function(r) {\n                            if (!r.exc && r.message) {\n                                let address = '';\n                                if (r.message.name1) address += r.message.name1 + '\\n';\n                                if (r.message.location) address += r.message.location + '\\n';\n                                if (r.message.physical_address) address += r.message.physical_address + '\\n';\n                                if (r.message.postal_address) address += r.message.postal_address + '\\n';\n                                frm.set_value('address', address.trim());\n                            }\n                        }\n                    });\n                }\n            });\n    \n     frappe.ui.form.on('Print Proposal BondFacility', {\n                refresh: function(frm) {\n\n                    frm.set_df_property('group_company','cannot_add_rows', true);\n                    frm.set_df_property('director_table','cannot_add_rows', true);\n                    frm.set_df_property('company_table','cannot_add_rows', true);\n                    frm.set_df_property('personel_table','cannot_add_rows', true);\n                    frm.set_df_property('current_table','cannot_add_rows', true);\n\n                    // \u2705 All existing frappe calls remain exactly as they are\n                    frappe.call({\n                        method: 'frappe.client.get',\n                        args: {\n                            doctype: 'Company-Details',\n                            filters: { name1: frm.doc.registered_name },\n                            fields: ['postal_address', 'location','telephone','fax', 'physical_address']\n                        },\n                        callback: function(r) {\n                            if (!r.exc && r.message) {\n                                frm.set_value('telephone', r.message.telephone || '');\n                                frm.set_value('postal_adress', r.message.postal_address || '');\n                                frm.set_value('fax', r.message.fax || '');\n\n                                let combined_address = '';\n                                if (r.message.physical_address) combined_address += r.message.physical_address;\n                                if (r.message.location) combined_address += (combined_address ? ' , ' : '') + r.message.location;\n\n                                frm.set_value('physical_address', combined_address);\n                                frm.refresh_fields(['telephone', 'postal_address', 'fax', 'physical_address']);\n                            }\n                        }\n                    });\n\n                    // Group Company\n                    frappe.call({\n                        method: \"frappe.client.get\",\n                        args: { doctype: \"Bond Facility\", filters: { client_name: frm.doc.registered_name } },\n                        callback: function(r) {\n                            if (!r.exc && r.message && r.message.group_company && r.message.group_company.length > 0) {\n                                const data = r.message.group_company;\n                                frm.clear_table('group_company');\n                                data.forEach(x => {\n                                    const child = frappe.model.add_child(frm.doc, \"Group Company\", \"group_company\");\n                                    frappe.model.set_value(child.doctype, child.name, \"compid\", x.company);\n                                    frappe.model.set_value(child.doctype, child.name, \"compname\", x.address);\n                                    frappe.model.set_value(child.doctype, child.name, \"comptype\", x.type);\n                                });\n                                frm.refresh_field('group_company');\n                            }\n                        }\n                    });\n\n                    // Director and Shareholder Child Table\n                    frappe.call({\n                        method: \"frappe.client.get\",\n                        args: { doctype: \"Bond Facility\", filters: { client_name: frm.doc.registered_name } },\n                        callback: function(r) {\n                            if (!r.exc && r.message && r.message.directors && r.message.directors.length > 0) {\n                                const data = r.message.directors;\n                                frm.clear_table('director_table');\n                                data.forEach(x => {\n                                    const child = frappe.model.add_child(frm.doc, \"Director and Shareholder Child Table\", \"director_table\");\n                                    frappe.model.set_value(child.doctype, child.name, \"shares_held\", x.share_held);\n                                    frappe.model.set_value(child.doctype, child.name, \"d_number_coregnumber\", x.id_number);\n                                    frappe.model.set_value(child.doctype, child.name, \"full_names\", x.full_name);\n                                    frappe.model.set_value(child.doctype, child.name, \"married_anc_cop\", x.married_anccop);\n                                });\n                                frm.refresh_field('director_table');\n                            }\n                        }\n                    });\n\n                    // Company child bond facility\n                    frappe.call({\n                        method: \"frappe.client.get\",\n                        args: { doctype: \"Bond Facility\", filters: { client_name: frm.doc.registered_name } },\n                        callback: function(r) {\n                            if (!r.exc && r.message && r.message.company_child && r.message.company_child.length > 0) {\n                                const data = r.message.company_child;\n                                frm.clear_table('company_table');\n                                data.forEach(x => {\n                                    const child = frappe.model.add_child(frm.doc, \"Company child bond facility\", \"company_table\");\n                                    frappe.model.set_value(child.doctype, child.name, \"name1\", x.name1);\n                                    frappe.model.set_value(child.doctype, child.name, \"co_reg_number\", x.registration_number);\n                                    frappe.model.set_value(child.doctype, child.name, \"_shares_held\", x.share_held);\n                                    frappe.model.set_value(child.doctype, child.name, \"nature_of_bussiness\", x.nature_of_business);\n                                    frappe.model.set_value(child.doctype, child.name, \"bond_required\", x.bond_required);\n                                });\n                                frm.refresh_field('company_table');\n                            }\n                        }\n                    });\n\n                    // Personel Child Table\n                    frappe.call({\n                        method: \"frappe.client.get\",\n                        args: { doctype: \"Bond Facility\", filters: { client_name: frm.doc.registered_name } },\n                        callback: function(r) {\n                            if (!r.exc && r.message && r.message.personel_child && r.message.personel_child.length > 0) {\n                                const data = r.message.personel_child;\n                                frm.clear_table('personel_table');\n                                data.forEach(x => {\n                                    const child = frappe.model.add_child(frm.doc, \"personel Child Table\", \"personel_table\");\n                                    frappe.model.set_value(child.doctype, child.name, \"name1\", x.name1);\n                                    frappe.model.set_value(child.doctype, child.name, \"period_with_company\", x.period_with_companyyears);\n                                    frappe.model.set_value(child.doctype, child.name, \"position\", x.position);\n                                });\n                                frm.refresh_field('personel_table');\n                            }\n                        }\n                    });\n\n                    // Current Bonds Child Table\n                    frappe.call({\n                        method: \"frappe.client.get\",\n                        args: { doctype: \"Bond Facility\", filters: { client_name: frm.doc.registered_name } },\n                        callback: function(r) {\n                            if (!r.exc && r.message && r.message.current_bond && r.message.current_bond.length > 0) {\n                                const data = r.message.current_bond;\n                                frm.clear_table('current_table');\n                                data.forEach(x => {\n                                    const child = frappe.model.add_child(frm.doc, \"Current Bonds Child Table\", \"current_table\");\n                                    frappe.model.set_value(child.doctype, child.name, \"name1\", x.name_of_bankinsurance_company);\n                                    frappe.model.set_value(child.doctype, child.name, \"facility\", x.facility);\n                                    frappe.model.set_value(child.doctype, child.name, \"bondsoutstanding\", x.bonds_out_standing);\n                                    frappe.model.set_value(child.doctype, child.name, \"rate\", x.rate_charged);\n                                });\n                                frm.refresh_field('current_table');\n                            }\n                        }\n                    });\n\n                }\n            });\n            \nfunction generateNumber(frm) {\n    if (!frm.doc.facility_no) {\n        let currentYear = new Date().getFullYear();\n        let prefix = `BFC/${currentYear}/`;\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Bond Facility',\n                fields: ['facility_no', 'creation'],\n                order_by: 'creation desc',\n                limit: 1\n            },\n            callback: function(r) {\n                if (r.message && r.message.length > 0) {\n                    let lastFacilityNo = r.message[0].facility_no;\n                    let lastNumber = parseInt(lastFacilityNo.split(\"/\").pop());\n                    if (!isNaN(lastNumber)) {\n                        let newNumber = (lastNumber + 1).toString().padStart(4, '0');\n                        frm.set_value('facility_no', prefix + newNumber);\n                    }\n                } else {\n                    frm.set_value('facility_no', prefix + '0001');\n                }\n            }\n        });\n    }\n}\nfunction addDataToGroupCompanyChild(frm, data) {\n    var childTable = frm.fields_dict['group_company'].grid;\n    var newRow = frappe.model.add_child(frm.doc, 'Group Company Child Doctype', 'group_company');\n    frappe.model.set_value(newRow.doctype, newRow.name, 'company', data.company);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'address', data.address);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'type', data.type);\n\n    frm.refresh_field('group_company');\n}\n\n//personnel\nfunction addDataTopersonnelchildbondfacility(frm, data) {\n    var childTable = frm.fields_dict['personel_child'].grid;\n    var newRow = frappe.model.add_child(frm.doc, childTable.doctype, 'personel_child');\n    frappe.model.set_value(newRow.doctype, newRow.name, 'name1', data.name1);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'position', data.position);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'period_with_companyyears', data.period_with_companyyears);\n    \n    frm.refresh_field('personel_child');\n}\n\n//Current Bonds tAb\n\nfunction addDataToCurrentBondChildBondFacility(frm, data) {\n    var childTable = frm.fields_dict['current_bond'].grid;\n    var newRow = frappe.model.add_child(frm.doc, childTable.doctype, 'current_bond');\n    frappe.model.set_value(newRow.doctype, newRow.name, 'name_of_bankinsurance_company', data.name_of_bankinsurance_company);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'facility', data.facility);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'bonds_out_standing', data.bonds_out_standing);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'rate_charged', data.rate_charged);\n    frm.refresh_field('current_bond');\n}\n\n\n//Company tab\n\nfunction addDataToCompanyChildBondFacility(frm, data1) {\n    var childTable = frm.fields_dict['company_child'].grid;\n    var newRow = frappe.model.add_child(frm.doc, childTable.doctype, 'company_child');\n    frappe.model.set_value(newRow.doctype, newRow.name, 'name1', data1.name1);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'registration_number', data1.registration_number);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'share_held', data1.share_held);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'nature_of_business', data1. nature_of_business);\n    frappe.model.set_value(newRow.doctype, newRow.name, 'bond_required', data1.bond_required);\n    frm.refresh_field('company_child');\n}\n\n\n//directors and shareholders\nfunction addDataToChildTable(frm, data) {\n    // Add a new row to the child table\n    var newRow = frappe.model.add_child(frm.doc, 'Directors', 'directors');\n\n    // Directly set the values to the new row\n    newRow.id_type = data.id_type;\n    newRow.id_number = data.id_number;\n    newRow.first_name = data.first_name;\n    newRow.middle_name = data.middle_name;\n    newRow.surname = data.surname;\n    newRow.contact_no = data.contact_no;\n    newRow.married_anccop = data.married_anccop;\n    newRow.share_held = data.share_held;\n    newRow.fax_no = data.fax_no;\n    newRow.e_mail_id = data.e_mail_id;\n    newRow.designation = data.designation;\n\n    // Set the 'name' field in the child doctype to the full_name\n    newRow.full_name = data.full_name;\n\n    // Refresh the child table to reflect the new row\n    frm.refresh_field('directors');\n}\n\n\n\nfunction clear_attachment(frm) {\n    if (frm.doc.status === \"Submitted\" || frm.doc.workflow_state === \"Submitted\") {\n        // Disable the file attachment field\n        frm.set_df_property(\"file_attach_fieldname\", \"read_only\", 1);\n\n        // Disable the \"Clear\" button immediately\n        $(\".btn[data-action='clear_attachment']\").prop(\"disabled\", true).addClass(\"disabled\");\n    } else {\n        // Enable the file attachment field\n        frm.set_df_property(\"file_attach_fieldname\", \"read_only\", 0);\n\n        // Enable the \"Clear\" button immediately\n        $(\".btn[data-action='clear_attachment']\").prop(\"disabled\", false).removeClass(\"disabled\");\n    }\n}\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Credit Note",
  "enabled": 1,
  "modified": "2025-12-09 11:22:15.996574",
  "module": "Finance",
  "name": "Final Script",
  "script": "frappe.ui.form.on('Credit Note', {\n\trefresh(frm) {\n\t    \n\t                fetchDomesticDeclaration(frm, frm.doc.ed_number);\n\n\t   \n\t    let inv = frm.doc.invoice_number || frm.doc.invoice_no;\n        toggle_sections_based_on_invoice(frm, inv);\n       // toggle_quotation_field(frm, frm.doc.invoice_number);\n      \n\t  // First time (new form, not saved)\n        if (frm.is_new() || frm.doc.__islocal) {\n            // Show this only before save\n            frm.toggle_display(\"invoice_number\", true);\n            frm.toggle_display(\"invoice_no\", false);\n        }\n\n        // After saving document\n        else {\n            // Show this only after save\n            frm.toggle_display(\"invoice_number\", false);\n            frm.toggle_display(\"invoice_no\", true);\n        }\n          toggle_sections_based_on_invoice(frm, frm.doc.invoice_number);\n        // //  toggle_quotation_field(frm, frm.doc.invoice_number);\n        //      if (frm.is_new()) {\n        //     frm.enable_save();\n\n        //     setTimeout(() => {\n        //         frm.page.btn_primary.show();   // Show Save button\n        //     }, 50);\n        // }\n\n        // // CASE 2: Existing document \u2192 hide Save button\n        // else {\n        //     frm.disable_save();\n\n        //     setTimeout(() => {\n        //         frm.page.btn_primary.hide();   // Hide Save\n        //         $('button[data-label=\"Save\"]').hide(); // Hide in menu\n        //     }, 50);\n        // }\n // Hide button on NEW form (before save)\n        if (frm.is_new()) {\n            return;\n        }\n        \n// Add Tax Invoice button ONLY after save\nfrm.add_custom_button(\"Tax Invoice\", function () {\n\n    let inv = frm.doc.invoice_no || \"\";\n\n    // 1\ufe0f\u20e3 Decide Route (Domestic / Export)\n    let target_doctype = \"\";\n\n    if (inv.includes(\"/D\")) {\n        target_doctype = \"Credit Note Tax Invoice Domestic\";\n    }\n    else if (inv.includes(\"/E\")) {\n        target_doctype = \"Credit Note Tax Invoice Export\";\n    }\n    else {\n        frappe.msgprint(\"Invalid Invoice Number Format (Missing /D or /E).\");\n        return;\n    }\n\n    // 2\ufe0f\u20e3 First check if record already exists\n    frappe.call({\n        method: \"frappe.client.get_list\",\n        args: {\n            doctype: target_doctype,\n            filters: {\n                credit_note_no: frm.doc.credit_note_no,\n                invoice2: frm.doc.invoice_number,\n                quotation_number: frm.doc.quotation_number,\n                invoice1: frm.doc.policy_holder\n            },\n            fields: [\"name\"],\n            limit: 1\n        },\n\n        callback: function (exist) {\n\n            if (exist.message && exist.message.length > 0) {\n                frappe.set_route(\"Form\", target_doctype, exist.message[0].name);\n                return;\n            }\n\n            // 3\ufe0f\u20e3 Fetch Company Details\n            frappe.call({\n                method: \"frappe.client.get_value\",\n                args: {\n                    doctype: \"Company-Details\",\n                    fieldname: [\n                        \"telephone\",\n                        \"fax\",\n                        \"postal_address\",\n                        \"location\",\n                        \"contact_person\",\n                        \"vat_reg_no\",\n                        \"country\"\n                    ],\n                    filters: { name: frm.doc.policy_holder }\n                },\n\n                callback: function (r1) {\n\n                    if (!r1.message) {\n                        frappe.msgprint(\"Company Details not found!\");\n                        return;\n                    }\n\n                    let telephone = r1.message.telephone;\n                    let fax = r1.message.fax;\n                    let postal_address = r1.message.postal_address;\n                    let location = r1.message.location;\n                    let contact_person = r1.message.contact_person;\n                    let vat_reg_no = r1.message.vat_reg_no;\n                    let country = r1.message.country;\n\n                    // 4\ufe0f\u20e3 Fetch Policy Number\n                    frappe.call({\n                        method: \"frappe.client.get_value\",\n                        args: {\n                            doctype: \"Policy Approvals\",\n                            fieldname: [\"policy_number\"],\n                            filters: { policy_holder: frm.doc.policy_holder }\n                        },\n\n                        callback: function (r2) {\n                            let policy_number = r2.message?.policy_number || \"\";\n\n                            // 5\ufe0f\u20e3 Pass Route Options\n                            frappe.route_options = {\n                                invoice1: frm.doc.policy_holder,\n                                date1: frm.doc.invoice_date,\n                                invoice2: frm.doc.invoice_number,\n                                sub_total: frm.doc.vat,\n                                month: frm.doc.month,\n                                quotation_number: frm.doc.quotation_number,\n                                credit_note_no: frm.doc.credit_note_no,\n                                currency: frm.doc.currency,   // \u2705 FIXED\n\n                                telephone,\n                                fax,\n                                address: postal_address,\n                                city: location,\n                                attn: contact_person,\n                                vat: vat_reg_no,\n                                country,\n\n                                reference1: policy_number\n                            };\n\n                            frappe.new_doc(target_doctype);\n                        }\n                    });\n                }\n            });\n        }\n    });\n\n}).addClass(\"btn-primary\");\n\n\n// \u2b50 INTERNAL INVOICE BUTTON (ONLY AFTER SAVE)\nif (!frm.is_new()) {\n\n    frm.add_custom_button(\"Internal Invoice\", function () {\n\n        let inv = frm.doc.invoice_no || \"\";\n        let target_doctype = \"\";\n\n        if (inv.includes(\"/D\")) {\n            target_doctype = \"Credit Note Internal Invoice Domestic\";\n        }\n        else if (inv.includes(\"/E\")) {\n            target_doctype = \"Credit Note Internal Invoice Export\";\n        }\n        else {\n            frappe.msgprint(\"Invalid Invoice Number Format. Cannot determine Domestic/Export.\");\n            return;\n        }\n\n        // 2\ufe0f\u20e3 Check if record exists\n        frappe.call({\n            method: \"frappe.client.get_list\",\n            args: {\n                doctype: target_doctype,\n                filters: {\n                    credit_note_no: frm.doc.credit_note_no,\n                    name1: frm.doc.policy_holder,\n                    quotation_number: frm.doc.quotation_number\n                },\n                fields: [\"name\"],\n                limit_page_length: 1\n            },\n\n            callback: function (res) {\n\n                if (res.message && res.message.length > 0) {\n                    frappe.set_route(\"Form\", target_doctype, res.message[0].name);\n                    return;\n                }\n\n                // 3\ufe0f\u20e3 Fetch Company Details\n                frappe.call({\n                    method: 'frappe.client.get_value',\n                    args: {\n                        doctype: 'Company-Details',\n                        fieldname: ['postal_address', 'location', 'vat_reg_no'],\n                        filters: { name: frm.doc.policy_holder }\n                    },\n\n                    callback: function (r) {\n\n                        if (!r.message) {\n                            frappe.msgprint(\"Company details not found for the selected Policy Holder.\");\n                            return;\n                        }\n\n                        // 4\ufe0f\u20e3 Route Options\n                        frappe.route_options = {\n                            name1: frm.doc.policy_holder,\n                            invoice_no: frm.doc.invoice_no,\n                            quotation_number: frm.doc.quotation_number,\n                            date: frm.doc.invoice_date,\n                            address: r.message.postal_address,\n                            city: r.message.location,\n                            vat: r.message.vat_reg_no,\n                            currency: frm.doc.currency,   // \u2705 FIXED\n                            credit_note_no: frm.doc.credit_note_no,\n                        };\n\n                        frappe.new_doc(target_doctype);\n                    }\n                });\n            }\n        });\n\n    }).addClass(\"btn-primary\");\n}\n\n\n\n          \t  frm.fields_dict['total_amountincl_vat'].$wrapper.find('input').css(\"text-align\", \"right\");\n         frm.fields_dict['a'].$wrapper.find('input').css(\"text-align\", \"right\");\n          frm.fields_dict['d'].$wrapper.find('input').css(\"text-align\", \"right\");\n           frm.fields_dict['dcl_amount1'].$wrapper.find('input').css(\"text-align\", \"right\");\n            frm.fields_dict['dcl_amount2'].$wrapper.find('input').css(\"text-align\", \"right\");\n             frm.fields_dict['premium_rate2'].$wrapper.find('input').css(\"text-align\", \"right\");\n              frm.fields_dict['premium_rate1'].$wrapper.find('input').css(\"text-align\", \"right\");\n       frm.set_df_property('credit_note_child','cannot_add_rows', true); \n    \n\n\t},\n\t\n\t    onload: function(frm) {\n\t           // Run after a small delay to ensure DOM is ready\n        setTimeout(() => {\n            let inv = frm.doc.invoice_number || frm.doc.invoice_no;\n            toggle_sections_based_on_invoice(frm, inv);\n        }, 100);\n       \n        // Fetch CI Invoices to populate the policy holder dropdown\n       frappe.call({\n    method: 'frappe.client.get_list',\n    args: {\n        doctype: 'CI Invoices',\n        fields: ['policy_holder'],\n         limit_page_length: 0\n    },\n    callback: function(response) {\n        if (response.message && response.message.length > 0) {\n            // Extract names\n            var policyHolders = response.message.map(inv => inv.policy_holder);\n\n            // Remove duplicates using Set\n            var uniquePolicyHolders = [...new Set(policyHolders)];\n            \n            uniquePolicyHolders.sort();\n            // Set dropdown options for policy holder field\n            frm.set_df_property('policy_holder', 'options', uniquePolicyHolders.join(\"\\n\"));\n        } else {\n            frappe.msgprint('No CI Invoices found.');\n        }\n    },\n    error: function(err) {\n        console.error(err);\n        frappe.msgprint('An error occurred while fetching CI Invoices.');\n    }\n});\n\n\t    },\n\t    \npolicy_holder: function(frm) {\n    var PH = frm.doc.policy_holder;\n\n    if (!PH) return;\n\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'CI Invoices',\n            filters: {\n                policy_holder: PH\n            },\n            fields: ['invoice_no'],\n            limit_page_length: 0\n        },\n        callback: function(res) {\n            if (res.message && res.message.length > 0) {\n\n                // Extract all invoice numbers for this policy holder\n                let invoiceList = res.message.map(r => r.invoice_no);\n\n                // Set invoice_number dropdown options\n                frm.set_df_property('invoice_number', 'options', invoiceList.join(\"\\n\"));\n\n            } else {\n                frappe.msgprint(\"No invoices found for this Policy Holder.\");\n                frm.set_df_property('invoice_number', 'options', \"\");\n            }\n        }\n    });\n},\ninvoice_number: function(frm) {\n\n    var InvoiceNumber = frm.doc.invoice_number;\n    frm.set_value('invoice_no', InvoiceNumber);\n\n    toggle_sections_based_on_invoice(frm, frm.doc.invoice_number);\n\n    // -------------------------------\n    // Fetch CI Invoice details\n    // -------------------------------\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'CI Invoices',\n            filters: {\n                policy_holder: frm.doc.policy_holder,\n                invoice_no: InvoiceNumber,\n            },\n            fields: ['invoice_date', 'vat', 'invoice_amount', 'invoice_no', 'quotation_number','ed_number','month'],\n            limit_page_length: 0\n        },\n        callback: function(response) {\n\n            if (response.message && response.message.length > 0) {\n\n                var cl_data = response.message[0];\n\n                // Set values\n                frm.set_value('invoice_date', cl_data.invoice_date || \"\");\n                frm.set_value('vat', cl_data.vat || \"\");\n                frm.set_value('total_amountincl_vat', cl_data.invoice_amount || \"\");\n                frm.set_value('quotation_number', cl_data.quotation_number || \"\");\n                frm.set_value('ed_number', cl_data.ed_number || \"\");\n                frm.set_value('month', cl_data.month || \"\");\n\n                // ------------------------------\n                // \u2b50 GENERATE CREDIT NOTE NUMBER\n                // ------------------------------\n\n                let invoiceNo = cl_data.invoice_no || '';\n                let parts = invoiceNo.split('/');\n\n                if (parts.length !== 3) {\n                    frappe.msgprint('Invalid invoice number format.');\n                    return;\n                }\n\n                let invPrefix = parts[0];     // INV\n                let invSeries = parts[2];     // D0007 / E0003\n\n                // \u2b50 GET CURRENT YEAR\n                let currentYear = new Date().getFullYear();\n\n                let firstLetter = invSeries.charAt(0);\n\n                let seriesType = '';\n                if (firstLetter === 'D') {\n                    seriesType = 'DCR';\n                } \n                else if (firstLetter === 'E') {\n                    seriesType = 'ECR';\n                } \n                else {\n                    frappe.msgprint('Invoice series must start with D or E.');\n                    return;\n                }\n\n                // New prefix \u2192 current year\n                let creditPrefix = `${invPrefix}/${currentYear}/${seriesType}`;\n\n                // --------------------------\n                // Fetch last Credit Note\n                // --------------------------\n                frappe.call({\n                    method: 'frappe.client.get_list',\n                    args: {\n                        doctype: 'Credit Note',\n                        filters: {\n                            credit_note_no: ['like', creditPrefix + '%']\n                        },\n                        fields: ['credit_note_no'],\n                        order_by: 'creation desc',\n                        limit: 1\n                    },\n                    callback: function(r) {\n\n                        let newNumber = '0001';\n\n                        if (r.message && r.message.length > 0) {\n\n                            let lastNo = r.message[0].credit_note_no;\n                            let lastParts = lastNo.split('/');\n\n                            if (lastParts.length === 3) {\n\n                                let lastSuffix = lastParts[2].replace(seriesType, '');\n\n                                if (!isNaN(lastSuffix)) {\n                                    newNumber = (parseInt(lastSuffix) + 1)\n                                        .toString().padStart(4, '0');\n                                }\n                            }\n                        }\n\n                        // Final Credit Note No\n                        frm.set_value('credit_note_no', `${creditPrefix}${newNumber}`);\n                    }\n                });\n\n            } \n            else {\n\n                frappe.msgprint(\"No invoice details found for this Policy Holder.\");\n\n                frm.set_value('invoice_date', \"\");\n                frm.set_value('vat', \"\");\n                frm.set_value('total_amountincl_vat', \"\");\n                frm.set_value('quotation_number', \"\");\n                frm.set_value('ed_number', \"\");\n                frm.set_value('month', \"\");\n            }\n\n        }\n    });\n\n    \n     frappe.call({\n            method: \"frappe.client.get\",\n            args: {\n                doctype: \"CI Invoices\",\n                filters: {\n                policy_holder: frm.doc.policy_holder,\n                invoice_no: InvoiceNumber\n                },\n                fields: [\"export_buyer\"]\n            },\n            callback: function(r) {\n                    console.log(\"Loaded CI Invoice \u2192\", r);\n\n                    if (r.message && r.message.export_buyer) {\n\n                        frm.clear_table('credit_note_child');\n\n                        r.message.export_buyer.forEach(function(buyer) {\n                            \n                            let child = frm.add_child(\"credit_note_child\");\n\n                            child.country = buyer.country;\n                            child.buyer = buyer.buyer;\n                           child.dcl_amt = Number(buyer.declamt || 0).toFixed(2);\n                            child.premium_rate = Number(buyer.premium_rate || 0).toFixed(2);\n                            child.amount = Number(buyer.premamount || 0).toFixed(2);\n                        });\n\n                        frm.refresh_field(\"credit_note_child\");\n                    }\n            }\n        });\n\n        \n\n\n\n\n\n    },\n    \n        \ned_number: function(frm) {\n        if (frm.doc.ed_number) {\n            fetchDomesticDeclaration(frm, frm.doc.ed_number);\n        }\n    },\n\n\n   invoice_no: function(frm) {\n        toggle_sections_based_on_invoice(frm, frm.doc.invoice_no);\n       // toggle_quotation_field(frm, frm.doc.invoice_number);\n\n    },\n  dcl_amount2: function(frm) {\n    calculateTotal(frm);\n},\n\n premium_rate2: function(frm) {\n    calculateTotal(frm);\n},\n  dcl_amount1: function(frm) {\n    calculateTotal_A(frm);\n},\n\n premium_rate1: function(frm) {\n    calculateTotal_A(frm);\n},\n\n\n\n});\n\n\nfunction fetchDomesticDeclaration(frm, ed_number) {\n    if (!ed_number) {\n        console.log(\"\u274c Required field missing: ed_number\");\n        return;\n    }\n\n    frappe.call({\n        method: \"frappe.client.get_list\",\n        args: {\n            doctype: \"Domestic Declarations\",\n            filters: {\n                ed_number: ed_number,\n            },\n            fields: [\"grandtotal\", \"grandtotal1\", \"premium_rate\"],\n            limit_page_length: 1\n        },\n        callback: function(res) {\n            console.log(\"========= DEBUG START =========\");\n            console.log(\"\ud83d\udd0e ED NUMBER sent:\", ed_number);\n            console.log(\"\ud83d\udd0d Domestic Declarations Response:\", res);\n\n            if (res.message && res.message.length > 0) {\n                let f = res.message[0];\n\n                console.log(\"\u2714 grandtotal:\", f.grandtotal);\n                console.log(\"\u2714 grandtotal1:\", f.grandtotal1);\n                console.log(\"\u2714 premium_rate:\", f.premium_rate);\n\n                let g1 = parseFloat(f.grandtotal) || 0;\n                let g2 = parseFloat(f.grandtotal1) || 0;\n\n                let final_amount = g1 > 0 ? g1 : (g2 > 0 ? g2 : 0);\n\n                console.log(\"\ud83d\udc49 FINAL AMOUNT PICKED:\", final_amount);\n\n                frm.set_value(\"dcl_amount1\", final_amount.toFixed(2));\n                frm.set_value(\"premium_rate1\", (parseFloat(f.premium_rate) || 0).toFixed(2));\n                frm.set_value(\"premium_rate2\", (parseFloat(f.premium_rate) || 0).toFixed(2));\n            } else {\n                console.log(\"\u274c No matching Domestic Declaration found for ED NUMBER:\", ed_number);\n\n                frm.set_value(\"dcl_amount1\", \"0.00\");\n                frm.set_value(\"premium_rate1\", \"0.00\");\n                 frm.set_value(\"premium_rate2\", \"0.00\");\n            }\n\n            console.log(\"========= DEBUG END =========\");\n        }\n    });\n}\n\n\n\nfunction toggle_sections_based_on_invoice(frm, invoice_number) {\n\n    if (!invoice_number || !invoice_number.startsWith(\"INV/\")) {\n        hide_all_fields(frm);\n        return;\n    }\n\n    let parts = invoice_number.split(\"/\");\n    if (parts.length !== 3) {\n        hide_all_fields(frm);\n        return;\n    }\n\n    let series = parts[2].charAt(0).toUpperCase(); // first letter after year\n\n    if (series === \"E\") {\n        // Show E fields\n        frm.toggle_display(\"credit_note_child\", true);\n        frm.toggle_display(\"invoce_details\", true);\n\n        // Hide D fields\n        toggle_d_block(frm, false);\n\n    } else if (series === \"D\") {\n        // Hide E fields\n        frm.toggle_display(\"credit_note_child\", false);\n        frm.toggle_display(\"invoce_details\", false);\n\n        // Show D fields\n        toggle_d_block(frm, true);\n\n    } else {\n        // Hide everything if not E or D\n        hide_all_fields(frm);\n    }\n}\n\n// ------------------------------\n// Helper: show/hide D block\n// ------------------------------\nfunction toggle_d_block(frm, show) {\n    const d_fields = [\n        \"invoice_details_section\",\n        \"dcl_amount1\",\n        \"column_break_yxuq6\",\n        \"premium_rate1\",\n        \"column_break_c44bl\",\n        \"a\",\n        \"section_break_zzse1\",\n        \"dcl_amount2\",\n        \"column_break_1mrrm\",\n        \"premium_rate2\",\n        \"column_break_vdpbh\",\n        \"d\",\n        \"column_break_5xihb\",\n        \"comments\",\n        \"column_break_0lhsl\"\n    ];\n\n    d_fields.forEach(f => frm.toggle_display(f, show));\n}\n\n// ------------------------------\n// Helper: hide everything\n// ------------------------------\nfunction hide_all_fields(frm) {\n    frm.toggle_display(\"credit_note_child\", false);\n    frm.toggle_display(\"invoce_details\", false);\n    toggle_d_block(frm, false);\n}\n\nfunction calculateTotal(frm) {\n\n    let a = (frm.doc.dcl_amount2 || 0) * (frm.doc.premium_rate2 || 0) / 100;\n\n    // round to 2 decimal places\n    let finalValue = Number(a).toFixed(2);\n\n    frm.set_value('d', finalValue);\n}\n\nfunction calculateTotal_A(frm) {\n\n    let a = (frm.doc.dcl_amount1 || 0) * (frm.doc.premium_rate1 || 0) / 100;\n\n    // round to 2 decimal places\n    let finalValue = Number(a).toFixed(2);\n\n    frm.set_value('a', finalValue);\n}\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Debit Note",
  "enabled": 1,
  "modified": "2025-12-09 11:22:41.377652",
  "module": "Finance",
  "name": "Final Debit",
  "script": "frappe.ui.form.on('Debit Note', {\n\trefresh(frm) {\n\t    let inv = frm.doc.invoice_number || frm.doc.invoice_no;\n        toggle_sections_based_on_invoice(frm, inv);\n     fetchDomesticDeclaration(frm, frm.doc.ed_number);\n      \n\t  // First time (new form, not saved)\n        if (frm.is_new() || frm.doc.__islocal) {\n            // Show this only before save\n            frm.toggle_display(\"invoice_number\", true);\n            frm.toggle_display(\"invoice_no\", false);\n        }\n\n        // After saving document\n        else {\n            // Show this only after save\n            frm.toggle_display(\"invoice_number\", false);\n            frm.toggle_display(\"invoice_no\", true);\n        }\n  toggle_sections_based_on_invoice(frm, frm.doc.invoice_number);\n    //  if (frm.is_new()) {\n    //         frm.enable_save();\n\n    //         setTimeout(() => {\n    //             frm.page.btn_primary.show();   // Show Save button\n    //         }, 50);\n    //     }\n\n    //     // CASE 2: Existing document \u2192 hide Save button\n    //     else {\n    //         frm.disable_save();\n\n    //         setTimeout(() => {\n    //             frm.page.btn_primary.hide();   // Hide Save\n    //             $('button[data-label=\"Save\"]').hide(); // Hide in menu\n    //         }, 50);\n    //     }\n        // Add Tax Invoice button ONLY after save\n        if (frm.is_new()) {\n            return;\n        }\n        frm.add_custom_button(\"Tax Invoice\", function () {\n\n    let inv = frm.doc.invoice_no || \"\";\n\n    // -----------------------------------\n    // 1\ufe0f\u20e3 Decide Route (Domestic / Export)\n    // -----------------------------------\n    let target_doctype = \"\";\n\n    if (inv.includes(\"/D\")) {\n        target_doctype = \"Credit Note Tax Invoice Domestic\";\n    }\n    else if (inv.includes(\"/E\")) {\n        target_doctype = \"Credit Note Tax Invoice Export\";\n    }\n    else {\n        frappe.msgprint(\"Invalid Invoice Number Format (Missing /D or /E).\");\n        return;\n    }\n\n    // -----------------------------------\n    // 2\ufe0f\u20e3 Check if record already exists\n    // -----------------------------------\n    frappe.call({\n        method: \"frappe.client.get_list\",\n        args: {\n            doctype: target_doctype,\n            filters: {\n                credit_note_no: frm.doc.debit_note_no,\n                invoice2: frm.doc.invoice_number,\n                quotation_number: frm.doc.quotation_number,\n                invoice1: frm.doc.policy_holder\n            },\n            fields: [\"name\"],\n            limit: 1\n        },\n\n        callback: function (exist) {\n\n            // \u2714 If record exists \u2192 OPEN IT\n            if (exist.message && exist.message.length > 0) {\n                frappe.set_route(\"Form\", target_doctype, exist.message[0].name);\n                return;\n            }\n\n            // -----------------------------------\n            // 3\ufe0f\u20e3 Fetch Company Details\n            // -----------------------------------\n            frappe.call({\n                method: \"frappe.client.get_value\",\n                args: {\n                    doctype: \"Company-Details\",\n                    fieldname: [\n                        \"telephone\",\n                        \"fax\",\n                        \"postal_address\",\n                        \"location\",\n                        \"contact_person\",\n                        \"vat_reg_no\",\n                        \"country\"\n                    ],\n                    filters: { name: frm.doc.policy_holder }\n                },\n\n                callback: function (r1) {\n                    if (!r1.message) {\n                        frappe.msgprint(\"Company Details not found!\");\n                        return;\n                    }\n\n                    let telephone = r1.message.telephone;\n                    let fax = r1.message.fax;\n                    let postal_address = r1.message.postal_address;\n                    let location = r1.message.location;\n                    let contact_person = r1.message.contact_person;\n                    let vat_reg_no = r1.message.vat_reg_no;\n                    let country = r1.message.country;\n\n                    // -----------------------------------\n                    // 4\ufe0f\u20e3 Fetch Policy Number\n                    // -----------------------------------\n                    frappe.call({\n                        method: \"frappe.client.get_value\",\n                        args: {\n                            doctype: \"Policy Approvals\",\n                            fieldname: [\"policy_number\"],\n                            filters: { policy_holder: frm.doc.policy_holder }\n                        },\n\n                        callback: function (r2) {\n\n                            // \u2b50 FIXED LINE \u2014 no more error\n                            let policy_number = (r2.message && r2.message.policy_number)\n                                ? r2.message.policy_number\n                                : \"\";\n\n                            // -----------------------------------\n                            // 5\ufe0f\u20e3 Set Route Options (New Record)\n                            // -----------------------------------\n                            frappe.route_options = {\n                                invoice1: frm.doc.policy_holder,\n                                date1: frm.doc.invoice_date,\n                                invoice2: frm.doc.invoice_number,\n                                sub_total: frm.doc.vat,\n                                month: frm.doc.month,\n                                quotation_number: frm.doc.quotation_number,\n                                  currency: frm.doc.currency,\n                                  credit_note_no: frm.doc.debit_note_no,\n\n                                telephone,\n                                fax,\n                                address: postal_address,\n                                city: location,\n                                attn: contact_person,\n                                vat: vat_reg_no,\n                                country,\n\n                                reference1: policy_number\n                            };\n\n                            frappe.new_doc(target_doctype);\n                        }\n                    });\n                }\n            });\n        }\n    });\n\n}).addClass(\"btn-primary\");\n\n  // SHOW BUTTON ONLY IF FORM IS SAVED\n        if (!frm.is_new()) {\n\n            frm.add_custom_button(\"Internal Invoice\", function () {\n\n                let inv = frm.doc.invoice_no || \"\";\n\n                // -----------------------------------\n                // 1\ufe0f\u20e3 Decide which Doctype to open\n                // -----------------------------------\n                let target_doctype = \"\";\n\n                if (inv.includes(\"/D\")) {\n                    target_doctype = \"Credit Note Internal Invoice Domestic\";\n                }\n                else if (inv.includes(\"/E\")) {\n                    target_doctype = \"Credit Note Internal Invoice Export\";\n                }\n                else {\n                    frappe.msgprint(\"Invalid Invoice Number Format. Cannot determine Domestic/Export.\");\n                    return;\n                }\n\n                // -----------------------------------\n                // 2\ufe0f\u20e3 BEFORE CREATING \u2192 CHECK IF RECORD EXISTS\n                // -----------------------------------\n                frappe.call({\n                    method: \"frappe.client.get_list\",\n                    args: {\n                        doctype: target_doctype,\n                        filters: {\n                            credit_note_no: frm.doc.debit_note_no,\n                            name1: frm.doc.policy_holder,\n                            quotation_number: frm.doc.quotation_number\n                        },\n                        fields: [\"name\"],\n                        limit_page_length: 1\n                    },\n\n                    callback: function (res) {\n\n                        // If document already exists \u2192 OPEN it\n                        if (res.message && res.message.length > 0) {\n                            let existing_doc = res.message[0].name;\n                            frappe.set_route(\"Form\", target_doctype, existing_doc);\n                            return;\n                        }\n\n                        // -----------------------------------\n                        // 3\ufe0f\u20e3 Get Company Details (only if new)\n                        // -----------------------------------\n                        frappe.call({\n                            method: 'frappe.client.get_value',\n                            args: {\n                                doctype: 'Company-Details',\n                                fieldname: ['postal_address', 'location', 'vat_reg_no'],\n                                filters: { name: frm.doc.policy_holder }\n                            },\n\n                            callback: function (r) {\n\n                                if (!r.message) {\n                                    frappe.msgprint(__('Company details not found for the selected Policy Holder.'));\n                                    return;\n                                }\n\n                                // -----------------------------------\n                                // 4\ufe0f\u20e3 Set Route Options for new record\n                                // -----------------------------------\n                                frappe.route_options = {\n                                    name1: frm.doc.policy_holder,\n                                    invoice_no: frm.doc.invoice_no,\n                                    quotation_number: frm.doc.quotation_number,\n                                      currency: frm.doc.currency,\n                                      credit_note_no: frm.doc.debit_note_no,\n                                    date: frm.doc.invoice_date,\n                                    address: r.message.postal_address,\n                                    city: r.message.location,\n                                    vat: r.message.vat_reg_no\n                                };\n\n                                // -----------------------------------\n                                // 5\ufe0f\u20e3 Create NEW Internal Invoice\n                                // -----------------------------------\n                                frappe.new_doc(target_doctype);\n                            }\n                        });\n                    }\n                });\n\n            }).addClass(\"btn-primary\"); \n        }\n\n        frm.fields_dict['total_amountincl_vat'].$wrapper.find('input').css(\"text-align\", \"right\");\n         frm.fields_dict['premium_rate'].$wrapper.find('input').css(\"text-align\", \"right\");\n          frm.fields_dict['premium_rate1'].$wrapper.find('input').css(\"text-align\", \"right\");\n          frm.fields_dict['dd_amount'].$wrapper.find('input').css(\"text-align\", \"right\");\n            frm.fields_dict['ddamount'].$wrapper.find('input').css(\"text-align\", \"right\");\n            // frm.fields_dict['premium_rate2'].$wrapper.find('input').css(\"text-align\", \"right\");\n              frm.fields_dict['premiumrate'].$wrapper.find('input').css(\"text-align\", \"right\");\n      frm.set_df_property('debit_note_child_table','cannot_add_rows', true); \n        \n         toggle_sections_based_on_invoice(frm, frm.doc.invoice_number);\n        // toggle_quotation_field(frm, frm.doc.invoice_number);\n         frm.fields_dict.ddamount.$wrapper.find(\"input\").css(\"background-color\", \"#FFF8DC\");\n\t},\n\n\t\n\t    onload: function(frm) {\n\t           // Run after a small delay to ensure DOM is ready\n        setTimeout(() => {\n            let inv = frm.doc.invoice_number || frm.doc.invoice_no;\n            toggle_sections_based_on_invoice(frm, inv);\n        }, 100);\n       \n        // Fetch CI Invoices to populate the policy holder dropdown\n       frappe.call({\n    method: 'frappe.client.get_list',\n    args: {\n        doctype: 'CI Invoices',\n        fields: ['policy_holder'],\n         limit_page_length: 0\n    },\n    callback: function(response) {\n        if (response.message && response.message.length > 0) {\n            // Extract names\n            var policyHolders = response.message.map(inv => inv.policy_holder);\n\n            // Remove duplicates using Set\n            var uniquePolicyHolders = [...new Set(policyHolders)];\n          uniquePolicyHolders.sort();\n            // Set dropdown options for policy holder field\n            frm.set_df_property('policy_holder', 'options', uniquePolicyHolders.join(\"\\n\"));\n        } else {\n            frappe.msgprint('No CI Invoices found.');\n        }\n    },\n    error: function(err) {\n        console.error(err);\n        frappe.msgprint('An error occurred while fetching CI Invoices.');\n    }\n});\n\n\t    },\n\t    \npolicy_holder: function(frm) {\n    var PH = frm.doc.policy_holder;\n\n    if (!PH) return;\n\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'CI Invoices',\n            filters: {\n                policy_holder: PH\n            },\n            fields: ['invoice_no'],\n            limit_page_length: 0\n        },\n        callback: function(res) {\n            if (res.message && res.message.length > 0) {\n\n                // Extract all invoice numbers for this policy holder\n                let invoiceList = res.message.map(r => r.invoice_no);\n\n                // Set invoice_number dropdown options\n                frm.set_df_property('invoice_number', 'options', invoiceList.join(\"\\n\"));\n\n            } else {\n                frappe.msgprint(\"No invoices found for this Policy Holder.\");\n                frm.set_df_property('invoice_number', 'options', \"\");\n            }\n        }\n    });\n},\ninvoice_number: function(frm) {\n\n    var InvoiceNumber = frm.doc.invoice_number;\n    frm.set_value('invoice_no', InvoiceNumber);\n\n    // Toggle sections\n    toggle_sections_based_on_invoice(frm, frm.doc.invoice_number);\n\n    // ---------------------------------------\n    // 1\ufe0f\u20e3 Load CI Invoice Details\n    // ---------------------------------------\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'CI Invoices',\n            filters: {\n                policy_holder: frm.doc.policy_holder,\n                invoice_no: InvoiceNumber\n            },\n            fields: [\n                'invoice_date',\n                'vat',\n                'invoice_amount',\n                'invoice_no',\n                'quotation_number',\n                'ed_number',\n                'month'\n            ],\n            limit_page_length: 1\n        },\n\n        callback: function(response) {\n\n            if (response.message && response.message.length > 0) {\n\n                let cl_data = response.message[0];\n\n                frm.set_value('invoice_date', cl_data.invoice_date || \"\");\n                frm.set_value('vat', cl_data.vat || \"\");\n                frm.set_value('total_amountincl_vat', cl_data.invoice_amount || \"\");\n                frm.set_value('quotation_number', cl_data.quotation_number || \"\");\n                frm.set_value('ed_number', cl_data.ed_number || \"\");\n                frm.set_value('month', cl_data.month || \"\");\n\n                // ---------------------------------------\n                // 2\ufe0f\u20e3 Generate Debit Note Number\n                // ---------------------------------------\n                let invoiceNo = cl_data.invoice_no || '';\n                let parts = invoiceNo.split('/');\n\n                if (parts.length !== 3) {\n                    frappe.msgprint('Invalid invoice number format.');\n                    return;\n                }\n\n                let invPrefix = parts[0];   // INV\n                let invSeries = parts[2];   // D0001 or E0001\n\n                // Get current year\n                let currentYear = new Date().getFullYear();\n\n                // Determine series type\n                let firstLetter = invSeries.charAt(0);\n                let seriesType = \"\";\n\n                if (firstLetter === \"D\") {\n                    seriesType = \"DCR\";\n                }\n                else if (firstLetter === \"E\") {\n                    seriesType = \"ECR\";\n                }\n                else {\n                    frappe.msgprint(\"Invalid invoice series (not D or E)\");\n                    return;\n                }\n\n                // Create new prefix\n                let debitPrefix = `${invPrefix}/${currentYear}/${seriesType}`;\n\n                // ---------------------------------------\n                // 3\ufe0f\u20e3 Get Last Debit Note in Same Series\n                // ---------------------------------------\n                frappe.call({\n                    method: 'frappe.client.get_list',\n                    args: {\n                        doctype: 'Debit Note',\n                        filters: {\n                            debit_note_no: ['like', debitPrefix + '%']\n                        },\n                        fields: ['debit_note_no'],\n                        order_by: 'creation desc',\n                        limit: 1\n                    },\n\n                    callback: function(r) {\n\n                        let newNumber = \"0001\";\n\n                        if (r.message && r.message.length > 0) {\n\n                            let lastNo = r.message[0].debit_note_no;\n                            let lastParts = lastNo.split('/');\n\n                            if (lastParts.length === 3) {\n\n                                let lastSuffix = lastParts[2].replace(seriesType, \"\");\n\n                                if (!isNaN(lastSuffix)) {\n                                    newNumber = (parseInt(lastSuffix) + 1)\n                                                .toString()\n                                                .padStart(4, '0');\n                                }\n                            }\n                        }\n\n                        // \u2b50 Final Debit Note Number\n                        frm.set_value('debit_note_no', `${debitPrefix}${newNumber}`);\n                    }\n                });\n\n            } else {\n\n                // No invoice found\n                frappe.msgprint(\"No invoice details found for this Policy Holder.\");\n\n                frm.set_value('invoice_date', \"\");\n                frm.set_value('vat', \"\");\n                frm.set_value('total_amountincl_vat', \"\");\n                frm.set_value('quotation_number', \"\");\n                frm.set_value('ed_number', \"\");\n                frm.set_value('month', \"\");\n            }\n\n        }\n    });\n\n//}\n\n\n\n    \n       frappe.call({\n            method: \"frappe.client.get\",\n            args: {\n                doctype: \"CI Invoices\",\n                filters: {\n                policy_holder: frm.doc.policy_holder,\n                invoice_no: InvoiceNumber\n                },\n                fields: [\"export_buyer\"]\n            },\n            callback: function(r) {\n                    console.log(\"Loaded CI Invoice \u2192\", r);\n\n                    if (r.message && r.message.export_buyer) {\n\n                        frm.clear_table('debit_note_child_table');\n\n                        r.message.export_buyer.forEach(function(buyer) {\n                            \n                            let child = frm.add_child(\"debit_note_child_table\");\n\n                       child.country = buyer.country;\n                            child.buyer = buyer.buyer;\n                         child.dclamt = Number(buyer.declamt || 0).toFixed(2); \n                         child.premium_rate = Number(buyer.premium_rate || 0).toFixed(2); \n                         child.amount = Number(buyer.premamount || 0).toFixed(2);\n                        });\n\n                        frm.refresh_field(\"debit_note_child_table\");\n                    }\n            }\n        });\n\n        \n\n// frappe.call({\n//     method: \"frappe.client.get_list\",\n//     args: {\n//         doctype: \"Domestic Declarations\",\n//         filters: {\n//             policy_holder1: frm.doc.policy_holder,\n//             ed_number: frm.doc.quotation_number,\n//             ed_number: frm.doc.ed_number,\n//         },\n//         fields: [\"grandtotal\", \"grandtotal1\", \"premium_rate\"],\n//         limit_page_length: 1\n//     },\n//     callback: function(res) {\n\n//         console.log(\"Domestic Declarations Response:\", res);\n\n//         if (res.message && res.message.length > 0) {\n//             let f = res.message[0];\n\n//             // Check which column has value\n//             let final_amount = 0;\n\n//             if (f.grandtotal && Number(f.grandtotal) !== 0) {\n//                 final_amount = Number(f.grandtotal);\n//             }\n//             else if (f.grandtotal1 && Number(f.grandtotal1) !== 0) {\n//                 final_amount = Number(f.grandtotal1);\n//             }\n\n//             frm.set_value(\"dd_amount\", final_amount.toFixed(2));\n\n//             // premium_rate for both\n//             frm.set_value(\"premium_rate\", Number(f.premium_rate || 0).toFixed(2));\n//             frm.set_value(\"premium_rate1\", Number(f.premium_rate || 0).toFixed(2));\n//         }\n//         else {\n//             frm.set_value(\"dd_amount\", \"0.00\");\n//             frm.set_value(\"premium_rate\", \"0.00\");\n//             frm.set_value(\"premium_rate1\", \"0.00\");\n//         }\n//     }\n// });\n\n\n\n\n\n    },\n    \n    \n\n   invoice_no: function(frm) {\n        toggle_sections_based_on_invoice(frm, frm.doc.invoice_no);\n        toggle_quotation_field(frm, frm.doc.invoice_number);\n    },\n    ed_number: function(frm) {\n        if (frm.doc.ed_number) {\n            fetchDomesticDeclaration(frm, frm.doc.ed_number);\n        }\n    },\n    \n     ddamount: function(frm) {\n    calculateTotal(frm);\n},\n\n premium_rate1: function(frm) {\n    calculateTotal(frm);\n},\n\n     dd_amount: function(frm) {\n    calculateTotal_A(frm);\n},\n\n premium_rate: function(frm) {\n    calculateTotal_A(frm);\n},\n\n})\n\n\nfunction toggle_sections_based_on_invoice(frm, invoice_number) {\n\n    if (!invoice_number || !invoice_number.startsWith(\"INV/\")) {\n        hide_all_fields(frm);\n        return;\n    }\n\n    let parts = invoice_number.split(\"/\");\n    if (parts.length !== 3) {\n        hide_all_fields(frm);\n        return;\n    }\n\n    let series = parts[2].charAt(0).toUpperCase(); // first letter after year\n\n    if (series === \"E\") {\n        // Show E fields\n        frm.toggle_display(\"debit_note_child_table\", true);\n        frm.toggle_display(\"invoce_details\", true);\n\n        // Hide D fields\n        toggle_d_block(frm, false);\n\n    } else if (series === \"D\") {\n        // Hide E fields\n        frm.toggle_display(\"debit_note_child_table\", false);\n        frm.toggle_display(\"invoce_details\", false);\n\n        // Show D fields\n        toggle_d_block(frm, true);\n\n    } else {\n        // Hide everything if not E or D\n        hide_all_fields(frm);\n    }\n}\n\n// ------------------------------\n// Helper: show/hide D block\n// ------------------------------\nfunction toggle_d_block(frm, show) {\n    const d_fields = [\n        \"dd_amount\",\n        \"premium_rate\",\n        \"column_break_5inxx\",\n        \"premiumrate\",\n        \"section_break_kodvm\",\n        \"ddamount\",\n        \"column_break_hrkxt\",\n        \"premium_rate1\",\n        \"column_break_gv2ul\",\n        \"premium_rate2\",\n        \"column_break_tpo84\",\n        \"comments\",\n        \"column_break_ypx6f\",\n    ];\n\n    d_fields.forEach(f => frm.toggle_display(f, show));\n}\n\n// ------------------------------\n// Helper: hide everything\n// ------------------------------\nfunction hide_all_fields(frm) {\n    frm.toggle_display(\"debit_note_child_table\", false);\n    frm.toggle_display(\"invoce_details\", false);\n    toggle_d_block(frm, false);\n}\n\n\nfunction calculateTotal(frm) {\n    let a = (frm.doc.ddamount || 0) * (frm.doc.premium_rate1 || 0) / 100;\n    let finalValue = Number(a).toFixed(2);\n\n    frm.set_value('premium_rate2', finalValue);\n\n    // Make field readonly after calculation\n    frm.set_df_property(\"premium_rate2\", \"read_only\", 1);\n    frm.refresh_field(\"premium_rate2\");\n\n    // Align right (works even after readonly)\n    frm.fields_dict['premium_rate2'].$wrapper\n        .find(\".control-value, input\")\n        .css(\"text-align\", \"right\");\n}\n\nfunction calculateTotal_A(frm) {\n    let a = (frm.doc.dd_amount || 0) * (frm.doc.premium_rate || 0) / 100;\n    let finalValue = Number(a).toFixed(2);\n\n    frm.set_value('premiumrate', finalValue);\n\n    // Make field readonly after calculation\n    frm.set_df_property(\"premiumrate\", \"read_only\", 1);\n    frm.refresh_field(\"premiumrate\");\n\n    // Align right (works even after readonly)\n    frm.fields_dict['premiumrate'].$wrapper\n        .find(\".control-value, input\")\n        .css(\"text-align\", \"right\");\n}\n\n\n\nfunction fetchDomesticDeclaration(frm, ed_no) {\n    if (!ed_no) {\n        console.log(\"\u274c Required field missing: ed_no\");\n        return;\n    }\n \n    frappe.call({\n        method: \"frappe.client.get_list\",\n        args: {\n            doctype: \"Domestic Declarations\",\n            filters: {\n                ed_number: ed_no,\n            },\n            fields: [\"grandtotal\", \"grandtotal1\", \"premium_rate\"],\n            limit_page_length: 1\n        },\n        callback: function(res) {\n            console.log(\"========= DEBUG START =========\");\n            console.log(\"\ud83d\udd0e ED NUMBER sent:\", ed_no);\n            console.log(\"\ud83d\udd0d Domestic Declarations Response:\", res);\n \n            if (res.message && res.message.length > 0) {\n                let f = res.message[0];\n \n                console.log(\"\u2714 grandtotal:\", f.grandtotal);\n                console.log(\"\u2714 grandtotal1:\", f.grandtotal1);\n                console.log(\"\u2714 premium_rate:\", f.premium_rate);\n \n                let g1 = parseFloat(f.grandtotal) || 0;\n                let g2 = parseFloat(f.grandtotal1) || 0;\n \n                let final_amount = g1 > 0 ? g1 : (g2 > 0 ? g2 : 0);\n \n                console.log(\"\ud83d\udc49 FINAL AMOUNT PICKED:\", final_amount);\n \n                frm.set_value(\"dd_amount\", final_amount.toFixed(2));\n                frm.set_value(\"premium_rate\", (parseFloat(f.premium_rate) || 0).toFixed(2));\n                 frm.set_value(\"premium_rate1\", (parseFloat(f.premium_rate) || 0).toFixed(2));\n            } else {\n                console.log(\"\u274c No matching Domestic Declaration found for ED NUMBER:\", ed_no);\n \n                frm.set_value(\"dd_amount\", \"0.00\");\n                frm.set_value(\"premium_rate\", \"0.00\");\n                 frm.set_value(\"premium_rate1\", \"0.00\");\n            }\n \n            console.log(\"========= DEBUG END =========\");\n        }\n    });\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "BondIN",
  "enabled": 1,
  "modified": "2025-11-28 14:06:40.687752",
  "module": "PracticeCiGiS",
  "name": "BondIN",
  "script": "// Form script: hide Save / New in the form header\r\nfrappe.ui.form.on(\"BondIN\", {\r\n    refresh: function(frm) {\r\n        try {\r\n            console.log(\"BondIN form refresh script running\");\r\n\r\n            // primary method\r\n            frm.disable_save();\r\n            frm.page?.btn_primary?.hide();\r\n            frm.page?.set_primary_action(null);\r\n            frm.page?.btn_secondary?.hide();\r\n            frm.page?.hide_menu_item('New');\r\n\r\n            // fallback DOM selectors (in case page object not ready)\r\n            setTimeout(function(){\r\n                // header primary button(s)\r\n                document.querySelectorAll(\".page-actions .btn-primary\").forEach(el => el.style.display = \"none\");\r\n                // menu New\r\n                document.querySelectorAll(\".dropdown-menu a[data-label='New']\").forEach(el => el.style.display = \"none\");\r\n            }, 200);\r\n        } catch (e) {\r\n            console.error(\"BondIN form script error:\", e);\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Tax Invoice For CI Invoice",
  "enabled": 0,
  "modified": "2025-12-01 08:08:56.167732",
  "module": null,
  "name": "Tax script",
  "script": "frappe.ui.form.on('Tax Invoice For CI Invoice', {\r\n\r\n    // refresh: function(frm) {\r\n\r\n    //     console.log(\"Quotation Number Value:\", frm.doc.quotation_number);\r\n\r\n    //     if (!frm.doc.quotation_number) {\r\n    //         frm.set_df_property(\"taxinvoicechildforciinvoice\", \"hidden\", 1);\r\n    //         frm.clear_table(\"taxinvoicechildforciinvoice\");\r\n    //         frm.refresh_field(\"taxinvoicechildforciinvoice\");\r\n\r\n    //         frm.set_df_property(\"tax_child\", \"hidden\", 0);\r\n    //         frm.refresh_field(\"tax_child\");\r\n    //     } \r\n    //     else {\r\n    //         frm.set_df_property(\"tax_child\", \"hidden\", 0);\r\n    //         frm.refresh_field(\"tax_child\");\r\n\r\n    //         frm.set_df_property(\"taxinvoicechildforciinvoice\", \"hidden\", 0);\r\n    //         frm.refresh_field(\"taxinvoicechildforciinvoice\");\r\n    //     }\r\n\r\n    //     // Align fields\r\n    //     frm.fields_dict.g.$input.css(\"text-align\", \"right\");\r\n    //     frm.fields_dict.currency9.$input.css(\"text-align\", \"right\");\r\n    //     frm.fields_dict.sub_total.$input.css(\"text-align\", \"right\");\r\n\r\n    //     frm.set_df_property('tax_child', 'cannot_add_rows', true);\r\n    //     frm.set_df_property('taxinvoicechildforciinvoice', 'cannot_add_rows', true);\r\n\r\n    //     calculateADD(frm);\r\n\r\n    //     // ----------- FETCH CHILD TABLE 1 -----------\r\n    //     frappe.call({\r\n    //         method: \"frappe.client.get\",\r\n    //         args: {\r\n    //             doctype: \"CI Invoices\",\r\n    //             filters: {\r\n    //                 policy_holder: frm.doc.invoice1,\r\n    //                 invoice_no: frm.doc.invoice2\r\n    //             }\r\n    //         },\r\n    //         callback: function(r) {\r\n\r\n    //             if (!r.exc && r.message && r.message.export_buyer && r.message.export_buyer.length > 0) {\r\n    //                 const data = r.message.export_buyer;\r\n\r\n    //                 frm.clear_table('taxinvoicechildforciinvoice');\r\n\r\n    //                 data.forEach(x => {\r\n    //                     var child = frappe.model.add_child(frm.doc,\r\n    //                         \"TaxInvoicechildforCIInvoice\",\r\n    //                         \"taxinvoicechildforciinvoice\");\r\n\r\n    //                     child.country = x.country;\r\n    //                     child.declaration_amount = x.declamt;\r\n    //                     child.rate = x.premium_rate;\r\n    //                     child.premium = x.premamount;\r\n    //                 });\r\n\r\n    //                 frm.refresh_field('taxinvoicechildforciinvoice');\r\n    //             }\r\n    //         }\r\n    //     });\r\n\r\n    //     // ----------- FETCH CHILD TABLE 2 AND SUM ----------\r\n    //     frappe.call({\r\n    //         method: \"frappe.client.get\",\r\n    //         args: {\r\n    //             doctype: \"CI Invoices\",\r\n    //             filters: {\r\n    //                 policy_holder: frm.doc.invoice1,\r\n    //                 invoice_no: frm.doc.invoice2\r\n    //             }\r\n    //         },\r\n    //         callback: function(r) {\r\n\r\n    //             if (!r.exc && r.message && r.message.export_invoice && r.message.export_invoice.length > 0) {\r\n    //                 const data = r.message.export_invoice;\r\n\r\n    //                 frm.clear_table('tax_child');\r\n\r\n    //                 let total_amount = 0;\r\n\r\n    //                 data.forEach(x => {\r\n    //                     var child = frappe.model.add_child(frm.doc,\r\n    //                         \"TaxinvoiceChildTable\",\r\n    //                         \"tax_child\");\r\n\r\n    //                     child.description = x.description;\r\n    //                     child.qty = x.qty;\r\n    //                     child.price = x.price;\r\n    //                     child.amount = x.amount;\r\n\r\n    //                     total_amount += parseFloat(x.amount) || 0;\r\n    //                 });\r\n\r\n    //                 frm.set_value('g', total_amount.toFixed(2));\r\n    //                 frm.refresh_field('tax_child');\r\n\r\n    //                 // \u2b50 FIX: Update totals after g updates\r\n    //                 calculate_total_premium(frm);\r\n    //                 calculateADD(frm);\r\n    //             }\r\n    //         }\r\n    //     });\r\n\r\n    //     // ----------- FETCH VAT % ----------\r\n    //     frappe.call({\r\n    //         method: \"frappe.client.get_value\",\r\n    //         args: {\r\n    //             doctype: \"CI Invoices\",\r\n    //             filters: { invoice_no: frm.doc.invoice2 },\r\n    //             fieldname: \"vat\"\r\n    //         },\r\n    //         callback: function(r) {\r\n    //             if (r.message) {\r\n    //                 frm.set_value(\"vat_percentage\", r.message.vat || 0);\r\n    //             } else {\r\n    //                 frm.set_value(\"vat_percentage\", 0);\r\n    //             }\r\n\r\n    //             // \u2b50 FIX: Recalculate after VAT updates\r\n    //             calculate_total_premium(frm);\r\n    //             calculateADD(frm);\r\n    //         }\r\n    //     });\r\n\r\n    // },\r\n    \r\n       refresh: function(frm) {\r\n\r\n        console.log(\"Quotation Number Value:\", frm.doc.quotation_number);\r\n\r\n        if (!frm.doc.quotation_number) {\r\n            frm.set_df_property(\"taxinvoicechildforciinvoice\", \"hidden\", 1);\r\n            frm.clear_table(\"taxinvoicechildforciinvoice\");\r\n            frm.refresh_field(\"taxinvoicechildforciinvoice\");\r\n\r\n            frm.set_df_property(\"tax_child\", \"hidden\", 0);\r\n            frm.refresh_field(\"tax_child\");\r\n        } \r\n        else {\r\n            frm.set_df_property(\"tax_child\", \"hidden\", 0);\r\n            frm.refresh_field(\"tax_child\");\r\n\r\n            frm.set_df_property(\"taxinvoicechildforciinvoice\", \"hidden\", 0);\r\n            frm.refresh_field(\"taxinvoicechildforciinvoice\");\r\n        }\r\n\r\n        // Align fields\r\n        frm.fields_dict.g.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.currency9.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.sub_total.$input.css(\"text-align\", \"right\");\r\n\r\n        frm.set_df_property('tax_child', 'cannot_add_rows', true);\r\n        frm.set_df_property('taxinvoicechildforciinvoice', 'cannot_add_rows', true);\r\n\r\n       // calculate_total_premium(frm);\r\n        calculateADD(frm);\r\n\r\n        // ----------- FETCH CHILD TABLE 1 -----------\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: {\r\n                doctype: \"CI Invoices\",\r\n                filters: {\r\n                    policy_holder: frm.doc.invoice1,\r\n                    invoice_no: frm.doc.invoice2\r\n                }\r\n            },\r\n            callback: function(r) {\r\n\r\n                if (!r.exc && r.message && r.message.export_buyer && r.message.export_buyer.length > 0) {\r\n                    const data = r.message.export_buyer;\r\n\r\n                    frm.clear_table('taxinvoicechildforciinvoice');\r\n\r\n                    data.forEach(x => {\r\n                        var child = frappe.model.add_child(frm.doc,\r\n                            \"TaxInvoicechildforCIInvoice\",\r\n                            \"taxinvoicechildforciinvoice\");\r\n\r\n                        child.country = x.country;\r\n                        child.declaration_amount = x.declamt;\r\n                        child.rate = x.premium_rate;\r\n                        child.premium = x.premamount;\r\n                    });\r\n\r\n                    frm.refresh_field('taxinvoicechildforciinvoice');\r\n                }\r\n            }\r\n        });\r\n\r\n        // ----------- FETCH CHILD TABLE 2 AND SUM ----------\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: {\r\n                doctype: \"CI Invoices\",\r\n                filters: {\r\n                    policy_holder: frm.doc.invoice1,\r\n                    invoice_no: frm.doc.invoice2\r\n                }\r\n            },\r\n            callback: function(r) {\r\n\r\n                if (!r.exc && r.message && r.message.export_invoice && r.message.export_invoice.length > 0) {\r\n                    const data = r.message.export_invoice;\r\n\r\n                    frm.clear_table('tax_child');\r\n\r\n                    let total_amount = 0;\r\n\r\n                    data.forEach(x => {\r\n                        var child = frappe.model.add_child(frm.doc,\r\n                            \"TaxinvoiceChildTable\",\r\n                            \"tax_child\");\r\n\r\n                        child.description = x.description;\r\n                        child.qty = x.qty;\r\n                        child.price = x.price;\r\n                        child.amount = x.amount;\r\n\r\n                        total_amount += parseFloat(x.amount) || 0;\r\n                    });\r\n\r\n                    frm.set_value('g', total_amount.toFixed(2));\r\n                    frm.refresh_field('tax_child');\r\n                }\r\n            }\r\n        });\r\n\r\n        // ----------- FETCH VAT % ----------\r\n        frappe.call({\r\n            method: \"frappe.client.get_value\",\r\n            args: {\r\n                doctype: \"CI Invoices\",\r\n                filters: { invoice_no: frm.doc.invoice2 },\r\n                fieldname: \"vat\"\r\n            },\r\n            callback: function(r) {\r\n                if (r.message) {\r\n                    frm.set_value(\"vat_percentage\", r.message.vat || 0);\r\n                } else {\r\n                    frm.set_value(\"vat_percentage\", 0);\r\n                }\r\n            }\r\n        });\r\n\r\n    },\r\n\r\n    // taxinvoicechildforciinvoice_add: function(frm) {\r\n    //     calculate_total_premium(frm);\r\n    //     calculateADD(frm);\r\n    // },\r\n\r\n    // taxinvoicechildforciinvoice_remove: function(frm) {\r\n    //     calculate_total_premium(frm);\r\n    //     calculateADD(frm);\r\n    // },\r\n    \r\n    \r\n        // // CHILD TABLE TRIGGERS\r\n    taxinvoicechildforciinvoice_add: function(frm) {\r\n        calculate_total_premium(frm);\r\n    },\r\n\r\n    taxinvoicechildforciinvoice_remove: function(frm) {\r\n        calculate_total_premium(frm);\r\n    },\r\n\r\n    g: function(frm) {\r\n        calculate_total_premium(frm);\r\n        calculateADD(frm);\r\n    },\r\n\r\n    sub_total: function(frm) {\r\n        calculateADD(frm);\r\n    },\r\n\r\n    onload: function(frm) {\r\n        frm.fields_dict.declaration_amount.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.rate.$input.css(\"text-align\", \"right\");\r\n        frm.fields_dict.premium.$input.css(\"text-align\", \"right\");\r\n\r\n        frm.set_df_property('tax_child', 'cannot_add_rows', true);\r\n        frm.set_df_property('taxinvoicechildforciinvoice', 'cannot_add_rows', true);\r\n\r\n        frm.fields_dict['g'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n        frm.fields_dict['sub_total'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n        frm.fields_dict['currency9'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n    }\r\n\r\n});\r\n\r\n\r\n// ------------------- FUNCTIONS ---------------------\r\n\r\nfunction calculate_total_premium(frm) {\r\n\r\n    let g = parseFloat(frm.doc.g) || 0;\r\n    let vat = parseFloat(frm.doc.vat_percentage) || 0;\r\n\r\n     let subtotal = (g * vat) / 100;\r\n    \r\n     \r\n\r\n    frm.set_value(\"sub_total\", subtotal.toFixed(2));\r\n    frm.refresh_field(\"sub_total\");\r\n\r\n    console.log(\"g:\", g, \"vat:\", vat, \"subtotal:\", subtotal);\r\n}\r\n\r\n\r\nfunction calculateADD(frm) {\r\n\r\n    let g = parseFloat(frm.doc.g) || 0;\r\n    let sub_total = parseFloat(frm.doc.sub_total) || 0;\r\n\r\n    let currency9 = g + sub_total;\r\n\r\n    frm.set_value(\"currency9\", currency9.toFixed(2));\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "BondIN",
  "enabled": 0,
  "modified": "2025-11-28 14:06:58.207750",
  "module": null,
  "name": "View",
  "script": "// List script: hide +Add and \"Create your first ...\" CTA\r\nfrappe.listview_settings['BondIN'] = {\r\n    onload: function(listview) {\r\n        try {\r\n            console.log(\"BondIN list script running\");\r\n\r\n            // primary method\r\n            listview.page?.btn_primary?.hide();\r\n\r\n            // fallback DOM selectors\r\n            setTimeout(function(){\r\n                // top right Add button\r\n                document.querySelectorAll(\".page-actions .btn-primary\").forEach(el => el.style.display = \"none\");\r\n                // middle \"Create your first BondIN\" CTA (in empty list)\r\n                document.querySelectorAll(\".btn.btn-primary\").forEach(el => {\r\n                    // be careful to not hide other primary buttons globally, but usually only match on list page\r\n                    if (el.innerText && el.innerText.toLowerCase().includes(\"create\") || el.innerText.includes(\"BondIN\")) {\r\n                        el.style.display = \"none\";\r\n                    }\r\n                });\r\n            }, 200);\r\n\r\n        } catch (e) {\r\n            console.error(\"BondIN list script error:\", e);\r\n        }\r\n    },\r\n\r\n    // additional: run on refresh too\r\n    onrefresh: function(listview) {\r\n        try {\r\n            listview.page?.btn_primary?.hide();\r\n        } catch(e) {}\r\n    }\r\n};\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Domestic Declarations",
  "enabled": 1,
  "modified": "2025-12-10 11:32:28.015889",
  "module": null,
  "name": "Custom script",
  "script": "frappe.ui.form.on('Domestic Declarations', {\r\n    \r\n\r\nmonth(frm) { \r\n    fetch_domestic_premium(frm);\r\n    },\r\nyear(frm) {\r\n    fetch_domestic_premium(frm); \r\n    \r\n},\r\nquotation_numbers(frm) { \r\n    fetch_domestic_premium(frm); \r\n    \r\n},\r\npolicy_number(frm) { \r\n    fetch_domestic_premium(frm); \r\n    \r\n\r\n\r\n    \r\n},\r\n\r\n\r\n    \r\n    refresh(frm) {\r\n\r\n        if (frm.doc.workflow_state === \"Accepted\") {\r\n\r\n            let btn = frm.add_custom_button(__('Prepare Invoice'), function() {\r\n\r\n       \r\n                \r\n                 if (!frm.doc.ed_number)  {  //|| !frm.doc.quotation_numbers)\r\n                    frappe.msgprint(\"Please fill quotation/ed/policyholder\");\r\n                    return;\r\n                }\r\n\r\n                const policy_holder = frm.doc.policy_holder;\r\n                const quotation_numbers = frm.doc.quotation_numbers;\r\n                const ed_number = frm.doc.ed_number;  // current document name\r\n\r\n                // -------------------------------------------------------\r\n                // CHECK IF SUBMIT TO FINANCE ALREADY EXISTS\r\n                // -------------------------------------------------------\r\n                frappe.db.get_list(\"Submit to Finance\", {\r\n                    filters: {\r\n                        name1: policy_holder,\r\n                        quotation_numbers: quotation_numbers,\r\n                        ed_number: ed_number\r\n                    },\r\n                    fields: [\"name\"],\r\n                    limit: 1\r\n                }).then(result => {\r\n\r\n                    if (result && result.length > 0) {\r\n                        // \u2714 Already exists\r\n                        frappe.set_route(\"Form\", \"Submit to Finance\", result[0].name);\r\n                        return;\r\n                    }\r\n\r\n                    // -------------------------------------------------------\r\n                    // NO EXISTING DOCUMENT \u2192 CREATE NEW\r\n                    // -------------------------------------------------------\r\n                    frappe.model.with_doctype(\"Submit to Finance\", function() {\r\n\r\n                        let doc = frappe.model.get_new_doc(\"Submit to Finance\");\r\n\r\n                        // PASS VALUES\r\n                        doc.name1 = policy_holder;\r\n                        doc.year = frm.doc.year;\r\n                        doc.month = frm.doc.month;\r\n                        doc.quotation_numbers = quotation_numbers;\r\n                        doc.vat = frm.doc.vat_percentage;\r\n                        doc.status = frm.doc.status;\r\n\r\n                        doc.ed_number = ed_number;\r\n                        doc.grandtotal = frm.doc.grandtotal;\r\n                        doc.grandtotal1 = frm.doc.grandtotal1;\r\n                        doc.premium_rate1 = frm.doc.premium_rate;\r\n                        doc.premium_rate = frm.doc.premium_rate;\r\n                        doc.currency = frm.doc.curr;\r\n                       // doc.decl_amt = frm.doc.decl_amt;\r\n\r\n                        // \u2714 Open the new document\r\n                        frappe.set_route(\"Form\", \"Submit to Finance\", doc.name);\r\n                    });\r\n\r\n                }).catch(err => {\r\n                    console.error(err);\r\n                    frappe.msgprint(\"Error while checking existing Submit to Finance.\");\r\n                });\r\n\r\n            });\r\n\r\n            // Button styling\r\n            $(btn).css({\r\n                'background-color': '#0d6efd',\r\n                'color': '#fff',\r\n                'border': 'none'\r\n            });\r\n        }\r\n    }\r\n});\r\n\r\n\r\nfunction parseDateDDMMYYYYorYYYYMMDD(dateStr) {\r\n    if (!dateStr) return null;\r\n\r\n    if (dateStr.includes('-')) {\r\n        const parts = dateStr.split('-');\r\n\r\n        if (parts[0].length === 4) {\r\n            return new Date(\r\n                parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])\r\n            );\r\n        } else {\r\n            return new Date(\r\n                parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0])\r\n            );\r\n        }\r\n    }\r\n\r\n    return new Date(dateStr);\r\n}\r\n\r\n\r\n\r\nfunction fetch_domestic_premium(frm) {\r\n    console.log(\"=== Domestic Premium Fetch Started ===\");\r\n\r\n    const quotation_no = frm.doc.quotation_numbers?.trim();\r\n    const policy_no = frm.doc.policy_number?.trim();\r\n    const form_month = frm.doc.month?.trim()?.toUpperCase();\r\n    const form_year = parseInt(frm.doc.year, 10);\r\n\r\n    // --- WAIT UNTIL MONTH + YEAR ARE SELECTED ---\r\n    if (!form_month || !form_year) {\r\n        console.log(\"Month or Year not selected \u2192 Do NOT fetch anything.\");\r\n        return; // STOP HERE (NO RESET TO ZERO)\r\n    }\r\n\r\n    // --- WAIT UNTIL POLICY + QUOTATION SELECTED ---\r\n    if (!quotation_no || !policy_no) {\r\n        console.log(\"Policy or Quotation missing \u2192 Do NOT set 0, just wait.\");\r\n        return;\r\n    }\r\n\r\n    const MONTH_MAP = {\r\n        \"JANUARY\": 1, \"FEBRUARY\": 2, \"MARCH\": 3, \"APRIL\": 4,\r\n        \"MAY\": 5, \"JUNE\": 6, \"JULY\": 7, \"AUGUST\": 8,\r\n        \"SEPTEMBER\": 9, \"OCTOBER\": 10, \"NOVEMBER\": 11, \"DECEMBER\": 12\r\n    };\r\n\r\n    const form_month_num = MONTH_MAP[form_month];\r\n    if (!form_month_num) {\r\n        console.log(\"Invalid Month:\", form_month);\r\n        return;\r\n    }\r\n\r\n    // -----------------------------\r\n    // STEP 1 \u2192 CHECK POLICY REVIEWS\r\n    // -----------------------------\r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: \"Policy Reviews\",\r\n            filters: { policy_no: policy_no },\r\n            fields: [\"name\", \"period_to\", \"premium_rate\"]\r\n        },\r\n        callback: function (res) {\r\n            const reviews = res.message || [];\r\n            console.log(\"Policy Reviews:\", reviews);\r\n\r\n            const matched_review = reviews.find(r => {\r\n                const d = parseDateDDMMYYYYorYYYYMMDD(r.period_to);\r\n                if (!d) return false;\r\n\r\n                return (\r\n                    (d.getMonth() + 1) === form_month_num &&\r\n                    d.getFullYear() === form_year\r\n                );\r\n            });\r\n\r\n            if (matched_review) {\r\n                console.log(\"Matched Policy Review:\", matched_review);\r\n                frm.set_value(\"premium_rate\", matched_review.premium_rate);\r\n                frappe.msgprint(`Premium Rate fetched from Policy Reviews`);\r\n                return;\r\n            }\r\n\r\n            // -----------------------------\r\n            // STEP 2 \u2192 CHECK DCI QUOTATION\r\n            // -----------------------------\r\n            console.log(\"No Policy Review matched \u2192 Checking DCI Quotation\");\r\n\r\n            frappe.call({\r\n                method: \"frappe.client.get_list\",\r\n                args: {\r\n                    doctype: \"DCI Quotation\",\r\n                    filters: { schedule_no: quotation_no },\r\n                    fields: [\"name\", \"premium_rate\"],\r\n                    limit_page_length: 1\r\n                },\r\n                callback: function (qres) {\r\n                    if (!qres.message || qres.message.length === 0) {\r\n                        console.log(\"No DCI Quotation found\");\r\n                        frm.set_value(\"premium_rate\", 0); // NOW set zero\r\n                        return;\r\n                    }\r\n\r\n                    const q = qres.message[0];\r\n                    frm.set_value(\"premium_rate\", q.premium_rate);\r\n                    frappe.msgprint(`Premium Rate fetched from DCI Quotation`);\r\n                }\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Submit to Finance",
  "enabled": 1,
  "modified": "2025-12-08 12:38:26.563234",
  "module": null,
  "name": "invoice button",
  "script": "frappe.ui.form.on('Submit to Finance', {\r\n    \r\n\r\n\r\n// refresh(frm) {\r\n\r\n//     // Always show Save button\r\n//     frm.enable_save();\r\n\r\n//     // 1\ufe0f\u20e3 Do NOT show button for new/unsaved documents\r\n//     if (frm.is_new()) {\r\n//           frm.enable_save();\r\n//         return;\r\n        \r\n//     }\r\n\r\n//     // 2\ufe0f\u20e3 Require invoice_no before comparing\r\n//     if (!frm.doc.invoice_no) {\r\n//         return;\r\n//     }\r\n\r\n//     // Remove old custom buttons every refresh\r\n//     frm.clear_custom_buttons();\r\n\r\n//     // 3\ufe0f\u20e3 Check if CI Invoice already exists\r\n//     frappe.call({\r\n//         method: \"frappe.client.get_value\",\r\n//         args: {\r\n//             doctype: \"CI Invoices\",\r\n//             fieldname: \"name\",\r\n//             filters: { invoice_no: frm.doc.invoice_no }\r\n//         },\r\n//         callback: function (r) {\r\n\r\n//             // 4\ufe0f\u20e3 If CI Invoice exists \u2192 DO NOT show button\r\n//             if (r.message && r.message.name) {\r\n//                 console.log(\"Invoice already exists:\", r.message.name);\r\n//                 return;\r\n//             }\r\n\r\n//             // 5\ufe0f\u20e3 CI Invoice does NOT exist \u2192 SHOW button\r\n//             frm.add_custom_button(\"Submit to Finance\", () => {\r\n//                 create_new_ci_invoice(frm);\r\n//             }).addClass(\"btn-primary\");\r\n\r\n//             console.log(\"Submit to Finance button shown\");\r\n//         }\r\n//     });\r\n// },\r\n\r\n refresh(frm) {\r\n\r\n frm.fields_dict.go_back.$input.addClass('btn-primary');\r\n        // Remove old copies (prevents duplicates)\r\n        frm.clear_custom_buttons();\r\n\r\n        // Always add button first\r\n        frm.add_custom_button(\"Submit to Finance\", () => {\r\n            frm.trigger(\"submit_to_finance\");\r\n        }).addClass(\"btn-primary\");\r\n\r\n        // NEW DOCUMENT \u2192 leave button visible\r\n        if (frm.is_new()) {\r\n            return;\r\n        }\r\n\r\n        // EXISTING DOCUMENT \u2192 check CI Invoice existence\r\n        frappe.call({\r\n            method: \"frappe.client.get_value\",\r\n            args: {\r\n                doctype: \"CI Invoices\",\r\n                fieldname: \"name\",\r\n                filters: {\r\n                    invoice_no: frm.doc.invoice_no\r\n                }\r\n            },\r\n            callback: function (r) {\r\n\r\n                // If exists \u2192 hide custom button\r\n                if (r.message && r.message.name) {\r\n                    frm.clear_custom_buttons();\r\n                }\r\n\r\n                // If not exists \u2192 keep button (already added)\r\n            }\r\n        });\r\n    },\r\n\r\n\r\n  go_back : function(frm) {\r\n        const ed_number = frm.doc.ed_number;\r\n        const quotation_numbers = frm.doc.quotation_numbers;\r\n\r\n        if (!ed_number || !quotation_numbers) {\r\n            frappe.msgprint('DD ref no or Quotation Number missing.');\r\n            return;\r\n        }\r\n\r\n        frappe.db.get_list('Domestic Declarations', {\r\n            filters: { ed_number, quotation_numbers },\r\n            fields: ['name'],\r\n            limit_page_length: 1\r\n        }).then(result => {\r\n            if (result.length > 0) {\r\n                frappe.set_route('Form', 'Domestic Declarations', result[0].name);\r\n            } else {\r\n                frappe.msgprint('No Domestic Declaration found for this');\r\n            }\r\n        }).catch(err => {\r\n            console.error('Error fetching Domestic Declaration:', err);\r\n            frappe.msgprint('Error fetching. See console.');\r\n        });\r\n    }\r\n});\r\n\r\n\r\n\r\n// \ud83d\ude80 Create a new CI Invoice\r\nfunction create_new_ci_invoice(frm) {\r\n    const ci_invoice = frappe.model.get_new_doc('CI Invoices');\r\n\r\n    // Set main fields\r\n    frappe.model.set_value(ci_invoice.doctype, ci_invoice.name, 'policy_holder', frm.doc.name1);\r\n    frappe.model.set_value(ci_invoice.doctype, ci_invoice.name, 'month', frm.doc.month);\r\n    frappe.model.set_value(ci_invoice.doctype, ci_invoice.name, 'year', frm.doc.year);\r\n    frappe.model.set_value(ci_invoice.doctype, ci_invoice.name, 'vat', frm.doc.vat);\r\n    frappe.model.set_value(ci_invoice.doctype, ci_invoice.name, 'invoice_date', frm.doc.invoice_date);\r\n    frappe.model.set_value(ci_invoice.doctype, ci_invoice.name, 'invoice_no', frm.doc.invoice_no);\r\n    frappe.model.set_value(ci_invoice.doctype, ci_invoice.name, 'invoice_amount', frm.doc.invoice_amount);\r\n    frappe.model.set_value(ci_invoice.doctype, ci_invoice.name, 'invoice_amount_without_vat', frm.doc.total);\r\n     frappe.model.set_value(ci_invoice.doctype, ci_invoice.name, 'quotation_number', frm.doc.quotation_numbers);\r\n     frappe.model.set_value(ci_invoice.doctype, ci_invoice.name, 'ed_number', frm.doc.ed_number);\r\n     frappe.model.set_value(ci_invoice.doctype, ci_invoice.name, 'currency', frm.doc.currency);\r\n\r\n    // Map child table items\r\n    ci_invoice.export_invoice = (frm.doc.child_table || []).map(r => ({\r\n        description: r.description,\r\n        qty: r.quantity,\r\n        price: r.price,\r\n        amount: (r.quantity || 0) * (r.price || 0),\r\n    }));\r\n\r\n    // Insert and open the new CI Invoice\r\n    frappe.db.insert(ci_invoice).then(res => {\r\n        frappe.set_route(\"Form\", \"CI Invoices\", res.name);\r\n    });\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Credit Note Tax Invoice Domestic",
  "enabled": 1,
  "modified": "2025-12-01 07:12:37.231887",
  "module": "Finance",
  "name": "Credit Note Tax invoice",
  "script": "frappe.ui.form.on('Credit Note Tax Invoice Domestic', {\n  refresh(frm) {\n\n        // Align fields\n        frm.fields_dict.g.$input.css(\"text-align\", \"right\");\n        frm.fields_dict.currency9.$input.css(\"text-align\", \"right\");\n        frm.fields_dict.sub_total.$input.css(\"text-align\", \"right\");\n\n        frm.set_df_property('tax_child', 'cannot_add_rows', true);\n\n        // -------- Fetch Domestic Child Table --------\n        frappe.call({\n            method: \"frappe.client.get\",\n            args: {\n                doctype: \"CI Invoices\",\n                filters: {\n                    policy_holder: frm.doc.invoice1,\n                    invoice_no: frm.doc.invoice2\n                }\n            },\n            callback: function(r) {\n\n                if (!r.exc && r.message && r.message.export_invoice && r.message.export_invoice.length > 0) {\n                    const data = r.message.export_invoice;\n\n                    frm.clear_table('tax_child');\n\n                    let total_amount = 0;\n\n                    data.forEach(x => {\n                        let child = frappe.model.add_child(frm.doc,\n                            \"TaxinvoiceChildTable\",\n                            \"tax_child\");\n\n                        child.description = x.description;\n                        child.qty = x.qty;\n                        child.price = x.price;\n                        child.amount = x.amount;\n\n                        total_amount += parseFloat(x.amount) || 0;\n                    });\n\n                    frm.set_value('g', total_amount.toFixed(2));\n                    frm.refresh_field('tax_child');\n\n                    calculate_total_premium(frm);\n                    calculateADD(frm);\n                }\n            }\n        });\n\n        // -------- Fetch VAT --------\n        frappe.call({\n            method: \"frappe.client.get_value\",\n            args: {\n                doctype: \"CI Invoices\",\n                filters: { invoice_no: frm.doc.invoice2 },\n                fieldname: \"vat\"\n            },\n            callback: function(r) {\n                frm.set_value(\"vat_percentage\", (r.message && r.message.vat) || 0);\n                calculate_total_premium(frm);\n                calculateADD(frm);\n            }\n        });\n\n    },\n\n    g(frm) {\n        calculate_total_premium(frm);\n        calculateADD(frm);\n    },\n\n    sub_total(frm) {\n        calculateADD(frm);\n    }\n});\n\n// ---------- FUNCTIONS ----------\nfunction calculate_total_premium(frm) {\n    let g = parseFloat(frm.doc.g) || 0;\n    let vat = parseFloat(frm.doc.vat_percentage) || 0;\n    let subtotal = (g * vat) / 100;\n\n    frm.set_value(\"sub_total\", subtotal.toFixed(2));\n}\n\nfunction calculateADD(frm) {\n    let g = parseFloat(frm.doc.g) || 0;\n    let sub_total = parseFloat(frm.doc.sub_total) || 0;\n    frm.set_value(\"currency9\", (g + sub_total).toFixed(2));\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Credit Note Tax Invoice Export",
  "enabled": 1,
  "modified": "2025-12-01 07:22:11.752217",
  "module": "Finance",
  "name": "Tax Invoice",
  "script": "frappe.ui.form.on('Credit Note Tax Invoice Export', {\n   refresh(frm) {\n\n        frm.set_df_property('tax_child', 'cannot_add_rows', true);\n        frm.set_df_property('taxinvoicechildforciinvoice', 'cannot_add_rows', true);\n // Align fields\n        frm.fields_dict.g.$input.css(\"text-align\", \"right\");\n        frm.fields_dict.currency9.$input.css(\"text-align\", \"right\");\n        frm.fields_dict.sub_total.$input.css(\"text-align\", \"right\");\n        // Fetch child table 1\n        frappe.call({\n            method: \"frappe.client.get\",\n            args: {\n                doctype: \"CI Invoices\",\n                filters: {\n                    policy_holder: frm.doc.invoice1,\n                    invoice_no: frm.doc.invoice2\n                }\n            },\n            callback: function(r) {\n\n                if (!r.exc && r.message.export_buyer && r.message.export_buyer.length > 0) {\n                    const data = r.message.export_buyer;\n\n                    frm.clear_table('taxinvoicechildforciinvoice');\n\n                    data.forEach(x => {\n                        let child = frappe.model.add_child(frm.doc,\n                            \"TaxInvoicechildforCIInvoice\",\n                            \"taxinvoicechildforciinvoice\");\n\n                        child.country = x.country;\n                        child.declaration_amount = x.declamt;\n                        child.rate = x.premium_rate;\n                        child.premium = x.premamount;\n                    });\n\n                    frm.refresh_field('taxinvoicechildforciinvoice');\n                }\n            }\n        });\n\n        // Fetch second child table\n        frappe.call({\n            method: \"frappe.client.get\",\n            args: {\n                doctype: \"CI Invoices\",\n                filters: {\n                    policy_holder: frm.doc.invoice1,\n                    invoice_no: frm.doc.invoice2\n                }\n            },\n            callback: function(r) {\n\n                if (!r.exc && r.message.export_invoice && r.message.export_invoice.length > 0) {\n\n                    const data = r.message.export_invoice;\n\n                    frm.clear_table('tax_child');\n\n                    let total_amount = 0;\n\n                    data.forEach(x => {\n                        let child = frappe.model.add_child(frm.doc,\n                            \"TaxinvoiceChildTable\",\n                            \"tax_child\");\n\n                        child.description = x.description;\n                        child.qty = x.qty;\n                        child.price = x.price;\n                        child.amount = x.amount;\n\n                        total_amount += parseFloat(x.amount) || 0;\n                    });\n\n                    frm.set_value('g', total_amount.toFixed(2));\n                    frm.refresh_field('tax_child');\n\n                    calculate_total_premium(frm);\n                    calculateADD(frm);\n                }\n            }\n        });\n\n        // Fetch VAT\n        frappe.call({\n            method: \"frappe.client.get_value\",\n            args: {\n                doctype: \"CI Invoices\",\n                filters: { invoice_no: frm.doc.invoice2 },\n                fieldname: \"vat\"\n            },\n            callback: function(r) {\n                frm.set_value(\"vat_percentage\", (r.message && r.message.vat) || 0);\n\n                calculate_total_premium(frm);\n                calculateADD(frm);\n            }\n        });\n\n    }\n});\n\n// ---------- FUNCTIONS ----------\nfunction calculate_total_premium(frm) {\n    let g = parseFloat(frm.doc.g) || 0;\n    let vat = parseFloat(frm.doc.vat_percentage) || 0;\n    frm.set_value(\"sub_total\", ((g * vat) / 100).toFixed(2));\n}\n\nfunction calculateADD(frm) {\n    frm.set_value(\"currency9\",\n        ((parseFloat(frm.doc.g) || 0) +\n         (parseFloat(frm.doc.sub_total) || 0)).toFixed(2)\n    );\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Credit Note Internal Invoice Export",
  "enabled": 1,
  "modified": "2025-12-01 07:58:05.213993",
  "module": "Finance",
  "name": "Internal Invoice",
  "script": "frappe.ui.form.on('Credit Note Internal Invoice Export', {\nrefresh(frm) {\n\n        frm.set_df_property('invioce_childtable', 'cannot_add_rows', true);\n\n        frm.set_value(\"reinsurercommercialamt\", 100);\n\n        // Clear child tables first\n        frm.clear_table(\"invioce_childtable\");\n\n        if (!frm.doc.quotation_number) {\n            return;\n        }\n\n        // Fetch quotation main\n        frappe.call({\n            method: \"frappe.client.get_list\",\n            args: {\n                doctype: \"ECI Quotations\",\n                filters: {\n                    client_name: frm.doc.name1,\n                    schedule_no: frm.doc.quotation_number\n                },\n                fields: [\"name\"]\n            },\n            callback: function(res) {\n                if (!res.message || res.message.length === 0) return;\n\n                let quotation_name = res.message[0].name;\n\n                frappe.call({\n                    method: \"frappe.client.get\",\n                    args: { doctype: \"ECI Quotations\", name: quotation_name },\n                    callback: function(r) {\n                        if (!r.message || !r.message.eci_quo_table) return;\n\n                        // Load first child table\n                        r.message.eci_quo_table.forEach(x => {\n                            let child = frm.add_child(\"invioce_childtable\");\n                            child.buyer = x.buyer_type;\n                            child.country = x.country;\n                            child.declamt = x.turnover;\n                            child.commercial_perms = x.commpreamt;\n                            child.political_perms = x.polpreamt;\n                            child.commercial_perm1 = x.commprerate;\n                            child.political_perms1 = x.polprerate;\n                            child.total_perms = x.total_pre_amt;\n                        });\n\n                        frm.refresh_field(\"invioce_childtable\");\n                        calculate_totals(frm);\n                    }\n                });\n\n                // Fetch totals\n                frappe.call({\n                    method: \"frappe.client.get_value\",\n                    args: {\n                        doctype: \"ECI Quotations\",\n                        filters: { schedule_no: frm.doc.quotation_number },\n                        fieldname: [\"com_pre_amt\",\"pol_pre_amt\",\"amt\",\"commercial\",\"political\",\"total\"]\n                    },\n                    callback: function(r) {\n                        if (!r.message) return;\n                        frm.set_value('commercial_perms_total', r.message.com_pre_amt);\n                        frm.set_value('political_perms_total', r.message.pol_pre_amt);\n                        frm.set_value('total_perms', r.message.amt);\n                    }\n                });\n\n            }\n        });\n\n    }\n\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Credit Note Internal Invoice Domestic",
  "enabled": 1,
  "modified": "2025-12-02 09:42:16.585474",
  "module": "Finance",
  "name": "Internal Invoice Domestic",
  "script": "frappe.ui.form.on('Credit Note Internal Invoice Domestic', {\n refresh(frm) {\n \n        frm.set_df_property('domesticdetails', 'cannot_add_rows', true);\n         frm.fields_dict.domestic_premium.$input.css(\"text-align\", \"right\");\n          frm.fields_dict.premium_rate.$input.css(\"text-align\", \"right\");\n           frm.fields_dict.total_amount.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.total.$input.css(\"text-align\", \"right\");\n            frm.fields_dict.commercial_perms_total.$input.css(\"text-align\", \"right\");\n              frm.fields_dict.political_perms_total.$input.css(\"text-align\", \"right\");\n                frm.fields_dict.total_perms.$input.css(\"text-align\", \"right\");\n                  frm.fields_dict.c29.$input.css(\"text-align\", \"right\");\n\n        frm.clear_table(\"domesticdetails\");\n        \n                    fetchDomesticDeclaration(frm, frm.doc.ed_no);\n\n\n        // if (!frm.doc.quotation_number) return;\n\n        // // Fetch Domestic quotation\n        // frappe.call({\n        //     method: \"frappe.client.get_list\",\n        //     args: {\n        //         doctype: \"DCI Quotation\",\n        //         filters: {\n        //             client_name: frm.doc.name1,\n        //             schedule_no: frm.doc.quotation_number\n        //         },\n        //         fields: [\"name\"]\n        //     },\n        //     callback: function(res) {\n        //         if (!res.message || res.message.length === 0) return;\n\n        //         let quotation_name = res.message[0].name;\n\n        //         frappe.call({\n        //             method: \"frappe.client.get\",\n        //             args: { doctype: \"DCI Quotation\", name: quotation_name },\n        //             callback: function(r) {\n        //                 if (!r.message || !r.message.dci_quo_table) return;\n\n        //                 r.message.dci_quo_table.forEach(x => {\n        //                     let child = frm.add_child(\"domesticdetails\");\n        //                     child.buyer = x.buyer_type;\n        //                     child.country = x.country;\n        //                     child.declamt = x.turnover;\n        //                     child.commercial_perms = x.commpreamt;\n        //                     child.political_perms = x.polpreamt;\n        //                     child.commercial_perm1 = x.commprerate;\n        //                     child.political_perms1 = x.polprerate;\n        //                     child.total_perms = x.total_pre_amt;\n        //                 });\n\n        //                 frm.refresh_field(\"domesticdetails\");\n        //                 calculate_totals(frm);\n        //             }\n        //         });\n\n        //     }\n        // });\n//     frappe.call({\n//     method: \"frappe.client.get_list\",\n//     args: {\n//         doctype: \"Domestic Declarations\",\n//         filters: {\n//             policy_holder: frm.doc.name1,\n//             ed_number: frm.doc.ed_no,\n//         },\n//         fields: [\"grandtotal\", \"grandtotal1\", \"premium_rate\"],\n//         limit_page_length: 1\n//     },\n//     callback: function(res) {\n\n//         console.log(\"Domestic Declarations Response:\", res);\n\n//         if (res.message && res.message.length > 0) {\n//             let f = res.message[0];\n//               console.log(\"grandtotal:\", f.grandtotal);\n//     console.log(\"grandtotal1:\", f.grandtotal1);\n//     console.log(\"premium_rate:\", f.premium_rate);\n\n//             // Check which column has value\n//             let final_amount = 0;\n\n//             if (f.grandtotal && Number(f.grandtotal) !== 0) {\n//                 final_amount = Number(f.grandtotal);\n//             }\n//             else if (f.grandtotal1 && Number(f.grandtotal1) !== 0) {\n//                 final_amount = Number(f.grandtotal1);\n//             }\n\n//             frm.set_value(\"domestic_premium\", final_amount.toFixed(2));\n\n//             // premium_rate for both\n//             frm.set_value(\"premium_rate\", Number(f.premium_rate || 0).toFixed(2));\n//             //frm.set_value(\"premium_rate2\", Number(f.premium_rate || 0).toFixed(2));\n//         }\n//         else {\n//             frm.set_value(\"domestic_premium\", \"0.00\");\n//             frm.set_value(\"premium_rate\", \"0.00\");\n//           // frm.set_value(\"premium_rate2\", \"0.00\");\n//         }\n//     }\n// });\n\n//priyanka commented\n// frappe.call({\n//     method: \"frappe.client.get_list\",\n//     args: {\n//         doctype: \"Domestic Declarations\",\n//         filters: {\n//             policy_holder: frm.doc.name1,\n//             ed_number: frm.doc.ed_no,\n//         },\n//         fields: [\"grandtotal\", \"grandtotal1\", \"premium_rate\"],\n//         limit_page_length: 1\n//     },\n//     callback: function(res) {\n\n//         console.log(\"========= DEBUG START =========\");\n//         console.log(\"\ud83d\udd0e POLICY HOLDER sent:\", frm.doc.name1);\n//         console.log(\"\ud83d\udd0e ED NUMBER sent:\", frm.doc.ed_no);\n//         console.log(\"\ud83d\udd0d Domestic Declarations Response:\", res);\n\n//         if (res.message && res.message.length > 0) {\n\n//             let f = res.message[0];\n\n//             // Field Debugs\n//             console.log(\"\u2714 grandtotal:\", f.grandtotal);\n//             console.log(\"\u2714 grandtotal1:\", f.grandtotal1);\n//             console.log(\"\u2714 premium_rate:\", f.premium_rate);\n\n//             let g1 = Number(f.grandtotal);\n//             let g2 = Number(f.grandtotal1);\n\n//             // Pick non-zero value\n//             let final_amount = g1 > 0 ? g1 : (g2 > 0 ? g2 : 0);\n\n//             console.log(\"\ud83d\udc49 FINAL AMOUNT PICKED:\", final_amount);\n\n//             frm.set_value(\"domestic_premium\", final_amount.toFixed(2));\n//             frm.set_value(\"premium_rate\", Number(f.premium_rate || 0).toFixed(2));\n//         }\n//         else {\n//             console.log(\"\u274c No matching Domestic Declaration found for:\");\n//             console.log(\"   \u2192 policy_holder:\", frm.doc.name1);\n//             console.log(\"   \u2192 ed_number:\", frm.doc.ed_no);\n\n//             frm.set_value(\"domestic_premium\", \"0.00\");\n//             frm.set_value(\"premium_rate\", \"0.00\");\n//         }\n\n//         console.log(\"========= DEBUG END =========\");\n//     }\n// });\n\n\n\nfrappe.call({\n    method: \"frappe.client.get_list\",\n    args: {\n        doctype: \"CI Invoices\",\n        filters: {\n            policy_holder: frm.doc.name1,\n            invoice_no: frm.doc.invoice_no,\n        },\n        fields: [\"ed_number\"],\n        limit_page_length: 1\n    },\n    callback: function(res) {\n\n        if (res.message && res.message.length > 0) {\n            let ed_no_value = res.message[0].ed_number || \"\";\n\n            // Set value in target field ed_no\n            frm.set_value(\"ed_no\", ed_no_value);\n\n        } else {\n            frappe.msgprint(\"ED Number not found for this invoice.\");\n        }\n    }\n});\n\n\n    },\n    \n    \ned_no: function(frm) {\n        if (frm.doc.ed_no) {\n            fetchDomesticDeclaration(frm, frm.doc.ed_no);\n        }\n    },\n\n\n\n\n\n\n    \n domestic_premium: function(frm) {\n calculateTotal_A(frm);\n},\n\n premium_rate: function(frm) {\n    calculateTotal_A(frm);\n},\n\n    \n\n});\n\nfunction fetchDomesticDeclaration(frm, ed_no) {\n    if (!ed_no) {\n        console.log(\"\u274c Required field missing: ed_no\");\n        return;\n    }\n\n    frappe.call({\n        method: \"frappe.client.get_list\",\n        args: {\n            doctype: \"Domestic Declarations\",\n            filters: {\n                ed_number: ed_no,\n            },\n            fields: [\"grandtotal\", \"grandtotal1\", \"premium_rate\"],\n            limit_page_length: 1\n        },\n        callback: function(res) {\n            console.log(\"========= DEBUG START =========\");\n            console.log(\"\ud83d\udd0e ED NUMBER sent:\", ed_no);\n            console.log(\"\ud83d\udd0d Domestic Declarations Response:\", res);\n\n            if (res.message && res.message.length > 0) {\n                let f = res.message[0];\n\n                console.log(\"\u2714 grandtotal:\", f.grandtotal);\n                console.log(\"\u2714 grandtotal1:\", f.grandtotal1);\n                console.log(\"\u2714 premium_rate:\", f.premium_rate);\n\n                let g1 = parseFloat(f.grandtotal) || 0;\n                let g2 = parseFloat(f.grandtotal1) || 0;\n\n                let final_amount = g1 > 0 ? g1 : (g2 > 0 ? g2 : 0);\n\n                console.log(\"\ud83d\udc49 FINAL AMOUNT PICKED:\", final_amount);\n\n                frm.set_value(\"domestic_premium\", final_amount.toFixed(2));\n                frm.set_value(\"premium_rate\", (parseFloat(f.premium_rate) || 0).toFixed(2));\n            } else {\n                console.log(\"\u274c No matching Domestic Declaration found for ED NUMBER:\", ed_no);\n\n                frm.set_value(\"domestic_premium\", \"0.00\");\n                frm.set_value(\"premium_rate\", \"0.00\");\n            }\n\n            console.log(\"========= DEBUG END =========\");\n        }\n    });\n}\n\n\n\nfunction calculateTotal_A(frm) {\n\n    let a = (frm.doc.domestic_premium || 0) * (frm.doc.premium_rate || 0) / 100;\n\n    // round to 2 decimal places\n    let finalValue = Number(a).toFixed(2);\n\n    frm.set_value('total_amount', finalValue);\n    frm.set_value('total', finalValue);\n     frm.set_value('commercial_perms_total', finalValue);\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Tax Invoice For CI Invoice",
  "enabled": 1,
  "modified": "2025-12-01 08:09:12.859859",
  "module": null,
  "name": "Latest script tax invoive",
  "script": "frappe.ui.form.on('Tax Invoice For CI Invoice', {\r\n\r\n    onload: function(frm) {\r\n        // Align numeric fields\r\n        ['declaration_amount', 'rate', 'premium', 'g', 'sub_total', 'currency9'].forEach(f => {\r\n            if (frm.fields_dict[f]) {\r\n                frm.fields_dict[f].$input?.css(\"text-align\", \"right\") || frm.fields_dict[f].$wrapper?.find('input').css(\"text-align\", \"right\");\r\n            }\r\n        });\r\n\r\n        // Prevent adding rows manually\r\n        frm.set_df_property('tax_child', 'cannot_add_rows', true);\r\n        frm.set_df_property('taxinvoicechildforciinvoice', 'cannot_add_rows', true);\r\n    },\r\n\r\n    refresh: function(frm) {\r\n        // If no quotation number, hide first child table\r\n        if (!frm.doc.quotation_number) {\r\n            frm.set_df_property(\"taxinvoicechildforciinvoice\", \"hidden\", 1);\r\n            frm.clear_table(\"taxinvoicechildforciinvoice\");\r\n            frm.refresh_field(\"taxinvoicechildforciinvoice\");\r\n\r\n            frm.set_df_property(\"tax_child\", \"hidden\", 0);\r\n            frm.refresh_field(\"tax_child\");\r\n        }\r\n\r\n        // Otherwise, fetch child tables\r\n        else {\r\n            frm.set_df_property(\"tax_child\", \"hidden\", 0);\r\n            frm.set_df_property(\"taxinvoicechildforciinvoice\", \"hidden\", 0);\r\n            frm.refresh_field(\"tax_child\");\r\n            frm.refresh_field(\"taxinvoicechildforciinvoice\");\r\n\r\n            fetch_child_tables(frm);\r\n        }\r\n    },\r\n\r\n    taxinvoicechildforciinvoice_add: function(frm) {\r\n        calculate_total_premium(frm);\r\n    },\r\n\r\n    taxinvoicechildforciinvoice_remove: function(frm) {\r\n        calculate_total_premium(frm);\r\n    },\r\n\r\n    g: function(frm) {\r\n        calculate_total_premium(frm);\r\n        calculateADD(frm);\r\n    },\r\n\r\n    sub_total: function(frm) {\r\n        calculateADD(frm);\r\n    }\r\n});\r\n\r\n// ------------------- FUNCTIONS ---------------------\r\n\r\nfunction fetch_child_tables(frm) {\r\n\r\n    // ----------- FETCH CHILD TABLE 1 -----------\r\n    frappe.call({\r\n        method: \"frappe.client.get\",\r\n        args: {\r\n            doctype: \"CI Invoices\",\r\n            filters: {\r\n                policy_holder: frm.doc.invoice1,\r\n                invoice_no: frm.doc.invoice2\r\n            }\r\n        },\r\n        callback: function(r) {\r\n            frm.clear_table('taxinvoicechildforciinvoice');\r\n\r\n            if (!r.exc && r.message && r.message.export_buyer?.length) {\r\n                r.message.export_buyer.forEach(x => {\r\n                    var child = frappe.model.add_child(frm.doc,\r\n                        \"TaxInvoicechildforCIInvoice\",\r\n                        \"taxinvoicechildforciinvoice\");\r\n\r\n                    child.country = x.country;\r\n                    child.declaration_amount = x.declamt;\r\n                    child.rate = x.premium_rate;\r\n                    child.premium = x.premamount;\r\n                });\r\n            }\r\n\r\n            // Hide table if empty\r\n            frm.set_df_property(\"taxinvoicechildforciinvoice\", \"hidden\", !frm.doc.taxinvoicechildforciinvoice.length);\r\n            frm.refresh_field(\"taxinvoicechildforciinvoice\");\r\n        }\r\n    });\r\n\r\n    // ----------- FETCH CHILD TABLE 2 -----------\r\n    frappe.call({\r\n        method: \"frappe.client.get\",\r\n        args: {\r\n            doctype: \"CI Invoices\",\r\n            filters: {\r\n                policy_holder: frm.doc.invoice1,\r\n                invoice_no: frm.doc.invoice2\r\n            }\r\n        },\r\n        callback: function(r) {\r\n            frm.clear_table('tax_child');\r\n\r\n            if (!r.exc && r.message && r.message.export_invoice?.length) {\r\n                let total_amount = 0;\r\n\r\n                r.message.export_invoice.forEach(x => {\r\n                    var child = frappe.model.add_child(frm.doc,\r\n                        \"TaxinvoiceChildTable\",\r\n                        \"tax_child\");\r\n\r\n                    child.description = x.description;\r\n                    child.qty = x.qty;\r\n                    child.price = x.price;\r\n                    child.amount = x.amount;\r\n\r\n                    total_amount += parseFloat(x.amount) || 0;\r\n                });\r\n\r\n                frm.set_value('g', total_amount.toFixed(2));\r\n            }\r\n\r\n            // Hide table if empty\r\n            frm.set_df_property(\"tax_child\", \"hidden\", !frm.doc.tax_child.length);\r\n            frm.refresh_field(\"tax_child\");\r\n\r\n            calculate_total_premium(frm);\r\n            calculateADD(frm);\r\n        }\r\n    });\r\n\r\n    // ----------- FETCH VAT % -----------\r\n    frappe.call({\r\n        method: \"frappe.client.get_value\",\r\n        args: {\r\n            doctype: \"CI Invoices\",\r\n            filters: { invoice_no: frm.doc.invoice2 },\r\n            fieldname: \"vat\"\r\n        },\r\n        callback: function(r) {\r\n            frm.set_value(\"vat_percentage\", r.message?.vat || 0);\r\n            calculate_total_premium(frm);\r\n            calculateADD(frm);\r\n        }\r\n    });\r\n}\r\n\r\nfunction calculate_total_premium(frm) {\r\n    let g = parseFloat(frm.doc.g) || 0;\r\n    let vat = parseFloat(frm.doc.vat_percentage) || 0;\r\n    let subtotal = (g * vat) / 100;\r\n\r\n    frm.set_value(\"sub_total\", subtotal.toFixed(2));\r\n    frm.refresh_field(\"sub_total\");\r\n}\r\n\r\nfunction calculateADD(frm) {\r\n    let g = parseFloat(frm.doc.g) || 0;\r\n    let sub_total = parseFloat(frm.doc.sub_total) || 0;\r\n\r\n    let currency9 = g + sub_total;\r\n    frm.set_value(\"currency9\", currency9.toFixed(2));\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Export Declaration Invoice",
  "enabled": 1,
  "modified": "2025-12-08 13:41:58.018174",
  "module": null,
  "name": "Export invoice submit button",
  "script": "frappe.ui.form.on(\"Export Declaration Invoice\", {\n    refresh(frm) {\n        generateENumber(frm);\n        calculatePremiumCharges(frm);\n        frm.fields_dict.cancel.$input.addClass('btn-primary');\n        \n         frm.set_df_property('export_buyer', 'cannot_add_rows', true);\n          frm.set_df_property('export_invoice', 'cannot_add_rows', true);\n\n\n\n\n    },\n\n\n\n\n\n    // When premium_charges updates\n    premium_charges(frm) {\n        buildExportInvoiceTable(frm);\n        calculateTotals(frm);\n    },\n\n    // VAT only affects invoice amount\n    vat(frm) {\n        calculateTotals(frm);\n    },\n    \n\n    \n\n  \n});\n\n// ---------------------------------------------\n// CHILD TABLE: export_buyer\n// ---------------------------------------------\nfrappe.ui.form.on(\"export_buyer\", {\n    turn_over_amt(frm, cdt, cdn) {\n        calculatePremiumCharges(frm);\n    },\n\n    premium_rate(frm, cdt, cdn) {\n        calculatePremiumCharges(frm);\n    }\n});\n\n// ----------------------------------------------------\n// PREMIUM CHARGES CALCULATION\n// ----------------------------------------------------\nfunction calculatePremiumCharges(frm) {\n    let total_premium = 0;\n\n    (frm.doc.export_buyer || []).forEach(row => {\n        let turnover = parseFloat(row.turn_over_amt) || 0;\n        let rate = (parseFloat(row.premium_rate) || 0) / 100;\n\n        let amt = turnover * rate;\n\n        frappe.model.set_value(row.doctype, row.name, \"amount1\", amt);\n        total_premium += amt;\n    });\n\n    // Update parent premium_charges\n    frm.set_value(\"premium_charges\", total_premium);\n    \n      frm.set_value(\"decl_amt\", total_premium);\n\n    // Rebuild export_invoice table after premium update\n    buildExportInvoiceTable(frm);\n\n    // Recalculate totals including VAT\n    calculateTotals(frm);\n\n    // Refresh child table\n    frm.refresh_field(\"export_buyer\");\n}\n\n// ----------------------------------------------------\n// AUTO-BUILD EXPORT INVOICE TABLE\n// ----------------------------------------------------\nfunction buildExportInvoiceTable(frm) {\n    frm.clear_table(\"export_invoice\");\n\n    let premium = parseFloat(frm.doc.premium_charges);\n\n    if (premium > 0) {\n        let row = frm.add_child(\"export_invoice\");\n        row.description = \"Premium Charges\";\n        row.qty = 1;\n        row.premium_charges = premium;\n        row.amount = premium;\n    }\n\n    frm.refresh_field(\"export_invoice\");\n}\n\n// ----------------------------------------------------\n// TOTAL + VAT CALCULATION\n// ----------------------------------------------------\nfunction calculateTotals(frm) {\n    let premium = parseFloat(frm.doc.premium_charges) || 0;\n    let vat = parseFloat(frm.doc.vat) || 0;\n\n    frm.set_value(\"total\", premium);\n\n    let invoice_amount = premium + (premium * vat / 100);\n    \n    let invoice_wo_amount = (premium * vat / 100);\n    \n    frm.set_value(\"invoice_amount\", invoice_amount);\n    frm.set_value(\"stamp_duty_value\", invoice_wo_amount);\n   // frm.set_value(\"invoice_amount_without_vat\", premium);\n}\n\n// ----------------------------------------------------\n// AUTO GENERATE INVOICE NUMBER\n// ----------------------------------------------------\nfunction generateENumber(frm) {\n    if (frm.doc.invoice_no) return;\n\n    let year = new Date().getFullYear();\n    let prefix = `INV/${year}/E`;\n\n    frappe.db.get_list(\"Export Declaration Invoice\", {\n        fields: [\"invoice_no\"],\n        filters: { invoice_no: [\"like\", `${prefix}%`] },\n        order_by: \"creation desc\",\n        limit: 1\n    }).then(r => {\n        let last_no = r.length ? r[0].invoice_no : \"\";\n        let last_num = parseInt(last_no.split(\"E\").pop()) || 0;\n        let next = String(last_num + 1).padStart(4, '0');\n\n        frm.set_value(\"invoice_no\", `${prefix}${next}`);\n    });\n}\n\n\n \n \n \n \n \n \n \n \n \n \n \n \n \n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Export Declaration Invoice",
  "enabled": 1,
  "modified": "2025-12-08 13:37:00.863560",
  "module": null,
  "name": "Export buttons",
  "script": "frappe.ui.form.on('Export Declaration Invoice', {\n    \n refresh(frm) {\n     \n           frm.fields_dict.add.$input.addClass('btn-primary');\n               \n\n        // Remove old copies (prevents duplicates)\n        frm.clear_custom_buttons();\n\n        // Always add button first\n        frm.add_custom_button(\"Submit to Finance\", () => {\n            frm.trigger(\"submit_to_finance\");\n        }).addClass(\"btn-primary\");\n\n        // NEW DOCUMENT \u2192 leave button visible\n        if (frm.is_new()) {\n            return;\n        }\n\n        // EXISTING DOCUMENT \u2192 check CI Invoice existence\n        frappe.call({\n            method: \"frappe.client.get_value\",\n            args: {\n                doctype: \"CI Invoices\",\n                fieldname: \"name\",\n                filters: {\n                    invoice_no: frm.doc.invoice_no\n                }\n            },\n            callback: function (r) {\n\n                // If exists \u2192 hide custom button\n                if (r.message && r.message.name) {\n                    frm.clear_custom_buttons();\n                }\n\n                // If not exists \u2192 keep button (already added)\n            }\n        });\n    },\n\n\n// refresh(frm) {\n\n//     // Always show Save button\n//     frm.enable_save();\n\n//     // 1\ufe0f\u20e3 Do NOT show button for new/unsaved documents\n//     if (frm.is_new()) {\n//           frm.enable_save();\n//         return;\n//     }\n\n//     // 2\ufe0f\u20e3 Require invoice_no before comparing\n//     if (!frm.doc.invoice_no) {\n//         return;\n//     }\n\n//     // Remove old custom buttons every refresh\n//     frm.clear_custom_buttons();\n\n//     // 3\ufe0f\u20e3 Check if CI Invoice already exists\n//     frappe.call({\n//         method: \"frappe.client.get_value\",\n//         args: {\n//             doctype: \"CI Invoices\",\n//             fieldname: \"name\",\n//             filters: { invoice_no: frm.doc.invoice_no }\n//         },\n//         callback: function (r) {\n\n//             // 4\ufe0f\u20e3 If CI Invoice exists \u2192 DO NOT show button\n//             if (r.message && r.message.name) {\n//                 console.log(\"Invoice already exists:\", r.message.name);\n//                 return;\n//             }\n\n//             // 5\ufe0f\u20e3 CI Invoice does NOT exist \u2192 SHOW button\n//             frm.add_custom_button(\"Submit to Finance\", () => {\n//                 create_new_ci_invoice(frm);\n//             }).addClass(\"btn-primary\");\n\n//             console.log(\"Submit to Finance button shown\");\n//         }\n//     });\n// },\n\n\n\n    submit_to_finance(frm) {\n\n        const ci_data = {\n            doctype: \"CI Invoices\",\n\n            quotation_number: frm.doc.quotation_number,\n            policy_holder: frm.doc.policy_holder,\n            month: frm.doc.month,\n            year: frm.doc.year,\n            vat: frm.doc.vat,\n            invoice_date: frm.doc.invoice_date,\n            invoice_no: frm.doc.invoice_no,\n            invoice_amount: frm.doc.invoice_amount,\n            ed_number: frm.doc.ed_number,\n            currency: frm.doc.currency,\n        };\n\n        // Export Invoice Child Table\n        ci_data.export_invoice = (frm.doc.export_invoice || []).map(r => ({\n            description: r.description,\n            qty: r.qty,\n            price: r.premium_charges || r.price,\n            amount: r.amount\n        }));\n\n        // Export Buyer Child Table\n        ci_data.export_buyer = (frm.doc.export_buyer || []).map(r => ({\n            buyer: r.buyer,\n            country: r.country,\n            premium_rate: r.premium_rate,\n            premamount: r.turn_over_amt,\n            declamt: r.amount1\n        }));\n\n        frappe.db.insert(ci_data).then(res => {\n            frappe.set_route(\"Form\", \"CI Invoices\", res.name);\n        });\n    },\n    \n    cancel:function (frm) {\n    const { policy_holder, quotation_number, ed_number } = frm.doc;\n\n    if (!policy_holder || !quotation_number || !ed_number) {\n        frappe.msgprint(\"Policy Holder or Quotation Number missing.\");\n        return;\n    }\n\n    frappe.db.get_list(\"Export Declarations\", {\n        filters: {\n            policy_holder,\n            quotation_number,\n            ed_number\n        },\n        fields: [\"name\"],\n        limit: 1\n    }).then(result => {\n        if (result.length > 0) {\n            frappe.set_route(\"Form\", \"Export Declarations\", result[0].name);\n        }\n    });\n}\n\n\n\n});\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "CI Invoices",
  "enabled": 1,
  "modified": "2025-12-04 12:21:34.262541",
  "module": "Finance",
  "name": "Ci Invoice",
  "script": "frappe.ui.form.on('CI Invoices', {\r\n tax_invoice: function(frm) {\r\n\r\n        let inv = frm.doc.invoice_no || \"\";\r\n        let target_doctype = \"\";\r\n\r\n        // \ud83c\udf0d Determine Domestic / Export\r\n        if (inv.includes(\"/D\")) {\r\n            target_doctype = \"Credit Note Tax Invoice Domestic\";\r\n        }\r\n        else if (inv.includes(\"/E\")) {\r\n            target_doctype = \"Credit Note Tax Invoice Export\";\r\n        }\r\n        else {\r\n            frappe.msgprint(\"Invalid Invoice Number Format (Missing /D or /E)\");\r\n            return;\r\n        }\r\n\r\n        // 1\ufe0f\u20e3 Fetch Company Details\r\n        frappe.call({\r\n            method: \"frappe.client.get_value\",\r\n            args: {\r\n                doctype: \"Company-Details\",\r\n                fieldname: [\r\n                    \"telephone\",\"fax\",\"postal_address\",\"location\",\r\n                    \"contact_person\",\"vat_reg_no\",\"country\"\r\n                ],\r\n                filters: { name: frm.doc.policy_holder }\r\n            },\r\n\r\n            callback: function(r1) {\r\n                if (!r1.message) {\r\n                    frappe.msgprint(\"Company Details not found!\");\r\n                    return;\r\n                }\r\n\r\n                let c = r1.message;\r\n\r\n                // 2\ufe0f\u20e3 Fetch Policy Number\r\n                frappe.call({\r\n                    method: \"frappe.client.get_value\",\r\n                    args: {\r\n                        doctype: \"Policy Approvals\",\r\n                        fieldname: [\"policy_number\"],\r\n                        filters: { policy_holder: frm.doc.policy_holder }\r\n                    },\r\n\r\n                    callback: function(r2) {\r\n                        let policy_no = r2.message?.policy_number || \"\";\r\n\r\n                        // 3\ufe0f\u20e3 Set route options\r\n                        frappe.route_options = {\r\n                            invoice1: frm.doc.policy_holder,\r\n                            date1: frm.doc.invoice_date,\r\n                            invoice2: frm.doc.invoice_no,\r\n                            sub_total: frm.doc.vat,\r\n                            month: frm.doc.month,\r\n                            quotation_number: frm.doc.quotation_number,\r\n                            currency: frm.doc.currency,\r\n\r\n\r\n                            // Company Details\r\n                            telephone: c.telephone,\r\n                            fax: c.fax,\r\n                            address: c.postal_address,\r\n                            city: c.location,\r\n                            attn: c.contact_person,\r\n                            vat: c.vat_reg_no,\r\n                            country: c.country,\r\n\r\n                            // Policy Number\r\n                            reference1: policy_no\r\n                        };\r\n\r\n                        // 4\ufe0f\u20e3 Create Domestic or Export Doc\r\n                        frappe.new_doc(target_doctype);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    },\r\n\r\n    // -------------------------------------------------------------\r\n    // 2\ufe0f\u20e3 INTERNAL INVOICE BUTTON LOGIC (with Domestic/Export)\r\n    // -------------------------------------------------------------\r\n    internal_invoice: function (frm) {\r\n\r\n        let inv = frm.doc.invoice_no || \"\";\r\n        let target_doctype = \"\";\r\n\r\n        // \ud83c\udf0d Domestic / Export logic\r\n        if (inv.includes(\"/D\")) {\r\n            target_doctype = \"Credit Note Internal Invoice Domestic\";\r\n        }\r\n        else if (inv.includes(\"/E\")) {\r\n            target_doctype = \"Credit Note Internal Invoice Export\";\r\n        }\r\n        else {\r\n            frappe.msgprint(\"Invalid Invoice Number Format (Missing /D or /E)\");\r\n            return;\r\n        }\r\n\r\n        // Fetch Company Details\r\n        frappe.call({\r\n            method: 'frappe.client.get_value',\r\n            args: {\r\n                doctype: 'Company-Details',\r\n                fieldname: ['postal_address', 'location', 'vat_reg_no'],\r\n                filters: { name: frm.doc.policy_holder }\r\n            },\r\n\r\n            callback: function (r) {\r\n\r\n                if (!r.message) {\r\n                    frappe.msgprint(\"Company details not found!\");\r\n                    return;\r\n                }\r\n\r\n                frappe.route_options = {\r\n                    name1: frm.doc.policy_holder,\r\n                    invoice_no: frm.doc.invoice_no,\r\n                    quotation_number: frm.doc.quotation_number,\r\n                    date: frm.doc.invoice_date,\r\n                    address: r.message.postal_address,\r\n                    city: r.message.location,\r\n                    vat: r.message.vat_reg_no,\r\n                    currency: frm.doc.currency\r\n                };\r\n\r\n                // Create Domestic or Export Internal Invoice\r\n                frappe.new_doc(target_doctype);\r\n            }\r\n        });\r\n    },\r\n    \r\n     with_out_vat: function(frm) {\r\n        // Check if 'With Out Vat' checkbox is selected\r\n        if (frm.doc.with_out_vat) {\r\n            // Get the current invoice amount and VAT amount\r\n            var invoice_amount = frm.doc.invoice_amount;\r\n            var vat = frm.doc.vat;\r\n\r\n            // Calculate the invoice amount without VAT\r\n            var invoice_amount_without_vat = invoice_amount - vat;\r\n\r\n            // Set the calculated value in the 'invoice_amount_without_vat' field\r\n            frm.set_value('invoice_amount_without_vat', invoice_amount_without_vat);\r\n        } else {\r\n            // If 'With Out Vat' is not checked, clear the 'invoice_amount_without_vat' field\r\n            frm.set_value('invoice_amount_without_vat', null);\r\n        }\r\n    },\r\n    \r\n     refresh: function(frm) {\r\n          frm.fields_dict['invoice_amount'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n          frm.fields_dict['invoice_amount_without_vat'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n          frm.fields_dict['vat'].$wrapper.find('input').css(\"text-align\", \"right\");\r\n          frm.set_df_property('export_buyer','cannot_add_rows', true); \r\n          frm.set_df_property('export_invoice','cannot_add_rows', true); \r\n          frm.fields_dict.tax_invoice.$input.addClass('btn-primary');\r\n          frm.fields_dict.internal_invoice.$input.addClass('btn-primary');\r\n\r\n          var exportBuyerRows = frm.doc.export_buyer || [];\r\n        if (exportBuyerRows.length > 0) {\r\n            // Show the export_buyer child table if there are rows\r\n            frm.fields_dict['export_buyer'].grid.wrapper.show();\r\n        } else {\r\n            // Hide the export_buyer child table if there are no rows\r\n            frm.fields_dict['export_buyer'].grid.wrapper.hide();\r\n        }\r\n\r\n        // Check if export_invoice table has any rows\r\n        var exportInvoiceRows = frm.doc.export_invoice || [];\r\n        if (exportInvoiceRows.length > 0) {\r\n            // Show the export_invoice child table if there are rows\r\n            frm.fields_dict['export_invoice'].grid.wrapper.show();\r\n        } else {\r\n            // Hide the export_invoice child table if there are no rows\r\n            frm.fields_dict['export_invoice'].grid.wrapper.hide();\r\n        }\r\n        \r\n          if (frm.is_new()) {\r\n        // New form \u2192 show save button\r\n        frm.page.btn_primary.show();\r\n    } else {\r\n        // Saved form \u2192 hide save button\r\n        frm.page.btn_primary.hide();\r\n    }\r\n     }\r\n     \r\n     \r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Credit Limit  Annexure",
  "enabled": 1,
  "modified": "2025-12-03 09:22:15.798433",
  "module": "Finance",
  "name": "Credit limit Annexure",
  "script": "frappe.ui.form.on('Credit Limit  Annexure', {\nrefresh(frm) {\n   frm.fields_dict.back.$input.addClass('btn-primary');\n\n        // CASE 1: New document \u2192 show Save button\n        if (frm.is_new()) {\n            frm.enable_save();\n \n            setTimeout(() => {\n                frm.page.btn_primary.show();   // Show Save button\n            }, 50);\n        }\n \n        // CASE 2: Existing document \u2192 hide Save button\n        else {\n            frm.disable_save();\n \n            setTimeout(() => {\n                frm.page.btn_primary.hide();   // Hide Save\n                $('button[data-label=\"Save\"]').hide(); // Hide in menu\n            }, 50);\n        }\n    },\nback: function(frm) {\n    if (!frm.doc.policy_holder_name) {\n        frappe.msgprint(\"Policy Holder not found.\");\n        return;\n    }\n\n    // Find the matching Advance Premium record\n    frappe.call({\n        method: \"frappe.client.get_list\",\n        args: {\n            doctype: \"Credit Limit Processing\",\n            filters: {\n                policy_holder_name: frm.doc.policy_holder_name\n            },\n            fields: [\"name\"],\n            limit_page_length: 1\n        },\n        callback(res) {\n            if (res.message && res.message.length > 0) {\n                // Open the SAME document\n                frappe.set_route(\"Form\", \"Credit Limit Processing\", res.message[0].name);\n            } else {\n                frappe.msgprint(\"No Credit Limit Processing record found for this Policy Holder.\");\n                frappe.set_route(\"List\", \"Credit Limit Processing\");\n            }\n        }\n    });\n}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Print Proposal DCI",
  "enabled": 1,
  "modified": "2025-12-08 09:11:47.926189",
  "module": null,
  "name": "Print Proposal DCI Script",
  "script": "frappe.ui.form.on('Print Proposal DCI', {\r\n    refresh(frm) {\r\n        // Make Back button blue\r\n        $('button[data-fieldname=\"back\"]')\r\n            .css(\"background-color\", \"#007bff\")\r\n            .css(\"color\", \"white\")\r\n            .css(\"font-weight\", \"bold\")\r\n            .css(\"border\", \"1px solid #007bff\");\r\n\r\n    \r\n    },\r\n    \r\n    \r\n    back(frm) {\r\n        // Get data1 from the current document (Full Name)\r\n        let data1 = frm.doc.data1;\r\n\r\n        if (!data1) {\r\n            frappe.msgprint(\"Full Name not found!\");\r\n            return;\r\n        }\r\n\r\n        // Search in DCI Proposals where client_name == data1\r\n        frappe.call({\r\n            method: \"frappe.client.get_list\",\r\n            args: {\r\n                doctype: \"DCI Proposals\",\r\n                filters: { client_name: data1 },\r\n                fields: [\"name\"]\r\n            },\r\n            callback: function (r) {\r\n                if (r.message && r.message.length > 0) {\r\n                    let proposalName = r.message[0].name;\r\n\r\n                    // Navigate to the DCI Proposal form\r\n                    frappe.set_route(\"Form\", \"DCI Proposals\", proposalName);\r\n                } else {\r\n                    frappe.msgprint(\"No matching DCI Proposal found for: \" + data1);\r\n                }\r\n            }\r\n        });\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Print Proposal ECI",
  "enabled": 1,
  "modified": "2025-12-04 07:19:28.114337",
  "module": null,
  "name": "Print Proposal ECI Script",
  "script": "frappe.ui.form.on('Print Proposal ECI', {\n    \n         refresh(frm) {\n        // Make Back button blue\n        $('button[data-fieldname=\"back\"]')\n            .css(\"background-color\", \"#007bff\")\n            .css(\"color\", \"white\")\n            .css(\"font-weight\", \"bold\")\n            .css(\"border\", \"1px solid #007bff\");\n    },\n\n back(frm) {\n        // Get data1 from the current document (Full Name)\n        let name1 = frm.doc.name1;\n\n        if (!name1) {\n            frappe.msgprint(\"Full Name not found!\");\n            return;\n        }\n\n        // Search in DCI Proposals where client_name == data1\n        frappe.call({\n            method: \"frappe.client.get_list\",\n            args: {\n                doctype: \"ECI Proposal\",\n                filters: { client_name: name1 },\n                fields: [\"name\"]\n            },\n            callback: function (r) {\n                if (r.message && r.message.length > 0) {\n\n                    let proposalName = r.message[0].name;\n\n                    // Correct routing\n                    frappe.set_route(\"Form\", \"ECI Proposal\", proposalName);\n\n                } else {\n                    frappe.msgprint(\"No matching DCI Proposal found for: \" + name1);\n                }\n            }\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "ECI Quotations",
  "enabled": 0,
  "modified": "2025-12-08 11:59:36.783057",
  "module": null,
  "name": "decimals",
  "script": "frappe.ui.form.on('ECI Quotations', {\r\nindividual_first_lossp: format_field,\r\nmin_premium_depositp: format_field,\r\nlimit_of_descrition: format_field,\r\nfranchise_lossp: format_field,\r\ninsured_commercial_risks_for_all_insured_companies: format_field\r\n});\r\n\r\nfunction format_field(frm, cdt, cdn) {\r\nlet fieldname = frappe.ui.form.get_triggered_fieldname();\r\nlet value = frm.doc[fieldname];\r\n\r\nif (!value && value !== 0) return;\r\n\r\nlet num = parseFloat(value.toString().trim());\r\nif (isNaN(num)) {\r\n    frappe.msgprint(__('Please enter a valid number for {0}', [fieldname]));\r\n    return;\r\n}\r\n\r\nfrm.set_value(fieldname, num.toFixed(2));\r\n\r\n\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Print Proposal BondFacility",
  "enabled": 1,
  "modified": "2025-12-08 12:33:11.889659",
  "module": "Marketing",
  "name": "Print1",
  "script": "frappe.ui.form.on('Print Proposal BondFacility', {\n    refresh(frm){\n            frm.fields_dict.back.$input.addClass('btn-primary');\n            \n            frm.set_df_property('group_company', 'cannot_add_rows', true);\n      frm.set_df_property('director_table', 'cannot_add_rows', true);\n      frm.set_df_property('company_table', 'cannot_add_rows', true);\n      frm.set_df_property('personel_table', 'cannot_add_rows', true);\n        frm.set_df_property('current_table', 'cannot_add_rows', true);\n\n    },\n    back(frm) {\n        // Get data1 from the current document (Full Name)\n        let registered_name = frm.doc.registered_name;\n\n        if (!registered_name) {\n            frappe.msgprint(\"Full Name not found!\");\n            return;\n        }\n\n        // Search in DCI Proposals where client_name == data1\n        frappe.call({\n            method: \"frappe.client.get_list\",\n            args: {\n                doctype: \"Bond Facility\",\n                filters: { client_name: registered_name },\n                fields: [\"name\"]\n            },\n            callback: function (r) {\n                if (r.message && r.message.length > 0) {\n                    let proposalName = r.message[0].name;\n\n                    // Navigate to the DCI Proposal form\n                    frappe.set_route(\"Form\", \"Bond Facility\", proposalName);\n                } else {\n                    frappe.msgprint(\"No matching Bond Facility found for: \" + registered_name);\n                }\n            }\n        });\n    }\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Rejection Letter Bond Facility",
  "enabled": 1,
  "modified": "2025-12-08 12:36:17.118536",
  "module": "Marketing",
  "name": "Rejection_1",
  "script": "frappe.ui.form.on('Rejection Letter Bond Facility', {\n\trefresh(frm) {\n\t            frm.fields_dict.back.$input.addClass('btn-primary');\n\n\t},\n back(frm) {\n        // Get data1 from the current document (Full Name)\n        let client = frm.doc.client;\n\n        if (!client) {\n            frappe.msgprint(\"Full Name not found!\");\n            return;\n        }\n\n        // Search in DCI Proposals where client_name == data1\n        frappe.call({\n            method: \"frappe.client.get_list\",\n            args: {\n                doctype: \"Bond Facility\",\n                filters: { client_name: client },\n                fields: [\"name\"]\n            },\n            callback: function (r) {\n                if (r.message && r.message.length > 0) {\n                    let proposalName = r.message[0].name;\n\n                    // Navigate to the DCI Proposal form\n                    frappe.set_route(\"Form\", \"Bond Facility\", proposalName);\n                } else {\n                    frappe.msgprint(\"No matching Bond Facility found for: \" + registered_name);\n                }\n            }\n        });\n    }\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Print internal invoice deputy sheriff",
  "enabled": 1,
  "modified": "2025-12-10 09:16:30.227929",
  "module": null,
  "name": "Invoice Script",
  "script": "frappe.ui.form.on('Print internal invoice deputy sheriff', {\n   refresh: function(frm) {\n         frm.fields_dict.back.$input.addClass('btn-primary');\n\n   },\n\tback: function(frm) {\n    if (!frm.doc.account) {\n        frappe.msgprint(\"account not found.\");\n        return;\n    }\n\n    // Find the matching Advance Premium record\n    frappe.call({\n        method: \"frappe.client.get_list\",\n        args: {\n            doctype: \"Bond Invoice\",\n            filters: {\n                facility_name: frm.doc.account\n            },\n            fields: [\"name\"],\n            limit_page_length: 1\n        },\n        callback(res) {\n            if (res.message && res.message.length > 0) {\n                // Open the SAME document\n                frappe.set_route(\"Form\", \"Bond Invoice\", res.message[0].name);\n            } else {\n                frappe.msgprint(\"No Bond Invoice record found for this Policy Holder.\");\n                frappe.set_route(\"List\", \"Bond Invoice\");\n            }\n        }\n    });\n},\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Print External Invoice deputy sherrif",
  "enabled": 1,
  "modified": "2025-12-10 08:12:13.356081",
  "module": null,
  "name": "External Invoice Script",
  "script": "frappe.ui.form.on('Print External Invoice deputy sherrif', {\n\t refresh: function(frm) {\n         frm.fields_dict.back.$input.addClass('btn-primary');\n\n   },\n\tback: function(frm) {\n    if (!frm.doc.invoice_to) {\n        frappe.msgprint(\"account not found.\");\n        return;\n    }\n\n    // Find the matching Advance Premium record\n    frappe.call({\n        method: \"frappe.client.get_list\",\n        args: {\n            doctype: \"Bond Invoice\",\n            filters: {\n                facility_name: frm.doc.invoice_to\n            },\n            fields: [\"name\"],\n            limit_page_length: 1\n        },\n        callback(res) {\n            if (res.message && res.message.length > 0) {\n                // Open the SAME document\n                frappe.set_route(\"Form\", \"Bond Invoice\", res.message[0].name);\n            } else {\n                frappe.msgprint(\"No Bond Invoice record found for this Policy Holder.\");\n                frappe.set_route(\"List\", \"Bond Invoice\");\n            }\n        }\n    });\n},\n// before_load: function(frm) {\n//         if (!frm.doc.invoice_no) return;\n\n//         // Check if record already exists\n//         frappe.call({\n//             method: \"frappe.client.get_list\",\n//             args: {\n//                 doctype: \"Print External Invoice deputy sherrif\",\n//                 filters: { invoice_no: frm.doc.invoice_no },\n//                 fields: [\"name\"],\n//                 limit: 1\n//             },\n//             callback: (res) => {\n//                 if (res.message && res.message.length > 0) {\n//                     // Open existing form\n//                     frappe.set_route(\"Form\", \"Print External Invoice deputy sherrif\", res.message[0].name);\n//                 } else {\n//                     // No existing record \u2192 create new\n//                     frappe.new_doc(\"Print External Invoice deputy sherrif\");\n//                 }\n//             }\n//         });\n//     },\n})",
  "view": "Form"
 }
]